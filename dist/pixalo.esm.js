/*!
 * Copyright (c) 2025 Pixalo
 * @Repository: https://github.com/pixalo 
 * @License: MIT
 */
function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,o,s,r,a=[],l=!0,h=!1;try{if(s=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;l=!1}else for(;!(l=(n=s.call(i)).done)&&(a.push(n.value),a.length!==e);l=!0);}catch(t){h=!0,o=t}finally{try{if(!l&&null!=i.return&&(r=i.return(),Object(r)!==r))return}finally{if(h)throw o}}return a}}(t,e)||n(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function i(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=n(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var o=0,s=function(){};return{s,n:function(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function(t){throw t},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,a=!0,l=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return a=t.done,t},e:function(t){l=!0,r=t},f:function(){try{a||null==i.return||i.return()}finally{if(l)throw r}}}}function n(t,e){if(t){if("string"==typeof t)return o(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?o(t,e):void 0}}function o(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function s(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function r(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?s(Object(i),!0).forEach(function(e){a(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):s(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function a(t,e,i){return(e=h(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function l(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,h(n.key),n)}}function h(e){var i=function(e,i){if("object"!=t(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var o=n.call(e,i||"default");if("object"!=t(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===i?String:Number)(e)}(e,"string");return"symbol"==t(i)?i:i+""}var c=function(){return function(t,e,i){return e&&l(t.prototype,e),i&&l(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.decomposedShapes=new Map,this.activeCollisions=new Map,this.lastPositions=new Map,this.customPathCache=new Map},[{key:"updateCollisions",value:function(t){var n=this;t=t.filter(function(t){var e;return t&&(null===(e=t.collision)||void 0===e?void 0:e.enabled)});var o=new Map;t.forEach(function(t){var e=n.lastPositions.get(t.id);e&&e.x===t.absoluteX+t.collision.x&&e.y===t.absoluteY+t.collision.y&&e.rotation===t.styles.rotation&&e.scaleX===t.styles.scaleX&&e.scaleY===t.styles.scaleY&&e.skewX===t.styles.skewX&&e.skewY===t.styles.skewY&&e.borderRadius===t.styles.borderRadius||n.clearCache(t.id),n.lastPositions.set(t.id,{x:t.absoluteX+t.collision.x,y:t.absoluteY+t.collision.y,rotation:t.styles.rotation,scaleX:t.styles.scaleX,scaleY:t.styles.scaleY,skewX:t.styles.skewX,skewY:t.styles.skewY,borderRadius:t.styles.borderRadius})});for(var s=0;s<t.length;s++)for(var a=s+1;a<t.length;a++){var l,h,c=t[s],m=t[a];if(null!==(l=c.collision)&&void 0!==l&&l.enabled&&null!==(h=m.collision)&&void 0!==h&&h.enabled&&c.collision.group!==m.collision.group){var u="".concat(c.id,"-").concat(m.id),y=this.detectCollisionDetailed(c,m);y.colliding&&!this.activeCollisions.has(u)&&(o.set(u,r(r({entity1:c,entity2:m},y),{},{timestamp:Date.now()})),c.trigger("collide",{entity:m,side:y.side1,otherSide:y.side2,point:y.point,overlap:y.overlap,normal:y.normal}),m.trigger("collide",{entity:c,side:y.side2,otherSide:y.side1,point:y.point,overlap:y.overlap,normal:{x:-y.normal.x,y:-y.normal.y}}))}}var p,f=i(this.activeCollisions);try{for(f.s();!(p=f.n()).done;){var _=e(p.value,2),d=_[0],v=_[1];if(!o.has(d)){var b=v.entity1,g=v.entity2,x=v.side1,w=v.side2;b.trigger("collideEnd",{entity:g,side:x}),g.trigger("collideEnd",{entity:b,side:w})}}}catch(t){f.e(t)}finally{f.f()}this.activeCollisions=o}},{key:"detectCollisionDetailed",value:function(t,e){var i=t.styles.borderRadius>0||e.styles.borderRadius>0?.2*Math.max(t.styles.borderRadius,e.styles.borderRadius):0;if(!this.checkAABBCollision(t,e,i))return{colliding:!1};if("circle"===t.styles.shape&&"circle"===e.styles.shape)return this.detectCircleCollision(t,e);var n=this.getVertices(t),o=this.getVertices(e);return this.detectSATCollision(n,o,t,e,i)}},{key:"detectCircleCollision",value:function(t,e){var i=Math.min(t.collision.width,t.collision.height)/2,n=Math.min(e.collision.width,e.collision.height)/2,o=t.absoluteX+t.collision.x+t.collision.width/2,s=t.absoluteY+t.collision.y+t.collision.height/2,r=e.absoluteX+e.collision.x+e.collision.width/2-o,a=e.absoluteY+e.collision.y+e.collision.height/2-s,l=Math.sqrt(r*r+a*a),h=i+n;if(l>=h)return{colliding:!1};var c=h-l,m={x:r/l,y:a/l};return{colliding:!0,side1:this.getSideFromNormal(m),side2:this.getSideFromNormal({x:-m.x,y:-m.y}),point:{x:o+m.x*i,y:s+m.y*i},overlap:c,normal:m}}},{key:"detectSATCollision",value:function(t,e,n,o){var s,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=1/0,l={x:0,y:0},h=i(this.getAxes(t).concat(this.getAxes(e)));try{for(h.s();!(s=h.n()).done;){var c=s.value,m=this.projectVertices(t,c),u=this.projectVertices(e,c),y=this.getOverlap(m,u)-r;if(y<=0)return{colliding:!1};y<a&&(a=y,l=c)}}catch(t){h.e(t)}finally{h.f()}var p=this.findCollisionPoint(t,e),f=this.getSideFromNormal(l);return{colliding:!0,side1:f,side2:this.getOppositeSide(f),point:p,overlap:a,normal:l}}},{key:"checkAABBCollision",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=this.getAABB(t),o=this.getAABB(e);return n.minX-i<=o.maxX+i&&n.maxX+i>=o.minX-i&&n.minY-i<=o.maxY+i&&n.maxY+i>=o.minY-i}},{key:"getSideFromNormal",value:function(t){var e=180*Math.atan2(t.y,t.x)/Math.PI;return e>-45&&e<=45?"right":e>45&&e<=135?"bottom":e>135||e<=-135?"left":"top"}},{key:"getOppositeSide",value:function(t){return{left:"right",right:"left",top:"bottom",bottom:"top"}[t]}},{key:"getOverlap",value:function(t,e){var i=Math.min(t.max-e.min,e.max-t.min);return Math.round(1e4*i)/1e4}},{key:"getAABB",value:function(t){var e=this.getVertices(t),i=1/0,n=1/0,o=-1/0,s=-1/0;return e.forEach(function(t){i=Math.min(i,t.x),n=Math.min(n,t.y),o=Math.max(o,t.x),s=Math.max(s,t.y)}),{minX:i,minY:n,maxX:o,maxY:s}}},{key:"getAxes",value:function(t){for(var e=[],i=0;i<t.length;i++){var n=t[i],o=t[(i+1)%t.length],s={x:o.x-n.x,y:o.y-n.y},r={x:-s.y,y:s.x},a=Math.sqrt(r.x*r.x+r.y*r.y);0!==a&&e.push({x:r.x/a,y:r.y/a})}return e}},{key:"projectVertices",value:function(t,e){var i=1/0,n=-1/0;return t.forEach(function(t){var o=t.x*e.x+t.y*e.y;i=Math.min(i,o),n=Math.max(n,o)}),{min:i,max:n}}},{key:"getVertices",value:function(t){if(this.decomposedShapes.has(t.id))return this.decomposedShapes.get(t.id);var e;if(t.collision.points&&t.collision.points.length>=3)e=t.collision.points;else if(t.styles.customPath)e=this.getCustomPathVertices(t);else switch(t.styles.shape){case"star":e=this.getStarVertices(t);break;case"circle":e=this.getCircleVertices(t);break;case"triangle":e=this.getTriangleVertices(t);break;case"polygon":e=t.styles.points;break;default:e=this.getRectangleVertices(t,t.styles.borderRadius)}return e=this.applyTransformations(e,t),this.decomposedShapes.set(t.id,e),e}},{key:"getStarVertices",value:function(t){for(var e=Math.min(t.collision.width,t.collision.height)/2,i=.4*e,n=t.styles.spikes||5,o=[],s=Math.PI/n,r=0;r<2*n;r++){var a=r%2==0?e:i,l=s*r-Math.PI/2;if(o.push({x:Math.cos(l)*a,y:Math.sin(l)*a}),r<2*n-1){var h=(r+1)%2==0?e:i,c=s*(r+1)-Math.PI/2,m=(Math.cos(l)*a+Math.cos(c)*h)/2,u=(Math.sin(l)*a+Math.sin(c)*h)/2;o.push({x:m,y:u})}}return o}},{key:"getCircleVertices",value:function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:16,i=[],n=Math.min(t.collision.width,t.collision.height)/2,o=0;o<e;o++){var s=o/e*Math.PI*2;i.push({x:Math.cos(s)*n,y:Math.sin(s)*n})}return i}},{key:"getTriangleVertices",value:function(t){var e=t.collision.width/2,i=t.collision.height/2;return[{x:0,y:-i},{x:e,y:i},{x:-e,y:i}]}},{key:"getRectangleVertices",value:function(t,e){var i=t.collision.width/2,n=t.collision.height/2;if(!e)return[{x:-i,y:-n},{x:i,y:-n},{x:i,y:n},{x:-i,y:n}];var o=Math.min(e,Math.min(i,n)),s=[];return s.push({x:i-o,y:-n}),s.push({x:-i+o,y:-n}),s.push({x:-i,y:-n+o}),s.push({x:-i,y:n-o}),s.push({x:-i+o,y:n}),s.push({x:i-o,y:n}),s.push({x:i,y:n-o}),s.push({x:i,y:-n+o}),this.addRoundedCornerVertices(s,i-o,-n+o,o,0,4),this.addRoundedCornerVertices(s,-i+o,-n+o,o,Math.PI/2,4),this.addRoundedCornerVertices(s,-i+o,n-o,o,Math.PI,4),this.addRoundedCornerVertices(s,i-o,n-o,o,3*Math.PI/2,4),s}},{key:"addRoundedCornerVertices",value:function(t,e,i,n,o,s){for(var r=0;r<=s;r++){var a=o+Math.PI/2*(r/s);t.push({x:e+Math.cos(a)*n,y:i+Math.sin(a)*n})}}},{key:"getCustomPathVertices",value:function(t){var e="".concat(t.id,"-").concat(t.styles.customPath);if(this.customPathCache.has(e))return this.customPathCache.get(e);var i=document.createElement("canvas"),n=i.getContext("2d");i.width=t.collision.width,i.height=t.collision.height,n.save(),n.translate(t.collision.width/2,t.collision.height/2),t.styles.customPath(n);var o=this.samplePathPoints(n,t.collision.width,t.collision.height);return n.restore(),this.customPathCache.set(e,o),o}},{key:"findCollisionPoint",value:function(t,e){var i=1/0,n={x:0,y:0};return t.forEach(function(t){e.forEach(function(e){var o=e.x-t.x,s=e.y-t.y,r=o*o+s*s;r<i&&(i=r,n={x:t.x+o/2,y:t.y+s/2})})}),n}},{key:"samplePathPoints",value:function(t,e,i){for(var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:16,o=[],s={minX:-e/2+2,maxX:e/2-2,minY:-i/2+2,maxY:i/2-2},r=0;r<2*Math.PI;r+=2*Math.PI/n){for(var a=0,l=Math.max(e,i),h=l,c=0;c<8;c++){var m=(a+l)/2,u=Math.cos(r)*m,y=Math.sin(r)*m;this.isPointInBounds(u,y,s)&&t.isPointInPath(u+e/2,y+i/2)?(h=m,l=m):a=m}var p=Math.cos(r)*h,f=Math.sin(r)*h;this.isPointInBounds(p,f,s)&&o.push({x:p,y:f})}if(o.length>2){for(var _=[],d=0;d<o.length;d++){var v=o[d],b=o[(d+1)%o.length];_.push(v),_.push({x:(v.x+b.x)/2,y:(v.y+b.y)/2})}return _}return o}},{key:"isPointInBounds",value:function(t,e,i){return t>=i.minX&&t<=i.maxX&&e>=i.minY&&e<=i.maxY}},{key:"applyTransformations",value:function(t,e){var i=e.styles.rotation*Math.PI/180,n=Math.cos(i),o=Math.sin(i),s=e.styles.scale*e.styles.scaleX,r=e.styles.scale*e.styles.scaleY,a=Math.tan(e.styles.skewX*Math.PI/180),l=Math.tan(e.styles.skewY*Math.PI/180);return t.map(function(t){var i=t.x*s,h=t.y*r,c=(i+=h*a)*o+(h+=i*l)*n;return{x:i*n-h*o+e.absoluteX+e.collision.x+e.collision.width/2,y:c+e.absoluteY+e.collision.y+e.collision.height/2}})}},{key:"remove",value:function(t){var e=this;this.decomposedShapes.delete(t.id),this.lastPositions.delete(t.id);var i=[];this.activeCollisions.forEach(function(e,n){e.entity1.id!==t.id&&e.entity2.id!==t.id||i.push(n)}),i.forEach(function(i){var n=e.activeCollisions.get(i);if(n){var o=n.entity1.id===t.id?n.entity2:n.entity1,s=n.entity1.id===t.id?n.side2:n.side1;o.trigger("collideEnd",{entity:t,side:s}),e.activeCollisions.delete(i)}})}},{key:"clearCache",value:function(t){this.decomposedShapes.delete(t)}},{key:"reset",value:function(){this.decomposedShapes.clear(),this.activeCollisions.clear(),this.lastPositions.clear(),this.customPathCache.clear()}}],[{key:"isPointInCollisionPoints",value:function(t,e,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2;return!!this.isPointOnBezierCurves(t,e,i,n)||this.isPointInShape(t,e,i)}},{key:"isPointInTriangle",value:function(t,e,i,n){var o=-n/2,s=i/2,r=n/2,a=-i/2,l=n/2,h=(t-a)*(o-l)-(0-a)*(e-l),c=(t-0)*(r-o)-(s-0)*(e-o),m=(t-s)*(l-r)-(a-s)*(e-r);return h>=0&&c>=0&&m>=0||h<=0&&c<=0&&m<=0}},{key:"isPointOnBezierCurves",value:function(t,e,i,n){for(var o=0;o<i.length-1;o++)for(var s=i[o],r=i[o+1],a=this.getIntermediatePoints(s,r,10),l=0;l<a.length-1;l++){var h=a[l],c=a[l+1];if(this.pointToLineDistance(t,e,h.x,h.y,c.x,c.y)<=n)return!0}if(i.length>0)for(var m=i[0],u=i[i.length-1],y=this.getIntermediatePoints(u,m,10),p=0;p<y.length-1;p++){var f=y[p],_=y[p+1];if(this.pointToLineDistance(t,e,f.x,f.y,_.x,_.y)<=n)return!0}return!1}},{key:"isPointInShape",value:function(t,e,i){for(var n=0,o=0;o<i.length;o++){var s=i[o],r=i[(o+1)%i.length];s.y<=e?r.y>e&&this.isLeft(s,r,{x:t,y:e})>0&&n++:r.y<=e&&this.isLeft(s,r,{x:t,y:e})<0&&n--}return 0!==n}},{key:"isLeft",value:function(t,e,i){return(e.x-t.x)*(i.y-t.y)-(i.x-t.x)*(e.y-t.y)}},{key:"getIntermediatePoints",value:function(t,e,i){for(var n=[],o=0;o<=i;o++){var s=o/i;n.push({x:t.x+(e.x-t.x)*s,y:t.y+(e.y-t.y)*s})}return n}},{key:"pointToLineDistance",value:function(t,e,i,n,o,s){var r,a,l=o-i,h=s-n,c=l*l+h*h,m=-1;0!==c&&(m=((t-i)*l+(e-n)*h)/c),m<0?(r=i,a=n):m>1?(r=o,a=s):(r=i+m*l,a=n+m*h);var u=t-r,y=e-a;return Math.sqrt(u*u+y*y)}},{key:"optimizeCollisionPoints",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;if(t.length<=2)return t;for(var i=[t[0]],n=t[0],o=1;o<t.length;o++){var s=t[o],r=s.x-n.x,a=s.y-n.y;Math.sqrt(r*r+a*a)>=e&&(i.push(s),n=s)}return i[0]!==i[i.length-1]&&i.push(i[0]),i}}])}();const m=c;function u(t){return u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},u(t)}function y(t){return function(t){if(Array.isArray(t))return b(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||v(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function p(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var t,e,i="function"==typeof Symbol?Symbol:{},n=i.iterator||"@@iterator",o=i.toStringTag||"@@toStringTag";function s(i,n,o,s){var l=n&&n.prototype instanceof a?n:a,h=Object.create(l.prototype);return f(h,"_invoke",function(i,n,o){var s,a,l,h=0,c=o||[],m=!1,u={p:0,n:0,v:t,a:y,f:y.bind(t,4),d:function(e,i){return s=e,a=0,l=t,u.n=i,r}};function y(i,n){for(a=i,l=n,e=0;!m&&h&&!o&&e<c.length;e++){var o,s=c[e],y=u.p,p=s[2];i>3?(o=p===n)&&(l=s[(a=s[4])?5:(a=3,3)],s[4]=s[5]=t):s[0]<=y&&((o=i<2&&y<s[1])?(a=0,u.v=n,u.n=s[1]):y<p&&(o=i<3||s[0]>n||n>p)&&(s[4]=i,s[5]=n,u.n=p,a=0))}if(o||i>1)return r;throw m=!0,n}return function(o,c,p){if(h>1)throw TypeError("Generator is already running");for(m&&1===c&&y(c,p),a=c,l=p;(e=a<2?t:l)||!m;){s||(a?a<3?(a>1&&(u.n=-1),y(a,l)):u.n=l:u.v=l);try{if(h=2,s){if(a||(o="next"),e=s[o]){if(!(e=e.call(s,l)))throw TypeError("iterator result is not an object");if(!e.done)return e;l=e.value,a<2&&(a=0)}else 1===a&&(e=s.return)&&e.call(s),a<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),a=1);s=t}else if((e=(m=u.n<0)?l:i.call(n,u))!==r)break}catch(e){s=t,a=1,l=e}finally{h=1}}return{value:e,done:m}}}(i,o,s),!0),h}var r={};function a(){}function l(){}function h(){}e=Object.getPrototypeOf;var c=[][n]?e(e([][n]())):(f(e={},n,function(){return this}),e),m=h.prototype=a.prototype=Object.create(c);function u(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,h):(t.__proto__=h,f(t,o,"GeneratorFunction")),t.prototype=Object.create(m),t}return l.prototype=h,f(m,"constructor",h),f(h,"constructor",l),l.displayName="GeneratorFunction",f(h,o,"GeneratorFunction"),f(m),f(m,o,"Generator"),f(m,n,function(){return this}),f(m,"toString",function(){return"[object Generator]"}),(p=function(){return{w:s,m:u}})()}function f(t,e,i,n){var o=Object.defineProperty;try{o({},"",{})}catch(t){o=0}f=function(t,e,i,n){if(e)o?o(t,e,{value:i,enumerable:!n,configurable:!n,writable:!n}):t[e]=i;else{var s=function(e,i){f(t,e,function(t){return this._invoke(e,i,t)})};s("next",0),s("throw",1),s("return",2)}},f(t,e,i,n)}function _(t,e,i,n,o,s,r){try{var a=t[s](r),l=a.value}catch(t){return void i(t)}a.done?e(l):Promise.resolve(l).then(n,o)}function d(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=v(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return r=t.done,t},e:function(t){a=!0,s=t},f:function(){try{r||null==i.return||i.return()}finally{if(a)throw s}}}}function v(t,e){if(t){if("string"==typeof t)return b(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?b(t,e):void 0}}function b(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function g(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,C(n.key),n)}}function x(t,e){(function(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")})(t,e),e.add(t)}function w(t,e,i){return(e=C(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function C(t){var e=function(t,e){if("object"!=u(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=u(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==u(e)?e:e+""}function S(t,e,i){if("function"==typeof t?t===e:t.has(e))return arguments.length<3?e:i;throw new TypeError("Private element is not present on this object")}var A=new WeakSet,M=function(){return function(t,e,i){return e&&g(t.prototype,e),i&&g(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),x(this,A),w(this,"pressedKeys",new Set),w(this,"keyMap",{control:"ctrl"," ":"space",arrowup:"up",arrowdown:"down",arrowleft:"left",arrowright:"right",escape:"esc",enter:"enter",shift:"shift",alt:"alt",meta:"meta",delete:"del",backspace:"backspace",tab:"tab",capslock:"caps",pageup:"pageup",pagedown:"pagedown",insert:"ins",home:"home",end:"end"})},[{key:"resize",value:function(t,e){return this._updateCanvasSize(t,e),this}},{key:"_handleResize",value:function(){var t=this.canvas.offsetWidth,e=this.canvas.offsetHeight;this._updateCanvasSize(t,e)}},{key:"_updateCanvasSize",value:function(t,e){this.baseWidth=t,this.baseHeight=e,this.config.width=t,this.config.height=e,this.canvas.width=t*this.config.quality,this.canvas.height=e*this.config.quality,this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",this.ctx.scale(this.config.quality,this.config.quality),this.workerSend({action:"update_canvas",props:{attributes:{width:this.canvas.width,height:this.canvas.height},style:this.canvas.style}}),this.trigger("resize",{width:t,height:e})}},{key:"getSortedEntitiesForInteraction",value:function(){var t,e=[],i=0,n=function(t){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:0)+(t.zIndex||0);e.push({entity:t,level:o,effectiveZIndex:s,isChild:!!t.parent,addOrder:i++});var r,a=d(t.children.values());try{for(a.s();!(r=a.n()).done;){var l=r.value;n(l,o+1,s)}}catch(t){a.e(t)}finally{a.f()}},o=d(this.entities.values());try{for(o.s();!(t=o.n()).done;){var s=t.value;n(s)}}catch(t){o.e(t)}finally{o.f()}return e.sort(function(t,e){return e.effectiveZIndex!==t.effectiveZIndex?e.effectiveZIndex-t.effectiveZIndex:e.level!==t.level?e.level-t.level:t.addOrder-e.addOrder}).map(function(t){return t.entity})}},{key:"isPointInEntity",value:function(t,e,i){var n;if(!i.styles.visible)return!1;var o=i.absoluteX+i.width/2,s=i.absoluteY+i.height/2,r=-i.styles.rotation*Math.PI/180,a=Math.cos(r),l=Math.sin(r),h=a*(t-o)-l*(e-s),c=l*(t-o)+a*(e-s);if((null===(n=i.collision)||void 0===n||null===(n=n.points)||void 0===n?void 0:n.length)>0)return m.isPointInCollisionPoints(h,c,i.collision.points);var u=i.width*i.styles.scale*i.styles.scaleX,y=i.height*i.styles.scale*i.styles.scaleY;switch(i.styles.shape){case"circle":var p=Math.min(u,y)/2;return h*h+c*c<=p*p;case"triangle":return m.isPointInTriangle(h,c,u,y);default:return Math.abs(h)<=u/2&&Math.abs(c)<=y/2}}},{key:"_handleTouchStart",value:function(t){var e=this;if(this.running){var i,n=d(t.changedTouches);try{var o=function(){var n=i.value,o=n.identifier,s=e.camera.screenToWorld(n.clientX,n.clientY),r={x:s.x,y:s.y,worldX:s.x,worldY:s.y,screenX:n.clientX,screenY:n.clientY,timestamp:Date.now(),touches:e._handleTouches(t),identifier:o};if(e.trigger("touchstart",r),e.physicsEnabled)return 1;var a=e.getSortedEntitiesForInteraction().find(function(t){return e.isPointInEntity(s.x,s.y,t)&&(t.isDraggable()||t.isClickable())});if(a){e.entities.forEach(function(t){t.zIndex>a.zIndex&&t.zIndex--});var l=0;e.entities.forEach(function(t){l=Math.max(l,t.zIndex||0)}),a.zIndex=l+1,a.isDraggable()&&(e.draggedEntities.set(o,{entity:a,touchStartX:s.x,touchStartY:s.y,dragStartX:s.x-a.absoluteX,dragStartY:s.y-a.absoluteY}),a.trigger("drag",r))}};for(n.s();!(i=n.n()).done;)o()}catch(t){n.e(t)}finally{n.f()}}}},{key:"_handleTouchMove",value:function(t){var e;if(null==t||null===(e=t.preventDefault)||void 0===e||e.call(t),this.running){var i,n=d(t.changedTouches);try{for(n.s();!(i=n.n()).done;){var o=i.value,s=o.identifier,r=this.draggedEntities.get(s),a=this.camera.screenToWorld(o.clientX,o.clientY),l={x:a.x,y:a.y,worldX:a.x,worldY:a.y,screenX:o.clientX,screenY:o.clientY,timestamp:Date.now(),touches:this._handleTouches(t),identifier:s};if(this.trigger("touchmove",l),!this.physicsEnabled&&r){var h=r.entity,c=a.x-r.dragStartX,m=a.y-r.dragStartY;if(h.parent&&h.constrainToParent){var u=h.parent,y=u.width-h.width,p=u.height-h.height;c=Math.max(0,Math.min(y,c-u.absoluteX)),m=Math.max(0,Math.min(p,m-u.absoluteY))}else h.parent&&(c-=h.parent.absoluteX,m-=h.parent.absoluteY);h.style({x:c,y:m}),h.trigger("dragMove",l)}}}catch(t){n.e(t)}finally{n.f()}}}},{key:"_handleTouchEnd",value:function(t){if(this.running){var e,i=d(t.changedTouches);try{for(i.s();!(e=i.n()).done;){var n=e.value,o=n.identifier,s=this.draggedEntities.get(o),r=this.camera.screenToWorld(n.clientX,n.clientY),a={x:r.x,y:r.y,worldX:r.x,worldY:r.y,screenX:n.clientX,screenY:n.clientY,timestamp:Date.now(),touches:this._handleTouches(t),identifier:o};if(!this.physicsEnabled&&s){var l=s.entity;Math.abs(r.x-s.touchStartX),Math.abs(r.y-s.touchStartY);l.isDraggable()&&l.trigger("drop",a),this.draggedEntities.delete(o)}this.trigger("touchend",a)}}catch(t){i.e(t)}finally{i.f()}}}},{key:"_handleTouchCancel",value:function(t){this.handleTouchEnd(t)}},{key:"_handleTouches",value:function(t){var e,i=[],n=d(t.touches);try{for(n.s();!(e=n.n()).done;){var o=e.value,s=this.camera.screenToWorld(o.clientX,o.clientY);i.push({identifier:o.identifier,screenX:o.clientX,screenY:o.clientY,worldX:s.x,worldY:s.y})}}catch(t){n.e(t)}finally{n.f()}return i}},{key:"_handleMouseDown",value:function(t){var e=this;if(this.running&&2!==t.buttons){var i=this.camera.screenToWorld(t.clientX,t.clientY),n={x:i.x,y:i.y,worldX:i.x,worldY:i.y,screenX:t.clientX,screenY:t.clientY,timestamp:Date.now()};if(this.trigger("mousedown",n),!this.physicsEnabled){var o=this.getSortedEntitiesForInteraction().find(function(t){return e.isPointInEntity(i.x,i.y,t)&&t.isDraggable()});if(o){this.draggedEntity=o,this.entities.forEach(function(t){t.zIndex>o.zIndex&&t.zIndex--});var s=0;this.entities.forEach(function(t){s=Math.max(s,t.zIndex||0)}),o.zIndex=s+1,this.draggedEntity.dragStartX=i.x-o.absoluteX,this.draggedEntity.dragStartY=i.y-o.absoluteY,o.trigger("drag",n)}}}}},{key:"_handleMouseUp",value:function(t){if(this.running&&2!==t.buttons){var e=this.camera.screenToWorld(t.clientX,t.clientY),i={x:e.x,y:e.y,worldX:e.x,worldY:e.y,screenX:t.clientX,screenY:t.clientY,timestamp:Date.now()};this.trigger("mouseup",i),this.physicsEnabled||this.draggedEntity&&(this.draggedEntity.trigger("drop",i),this.draggedEntity=null)}}},{key:"_handleMouseMove",value:function(t){var e=this;if(this.running&&2!==t.buttons){var i=this.camera.screenToWorld(t.clientX,t.clientY),n={x:i.x,y:i.y,worldX:i.x,worldY:i.y,screenX:t.clientX,screenY:t.clientY,timestamp:Date.now()};if(this.trigger("mousemove",n),!this.physicsEnabled){if(this.draggedEntity&&this.draggedEntity.isDraggable()){var o=i.x-this.draggedEntity.dragStartX,s=i.y-this.draggedEntity.dragStartY;if(this.draggedEntity.parent&&this.draggedEntity.constrainToParent){var r=this.draggedEntity.parent,a=r.width-this.draggedEntity.width,l=r.height-this.draggedEntity.height;o=Math.max(0,Math.min(a,o-r.absoluteX)),s=Math.max(0,Math.min(l,s-r.absoluteY))}else this.draggedEntity.parent&&(o-=this.draggedEntity.parent.absoluteX,s-=this.draggedEntity.parent.absoluteY);return this.draggedEntity.style({x:o,y:s}),void this.draggedEntity.trigger("dragMove",n)}var h=this.getSortedEntitiesForInteraction().find(function(t){return e.isPointInEntity(i.x,i.y,t)&&t.isHoverable()});h!==this.hoveredEntity&&(this.hoveredEntity&&this.hoveredEntity.trigger("hoverOut",n),h?(this.hoveredEntity=h,h.trigger("hover",n)):this.hoveredEntity=null)}}}},{key:"_handleWheel",value:function(t){var e;if(this.running){null==t||null===(e=t.preventDefault)||void 0===e||e.call(t);var i=this.camera.screenToWorld(t.clientX,t.clientY),n={x:i.x,y:i.y,worldX:i.x,worldY:i.y,screenX:t.clientX,screenY:t.clientY,deltaX:t.deltaX,deltaY:t.deltaY,deltaZ:t.deltaZ,deltaMode:t.deltaMode,timestamp:Date.now()};this.trigger("wheel",n)}}},{key:"_handleClick",value:function(t){2!==t.button&&this._handleClicks(t,"click")}},{key:"_handleRightClick",value:function(t){this._handleClicks(t,"rightclick")}},{key:"_handleClicks",value:function(t,e){var i,n=this;if(null==t||null===(i=t.preventDefault)||void 0===i||i.call(t),this.timeout(function(){var t,e;return null===(t=n.canvas)||void 0===t||null===(e=t.focus)||void 0===e?void 0:e.call(t)},0),this.running){var o=this.camera.screenToWorld(t.clientX,t.clientY),s={x:o.x,y:o.y,worldX:o.x,worldY:o.y,screenX:t.clientX,screenY:t.clientY,timestamp:Date.now()},r=this.getSortedEntitiesForInteraction().find(function(t){return n.isPointInEntity(o.x,o.y,t)&&t.isClickable()});r&&r.trigger(e,s),this.trigger(e,s)}}},{key:"isKeyPressed",value:function(){for(var t=this,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return i.some(function(e){return t.pressedKeys.has(e)})}},{key:"_handleKeyDown",value:function(t){var e;null==t||null===(e=t.preventDefault)||void 0===e||e.call(t);var i=S(A,this,D).call(this,t.key);this.pressedKeys.add(i);var n=S(A,this,k).call(this,this.pressedKeys).join("+");this.trigger("keydown",n,t),this.trigger(n,n,t)}},{key:"_handleKeyUp",value:function(t){var e;null==t||null===(e=t.preventDefault)||void 0===e||e.call(t);var i=S(A,this,D).call(this,t.key);this.pressedKeys.delete(i),this.trigger("keyup",i,t)}},{key:"hexToRgb",value:function(t){var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}},{key:"rgbToHex",value:function(t,e,i){return"#"+[t,e,i].map(function(t){var e=t.toString(16);return 1===e.length?"0"+e:e}).join("")}},{key:"hslToRgb",value:function(t,e,i){var n,o,s;if(0===e)n=o=s=i;else{var r=function(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t},a=i<.5?i*(1+e):i+e-i*e,l=2*i-a;n=r(l,a,t+1/3),o=r(l,a,t),s=r(l,a,t-1/3)}return{r:Math.round(255*n),g:Math.round(255*o),b:Math.round(255*s)}}},{key:"randHex",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=Math.floor(256*Math.random()),i=Math.floor(256*Math.random()),n=Math.floor(256*Math.random()),o=function(t){return t.toString(16).padStart(2,"0")};if(t){var s=Math.floor(256*Math.random());return"#".concat(o(e)).concat(o(i)).concat(o(n)).concat(o(s))}return"#".concat(o(e)).concat(o(i)).concat(o(n))}},{key:"randRgb",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=Math.floor(256*Math.random()),i=Math.floor(256*Math.random()),n=Math.floor(256*Math.random());if(t){var o=Math.random().toFixed(2);return"rgba(".concat(e,", ").concat(i,", ").concat(n,", ").concat(o,")")}return"rgb(".concat(e,", ").concat(i,", ").concat(n,")")}},{key:"randHsl",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=t.hueRange,n=void 0===i?[0,360]:i,o=t.saturationRange,s=void 0===o?[0,100]:o,r=t.lightnessRange,a=void 0===r?[0,100]:r,l=Math.floor(Math.random()*(n[1]-n[0])+n[0]),h=Math.floor(Math.random()*(s[1]-s[0])+s[0]),c=Math.floor(Math.random()*(a[1]-a[0])+a[0]);if(e){var m=Math.random().toFixed(2);return"hsla(".concat(l,", ").concat(h,"%, ").concat(c,"%, ").concat(m,")")}return"hsl(".concat(l,", ").concat(h,"%, ").concat(c,"%)")}},{key:"adjustAlpha",value:function(t,e){if(t.includes("rgba"))return t.replace(/rgba\((.+),\s*([0-9.]+)\)/,function(t,i,n){var o=Math.min(parseFloat(n)*e,1);return"rgba(".concat(i,", ").concat(o,")")});if(t.includes("rgb")){var i=t.match(/rgb\((.+)\)/)[1],n=Math.min(.5*e,1);return"rgba(".concat(i,", ").concat(n,")")}var o=t.replace("#",""),s=parseInt(o.substr(0,2),16),r=parseInt(o.substr(2,2),16),a=parseInt(o.substr(4,2),16),l=Math.min(.5*e,1);return"rgba(".concat(s,", ").concat(r,", ").concat(a,", ").concat(l,")")}},{key:"getDistance",value:function(t,e,i,n){return Math.sqrt(Math.pow(i-t,2)+Math.pow(n-e,2))}},{key:"randBetween",value:function(t,e){return Math.floor(Math.random()*(e-t+1)+t)}},{key:"clamp",value:function(t,e,i){return Math.min(Math.max(t,e),i)}},{key:"lerp",value:function(t,e,i){return t+(e-t)*i}},{key:"degToRad",value:function(t){return t*(Math.PI/180)}},{key:"radToDeg",value:function(t){return t*(180/Math.PI)}},{key:"getAngle",value:function(t,e,i,n){return Math.atan2(n-e,i-t)}},{key:"rotatePoint",value:function(t,e,i,n,o){var s=this.degToRad(o),r=Math.cos(s),a=Math.sin(s),l=i-t,h=n-e;return{x:t+(l*r-h*a),y:e+(l*a+h*r)}}},{key:"wait",value:(t=function(t){return function(){var e=this,i=arguments;return new Promise(function(n,o){var s=t.apply(e,i);function r(t){_(s,n,o,r,a,"next",t)}function a(t){_(s,n,o,r,a,"throw",t)}r(void 0)})}}(p().m(function t(){var e,i,n,o,s,r=arguments;return p().w(function(t){for(;;)switch(t.p=t.n){case 0:for(e=r.length,i=new Array(e),n=0;n<e;n++)i[n]=r[n];if(0!==i.length){t.n=1;break}return t.a(2,[]);case 1:if(0!==(o=this._flattenPromises(i)).length){t.n=2;break}return t.a(2,[]);case 2:return t.p=2,t.n=3,Promise.all(o);case 3:return t.a(2,t.v);case 4:throw t.p=4,s=t.v,new Error("Wait operation failed: ".concat(s.message));case 5:return t.a(2)}},t,this,[[2,4]])})),function(){return t.apply(this,arguments)})},{key:"_flattenPromises",value:function(t){var e,i=[],n=d(t);try{for(n.s();!(e=n.n()).done;){var o=e.value;Array.isArray(o)?i.push.apply(i,y(this._flattenPromises(o))):o&&"function"==typeof o.then?i.push(o):null!=o&&i.push(Promise.resolve(o))}}catch(t){n.e(t)}finally{n.f()}return i}}],[{key:"dataURLToBlob",value:function(t){for(var e=t.split(","),i=e[0].match(/:(.*?);/)[1],n=atob(e[1]),o=n.length,s=new Uint8Array(o);o--;)s[o]=n.charCodeAt(o);return new Blob([s],{type:i})}},{key:"scriptToUrl",value:function(t){try{return new URL(t),t}catch(t){}var e=function(t){return"function"==typeof t};if(e(t))t="".concat(t.toString(),"()");else{if(/^(?:\.\/|\.\.\/|\/|[^/]*\.[a-zA-Z0-9]{1,5}$)/.test(t)&&!/\s/.test(t))return t;if(/^[a-zA-Z_$][\w$]*$/.test(String(t).trim())){var i=String(t).trim(),n=globalThis[i];e(n)&&(t="(".concat(n.toString(),")();"))}else if(!/[(){}\[\];=>]/.test(t)&&!/\b(function|=>|var|let|const|if|for|while|return)\b/.test(t))throw new Error("".concat(t," is not valid"))}var o=new Blob([t],{type:"application/javascript"});return URL.createObjectURL(o)}}]);var t}();function D(t){return this.keyMap[t.toLowerCase()]||t.toLowerCase()}function k(t){var e=["ctrl","shift","alt","meta"];return y(t).sort(function(t,i){var n=e.indexOf(t),o=e.indexOf(i);return(-1===n?99:n)-(-1===o?99:o)||t.localeCompare(i)})}const B=M;function I(t){return I="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},I(t)}function V(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,P(n.key),n)}}function P(t){var e=function(t,e){if("object"!=I(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=I(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==I(e)?e:e+""}var T=function(){return function(t,e,i){return e&&V(t.prototype,e),i&&V(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t)},null,[{key:"getPoint",value:function(t,e,i,n,o){var s=1-o;return{x:s*s*s*t.x+3*s*s*o*e.x+3*s*o*o*i.x+o*o*o*n.x,y:s*s*s*t.y+3*s*s*o*e.y+3*s*o*o*i.y+o*o*o*n.y}}},{key:"getPoints",value:function(t,e,i,n){for(var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:20,s=[],r=0;r<=1;r+=1/o)s.push(this.getPoint(t,e,i,n,r));return s}},{key:"getQuadraticPoint",value:function(t,e,i,n){var o=1-n;return{x:o*o*t.x+2*o*n*e.x+n*n*i.x,y:o*o*t.y+2*o*n*e.y+n*n*i.y}}},{key:"getLength",value:function(t,e,i,n){for(var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:100,s=0,r=this.getPoint(t,e,i,n,0),a=1;a<=o;a++){var l=a/o,h=this.getPoint(t,e,i,n,l),c=h.x-r.x,m=h.y-r.y;s+=Math.sqrt(c*c+m*m),r=h}return s}}])}();const L=T;var G={linear:function(t){return t},easeInQuad:function(t){return t*t},easeOutQuad:function(t){return t*(2-t)},easeInOutQuad:function(t){return t<.5?2*t*t:(4-2*t)*t-1},easeInCubic:function(t){return t*t*t},easeOutCubic:function(t){return--t*t*t+1},easeInOutCubic:function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1},easeInQuart:function(t){return t*t*t*t},easeOutQuart:function(t){return 1- --t*t*t*t},easeInOutQuart:function(t){return t<.5?8*t*t*t*t:1-8*--t*t*t*t},easeInQuint:function(t){return t*t*t*t*t},easeOutQuint:function(t){return 1+--t*t*t*t*t},easeInOutQuint:function(t){return t<.5?16*t*t*t*t*t:1+16*--t*t*t*t*t},easeInSine:function(t){return 1-Math.cos(t*Math.PI/2)},easeOutSine:function(t){return Math.sin(t*Math.PI/2)},easeInOutSine:function(t){return-(Math.cos(Math.PI*t)-1)/2},easeInExpo:function(t){return 0===t?0:Math.pow(2,10*(t-1))},easeOutExpo:function(t){return 1===t?1:1-Math.pow(2,-10*t)},easeInOutExpo:function(t){return 0===t?0:1===t?1:t<.5?Math.pow(2,20*t-10)/2:(2-Math.pow(2,-20*t+10))/2},easeInCirc:function(t){return 1-Math.sqrt(1-t*t)},easeOutCirc:function(t){return Math.sqrt(1- --t*t)},easeInOutCirc:function(t){return t<.5?(1-Math.sqrt(1-4*t*t))/2:(Math.sqrt(1-4*(t-1)*(t-1))+1)/2},easeInBounce:function(t){return 1-G.easeOutBounce(1-t)},easeOutBounce:function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},easeInOutBounce:function(t){return t<.5?.5*G.easeInBounce(2*t):.5*G.easeOutBounce(2*t-1)+.5},easeInElastic:function(t){return 0===t?0:1===t?1:-Math.pow(2,10*(t-1))*Math.sin(5*(t-1.1)*Math.PI)},easeOutElastic:function(t){return 0===t?0:1===t?1:Math.pow(2,-10*t)*Math.sin(5*(t-.1)*Math.PI)+1},easeInOutElastic:function(t){return 0===t?0:1===t?1:(t*=2)<1?-.5*Math.pow(2,10*(t-1))*Math.sin(5*(t-1.1)*Math.PI):.5*Math.pow(2,-10*(t-1))*Math.sin(5*(t-1.1)*Math.PI)+1},easeStepStart:function(t){return 0===t?0:1},easeStepEnd:function(t){return 1===t?1:0},easeSteps:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;return Math.floor(t*e)/(e-1)},easeInBack:function(t){var e=1.70158;return e*t*t*t-e*t*t},easeOutBack:function(t){var e=1.70158;return 1+e*Math.pow(t-1,3)+e*Math.pow(t-1,2)},easeInOutBack:function(t){var e=2.5949095;return t<.5?Math.pow(2*t,2)*(7.189819*t-e)/2:(Math.pow(2*t-2,2)*((e+1)*(2*t-2)+e)+2)/2}};const E=G;function F(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,o,s,r,a=[],l=!0,h=!1;try{if(s=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;l=!1}else for(;!(l=(n=s.call(i)).done)&&(a.push(n.value),a.length!==e);l=!0);}catch(t){h=!0,o=t}finally{try{if(!l&&null!=i.return&&(r=i.return(),Object(r)!==r))return}finally{if(h)throw o}}return a}}(t,e)||function(t,e){if(t){if("string"==typeof t)return R(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?R(t,e):void 0}}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function R(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function O(t){return O="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},O(t)}function J(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function z(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?J(Object(i),!0).forEach(function(e){j(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):J(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function j(t,e,i){return(e=X(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function N(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,X(n.key),n)}}function X(t){var e=function(t,e){if("object"!=O(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=O(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==O(e)?e:e+""}var W=function(){return function(t,e,i){return e&&N(t.prototype,e),i&&N(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(e){var i,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.engine=e,this.config={x:n.x||0,y:n.y||0,zoom:n.zoom||1,bounds:n.bounds||null,minZoom:n.minZoom||.1,maxZoom:n.maxZoom||5,smoothing:null===(i=n.smoothing)||void 0===i||i,smoothSpeed:n.smoothSpeed||.1,rotation:n.rotation||0},this._originalConfig=z({},this.config),this.x=this.config.x,this.y=this.config.y,this.zoom=this.config.zoom,this.bounds=this.config.bounds,this.minZoom=this.config.minZoom,this.maxZoom=this.config.maxZoom,this.smoothing=this.config.smoothing,this.smoothSpeed=this.config.smoothSpeed,this._targetX=this.x,this._targetY=this.y,this._targetZoom=this.zoom,this._lastX=this.x,this._lastY=this.y,this._lastZoom=this.zoom,this.deltaX=0,this.deltaY=0,this.deltaZoom=0,this._followedEntity=null,this._followConfig=null,this._followOffset={x:0,y:0},this._states=new Map,this._effects={shake:null},this.rotation=this.config.rotation,this._targetRotation=this.rotation,this._lastRotation=this.rotation,this.deltaRotation=0},[{key:"moveTo",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"easeInOutCubic";if(this.bounds){var r=this.engine.baseWidth/this.zoom,a=this.engine.baseHeight/this.zoom;t=this.bounds.width>r?Math.min(Math.max(t,this.bounds.x),this.bounds.x+this.bounds.width-r):this.bounds.x+(this.bounds.width-r)/2,i=this.bounds.height>a?Math.min(Math.max(i,this.bounds.y),this.bounds.y+this.bounds.height-a):this.bounds.y+(this.bounds.height-a)/2}if(n||!o)return this.x=this._targetX=t,this.y=this._targetY=i,this;var l=this.x,h=this.y,c=Date.now();this.smoothing=!1,s="function"==typeof s?s:this.engine.Ease[s]||this.engine.Ease.easeInOutCubic;var m=function(){var n=Math.min((Date.now()-c)/o,1),r=s(n);e.x=e._targetX=l+(t-l)*r,e.y=e._targetY=h+(i-h)*r,n<1?requestAnimationFrame(m):e.smoothing=!0};return m(),this}},{key:"moveBy",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"easeInOutCubic";return this.moveTo(this.x+t,this.y+e,i,n,o)}},{key:"getCurrentCenter",value:function(){var t=this.engine.baseWidth/this.zoom,e=this.engine.baseHeight/this.zoom;return{x:this.x+t/2,y:this.y+e/2}}},{key:"zoomTo",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"easeInOutCubic";if("object"===O(t)){var r=t;t=r.zoom,i=r.centerX,n=r.centerY;var a=r.duration;o=void 0===a?500:a;var l=r.easing;s=void 0===l?"easeInOutCubic":l}t=Math.min(Math.max(t,this.minZoom),this.maxZoom);var h=this.getCurrentCenter();i=null!=i?i:h.x,n=null!=n?n:h.y;var c=this.zoom,m=this.x,u=this.y,y=Date.now(),p=(this.engine.baseWidth,this.engine.baseHeight,this.engine.baseWidth/t),f=this.engine.baseHeight/t,_=i-p/2,d=n-f/2;this.bounds&&(_=this.bounds.width>p?Math.min(Math.max(_,this.bounds.x),this.bounds.x+this.bounds.width-p):this.bounds.x+(this.bounds.width-p)/2,d=this.bounds.height>f?Math.min(Math.max(d,this.bounds.y),this.bounds.y+this.bounds.height-f):this.bounds.y+(this.bounds.height-f)/2);var v=this.smoothing;this.smoothing=!1,s="function"==typeof s?s:this.engine.Ease[s]||this.engine.Ease.easeInOutCubic;var b=function(){var i=Date.now()-y,n=Math.min(i/o,1),r=s(n);e.zoom=c+(t-c)*r;var a,l,h=e.engine.baseWidth/e.zoom,p=e.engine.baseHeight/e.zoom;e.bounds?(e.bounds.width>h?(a=m+(_-m)*r,a=Math.min(Math.max(a,e.bounds.x),e.bounds.x+e.bounds.width-h)):a=e.bounds.x+(e.bounds.width-h)/2,e.bounds.height>p?(l=u+(d-u)*r,l=Math.min(Math.max(l,e.bounds.y),e.bounds.y+e.bounds.height-p)):l=e.bounds.y+(e.bounds.height-p)/2):(a=m+(_-m)*r,l=u+(d-u)*r),e.x=a,e.y=l,e._targetZoom=e.zoom,e._targetX=e.x,e._targetY=e.y,n<1?requestAnimationFrame(b):e.smoothing=v};return b(),this}},{key:"zoomToLevel",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"easeInOutCubic";return this.zoomTo(t,e,i,n,o)}},{key:"zoomBy",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"easeInOutCubic";return this.zoomTo(this.zoom*t,e,i,n,o)}},{key:"zoomAtPoint",value:function(t,e,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"easeInOutCubic",s=this.screenToWorld(e,i);return this.zoomTo(this.zoom*t,s.x,s.y,n,o)}},{key:"rotate",value:function(t){var e=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:500,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"easeInOutCubic";if((t%=360)<0&&(t+=360),arguments.length>1&&void 0!==arguments[1]&&arguments[1]||!i)return this.rotation=this._targetRotation=t,this;var o=this.rotation,s=Date.now();this.smoothing=!1,n="function"==typeof n?n:this.engine.Ease[n]||this.engine.Ease.easeInOutCubic;var r=function(){var a=Math.min((Date.now()-s)/i,1),l=n(a),h=t-o;Math.abs(h)>180&&(h>0?h-=360:h+=360),e.rotation=e._targetRotation=o+h*l,a<1?requestAnimationFrame(r):e.smoothing=!0};return r(),this}},{key:"rotateBy",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:500,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"easeInOutCubic";return this.rotate(this.rotation+t,e,i,n)}},{key:"setBounds",value:function(t){return this.bounds=t,this._enforceBounds(),this}},{key:"_enforceBounds",value:function(){if(this.bounds){var t=this.engine.baseWidth/this._targetZoom,e=this.engine.baseHeight/this._targetZoom;this.bounds.width>t?this._targetX=Math.min(Math.max(this._targetX,this.bounds.x),this.bounds.x+this.bounds.width-t):this._targetX=this.bounds.x+(this.bounds.width-t)/2,this.bounds.height>e?this._targetY=Math.min(Math.max(this._targetY,this.bounds.y),this.bounds.y+this.bounds.height-e):this._targetY=this.bounds.y+(this.bounds.height-e)/2}}},{key:"focusOn",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.zoom,n=this.engine.baseWidth/i,o=this.engine.baseHeight/i;return this.moveTo(t-n/2,e-o/2).zoomTo(i)}},{key:"focusOnRect",value:function(t){var e,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this.engine.baseWidth/this.engine.baseHeight;return e=(t.width+2*i)/(t.height+2*i)>n?this.engine.baseWidth/(t.width+2*i):this.engine.baseHeight/(t.height+2*i),this.focusOn(t.x+t.width/2,t.y+t.height/2,Math.min(Math.max(e,this.minZoom),this.maxZoom))}},{key:"apply",value:function(){var t=this.engine.ctx;t.save(),t.translate(this.engine.baseWidth/2,this.engine.baseHeight/2),t.rotate(this.rotation*Math.PI/180),t.scale(this.zoom,this.zoom),t.translate(-this.engine.baseWidth/(2*this.zoom)-this.x,-this.engine.baseHeight/(2*this.zoom)-this.y)}},{key:"update",value:function(){var t;if(this._lastRotation=this.rotation,this._lastX=this.x,this._lastY=this.y,this._lastZoom=this.zoom,this._followedEntity&&this._followConfig){var e=this._calculateFollowPosition();e&&(this._followConfig.smooth?(this._targetX=e.x,this._targetY=e.y):(this.x=this._targetX=e.x,this.y=this._targetY=e.y))}if(this.smoothing||this._followedEntity&&null!==(t=this._followConfig)&&void 0!==t&&t.smooth){var i,n=(null===(i=this._followConfig)||void 0===i?void 0:i.smoothSpeed)||this.smoothSpeed;this.x+=(this._targetX-this.x)*n,this.y+=(this._targetY-this.y)*n,this.zoom+=(this._targetZoom-this.zoom)*this.smoothSpeed,this.rotation+=(this._targetRotation-this.rotation)*this.smoothSpeed}else this.x=this._targetX,this.y=this._targetY,this.zoom=this._targetZoom,this.rotation=this._targetRotation;this.deltaX=this.x-this._lastX,this.deltaY=this.y-this._lastY,this.deltaZoom=this.zoom-this._lastZoom,this.deltaRotation=this.rotation-this._lastRotation,this._enforceBounds(),this._updateEffects(this.engine.ctx)}},{key:"screenToWorld",value:function(t,e){var i=this.engine.canvas.getBoundingClientRect(),n=(t-i.left)*(this.engine.canvas.width/i.width),o=(e-i.top)*(this.engine.canvas.height/i.height),s=n/this.engine.config.quality,r=o/this.engine.config.quality,a=s-this.engine.baseWidth/2,l=r-this.engine.baseHeight/2,h=-this.rotation*Math.PI/180,c=a*Math.cos(h)-l*Math.sin(h),m=a*Math.sin(h)+l*Math.cos(h);return{x:c/this.zoom+this.x+this.engine.baseWidth/(2*this.zoom),y:m/this.zoom+this.y+this.engine.baseHeight/(2*this.zoom)}}},{key:"worldToScreen",value:function(t,e){var i=(t-this.x)*this.zoom,n=(e-this.y)*this.zoom,o=this.rotation*Math.PI/180,s=i*Math.cos(o)-n*Math.sin(o),r=i*Math.sin(o)+n*Math.cos(o),a=s*this.engine.config.quality,l=r*this.engine.config.quality,h=this.engine.canvas.getBoundingClientRect();return{x:a*(h.width/this.engine.canvas.width)+h.left+h.width/2,y:l*(h.height/this.engine.canvas.height)+h.top+h.height/2}}},{key:"follow",value:function(t){var e,i,n,o,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!this.engine.isEntity(t))throw new Error("Entity is required");return this._followedEntity=t,this._followConfig={behavior:s.behavior||"center",offset:{x:(null===(e=s.offset)||void 0===e?void 0:e.x)||0,y:(null===(i=s.offset)||void 0===i?void 0:i.y)||0},deadzone:{x:(null===(n=s.deadzone)||void 0===n?void 0:n.x)||0,y:(null===(o=s.deadzone)||void 0===o?void 0:o.y)||0},smooth:void 0===s.smooth||s.smooth,smoothSpeed:s.smoothSpeed||.1},this._followConfig.smoothSpeed=Math.min(Math.max(this._followConfig.smoothSpeed,0),1),this}},{key:"cancelFollow",value:function(){return this._followedEntity=null,this._followConfig=null,this._followOffset={x:0,y:0},this}},{key:"_calculateFollowPosition",value:function(){if(!this._followedEntity||!this._followConfig)return null;var t=this._followedEntity,e=this._followConfig,i=this.engine.baseWidth/this.zoom,n=this.engine.baseHeight/this.zoom,o=this.x,s=this.y,r=t.absoluteX+t.width/2,a=t.absoluteY+t.height/2,l=this.x,h=this.x+i,c=this.y,m=this.y+n,u=e.deadzone.x,y=e.deadzone.y;switch(e.behavior){case"center":o=r-i/2+e.offset.x,s=a-n/2+e.offset.y;break;case"edge":r<l+u?o=r-u:r>h-u&&(o=r+u-i),a<c+y?s=a-y:a>m-y&&(s=a+y-n);break;case"horizontal-edge":r<l+u?o=r-u:r>h-u&&(o=r+u-i);break;case"vertical-edge":a<c+y?s=a-y:a>m-y&&(s=a+y-n);break;case"top":o=r-i/2+e.offset.x,s=a-y+e.offset.y;break;case"bottom":o=r-i/2+e.offset.x,s=a+y-n+e.offset.y;break;case"left":o=r-u+e.offset.x,s=a-n/2+e.offset.y;break;case"right":o=r+u-i+e.offset.x,s=a-n/2+e.offset.y}return this.bounds&&(o=this.bounds.width>i?Math.min(Math.max(o,this.bounds.x),this.bounds.x+this.bounds.width-i):this.bounds.x+(this.bounds.width-i)/2,s=this.bounds.height>n?Math.min(Math.max(s,this.bounds.y),this.bounds.y+this.bounds.height-n):this.bounds.y+(this.bounds.height-n)/2),{x:o,y:s}}},{key:"saveState",value:function(t){if(!t)throw new Error("Status name cannot be empty.");var e={x:this.x,y:this.y,zoom:this.zoom,_targetX:this._targetX,_targetY:this._targetY,_targetZoom:this._targetZoom,smoothing:this.smoothing,smoothSpeed:this.smoothSpeed,bounds:this.bounds?z({},this.bounds):null,minZoom:this.minZoom,maxZoom:this.maxZoom,_followedEntity:this._followedEntity,_followConfig:this._followConfig?z({},this._followConfig):null,_followOffset:z({},this._followOffset),timestamp:(new Date).toISOString()};return this._states.set(t,e),this}},{key:"loadState",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=this._states.get(t);if(!i)throw new Error('No status with name "'.concat(t,'" found.'));var n=e.smooth,o=void 0!==n&&n,s=e.duration,r=void 0===s?500:s;return o?this.zoomTo({zoom:i.zoom,centerX:i.x+this.engine.baseWidth/i.zoom/2,centerY:i.y+this.engine.baseHeight/i.zoom/2,duration:r}):(this.x=this._targetX=i.x,this.y=this._targetY=i.y,this.zoom=this._targetZoom=i.zoom),this.smoothing=i.smoothing,this.smoothSpeed=i.smoothSpeed,this.bounds=i.bounds?z({},i.bounds):null,this.minZoom=i.minZoom,this.maxZoom=i.maxZoom,i._followedEntity?(this._followedEntity=i._followedEntity,this._followConfig=i._followConfig?z({},i._followConfig):null,this._followOffset=z({},i._followOffset)):this.cancelFollow(),this}},{key:"deleteState",value:function(t){return this._states.delete(t)}},{key:"getStatesList",value:function(){return Array.from(this._states.keys())}},{key:"hasState",value:function(t){return this._states.has(t)}},{key:"shake",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};"number"==typeof e&&(e={intensity:e});var i=e,n=i.intensity,o=void 0===n?5:n,s=i.duration,r=void 0===s?500:s,a=(i.frequency,i.falloff),l=void 0===a?"linear":a,h=Date.now(),c=this.x,m=this.y;return this._effects.shake={animate:function(){var e=Date.now()-h;if(e<r){var i=e/r,n="linear"===l?o*(1-i):o*Math.pow(1-i,2),s=2*(Math.random()-.5)*n,a=2*(Math.random()-.5)*n,u=c+s,y=m+a;if(t.bounds){var p=t.engine.baseWidth/t.zoom,f=t.engine.baseHeight/t.zoom;u=t.bounds.width>p?Math.min(Math.max(u,t.bounds.x),t.bounds.x+t.bounds.width-p):t.bounds.x+(t.bounds.width-p)/2,y=t.bounds.height>f?Math.min(Math.max(y,t.bounds.y),t.bounds.y+t.bounds.height-f):t.bounds.y+(t.bounds.height-f)/2}return t.x=u,t.y=y,!0}if(t.bounds){var _=t.engine.baseWidth/t.zoom,d=t.engine.baseHeight/t.zoom;t.bounds.width>_?t.x=Math.min(Math.max(c,t.bounds.x),t.bounds.x+t.bounds.width-_):t.x=t.bounds.x+(t.bounds.width-_)/2,t.bounds.height>d?t.y=Math.min(Math.max(m,t.bounds.y),t.bounds.y+t.bounds.height-d):t.y=t.bounds.y+(t.bounds.height-d)/2}else t.x=c,t.y=m;return t._effects.shake=null,!1}},this}},{key:"dramaticFocus",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,o=this.zoom,s=this.x,r=this.y,a=Date.now(),l=t.x-this.engine.baseWidth/n/2,h=t.y-this.engine.baseHeight/n/2;return this._effects.dramaticFocus={animate:function(){var t=Date.now()-a,c=Math.min(t/i,1),m=e.engine.Ease.easeInOutCubic(c);return e.zoom=o+(n-o)*m,e.x=s+(l-s)*m,e.y=r+(h-r)*m,c<1}},this}},{key:"_updateEffects",value:function(t){for(var e=0,i=Object.entries(this._effects);e<i.length;e++){var n=F(i[e],2),o=n[0],s=n[1];s&&!s.animate(t)&&(this._effects[o]=null)}}},{key:"reset",value:function(){return this.x=this._originalConfig.x,this.y=this._originalConfig.y,this.zoom=this._originalConfig.zoom,this.rotation=this._originalConfig.rotation,this._targetX=this.x,this._targetY=this.y,this._targetZoom=this.zoom,this._targetRotation=this.rotation,this._lastX=this.x,this._lastY=this.y,this._lastZoom=this.zoom,this._lastRotation=this.rotation,this.deltaX=0,this.deltaY=0,this.deltaZoom=0,this.deltaRotation=0,this.bounds=this._originalConfig.bounds,this.minZoom=this._originalConfig.minZoom,this.maxZoom=this._originalConfig.maxZoom,this.smoothing=this._originalConfig.smoothing,this.smoothSpeed=this._originalConfig.smoothSpeed,this.cancelFollow(),this._states.clear(),this._effects={shake:null},this}}])}();const Y=W;function q(t){return q="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},q(t)}function U(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,K(n.key),n)}}function K(t){var e=function(t,e){if("object"!=q(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=q(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==q(e)?e:e+""}var Z=function(){return function(t,e,i){return e&&U(t.prototype,e),i&&U(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.engine=e,this.layers=new Map,this.layerCounter=0},[{key:"add",value:function(t){var e,i,n,o,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=s.id||"bg_layer_".concat(++this.layerCounter),a=this._detectSourceType(t),l={id:r,source:t,sourceType:a,asset:"asset"===a?this.engine.getAsset(t):null,width:s.width||null,height:s.height||null,x:s.x||0,y:s.y||0,scale:s.scale||1,rotation:s.rotation||0,opacity:void 0!==s.opacity?s.opacity:1,parallax:void 0!==s.parallax?s.parallax:1,parallaxX:void 0!==s.parallaxX?s.parallaxX:s.parallax||1,parallaxY:void 0!==s.parallaxY?s.parallaxY:s.parallax||1,repeat:s.repeat||"none",speed:{x:(null===(e=s.speed)||void 0===e?void 0:e.x)||0,y:(null===(i=s.speed)||void 0===i?void 0:i.y)||0},offset:{x:(null===(n=s.offset)||void 0===n?void 0:n.x)||0,y:(null===(o=s.offset)||void 0===o?void 0:o.y)||0},top:s.top||!1,zIndex:s.zIndex||0,visible:void 0===s.visible||s.visible,_currentOffset:{x:0,y:0}};return"asset"!==a||l.asset?(this.layers.set(r,l),r):(this.engine.warn("Background asset '".concat(t,"' not found")),null)}},{key:"get",value:function(t){return this.layers.get(t)||null}},{key:"remove",value:function(t){return this.layers.delete(t)}},{key:"clear",value:function(){return this.layers.clear(),this.layerCounter=0,this}},{key:"setOrder",value:function(t,e){var i=this.layers.get(t);return!!i&&(i.zIndex=e,!0)}},{key:"setVisible",value:function(t,e){var i=this.layers.get(t);return!!i&&(i.visible=e,!0)}},{key:"update",value:function(t,e){var i=this.layers.get(t);return!!i&&(Object.keys(e).forEach(function(t){"speed"===t||"offset"===t?Object.assign(i[t],e[t]):i[t]=e[t]}),!0)}},{key:"_updateLayers",value:function(t){this.layers.forEach(function(e){e.visible&&(e._currentOffset.x+=e.speed.x*(t/1e3),e._currentOffset.y+=e.speed.y*(t/1e3))})}},{key:"_renderLayers",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];Array.from(this.layers.values()).filter(function(t){return t.visible&&t.top===i}).sort(function(t,e){return t.zIndex-e.zIndex}).forEach(function(i){e._renderLayer(t,i)})}},{key:"_renderLayer",value:function(t,e){t.save(),e.opacity<1&&(t.globalAlpha=e.opacity);var i=this.engine.camera,n=Math.floor(i.x),o=Math.floor(i.y),s=this.engine.baseWidth/i.zoom,r=this.engine.baseHeight/i.zoom,a=n*(1-e.parallaxX),l=o*(1-e.parallaxY),h=e.x+a+e.offset.x+e._currentOffset.x,c=e.y+l+e.offset.y+e._currentOffset.y;"color"===e.sourceType?this._renderColorBackground(t,e,h,c,n,o,s,r):"asset"===e.sourceType&&e.asset&&this._renderImageBackground(t,e,h,c,n,o,s,r),t.restore()}},{key:"_renderColorBackground",value:function(t,e,i,n,o,s,r,a){t.fillStyle=e.source,t.fillRect(o,s,r,a)}},{key:"_renderImageBackground",value:function(t,e,i,n,o,s,r,a){var l=e.asset.asset;t.imageSmoothingEnabled=!1,"none"===e.repeat?this._renderSingleImage(t,e,l,i,n):this._renderRepeatingBackground(t,e,l,i,n,o,s,r,a)}},{key:"_renderSingleImage",value:function(t,e,i,n,o){var s=null!=e.width?e.width:i.width*e.scale,r=null!=e.height?e.height:i.height*e.scale;0!==e.rotation?(t.save(),t.translate(n+s/2,o+r/2),t.rotate(e.rotation),t.drawImage(i,-s/2,-r/2,s,r),t.restore()):t.drawImage(i,n,o,s,r)}},{key:"_renderRepeatingBackground",value:function(t,e,i,n,o,s,r,a,l){var h=null!=e.width?e.width:i.width*e.scale,c=null!=e.height?e.height:i.height*e.scale,m=0,u=1,y=0,p=1;if("x"===e.repeat||"both"===e.repeat){var f=s-n;m=Math.floor(f/h)-1,u=Math.ceil((f+a)/h)+1}if("y"===e.repeat||"both"===e.repeat){var _=r-o;y=Math.floor(_/c)-1,p=Math.ceil((_+l)/c)+1}for(var d=y;d<p;d++)for(var v=m;v<u;v++){var b=n+v*h,g=o+d*c;b+h<s||b>s+a||g+c<r||g>r+l||(0!==e.rotation?(t.save(),t.translate(b+h/2,g+c/2),t.rotate(e.rotation),t.drawImage(i,-h/2,-c/2,h,c),t.restore()):t.drawImage(i,b,g,h,c))}}},{key:"_detectSourceType",value:function(t){if(this.engine.getAsset(t))return"asset";return"string"==typeof t&&/^(#[0-9a-fA-F]{3,8}|rgb\(|rgba\(|hsl\(|hsla\(|[a-zA-Z]+)$/.test(t.trim())?"color":void 0}}])}();const H=Z;function Q(t){return Q="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Q(t)}function $(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,tt(n.key),n)}}function tt(t){var e=function(t,e){if("object"!=Q(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=Q(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==Q(e)?e:e+""}var et=function(){return function(t,e,i){return e&&$(t.prototype,e),i&&$(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.engine=e,this.enabled=!1!==i.enabled,this.width=i.width||32,this.height=i.height||32,this.color=i.color||"rgba(0,0,0,0.3)",this.lineWidth=i.lineWidth||1,this.majorGridEvery=i.majorGridEvery||5,this.majorColor=i.majorColor||"rgba(0,0,0,0.6)",this.majorLineWidth=i.majorLineWidth||2,this.bounds=i.bounds||null,this.minZoomToShow=i.minZoomToShow||.1,this.maxZoomToShow=i.maxZoomToShow||10,this.maxLines=i.maxLines||1e3,this.originX=i.originX||0,this.originY=i.originY||0},[{key:"render",value:function(t){if(this.enabled){var e=this.engine.camera,i=e.zoom;if(!(i<this.minZoomToShow||i>this.maxZoomToShow)){t.save();var n=this.engine.baseWidth/i,o=this.engine.baseHeight/i,s=e.x,r=e.y,a=s+n,l=r+o,h=this.bounds?Math.max(s,this.bounds.x):s,c=this.bounds?Math.max(r,this.bounds.y):r,m=this.bounds?Math.min(a,this.bounds.x+this.bounds.width):a,u=this.bounds?Math.min(l,this.bounds.y+this.bounds.height):l,y=Math.floor((h-this.originX)/this.width)*this.width+this.originX,p=Math.floor((c-this.originY)/this.height)*this.height+this.originY;if(Math.ceil((m-y)/this.width)+Math.ceil((u-p)/this.height)>this.maxLines)t.restore();else{var f=Math.min(i/2,1);t.beginPath(),t.strokeStyle=this.engine.adjustAlpha(this.color,f),t.lineWidth=this.lineWidth/i;for(var _=y;_<=m;_+=this.width)if(!(_<h)){var d,v=Math.round((_-this.originX)/this.width);if(!(this.majorGridEvery>0&&v%this.majorGridEvery===0))t.moveTo(_,Math.max(c,(null===(d=this.bounds)||void 0===d?void 0:d.y)||c)),t.lineTo(_,Math.min(u,this.bounds?this.bounds.y+this.bounds.height:u))}t.stroke(),t.beginPath();for(var b=p;b<=u;b+=this.height)if(!(b<c)){var g,x=Math.round((b-this.originY)/this.height);if(!(this.majorGridEvery>0&&x%this.majorGridEvery===0))t.moveTo(Math.max(h,(null===(g=this.bounds)||void 0===g?void 0:g.x)||h),b),t.lineTo(Math.min(m,this.bounds?this.bounds.x+this.bounds.width:m),b)}if(t.stroke(),this.majorGridEvery>0){t.beginPath(),t.strokeStyle=this.engine.adjustAlpha(this.majorColor,f),t.lineWidth=this.majorLineWidth/i;for(var w=y;w<=m;w+=this.width){var C;if(!(w<h))if(Math.round((w-this.originX)/this.width)%this.majorGridEvery===0)t.moveTo(w,Math.max(c,(null===(C=this.bounds)||void 0===C?void 0:C.y)||c)),t.lineTo(w,Math.min(u,this.bounds?this.bounds.y+this.bounds.height:u))}for(var S=p;S<=u;S+=this.height){var A;if(!(S<c))if(Math.round((S-this.originY)/this.height)%this.majorGridEvery===0)t.moveTo(Math.max(h,(null===(A=this.bounds)||void 0===A?void 0:A.x)||h),S),t.lineTo(Math.min(m,this.bounds?this.bounds.x+this.bounds.width:m),S)}t.stroke()}t.restore()}}}}},{key:"snapToGrid",value:function(t,e){return{x:Math.round((t-this.originX)/this.width)*this.width+this.originX,y:Math.round((e-this.originY)/this.height)*this.height+this.originY}}},{key:"getGridCell",value:function(t,e){return{x:Math.floor((t-this.originX)/this.width),y:Math.floor((e-this.originY)/this.height)}}},{key:"cellToWorld",value:function(t,e){return{x:t*this.width+this.originX,y:e*this.height+this.originY}}},{key:"setEnabled",value:function(t){return this.enabled=t,this}},{key:"setSize",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t;return this.width=t,this.height=e,this}},{key:"setColors",value:function(t,e){return t&&(this.color=t),e&&(this.majorColor=e),this}},{key:"setLineWidth",value:function(t,e){return void 0!==t&&(this.lineWidth=t),void 0!==e&&(this.majorLineWidth=e),this}},{key:"setMajorGrid",value:function(t,e,i){return void 0!==t&&(this.majorGridEvery=t),e&&(this.majorColor=e),void 0!==i&&(this.majorLineWidth=i),this}},{key:"setBounds",value:function(t){return this.bounds=t,this}},{key:"setOrigin",value:function(t,e){return this.originX=t,this.originY=e,this}},{key:"setVisibilityRange",value:function(t,e){return void 0!==t&&(this.minZoomToShow=t),void 0!==e&&(this.maxZoomToShow=e),this}}])}();const it=et;function nt(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,o,s,r,a=[],l=!0,h=!1;try{if(s=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;l=!1}else for(;!(l=(n=s.call(i)).done)&&(a.push(n.value),a.length!==e);l=!0);}catch(t){h=!0,o=t}finally{try{if(!l&&null!=i.return&&(r=i.return(),Object(r)!==r))return}finally{if(h)throw o}}return a}}(t,e)||ot(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ot(t,e){if(t){if("string"==typeof t)return st(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?st(t,e):void 0}}function st(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function rt(t){return rt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},rt(t)}function at(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function lt(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?at(Object(i),!0).forEach(function(e){ht(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):at(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function ht(t,e,i){return(e=mt(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function ct(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,mt(n.key),n)}}function mt(t){var e=function(t,e){if("object"!=rt(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=rt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==rt(e)?e:e+""}function ut(t,e){(function(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")})(t,e),e.add(t)}function yt(t,e,i){if("function"==typeof t?t===e:t.has(e))return arguments.length<3?e:i;throw new TypeError("Private element is not present on this object")}var pt=new WeakSet,ft=function(){function t(e){var i,n,o,s,r,a,l,h,c,m,u,y,p,f=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),ut(this,pt),this.engine=f.engine,this.id=e;var _=f.class||"";this.class=new Set(_.split(/\s+/).filter(Boolean)),this.x=f.x||0,this.y=f.y||0,this.width=f.width||32,this.height=f.height||32,this._data={},this.parent=null,this.children=new Map,this.absoluteX=this.x,this.absoluteY=this.y,this.constrainToParent=null===(i=f.constrainToParent)||void 0===i||i,this.styles=lt(lt({},yt(pt,this,_t).call(this,f)),{},{shape:f.shape||"rectangle",blur:f.blur||0,opacity:null!==(n=f.opacity)&&void 0!==n?n:1,borderColor:f.borderColor,borderWidth:f.borderWidth||0,borderStyle:f.borderStyle||"solid",borderRadius:f.borderRadius||0,shadowColor:f.shadowColor,shadowBlur:f.shadowBlur||0,shadowOffsetX:f.shadowOffsetX||0,shadowOffsetY:f.shadowOffsetY||0,rotation:f.rotation||0,scale:f.scale||1,scaleX:f.scaleX||1,scaleY:f.scaleY||1,skewX:f.skewX||0,skewY:f.skewY||0,flipX:f.flipX||!1,flipY:f.flipY||!1,text:f.text,font:f.font||"16px Arial",color:f.color||"#000000",textAlign:f.textAlign||"center",lineHeight:f.lineHeight||1.2,textBaseline:f.textBaseline||"middle",transition:f.transition||{},visible:f.visible||!0,blendMode:f.blendMode||"source-over",clip:f.clip,mask:f.mask,filter:f.filter,points:f.points||[],customPath:f.customPath?f.customPath.bind(this):null,spikes:f.spikes||5}),this.collision={enabled:Boolean(f.collision),group:(null===(o=f.collision)||void 0===o?void 0:o.group)||"group_".concat(e),width:(null===(s=f.collision)||void 0===s?void 0:s.width)||this.width,height:(null===(r=f.collision)||void 0===r?void 0:r.height)||this.height,points:(null===(a=f.collision)||void 0===a?void 0:a.points)||f.points||null,x:(null===(l=f.collision)||void 0===l?void 0:l.x)||0,y:(null===(h=f.collision)||void 0===h?void 0:h.y)||0},this.physics=null!==(c=f.physics)&&void 0!==c&&c,this.events={hoverable:Boolean(f.hoverable),draggable:Boolean(f.draggable),clickable:Boolean(f.clickable)},this.eventListeners=new Map,this.animationStates=new Map,this.layer(f.layer||0),this.defaultZIndex=this.zIndex,this.sprite=f.sprite?{asset:this.engine.getAsset(f.sprite.asset),width:(null===(m=f.sprite)||void 0===m?void 0:m.width)||null,height:(null===(u=f.sprite)||void 0===u?void 0:u.height)||null,x:(null===(y=f.sprite)||void 0===y?void 0:y.x)||0,y:(null===(p=f.sprite)||void 0===p?void 0:p.y)||0,currentFrame:0,currentAnimation:null,lastFrameUpdate:0,animations:f.sprite.animations||{},defaultAnimation:f.sprite.defaultAnimation,playing:!1,frameTimer:null}:null,this.sprite&&this.sprite.defaultAnimation&&this.play(this.sprite.defaultAnimation)}return function(t,e,i){return e&&ct(t.prototype,e),i&&ct(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(t,[{key:"on",value:function(t,e){var i=this;if(Array.isArray(t))return t.forEach(function(t){i.on(t,e)}),this;if("object"===rt(t)){for(var n in t)this.on(n,t[n]);return this}return this.eventListeners.has(t)||this.eventListeners.set(t,new Set),this.eventListeners.get(t).add(e),this}},{key:"one",value:function(t,e){var i=this;if(Array.isArray(t))return t.forEach(function(t){i.one(t,e)}),this;if("object"===rt(t)){for(var n in t)this.one(n,t[n]);return this}var o=function(n){e.call(i,n),i.off(t,o)};return this.on(t,o),this}},{key:"off",value:function(t,e){var i=this;return Array.isArray(t)?(t.forEach(function(t){return i.off(t,e)}),this):(this.eventListeners.has(t)&&this.eventListeners.get(t).delete(e),this)}},{key:"trigger",value:function(t){for(var e=this,i=arguments.length,n=new Array(i>1?i-1:0),o=1;o<i;o++)n[o-1]=arguments[o];if(Array.isArray(t))return t.forEach(function(t){e.trigger(t,n)}),this;if(!this.eventListeners.has(t))return this;var s,r=function(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=ot(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return r=t.done,t},e:function(t){a=!0,s=t},f:function(){try{r||null==i.return||i.return()}finally{if(a)throw s}}}}(this.eventListeners.get(t));try{for(r.s();!(s=r.n()).done;){s.value.apply(this,n)}}catch(t){r.e(t)}finally{r.f()}return this}},{key:"isHoverable",value:function(){return this.events.hoverable}},{key:"isDraggable",value:function(){return this.events.draggable}},{key:"isClickable",value:function(){return this.events.clickable}},{key:"append",value:function(e){var i,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e instanceof t?e=(i=e).id:i=new t(e,lt(lt({},n),{},{engine:this.engine})),i.parent=this,this.children.set(e,i),i.move({x:0,y:0,relative:!this.engine.physicsEnabled}),i}},{key:"layer",value:function(t){if("number"==typeof t)this.zIndex=t;else switch(t){case"above":this.zIndex=999999;break;case"below":this.zIndex=-999999;break;case"top":this.zIndex=100;break;case"bottom":this.zIndex=-100;break;case"reset":this.zIndex=this.defaultZIndex;break;default:this.zIndex=0}return this}},{key:"find",value:function(t){return this.children.get(t)}},{key:"findByClass",value:function(t){return(t=t.trim())?Array.from(this.children).filter(function(e){return nt(e,2)[1].class.has(t)}).map(function(t){return nt(t,2)[1]}):(this.engine.warn("ClassName is required"),[])}},{key:"getEntities",value:function(){var t=[this],e=function(i){i.children.forEach(function(i){t.push(i),e(i)})};return e(this),t}},{key:"clone",value:function(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=lt(lt(lt({x:this.x,y:this.y,absoluteX:this.absoluteX,absoluteY:this.absoluteY,width:this.width,height:this.height,_data:this._data,engine:this.engine,constrainToParent:this.constrainToParent,zIndex:this.zIndex},this.styles),this.events),{},{collision:lt(lt({},this.collision),{},{points:null!==(e=this.collision)&&void 0!==e&&e.points?JSON.parse(JSON.stringify(this.collision.points)):null}),physics:this.physics}),o=new t(i||"".concat(this.id,"_clone_").concat(Date.now()),n);return o.defaultZIndex=this.defaultZIndex,this.eventListeners.forEach(function(t,e){t.forEach(function(t){o.on(e,t)})}),this.animationStates.forEach(function(t,e){o.animationStates.set(e,lt({},t))}),this.sprite&&(o.sprite=lt(lt({},this.sprite),{},{animations:JSON.parse(JSON.stringify(this.sprite.animations)),asset:this.sprite.asset,currentFrame:0,currentAnimation:null,lastFrameUpdate:0,playing:!1,frameTimer:null}),o.sprite.defaultAnimation&&o.play(o.sprite.defaultAnimation)),this.styles.mask instanceof t&&(o.styles.mask=this.styles.mask.clone()),this.styles.backgroundImage&&o.style({backgroundImage:this.styles.backgroundImage,backgroundImageFit:this.styles.backgroundImageFit,backgroundImagePosition:this.styles.backgroundImagePosition,backgroundImageRepeat:this.styles.backgroundImageRepeat}),this.children.forEach(function(t,e){var i=t.clone();i.parent=o,o.children.set(e,i)}),o}},{key:"updatePosition",value:function(){this.parent?(this.absoluteX=this.parent.absoluteX+this.x,this.absoluteY=this.parent.absoluteY+this.y):(this.absoluteX=this.x,this.absoluteY=this.y),this.children.forEach(function(t){return t.updatePosition()})}},{key:"transition",value:function(t){var e,i=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};"string"==typeof t&&(n=arguments[2]||{},t=ht({},t,arguments[1]));n=lt({duration:300,easing:"linear",delay:0},n);var o={};Object.keys(t).forEach(function(t){return o[t]=i.styles[t]});var s=performance.now()+n.delay,r=0,a=0,l="function"==typeof n.easing?n.easing:null!==(e=this.engine.Ease[n.easing])&&void 0!==e?e:this.engine.Ease.linear,h=function(e){var c;if(null===(c=i.engine)||void 0===c||!c.running)return 0===r&&(r=e),void requestAnimationFrame(h);0!==r&&(a+=e-r,r=0);var m=e-a;if(m<s)requestAnimationFrame(h);else{var u,y=m-s;if(y>=n.duration)return i.style(t),void(null===(u=n.onComplete)||void 0===u||u.call(i));var p=y/n.duration,f=l(p),_={};Object.keys(t).forEach(function(e){var n=o[e],s=t[e];"number"==typeof n?_[e]=n+(s-n)*f:"string"==typeof n&&n.startsWith("#")&&(_[e]=i._interpolateColor(n,s,f))}),i.style(_),requestAnimationFrame(h)}};return requestAnimationFrame(h),this}},{key:"startAnimation",value:function(t){var e=this,i=this.engine.animations[t];if(!i)return this;var n=this.animationStates.get(t)||{currentFrame:0,repeat:i.options.repeat,isRunning:!0};n.isRunning=!0,this.animationStates.set(t,n);var o=function(){var t;if(n.isRunning){if(null!==(t=e.engine)&&void 0!==t&&t.running){var s=i.keyframes[n.currentFrame];if(e.style(s),n.currentFrame++,n.currentFrame>=i.keyframes.length){if(!("infinite"===n.repeat||n.repeat>0))return void(n.isRunning=!1);n.currentFrame=0,"number"==typeof n.repeat&&n.repeat--}}e.engine.timeout(function(){return requestAnimationFrame(o)},i.options.duration/i.keyframes.length)}};return requestAnimationFrame(o),this}},{key:"stopAnimation",value:function(t){if(!this.animationStates)return this;if(t){var e=this.animationStates.get(t);e&&(e.isRunning=!1,e.currentFrame=0)}else this.animationStates.forEach(function(t){t.isRunning=!1,t.currentFrame=0});return this}},{key:"style",value:function(t,e){if("object"===rt(t))("x"in t||"y"in t)&&(Object.assign(this,{x:t.x||this.x,y:t.y||this.y}),this.updatePosition()),"fill"in t&&(t.backgroundColor=t.fill),Object.assign(this.styles,t);else{if("x"===t||"y"===t)return this[t]=e,this.updatePosition(),this;"fill"===t&&(this.styles.backgroundColor=e,this.styles.fill=e),this.styles[t]=e}return this}},{key:"text",value:function(t){return void 0===t?this.styles.text:(this.styles.text=t,this)}},{key:"img",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=this.engine.getAsset(t);if(!i)throw new Error("Asset not found.");return this.style({backgroundColor:"transparent",backgroundImage:i.asset,backgroundImageFit:e.fit||"cover",backgroundImagePosition:e.position||"center",backgroundImageRepeat:e.repeat||!1})}},{key:"move",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this.halt(),"number"==typeof t&&(t={x:t,y:i,duration:n||0});var o=lt({x:this.x,y:this.y,easing:"linear",duration:0,relative:!0},t);if(this.engine.physicsEnabled){var s={entity:this,x:o.relative?t.x||0:o.x,y:o.relative?t.y||0:o.y,duration:o.duration,easing:o.easing,relative:o.relative,onUpdate:o.onUpdate,onComplete:o.onComplete};if(this.engine.physics.moveEntity(s))return this}o.relative&&("x"in t&&(o.x=this.x+(t.x||0)),"y"in t&&(o.y=this.y+(t.y||0)));var r,a=o.x-this.x,l=o.y-this.y;if(!o.duration)return this.style({x:o.x,y:o.y}),null===(r=o.onComplete)||void 0===r||r.call(this),this;var h=this.getEntities(),c=new Map;h.forEach(function(t){return c.set(t,{x:t.x,y:t.y,absoluteX:t.absoluteX,absoluteY:t.absoluteY})});var m=performance.now(),u=0,y=0,p="function"==typeof o.easing?o.easing:this.engine.Ease[o.easing]||this.engine.Ease.linear,f=function(t){var i,n;if(null===(i=e.engine)||void 0===i||!i.running)return 0===u&&(u=t),void requestAnimationFrame(f);0!==u&&(y+=t-u,u=0);var s,r=t-y-m;if(r>=o.duration)return e.style({x:o.x,y:o.y}),null===(s=o.onComplete)||void 0===s||s.call(e),void e.unset("moveAnimation");var _=r/o.duration,d=p(_);h.forEach(function(t){var i=c.get(t);t===e?t.style({x:i.x+a*d,y:i.y+l*d}):t.style({x:i.x,y:i.y})}),null===(n=o.onUpdate)||void 0===n||n.call(e,d);var v=requestAnimationFrame(f);e.data("moveAnimation",v)},_=requestAnimationFrame(f);return this.data("moveAnimation",_),this}},{key:"hide",value:function(){this.style("visible",!1)}},{key:"show",value:function(){this.style("visible",!0)}},{key:"data",value:function(t,e){return void 0===e?this._data[t]||void 0:(this._data[t]=e,this)}},{key:"unset",value:function(t){return void 0!==this._data[t]&&delete this._data[t],this}},{key:"halt",value:function(){var t=this,e=this.data("moveAnimation");return e&&(cancelAnimationFrame(e),this.unset("moveAnimation"),this.engine.timeout(function(){t.trigger("moveStop",{x:t.x,y:t.y})},5)),this}},{key:"addClass",value:function(){for(var t=this,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return i.forEach(function(e){return t.class.add(e)}),this}},{key:"removeClass",value:function(){for(var t=this,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return i.forEach(function(e){return t.class.delete(e)}),this}},{key:"toggleClass",value:function(t){return this.class.delete(t)||this.class.add(t),this}},{key:"hasClass",value:function(t){return this.class.has(t)}},{key:"play",value:function(t){var e,i=this;if(t=t||this.sprite.currentAnimation,!this.sprite||!this.sprite.animations[t])return this;var n=this.sprite.currentAnimation;this.stop();var o=this.sprite.animations[t];this.sprite.currentAnimation=t,this.sprite.currentFrame=0,this.sprite.playing=!0,this.sprite.lastFrameUpdate=performance.now(),this.trigger("animationStart",t),null===(e=o.onStart)||void 0===e||e.call(this,t),n!==t&&this.trigger("animationChange",n,t);var s=function(){if(i.sprite.playing){var e=performance.now();if(e-i.sprite.lastFrameUpdate>=1e3/o.frameRate){var n,r=i.sprite.currentFrame;if(i.sprite.currentFrame++,i.sprite.lastFrameUpdate=e,r!==i.sprite.currentFrame)i.trigger("frameChange",i.sprite.currentFrame),null===(n=o.onFrame)||void 0===n||n.call(i,i.sprite.currentFrame);if(i.sprite.currentFrame>=o.frames.length){var a,l;if(!o.loop)return i.stop(),i.trigger("animationEnd",t),void(null===(a=o.onEnd)||void 0===a||a.call(i,t));i.sprite.currentFrame=0,i.trigger("animationOnLoop",i.sprite.currentAnimation),null===(l=o.onLoop)||void 0===l||l.call(i,i.sprite.currentAnimation)}}i.sprite.frameTimer=requestAnimationFrame(s)}};return s(),this}},{key:"pause",value:function(){return this.sprite&&this.sprite.playing?(this.sprite.playing=!1,this.sprite.frameTimer&&(cancelAnimationFrame(this.sprite.frameTimer),this.sprite.frameTimer=null),this.trigger("animationPause",this.sprite.currentAnimation),this):this}},{key:"resume",value:function(){if(!this.sprite||this.sprite.playing)return this;var t=this.sprite.currentFrame;return this.sprite.playing=!0,this.play(this.sprite.currentAnimation),this.sprite.currentFrame=t,this.trigger("animationResume",this.sprite.currentAnimation),this}},{key:"stop",value:function(){if(!this.sprite)return this;var t=this.sprite.currentAnimation;return this.sprite.playing=!1,this.sprite.currentFrame=0,this.sprite.frameTimer&&(cancelAnimationFrame(this.sprite.frameTimer),this.sprite.frameTimer=null),t&&this.trigger("animationStop",t),this}},{key:"isPlaying",value:function(){var t;return(null===(t=this.sprite)||void 0===t?void 0:t.playing)||!1}},{key:"setSpriteAsset",value:function(t){return"spritesheet"!==(t=this.engine.getAsset(t)).type||(this.sprite.asset=t,this.trigger("spriteAssetChanged",t.id)),this}},{key:"addAnimation",value:function(t,e){return this.sprite?(this.sprite.animations[t]=e,this):this}},{key:"setAnimations",value:function(t){return this.sprite?(this.sprite.animations=t,this):this}},{key:"getCurrentAnimation",value:function(){var t;return(null===(t=this.sprite)||void 0===t?void 0:t.currentAnimation)||null}},{key:"setFrame",value:function(t){return!this.sprite||!this.sprite.currentAnimation||t>=this.sprite.animations[this.sprite.currentAnimation].frames.length||(this.sprite.currentFrame=t),this}},{key:"getCurrentFrame",value:function(){return this.sprite&&this.sprite.currentAnimation?this.sprite.animations[this.sprite.currentAnimation].frames[this.sprite.currentFrame]:null}},{key:"setFrameRate",value:function(t,e){return this.sprite&&this.sprite.animations[t]?(this.sprite.animations[t].frameRate=e,this):this}},{key:"render",value:function(t){var e;if(this.styles.visible){t.save(),this.trigger("beforerender",t),t.translate(this.absoluteX+this.width/2,this.absoluteY+this.height/2),t.rotate(this.styles.rotation*Math.PI/180),t.scale((this.styles.flipX?-1:1)*this.styles.scaleX*this.styles.scale,(this.styles.flipY?-1:1)*this.styles.scaleY*this.styles.scale),t.transform(1,this.styles.skewY,this.styles.skewX,1,0,0),t.globalAlpha=this.styles.opacity,t.globalCompositeOperation=this.styles.blendMode,this._applyFilters(t),this._applyClip(t),this.styles.shadowColor&&(t.shadowColor=this.styles.shadowColor,t.shadowBlur=this.styles.shadowBlur,t.shadowOffsetX=this.styles.shadowOffsetX,t.shadowOffsetY=this.styles.shadowOffsetY);var i=this.styles.borderRadius>0;i&&(t.save(),this._clipPath(t)),this.trigger("render",t),this.sprite?this._renderSprite(t):(this.styles.backgroundImage&&this._renderBackgroundImage(t),this.styles.customPath?this._renderCustomPath(t):this.renderShape(t)),this.styles.text&&this._renderText(t),this._applyMask(t),i&&t.restore(),this.trigger("afterrender",t),t.restore(),null!==(e=this.engine)&&void 0!==e&&null!==(e=e.debugger)&&void 0!==e&&e.active&&(t.save(),t.globalCompositeOperation="source-over",t.translate(this.absoluteX+this.width/2,this.absoluteY+this.height/2),t.rotate(this.styles.rotation*Math.PI/180),t.scale((this.styles.flipX?-1:1)*this.styles.scaleX*this.styles.scale,(this.styles.flipY?-1:1)*this.styles.scaleY*this.styles.scale),t.transform(1,this.styles.skewY,this.styles.skewX,1,0,0),this._renderDebugInfo(t),t.restore()),this.children.size>0&&this.children.forEach(function(e){e.styles.visible&&e.render(t)})}}},{key:"renderShape",value:function(t){switch(this.styles.shape){case"circle":this.renderCircle(t);break;case"triangle":this.renderTriangle(t);break;case"star":this.renderStar(t);break;case"polygon":this.renderPolygon(t);break;default:this.renderRectangle(t)}}},{key:"renderRectangle",value:function(t){var e=this.width,i=this.height;if(this.styles.borderRadius>0){var n=this.styles.borderRadius;t.beginPath(),t.moveTo(-e/2+n,-i/2),t.lineTo(e/2-n,-i/2),t.arcTo(e/2,-i/2,e/2,-i/2+n,n),t.lineTo(e/2,i/2-n),t.arcTo(e/2,i/2,e/2-n,i/2,n),t.lineTo(-e/2+n,i/2),t.arcTo(-e/2,i/2,-e/2,i/2-n,n),t.lineTo(-e/2,-i/2+n),t.arcTo(-e/2,-i/2,-e/2+n,-i/2,n),t.closePath()}else t.beginPath(),t.rect(-e/2,-i/2,e,i);this.fillAndStroke(t)}},{key:"renderCircle",value:function(t){t.beginPath(),t.arc(0,0,Math.min(this.width,this.height)/2,0,2*Math.PI),this.fillAndStroke(t)}},{key:"renderTriangle",value:function(t){var e=this.width,i=this.height;t.beginPath(),t.moveTo(0,-i/2),t.lineTo(e/2,i/2),t.lineTo(-e/2,i/2),t.closePath(),this.fillAndStroke(t)}},{key:"renderPolygon",value:function(t){if(!(this.styles.points.length<3)){if(this.styles.borderRadius>0)this._renderPolygonWithRadius(t);else{t.beginPath(),t.moveTo(this.styles.points[0].x,this.styles.points[0].y);for(var e=1;e<this.styles.points.length;e++)t.lineTo(this.styles.points[e].x,this.styles.points[e].y);t.closePath()}this.fillAndStroke(t)}}},{key:"renderStar",value:function(t){var e=Math.min(this.width,this.height)/2,i=.4*e,n=this.styles.spikes||5,o=Math.PI/n;t.beginPath(),t.moveTo(0,-e);for(var s=0;s<2*n;s++){var r=s%2==0?e:i,a=o*s-Math.PI/2;t.lineTo(Math.cos(a)*r,Math.sin(a)*r)}t.closePath(),this.fillAndStroke(t)}},{key:"fillAndStroke",value:function(t){if(this.styles.backgroundGradient){var e=this._createGradient(t);t.fillStyle=e}else t.fillStyle=this.styles.backgroundColor||this.styles.fill;this.styles.borderWidth>0&&(t.strokeStyle=this.styles.borderColor,t.lineWidth=this.styles.borderWidth,"dashed"===this.styles.borderStyle?t.setLineDash([2*this.styles.borderWidth]):"dotted"===this.styles.borderStyle&&t.setLineDash([this.styles.borderWidth])),t.fill(),this.styles.borderWidth>0&&t.stroke()}},{key:"_renderPolygonWithRadius",value:function(t){var e=this.styles.points,i=this.styles.borderRadius;t.beginPath();for(var n=0;n<e.length;n++){var o=e[n],s=e[(n+1)%e.length],r=e[(n-1+e.length)%e.length],a={x:r.x-o.x,y:r.y-o.y},l={x:s.x-o.x,y:s.y-o.y},h=Math.sqrt(a.x*a.x+a.y*a.y),c=Math.sqrt(l.x*l.x+l.y*l.y);a.x/=h,a.y/=h,l.x/=c,l.y/=c;var m=Math.min(i,h/2,c/2),u={x:o.x+a.x*m,y:o.y+a.y*m},y={x:o.x+l.x*m,y:o.y+l.y*m};0===n?t.moveTo(u.x,u.y):t.lineTo(u.x,u.y),t.quadraticCurveTo(o.x,o.y,y.x,y.y)}t.closePath()}},{key:"_renderBackgroundImage",value:function(t){if(this.styles.backgroundImage){this.styles.borderRadius>0&&this._clipPath(t),this.style("backgroundColor","transparent");var e=this.styles.backgroundImage,i=this.styles.backgroundImageFit,n=this.styles.backgroundImagePosition,o=this.styles.backgroundImageRepeat,s=this.width,r=this.height,a=-this.width/2,l=-this.height/2;if(o)t.fillStyle=t.createPattern(e,"repeat"),t.fillRect(-this.width/2,-this.height/2,this.width,this.height);else{var h="contain"===i?Math.min(this.width/e.width,this.height/e.height):"cover"===i?Math.max(this.width/e.width,this.height/e.height):1;"stretch"!==i&&(s=e.width*h,r=e.height*h),n.includes("center")?(a=-s/2,l=-r/2):(n.includes("left")&&(a=-this.width/2),n.includes("right")&&(a=this.width/2-s),n.includes("top")&&(l=-this.height/2),n.includes("bottom")&&(l=this.height/2-r)),t.drawImage(e,a,l,s,r)}}}},{key:"_renderText",value:function(t){var e=this;if(this.styles.text){t.font=this.styles.font,t.textAlign=this.styles.textAlign,t.textBaseline=this.styles.textBaseline,t.fillStyle=this.styles.color;var i=this.styles.text.toString().split("\n"),n=parseInt(this.styles.font)*this.styles.lineHeight;i.forEach(function(o,s){var r=0,a=(s-(i.length-1)/2)*n;switch(e.styles.textAlign){case"left":r=-e.width/2;break;case"right":r=e.width/2;break;default:r=0}t.fillText(o,r,a)})}}},{key:"_clipPath",value:function(t){var e=this.width,i=this.height,n=this.styles.borderRadius;n>0&&(t.beginPath(),t.moveTo(-e/2+n,-i/2),t.lineTo(e/2-n,-i/2),t.arcTo(e/2,-i/2,e/2,-i/2+n,n),t.lineTo(e/2,i/2-n),t.arcTo(e/2,i/2,e/2-n,i/2,n),t.lineTo(-e/2+n,i/2),t.arcTo(-e/2,i/2,-e/2,i/2-n,n),t.lineTo(-e/2,-i/2+n),t.arcTo(-e/2,-i/2,-e/2+n,-i/2,n),t.closePath(),t.clip())}},{key:"_applyClip",value:function(t){if(this.styles.clip)if("function"==typeof this.styles.clip)t.beginPath(),this.styles.clip.call(this,t),t.clip();else if(Array.isArray(this.styles.clip)){t.beginPath(),t.moveTo(this.styles.clip[0].x,this.styles.clip[0].y);for(var e=1;e<this.styles.clip.length;e++)t.lineTo(this.styles.clip[e].x,this.styles.clip[e].y);t.closePath(),t.clip()}}},{key:"_applyFilters",value:function(t){this.styles.blur>0&&(t.filter="blur(".concat(this.styles.blur,"px)")),this.styles.filter&&(t.filter=this.styles.filter)}},{key:"_applyMask",value:function(e){this.styles.mask&&(e.save(),"function"==typeof this.styles.mask?this.styles.mask.call(this,e):this.styles.mask instanceof t&&(e.globalCompositeOperation="destination-in",this.styles.mask.render(e)),e.restore())}},{key:"_renderCustomPath",value:function(t){"function"==typeof this.styles.customPath&&this.styles.customPath(t)}},{key:"_renderSprite",value:function(t){var e;if(this.sprite&&this.sprite.asset){var i=this.sprite.asset;if("spritesheet"===i.type){var n=this.sprite.animations[this.sprite.currentAnimation];if(n){var o=n.frames[this.sprite.currentFrame];if(i.config.frames[o]){t.save(),t.translate(-this.width/2,-this.height/2),(this.styles.backgroundColor||this.styles.backgroundGradient)&&(this.styles.backgroundGradient?t.fillStyle=this._createGradient(t):t.fillStyle=this.styles.backgroundColor,t.fillRect(0,0,this.width,this.height));var s,r,a,l=i.config,h=l.width,c=l.height,m=l.columns,u=l.margin,y=void 0===u?[0,0]:u,p=l.originOffset,f=void 0===p?[0,0]:p;if(null!==this.sprite.width&&null!==this.sprite.height)s=this.sprite.width,r=this.sprite.height,a=s/h;else{var _=this.width/h,d=this.height/c;s=h*(a=Math.max(_,d)),r=c*a}var v=.5*(this.width-s)+(this.sprite.x||0),b=.5*(this.height-r)+(this.sprite.y||0),g=o%m,x=Math.floor(o/m),w=f[0]+g*(h+y[0]),C=f[1]+x*(c+y[1]);t.drawImage(i.asset,w,C,h,c,v,b,s,r);var S={frame:{current:this.sprite.currentFrame,total:n.frames.length,index:o,data:{x:w,y:C,width:h,height:c,column:g,row:x}},timing:{lastUpdate:this.sprite.lastFrameUpdate,frameRate:n.frameRate,elapsedSinceLastFrame:performance.now()-this.sprite.lastFrameUpdate},render:{source:{x:w,y:C,width:h,height:c},target:{x:v,y:b,width:s,height:r,scale:a}},animation:{name:this.sprite.currentAnimation,isPlaying:this.sprite.playing,loop:n.loop},sprite:{asset:i.id,totalFrames:n.frames.length,config:{columns:m,rows:i.config.rows,width:h,height:c,originOffset:f,margin:y}}};this.trigger("spriteRender",S),null===(e=n.onRender)||void 0===e||e.call(this,S),this.styles.borderWidth>0&&(t.strokeStyle=this.styles.borderColor,t.lineWidth=this.styles.borderWidth,"dashed"===this.styles.borderStyle?t.setLineDash([2*this.styles.borderWidth]):"dotted"===this.styles.borderStyle&&t.setLineDash([this.styles.borderWidth]),t.strokeRect(0,0,this.width,this.height)),t.restore()}}}}}},{key:"isCollidable",value:function(){return this.collision.enabled}},{key:"enableCollision",value:function(){return this.collision.enabled=!0,this}},{key:"disableCollision",value:function(){return this.collision.enabled=!1,this}},{key:"setCollisionGroup",value:function(t){return this.collision.group=t,this}},{key:"setCollisionPoints",value:function(t){if(!Array.isArray(t)||t.length<3)throw new Error("Collision points must be an array with at least 3 points");return t.forEach(function(t){if(!t.x||!t.y)throw new Error("Each collision point must have x and y coordinates")}),this.collision.points=t,this.engine&&this.engine.collision&&this.engine.collision.clearCache(this.id),this}},{key:"clearCollisionPoints",value:function(){return this.collision.points=null,this.engine&&this.engine.collision&&this.engine.collision.clearCache(this.id),this}},{key:"getBounds",value:function(){var t={x:this.absoluteX+this.collision.x,y:this.absoluteY+this.collision.y,width:this.collision.width*Math.abs(this.styles.scaleX*this.styles.scale),height:this.collision.height*Math.abs(this.styles.scaleY*this.styles.scale)};if(0!==this.styles.rotation){var e=this.styles.rotation*Math.PI/180,i=Math.abs(Math.cos(e)),n=Math.abs(Math.sin(e)),o=t.width*i+t.height*n,s=t.width*n+t.height*i;t.width=o,t.height=s}return t}},{key:"_createGradient",value:function(t){var e,i=this.styles.backgroundGradient;return"linear"===i.type?e=t.createLinearGradient(i.x1||-this.width/2,i.y1||-this.height/2,i.x2||this.width/2,i.y2||this.height/2):"radial"===i.type&&(e=t.createRadialGradient(0,0,0,0,0,Math.max(this.width,this.height)/2)),i.stops.forEach(function(t){e.addColorStop(t.offset,t.color)}),e}},{key:"_interpolateColor",value:function(t,e,i){var n=this.engine.hexToRgb(t),o=this.engine.hexToRgb(e),s=Math.round(n.r+(o.r-n.r)*i),r=Math.round(n.g+(o.g-n.g)*i),a=Math.round(n.b+(o.b-n.b)*i);return"rgb(".concat(s,",").concat(r,",").concat(a,")")}},{key:"_renderDebugInfo",value:function(t){this.collision.enabled&&(t.lineWidth=1,this.collision.points?this._renderCustomCollisionShape(t):this._renderCollisionShape(t))}},{key:"_renderCustomCollisionShape",value:function(t){var e=this.collision.points;if(e&&!(e.length<2)){if(t.strokeStyle="rgba(255, 255, 255, 0.8)",t.beginPath(),t.moveTo(e[0].x,e[0].y),this.styles.customPath)for(var i=0;i<e.length-1;){var n=e[i],o=e[i+1],s={x:n.x+(o.x-n.x)/3,y:n.y+(o.y-n.y)/3},r={x:n.x+2*(o.x-n.x)/3,y:n.y+2*(o.y-n.y)/3};t.bezierCurveTo(s.x,s.y,r.x,r.y,o.x,o.y),i++}else for(var a=1;a<e.length;a++)t.lineTo(e[a].x,e[a].y);t.closePath(),t.stroke(),t.strokeStyle="rgba(255, 0, 0, 0.8)",t.fillStyle="rgba(255, 0, 0, 0.6)",t.fill(),t.stroke(),"advanced"===this.engine.debugger.level&&(t.fillStyle="rgba(255, 255, 255, 0.8)",e.forEach(function(e){t.beginPath(),t.arc(e.x,e.y,2,0,2*Math.PI),t.fill()}))}}},{key:"_renderCollisionShape",value:function(t){t.save();var e=-this.width/2+this.collision.x+this.collision.width/2,i=-this.height/2+this.collision.y+this.collision.height/2;t.translate(e,i);var n=lt({},this.styles),o=this.width,s=this.height;this.width=this.collision.width,this.height=this.collision.height,Object.assign(this.styles,{backgroundColor:"rgba(255, 0, 0, 0.3)",borderColor:"rgba(255, 0, 0, 0.5)",borderWidth:1,color:"rgba(255, 0, 0, 0.3)"}),this.renderShape(t),this.width=o,this.height=s,this.styles=n,t.restore()}},{key:"kill",value:function(){var t;return!!this.engine&&(this.engine.physics&&this.physics&&this.engine.physics.removeEntity(this),this.engine.draggedEntity===this&&(this.engine.draggedEntity=null),this.engine.hoveredEntity===this&&(this.engine.hoveredEntity=null),this.engine.collisionEnabled&&null!==(t=this.collision)&&void 0!==t&&t.enabled&&this.engine.collision.remove(this),this.parent&&this.parent.children.delete(this.id),this.children.forEach(function(t){return t.kill()}),this.engine.entities.delete(this.id),this.trigger("kill"),this.engine.trigger("kill",this.id),this.parent=null,this.engine=null,!0)}}])}();function _t(){var t,e,i,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o={};o.backgroundColor=null!==(t=n.fill)&&void 0!==t?t:n.backgroundColor,o.backgroundGradient=null!==(e=n.gradient)&&void 0!==e?e:n.backgroundGradient,o.fill=o.backgroundColor;var s=null!==(i=n.image)&&void 0!==i?i:n.backgroundImage;return"string"==typeof s?(o.backgroundImage=yt(pt,this,dt).call(this,s),o.backgroundImageFit=n.backgroundImageFit||"contain",o.backgroundImagePosition=n.backgroundImagePosition||"center",o.backgroundImageRepeat=n.backgroundImageRepeat||!1):"object"===rt(s)&&(null!=s&&s.asset||null!=s&&s.src)&&(o.backgroundImage=(null==s?void 0:s.asset)||yt(pt,this,dt).call(this,s.src),o.backgroundImageFit=s.fit||"contain",o.backgroundImagePosition=s.position||"center",o.backgroundImageRepeat=s.repeat||!1),o}function dt(t){var e,i;return"object"===rt(t)&&null!=t&&t.asset?t.asset:null===(e=(i=this.engine).getAsset)||void 0===e||null===(e=e.call(i,t))||void 0===e?void 0:e.asset}const vt=ft;var bt={};!function(t,e){function i(){}t.inherit=function(t,e){var n=t;i.prototype=e.prototype,t.prototype=new i,t.prototype.constructor=n},t.generateCallback=function(t,e){return function(){e.apply(t,arguments)}},t.NVector=function(t){t===e&&(t=0);for(var i=new Array(t||0),n=0;n<t;++n)i[n]=0;return i},t.is=function(t,i){return null!==t&&(i instanceof Function&&t instanceof i||!(t.constructor.__implements==e||!t.constructor.__implements[i]))},t.parseUInt=function(t){return Math.abs(parseInt(t))}}(bt);var gt,xt,wt=Array,Ct=bt.NVector;for(void 0===bt&&(bt={}),void 0===bt.Collision&&(bt.Collision={}),void 0===bt.Collision.Shapes&&(bt.Collision.Shapes={}),void 0===bt.Common&&(bt.Common={}),void 0===bt.Common.Math&&(bt.Common.Math={}),void 0===bt.Dynamics&&(bt.Dynamics={}),void 0===bt.Dynamics.Contacts&&(bt.Dynamics.Contacts={}),void 0===bt.Dynamics.Controllers&&(bt.Dynamics.Controllers={}),void 0===bt.Dynamics.Joints&&(bt.Dynamics.Joints={}),bt.Collision.IBroadPhase="Box2D.Collision.IBroadPhase",bt.Collision.b2AABB=function t(){t.b2AABB.apply(this,arguments)},bt.Collision.b2Bound=function t(){t.b2Bound.apply(this,arguments)},bt.Collision.b2BoundValues=function t(){t.b2BoundValues.apply(this,arguments),this.constructor===t&&this.b2BoundValues.apply(this,arguments)},bt.Collision.b2Collision=function t(){t.b2Collision.apply(this,arguments)},bt.Collision.b2ContactID=function t(){t.b2ContactID.apply(this,arguments),this.constructor===t&&this.b2ContactID.apply(this,arguments)},bt.Collision.b2ContactPoint=function t(){t.b2ContactPoint.apply(this,arguments)},bt.Collision.b2Distance=function t(){t.b2Distance.apply(this,arguments)},bt.Collision.b2DistanceInput=function t(){t.b2DistanceInput.apply(this,arguments)},bt.Collision.b2DistanceOutput=function t(){t.b2DistanceOutput.apply(this,arguments)},bt.Collision.b2DistanceProxy=function t(){t.b2DistanceProxy.apply(this,arguments)},bt.Collision.b2DynamicTree=function t(){t.b2DynamicTree.apply(this,arguments),this.constructor===t&&this.b2DynamicTree.apply(this,arguments)},bt.Collision.b2DynamicTreeBroadPhase=function t(){t.b2DynamicTreeBroadPhase.apply(this,arguments)},bt.Collision.b2DynamicTreeNode=function t(){t.b2DynamicTreeNode.apply(this,arguments)},bt.Collision.b2DynamicTreePair=function t(){t.b2DynamicTreePair.apply(this,arguments)},bt.Collision.b2Manifold=function t(){t.b2Manifold.apply(this,arguments),this.constructor===t&&this.b2Manifold.apply(this,arguments)},bt.Collision.b2ManifoldPoint=function t(){t.b2ManifoldPoint.apply(this,arguments),this.constructor===t&&this.b2ManifoldPoint.apply(this,arguments)},bt.Collision.b2Point=function t(){t.b2Point.apply(this,arguments)},bt.Collision.b2RayCastInput=function t(){t.b2RayCastInput.apply(this,arguments),this.constructor===t&&this.b2RayCastInput.apply(this,arguments)},bt.Collision.b2RayCastOutput=function t(){t.b2RayCastOutput.apply(this,arguments)},bt.Collision.b2Segment=function t(){t.b2Segment.apply(this,arguments)},bt.Collision.b2SeparationFunction=function t(){t.b2SeparationFunction.apply(this,arguments)},bt.Collision.b2Simplex=function t(){t.b2Simplex.apply(this,arguments),this.constructor===t&&this.b2Simplex.apply(this,arguments)},bt.Collision.b2SimplexCache=function t(){t.b2SimplexCache.apply(this,arguments)},bt.Collision.b2SimplexVertex=function t(){t.b2SimplexVertex.apply(this,arguments)},bt.Collision.b2TimeOfImpact=function t(){t.b2TimeOfImpact.apply(this,arguments)},bt.Collision.b2TOIInput=function t(){t.b2TOIInput.apply(this,arguments)},bt.Collision.b2WorldManifold=function t(){t.b2WorldManifold.apply(this,arguments),this.constructor===t&&this.b2WorldManifold.apply(this,arguments)},bt.Collision.ClipVertex=function t(){t.ClipVertex.apply(this,arguments)},bt.Collision.Features=function t(){t.Features.apply(this,arguments)},bt.Collision.Shapes.b2CircleShape=function t(){t.b2CircleShape.apply(this,arguments),this.constructor===t&&this.b2CircleShape.apply(this,arguments)},bt.Collision.Shapes.b2EdgeChainDef=function t(){t.b2EdgeChainDef.apply(this,arguments),this.constructor===t&&this.b2EdgeChainDef.apply(this,arguments)},bt.Collision.Shapes.b2EdgeShape=function t(){t.b2EdgeShape.apply(this,arguments),this.constructor===t&&this.b2EdgeShape.apply(this,arguments)},bt.Collision.Shapes.b2MassData=function t(){t.b2MassData.apply(this,arguments)},bt.Collision.Shapes.b2PolygonShape=function t(){t.b2PolygonShape.apply(this,arguments),this.constructor===t&&this.b2PolygonShape.apply(this,arguments)},bt.Collision.Shapes.b2Shape=function t(){t.b2Shape.apply(this,arguments),this.constructor===t&&this.b2Shape.apply(this,arguments)},bt.Common.b2internal="Box2D.Common.b2internal",bt.Common.b2Color=function t(){t.b2Color.apply(this,arguments),this.constructor===t&&this.b2Color.apply(this,arguments)},bt.Common.b2Settings=function t(){t.b2Settings.apply(this,arguments)},bt.Common.Math.b2Mat22=function t(){t.b2Mat22.apply(this,arguments),this.constructor===t&&this.b2Mat22.apply(this,arguments)},bt.Common.Math.b2Mat33=function t(){t.b2Mat33.apply(this,arguments),this.constructor===t&&this.b2Mat33.apply(this,arguments)},bt.Common.Math.b2Math=function t(){t.b2Math.apply(this,arguments)},bt.Common.Math.b2Sweep=function t(){t.b2Sweep.apply(this,arguments)},bt.Common.Math.b2Transform=function t(){t.b2Transform.apply(this,arguments),this.constructor===t&&this.b2Transform.apply(this,arguments)},bt.Common.Math.b2Vec2=function t(){t.b2Vec2.apply(this,arguments),this.constructor===t&&this.b2Vec2.apply(this,arguments)},bt.Common.Math.b2Vec3=function t(){t.b2Vec3.apply(this,arguments),this.constructor===t&&this.b2Vec3.apply(this,arguments)},bt.Dynamics.b2Body=function t(){t.b2Body.apply(this,arguments),this.constructor===t&&this.b2Body.apply(this,arguments)},bt.Dynamics.b2BodyDef=function t(){t.b2BodyDef.apply(this,arguments),this.constructor===t&&this.b2BodyDef.apply(this,arguments)},bt.Dynamics.b2ContactFilter=function t(){t.b2ContactFilter.apply(this,arguments)},bt.Dynamics.b2ContactImpulse=function t(){t.b2ContactImpulse.apply(this,arguments)},bt.Dynamics.b2ContactListener=function t(){t.b2ContactListener.apply(this,arguments)},bt.Dynamics.b2ContactManager=function t(){t.b2ContactManager.apply(this,arguments),this.constructor===t&&this.b2ContactManager.apply(this,arguments)},bt.Dynamics.b2DebugDraw=function t(){t.b2DebugDraw.apply(this,arguments),this.constructor===t&&this.b2DebugDraw.apply(this,arguments)},bt.Dynamics.b2DestructionListener=function t(){t.b2DestructionListener.apply(this,arguments)},bt.Dynamics.b2FilterData=function t(){t.b2FilterData.apply(this,arguments)},bt.Dynamics.b2Fixture=function t(){t.b2Fixture.apply(this,arguments),this.constructor===t&&this.b2Fixture.apply(this,arguments)},bt.Dynamics.b2FixtureDef=function t(){t.b2FixtureDef.apply(this,arguments),this.constructor===t&&this.b2FixtureDef.apply(this,arguments)},bt.Dynamics.b2Island=function t(){t.b2Island.apply(this,arguments),this.constructor===t&&this.b2Island.apply(this,arguments)},bt.Dynamics.b2TimeStep=function t(){t.b2TimeStep.apply(this,arguments)},bt.Dynamics.b2World=function t(){t.b2World.apply(this,arguments),this.constructor===t&&this.b2World.apply(this,arguments)},bt.Dynamics.Contacts.b2CircleContact=function t(){t.b2CircleContact.apply(this,arguments)},bt.Dynamics.Contacts.b2Contact=function t(){t.b2Contact.apply(this,arguments),this.constructor===t&&this.b2Contact.apply(this,arguments)},bt.Dynamics.Contacts.b2ContactConstraint=function t(){t.b2ContactConstraint.apply(this,arguments),this.constructor===t&&this.b2ContactConstraint.apply(this,arguments)},bt.Dynamics.Contacts.b2ContactConstraintPoint=function t(){t.b2ContactConstraintPoint.apply(this,arguments)},bt.Dynamics.Contacts.b2ContactEdge=function t(){t.b2ContactEdge.apply(this,arguments)},bt.Dynamics.Contacts.b2ContactFactory=function t(){t.b2ContactFactory.apply(this,arguments),this.constructor===t&&this.b2ContactFactory.apply(this,arguments)},bt.Dynamics.Contacts.b2ContactRegister=function t(){t.b2ContactRegister.apply(this,arguments)},bt.Dynamics.Contacts.b2ContactResult=function t(){t.b2ContactResult.apply(this,arguments)},bt.Dynamics.Contacts.b2ContactSolver=function t(){t.b2ContactSolver.apply(this,arguments),this.constructor===t&&this.b2ContactSolver.apply(this,arguments)},bt.Dynamics.Contacts.b2EdgeAndCircleContact=function t(){t.b2EdgeAndCircleContact.apply(this,arguments)},bt.Dynamics.Contacts.b2NullContact=function t(){t.b2NullContact.apply(this,arguments),this.constructor===t&&this.b2NullContact.apply(this,arguments)},bt.Dynamics.Contacts.b2PolyAndCircleContact=function t(){t.b2PolyAndCircleContact.apply(this,arguments)},bt.Dynamics.Contacts.b2PolyAndEdgeContact=function t(){t.b2PolyAndEdgeContact.apply(this,arguments)},bt.Dynamics.Contacts.b2PolygonContact=function t(){t.b2PolygonContact.apply(this,arguments)},bt.Dynamics.Contacts.b2PositionSolverManifold=function t(){t.b2PositionSolverManifold.apply(this,arguments),this.constructor===t&&this.b2PositionSolverManifold.apply(this,arguments)},bt.Dynamics.Controllers.b2BuoyancyController=function t(){t.b2BuoyancyController.apply(this,arguments)},bt.Dynamics.Controllers.b2ConstantAccelController=function t(){t.b2ConstantAccelController.apply(this,arguments)},bt.Dynamics.Controllers.b2ConstantForceController=function t(){t.b2ConstantForceController.apply(this,arguments)},bt.Dynamics.Controllers.b2Controller=function t(){t.b2Controller.apply(this,arguments)},bt.Dynamics.Controllers.b2ControllerEdge=function t(){t.b2ControllerEdge.apply(this,arguments)},bt.Dynamics.Controllers.b2GravityController=function t(){t.b2GravityController.apply(this,arguments)},bt.Dynamics.Controllers.b2TensorDampingController=function t(){t.b2TensorDampingController.apply(this,arguments)},bt.Dynamics.Joints.b2DistanceJoint=function t(){t.b2DistanceJoint.apply(this,arguments),this.constructor===t&&this.b2DistanceJoint.apply(this,arguments)},bt.Dynamics.Joints.b2DistanceJointDef=function t(){t.b2DistanceJointDef.apply(this,arguments),this.constructor===t&&this.b2DistanceJointDef.apply(this,arguments)},bt.Dynamics.Joints.b2FrictionJoint=function t(){t.b2FrictionJoint.apply(this,arguments),this.constructor===t&&this.b2FrictionJoint.apply(this,arguments)},bt.Dynamics.Joints.b2FrictionJointDef=function t(){t.b2FrictionJointDef.apply(this,arguments),this.constructor===t&&this.b2FrictionJointDef.apply(this,arguments)},bt.Dynamics.Joints.b2GearJoint=function t(){t.b2GearJoint.apply(this,arguments),this.constructor===t&&this.b2GearJoint.apply(this,arguments)},bt.Dynamics.Joints.b2GearJointDef=function t(){t.b2GearJointDef.apply(this,arguments),this.constructor===t&&this.b2GearJointDef.apply(this,arguments)},bt.Dynamics.Joints.b2Jacobian=function t(){t.b2Jacobian.apply(this,arguments)},bt.Dynamics.Joints.b2Joint=function t(){t.b2Joint.apply(this,arguments),this.constructor===t&&this.b2Joint.apply(this,arguments)},bt.Dynamics.Joints.b2JointDef=function t(){t.b2JointDef.apply(this,arguments),this.constructor===t&&this.b2JointDef.apply(this,arguments)},bt.Dynamics.Joints.b2JointEdge=function t(){t.b2JointEdge.apply(this,arguments)},bt.Dynamics.Joints.b2LineJoint=function t(){t.b2LineJoint.apply(this,arguments),this.constructor===t&&this.b2LineJoint.apply(this,arguments)},bt.Dynamics.Joints.b2LineJointDef=function t(){t.b2LineJointDef.apply(this,arguments),this.constructor===t&&this.b2LineJointDef.apply(this,arguments)},bt.Dynamics.Joints.b2MouseJoint=function t(){t.b2MouseJoint.apply(this,arguments),this.constructor===t&&this.b2MouseJoint.apply(this,arguments)},bt.Dynamics.Joints.b2MouseJointDef=function t(){t.b2MouseJointDef.apply(this,arguments),this.constructor===t&&this.b2MouseJointDef.apply(this,arguments)},bt.Dynamics.Joints.b2PrismaticJoint=function t(){t.b2PrismaticJoint.apply(this,arguments),this.constructor===t&&this.b2PrismaticJoint.apply(this,arguments)},bt.Dynamics.Joints.b2PrismaticJointDef=function t(){t.b2PrismaticJointDef.apply(this,arguments),this.constructor===t&&this.b2PrismaticJointDef.apply(this,arguments)},bt.Dynamics.Joints.b2PulleyJoint=function t(){t.b2PulleyJoint.apply(this,arguments),this.constructor===t&&this.b2PulleyJoint.apply(this,arguments)},bt.Dynamics.Joints.b2PulleyJointDef=function t(){t.b2PulleyJointDef.apply(this,arguments),this.constructor===t&&this.b2PulleyJointDef.apply(this,arguments)},bt.Dynamics.Joints.b2RevoluteJoint=function t(){t.b2RevoluteJoint.apply(this,arguments),this.constructor===t&&this.b2RevoluteJoint.apply(this,arguments)},bt.Dynamics.Joints.b2RevoluteJointDef=function t(){t.b2RevoluteJointDef.apply(this,arguments),this.constructor===t&&this.b2RevoluteJointDef.apply(this,arguments)},bt.Dynamics.Joints.b2WeldJoint=function t(){t.b2WeldJoint.apply(this,arguments),this.constructor===t&&this.b2WeldJoint.apply(this,arguments)},bt.Dynamics.Joints.b2WeldJointDef=function t(){t.b2WeldJointDef.apply(this,arguments),this.constructor===t&&this.b2WeldJointDef.apply(this,arguments)},bt.postDefs=[],function(){var t=bt.Collision.Shapes.b2CircleShape;bt.Collision.Shapes.b2EdgeChainDef,bt.Collision.Shapes.b2EdgeShape,bt.Collision.Shapes.b2MassData;var e=bt.Collision.Shapes.b2PolygonShape,i=bt.Collision.Shapes.b2Shape;bt.Common.b2Color,bt.Common.b2internal;var n=bt.Common.b2Settings;bt.Common.Math.b2Mat22,bt.Common.Math.b2Mat33;var o=bt.Common.Math.b2Math,s=bt.Common.Math.b2Sweep,r=bt.Common.Math.b2Transform,a=bt.Common.Math.b2Vec2;bt.Common.Math.b2Vec3;var l=bt.Collision.b2AABB,h=bt.Collision.b2Bound,c=bt.Collision.b2BoundValues,m=bt.Collision.b2Collision,u=bt.Collision.b2ContactID,y=bt.Collision.b2ContactPoint,p=bt.Collision.b2Distance,f=bt.Collision.b2DistanceInput,_=bt.Collision.b2DistanceOutput,d=bt.Collision.b2DistanceProxy,v=bt.Collision.b2DynamicTree,b=bt.Collision.b2DynamicTreeBroadPhase,g=bt.Collision.b2DynamicTreeNode,x=bt.Collision.b2DynamicTreePair,w=bt.Collision.b2Manifold,C=bt.Collision.b2ManifoldPoint,S=bt.Collision.b2Point,A=bt.Collision.b2RayCastInput,M=bt.Collision.b2RayCastOutput,D=bt.Collision.b2Segment,k=bt.Collision.b2SeparationFunction,B=bt.Collision.b2Simplex,I=bt.Collision.b2SimplexCache,V=bt.Collision.b2SimplexVertex,P=bt.Collision.b2TimeOfImpact,T=bt.Collision.b2TOIInput,L=bt.Collision.b2WorldManifold,G=bt.Collision.ClipVertex,E=bt.Collision.Features,F=bt.Collision.IBroadPhase;l.b2AABB=function(){this.lowerBound=new a,this.upperBound=new a},l.prototype.IsValid=function(){var t=this.upperBound.x-this.lowerBound.x,e=this.upperBound.y-this.lowerBound.y,i=t>=0&&e>=0;return i&&this.lowerBound.IsValid()&&this.upperBound.IsValid()},l.prototype.GetCenter=function(){return new a((this.lowerBound.x+this.upperBound.x)/2,(this.lowerBound.y+this.upperBound.y)/2)},l.prototype.GetExtents=function(){return new a((this.upperBound.x-this.lowerBound.x)/2,(this.upperBound.y-this.lowerBound.y)/2)},l.prototype.Contains=function(t){var e=!0;return(e=(e=(e=e&&this.lowerBound.x<=t.lowerBound.x)&&this.lowerBound.y<=t.lowerBound.y)&&t.upperBound.x<=this.upperBound.x)&&t.upperBound.y<=this.upperBound.y},l.prototype.RayCast=function(t,e){var i=-Number.MAX_VALUE,n=Number.MAX_VALUE,o=e.p1.x,s=e.p1.y,r=e.p2.x-e.p1.x,a=e.p2.y-e.p1.y,l=Math.abs(r),h=Math.abs(a),c=t.normal,m=0,u=0,y=0,p=0,f=0;if(l<Number.MIN_VALUE){if(o<this.lowerBound.x||this.upperBound.x<o)return!1}else if(m=1/r,f=-1,(u=(this.lowerBound.x-o)*m)>(y=(this.upperBound.x-o)*m)&&(p=u,u=y,y=p,f=1),u>i&&(c.x=f,c.y=0,i=u),i>(n=Math.min(n,y)))return!1;if(h<Number.MIN_VALUE){if(s<this.lowerBound.y||this.upperBound.y<s)return!1}else if(m=1/a,f=-1,(u=(this.lowerBound.y-s)*m)>(y=(this.upperBound.y-s)*m)&&(p=u,u=y,y=p,f=1),u>i&&(c.y=f,c.x=0,i=u),i>(n=Math.min(n,y)))return!1;return t.fraction=i,!0},l.prototype.TestOverlap=function(t){var e=t.lowerBound.x-this.upperBound.x,i=t.lowerBound.y-this.upperBound.y,n=this.lowerBound.x-t.upperBound.x,o=this.lowerBound.y-t.upperBound.y;return!(e>0||i>0||n>0||o>0)},l.Combine=function(t,e){var i=new l;return i.Combine(t,e),i},l.prototype.Combine=function(t,e){this.lowerBound.x=Math.min(t.lowerBound.x,e.lowerBound.x),this.lowerBound.y=Math.min(t.lowerBound.y,e.lowerBound.y),this.upperBound.x=Math.max(t.upperBound.x,e.upperBound.x),this.upperBound.y=Math.max(t.upperBound.y,e.upperBound.y)},h.b2Bound=function(){},h.prototype.IsLower=function(){return!(1&this.value)},h.prototype.IsUpper=function(){return!(1&~this.value)},h.prototype.Swap=function(t){var e=this.value,i=this.proxy,n=this.stabbingCount;this.value=t.value,this.proxy=t.proxy,this.stabbingCount=t.stabbingCount,t.value=e,t.proxy=i,t.stabbingCount=n},c.b2BoundValues=function(){},c.prototype.b2BoundValues=function(){this.lowerValues=new Ct,this.lowerValues[0]=0,this.lowerValues[1]=0,this.upperValues=new Ct,this.upperValues[0]=0,this.upperValues[1]=0},m.b2Collision=function(){},m.ClipSegmentToLine=function(t,e,i,n){var o;void 0===n&&(n=0);var s=0,r=(o=e[0]).v,a=(o=e[1]).v,l=i.x*r.x+i.y*r.y-n,h=i.x*a.x+i.y*a.y-n;if(l<=0&&t[s++].Set(e[0]),h<=0&&t[s++].Set(e[1]),l*h<0){var c,m=l/(l-h),u=(o=t[s]).v;u.x=r.x+m*(a.x-r.x),u.y=r.y+m*(a.y-r.y),o=t[s],l>0?(c=e[0],o.id=c.id):(c=e[1],o.id=c.id),++s}return s},m.EdgeSeparation=function(t,e,i,n,o){void 0===i&&(i=0),parseInt(t.m_vertexCount);var s,r,a=t.m_vertices,l=t.m_normals,h=parseInt(n.m_vertexCount),c=n.m_vertices;s=e.R,r=l[i];for(var m=s.col1.x*r.x+s.col2.x*r.y,u=s.col1.y*r.x+s.col2.y*r.y,y=(s=o.R).col1.x*m+s.col1.y*u,p=s.col2.x*m+s.col2.y*u,f=0,_=Number.MAX_VALUE,d=0;d<h;++d){var v=(r=c[d]).x*y+r.y*p;v<_&&(_=v,f=d)}r=a[i],s=e.R;var b=e.position.x+(s.col1.x*r.x+s.col2.x*r.y),g=e.position.y+(s.col1.y*r.x+s.col2.y*r.y);r=c[f],s=o.R;var x=o.position.x+(s.col1.x*r.x+s.col2.x*r.y),w=o.position.y+(s.col1.y*r.x+s.col2.y*r.y);return(x-=b)*m+(w-=g)*u},m.FindMaxSeparation=function(t,e,i,n,o){var s,r,a=parseInt(e.m_vertexCount),l=e.m_normals;r=o.R,s=n.m_centroid;var h=o.position.x+(r.col1.x*s.x+r.col2.x*s.y),c=o.position.y+(r.col1.y*s.x+r.col2.y*s.y);r=i.R,s=e.m_centroid,h-=i.position.x+(r.col1.x*s.x+r.col2.x*s.y),c-=i.position.y+(r.col1.y*s.x+r.col2.y*s.y);for(var u=h*i.R.col1.x+c*i.R.col1.y,y=h*i.R.col2.x+c*i.R.col2.y,p=0,f=-Number.MAX_VALUE,_=0;_<a;++_){var d=(s=l[_]).x*u+s.y*y;d>f&&(f=d,p=_)}var v=m.EdgeSeparation(e,i,p,n,o),b=parseInt(p-1>=0?p-1:a-1),g=m.EdgeSeparation(e,i,b,n,o),x=parseInt(p+1<a?p+1:0),w=m.EdgeSeparation(e,i,x,n,o),C=0,S=0,A=0;if(g>v&&g>w)A=-1,C=b,S=g;else{if(!(w>v))return t[0]=p,v;A=1,C=x,S=w}for(;p=-1==A?C-1>=0?C-1:a-1:C+1<a?C+1:0,(v=m.EdgeSeparation(e,i,p,n,o))>S;)C=p,S=v;return t[0]=C,S},m.FindIncidentEdge=function(t,e,i,n,o,s){void 0===n&&(n=0),parseInt(e.m_vertexCount);var r,a,l=e.m_normals,h=parseInt(o.m_vertexCount),c=o.m_vertices,m=o.m_normals;r=i.R,a=l[n];var u=r.col1.x*a.x+r.col2.x*a.y,y=r.col1.y*a.x+r.col2.y*a.y,p=(r=s.R).col1.x*u+r.col1.y*y;y=r.col2.x*u+r.col2.y*y,u=p;for(var f,_=0,d=Number.MAX_VALUE,v=0;v<h;++v){var b=u*(a=m[v]).x+y*a.y;b<d&&(d=b,_=v)}var g=parseInt(_),x=parseInt(g+1<h?g+1:0);f=t[0],a=c[g],r=s.R,f.v.x=s.position.x+(r.col1.x*a.x+r.col2.x*a.y),f.v.y=s.position.y+(r.col1.y*a.x+r.col2.y*a.y),f.id.features.referenceEdge=n,f.id.features.incidentEdge=g,f.id.features.incidentVertex=0,f=t[1],a=c[x],r=s.R,f.v.x=s.position.x+(r.col1.x*a.x+r.col2.x*a.y),f.v.y=s.position.y+(r.col1.y*a.x+r.col2.y*a.y),f.id.features.referenceEdge=n,f.id.features.incidentEdge=x,f.id.features.incidentVertex=1},m.MakeClipPointVector=function(){var t=new wt(2);return t[0]=new G,t[1]=new G,t},m.CollidePolygons=function(t,e,i,o,s){var r;t.m_pointCount=0;var a=e.m_radius+o.m_radius,l=0;m.s_edgeAO[0]=l;var h=m.FindMaxSeparation(m.s_edgeAO,e,i,o,s);if(l=m.s_edgeAO[0],!(h>a)){var c=0;m.s_edgeBO[0]=c;var u=m.FindMaxSeparation(m.s_edgeBO,o,s,e,i);if(c=m.s_edgeBO[0],!(u>a)){var y,p,f,_,d,v=0,b=0;u>.98*h+.001?(y=o,p=e,f=s,_=i,v=c,t.m_type=w.e_faceB,b=1):(y=e,p=o,f=i,_=s,v=l,t.m_type=w.e_faceA,b=0);var g=m.s_incidentEdge;m.FindIncidentEdge(g,y,f,v,p,_);var x,C=parseInt(y.m_vertexCount),S=y.m_vertices,A=S[v];x=v+1<C?S[parseInt(v+1)]:S[0];var M=m.s_localTangent;M.Set(x.x-A.x,x.y-A.y),M.Normalize();var D=m.s_localNormal;D.x=M.y,D.y=-M.x;var k=m.s_planePoint;k.Set(.5*(A.x+x.x),.5*(A.y+x.y));var B=m.s_tangent;d=f.R,B.x=d.col1.x*M.x+d.col2.x*M.y,B.y=d.col1.y*M.x+d.col2.y*M.y;var I=m.s_tangent2;I.x=-B.x,I.y=-B.y;var V=m.s_normal;V.x=B.y,V.y=-B.x;var P=m.s_v11,T=m.s_v12;P.x=f.position.x+(d.col1.x*A.x+d.col2.x*A.y),P.y=f.position.y+(d.col1.y*A.x+d.col2.y*A.y),T.x=f.position.x+(d.col1.x*x.x+d.col2.x*x.y),T.y=f.position.y+(d.col1.y*x.x+d.col2.y*x.y);var L=V.x*P.x+V.y*P.y,G=-B.x*P.x-B.y*P.y+a,E=B.x*T.x+B.y*T.y+a,F=m.s_clipPoints1,R=m.s_clipPoints2;if(!(m.ClipSegmentToLine(F,g,I,G)<2||m.ClipSegmentToLine(R,F,B,E)<2)){t.m_localPlaneNormal.SetV(D),t.m_localPoint.SetV(k);for(var O=0,J=0;J<n.b2_maxManifoldPoints;++J)if(r=R[J],V.x*r.v.x+V.y*r.v.y-L<=a){var z=t.m_points[O];d=_.R;var j=r.v.x-_.position.x,N=r.v.y-_.position.y;z.m_localPoint.x=j*d.col1.x+N*d.col1.y,z.m_localPoint.y=j*d.col2.x+N*d.col2.y,z.m_id.Set(r.id),z.m_id.features.flip=b,++O}t.m_pointCount=O}}}},m.CollideCircles=function(t,e,i,n,o){var s,r;t.m_pointCount=0,s=i.R,r=e.m_p;var a=i.position.x+(s.col1.x*r.x+s.col2.x*r.y),l=i.position.y+(s.col1.y*r.x+s.col2.y*r.y);s=o.R,r=n.m_p;var h=o.position.x+(s.col1.x*r.x+s.col2.x*r.y)-a,c=o.position.y+(s.col1.y*r.x+s.col2.y*r.y)-l,m=h*h+c*c,u=e.m_radius+n.m_radius;m>u*u||(t.m_type=w.e_circles,t.m_localPoint.SetV(e.m_p),t.m_localPlaneNormal.SetZero(),t.m_pointCount=1,t.m_points[0].m_localPoint.SetV(n.m_p),t.m_points[0].m_id.key=0)},m.CollidePolygonAndCircle=function(t,e,i,n,o){t.m_pointCount=0;var s,r,a=0,l=0;r=o.R,s=n.m_p;var h=o.position.x+(r.col1.x*s.x+r.col2.x*s.y),c=o.position.y+(r.col1.y*s.x+r.col2.y*s.y);a=h-i.position.x,l=c-i.position.y;for(var m=a*(r=i.R).col1.x+l*r.col1.y,u=a*r.col2.x+l*r.col2.y,y=0,p=-Number.MAX_VALUE,f=e.m_radius+n.m_radius,_=parseInt(e.m_vertexCount),d=e.m_vertices,v=e.m_normals,b=0;b<_;++b){a=m-(s=d[b]).x,l=u-s.y;var g=(s=v[b]).x*a+s.y*l;if(g>f)return;g>p&&(p=g,y=b)}var x=parseInt(y),C=parseInt(x+1<_?x+1:0),S=d[x],A=d[C];if(p<Number.MIN_VALUE)return t.m_pointCount=1,t.m_type=w.e_faceA,t.m_localPlaneNormal.SetV(v[y]),t.m_localPoint.x=.5*(S.x+A.x),t.m_localPoint.y=.5*(S.y+A.y),t.m_points[0].m_localPoint.SetV(n.m_p),void(t.m_points[0].m_id.key=0);var M=(m-S.x)*(A.x-S.x)+(u-S.y)*(A.y-S.y),D=(m-A.x)*(S.x-A.x)+(u-A.y)*(S.y-A.y);if(M<=0){if((m-S.x)*(m-S.x)+(u-S.y)*(u-S.y)>f*f)return;t.m_pointCount=1,t.m_type=w.e_faceA,t.m_localPlaneNormal.x=m-S.x,t.m_localPlaneNormal.y=u-S.y,t.m_localPlaneNormal.Normalize(),t.m_localPoint.SetV(S),t.m_points[0].m_localPoint.SetV(n.m_p),t.m_points[0].m_id.key=0}else if(D<=0){if((m-A.x)*(m-A.x)+(u-A.y)*(u-A.y)>f*f)return;t.m_pointCount=1,t.m_type=w.e_faceA,t.m_localPlaneNormal.x=m-A.x,t.m_localPlaneNormal.y=u-A.y,t.m_localPlaneNormal.Normalize(),t.m_localPoint.SetV(A),t.m_points[0].m_localPoint.SetV(n.m_p),t.m_points[0].m_id.key=0}else{var k=.5*(S.x+A.x),B=.5*(S.y+A.y);if((p=(m-k)*v[x].x+(u-B)*v[x].y)>f)return;t.m_pointCount=1,t.m_type=w.e_faceA,t.m_localPlaneNormal.x=v[x].x,t.m_localPlaneNormal.y=v[x].y,t.m_localPlaneNormal.Normalize(),t.m_localPoint.Set(k,B),t.m_points[0].m_localPoint.SetV(n.m_p),t.m_points[0].m_id.key=0}},m.TestOverlap=function(t,e){var i=e.lowerBound,n=t.upperBound,o=i.x-n.x,s=i.y-n.y;i=t.lowerBound,n=e.upperBound;var r=i.x-n.x,a=i.y-n.y;return!(o>0||s>0||r>0||a>0)},bt.postDefs.push(function(){bt.Collision.b2Collision.s_incidentEdge=m.MakeClipPointVector(),bt.Collision.b2Collision.s_clipPoints1=m.MakeClipPointVector(),bt.Collision.b2Collision.s_clipPoints2=m.MakeClipPointVector(),bt.Collision.b2Collision.s_edgeAO=new Ct(1),bt.Collision.b2Collision.s_edgeBO=new Ct(1),bt.Collision.b2Collision.s_localTangent=new a,bt.Collision.b2Collision.s_localNormal=new a,bt.Collision.b2Collision.s_planePoint=new a,bt.Collision.b2Collision.s_normal=new a,bt.Collision.b2Collision.s_tangent=new a,bt.Collision.b2Collision.s_tangent2=new a,bt.Collision.b2Collision.s_v11=new a,bt.Collision.b2Collision.s_v12=new a,bt.Collision.b2Collision.b2CollidePolyTempVec=new a,bt.Collision.b2Collision.b2_nullFeature=255}),u.b2ContactID=function(){this.features=new E},u.prototype.b2ContactID=function(){this.features._m_id=this},u.prototype.Set=function(t){this.key=t._key},u.prototype.Copy=function(){var t=new u;return t.key=this.key,t},Object.defineProperty(u.prototype,"key",{enumerable:!1,configurable:!0,get:function(){return this._key}}),Object.defineProperty(u.prototype,"key",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._key=t,this.features._referenceEdge=255&this._key,this.features._incidentEdge=(65280&this._key)>>8&255,this.features._incidentVertex=(16711680&this._key)>>16&255,this.features._flip=(4278190080&this._key)>>24&255}}),y.b2ContactPoint=function(){this.position=new a,this.velocity=new a,this.normal=new a,this.id=new u},p.b2Distance=function(){},p.Distance=function(t,e,i){++p.b2_gjkCalls;var s=i.proxyA,r=i.proxyB,l=i.transformA,h=i.transformB,c=p.s_simplex;c.ReadCache(e,s,l,r,h);var m=c.m_vertices,u=p.s_saveA,y=p.s_saveB,f=0;c.GetClosestPoint().LengthSquared();for(var _,d=0,v=0;v<20;){for(f=c.m_count,d=0;d<f;d++)u[d]=m[d].indexA,y[d]=m[d].indexB;switch(c.m_count){case 1:break;case 2:c.Solve2();break;case 3:c.Solve3();break;default:n.b2Assert(!1)}if(3==c.m_count)break;(_=c.GetClosestPoint()).LengthSquared();var b=c.GetSearchDirection();if(b.LengthSquared()<Number.MIN_VALUE*Number.MIN_VALUE)break;var g=m[c.m_count];g.indexA=s.GetSupport(o.MulTMV(l.R,b.GetNegative())),g.wA=o.MulX(l,s.GetVertex(g.indexA)),g.indexB=r.GetSupport(o.MulTMV(h.R,b)),g.wB=o.MulX(h,r.GetVertex(g.indexB)),g.w=o.SubtractVV(g.wB,g.wA),++v,++p.b2_gjkIters;var x=!1;for(d=0;d<f;d++)if(g.indexA==u[d]&&g.indexB==y[d]){x=!0;break}if(x)break;++c.m_count}if(p.b2_gjkMaxIters=o.Max(p.b2_gjkMaxIters,v),c.GetWitnessPoints(t.pointA,t.pointB),t.distance=o.SubtractVV(t.pointA,t.pointB).Length(),t.iterations=v,c.WriteCache(e),i.useRadii){var w=s.m_radius,C=r.m_radius;if(t.distance>w+C&&t.distance>Number.MIN_VALUE){t.distance-=w+C;var S=o.SubtractVV(t.pointB,t.pointA);S.Normalize(),t.pointA.x+=w*S.x,t.pointA.y+=w*S.y,t.pointB.x-=C*S.x,t.pointB.y-=C*S.y}else(_=new a).x=.5*(t.pointA.x+t.pointB.x),_.y=.5*(t.pointA.y+t.pointB.y),t.pointA.x=t.pointB.x=_.x,t.pointA.y=t.pointB.y=_.y,t.distance=0}},bt.postDefs.push(function(){bt.Collision.b2Distance.s_simplex=new B,bt.Collision.b2Distance.s_saveA=new Ct(3),bt.Collision.b2Distance.s_saveB=new Ct(3)}),f.b2DistanceInput=function(){},_.b2DistanceOutput=function(){this.pointA=new a,this.pointB=new a},d.b2DistanceProxy=function(){},d.prototype.Set=function(o){switch(o.GetType()){case i.e_circleShape:var s=o instanceof t?o:null;this.m_vertices=new wt(1,!0),this.m_vertices[0]=s.m_p,this.m_count=1,this.m_radius=s.m_radius;break;case i.e_polygonShape:var r=o instanceof e?o:null;this.m_vertices=r.m_vertices,this.m_count=r.m_vertexCount,this.m_radius=r.m_radius;break;default:n.b2Assert(!1)}},d.prototype.GetSupport=function(t){for(var e=0,i=this.m_vertices[0].x*t.x+this.m_vertices[0].y*t.y,n=1;n<this.m_count;++n){var o=this.m_vertices[n].x*t.x+this.m_vertices[n].y*t.y;o>i&&(e=n,i=o)}return e},d.prototype.GetSupportVertex=function(t){for(var e=0,i=this.m_vertices[0].x*t.x+this.m_vertices[0].y*t.y,n=1;n<this.m_count;++n){var o=this.m_vertices[n].x*t.x+this.m_vertices[n].y*t.y;o>i&&(e=n,i=o)}return this.m_vertices[e]},d.prototype.GetVertexCount=function(){return this.m_count},d.prototype.GetVertex=function(t){return void 0===t&&(t=0),n.b2Assert(0<=t&&t<this.m_count),this.m_vertices[t]},v.b2DynamicTree=function(){},v.prototype.b2DynamicTree=function(){this.m_root=null,this.m_freeList=null,this.m_path=0,this.m_insertionCount=0},v.prototype.CreateProxy=function(t,e){var i=this.AllocateNode(),o=n.b2_aabbExtension,s=n.b2_aabbExtension;return i.aabb.lowerBound.x=t.lowerBound.x-o,i.aabb.lowerBound.y=t.lowerBound.y-s,i.aabb.upperBound.x=t.upperBound.x+o,i.aabb.upperBound.y=t.upperBound.y+s,i.userData=e,this.InsertLeaf(i),i},v.prototype.DestroyProxy=function(t){this.RemoveLeaf(t),this.FreeNode(t)},v.prototype.MoveProxy=function(t,e,i){if(n.b2Assert(t.IsLeaf()),t.aabb.Contains(e))return!1;this.RemoveLeaf(t);var o=n.b2_aabbExtension+n.b2_aabbMultiplier*(i.x>0?i.x:-i.x),s=n.b2_aabbExtension+n.b2_aabbMultiplier*(i.y>0?i.y:-i.y);return t.aabb.lowerBound.x=e.lowerBound.x-o,t.aabb.lowerBound.y=e.lowerBound.y-s,t.aabb.upperBound.x=e.upperBound.x+o,t.aabb.upperBound.y=e.upperBound.y+s,this.InsertLeaf(t),!0},v.prototype.Rebalance=function(t){if(void 0===t&&(t=0),null!=this.m_root)for(var e=0;e<t;e++){for(var i=this.m_root,n=0;0==i.IsLeaf();)i=this.m_path>>n&1?i.child2:i.child1,n=n+1&31;++this.m_path,this.RemoveLeaf(i),this.InsertLeaf(i)}},v.prototype.GetFatAABB=function(t){return t.aabb},v.prototype.GetUserData=function(t){return t.userData},v.prototype.Query=function(t,e){if(null!=this.m_root){var i=new wt,n=0;for(i[n++]=this.m_root;n>0;){var o=i[--n];if(o.aabb.TestOverlap(e))if(o.IsLeaf()){if(!t(o))return}else i[n++]=o.child1,i[n++]=o.child2}}},v.prototype.RayCast=function(t,e){if(null!=this.m_root){var i=e.p1,n=e.p2,s=o.SubtractVV(i,n);s.Normalize();var r=o.CrossFV(1,s),a=o.AbsV(r),h=e.maxFraction,c=new l,m=0,u=0;m=i.x+h*(n.x-i.x),u=i.y+h*(n.y-i.y),c.lowerBound.x=Math.min(i.x,m),c.lowerBound.y=Math.min(i.y,u),c.upperBound.x=Math.max(i.x,m),c.upperBound.y=Math.max(i.y,u);var y=new wt,p=0;for(y[p++]=this.m_root;p>0;){var f=y[--p];if(0!=f.aabb.TestOverlap(c)){var _=f.aabb.GetCenter(),d=f.aabb.GetExtents();if(!(Math.abs(r.x*(i.x-_.x)+r.y*(i.y-_.y))-a.x*d.x-a.y*d.y>0))if(f.IsLeaf()){var v=new A;if(v.p1=e.p1,v.p2=e.p2,v.maxFraction=e.maxFraction,0==(h=t(v,f)))return;h>0&&(m=i.x+h*(n.x-i.x),u=i.y+h*(n.y-i.y),c.lowerBound.x=Math.min(i.x,m),c.lowerBound.y=Math.min(i.y,u),c.upperBound.x=Math.max(i.x,m),c.upperBound.y=Math.max(i.y,u))}else y[p++]=f.child1,y[p++]=f.child2}}}},v.prototype.AllocateNode=function(){if(this.m_freeList){var t=this.m_freeList;return this.m_freeList=t.parent,t.parent=null,t.child1=null,t.child2=null,t}return new g},v.prototype.FreeNode=function(t){t.parent=this.m_freeList,this.m_freeList=t},v.prototype.InsertLeaf=function(t){if(++this.m_insertionCount,null==this.m_root)return this.m_root=t,void(this.m_root.parent=null);var e=t.aabb.GetCenter(),i=this.m_root;if(0==i.IsLeaf())do{var n=i.child1,o=i.child2;i=Math.abs((n.aabb.lowerBound.x+n.aabb.upperBound.x)/2-e.x)+Math.abs((n.aabb.lowerBound.y+n.aabb.upperBound.y)/2-e.y)<Math.abs((o.aabb.lowerBound.x+o.aabb.upperBound.x)/2-e.x)+Math.abs((o.aabb.lowerBound.y+o.aabb.upperBound.y)/2-e.y)?n:o}while(0==i.IsLeaf());var s=i.parent,r=this.AllocateNode();if(r.parent=s,r.userData=null,r.aabb.Combine(t.aabb,i.aabb),s){i.parent.child1==i?s.child1=r:s.child2=r,r.child1=i,r.child2=t,i.parent=r,t.parent=r;do{if(s.aabb.Contains(r.aabb))break;s.aabb.Combine(s.child1.aabb,s.child2.aabb),r=s,s=s.parent}while(s)}else r.child1=i,r.child2=t,i.parent=r,t.parent=r,this.m_root=r},v.prototype.RemoveLeaf=function(t){if(t!=this.m_root){var e,i=t.parent,n=i.parent;if(e=i.child1==t?i.child2:i.child1,n)for(n.child1==i?n.child1=e:n.child2=e,e.parent=n,this.FreeNode(i);n;){var o=n.aabb;if(n.aabb=l.Combine(n.child1.aabb,n.child2.aabb),o.Contains(n.aabb))break;n=n.parent}else this.m_root=e,e.parent=null,this.FreeNode(i)}else this.m_root=null},b.b2DynamicTreeBroadPhase=function(){this.m_tree=new v,this.m_moveBuffer=new wt,this.m_pairBuffer=new wt,this.m_pairCount=0},b.prototype.CreateProxy=function(t,e){var i=this.m_tree.CreateProxy(t,e);return++this.m_proxyCount,this.BufferMove(i),i},b.prototype.DestroyProxy=function(t){this.UnBufferMove(t),--this.m_proxyCount,this.m_tree.DestroyProxy(t)},b.prototype.MoveProxy=function(t,e,i){this.m_tree.MoveProxy(t,e,i)&&this.BufferMove(t)},b.prototype.TestOverlap=function(t,e){var i=this.m_tree.GetFatAABB(t),n=this.m_tree.GetFatAABB(e);return i.TestOverlap(n)},b.prototype.GetUserData=function(t){return this.m_tree.GetUserData(t)},b.prototype.GetFatAABB=function(t){return this.m_tree.GetFatAABB(t)},b.prototype.GetProxyCount=function(){return this.m_proxyCount},b.prototype.UpdatePairs=function(t){var e=this;e.m_pairCount=0;var i,n=0;function o(t){if(t==i)return!0;e.m_pairCount==e.m_pairBuffer.length&&(e.m_pairBuffer[e.m_pairCount]=new x);var n=e.m_pairBuffer[e.m_pairCount];return n.proxyA=t<i?t:i,n.proxyB=t>=i?t:i,++e.m_pairCount,!0}for(n=0;n<e.m_moveBuffer.length;++n){i=e.m_moveBuffer[n];var s=e.m_tree.GetFatAABB(i);e.m_tree.Query(o,s)}for(e.m_moveBuffer.length=0,n=0;n<e.m_pairCount;){var r=e.m_pairBuffer[n];for(t(e.m_tree.GetUserData(r.proxyA),e.m_tree.GetUserData(r.proxyB)),++n;n<e.m_pairCount;){var a=e.m_pairBuffer[n];if(a.proxyA!=r.proxyA||a.proxyB!=r.proxyB)break;++n}}},b.prototype.Query=function(t,e){this.m_tree.Query(t,e)},b.prototype.RayCast=function(t,e){this.m_tree.RayCast(t,e)},b.prototype.Validate=function(){},b.prototype.Rebalance=function(t){void 0===t&&(t=0),this.m_tree.Rebalance(t)},b.prototype.BufferMove=function(t){this.m_moveBuffer[this.m_moveBuffer.length]=t},b.prototype.UnBufferMove=function(t){var e=parseInt(this.m_moveBuffer.indexOf(t));this.m_moveBuffer.splice(e,1)},b.prototype.ComparePairs=function(t,e){return 0},b.__implements={},b.__implements[F]=!0,g.b2DynamicTreeNode=function(){this.aabb=new l},g.prototype.IsLeaf=function(){return null==this.child1},x.b2DynamicTreePair=function(){},w.b2Manifold=function(){this.m_pointCount=0},w.prototype.b2Manifold=function(){this.m_points=new wt(n.b2_maxManifoldPoints);for(var t=0;t<n.b2_maxManifoldPoints;t++)this.m_points[t]=new C;this.m_localPlaneNormal=new a,this.m_localPoint=new a},w.prototype.Reset=function(){for(var t=0;t<n.b2_maxManifoldPoints;t++)(this.m_points[t]instanceof C?this.m_points[t]:null).Reset();this.m_localPlaneNormal.SetZero(),this.m_localPoint.SetZero(),this.m_type=0,this.m_pointCount=0},w.prototype.Set=function(t){this.m_pointCount=t.m_pointCount;for(var e=0;e<n.b2_maxManifoldPoints;e++)(this.m_points[e]instanceof C?this.m_points[e]:null).Set(t.m_points[e]);this.m_localPlaneNormal.SetV(t.m_localPlaneNormal),this.m_localPoint.SetV(t.m_localPoint),this.m_type=t.m_type},w.prototype.Copy=function(){var t=new w;return t.Set(this),t},bt.postDefs.push(function(){bt.Collision.b2Manifold.e_circles=1,bt.Collision.b2Manifold.e_faceA=2,bt.Collision.b2Manifold.e_faceB=4}),C.b2ManifoldPoint=function(){this.m_localPoint=new a,this.m_id=new u},C.prototype.b2ManifoldPoint=function(){this.Reset()},C.prototype.Reset=function(){this.m_localPoint.SetZero(),this.m_normalImpulse=0,this.m_tangentImpulse=0,this.m_id.key=0},C.prototype.Set=function(t){this.m_localPoint.SetV(t.m_localPoint),this.m_normalImpulse=t.m_normalImpulse,this.m_tangentImpulse=t.m_tangentImpulse,this.m_id.Set(t.m_id)},S.b2Point=function(){this.p=new a},S.prototype.Support=function(t,e,i){return this.p},S.prototype.GetFirstVertex=function(t){return this.p},A.b2RayCastInput=function(){this.p1=new a,this.p2=new a},A.prototype.b2RayCastInput=function(t,e,i){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=1),t&&this.p1.SetV(t),e&&this.p2.SetV(e),this.maxFraction=i},M.b2RayCastOutput=function(){this.normal=new a},D.b2Segment=function(){this.p1=new a,this.p2=new a},D.prototype.TestSegment=function(t,e,i,n){void 0===n&&(n=0);var o=i.p1,s=i.p2.x-o.x,r=i.p2.y-o.y,a=this.p2.x-this.p1.x,l=this.p2.y-this.p1.y,h=-a,c=100*Number.MIN_VALUE,m=-(s*l+r*h);if(m>c){var u=o.x-this.p1.x,y=o.y-this.p1.y,p=u*l+y*h;if(0<=p&&p<=n*m){var f=-s*y+r*u;if(-c*m<=f&&f<=m*(1+c)){p/=m;var _=Math.sqrt(l*l+h*h);return l/=_,h/=_,t[0]=p,e.Set(l,h),!0}}}return!1},D.prototype.Extend=function(t){this.ExtendForward(t),this.ExtendBackward(t)},D.prototype.ExtendForward=function(t){var e=this.p2.x-this.p1.x,i=this.p2.y-this.p1.y,n=Math.min(e>0?(t.upperBound.x-this.p1.x)/e:e<0?(t.lowerBound.x-this.p1.x)/e:Number.POSITIVE_INFINITY,i>0?(t.upperBound.y-this.p1.y)/i:i<0?(t.lowerBound.y-this.p1.y)/i:Number.POSITIVE_INFINITY);this.p2.x=this.p1.x+e*n,this.p2.y=this.p1.y+i*n},D.prototype.ExtendBackward=function(t){var e=-this.p2.x+this.p1.x,i=-this.p2.y+this.p1.y,n=Math.min(e>0?(t.upperBound.x-this.p2.x)/e:e<0?(t.lowerBound.x-this.p2.x)/e:Number.POSITIVE_INFINITY,i>0?(t.upperBound.y-this.p2.y)/i:i<0?(t.lowerBound.y-this.p2.y)/i:Number.POSITIVE_INFINITY);this.p1.x=this.p2.x+e*n,this.p1.y=this.p2.y+i*n},k.b2SeparationFunction=function(){this.m_localPoint=new a,this.m_axis=new a},k.prototype.Initialize=function(t,e,i,s,r){this.m_proxyA=e,this.m_proxyB=s;var l,h,c,m,u,y,p=parseInt(t.count);n.b2Assert(0<p&&p<3);var f,_,d=0,v=0,b=0,g=0,x=0,w=0,C=0;if(1==p)this.m_type=k.e_points,l=this.m_proxyA.GetVertex(t.indexA[0]),m=this.m_proxyB.GetVertex(t.indexB[0]),_=l,f=i.R,d=i.position.x+(f.col1.x*_.x+f.col2.x*_.y),v=i.position.y+(f.col1.y*_.x+f.col2.y*_.y),_=m,f=r.R,b=r.position.x+(f.col1.x*_.x+f.col2.x*_.y),g=r.position.y+(f.col1.y*_.x+f.col2.y*_.y),this.m_axis.x=b-d,this.m_axis.y=g-v,this.m_axis.Normalize();else if(t.indexB[0]==t.indexB[1])this.m_type=k.e_faceA,h=this.m_proxyA.GetVertex(t.indexA[0]),c=this.m_proxyA.GetVertex(t.indexA[1]),m=this.m_proxyB.GetVertex(t.indexB[0]),this.m_localPoint.x=.5*(h.x+c.x),this.m_localPoint.y=.5*(h.y+c.y),this.m_axis=o.CrossVF(o.SubtractVV(c,h),1),this.m_axis.Normalize(),_=this.m_axis,x=(f=i.R).col1.x*_.x+f.col2.x*_.y,w=f.col1.y*_.x+f.col2.y*_.y,_=this.m_localPoint,f=i.R,d=i.position.x+(f.col1.x*_.x+f.col2.x*_.y),v=i.position.y+(f.col1.y*_.x+f.col2.y*_.y),_=m,f=r.R,(C=((b=r.position.x+(f.col1.x*_.x+f.col2.x*_.y))-d)*x+((g=r.position.y+(f.col1.y*_.x+f.col2.y*_.y))-v)*w)<0&&this.m_axis.NegativeSelf();else if(t.indexA[0]==t.indexA[0])this.m_type=k.e_faceB,u=this.m_proxyB.GetVertex(t.indexB[0]),y=this.m_proxyB.GetVertex(t.indexB[1]),l=this.m_proxyA.GetVertex(t.indexA[0]),this.m_localPoint.x=.5*(u.x+y.x),this.m_localPoint.y=.5*(u.y+y.y),this.m_axis=o.CrossVF(o.SubtractVV(y,u),1),this.m_axis.Normalize(),_=this.m_axis,x=(f=r.R).col1.x*_.x+f.col2.x*_.y,w=f.col1.y*_.x+f.col2.y*_.y,_=this.m_localPoint,f=r.R,b=r.position.x+(f.col1.x*_.x+f.col2.x*_.y),g=r.position.y+(f.col1.y*_.x+f.col2.y*_.y),_=l,f=i.R,(C=((d=i.position.x+(f.col1.x*_.x+f.col2.x*_.y))-b)*x+((v=i.position.y+(f.col1.y*_.x+f.col2.y*_.y))-g)*w)<0&&this.m_axis.NegativeSelf();else{h=this.m_proxyA.GetVertex(t.indexA[0]),c=this.m_proxyA.GetVertex(t.indexA[1]),u=this.m_proxyB.GetVertex(t.indexB[0]),y=this.m_proxyB.GetVertex(t.indexB[1]),o.MulX(i,l);var S=o.MulMV(i.R,o.SubtractVV(c,h));o.MulX(r,m);var A=o.MulMV(r.R,o.SubtractVV(y,u)),M=S.x*S.x+S.y*S.y,D=A.x*A.x+A.y*A.y,B=o.SubtractVV(A,S),I=S.x*B.x+S.y*B.y,V=A.x*B.x+A.y*B.y,P=S.x*A.x+S.y*A.y,T=M*D-P*P;C=0,0!=T&&(C=o.Clamp((P*V-I*D)/T,0,1));var L=(P*C+V)/D;L<0&&(L=0,C=o.Clamp((P-I)/M,0,1)),(l=new a).x=h.x+C*(c.x-h.x),l.y=h.y+C*(c.y-h.y),(m=new a).x=u.x+C*(y.x-u.x),m.y=u.y+C*(y.y-u.y),0==C||1==C?(this.m_type=k.e_faceB,this.m_axis=o.CrossVF(o.SubtractVV(y,u),1),this.m_axis.Normalize(),this.m_localPoint=m,_=this.m_axis,x=(f=r.R).col1.x*_.x+f.col2.x*_.y,w=f.col1.y*_.x+f.col2.y*_.y,_=this.m_localPoint,f=r.R,b=r.position.x+(f.col1.x*_.x+f.col2.x*_.y),g=r.position.y+(f.col1.y*_.x+f.col2.y*_.y),_=l,f=i.R,d=i.position.x+(f.col1.x*_.x+f.col2.x*_.y),v=i.position.y+(f.col1.y*_.x+f.col2.y*_.y),C<0&&this.m_axis.NegativeSelf()):(this.m_type=k.e_faceA,this.m_axis=o.CrossVF(o.SubtractVV(c,h),1),this.m_localPoint=l,_=this.m_axis,x=(f=i.R).col1.x*_.x+f.col2.x*_.y,w=f.col1.y*_.x+f.col2.y*_.y,_=this.m_localPoint,f=i.R,d=i.position.x+(f.col1.x*_.x+f.col2.x*_.y),v=i.position.y+(f.col1.y*_.x+f.col2.y*_.y),_=m,f=r.R,b=r.position.x+(f.col1.x*_.x+f.col2.x*_.y),g=r.position.y+(f.col1.y*_.x+f.col2.y*_.y),C<0&&this.m_axis.NegativeSelf())}},k.prototype.Evaluate=function(t,e){var i,s,r,a,l,h,c;switch(this.m_type){case k.e_points:return i=o.MulTMV(t.R,this.m_axis),s=o.MulTMV(e.R,this.m_axis.GetNegative()),r=this.m_proxyA.GetSupportVertex(i),a=this.m_proxyB.GetSupportVertex(s),l=o.MulX(t,r),((h=o.MulX(e,a)).x-l.x)*this.m_axis.x+(h.y-l.y)*this.m_axis.y;case k.e_faceA:return c=o.MulMV(t.R,this.m_axis),l=o.MulX(t,this.m_localPoint),s=o.MulTMV(e.R,c.GetNegative()),a=this.m_proxyB.GetSupportVertex(s),((h=o.MulX(e,a)).x-l.x)*c.x+(h.y-l.y)*c.y;case k.e_faceB:return c=o.MulMV(e.R,this.m_axis),h=o.MulX(e,this.m_localPoint),i=o.MulTMV(t.R,c.GetNegative()),r=this.m_proxyA.GetSupportVertex(i),((l=o.MulX(t,r)).x-h.x)*c.x+(l.y-h.y)*c.y;default:return n.b2Assert(!1),0}},bt.postDefs.push(function(){bt.Collision.b2SeparationFunction.e_points=1,bt.Collision.b2SeparationFunction.e_faceA=2,bt.Collision.b2SeparationFunction.e_faceB=4}),B.b2Simplex=function(){this.m_v1=new V,this.m_v2=new V,this.m_v3=new V,this.m_vertices=new wt(3)},B.prototype.b2Simplex=function(){this.m_vertices[0]=this.m_v1,this.m_vertices[1]=this.m_v2,this.m_vertices[2]=this.m_v3},B.prototype.ReadCache=function(t,e,i,s,r){var a,l;n.b2Assert(0<=t.count&&t.count<=3),this.m_count=t.count;for(var h=this.m_vertices,c=0;c<this.m_count;c++){var m=h[c];m.indexA=t.indexA[c],m.indexB=t.indexB[c],a=e.GetVertex(m.indexA),l=s.GetVertex(m.indexB),m.wA=o.MulX(i,a),m.wB=o.MulX(r,l),m.w=o.SubtractVV(m.wB,m.wA),m.a=0}if(this.m_count>1){var u=t.metric,y=this.GetMetric();(y<.5*u||2*u<y||y<Number.MIN_VALUE)&&(this.m_count=0)}0==this.m_count&&((m=h[0]).indexA=0,m.indexB=0,a=e.GetVertex(0),l=s.GetVertex(0),m.wA=o.MulX(i,a),m.wB=o.MulX(r,l),m.w=o.SubtractVV(m.wB,m.wA),this.m_count=1)},B.prototype.WriteCache=function(t){t.metric=this.GetMetric(),t.count=bt.parseUInt(this.m_count);for(var e=this.m_vertices,i=0;i<this.m_count;i++)t.indexA[i]=bt.parseUInt(e[i].indexA),t.indexB[i]=bt.parseUInt(e[i].indexB)},B.prototype.GetSearchDirection=function(){switch(this.m_count){case 1:return this.m_v1.w.GetNegative();case 2:var t=o.SubtractVV(this.m_v2.w,this.m_v1.w);return o.CrossVV(t,this.m_v1.w.GetNegative())>0?o.CrossFV(1,t):o.CrossVF(t,1);default:return n.b2Assert(!1),new a}},B.prototype.GetClosestPoint=function(){switch(this.m_count){case 0:default:return n.b2Assert(!1),new a;case 1:return this.m_v1.w;case 2:return new a(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y)}},B.prototype.GetWitnessPoints=function(t,e){switch(this.m_count){case 0:default:n.b2Assert(!1);break;case 1:t.SetV(this.m_v1.wA),e.SetV(this.m_v1.wB);break;case 2:t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x,t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y,e.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x,e.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:e.x=t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x,e.y=t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y}},B.prototype.GetMetric=function(){switch(this.m_count){case 0:default:return n.b2Assert(!1),0;case 1:return 0;case 2:return o.SubtractVV(this.m_v1.w,this.m_v2.w).Length();case 3:return o.CrossVV(o.SubtractVV(this.m_v2.w,this.m_v1.w),o.SubtractVV(this.m_v3.w,this.m_v1.w))}},B.prototype.Solve2=function(){var t=this.m_v1.w,e=this.m_v2.w,i=o.SubtractVV(e,t),n=-(t.x*i.x+t.y*i.y);if(n<=0)return this.m_v1.a=1,void(this.m_count=1);var s=e.x*i.x+e.y*i.y;if(s<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Set(this.m_v2);var r=1/(s+n);this.m_v1.a=s*r,this.m_v2.a=n*r,this.m_count=2},B.prototype.Solve3=function(){var t=this.m_v1.w,e=this.m_v2.w,i=this.m_v3.w,n=o.SubtractVV(e,t),s=o.Dot(t,n),r=o.Dot(e,n),a=-s,l=o.SubtractVV(i,t),h=o.Dot(t,l),c=o.Dot(i,l),m=-h,u=o.SubtractVV(i,e),y=o.Dot(e,u),p=o.Dot(i,u),f=-y,_=o.CrossVV(n,l),d=_*o.CrossVV(e,i),v=_*o.CrossVV(i,t),b=_*o.CrossVV(t,e);if(a<=0&&m<=0)return this.m_v1.a=1,void(this.m_count=1);if(r>0&&a>0&&b<=0){var g=1/(r+a);return this.m_v1.a=r*g,this.m_v2.a=a*g,void(this.m_count=2)}if(c>0&&m>0&&v<=0){var x=1/(c+m);return this.m_v1.a=c*x,this.m_v3.a=m*x,this.m_count=2,void this.m_v2.Set(this.m_v3)}if(r<=0&&f<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Set(this.m_v2);if(c<=0&&p<=0)return this.m_v3.a=1,this.m_count=1,void this.m_v1.Set(this.m_v3);if(p>0&&f>0&&d<=0){var w=1/(p+f);return this.m_v2.a=p*w,this.m_v3.a=f*w,this.m_count=2,void this.m_v1.Set(this.m_v3)}var C=1/(d+v+b);this.m_v1.a=d*C,this.m_v2.a=v*C,this.m_v3.a=b*C,this.m_count=3},I.b2SimplexCache=function(){this.indexA=new Ct(3),this.indexB=new Ct(3)},V.b2SimplexVertex=function(){},V.prototype.Set=function(t){this.wA.SetV(t.wA),this.wB.SetV(t.wB),this.w.SetV(t.w),this.a=t.a,this.indexA=t.indexA,this.indexB=t.indexB},P.b2TimeOfImpact=function(){},P.TimeOfImpact=function(t){++P.b2_toiCalls;var e=t.proxyA,i=t.proxyB,s=t.sweepA,r=t.sweepB;n.b2Assert(s.t0==r.t0),n.b2Assert(1-s.t0>Number.MIN_VALUE);var a=e.m_radius+i.m_radius,l=t.tolerance,h=0,c=0,m=0;for(P.s_cache.count=0,P.s_distanceInput.useRadii=!1;;){if(s.GetTransform(P.s_xfA,h),r.GetTransform(P.s_xfB,h),P.s_distanceInput.proxyA=e,P.s_distanceInput.proxyB=i,P.s_distanceInput.transformA=P.s_xfA,P.s_distanceInput.transformB=P.s_xfB,p.Distance(P.s_distanceOutput,P.s_cache,P.s_distanceInput),P.s_distanceOutput.distance<=0){h=1;break}P.s_fcn.Initialize(P.s_cache,e,P.s_xfA,i,P.s_xfB);var u=P.s_fcn.Evaluate(P.s_xfA,P.s_xfB);if(u<=0){h=1;break}if(0==c&&(m=u>a?o.Max(a-l,.75*a):o.Max(u-l,.02*a)),u-m<.5*l){if(0==c){h=1;break}break}var y=h,f=h,_=1,d=u;s.GetTransform(P.s_xfA,_),r.GetTransform(P.s_xfB,_);var v=P.s_fcn.Evaluate(P.s_xfA,P.s_xfB);if(v>=m){h=1;break}for(var b=0;;){var g;g=1&b?f+(m-d)*(_-f)/(v-d):.5*(f+_),s.GetTransform(P.s_xfA,g),r.GetTransform(P.s_xfB,g);var x=P.s_fcn.Evaluate(P.s_xfA,P.s_xfB);if(o.Abs(x-m)<.025*l){y=g;break}if(x>m?(f=g,d=x):(_=g,v=x),++b,++P.b2_toiRootIters,50==b)break}if(P.b2_toiMaxRootIters=o.Max(P.b2_toiMaxRootIters,b),y<(1+100*Number.MIN_VALUE)*h)break;if(h=y,c++,++P.b2_toiIters,1e3==c)break}return P.b2_toiMaxIters=o.Max(P.b2_toiMaxIters,c),h},bt.postDefs.push(function(){bt.Collision.b2TimeOfImpact.b2_toiCalls=0,bt.Collision.b2TimeOfImpact.b2_toiIters=0,bt.Collision.b2TimeOfImpact.b2_toiMaxIters=0,bt.Collision.b2TimeOfImpact.b2_toiRootIters=0,bt.Collision.b2TimeOfImpact.b2_toiMaxRootIters=0,bt.Collision.b2TimeOfImpact.s_cache=new I,bt.Collision.b2TimeOfImpact.s_distanceInput=new f,bt.Collision.b2TimeOfImpact.s_xfA=new r,bt.Collision.b2TimeOfImpact.s_xfB=new r,bt.Collision.b2TimeOfImpact.s_fcn=new k,bt.Collision.b2TimeOfImpact.s_distanceOutput=new _}),T.b2TOIInput=function(){this.proxyA=new d,this.proxyB=new d,this.sweepA=new s,this.sweepB=new s},L.b2WorldManifold=function(){this.m_normal=new a},L.prototype.b2WorldManifold=function(){this.m_points=new wt(n.b2_maxManifoldPoints);for(var t=0;t<n.b2_maxManifoldPoints;t++)this.m_points[t]=new a},L.prototype.Initialize=function(t,e,i,n,o){if(void 0===i&&(i=0),void 0===o&&(o=0),0!=t.m_pointCount){var s,r,a=0,l=0,h=0,c=0,m=0,u=0,y=0;switch(t.m_type){case w.e_circles:r=e.R,s=t.m_localPoint;var p=e.position.x+r.col1.x*s.x+r.col2.x*s.y,f=e.position.y+r.col1.y*s.x+r.col2.y*s.y;r=n.R,s=t.m_points[0].m_localPoint;var _=n.position.x+r.col1.x*s.x+r.col2.x*s.y,d=n.position.y+r.col1.y*s.x+r.col2.y*s.y,v=_-p,b=d-f,g=v*v+b*b;if(g>Number.MIN_VALUE*Number.MIN_VALUE){var x=Math.sqrt(g);this.m_normal.x=v/x,this.m_normal.y=b/x}else this.m_normal.x=1,this.m_normal.y=0;var C=p+i*this.m_normal.x,S=f+i*this.m_normal.y,A=_-o*this.m_normal.x,M=d-o*this.m_normal.y;this.m_points[0].x=.5*(C+A),this.m_points[0].y=.5*(S+M);break;case w.e_faceA:for(r=e.R,s=t.m_localPlaneNormal,l=r.col1.x*s.x+r.col2.x*s.y,h=r.col1.y*s.x+r.col2.y*s.y,r=e.R,s=t.m_localPoint,c=e.position.x+r.col1.x*s.x+r.col2.x*s.y,m=e.position.y+r.col1.y*s.x+r.col2.y*s.y,this.m_normal.x=l,this.m_normal.y=h,a=0;a<t.m_pointCount;a++)r=n.R,s=t.m_points[a].m_localPoint,u=n.position.x+r.col1.x*s.x+r.col2.x*s.y,y=n.position.y+r.col1.y*s.x+r.col2.y*s.y,this.m_points[a].x=u+.5*(i-(u-c)*l-(y-m)*h-o)*l,this.m_points[a].y=y+.5*(i-(u-c)*l-(y-m)*h-o)*h;break;case w.e_faceB:for(r=n.R,s=t.m_localPlaneNormal,l=r.col1.x*s.x+r.col2.x*s.y,h=r.col1.y*s.x+r.col2.y*s.y,r=n.R,s=t.m_localPoint,c=n.position.x+r.col1.x*s.x+r.col2.x*s.y,m=n.position.y+r.col1.y*s.x+r.col2.y*s.y,this.m_normal.x=-l,this.m_normal.y=-h,a=0;a<t.m_pointCount;a++)r=e.R,s=t.m_points[a].m_localPoint,u=e.position.x+r.col1.x*s.x+r.col2.x*s.y,y=e.position.y+r.col1.y*s.x+r.col2.y*s.y,this.m_points[a].x=u+.5*(o-(u-c)*l-(y-m)*h-i)*l,this.m_points[a].y=y+.5*(o-(u-c)*l-(y-m)*h-i)*h}}},G.ClipVertex=function(){this.v=new a,this.id=new u},G.prototype.Set=function(t){this.v.SetV(t.v),this.id.Set(t.id)},E.Features=function(){},Object.defineProperty(E.prototype,"referenceEdge",{enumerable:!1,configurable:!0,get:function(){return this._referenceEdge}}),Object.defineProperty(E.prototype,"referenceEdge",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._referenceEdge=t,this._m_id._key=4294967040&this._m_id._key|255&this._referenceEdge}}),Object.defineProperty(E.prototype,"incidentEdge",{enumerable:!1,configurable:!0,get:function(){return this._incidentEdge}}),Object.defineProperty(E.prototype,"incidentEdge",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._incidentEdge=t,this._m_id._key=4294902015&this._m_id._key|this._incidentEdge<<8&65280}}),Object.defineProperty(E.prototype,"incidentVertex",{enumerable:!1,configurable:!0,get:function(){return this._incidentVertex}}),Object.defineProperty(E.prototype,"incidentVertex",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._incidentVertex=t,this._m_id._key=4278255615&this._m_id._key|this._incidentVertex<<16&16711680}}),Object.defineProperty(E.prototype,"flip",{enumerable:!1,configurable:!0,get:function(){return this._flip}}),Object.defineProperty(E.prototype,"flip",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._flip=t,this._m_id._key=16777215&this._m_id._key|this._flip<<24&4278190080}})}(),function(){bt.Common.b2Color,bt.Common.b2internal;var t=bt.Common.b2Settings,e=bt.Collision.Shapes.b2CircleShape,i=bt.Collision.Shapes.b2EdgeChainDef,n=bt.Collision.Shapes.b2EdgeShape,o=bt.Collision.Shapes.b2MassData,s=bt.Collision.Shapes.b2PolygonShape,r=bt.Collision.Shapes.b2Shape,a=bt.Common.Math.b2Mat22;bt.Common.Math.b2Mat33;var l=bt.Common.Math.b2Math;bt.Common.Math.b2Sweep;var h=bt.Common.Math.b2Transform,c=bt.Common.Math.b2Vec2;bt.Common.Math.b2Vec3,bt.Dynamics.b2Body,bt.Dynamics.b2BodyDef,bt.Dynamics.b2ContactFilter,bt.Dynamics.b2ContactImpulse,bt.Dynamics.b2ContactListener,bt.Dynamics.b2ContactManager,bt.Dynamics.b2DebugDraw,bt.Dynamics.b2DestructionListener,bt.Dynamics.b2FilterData,bt.Dynamics.b2Fixture,bt.Dynamics.b2FixtureDef,bt.Dynamics.b2Island,bt.Dynamics.b2TimeStep,bt.Dynamics.b2World,bt.Collision.b2AABB,bt.Collision.b2Bound,bt.Collision.b2BoundValues,bt.Collision.b2Collision,bt.Collision.b2ContactID,bt.Collision.b2ContactPoint;var m=bt.Collision.b2Distance,u=bt.Collision.b2DistanceInput,y=bt.Collision.b2DistanceOutput,p=bt.Collision.b2DistanceProxy;bt.Collision.b2DynamicTree,bt.Collision.b2DynamicTreeBroadPhase,bt.Collision.b2DynamicTreeNode,bt.Collision.b2DynamicTreePair,bt.Collision.b2Manifold,bt.Collision.b2ManifoldPoint,bt.Collision.b2Point,bt.Collision.b2RayCastInput,bt.Collision.b2RayCastOutput,bt.Collision.b2Segment,bt.Collision.b2SeparationFunction,bt.Collision.b2Simplex;var f=bt.Collision.b2SimplexCache;bt.Collision.b2SimplexVertex,bt.Collision.b2TimeOfImpact,bt.Collision.b2TOIInput,bt.Collision.b2WorldManifold,bt.Collision.ClipVertex,bt.Collision.Features,bt.Collision.IBroadPhase,bt.inherit(e,bt.Collision.Shapes.b2Shape),e.prototype.__super=bt.Collision.Shapes.b2Shape.prototype,e.b2CircleShape=function(){bt.Collision.Shapes.b2Shape.b2Shape.apply(this,arguments),this.m_p=new c},e.prototype.Copy=function(){var t=new e;return t.Set(this),t},e.prototype.Set=function(t){if(this.__super.Set.call(this,t),bt.is(t,e)){var i=t instanceof e?t:null;this.m_p.SetV(i.m_p)}},e.prototype.TestPoint=function(t,e){var i=t.R,n=t.position.x+(i.col1.x*this.m_p.x+i.col2.x*this.m_p.y),o=t.position.y+(i.col1.y*this.m_p.x+i.col2.y*this.m_p.y);return(n=e.x-n)*n+(o=e.y-o)*o<=this.m_radius*this.m_radius},e.prototype.RayCast=function(t,e,i){var n=i.R,o=i.position.x+(n.col1.x*this.m_p.x+n.col2.x*this.m_p.y),s=i.position.y+(n.col1.y*this.m_p.x+n.col2.y*this.m_p.y),r=e.p1.x-o,a=e.p1.y-s,l=r*r+a*a-this.m_radius*this.m_radius,h=e.p2.x-e.p1.x,c=e.p2.y-e.p1.y,m=r*h+a*c,u=h*h+c*c,y=m*m-u*l;if(y<0||u<Number.MIN_VALUE)return!1;var p=-(m+Math.sqrt(y));return 0<=p&&p<=e.maxFraction*u&&(p/=u,t.fraction=p,t.normal.x=r+p*h,t.normal.y=a+p*c,t.normal.Normalize(),!0)},e.prototype.ComputeAABB=function(t,e){var i=e.R,n=e.position.x+(i.col1.x*this.m_p.x+i.col2.x*this.m_p.y),o=e.position.y+(i.col1.y*this.m_p.x+i.col2.y*this.m_p.y);t.lowerBound.Set(n-this.m_radius,o-this.m_radius),t.upperBound.Set(n+this.m_radius,o+this.m_radius)},e.prototype.ComputeMass=function(e,i){void 0===i&&(i=0),e.mass=i*t.b2_pi*this.m_radius*this.m_radius,e.center.SetV(this.m_p),e.I=e.mass*(.5*this.m_radius*this.m_radius+(this.m_p.x*this.m_p.x+this.m_p.y*this.m_p.y))},e.prototype.ComputeSubmergedArea=function(t,e,i,n){void 0===e&&(e=0);var o=l.MulX(i,this.m_p),s=-(l.Dot(t,o)-e);if(s<-this.m_radius+Number.MIN_VALUE)return 0;if(s>this.m_radius)return n.SetV(o),Math.PI*this.m_radius*this.m_radius;var r=this.m_radius*this.m_radius,a=s*s,h=r*(Math.asin(s/this.m_radius)+Math.PI/2)+s*Math.sqrt(r-a),c=-2/3*Math.pow(r-a,1.5)/h;return n.x=o.x+t.x*c,n.y=o.y+t.y*c,h},e.prototype.GetLocalPosition=function(){return this.m_p},e.prototype.SetLocalPosition=function(t){this.m_p.SetV(t)},e.prototype.GetRadius=function(){return this.m_radius},e.prototype.SetRadius=function(t){void 0===t&&(t=0),this.m_radius=t},e.prototype.b2CircleShape=function(t){void 0===t&&(t=0),this.__super.b2Shape.call(this),this.m_type=r.e_circleShape,this.m_radius=t},i.b2EdgeChainDef=function(){},i.prototype.b2EdgeChainDef=function(){this.vertexCount=0,this.isALoop=!0,this.vertices=[]},bt.inherit(n,bt.Collision.Shapes.b2Shape),n.prototype.__super=bt.Collision.Shapes.b2Shape.prototype,n.b2EdgeShape=function(){bt.Collision.Shapes.b2Shape.b2Shape.apply(this,arguments),this.s_supportVec=new c,this.m_v1=new c,this.m_v2=new c,this.m_coreV1=new c,this.m_coreV2=new c,this.m_normal=new c,this.m_direction=new c,this.m_cornerDir1=new c,this.m_cornerDir2=new c},n.prototype.TestPoint=function(t,e){return!1},n.prototype.RayCast=function(t,e,i){var n,o=e.p2.x-e.p1.x,s=e.p2.y-e.p1.y;n=i.R;var r=i.position.x+(n.col1.x*this.m_v1.x+n.col2.x*this.m_v1.y),a=i.position.y+(n.col1.y*this.m_v1.x+n.col2.y*this.m_v1.y),l=i.position.y+(n.col1.y*this.m_v2.x+n.col2.y*this.m_v2.y)-a,h=-(i.position.x+(n.col1.x*this.m_v2.x+n.col2.x*this.m_v2.y)-r),c=100*Number.MIN_VALUE,m=-(o*l+s*h);if(m>c){var u=e.p1.x-r,y=e.p1.y-a,p=u*l+y*h;if(0<=p&&p<=e.maxFraction*m){var f=-o*y+s*u;if(-c*m<=f&&f<=m*(1+c)){p/=m,t.fraction=p;var _=Math.sqrt(l*l+h*h);return t.normal.x=l/_,t.normal.y=h/_,!0}}}return!1},n.prototype.ComputeAABB=function(t,e){var i=e.R,n=e.position.x+(i.col1.x*this.m_v1.x+i.col2.x*this.m_v1.y),o=e.position.y+(i.col1.y*this.m_v1.x+i.col2.y*this.m_v1.y),s=e.position.x+(i.col1.x*this.m_v2.x+i.col2.x*this.m_v2.y),r=e.position.y+(i.col1.y*this.m_v2.x+i.col2.y*this.m_v2.y);n<s?(t.lowerBound.x=n,t.upperBound.x=s):(t.lowerBound.x=s,t.upperBound.x=n),o<r?(t.lowerBound.y=o,t.upperBound.y=r):(t.lowerBound.y=r,t.upperBound.y=o)},n.prototype.ComputeMass=function(t,e){t.mass=0,t.center.SetV(this.m_v1),t.I=0},n.prototype.ComputeSubmergedArea=function(t,e,i,n){void 0===e&&(e=0);var o=new c(t.x*e,t.y*e),s=l.MulX(i,this.m_v1),r=l.MulX(i,this.m_v2),a=l.Dot(t,s)-e,h=l.Dot(t,r)-e;if(a>0){if(h>0)return 0;s.x=-h/(a-h)*s.x+a/(a-h)*r.x,s.y=-h/(a-h)*s.y+a/(a-h)*r.y}else h>0&&(r.x=-h/(a-h)*s.x+a/(a-h)*r.x,r.y=-h/(a-h)*s.y+a/(a-h)*r.y);return n.x=(o.x+s.x+r.x)/3,n.y=(o.y+s.y+r.y)/3,.5*((s.x-o.x)*(r.y-o.y)-(s.y-o.y)*(r.x-o.x))},n.prototype.GetLength=function(){return this.m_length},n.prototype.GetVertex1=function(){return this.m_v1},n.prototype.GetVertex2=function(){return this.m_v2},n.prototype.GetCoreVertex1=function(){return this.m_coreV1},n.prototype.GetCoreVertex2=function(){return this.m_coreV2},n.prototype.GetNormalVector=function(){return this.m_normal},n.prototype.GetDirectionVector=function(){return this.m_direction},n.prototype.GetCorner1Vector=function(){return this.m_cornerDir1},n.prototype.GetCorner2Vector=function(){return this.m_cornerDir2},n.prototype.Corner1IsConvex=function(){return this.m_cornerConvex1},n.prototype.Corner2IsConvex=function(){return this.m_cornerConvex2},n.prototype.GetFirstVertex=function(t){var e=t.R;return new c(t.position.x+(e.col1.x*this.m_coreV1.x+e.col2.x*this.m_coreV1.y),t.position.y+(e.col1.y*this.m_coreV1.x+e.col2.y*this.m_coreV1.y))},n.prototype.GetNextEdge=function(){return this.m_nextEdge},n.prototype.GetPrevEdge=function(){return this.m_prevEdge},n.prototype.Support=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0);var n=t.R,o=t.position.x+(n.col1.x*this.m_coreV1.x+n.col2.x*this.m_coreV1.y),s=t.position.y+(n.col1.y*this.m_coreV1.x+n.col2.y*this.m_coreV1.y),r=t.position.x+(n.col1.x*this.m_coreV2.x+n.col2.x*this.m_coreV2.y),a=t.position.y+(n.col1.y*this.m_coreV2.x+n.col2.y*this.m_coreV2.y);return o*e+s*i>r*e+a*i?(this.s_supportVec.x=o,this.s_supportVec.y=s):(this.s_supportVec.x=r,this.s_supportVec.y=a),this.s_supportVec},n.prototype.b2EdgeShape=function(e,i){this.__super.b2Shape.call(this),this.m_type=r.e_edgeShape,this.m_prevEdge=null,this.m_nextEdge=null,this.m_v1=e,this.m_v2=i,this.m_direction.Set(this.m_v2.x-this.m_v1.x,this.m_v2.y-this.m_v1.y),this.m_length=this.m_direction.Normalize(),this.m_normal.Set(this.m_direction.y,-this.m_direction.x),this.m_coreV1.Set(-t.b2_toiSlop*(this.m_normal.x-this.m_direction.x)+this.m_v1.x,-t.b2_toiSlop*(this.m_normal.y-this.m_direction.y)+this.m_v1.y),this.m_coreV2.Set(-t.b2_toiSlop*(this.m_normal.x+this.m_direction.x)+this.m_v2.x,-t.b2_toiSlop*(this.m_normal.y+this.m_direction.y)+this.m_v2.y),this.m_cornerDir1=this.m_normal,this.m_cornerDir2.Set(-this.m_normal.x,-this.m_normal.y)},n.prototype.SetPrevEdge=function(t,e,i,n){this.m_prevEdge=t,this.m_coreV1=e,this.m_cornerDir1=i,this.m_cornerConvex1=n},n.prototype.SetNextEdge=function(t,e,i,n){this.m_nextEdge=t,this.m_coreV2=e,this.m_cornerDir2=i,this.m_cornerConvex2=n},o.b2MassData=function(){this.mass=0,this.center=new c(0,0),this.I=0},bt.inherit(s,bt.Collision.Shapes.b2Shape),s.prototype.__super=bt.Collision.Shapes.b2Shape.prototype,s.b2PolygonShape=function(){bt.Collision.Shapes.b2Shape.b2Shape.apply(this,arguments)},s.prototype.Copy=function(){var t=new s;return t.Set(this),t},s.prototype.Set=function(t){if(this.__super.Set.call(this,t),bt.is(t,s)){var e=t instanceof s?t:null;this.m_centroid.SetV(e.m_centroid),this.m_vertexCount=e.m_vertexCount,this.Reserve(this.m_vertexCount);for(var i=0;i<this.m_vertexCount;i++)this.m_vertices[i].SetV(e.m_vertices[i]),this.m_normals[i].SetV(e.m_normals[i])}},s.prototype.SetAsArray=function(t,e){void 0===e&&(e=0);var i,n=new wt,o=0;for(o=0;o<t.length;++o)i=t[o],n.push(i);this.SetAsVector(n,e)},s.AsArray=function(t,e){void 0===e&&(e=0);var i=new s;return i.SetAsArray(t,e),i},s.prototype.SetAsVector=function(e,i){void 0===i&&(i=0),0==i&&(i=e.length),t.b2Assert(2<=i),this.m_vertexCount=i,this.Reserve(i);var n=0;for(n=0;n<this.m_vertexCount;n++)this.m_vertices[n].SetV(e[n]);for(n=0;n<this.m_vertexCount;++n){var o=parseInt(n),r=parseInt(n+1<this.m_vertexCount?n+1:0),a=l.SubtractVV(this.m_vertices[r],this.m_vertices[o]);t.b2Assert(a.LengthSquared()>Number.MIN_VALUE),this.m_normals[n].SetV(l.CrossVF(a,1)),this.m_normals[n].Normalize()}this.m_centroid=s.ComputeCentroid(this.m_vertices,this.m_vertexCount)},s.AsVector=function(t,e){void 0===e&&(e=0);var i=new s;return i.SetAsVector(t,e),i},s.prototype.SetAsBox=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.m_vertexCount=4,this.Reserve(4),this.m_vertices[0].Set(-t,-e),this.m_vertices[1].Set(t,-e),this.m_vertices[2].Set(t,e),this.m_vertices[3].Set(-t,e),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid.SetZero()},s.AsBox=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0);var i=new s;return i.SetAsBox(t,e),i},s.prototype.SetAsOrientedBox=function(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=null),void 0===n&&(n=0),this.m_vertexCount=4,this.Reserve(4),this.m_vertices[0].Set(-t,-e),this.m_vertices[1].Set(t,-e),this.m_vertices[2].Set(t,e),this.m_vertices[3].Set(-t,e),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid=i;var o=new h;o.position=i,o.R.Set(n);for(var s=0;s<this.m_vertexCount;++s)this.m_vertices[s]=l.MulX(o,this.m_vertices[s]),this.m_normals[s]=l.MulMV(o.R,this.m_normals[s])},s.AsOrientedBox=function(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=null),void 0===n&&(n=0);var o=new s;return o.SetAsOrientedBox(t,e,i,n),o},s.prototype.SetAsEdge=function(t,e){this.m_vertexCount=2,this.Reserve(2),this.m_vertices[0].SetV(t),this.m_vertices[1].SetV(e),this.m_centroid.x=.5*(t.x+e.x),this.m_centroid.y=.5*(t.y+e.y),this.m_normals[0]=l.CrossVF(l.SubtractVV(e,t),1),this.m_normals[0].Normalize(),this.m_normals[1].x=-this.m_normals[0].x,this.m_normals[1].y=-this.m_normals[0].y},s.AsEdge=function(t,e){var i=new s;return i.SetAsEdge(t,e),i},s.prototype.TestPoint=function(t,e){for(var i,n=t.R,o=e.x-t.position.x,s=e.y-t.position.y,r=o*n.col1.x+s*n.col1.y,a=o*n.col2.x+s*n.col2.y,l=0;l<this.m_vertexCount;++l)if(o=r-(i=this.m_vertices[l]).x,s=a-i.y,(i=this.m_normals[l]).x*o+i.y*s>0)return!1;return!0},s.prototype.RayCast=function(t,e,i){var n,o,s=0,r=e.maxFraction,a=0,l=0;a=e.p1.x-i.position.x,l=e.p1.y-i.position.y;var h=a*(n=i.R).col1.x+l*n.col1.y,c=a*n.col2.x+l*n.col2.y;a=e.p2.x-i.position.x,l=e.p2.y-i.position.y;for(var m=a*(n=i.R).col1.x+l*n.col1.y-h,u=a*n.col2.x+l*n.col2.y-c,y=parseInt(-1),p=0;p<this.m_vertexCount;++p){a=(o=this.m_vertices[p]).x-h,l=o.y-c;var f=(o=this.m_normals[p]).x*a+o.y*l,_=o.x*m+o.y*u;if(0==_){if(f<0)return!1}else _<0&&f<s*_?(s=f/_,y=p):_>0&&f<r*_&&(r=f/_);if(r<s-Number.MIN_VALUE)return!1}return y>=0&&(t.fraction=s,n=i.R,o=this.m_normals[y],t.normal.x=n.col1.x*o.x+n.col2.x*o.y,t.normal.y=n.col1.y*o.x+n.col2.y*o.y,!0)},s.prototype.ComputeAABB=function(t,e){for(var i=e.R,n=this.m_vertices[0],o=e.position.x+(i.col1.x*n.x+i.col2.x*n.y),s=e.position.y+(i.col1.y*n.x+i.col2.y*n.y),r=o,a=s,l=1;l<this.m_vertexCount;++l){n=this.m_vertices[l];var h=e.position.x+(i.col1.x*n.x+i.col2.x*n.y),c=e.position.y+(i.col1.y*n.x+i.col2.y*n.y);o=o<h?o:h,s=s<c?s:c,r=r>h?r:h,a=a>c?a:c}t.lowerBound.x=o-this.m_radius,t.lowerBound.y=s-this.m_radius,t.upperBound.x=r+this.m_radius,t.upperBound.y=a+this.m_radius},s.prototype.ComputeMass=function(t,e){if(void 0===e&&(e=0),2==this.m_vertexCount)return t.center.x=.5*(this.m_vertices[0].x+this.m_vertices[1].x),t.center.y=.5*(this.m_vertices[0].y+this.m_vertices[1].y),t.mass=0,void(t.I=0);for(var i=0,n=0,o=0,s=0,r=1/3,a=0;a<this.m_vertexCount;++a){var l=this.m_vertices[a],h=a+1<this.m_vertexCount?this.m_vertices[parseInt(a+1)]:this.m_vertices[0],c=l.x-0,m=l.y-0,u=h.x-0,y=h.y-0,p=c*y-m*u,f=.5*p;o+=f,i+=f*r*(0+l.x+h.x),n+=f*r*(0+l.y+h.y),s+=p*(r*(.25*(c*c+u*c+u*u)+(0*c+0*u))+0+(r*(.25*(m*m+y*m+y*y)+(0*m+0*y))+0))}t.mass=e*o,i*=1/o,n*=1/o,t.center.Set(i,n),t.I=e*s},s.prototype.ComputeSubmergedArea=function(t,e,i,n){void 0===e&&(e=0);var s=l.MulTMV(i.R,t),r=e-l.Dot(t,i.position),a=new Ct,h=0,m=parseInt(-1),u=parseInt(-1),y=!1,p=0;for(p=0;p<this.m_vertexCount;++p){a[p]=l.Dot(s,this.m_vertices[p])-r;var f=a[p]<-Number.MIN_VALUE;p>0&&(f?y||(m=p-1,h++):y&&(u=p-1,h++)),y=f}switch(h){case 0:if(y){var _=new o;return this.ComputeMass(_,1),n.SetV(l.MulX(i,_.center)),_.mass}return 0;case 1:-1==m?m=this.m_vertexCount-1:u=this.m_vertexCount-1}var d,v=parseInt((m+1)%this.m_vertexCount),b=parseInt((u+1)%this.m_vertexCount),g=(0-a[m])/(a[v]-a[m]),x=(0-a[u])/(a[b]-a[u]),w=new c(this.m_vertices[m].x*(1-g)+this.m_vertices[v].x*g,this.m_vertices[m].y*(1-g)+this.m_vertices[v].y*g),C=new c(this.m_vertices[u].x*(1-x)+this.m_vertices[b].x*x,this.m_vertices[u].y*(1-x)+this.m_vertices[b].y*x),S=0,A=new c,M=this.m_vertices[v];for(p=v;p!=b;){d=(p=(p+1)%this.m_vertexCount)==b?C:this.m_vertices[p];var D=.5*((M.x-w.x)*(d.y-w.y)-(M.y-w.y)*(d.x-w.x));S+=D,A.x+=D*(w.x+M.x+d.x)/3,A.y+=D*(w.y+M.y+d.y)/3,M=d}return A.Multiply(1/S),n.SetV(l.MulX(i,A)),S},s.prototype.GetVertexCount=function(){return this.m_vertexCount},s.prototype.GetVertices=function(){return this.m_vertices},s.prototype.GetNormals=function(){return this.m_normals},s.prototype.GetSupport=function(t){for(var e=0,i=this.m_vertices[0].x*t.x+this.m_vertices[0].y*t.y,n=1;n<this.m_vertexCount;++n){var o=this.m_vertices[n].x*t.x+this.m_vertices[n].y*t.y;o>i&&(e=n,i=o)}return e},s.prototype.GetSupportVertex=function(t){for(var e=0,i=this.m_vertices[0].x*t.x+this.m_vertices[0].y*t.y,n=1;n<this.m_vertexCount;++n){var o=this.m_vertices[n].x*t.x+this.m_vertices[n].y*t.y;o>i&&(e=n,i=o)}return this.m_vertices[e]},s.prototype.Validate=function(){return!1},s.prototype.b2PolygonShape=function(){this.__super.b2Shape.call(this),this.m_type=r.e_polygonShape,this.m_centroid=new c,this.m_vertices=new wt,this.m_normals=new wt},s.prototype.Reserve=function(t){void 0===t&&(t=0);for(var e=parseInt(this.m_vertices.length);e<t;e++)this.m_vertices[e]=new c,this.m_normals[e]=new c},s.ComputeCentroid=function(t,e){void 0===e&&(e=0);for(var i=new c,n=0,o=1/3,s=0;s<e;++s){var r=t[s],a=s+1<e?t[parseInt(s+1)]:t[0],l=r.x-0,h=r.y-0,m=a.x-0,u=.5*(l*(a.y-0)-h*m);n+=u,i.x+=u*o*(0+r.x+a.x),i.y+=u*o*(0+r.y+a.y)}return i.x*=1/n,i.y*=1/n,i},s.ComputeOBB=function(t,e,i){void 0===i&&(i=0);var n=0,o=new wt(i+1);for(n=0;n<i;++n)o[n]=e[n];o[i]=o[0];var s=Number.MAX_VALUE;for(n=1;n<=i;++n){for(var r=o[parseInt(n-1)],a=o[n].x-r.x,l=o[n].y-r.y,h=Math.sqrt(a*a+l*l),c=-(l/=h),m=a/=h,u=Number.MAX_VALUE,y=Number.MAX_VALUE,p=-Number.MAX_VALUE,f=-Number.MAX_VALUE,_=0;_<i;++_){var d=o[_].x-r.x,v=o[_].y-r.y,b=a*d+l*v,g=c*d+m*v;b<u&&(u=b),g<y&&(y=g),b>p&&(p=b),g>f&&(f=g)}var x=(p-u)*(f-y);if(x<.95*s){s=x,t.R.col1.x=a,t.R.col1.y=l,t.R.col2.x=c,t.R.col2.y=m;var w=.5*(u+p),C=.5*(y+f),S=t.R;t.center.x=r.x+(S.col1.x*w+S.col2.x*C),t.center.y=r.y+(S.col1.y*w+S.col2.y*C),t.extents.x=.5*(p-u),t.extents.y=.5*(f-y)}}},bt.postDefs.push(function(){bt.Collision.Shapes.b2PolygonShape.s_mat=new a}),r.b2Shape=function(){},r.prototype.Copy=function(){return null},r.prototype.Set=function(t){this.m_radius=t.m_radius},r.prototype.GetType=function(){return this.m_type},r.prototype.TestPoint=function(t,e){return!1},r.prototype.RayCast=function(t,e,i){return!1},r.prototype.ComputeAABB=function(t,e){},r.prototype.ComputeMass=function(t,e){},r.prototype.ComputeSubmergedArea=function(t,e,i,n){return 0},r.TestOverlap=function(t,e,i,n){var o=new u;o.proxyA=new p,o.proxyA.Set(t),o.proxyB=new p,o.proxyB.Set(i),o.transformA=e,o.transformB=n,o.useRadii=!0;var s=new f;s.count=0;var r=new y;return m.Distance(r,s,o),r.distance<10*Number.MIN_VALUE},r.prototype.b2Shape=function(){this.m_type=r.e_unknownShape,this.m_radius=t.b2_linearSlop},bt.postDefs.push(function(){bt.Collision.Shapes.b2Shape.e_unknownShape=parseInt(-1),bt.Collision.Shapes.b2Shape.e_circleShape=0,bt.Collision.Shapes.b2Shape.e_polygonShape=1,bt.Collision.Shapes.b2Shape.e_edgeShape=2,bt.Collision.Shapes.b2Shape.e_shapeTypeCount=3,bt.Collision.Shapes.b2Shape.e_hitCollide=1,bt.Collision.Shapes.b2Shape.e_missCollide=0,bt.Collision.Shapes.b2Shape.e_startsInsideCollide=parseInt(-1)})}(),function(){var t=bt.Common.b2Color;bt.Common.b2internal;var e=bt.Common.b2Settings;bt.Common.Math.b2Mat22,bt.Common.Math.b2Mat33;var i=bt.Common.Math.b2Math;bt.Common.Math.b2Sweep,bt.Common.Math.b2Transform,bt.Common.Math.b2Vec2,bt.Common.Math.b2Vec3,t.b2Color=function(){this._r=0,this._g=0,this._b=0},t.prototype.b2Color=function(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this._r=bt.parseUInt(255*i.Clamp(t,0,1)),this._g=bt.parseUInt(255*i.Clamp(e,0,1)),this._b=bt.parseUInt(255*i.Clamp(n,0,1))},t.prototype.Set=function(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this._r=bt.parseUInt(255*i.Clamp(t,0,1)),this._g=bt.parseUInt(255*i.Clamp(e,0,1)),this._b=bt.parseUInt(255*i.Clamp(n,0,1))},Object.defineProperty(t.prototype,"r",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._r=bt.parseUInt(255*i.Clamp(t,0,1))}}),Object.defineProperty(t.prototype,"g",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._g=bt.parseUInt(255*i.Clamp(t,0,1))}}),Object.defineProperty(t.prototype,"b",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._b=bt.parseUInt(255*i.Clamp(t,0,1))}}),Object.defineProperty(t.prototype,"color",{enumerable:!1,configurable:!0,get:function(){return this._r<<16|this._g<<8|this._b}}),e.b2Settings=function(){},e.b2MixFriction=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),Math.sqrt(t*e)},e.b2MixRestitution=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),t>e?t:e},e.b2Assert=function(t){if(!t)throw"Assertion Failed"},bt.postDefs.push(function(){bt.Common.b2Settings.VERSION="2.1alpha",bt.Common.b2Settings.USHRT_MAX=65535,bt.Common.b2Settings.b2_pi=Math.PI,bt.Common.b2Settings.b2_maxManifoldPoints=2,bt.Common.b2Settings.b2_aabbExtension=.1,bt.Common.b2Settings.b2_aabbMultiplier=2,bt.Common.b2Settings.b2_polygonRadius=2*e.b2_linearSlop,bt.Common.b2Settings.b2_linearSlop=.005,bt.Common.b2Settings.b2_angularSlop=2/180*e.b2_pi,bt.Common.b2Settings.b2_toiSlop=8*e.b2_linearSlop,bt.Common.b2Settings.b2_maxTOIContactsPerIsland=32,bt.Common.b2Settings.b2_maxTOIJointsPerIsland=32,bt.Common.b2Settings.b2_velocityThreshold=1,bt.Common.b2Settings.b2_maxLinearCorrection=.2,bt.Common.b2Settings.b2_maxAngularCorrection=8/180*e.b2_pi,bt.Common.b2Settings.b2_maxTranslation=2,bt.Common.b2Settings.b2_maxTranslationSquared=e.b2_maxTranslation*e.b2_maxTranslation,bt.Common.b2Settings.b2_maxRotation=.5*e.b2_pi,bt.Common.b2Settings.b2_maxRotationSquared=e.b2_maxRotation*e.b2_maxRotation,bt.Common.b2Settings.b2_contactBaumgarte=.2,bt.Common.b2Settings.b2_timeToSleep=.5,bt.Common.b2Settings.b2_linearSleepTolerance=.01,bt.Common.b2Settings.b2_angularSleepTolerance=2/180*e.b2_pi})}(),function(){bt.Collision.b2AABB,bt.Common.b2Color,bt.Common.b2internal,bt.Common.b2Settings;var t=bt.Common.Math.b2Mat22,e=bt.Common.Math.b2Mat33,i=bt.Common.Math.b2Math,n=bt.Common.Math.b2Sweep,o=bt.Common.Math.b2Transform,s=bt.Common.Math.b2Vec2,r=bt.Common.Math.b2Vec3;t.b2Mat22=function(){this.col1=new s,this.col2=new s},t.prototype.b2Mat22=function(){this.SetIdentity()},t.FromAngle=function(e){void 0===e&&(e=0);var i=new t;return i.Set(e),i},t.FromVV=function(e,i){var n=new t;return n.SetVV(e,i),n},t.prototype.Set=function(t){void 0===t&&(t=0);var e=Math.cos(t),i=Math.sin(t);this.col1.x=e,this.col2.x=-i,this.col1.y=i,this.col2.y=e},t.prototype.SetVV=function(t,e){this.col1.SetV(t),this.col2.SetV(e)},t.prototype.Copy=function(){var e=new t;return e.SetM(this),e},t.prototype.SetM=function(t){this.col1.SetV(t.col1),this.col2.SetV(t.col2)},t.prototype.AddM=function(t){this.col1.x+=t.col1.x,this.col1.y+=t.col1.y,this.col2.x+=t.col2.x,this.col2.y+=t.col2.y},t.prototype.SetIdentity=function(){this.col1.x=1,this.col2.x=0,this.col1.y=0,this.col2.y=1},t.prototype.SetZero=function(){this.col1.x=0,this.col2.x=0,this.col1.y=0,this.col2.y=0},t.prototype.GetAngle=function(){return Math.atan2(this.col1.y,this.col1.x)},t.prototype.GetInverse=function(t){var e=this.col1.x,i=this.col2.x,n=this.col1.y,o=this.col2.y,s=e*o-i*n;return 0!=s&&(s=1/s),t.col1.x=s*o,t.col2.x=-s*i,t.col1.y=-s*n,t.col2.y=s*e,t},t.prototype.Solve=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0);var n=this.col1.x,o=this.col2.x,s=this.col1.y,r=this.col2.y,a=n*r-o*s;return 0!=a&&(a=1/a),t.x=a*(r*e-o*i),t.y=a*(n*i-s*e),t},t.prototype.Abs=function(){this.col1.Abs(),this.col2.Abs()},e.b2Mat33=function(){this.col1=new r,this.col2=new r,this.col3=new r},e.prototype.b2Mat33=function(t,e,i){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=null),t||e||i?(this.col1.SetV(t),this.col2.SetV(e),this.col3.SetV(i)):(this.col1.SetZero(),this.col2.SetZero(),this.col3.SetZero())},e.prototype.SetVVV=function(t,e,i){this.col1.SetV(t),this.col2.SetV(e),this.col3.SetV(i)},e.prototype.Copy=function(){return new e(this.col1,this.col2,this.col3)},e.prototype.SetM=function(t){this.col1.SetV(t.col1),this.col2.SetV(t.col2),this.col3.SetV(t.col3)},e.prototype.AddM=function(t){this.col1.x+=t.col1.x,this.col1.y+=t.col1.y,this.col1.z+=t.col1.z,this.col2.x+=t.col2.x,this.col2.y+=t.col2.y,this.col2.z+=t.col2.z,this.col3.x+=t.col3.x,this.col3.y+=t.col3.y,this.col3.z+=t.col3.z},e.prototype.SetIdentity=function(){this.col1.x=1,this.col2.x=0,this.col3.x=0,this.col1.y=0,this.col2.y=1,this.col3.y=0,this.col1.z=0,this.col2.z=0,this.col3.z=1},e.prototype.SetZero=function(){this.col1.x=0,this.col2.x=0,this.col3.x=0,this.col1.y=0,this.col2.y=0,this.col3.y=0,this.col1.z=0,this.col2.z=0,this.col3.z=0},e.prototype.Solve22=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0);var n=this.col1.x,o=this.col2.x,s=this.col1.y,r=this.col2.y,a=n*r-o*s;return 0!=a&&(a=1/a),t.x=a*(r*e-o*i),t.y=a*(n*i-s*e),t},e.prototype.Solve33=function(t,e,i,n){void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0);var o=this.col1.x,s=this.col1.y,r=this.col1.z,a=this.col2.x,l=this.col2.y,h=this.col2.z,c=this.col3.x,m=this.col3.y,u=this.col3.z,y=o*(l*u-h*m)+s*(h*c-a*u)+r*(a*m-l*c);return 0!=y&&(y=1/y),t.x=y*(e*(l*u-h*m)+i*(h*c-a*u)+n*(a*m-l*c)),t.y=y*(o*(i*u-n*m)+s*(n*c-e*u)+r*(e*m-i*c)),t.z=y*(o*(l*n-h*i)+s*(h*e-a*n)+r*(a*i-l*e)),t},i.b2Math=function(){},i.IsValid=function(t){return void 0===t&&(t=0),isFinite(t)},i.Dot=function(t,e){return t.x*e.x+t.y*e.y},i.CrossVV=function(t,e){return t.x*e.y-t.y*e.x},i.CrossVF=function(t,e){return void 0===e&&(e=0),new s(e*t.y,-e*t.x)},i.CrossFV=function(t,e){return void 0===t&&(t=0),new s(-t*e.y,t*e.x)},i.MulMV=function(t,e){return new s(t.col1.x*e.x+t.col2.x*e.y,t.col1.y*e.x+t.col2.y*e.y)},i.MulTMV=function(t,e){return new s(i.Dot(e,t.col1),i.Dot(e,t.col2))},i.MulX=function(t,e){var n=i.MulMV(t.R,e);return n.x+=t.position.x,n.y+=t.position.y,n},i.MulXT=function(t,e){var n=i.SubtractVV(e,t.position),o=n.x*t.R.col1.x+n.y*t.R.col1.y;return n.y=n.x*t.R.col2.x+n.y*t.R.col2.y,n.x=o,n},i.AddVV=function(t,e){return new s(t.x+e.x,t.y+e.y)},i.SubtractVV=function(t,e){return new s(t.x-e.x,t.y-e.y)},i.Distance=function(t,e){var i=t.x-e.x,n=t.y-e.y;return Math.sqrt(i*i+n*n)},i.DistanceSquared=function(t,e){var i=t.x-e.x,n=t.y-e.y;return i*i+n*n},i.MulFV=function(t,e){return void 0===t&&(t=0),new s(t*e.x,t*e.y)},i.AddMM=function(e,n){return t.FromVV(i.AddVV(e.col1,n.col1),i.AddVV(e.col2,n.col2))},i.MulMM=function(e,n){return t.FromVV(i.MulMV(e,n.col1),i.MulMV(e,n.col2))},i.MulTMM=function(e,n){var o=new s(i.Dot(e.col1,n.col1),i.Dot(e.col2,n.col1)),r=new s(i.Dot(e.col1,n.col2),i.Dot(e.col2,n.col2));return t.FromVV(o,r)},i.Abs=function(t){return void 0===t&&(t=0),t>0?t:-t},i.AbsV=function(t){return new s(i.Abs(t.x),i.Abs(t.y))},i.AbsM=function(e){return t.FromVV(i.AbsV(e.col1),i.AbsV(e.col2))},i.Min=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),t<e?t:e},i.MinV=function(t,e){return new s(i.Min(t.x,e.x),i.Min(t.y,e.y))},i.Max=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),t>e?t:e},i.MaxV=function(t,e){return new s(i.Max(t.x,e.x),i.Max(t.y,e.y))},i.Clamp=function(t,e,i){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),t<e?e:t>i?i:t},i.ClampV=function(t,e,n){return i.MaxV(e,i.MinV(t,n))},i.Swap=function(t,e){var i=t[0];t[0]=e[0],e[0]=i},i.Random=function(){return 2*Math.random()-1},i.RandomRange=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0);var i=Math.random();return(e-t)*i+t},i.NextPowerOfTwo=function(t){return void 0===t&&(t=0),t|=t>>1&2147483647,t|=t>>2&1073741823,t|=t>>4&268435455,t|=t>>8&16777215,1+(t|=t>>16&65535)},i.IsPowerOfTwo=function(t){return void 0===t&&(t=0),t>0&&!(t&t-1)},bt.postDefs.push(function(){bt.Common.Math.b2Math.b2Vec2_zero=new s(0,0),bt.Common.Math.b2Math.b2Mat22_identity=t.FromVV(new s(1,0),new s(0,1)),bt.Common.Math.b2Math.b2Transform_identity=new o(i.b2Vec2_zero,i.b2Mat22_identity)}),n.b2Sweep=function(){this.localCenter=new s,this.c0=new s,this.c=new s},n.prototype.Set=function(t){this.localCenter.SetV(t.localCenter),this.c0.SetV(t.c0),this.c.SetV(t.c),this.a0=t.a0,this.a=t.a,this.t0=t.t0},n.prototype.Copy=function(){var t=new n;return t.localCenter.SetV(this.localCenter),t.c0.SetV(this.c0),t.c.SetV(this.c),t.a0=this.a0,t.a=this.a,t.t0=this.t0,t},n.prototype.GetTransform=function(t,e){void 0===e&&(e=0),t.position.x=(1-e)*this.c0.x+e*this.c.x,t.position.y=(1-e)*this.c0.y+e*this.c.y;var i=(1-e)*this.a0+e*this.a;t.R.Set(i);var n=t.R;t.position.x-=n.col1.x*this.localCenter.x+n.col2.x*this.localCenter.y,t.position.y-=n.col1.y*this.localCenter.x+n.col2.y*this.localCenter.y},n.prototype.Advance=function(t){if(void 0===t&&(t=0),this.t0<t&&1-this.t0>Number.MIN_VALUE){var e=(t-this.t0)/(1-this.t0);this.c0.x=(1-e)*this.c0.x+e*this.c.x,this.c0.y=(1-e)*this.c0.y+e*this.c.y,this.a0=(1-e)*this.a0+e*this.a,this.t0=t}},o.b2Transform=function(){this.position=new s,this.R=new t},o.prototype.b2Transform=function(t,e){void 0===t&&(t=null),void 0===e&&(e=null),t&&(this.position.SetV(t),this.R.SetM(e))},o.prototype.Initialize=function(t,e){this.position.SetV(t),this.R.SetM(e)},o.prototype.SetIdentity=function(){this.position.SetZero(),this.R.SetIdentity()},o.prototype.Set=function(t){this.position.SetV(t.position),this.R.SetM(t.R)},o.prototype.GetAngle=function(){return Math.atan2(this.R.col1.y,this.R.col1.x)},s.b2Vec2=function(){},s.prototype.b2Vec2=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e},s.prototype.SetZero=function(){this.x=0,this.y=0},s.prototype.Set=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e},s.prototype.SetV=function(t){this.x=t.x,this.y=t.y},s.prototype.GetNegative=function(){return new s(-this.x,-this.y)},s.prototype.NegativeSelf=function(){this.x=-this.x,this.y=-this.y},s.Make=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),new s(t,e)},s.prototype.Copy=function(){return new s(this.x,this.y)},s.prototype.Add=function(t){this.x+=t.x,this.y+=t.y},s.prototype.Subtract=function(t){this.x-=t.x,this.y-=t.y},s.prototype.Multiply=function(t){void 0===t&&(t=0),this.x*=t,this.y*=t},s.prototype.MulM=function(t){var e=this.x;this.x=t.col1.x*e+t.col2.x*this.y,this.y=t.col1.y*e+t.col2.y*this.y},s.prototype.MulTM=function(t){var e=i.Dot(this,t.col1);this.y=i.Dot(this,t.col2),this.x=e},s.prototype.CrossVF=function(t){void 0===t&&(t=0);var e=this.x;this.x=t*this.y,this.y=-t*e},s.prototype.CrossFV=function(t){void 0===t&&(t=0);var e=this.x;this.x=-t*this.y,this.y=t*e},s.prototype.MinV=function(t){this.x=this.x<t.x?this.x:t.x,this.y=this.y<t.y?this.y:t.y},s.prototype.MaxV=function(t){this.x=this.x>t.x?this.x:t.x,this.y=this.y>t.y?this.y:t.y},s.prototype.Abs=function(){this.x<0&&(this.x=-this.x),this.y<0&&(this.y=-this.y)},s.prototype.Length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},s.prototype.LengthSquared=function(){return this.x*this.x+this.y*this.y},s.prototype.Normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y);if(t<Number.MIN_VALUE)return 0;var e=1/t;return this.x*=e,this.y*=e,t},s.prototype.IsValid=function(){return i.IsValid(this.x)&&i.IsValid(this.y)},r.b2Vec3=function(){},r.prototype.b2Vec3=function(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=i},r.prototype.SetZero=function(){this.x=this.y=this.z=0},r.prototype.Set=function(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=i},r.prototype.SetV=function(t){this.x=t.x,this.y=t.y,this.z=t.z},r.prototype.GetNegative=function(){return new r(-this.x,-this.y,-this.z)},r.prototype.NegativeSelf=function(){this.x=-this.x,this.y=-this.y,this.z=-this.z},r.prototype.Copy=function(){return new r(this.x,this.y,this.z)},r.prototype.Add=function(t){this.x+=t.x,this.y+=t.y,this.z+=t.z},r.prototype.Subtract=function(t){this.x-=t.x,this.y-=t.y,this.z-=t.z},r.prototype.Multiply=function(t){void 0===t&&(t=0),this.x*=t,this.y*=t,this.z*=t}}(),function(){bt.Dynamics.Controllers.b2ControllerEdge,bt.Common.Math.b2Mat22,bt.Common.Math.b2Mat33;var t=bt.Common.Math.b2Math,e=bt.Common.Math.b2Sweep,i=bt.Common.Math.b2Transform,n=bt.Common.Math.b2Vec2;bt.Common.Math.b2Vec3;var o=bt.Common.b2Color;bt.Common.b2internal;var s=bt.Common.b2Settings,r=bt.Collision.b2AABB;bt.Collision.b2Bound,bt.Collision.b2BoundValues,bt.Collision.b2Collision,bt.Collision.b2ContactID;var a=bt.Collision.b2ContactPoint;bt.Collision.b2Distance,bt.Collision.b2DistanceInput,bt.Collision.b2DistanceOutput,bt.Collision.b2DistanceProxy,bt.Collision.b2DynamicTree;var l=bt.Collision.b2DynamicTreeBroadPhase;bt.Collision.b2DynamicTreeNode,bt.Collision.b2DynamicTreePair,bt.Collision.b2Manifold,bt.Collision.b2ManifoldPoint,bt.Collision.b2Point;var h=bt.Collision.b2RayCastInput,c=bt.Collision.b2RayCastOutput;bt.Collision.b2Segment,bt.Collision.b2SeparationFunction,bt.Collision.b2Simplex,bt.Collision.b2SimplexCache,bt.Collision.b2SimplexVertex,bt.Collision.b2TimeOfImpact,bt.Collision.b2TOIInput,bt.Collision.b2WorldManifold,bt.Collision.ClipVertex,bt.Collision.Features,bt.Collision.IBroadPhase;var m=bt.Collision.Shapes.b2CircleShape;bt.Collision.Shapes.b2EdgeChainDef;var u=bt.Collision.Shapes.b2EdgeShape,y=bt.Collision.Shapes.b2MassData,p=bt.Collision.Shapes.b2PolygonShape,f=bt.Collision.Shapes.b2Shape,_=bt.Dynamics.b2Body,d=bt.Dynamics.b2BodyDef,v=bt.Dynamics.b2ContactFilter,b=bt.Dynamics.b2ContactImpulse,g=bt.Dynamics.b2ContactListener,x=bt.Dynamics.b2ContactManager,w=bt.Dynamics.b2DebugDraw,C=bt.Dynamics.b2DestructionListener,S=bt.Dynamics.b2FilterData,A=bt.Dynamics.b2Fixture,M=bt.Dynamics.b2FixtureDef,D=bt.Dynamics.b2Island,k=bt.Dynamics.b2TimeStep,B=bt.Dynamics.b2World;bt.Dynamics.Contacts.b2CircleContact;var I=bt.Dynamics.Contacts.b2Contact;bt.Dynamics.Contacts.b2ContactConstraint,bt.Dynamics.Contacts.b2ContactConstraintPoint,bt.Dynamics.Contacts.b2ContactEdge;var V=bt.Dynamics.Contacts.b2ContactFactory;bt.Dynamics.Contacts.b2ContactRegister,bt.Dynamics.Contacts.b2ContactResult;var P=bt.Dynamics.Contacts.b2ContactSolver;bt.Dynamics.Contacts.b2EdgeAndCircleContact,bt.Dynamics.Contacts.b2NullContact,bt.Dynamics.Contacts.b2PolyAndCircleContact,bt.Dynamics.Contacts.b2PolyAndEdgeContact,bt.Dynamics.Contacts.b2PolygonContact,bt.Dynamics.Contacts.b2PositionSolverManifold,bt.Dynamics.Controllers.b2Controller,bt.Dynamics.Joints.b2DistanceJoint,bt.Dynamics.Joints.b2DistanceJointDef,bt.Dynamics.Joints.b2FrictionJoint,bt.Dynamics.Joints.b2FrictionJointDef,bt.Dynamics.Joints.b2GearJoint,bt.Dynamics.Joints.b2GearJointDef,bt.Dynamics.Joints.b2Jacobian;var T=bt.Dynamics.Joints.b2Joint;bt.Dynamics.Joints.b2JointDef,bt.Dynamics.Joints.b2JointEdge,bt.Dynamics.Joints.b2LineJoint,bt.Dynamics.Joints.b2LineJointDef,bt.Dynamics.Joints.b2MouseJoint,bt.Dynamics.Joints.b2MouseJointDef,bt.Dynamics.Joints.b2PrismaticJoint,bt.Dynamics.Joints.b2PrismaticJointDef;var L=bt.Dynamics.Joints.b2PulleyJoint;bt.Dynamics.Joints.b2PulleyJointDef,bt.Dynamics.Joints.b2RevoluteJoint,bt.Dynamics.Joints.b2RevoluteJointDef,bt.Dynamics.Joints.b2WeldJoint,bt.Dynamics.Joints.b2WeldJointDef,_.b2Body=function(){this.m_xf=new i,this.m_sweep=new e,this.m_linearVelocity=new n,this.m_force=new n},_.prototype.connectEdges=function(e,i,n){void 0===n&&(n=0);var o=Math.atan2(i.GetDirectionVector().y,i.GetDirectionVector().x),r=Math.tan(.5*(o-n)),a=t.MulFV(r,i.GetDirectionVector());a=t.SubtractVV(a,i.GetNormalVector()),a=t.MulFV(s.b2_toiSlop,a),a=t.AddVV(a,i.GetVertex1());var l=t.AddVV(e.GetDirectionVector(),i.GetDirectionVector());l.Normalize();var h=t.Dot(e.GetDirectionVector(),i.GetNormalVector())>0;return e.SetNextEdge(i,a,l,h),i.SetPrevEdge(e,a,l,h),o},_.prototype.CreateFixture=function(t){if(1==this.m_world.IsLocked())return null;var e=new A;if(e.Create(this,this.m_xf,t),this.m_flags&_.e_activeFlag){var i=this.m_world.m_contactManager.m_broadPhase;e.CreateProxy(i,this.m_xf)}return e.m_next=this.m_fixtureList,this.m_fixtureList=e,++this.m_fixtureCount,e.m_body=this,e.m_density>0&&this.ResetMassData(),this.m_world.m_flags|=B.e_newFixture,e},_.prototype.CreateFixture2=function(t,e){void 0===e&&(e=0);var i=new M;return i.shape=t,i.density=e,this.CreateFixture(i)},_.prototype.DestroyFixture=function(t){if(1!=this.m_world.IsLocked()){for(var e=this.m_fixtureList,i=null;null!=e;){if(e==t){i?i.m_next=t.m_next:this.m_fixtureList=t.m_next;break}i=e,e=e.m_next}for(var n=this.m_contactList;n;){var o=n.contact;n=n.next;var s=o.GetFixtureA(),r=o.GetFixtureB();t!=s&&t!=r||this.m_world.m_contactManager.Destroy(o)}if(this.m_flags&_.e_activeFlag){var a=this.m_world.m_contactManager.m_broadPhase;t.DestroyProxy(a)}t.Destroy(),t.m_body=null,t.m_next=null,--this.m_fixtureCount,this.ResetMassData()}},_.prototype.SetPositionAndAngle=function(t,e){var i;if(void 0===e&&(e=0),1!=this.m_world.IsLocked()){this.m_xf.R.Set(e),this.m_xf.position.SetV(t);var n=this.m_xf.R,o=this.m_sweep.localCenter;this.m_sweep.c.x=n.col1.x*o.x+n.col2.x*o.y,this.m_sweep.c.y=n.col1.y*o.x+n.col2.y*o.y,this.m_sweep.c.x+=this.m_xf.position.x,this.m_sweep.c.y+=this.m_xf.position.y,this.m_sweep.c0.SetV(this.m_sweep.c),this.m_sweep.a0=this.m_sweep.a=e;var s=this.m_world.m_contactManager.m_broadPhase;for(i=this.m_fixtureList;i;i=i.m_next)i.Synchronize(s,this.m_xf,this.m_xf);this.m_world.m_contactManager.FindNewContacts()}},_.prototype.SetTransform=function(t){this.SetPositionAndAngle(t.position,t.GetAngle())},_.prototype.GetTransform=function(){return this.m_xf},_.prototype.GetPosition=function(){return this.m_xf.position},_.prototype.SetPosition=function(t){this.SetPositionAndAngle(t,this.GetAngle())},_.prototype.GetAngle=function(){return this.m_sweep.a},_.prototype.SetAngle=function(t){void 0===t&&(t=0),this.SetPositionAndAngle(this.GetPosition(),t)},_.prototype.GetWorldCenter=function(){return this.m_sweep.c},_.prototype.GetLocalCenter=function(){return this.m_sweep.localCenter},_.prototype.SetLinearVelocity=function(t){this.m_type!=_.b2_staticBody&&this.m_linearVelocity.SetV(t)},_.prototype.GetLinearVelocity=function(){return this.m_linearVelocity},_.prototype.SetAngularVelocity=function(t){void 0===t&&(t=0),this.m_type!=_.b2_staticBody&&(this.m_angularVelocity=t)},_.prototype.GetAngularVelocity=function(){return this.m_angularVelocity},_.prototype.GetDefinition=function(){var t=new d;return t.type=this.GetType(),t.allowSleep=(this.m_flags&_.e_allowSleepFlag)==_.e_allowSleepFlag,t.angle=this.GetAngle(),t.angularDamping=this.m_angularDamping,t.angularVelocity=this.m_angularVelocity,t.fixedRotation=(this.m_flags&_.e_fixedRotationFlag)==_.e_fixedRotationFlag,t.bullet=(this.m_flags&_.e_bulletFlag)==_.e_bulletFlag,t.awake=(this.m_flags&_.e_awakeFlag)==_.e_awakeFlag,t.linearDamping=this.m_linearDamping,t.linearVelocity.SetV(this.GetLinearVelocity()),t.position=this.GetPosition(),t.userData=this.GetUserData(),t},_.prototype.ApplyForce=function(t,e){this.m_type==_.b2_dynamicBody&&(0==this.IsAwake()&&this.SetAwake(!0),this.m_force.x+=t.x,this.m_force.y+=t.y,this.m_torque+=(e.x-this.m_sweep.c.x)*t.y-(e.y-this.m_sweep.c.y)*t.x)},_.prototype.ApplyTorque=function(t){void 0===t&&(t=0),this.m_type==_.b2_dynamicBody&&(0==this.IsAwake()&&this.SetAwake(!0),this.m_torque+=t)},_.prototype.ApplyImpulse=function(t,e){this.m_type==_.b2_dynamicBody&&(0==this.IsAwake()&&this.SetAwake(!0),this.m_linearVelocity.x+=this.m_invMass*t.x,this.m_linearVelocity.y+=this.m_invMass*t.y,this.m_angularVelocity+=this.m_invI*((e.x-this.m_sweep.c.x)*t.y-(e.y-this.m_sweep.c.y)*t.x))},_.prototype.Split=function(e){for(var i,n=this.GetLinearVelocity().Copy(),o=this.GetAngularVelocity(),s=this.GetWorldCenter(),r=this,a=this.m_world.CreateBody(this.GetDefinition()),l=r.m_fixtureList;l;)if(e(l)){var h=l.m_next;i?i.m_next=h:r.m_fixtureList=h,r.m_fixtureCount--,l.m_next=a.m_fixtureList,a.m_fixtureList=l,a.m_fixtureCount++,l.m_body=a,l=h}else i=l,l=l.m_next;r.ResetMassData(),a.ResetMassData();var c=r.GetWorldCenter(),m=a.GetWorldCenter(),u=t.AddVV(n,t.CrossFV(o,t.SubtractVV(c,s))),y=t.AddVV(n,t.CrossFV(o,t.SubtractVV(m,s)));return r.SetLinearVelocity(u),a.SetLinearVelocity(y),r.SetAngularVelocity(o),a.SetAngularVelocity(o),r.SynchronizeFixtures(),a.SynchronizeFixtures(),a},_.prototype.Merge=function(t){var e;for(e=t.m_fixtureList;e;){var i=e.m_next;t.m_fixtureCount--,e.m_next=this.m_fixtureList,this.m_fixtureList=e,this.m_fixtureCount++,e.m_body=o,e=i}n.m_fixtureCount=0;var n=this,o=t;n.GetWorldCenter(),o.GetWorldCenter(),n.GetLinearVelocity().Copy(),o.GetLinearVelocity().Copy(),n.GetAngularVelocity(),o.GetAngularVelocity(),n.ResetMassData(),this.SynchronizeFixtures()},_.prototype.GetMass=function(){return this.m_mass},_.prototype.GetInertia=function(){return this.m_I},_.prototype.GetMassData=function(t){t.mass=this.m_mass,t.I=this.m_I,t.center.SetV(this.m_sweep.localCenter)},_.prototype.SetMassData=function(e){if(s.b2Assert(0==this.m_world.IsLocked()),1!=this.m_world.IsLocked()&&this.m_type==_.b2_dynamicBody){this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=e.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,e.I>0&&!(this.m_flags&_.e_fixedRotationFlag)&&(this.m_I=e.I-this.m_mass*(e.center.x*e.center.x+e.center.y*e.center.y),this.m_invI=1/this.m_I);var i=this.m_sweep.c.Copy();this.m_sweep.localCenter.SetV(e.center),this.m_sweep.c0.SetV(t.MulX(this.m_xf,this.m_sweep.localCenter)),this.m_sweep.c.SetV(this.m_sweep.c0),this.m_linearVelocity.x+=this.m_angularVelocity*-(this.m_sweep.c.y-i.y),this.m_linearVelocity.y+=this.m_angularVelocity*+(this.m_sweep.c.x-i.x)}},_.prototype.ResetMassData=function(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_sweep.localCenter.SetZero(),this.m_type!=_.b2_staticBody&&this.m_type!=_.b2_kinematicBody){for(var e=n.Make(0,0),i=this.m_fixtureList;i;i=i.m_next)if(0!=i.m_density){var o=i.GetMassData();this.m_mass+=o.mass,e.x+=o.center.x*o.mass,e.y+=o.center.y*o.mass,this.m_I+=o.I}this.m_mass>0?(this.m_invMass=1/this.m_mass,e.x*=this.m_invMass,e.y*=this.m_invMass):(this.m_mass=1,this.m_invMass=1),this.m_I>0&&!(this.m_flags&_.e_fixedRotationFlag)?(this.m_I-=this.m_mass*(e.x*e.x+e.y*e.y),this.m_I*=this.m_inertiaScale,s.b2Assert(this.m_I>0),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0);var r=this.m_sweep.c.Copy();this.m_sweep.localCenter.SetV(e),this.m_sweep.c0.SetV(t.MulX(this.m_xf,this.m_sweep.localCenter)),this.m_sweep.c.SetV(this.m_sweep.c0),this.m_linearVelocity.x+=this.m_angularVelocity*-(this.m_sweep.c.y-r.y),this.m_linearVelocity.y+=this.m_angularVelocity*+(this.m_sweep.c.x-r.x)}},_.prototype.GetWorldPoint=function(t){var e=this.m_xf.R,i=new n(e.col1.x*t.x+e.col2.x*t.y,e.col1.y*t.x+e.col2.y*t.y);return i.x+=this.m_xf.position.x,i.y+=this.m_xf.position.y,i},_.prototype.GetWorldVector=function(e){return t.MulMV(this.m_xf.R,e)},_.prototype.GetLocalPoint=function(e){return t.MulXT(this.m_xf,e)},_.prototype.GetLocalVector=function(e){return t.MulTMV(this.m_xf.R,e)},_.prototype.GetLinearVelocityFromWorldPoint=function(t){return new n(this.m_linearVelocity.x-this.m_angularVelocity*(t.y-this.m_sweep.c.y),this.m_linearVelocity.y+this.m_angularVelocity*(t.x-this.m_sweep.c.x))},_.prototype.GetLinearVelocityFromLocalPoint=function(t){var e=this.m_xf.R,i=new n(e.col1.x*t.x+e.col2.x*t.y,e.col1.y*t.x+e.col2.y*t.y);return i.x+=this.m_xf.position.x,i.y+=this.m_xf.position.y,new n(this.m_linearVelocity.x-this.m_angularVelocity*(i.y-this.m_sweep.c.y),this.m_linearVelocity.y+this.m_angularVelocity*(i.x-this.m_sweep.c.x))},_.prototype.GetLinearDamping=function(){return this.m_linearDamping},_.prototype.SetLinearDamping=function(t){void 0===t&&(t=0),this.m_linearDamping=t},_.prototype.GetAngularDamping=function(){return this.m_angularDamping},_.prototype.SetAngularDamping=function(t){void 0===t&&(t=0),this.m_angularDamping=t},_.prototype.SetType=function(t){if(void 0===t&&(t=0),this.m_type!=t){this.m_type=t,this.ResetMassData(),this.m_type==_.b2_staticBody&&(this.m_linearVelocity.SetZero(),this.m_angularVelocity=0),this.SetAwake(!0),this.m_force.SetZero(),this.m_torque=0;for(var e=this.m_contactList;e;e=e.next)e.contact.FlagForFiltering()}},_.prototype.GetType=function(){return this.m_type},_.prototype.SetBullet=function(t){t?this.m_flags|=_.e_bulletFlag:this.m_flags&=~_.e_bulletFlag},_.prototype.IsBullet=function(){return(this.m_flags&_.e_bulletFlag)==_.e_bulletFlag},_.prototype.SetSleepingAllowed=function(t){t?this.m_flags|=_.e_allowSleepFlag:(this.m_flags&=~_.e_allowSleepFlag,this.SetAwake(!0))},_.prototype.SetAwake=function(t){t?(this.m_flags|=_.e_awakeFlag,this.m_sleepTime=0):(this.m_flags&=~_.e_awakeFlag,this.m_sleepTime=0,this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_force.SetZero(),this.m_torque=0)},_.prototype.IsAwake=function(){return(this.m_flags&_.e_awakeFlag)==_.e_awakeFlag},_.prototype.SetFixedRotation=function(t){t?this.m_flags|=_.e_fixedRotationFlag:this.m_flags&=~_.e_fixedRotationFlag,this.ResetMassData()},_.prototype.IsFixedRotation=function(){return(this.m_flags&_.e_fixedRotationFlag)==_.e_fixedRotationFlag},_.prototype.SetActive=function(t){var e,i;if(t!=this.IsActive())if(t)for(this.m_flags|=_.e_activeFlag,e=this.m_world.m_contactManager.m_broadPhase,i=this.m_fixtureList;i;i=i.m_next)i.CreateProxy(e,this.m_xf);else{for(this.m_flags&=~_.e_activeFlag,e=this.m_world.m_contactManager.m_broadPhase,i=this.m_fixtureList;i;i=i.m_next)i.DestroyProxy(e);for(var n=this.m_contactList;n;){var o=n;n=n.next,this.m_world.m_contactManager.Destroy(o.contact)}this.m_contactList=null}},_.prototype.IsActive=function(){return(this.m_flags&_.e_activeFlag)==_.e_activeFlag},_.prototype.IsSleepingAllowed=function(){return(this.m_flags&_.e_allowSleepFlag)==_.e_allowSleepFlag},_.prototype.GetFixtureList=function(){return this.m_fixtureList},_.prototype.GetJointList=function(){return this.m_jointList},_.prototype.GetControllerList=function(){return this.m_controllerList},_.prototype.GetContactList=function(){return this.m_contactList},_.prototype.GetNext=function(){return this.m_next},_.prototype.GetUserData=function(){return this.m_userData},_.prototype.SetUserData=function(t){this.m_userData=t},_.prototype.GetWorld=function(){return this.m_world},_.prototype.b2Body=function(t,e){this.m_flags=0,t.bullet&&(this.m_flags|=_.e_bulletFlag),t.fixedRotation&&(this.m_flags|=_.e_fixedRotationFlag),t.allowSleep&&(this.m_flags|=_.e_allowSleepFlag),t.awake&&(this.m_flags|=_.e_awakeFlag),t.active&&(this.m_flags|=_.e_activeFlag),this.m_world=e,this.m_xf.position.SetV(t.position),this.m_xf.R.Set(t.angle),this.m_sweep.localCenter.SetZero(),this.m_sweep.t0=1,this.m_sweep.a0=this.m_sweep.a=t.angle;var i=this.m_xf.R,n=this.m_sweep.localCenter;this.m_sweep.c.x=i.col1.x*n.x+i.col2.x*n.y,this.m_sweep.c.y=i.col1.y*n.x+i.col2.y*n.y,this.m_sweep.c.x+=this.m_xf.position.x,this.m_sweep.c.y+=this.m_xf.position.y,this.m_sweep.c0.SetV(this.m_sweep.c),this.m_jointList=null,this.m_controllerList=null,this.m_contactList=null,this.m_controllerCount=0,this.m_prev=null,this.m_next=null,this.m_linearVelocity.SetV(t.linearVelocity),this.m_angularVelocity=t.angularVelocity,this.m_linearDamping=t.linearDamping,this.m_angularDamping=t.angularDamping,this.m_force.Set(0,0),this.m_torque=0,this.m_sleepTime=0,this.m_type=t.type,this.m_type==_.b2_dynamicBody?(this.m_mass=1,this.m_invMass=1):(this.m_mass=0,this.m_invMass=0),this.m_I=0,this.m_invI=0,this.m_inertiaScale=t.inertiaScale,this.m_userData=t.userData,this.m_fixtureList=null,this.m_fixtureCount=0},_.prototype.SynchronizeFixtures=function(){var t=_.s_xf1;t.R.Set(this.m_sweep.a0);var e,i=t.R,n=this.m_sweep.localCenter;t.position.x=this.m_sweep.c0.x-(i.col1.x*n.x+i.col2.x*n.y),t.position.y=this.m_sweep.c0.y-(i.col1.y*n.x+i.col2.y*n.y);var o=this.m_world.m_contactManager.m_broadPhase;for(e=this.m_fixtureList;e;e=e.m_next)e.Synchronize(o,t,this.m_xf)},_.prototype.SynchronizeTransform=function(){this.m_xf.R.Set(this.m_sweep.a);var t=this.m_xf.R,e=this.m_sweep.localCenter;this.m_xf.position.x=this.m_sweep.c.x-(t.col1.x*e.x+t.col2.x*e.y),this.m_xf.position.y=this.m_sweep.c.y-(t.col1.y*e.x+t.col2.y*e.y)},_.prototype.ShouldCollide=function(t){if(this.m_type!=_.b2_dynamicBody&&t.m_type!=_.b2_dynamicBody)return!1;for(var e=this.m_jointList;e;e=e.next)if(e.other==t&&0==e.joint.m_collideConnected)return!1;return!0},_.prototype.Advance=function(t){void 0===t&&(t=0),this.m_sweep.Advance(t),this.m_sweep.c.SetV(this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.SynchronizeTransform()},bt.postDefs.push(function(){bt.Dynamics.b2Body.s_xf1=new i,bt.Dynamics.b2Body.e_islandFlag=1,bt.Dynamics.b2Body.e_awakeFlag=2,bt.Dynamics.b2Body.e_allowSleepFlag=4,bt.Dynamics.b2Body.e_bulletFlag=8,bt.Dynamics.b2Body.e_fixedRotationFlag=16,bt.Dynamics.b2Body.e_activeFlag=32,bt.Dynamics.b2Body.b2_staticBody=0,bt.Dynamics.b2Body.b2_kinematicBody=1,bt.Dynamics.b2Body.b2_dynamicBody=2}),d.b2BodyDef=function(){this.position=new n,this.linearVelocity=new n},d.prototype.b2BodyDef=function(){this.userData=null,this.position.Set(0,0),this.angle=0,this.linearVelocity.Set(0,0),this.angularVelocity=0,this.linearDamping=0,this.angularDamping=0,this.allowSleep=!0,this.awake=!0,this.fixedRotation=!1,this.bullet=!1,this.type=_.b2_staticBody,this.active=!0,this.inertiaScale=1},v.b2ContactFilter=function(){},v.prototype.ShouldCollide=function(t,e){var i=t.GetFilterData(),n=e.GetFilterData();return i.groupIndex==n.groupIndex&&0!=i.groupIndex?i.groupIndex>0:!!(i.maskBits&n.categoryBits)&&!!(i.categoryBits&n.maskBits)},v.prototype.RayCollide=function(t,e){return!t||this.ShouldCollide(t instanceof A?t:null,e)},bt.postDefs.push(function(){bt.Dynamics.b2ContactFilter.b2_defaultFilter=new v}),b.b2ContactImpulse=function(){this.normalImpulses=new Ct(s.b2_maxManifoldPoints),this.tangentImpulses=new Ct(s.b2_maxManifoldPoints)},g.b2ContactListener=function(){},g.prototype.BeginContact=function(t){},g.prototype.EndContact=function(t){},g.prototype.PreSolve=function(t,e){},g.prototype.PostSolve=function(t,e){},bt.postDefs.push(function(){bt.Dynamics.b2ContactListener.b2_defaultListener=new g}),x.b2ContactManager=function(){},x.prototype.b2ContactManager=function(){this.m_world=null,this.m_contactCount=0,this.m_contactFilter=v.b2_defaultFilter,this.m_contactListener=g.b2_defaultListener,this.m_contactFactory=new V(this.m_allocator),this.m_broadPhase=new l},x.prototype.AddPair=function(t,e){var i=t instanceof A?t:null,n=e instanceof A?e:null,o=i.GetBody(),s=n.GetBody();if(o!=s){for(var r=s.GetContactList();r;){if(r.other==o){var a=r.contact.GetFixtureA(),l=r.contact.GetFixtureB();if(a==i&&l==n)return;if(a==n&&l==i)return}r=r.next}if(0!=s.ShouldCollide(o)&&0!=this.m_contactFilter.ShouldCollide(i,n)){var h=this.m_contactFactory.Create(i,n);i=h.GetFixtureA(),n=h.GetFixtureB(),o=i.m_body,s=n.m_body,h.m_prev=null,h.m_next=this.m_world.m_contactList,null!=this.m_world.m_contactList&&(this.m_world.m_contactList.m_prev=h),this.m_world.m_contactList=h,h.m_nodeA.contact=h,h.m_nodeA.other=s,h.m_nodeA.prev=null,h.m_nodeA.next=o.m_contactList,null!=o.m_contactList&&(o.m_contactList.prev=h.m_nodeA),o.m_contactList=h.m_nodeA,h.m_nodeB.contact=h,h.m_nodeB.other=o,h.m_nodeB.prev=null,h.m_nodeB.next=s.m_contactList,null!=s.m_contactList&&(s.m_contactList.prev=h.m_nodeB),s.m_contactList=h.m_nodeB,++this.m_world.m_contactCount}}},x.prototype.FindNewContacts=function(){this.m_broadPhase.UpdatePairs(bt.generateCallback(this,this.AddPair))},x.prototype.Destroy=function(t){var e=t.GetFixtureA(),i=t.GetFixtureB(),n=e.GetBody(),o=i.GetBody();t.IsTouching()&&this.m_contactListener.EndContact(t),t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_world.m_contactList&&(this.m_world.m_contactList=t.m_next),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA==n.m_contactList&&(n.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB==o.m_contactList&&(o.m_contactList=t.m_nodeB.next),this.m_contactFactory.Destroy(t),--this.m_contactCount},x.prototype.Collide=function(){for(var t=this.m_world.m_contactList;t;){var e=t.GetFixtureA(),i=t.GetFixtureB(),n=e.GetBody(),o=i.GetBody();if(0!=n.IsAwake()||0!=o.IsAwake()){if(t.m_flags&I.e_filterFlag){if(0==o.ShouldCollide(n)){var s=t;t=s.GetNext(),this.Destroy(s);continue}if(0==this.m_contactFilter.ShouldCollide(e,i)){t=(s=t).GetNext(),this.Destroy(s);continue}t.m_flags&=~I.e_filterFlag}var r=e.m_proxy,a=i.m_proxy;0!=this.m_broadPhase.TestOverlap(r,a)?(t.Update(this.m_contactListener),t=t.GetNext()):(t=(s=t).GetNext(),this.Destroy(s))}else t=t.GetNext()}},bt.postDefs.push(function(){bt.Dynamics.b2ContactManager.s_evalCP=new a}),w.b2DebugDraw=function(){},w.prototype.b2DebugDraw=function(){},w.prototype.SetFlags=function(t){},w.prototype.GetFlags=function(){},w.prototype.AppendFlags=function(t){},w.prototype.ClearFlags=function(t){},w.prototype.SetSprite=function(t){},w.prototype.GetSprite=function(){},w.prototype.SetDrawScale=function(t){},w.prototype.GetDrawScale=function(){},w.prototype.SetLineThickness=function(t){},w.prototype.GetLineThickness=function(){},w.prototype.SetAlpha=function(t){},w.prototype.GetAlpha=function(){},w.prototype.SetFillAlpha=function(t){},w.prototype.GetFillAlpha=function(){},w.prototype.SetXFormScale=function(t){},w.prototype.GetXFormScale=function(){},w.prototype.DrawPolygon=function(t,e,i){},w.prototype.DrawSolidPolygon=function(t,e,i){},w.prototype.DrawCircle=function(t,e,i){},w.prototype.DrawSolidCircle=function(t,e,i,n){},w.prototype.DrawSegment=function(t,e,i){},w.prototype.DrawTransform=function(t){},bt.postDefs.push(function(){bt.Dynamics.b2DebugDraw.e_shapeBit=1,bt.Dynamics.b2DebugDraw.e_jointBit=2,bt.Dynamics.b2DebugDraw.e_aabbBit=4,bt.Dynamics.b2DebugDraw.e_pairBit=8,bt.Dynamics.b2DebugDraw.e_centerOfMassBit=16,bt.Dynamics.b2DebugDraw.e_controllerBit=32}),C.b2DestructionListener=function(){},C.prototype.SayGoodbyeJoint=function(t){},C.prototype.SayGoodbyeFixture=function(t){},S.b2FilterData=function(){this.categoryBits=1,this.maskBits=65535,this.groupIndex=0},S.prototype.Copy=function(){var t=new S;return t.categoryBits=this.categoryBits,t.maskBits=this.maskBits,t.groupIndex=this.groupIndex,t},A.b2Fixture=function(){this.m_filter=new S},A.prototype.GetType=function(){return this.m_shape.GetType()},A.prototype.GetShape=function(){return this.m_shape},A.prototype.SetSensor=function(t){if(this.m_isSensor!=t&&(this.m_isSensor=t,null!=this.m_body))for(var e=this.m_body.GetContactList();e;){var i=e.contact,n=i.GetFixtureA(),o=i.GetFixtureB();n!=this&&o!=this||i.SetSensor(n.IsSensor()||o.IsSensor()),e=e.next}},A.prototype.IsSensor=function(){return this.m_isSensor},A.prototype.SetFilterData=function(t){if(this.m_filter=t.Copy(),!this.m_body)for(var e=this.m_body.GetContactList();e;){var i=e.contact,n=i.GetFixtureA(),o=i.GetFixtureB();n!=this&&o!=this||i.FlagForFiltering(),e=e.next}},A.prototype.GetFilterData=function(){return this.m_filter.Copy()},A.prototype.GetBody=function(){return this.m_body},A.prototype.GetNext=function(){return this.m_next},A.prototype.GetUserData=function(){return this.m_userData},A.prototype.SetUserData=function(t){this.m_userData=t},A.prototype.TestPoint=function(t){return this.m_shape.TestPoint(this.m_body.GetTransform(),t)},A.prototype.RayCast=function(t,e){return this.m_shape.RayCast(t,e,this.m_body.GetTransform())},A.prototype.GetMassData=function(t){return void 0===t&&(t=null),null==t&&(t=new y),this.m_shape.ComputeMass(t,this.m_density),t},A.prototype.SetDensity=function(t){void 0===t&&(t=0),this.m_density=t},A.prototype.GetDensity=function(){return this.m_density},A.prototype.GetFriction=function(){return this.m_friction},A.prototype.SetFriction=function(t){void 0===t&&(t=0),this.m_friction=t},A.prototype.GetRestitution=function(){return this.m_restitution},A.prototype.SetRestitution=function(t){void 0===t&&(t=0),this.m_restitution=t},A.prototype.GetAABB=function(){return this.m_aabb},A.prototype.b2Fixture=function(){this.m_aabb=new r,this.m_userData=null,this.m_body=null,this.m_next=null,this.m_shape=null,this.m_density=0,this.m_friction=0,this.m_restitution=0},A.prototype.Create=function(t,e,i){this.m_userData=i.userData,this.m_friction=i.friction,this.m_restitution=i.restitution,this.m_body=t,this.m_next=null,this.m_filter=i.filter.Copy(),this.m_isSensor=i.isSensor,this.m_shape=i.shape.Copy(),this.m_density=i.density},A.prototype.Destroy=function(){this.m_shape=null},A.prototype.CreateProxy=function(t,e){this.m_shape.ComputeAABB(this.m_aabb,e),this.m_proxy=t.CreateProxy(this.m_aabb,this)},A.prototype.DestroyProxy=function(t){null!=this.m_proxy&&(t.DestroyProxy(this.m_proxy),this.m_proxy=null)},A.prototype.Synchronize=function(e,i,n){if(this.m_proxy){var o=new r,s=new r;this.m_shape.ComputeAABB(o,i),this.m_shape.ComputeAABB(s,n),this.m_aabb.Combine(o,s);var a=t.SubtractVV(n.position,i.position);e.MoveProxy(this.m_proxy,this.m_aabb,a)}},M.b2FixtureDef=function(){this.filter=new S},M.prototype.b2FixtureDef=function(){this.shape=null,this.userData=null,this.friction=.2,this.restitution=0,this.density=0,this.filter.categoryBits=1,this.filter.maskBits=65535,this.filter.groupIndex=0,this.isSensor=!1},D.b2Island=function(){},D.prototype.b2Island=function(){this.m_bodies=new wt,this.m_contacts=new wt,this.m_joints=new wt},D.prototype.Initialize=function(t,e,i,n,o,s){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0);var r=0;for(this.m_bodyCapacity=t,this.m_contactCapacity=e,this.m_jointCapacity=i,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_allocator=n,this.m_listener=o,this.m_contactSolver=s,r=this.m_bodies.length;r<t;r++)this.m_bodies[r]=null;for(r=this.m_contacts.length;r<e;r++)this.m_contacts[r]=null;for(r=this.m_joints.length;r<i;r++)this.m_joints[r]=null},D.prototype.Clear=function(){this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0},D.prototype.Solve=function(e,i,n){var o,r=0,a=0;for(r=0;r<this.m_bodyCount;++r)(o=this.m_bodies[r]).GetType()==_.b2_dynamicBody&&(o.m_linearVelocity.x+=e.dt*(i.x+o.m_invMass*o.m_force.x),o.m_linearVelocity.y+=e.dt*(i.y+o.m_invMass*o.m_force.y),o.m_angularVelocity+=e.dt*o.m_invI*o.m_torque,o.m_linearVelocity.Multiply(t.Clamp(1-e.dt*o.m_linearDamping,0,1)),o.m_angularVelocity*=t.Clamp(1-e.dt*o.m_angularDamping,0,1));this.m_contactSolver.Initialize(e,this.m_contacts,this.m_contactCount,this.m_allocator);var l=this.m_contactSolver;for(l.InitVelocityConstraints(e),r=0;r<this.m_jointCount;++r)this.m_joints[r].InitVelocityConstraints(e);for(r=0;r<e.velocityIterations;++r){for(a=0;a<this.m_jointCount;++a)this.m_joints[a].SolveVelocityConstraints(e);l.SolveVelocityConstraints()}for(r=0;r<this.m_jointCount;++r)this.m_joints[r].FinalizeVelocityConstraints();for(l.FinalizeVelocityConstraints(),r=0;r<this.m_bodyCount;++r)if((o=this.m_bodies[r]).GetType()!=_.b2_staticBody){var h=e.dt*o.m_linearVelocity.x,c=e.dt*o.m_linearVelocity.y;h*h+c*c>s.b2_maxTranslationSquared&&(o.m_linearVelocity.Normalize(),o.m_linearVelocity.x*=s.b2_maxTranslation*e.inv_dt,o.m_linearVelocity.y*=s.b2_maxTranslation*e.inv_dt);var m=e.dt*o.m_angularVelocity;m*m>s.b2_maxRotationSquared&&(o.m_angularVelocity<0?o.m_angularVelocity=-s.b2_maxRotation*e.inv_dt:o.m_angularVelocity=s.b2_maxRotation*e.inv_dt),o.m_sweep.c0.SetV(o.m_sweep.c),o.m_sweep.a0=o.m_sweep.a,o.m_sweep.c.x+=e.dt*o.m_linearVelocity.x,o.m_sweep.c.y+=e.dt*o.m_linearVelocity.y,o.m_sweep.a+=e.dt*o.m_angularVelocity,o.SynchronizeTransform()}for(r=0;r<e.positionIterations;++r){var u=l.SolvePositionConstraints(s.b2_contactBaumgarte),y=!0;for(a=0;a<this.m_jointCount;++a){var p=this.m_joints[a].SolvePositionConstraints(s.b2_contactBaumgarte);y=y&&p}if(u&&y)break}if(this.Report(l.m_constraints),n){var f=Number.MAX_VALUE,d=s.b2_linearSleepTolerance*s.b2_linearSleepTolerance,v=s.b2_angularSleepTolerance*s.b2_angularSleepTolerance;for(r=0;r<this.m_bodyCount;++r)(o=this.m_bodies[r]).GetType()!=_.b2_staticBody&&(o.m_flags&_.e_allowSleepFlag||(o.m_sleepTime=0,f=0),!(o.m_flags&_.e_allowSleepFlag)||o.m_angularVelocity*o.m_angularVelocity>v||t.Dot(o.m_linearVelocity,o.m_linearVelocity)>d?(o.m_sleepTime=0,f=0):(o.m_sleepTime+=e.dt,f=t.Min(f,o.m_sleepTime)));if(f>=s.b2_timeToSleep)for(r=0;r<this.m_bodyCount;++r)(o=this.m_bodies[r]).SetAwake(!1)}},D.prototype.SolveTOI=function(t){var e=0,i=0;this.m_contactSolver.Initialize(t,this.m_contacts,this.m_contactCount,this.m_allocator);var n=this.m_contactSolver;for(e=0;e<this.m_jointCount;++e)this.m_joints[e].InitVelocityConstraints(t);for(e=0;e<t.velocityIterations;++e)for(n.SolveVelocityConstraints(),i=0;i<this.m_jointCount;++i)this.m_joints[i].SolveVelocityConstraints(t);for(e=0;e<this.m_bodyCount;++e){var o=this.m_bodies[e];if(o.GetType()!=_.b2_staticBody){var r=t.dt*o.m_linearVelocity.x,a=t.dt*o.m_linearVelocity.y;r*r+a*a>s.b2_maxTranslationSquared&&(o.m_linearVelocity.Normalize(),o.m_linearVelocity.x*=s.b2_maxTranslation*t.inv_dt,o.m_linearVelocity.y*=s.b2_maxTranslation*t.inv_dt);var l=t.dt*o.m_angularVelocity;l*l>s.b2_maxRotationSquared&&(o.m_angularVelocity<0?o.m_angularVelocity=-s.b2_maxRotation*t.inv_dt:o.m_angularVelocity=s.b2_maxRotation*t.inv_dt),o.m_sweep.c0.SetV(o.m_sweep.c),o.m_sweep.a0=o.m_sweep.a,o.m_sweep.c.x+=t.dt*o.m_linearVelocity.x,o.m_sweep.c.y+=t.dt*o.m_linearVelocity.y,o.m_sweep.a+=t.dt*o.m_angularVelocity,o.SynchronizeTransform()}}for(e=0;e<t.positionIterations;++e){var h=n.SolvePositionConstraints(.75),c=!0;for(i=0;i<this.m_jointCount;++i){var m=this.m_joints[i].SolvePositionConstraints(s.b2_contactBaumgarte);c=c&&m}if(h&&c)break}this.Report(n.m_constraints)},D.prototype.Report=function(t){if(null!=this.m_listener)for(var e=0;e<this.m_contactCount;++e){for(var i=this.m_contacts[e],n=t[e],o=0;o<n.pointCount;++o)D.s_impulse.normalImpulses[o]=n.points[o].normalImpulse,D.s_impulse.tangentImpulses[o]=n.points[o].tangentImpulse;this.m_listener.PostSolve(i,D.s_impulse)}},D.prototype.AddBody=function(t){t.m_islandIndex=this.m_bodyCount,this.m_bodies[this.m_bodyCount++]=t},D.prototype.AddContact=function(t){this.m_contacts[this.m_contactCount++]=t},D.prototype.AddJoint=function(t){this.m_joints[this.m_jointCount++]=t},bt.postDefs.push(function(){bt.Dynamics.b2Island.s_impulse=new b}),k.b2TimeStep=function(){},k.prototype.Set=function(t){this.dt=t.dt,this.inv_dt=t.inv_dt,this.positionIterations=t.positionIterations,this.velocityIterations=t.velocityIterations,this.warmStarting=t.warmStarting},B.b2World=function(){this.s_stack=new wt,this.m_contactManager=new x,this.m_contactSolver=new P,this.m_island=new D},B.prototype.b2World=function(t,e){this.m_destructionListener=null,this.m_debugDraw=null,this.m_bodyList=null,this.m_contactList=null,this.m_jointList=null,this.m_controllerList=null,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_controllerCount=0,B.m_warmStarting=!0,B.m_continuousPhysics=!0,this.m_allowSleep=e,this.m_gravity=t,this.m_inv_dt0=0,this.m_contactManager.m_world=this;var i=new d;this.m_groundBody=this.CreateBody(i)},B.prototype.SetDestructionListener=function(t){this.m_destructionListener=t},B.prototype.SetContactFilter=function(t){this.m_contactManager.m_contactFilter=t},B.prototype.SetContactListener=function(t){this.m_contactManager.m_contactListener=t},B.prototype.SetDebugDraw=function(t){this.m_debugDraw=t},B.prototype.SetBroadPhase=function(t){var e=this.m_contactManager.m_broadPhase;this.m_contactManager.m_broadPhase=t;for(var i=this.m_bodyList;i;i=i.m_next)for(var n=i.m_fixtureList;n;n=n.m_next)n.m_proxy=t.CreateProxy(e.GetFatAABB(n.m_proxy),n)},B.prototype.Validate=function(){this.m_contactManager.m_broadPhase.Validate()},B.prototype.GetProxyCount=function(){return this.m_contactManager.m_broadPhase.GetProxyCount()},B.prototype.CreateBody=function(t){if(1==this.IsLocked())return null;var e=new _(t,this);return e.m_prev=null,e.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=e),this.m_bodyList=e,++this.m_bodyCount,e},B.prototype.DestroyBody=function(t){if(1!=this.IsLocked()){for(var e=t.m_jointList;e;){var i=e;e=e.next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeJoint(i.joint),this.DestroyJoint(i.joint)}for(var n=t.m_controllerList;n;){var o=n;n=n.nextController,o.controller.RemoveBody(t)}for(var s=t.m_contactList;s;){var r=s;s=s.next,this.m_contactManager.Destroy(r.contact)}t.m_contactList=null;for(var a=t.m_fixtureList;a;){var l=a;a=a.m_next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeFixture(l),l.DestroyProxy(this.m_contactManager.m_broadPhase),l.Destroy()}t.m_fixtureList=null,t.m_fixtureCount=0,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_bodyList&&(this.m_bodyList=t.m_next),--this.m_bodyCount}},B.prototype.CreateJoint=function(t){var e=T.Create(t,null);e.m_prev=null,e.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=e),this.m_jointList=e,++this.m_jointCount,e.m_edgeA.joint=e,e.m_edgeA.other=e.m_bodyB,e.m_edgeA.prev=null,e.m_edgeA.next=e.m_bodyA.m_jointList,e.m_bodyA.m_jointList&&(e.m_bodyA.m_jointList.prev=e.m_edgeA),e.m_bodyA.m_jointList=e.m_edgeA,e.m_edgeB.joint=e,e.m_edgeB.other=e.m_bodyA,e.m_edgeB.prev=null,e.m_edgeB.next=e.m_bodyB.m_jointList,e.m_bodyB.m_jointList&&(e.m_bodyB.m_jointList.prev=e.m_edgeB),e.m_bodyB.m_jointList=e.m_edgeB;var i=t.bodyA,n=t.bodyB;if(0==t.collideConnected)for(var o=n.GetContactList();o;)o.other==i&&o.contact.FlagForFiltering(),o=o.next;return e},B.prototype.DestroyJoint=function(t){var e=t.m_collideConnected;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_jointList&&(this.m_jointList=t.m_next);var i=t.m_bodyA,n=t.m_bodyB;if(i.SetAwake(!0),n.SetAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA==i.m_jointList&&(i.m_jointList=t.m_edgeA.next),t.m_edgeA.prev=null,t.m_edgeA.next=null,t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB==n.m_jointList&&(n.m_jointList=t.m_edgeB.next),t.m_edgeB.prev=null,t.m_edgeB.next=null,T.Destroy(t,null),--this.m_jointCount,0==e)for(var o=n.GetContactList();o;)o.other==i&&o.contact.FlagForFiltering(),o=o.next},B.prototype.AddController=function(t){return t.m_next=this.m_controllerList,t.m_prev=null,this.m_controllerList=t,t.m_world=this,this.m_controllerCount++,t},B.prototype.RemoveController=function(t){t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),this.m_controllerList==t&&(this.m_controllerList=t.m_next),this.m_controllerCount--},B.prototype.CreateController=function(t){if(t.m_world!=this)throw new Error("Controller can only be a member of one world");return t.m_next=this.m_controllerList,t.m_prev=null,this.m_controllerList&&(this.m_controllerList.m_prev=t),this.m_controllerList=t,++this.m_controllerCount,t.m_world=this,t},B.prototype.DestroyController=function(t){t.Clear(),t.m_next&&(t.m_next.m_prev=t.m_prev),t.m_prev&&(t.m_prev.m_next=t.m_next),t==this.m_controllerList&&(this.m_controllerList=t.m_next),--this.m_controllerCount},B.prototype.SetWarmStarting=function(t){B.m_warmStarting=t},B.prototype.SetContinuousPhysics=function(t){B.m_continuousPhysics=t},B.prototype.GetBodyCount=function(){return this.m_bodyCount},B.prototype.GetJointCount=function(){return this.m_jointCount},B.prototype.GetContactCount=function(){return this.m_contactCount},B.prototype.SetGravity=function(t){this.m_gravity=t},B.prototype.GetGravity=function(){return this.m_gravity},B.prototype.GetGroundBody=function(){return this.m_groundBody},B.prototype.Step=function(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.m_flags&B.e_newFixture&&(this.m_contactManager.FindNewContacts(),this.m_flags&=~B.e_newFixture),this.m_flags|=B.e_locked;var n=B.s_timestep2;n.dt=t,n.velocityIterations=e,n.positionIterations=i,n.inv_dt=t>0?1/t:0,n.dtRatio=this.m_inv_dt0*t,n.warmStarting=B.m_warmStarting,this.m_contactManager.Collide(),n.dt>0&&this.Solve(n),B.m_continuousPhysics&&n.dt>0&&this.SolveTOI(n),n.dt>0&&(this.m_inv_dt0=n.inv_dt),this.m_flags&=~B.e_locked},B.prototype.ClearForces=function(){for(var t=this.m_bodyList;t;t=t.m_next)t.m_force.SetZero(),t.m_torque=0},B.prototype.DrawDebugData=function(){if(null!=this.m_debugDraw){this.m_debugDraw.m_sprite.graphics.clear();var t,e,i,s,a,l,h=this.m_debugDraw.GetFlags();new n,new n,new n,new r,new r;var c=[new n,new n,new n,new n],m=new o(0,0,0);if(h&w.e_shapeBit)for(t=this.m_bodyList;t;t=t.m_next)for(l=t.m_xf,e=t.GetFixtureList();e;e=e.m_next)i=e.GetShape(),0==t.IsActive()?(m.Set(.5,.5,.3),this.DrawShape(i,l,m)):t.GetType()==_.b2_staticBody?(m.Set(.5,.9,.5),this.DrawShape(i,l,m)):t.GetType()==_.b2_kinematicBody?(m.Set(.5,.5,.9),this.DrawShape(i,l,m)):0==t.IsAwake()?(m.Set(.6,.6,.6),this.DrawShape(i,l,m)):(m.Set(.9,.7,.7),this.DrawShape(i,l,m));if(h&w.e_jointBit)for(s=this.m_jointList;s;s=s.m_next)this.DrawJoint(s);if(h&w.e_controllerBit)for(var u=this.m_controllerList;u;u=u.m_next)u.Draw(this.m_debugDraw);if(h&w.e_pairBit){m.Set(.3,.9,.9);for(var y=this.m_contactManager.m_contactList;y;y=y.GetNext()){var p=y.GetFixtureA(),f=y.GetFixtureB(),d=p.GetAABB().GetCenter(),v=f.GetAABB().GetCenter();this.m_debugDraw.DrawSegment(d,v,m)}}if(h&w.e_aabbBit)for(a=this.m_contactManager.m_broadPhase,c=[new n,new n,new n,new n],t=this.m_bodyList;t;t=t.GetNext())if(0!=t.IsActive())for(e=t.GetFixtureList();e;e=e.GetNext()){var b=a.GetFatAABB(e.m_proxy);c[0].Set(b.lowerBound.x,b.lowerBound.y),c[1].Set(b.upperBound.x,b.lowerBound.y),c[2].Set(b.upperBound.x,b.upperBound.y),c[3].Set(b.lowerBound.x,b.upperBound.y),this.m_debugDraw.DrawPolygon(c,4,m)}if(h&w.e_centerOfMassBit)for(t=this.m_bodyList;t;t=t.m_next)(l=B.s_xf).R=t.m_xf.R,l.position=t.GetWorldCenter(),this.m_debugDraw.DrawTransform(l)}},B.prototype.QueryAABB=function(t,e){var i=this.m_contactManager.m_broadPhase;i.Query(function(e){return t(i.GetUserData(e))},e)},B.prototype.QueryShape=function(t,e,n){void 0===n&&(n=null),null==n&&(n=new i).SetIdentity();var o=this.m_contactManager.m_broadPhase,s=new r;e.ComputeAABB(s,n),o.Query(function(i){var s=o.GetUserData(i)instanceof A?o.GetUserData(i):null;return!f.TestOverlap(e,n,s.GetShape(),s.GetBody().GetTransform())||t(s)},s)},B.prototype.QueryPoint=function(t,e){var i=this.m_contactManager.m_broadPhase,n=new r;n.lowerBound.Set(e.x-s.b2_linearSlop,e.y-s.b2_linearSlop),n.upperBound.Set(e.x+s.b2_linearSlop,e.y+s.b2_linearSlop),i.Query(function(n){var o=i.GetUserData(n)instanceof A?i.GetUserData(n):null;return!o.TestPoint(e)||t(o)},n)},B.prototype.RayCast=function(t,e,i){var o=this.m_contactManager.m_broadPhase,s=new c,r=new h(e,i);o.RayCast(function(r,a){var l=o.GetUserData(a),h=l instanceof A?l:null;if(h.RayCast(s,r)){var c=s.fraction,m=new n((1-c)*e.x+c*i.x,(1-c)*e.y+c*i.y);return t(h,m,s.normal,c)}return r.maxFraction},r)},B.prototype.RayCastOne=function(t,e){var i;return this.RayCast(function(t,e,n,o){return void 0===o&&(o=0),i=t,o},t,e),i},B.prototype.RayCastAll=function(t,e){var i=new wt;return this.RayCast(function(t,e,n,o){return i[i.length]=t,1},t,e),i},B.prototype.GetBodyList=function(){return this.m_bodyList},B.prototype.GetJointList=function(){return this.m_jointList},B.prototype.GetContactList=function(){return this.m_contactList},B.prototype.IsLocked=function(){return(this.m_flags&B.e_locked)>0},B.prototype.Solve=function(t){for(var e,i=this.m_controllerList;i;i=i.m_next)i.Step(t);var n=this.m_island;for(n.Initialize(this.m_bodyCount,this.m_contactCount,this.m_jointCount,null,this.m_contactManager.m_contactListener,this.m_contactSolver),e=this.m_bodyList;e;e=e.m_next)e.m_flags&=~_.e_islandFlag;for(var o=this.m_contactList;o;o=o.m_next)o.m_flags&=~I.e_islandFlag;for(var s=this.m_jointList;s;s=s.m_next)s.m_islandFlag=!1;parseInt(this.m_bodyCount);for(var r=this.s_stack,a=this.m_bodyList;a;a=a.m_next)if(!(a.m_flags&_.e_islandFlag)&&0!=a.IsAwake()&&0!=a.IsActive()&&a.GetType()!=_.b2_staticBody){n.Clear();var l=0;for(r[l++]=a,a.m_flags|=_.e_islandFlag;l>0;)if(e=r[--l],n.AddBody(e),0==e.IsAwake()&&e.SetAwake(!0),e.GetType()!=_.b2_staticBody){for(var h,c=e.m_contactList;c;c=c.next)c.contact.m_flags&I.e_islandFlag||1!=c.contact.IsSensor()&&0!=c.contact.IsEnabled()&&0!=c.contact.IsTouching()&&(n.AddContact(c.contact),c.contact.m_flags|=I.e_islandFlag,(h=c.other).m_flags&_.e_islandFlag||(r[l++]=h,h.m_flags|=_.e_islandFlag));for(var m=e.m_jointList;m;m=m.next)1!=m.joint.m_islandFlag&&0!=(h=m.other).IsActive()&&(n.AddJoint(m.joint),m.joint.m_islandFlag=!0,h.m_flags&_.e_islandFlag||(r[l++]=h,h.m_flags|=_.e_islandFlag))}n.Solve(t,this.m_gravity,this.m_allowSleep);for(var u=0;u<n.m_bodyCount;++u)(e=n.m_bodies[u]).GetType()==_.b2_staticBody&&(e.m_flags&=~_.e_islandFlag)}for(u=0;u<r.length&&r[u];++u)r[u]=null;for(e=this.m_bodyList;e;e=e.m_next)0!=e.IsAwake()&&0!=e.IsActive()&&e.GetType()!=_.b2_staticBody&&e.SynchronizeFixtures();this.m_contactManager.FindNewContacts()},B.prototype.SolveTOI=function(t){var e,i,n,o,r,a,l,h=this.m_island;h.Initialize(this.m_bodyCount,s.b2_maxTOIContactsPerIsland,s.b2_maxTOIJointsPerIsland,null,this.m_contactManager.m_contactListener,this.m_contactSolver);var c,m=B.s_queue;for(e=this.m_bodyList;e;e=e.m_next)e.m_flags&=~_.e_islandFlag,e.m_sweep.t0=0;for(c=this.m_contactList;c;c=c.m_next)c.m_flags&=~(I.e_toiFlag|I.e_islandFlag);for(l=this.m_jointList;l;l=l.m_next)l.m_islandFlag=!1;for(;;){var u=null,y=1;for(c=this.m_contactList;c;c=c.m_next)if(1!=c.IsSensor()&&0!=c.IsEnabled()&&0!=c.IsContinuous()){var p=1;if(c.m_flags&I.e_toiFlag)p=c.m_toi;else{if(i=c.m_fixtureA,n=c.m_fixtureB,o=i.m_body,r=n.m_body,!(o.GetType()==_.b2_dynamicBody&&0!=o.IsAwake()||r.GetType()==_.b2_dynamicBody&&0!=r.IsAwake()))continue;var f=o.m_sweep.t0;o.m_sweep.t0<r.m_sweep.t0?(f=r.m_sweep.t0,o.m_sweep.Advance(f)):r.m_sweep.t0<o.m_sweep.t0&&(f=o.m_sweep.t0,r.m_sweep.Advance(f)),p=c.ComputeTOI(o.m_sweep,r.m_sweep),s.b2Assert(0<=p&&p<=1),p>0&&p<1&&(p=(1-p)*f+p)>1&&(p=1),c.m_toi=p,c.m_flags|=I.e_toiFlag}Number.MIN_VALUE<p&&p<y&&(u=c,y=p)}if(null==u||1-100*Number.MIN_VALUE<y)break;if(i=u.m_fixtureA,n=u.m_fixtureB,o=i.m_body,r=n.m_body,B.s_backupA.Set(o.m_sweep),B.s_backupB.Set(r.m_sweep),o.Advance(y),r.Advance(y),u.Update(this.m_contactManager.m_contactListener),u.m_flags&=~I.e_toiFlag,1!=u.IsSensor()&&0!=u.IsEnabled()){if(0!=u.IsTouching()){var d=o;d.GetType()!=_.b2_dynamicBody&&(d=r),h.Clear();var v=0,b=0;for(m[v+b++]=d,d.m_flags|=_.e_islandFlag;b>0;)if(e=m[v++],--b,h.AddBody(e),0==e.IsAwake()&&e.SetAwake(!0),e.GetType()==_.b2_dynamicBody){for(a=e.m_contactList;a&&h.m_contactCount!=h.m_contactCapacity;a=a.next)if(!(a.contact.m_flags&I.e_islandFlag)&&1!=a.contact.IsSensor()&&0!=a.contact.IsEnabled()&&0!=a.contact.IsTouching()){h.AddContact(a.contact),a.contact.m_flags|=I.e_islandFlag;var g=a.other;g.m_flags&_.e_islandFlag||(g.GetType()!=_.b2_staticBody&&(g.Advance(y),g.SetAwake(!0)),m[v+b]=g,++b,g.m_flags|=_.e_islandFlag)}for(var x=e.m_jointList;x;x=x.next)h.m_jointCount!=h.m_jointCapacity&&1!=x.joint.m_islandFlag&&0!=(g=x.other).IsActive()&&(h.AddJoint(x.joint),x.joint.m_islandFlag=!0,g.m_flags&_.e_islandFlag||(g.GetType()!=_.b2_staticBody&&(g.Advance(y),g.SetAwake(!0)),m[v+b]=g,++b,g.m_flags|=_.e_islandFlag))}var w=B.s_timestep;w.warmStarting=!1,w.dt=(1-y)*t.dt,w.inv_dt=1/w.dt,w.dtRatio=0,w.velocityIterations=t.velocityIterations,w.positionIterations=t.positionIterations,h.SolveTOI(w);var C=0;for(C=0;C<h.m_bodyCount;++C)if((e=h.m_bodies[C]).m_flags&=~_.e_islandFlag,0!=e.IsAwake()&&e.GetType()==_.b2_dynamicBody)for(e.SynchronizeFixtures(),a=e.m_contactList;a;a=a.next)a.contact.m_flags&=~I.e_toiFlag;for(C=0;C<h.m_contactCount;++C)(c=h.m_contacts[C]).m_flags&=~(I.e_toiFlag|I.e_islandFlag);for(C=0;C<h.m_jointCount;++C)(l=h.m_joints[C]).m_islandFlag=!1;this.m_contactManager.FindNewContacts()}}else o.m_sweep.Set(B.s_backupA),r.m_sweep.Set(B.s_backupB),o.SynchronizeTransform(),r.SynchronizeTransform()}},B.prototype.DrawJoint=function(t){var e=t.GetBodyA(),i=t.GetBodyB(),n=e.m_xf,o=i.m_xf,s=n.position,r=o.position,a=t.GetAnchorA(),l=t.GetAnchorB(),h=B.s_jointColor;switch(t.m_type){case T.e_distanceJoint:this.m_debugDraw.DrawSegment(a,l,h);break;case T.e_pulleyJoint:var c=t instanceof L?t:null,m=c.GetGroundAnchorA(),u=c.GetGroundAnchorB();this.m_debugDraw.DrawSegment(m,a,h),this.m_debugDraw.DrawSegment(u,l,h),this.m_debugDraw.DrawSegment(m,u,h);break;case T.e_mouseJoint:this.m_debugDraw.DrawSegment(a,l,h);break;default:e!=this.m_groundBody&&this.m_debugDraw.DrawSegment(s,a,h),this.m_debugDraw.DrawSegment(a,l,h),i!=this.m_groundBody&&this.m_debugDraw.DrawSegment(r,l,h)}},B.prototype.DrawShape=function(e,i,n){switch(e.m_type){case f.e_circleShape:var o=e instanceof m?e:null,s=t.MulX(i,o.m_p),r=o.m_radius,a=i.R.col1;this.m_debugDraw.DrawSolidCircle(s,r,a,n);break;case f.e_polygonShape:var l=0,h=e instanceof p?e:null,c=parseInt(h.GetVertexCount()),y=h.GetVertices(),_=new wt(c);for(l=0;l<c;++l)_[l]=t.MulX(i,y[l]);this.m_debugDraw.DrawSolidPolygon(_,c,n);break;case f.e_edgeShape:var d=e instanceof u?e:null;this.m_debugDraw.DrawSegment(t.MulX(i,d.GetVertex1()),t.MulX(i,d.GetVertex2()),n)}},bt.postDefs.push(function(){bt.Dynamics.b2World.s_timestep2=new k,bt.Dynamics.b2World.s_xf=new i,bt.Dynamics.b2World.s_backupA=new e,bt.Dynamics.b2World.s_backupB=new e,bt.Dynamics.b2World.s_timestep=new k,bt.Dynamics.b2World.s_queue=new wt,bt.Dynamics.b2World.s_jointColor=new o(.5,.8,.8),bt.Dynamics.b2World.e_newFixture=1,bt.Dynamics.b2World.e_locked=2})}(),function(){var t=bt.Collision.Shapes.b2CircleShape;bt.Collision.Shapes.b2EdgeChainDef;var e=bt.Collision.Shapes.b2EdgeShape;bt.Collision.Shapes.b2MassData;var i=bt.Collision.Shapes.b2PolygonShape,n=bt.Collision.Shapes.b2Shape,o=bt.Dynamics.Contacts.b2CircleContact,s=bt.Dynamics.Contacts.b2Contact,r=bt.Dynamics.Contacts.b2ContactConstraint,a=bt.Dynamics.Contacts.b2ContactConstraintPoint,l=bt.Dynamics.Contacts.b2ContactEdge,h=bt.Dynamics.Contacts.b2ContactFactory,c=bt.Dynamics.Contacts.b2ContactRegister,m=bt.Dynamics.Contacts.b2ContactResult,u=bt.Dynamics.Contacts.b2ContactSolver,y=bt.Dynamics.Contacts.b2EdgeAndCircleContact,p=bt.Dynamics.Contacts.b2NullContact,f=bt.Dynamics.Contacts.b2PolyAndCircleContact,_=bt.Dynamics.Contacts.b2PolyAndEdgeContact,d=bt.Dynamics.Contacts.b2PolygonContact,v=bt.Dynamics.Contacts.b2PositionSolverManifold,b=bt.Dynamics.b2Body;bt.Dynamics.b2BodyDef,bt.Dynamics.b2ContactFilter,bt.Dynamics.b2ContactImpulse,bt.Dynamics.b2ContactListener,bt.Dynamics.b2ContactManager,bt.Dynamics.b2DebugDraw,bt.Dynamics.b2DestructionListener,bt.Dynamics.b2FilterData,bt.Dynamics.b2Fixture,bt.Dynamics.b2FixtureDef,bt.Dynamics.b2Island;var g=bt.Dynamics.b2TimeStep;bt.Dynamics.b2World,bt.Common.b2Color,bt.Common.b2internal;var x=bt.Common.b2Settings,w=bt.Common.Math.b2Mat22;bt.Common.Math.b2Mat33;var C=bt.Common.Math.b2Math;bt.Common.Math.b2Sweep,bt.Common.Math.b2Transform;var S=bt.Common.Math.b2Vec2;bt.Common.Math.b2Vec3,bt.Collision.b2AABB,bt.Collision.b2Bound,bt.Collision.b2BoundValues;var A=bt.Collision.b2Collision,M=bt.Collision.b2ContactID;bt.Collision.b2ContactPoint,bt.Collision.b2Distance,bt.Collision.b2DistanceInput,bt.Collision.b2DistanceOutput,bt.Collision.b2DistanceProxy,bt.Collision.b2DynamicTree,bt.Collision.b2DynamicTreeBroadPhase,bt.Collision.b2DynamicTreeNode,bt.Collision.b2DynamicTreePair;var D=bt.Collision.b2Manifold;bt.Collision.b2ManifoldPoint,bt.Collision.b2Point,bt.Collision.b2RayCastInput,bt.Collision.b2RayCastOutput,bt.Collision.b2Segment,bt.Collision.b2SeparationFunction,bt.Collision.b2Simplex,bt.Collision.b2SimplexCache,bt.Collision.b2SimplexVertex;var k=bt.Collision.b2TimeOfImpact,B=bt.Collision.b2TOIInput,I=bt.Collision.b2WorldManifold;bt.Collision.ClipVertex,bt.Collision.Features,bt.Collision.IBroadPhase,bt.inherit(o,bt.Dynamics.Contacts.b2Contact),o.prototype.__super=bt.Dynamics.Contacts.b2Contact.prototype,o.b2CircleContact=function(){bt.Dynamics.Contacts.b2Contact.b2Contact.apply(this,arguments)},o.Create=function(t){return new o},o.Destroy=function(t,e){},o.prototype.Reset=function(t,e){this.__super.Reset.call(this,t,e)},o.prototype.Evaluate=function(){var e=this.m_fixtureA.GetBody(),i=this.m_fixtureB.GetBody();A.CollideCircles(this.m_manifold,this.m_fixtureA.GetShape()instanceof t?this.m_fixtureA.GetShape():null,e.m_xf,this.m_fixtureB.GetShape()instanceof t?this.m_fixtureB.GetShape():null,i.m_xf)},s.b2Contact=function(){this.m_nodeA=new l,this.m_nodeB=new l,this.m_manifold=new D,this.m_oldManifold=new D},s.prototype.GetManifold=function(){return this.m_manifold},s.prototype.GetWorldManifold=function(t){var e=this.m_fixtureA.GetBody(),i=this.m_fixtureB.GetBody(),n=this.m_fixtureA.GetShape(),o=this.m_fixtureB.GetShape();t.Initialize(this.m_manifold,e.GetTransform(),n.m_radius,i.GetTransform(),o.m_radius)},s.prototype.IsTouching=function(){return(this.m_flags&s.e_touchingFlag)==s.e_touchingFlag},s.prototype.IsContinuous=function(){return(this.m_flags&s.e_continuousFlag)==s.e_continuousFlag},s.prototype.SetSensor=function(t){t?this.m_flags|=s.e_sensorFlag:this.m_flags&=~s.e_sensorFlag},s.prototype.IsSensor=function(){return(this.m_flags&s.e_sensorFlag)==s.e_sensorFlag},s.prototype.SetEnabled=function(t){t?this.m_flags|=s.e_enabledFlag:this.m_flags&=~s.e_enabledFlag},s.prototype.IsEnabled=function(){return(this.m_flags&s.e_enabledFlag)==s.e_enabledFlag},s.prototype.GetNext=function(){return this.m_next},s.prototype.GetFixtureA=function(){return this.m_fixtureA},s.prototype.GetFixtureB=function(){return this.m_fixtureB},s.prototype.FlagForFiltering=function(){this.m_flags|=s.e_filterFlag},s.prototype.b2Contact=function(){},s.prototype.Reset=function(t,e){if(void 0===t&&(t=null),void 0===e&&(e=null),this.m_flags=s.e_enabledFlag,!t||!e)return this.m_fixtureA=null,void(this.m_fixtureB=null);(t.IsSensor()||e.IsSensor())&&(this.m_flags|=s.e_sensorFlag);var i=t.GetBody(),n=e.GetBody();(i.GetType()!=b.b2_dynamicBody||i.IsBullet()||n.GetType()!=b.b2_dynamicBody||n.IsBullet())&&(this.m_flags|=s.e_continuousFlag),this.m_fixtureA=t,this.m_fixtureB=e,this.m_manifold.m_pointCount=0,this.m_prev=null,this.m_next=null,this.m_nodeA.contact=null,this.m_nodeA.prev=null,this.m_nodeA.next=null,this.m_nodeA.other=null,this.m_nodeB.contact=null,this.m_nodeB.prev=null,this.m_nodeB.next=null,this.m_nodeB.other=null},s.prototype.Update=function(t){var e=this.m_oldManifold;this.m_oldManifold=this.m_manifold,this.m_manifold=e,this.m_flags|=s.e_enabledFlag;var i=!1,o=(this.m_flags&s.e_touchingFlag)==s.e_touchingFlag,r=this.m_fixtureA.m_body,a=this.m_fixtureB.m_body,l=this.m_fixtureA.m_aabb.TestOverlap(this.m_fixtureB.m_aabb);if(this.m_flags&s.e_sensorFlag){if(l){var h=this.m_fixtureA.GetShape(),c=this.m_fixtureB.GetShape(),m=r.GetTransform(),u=a.GetTransform();i=n.TestOverlap(h,m,c,u)}this.m_manifold.m_pointCount=0}else{if(r.GetType()!=b.b2_dynamicBody||r.IsBullet()||a.GetType()!=b.b2_dynamicBody||a.IsBullet()?this.m_flags|=s.e_continuousFlag:this.m_flags&=~s.e_continuousFlag,l){this.Evaluate(),i=this.m_manifold.m_pointCount>0;for(var y=0;y<this.m_manifold.m_pointCount;++y){var p=this.m_manifold.m_points[y];p.m_normalImpulse=0,p.m_tangentImpulse=0;for(var f=p.m_id,_=0;_<this.m_oldManifold.m_pointCount;++_){var d=this.m_oldManifold.m_points[_];if(d.m_id.key==f.key){p.m_normalImpulse=d.m_normalImpulse,p.m_tangentImpulse=d.m_tangentImpulse;break}}}}else this.m_manifold.m_pointCount=0;i!=o&&(r.SetAwake(!0),a.SetAwake(!0))}i?this.m_flags|=s.e_touchingFlag:this.m_flags&=~s.e_touchingFlag,0==o&&1==i&&t.BeginContact(this),1==o&&0==i&&t.EndContact(this),this.m_flags&s.e_sensorFlag||t.PreSolve(this,this.m_oldManifold)},s.prototype.Evaluate=function(){},s.prototype.ComputeTOI=function(t,e){return s.s_input.proxyA.Set(this.m_fixtureA.GetShape()),s.s_input.proxyB.Set(this.m_fixtureB.GetShape()),s.s_input.sweepA=t,s.s_input.sweepB=e,s.s_input.tolerance=x.b2_linearSlop,k.TimeOfImpact(s.s_input)},bt.postDefs.push(function(){bt.Dynamics.Contacts.b2Contact.e_sensorFlag=1,bt.Dynamics.Contacts.b2Contact.e_continuousFlag=2,bt.Dynamics.Contacts.b2Contact.e_islandFlag=4,bt.Dynamics.Contacts.b2Contact.e_toiFlag=8,bt.Dynamics.Contacts.b2Contact.e_touchingFlag=16,bt.Dynamics.Contacts.b2Contact.e_enabledFlag=32,bt.Dynamics.Contacts.b2Contact.e_filterFlag=64,bt.Dynamics.Contacts.b2Contact.s_input=new B}),r.b2ContactConstraint=function(){this.localPlaneNormal=new S,this.localPoint=new S,this.normal=new S,this.normalMass=new w,this.K=new w},r.prototype.b2ContactConstraint=function(){this.points=new wt(x.b2_maxManifoldPoints);for(var t=0;t<x.b2_maxManifoldPoints;t++)this.points[t]=new a},a.b2ContactConstraintPoint=function(){this.localPoint=new S,this.rA=new S,this.rB=new S},l.b2ContactEdge=function(){},h.b2ContactFactory=function(){},h.prototype.b2ContactFactory=function(t){this.m_allocator=t,this.InitializeRegisters()},h.prototype.AddType=function(t,e,i,n){void 0===i&&(i=0),void 0===n&&(n=0),this.m_registers[i][n].createFcn=t,this.m_registers[i][n].destroyFcn=e,this.m_registers[i][n].primary=!0,i!=n&&(this.m_registers[n][i].createFcn=t,this.m_registers[n][i].destroyFcn=e,this.m_registers[n][i].primary=!1)},h.prototype.InitializeRegisters=function(){this.m_registers=new wt(n.e_shapeTypeCount);for(var t=0;t<n.e_shapeTypeCount;t++){this.m_registers[t]=new wt(n.e_shapeTypeCount);for(var e=0;e<n.e_shapeTypeCount;e++)this.m_registers[t][e]=new c}this.AddType(o.Create,o.Destroy,n.e_circleShape,n.e_circleShape),this.AddType(f.Create,f.Destroy,n.e_polygonShape,n.e_circleShape),this.AddType(d.Create,d.Destroy,n.e_polygonShape,n.e_polygonShape),this.AddType(y.Create,y.Destroy,n.e_edgeShape,n.e_circleShape),this.AddType(_.Create,_.Destroy,n.e_polygonShape,n.e_edgeShape)},h.prototype.Create=function(t,e){var i,n=parseInt(t.GetType()),o=parseInt(e.GetType()),s=this.m_registers[n][o];if(s.pool)return i=s.pool,s.pool=i.m_next,s.poolCount--,i.Reset(t,e),i;var r=s.createFcn;return null!=r?s.primary?((i=r(this.m_allocator)).Reset(t,e),i):((i=r(this.m_allocator)).Reset(e,t),i):null},h.prototype.Destroy=function(t){t.m_manifold.m_pointCount>0&&(t.m_fixtureA.m_body.SetAwake(!0),t.m_fixtureB.m_body.SetAwake(!0));var e=parseInt(t.m_fixtureA.GetType()),i=parseInt(t.m_fixtureB.GetType()),n=this.m_registers[e][i];n.poolCount++,t.m_next=n.pool,n.pool=t,(0,n.destroyFcn)(t,this.m_allocator)},c.b2ContactRegister=function(){},m.b2ContactResult=function(){this.position=new S,this.normal=new S,this.id=new M},u.b2ContactSolver=function(){this.m_step=new g,this.m_constraints=new wt},u.prototype.b2ContactSolver=function(){},u.prototype.Initialize=function(t,e,i,n){var o;void 0===i&&(i=0),this.m_step.Set(t),this.m_allocator=n;var s=0;for(this.m_constraintCount=i;this.m_constraints.length<this.m_constraintCount;)this.m_constraints[this.m_constraints.length]=new r;for(s=0;s<i;++s){var a=(o=e[s]).m_fixtureA,l=o.m_fixtureB,h=a.m_shape,c=l.m_shape,m=h.m_radius,y=c.m_radius,p=a.m_body,f=l.m_body,_=o.GetManifold(),d=x.b2MixFriction(a.GetFriction(),l.GetFriction()),v=x.b2MixRestitution(a.GetRestitution(),l.GetRestitution()),b=p.m_linearVelocity.x,g=p.m_linearVelocity.y,w=f.m_linearVelocity.x,C=f.m_linearVelocity.y,S=p.m_angularVelocity,A=f.m_angularVelocity;x.b2Assert(_.m_pointCount>0),u.s_worldManifold.Initialize(_,p.m_xf,m,f.m_xf,y);var M=u.s_worldManifold.m_normal.x,D=u.s_worldManifold.m_normal.y,k=this.m_constraints[s];k.bodyA=p,k.bodyB=f,k.manifold=_,k.normal.x=M,k.normal.y=D,k.pointCount=_.m_pointCount,k.friction=d,k.restitution=v,k.localPlaneNormal.x=_.m_localPlaneNormal.x,k.localPlaneNormal.y=_.m_localPlaneNormal.y,k.localPoint.x=_.m_localPoint.x,k.localPoint.y=_.m_localPoint.y,k.radius=m+y,k.type=_.m_type;for(var B=0;B<k.pointCount;++B){var I=_.m_points[B],V=k.points[B];V.normalImpulse=I.m_normalImpulse,V.tangentImpulse=I.m_tangentImpulse,V.localPoint.SetV(I.m_localPoint);var P=V.rA.x=u.s_worldManifold.m_points[B].x-p.m_sweep.c.x,T=V.rA.y=u.s_worldManifold.m_points[B].y-p.m_sweep.c.y,L=V.rB.x=u.s_worldManifold.m_points[B].x-f.m_sweep.c.x,G=V.rB.y=u.s_worldManifold.m_points[B].y-f.m_sweep.c.y,E=P*D-T*M,F=L*D-G*M;E*=E,F*=F;var R=p.m_invMass+f.m_invMass+p.m_invI*E+f.m_invI*F;V.normalMass=1/R;var O=p.m_mass*p.m_invMass+f.m_mass*f.m_invMass;O+=p.m_mass*p.m_invI*E+f.m_mass*f.m_invI*F,V.equalizedMass=1/O;var J=-M,z=P*J-T*D,j=L*J-G*D;z*=z,j*=j;var N=p.m_invMass+f.m_invMass+p.m_invI*z+f.m_invI*j;V.tangentMass=1/N,V.velocityBias=0;var X=w+-A*G-b- -S*T,W=C+A*L-g-S*P,Y=k.normal.x*X+k.normal.y*W;Y<-x.b2_velocityThreshold&&(V.velocityBias+=-k.restitution*Y)}if(2==k.pointCount){var q=k.points[0],U=k.points[1],K=p.m_invMass,Z=p.m_invI,H=f.m_invMass,Q=f.m_invI,$=q.rA.x*D-q.rA.y*M,tt=q.rB.x*D-q.rB.y*M,et=U.rA.x*D-U.rA.y*M,it=U.rB.x*D-U.rB.y*M,nt=K+H+Z*$*$+Q*tt*tt,ot=K+H+Z*et*et+Q*it*it,st=K+H+Z*$*et+Q*tt*it;nt*nt<100*(nt*ot-st*st)?(k.K.col1.Set(nt,st),k.K.col2.Set(st,ot),k.K.GetInverse(k.normalMass)):k.pointCount=1}}},u.prototype.InitVelocityConstraints=function(t){for(var e=0;e<this.m_constraintCount;++e){var i=this.m_constraints[e],n=i.bodyA,o=i.bodyB,s=n.m_invMass,r=n.m_invI,a=o.m_invMass,l=o.m_invI,h=i.normal.x,c=i.normal.y,m=c,u=-h,y=0,p=0;if(t.warmStarting)for(p=i.pointCount,y=0;y<p;++y){var f=i.points[y];f.normalImpulse*=t.dtRatio,f.tangentImpulse*=t.dtRatio;var _=f.normalImpulse*h+f.tangentImpulse*m,d=f.normalImpulse*c+f.tangentImpulse*u;n.m_angularVelocity-=r*(f.rA.x*d-f.rA.y*_),n.m_linearVelocity.x-=s*_,n.m_linearVelocity.y-=s*d,o.m_angularVelocity+=l*(f.rB.x*d-f.rB.y*_),o.m_linearVelocity.x+=a*_,o.m_linearVelocity.y+=a*d}else for(p=i.pointCount,y=0;y<p;++y){var v=i.points[y];v.normalImpulse=0,v.tangentImpulse=0}}},u.prototype.SolveVelocityConstraints=function(){for(var t,e,i=0,n=0,o=0,s=0,r=0,a=0,l=0,h=0,c=0,m=0,u=0,y=0,p=0,f=0,_=0;_<this.m_constraintCount;++_){var d=this.m_constraints[_],v=d.bodyA,b=d.bodyB,g=v.m_angularVelocity,x=b.m_angularVelocity,w=v.m_linearVelocity,S=b.m_linearVelocity,A=v.m_invMass,M=v.m_invI,D=b.m_invMass,k=b.m_invI,B=d.normal.x,I=d.normal.y,V=I,P=-B,T=d.friction;for(i=0;i<d.pointCount;i++)t=d.points[i],o=(S.x-x*t.rB.y-w.x+g*t.rA.y)*V+(S.y+x*t.rB.x-w.y-g*t.rA.x)*P,s=t.tangentMass*-o,r=T*t.normalImpulse,l=(s=(a=C.Clamp(t.tangentImpulse+s,-r,r))-t.tangentImpulse)*V,h=s*P,w.x-=A*l,w.y-=A*h,g-=M*(t.rA.x*h-t.rA.y*l),S.x+=D*l,S.y+=D*h,x+=k*(t.rB.x*h-t.rB.y*l),t.tangentImpulse=a;if(parseInt(d.pointCount),1==d.pointCount)t=d.points[0],n=(S.x+-x*t.rB.y-w.x- -g*t.rA.y)*B+(S.y+x*t.rB.x-w.y-g*t.rA.x)*I,s=-t.normalMass*(n-t.velocityBias),l=(s=(a=(a=t.normalImpulse+s)>0?a:0)-t.normalImpulse)*B,h=s*I,w.x-=A*l,w.y-=A*h,g-=M*(t.rA.x*h-t.rA.y*l),S.x+=D*l,S.y+=D*h,x+=k*(t.rB.x*h-t.rB.y*l),t.normalImpulse=a;else{var L=d.points[0],G=d.points[1],E=L.normalImpulse,F=G.normalImpulse,R=(S.x-x*L.rB.y-w.x+g*L.rA.y)*B+(S.y+x*L.rB.x-w.y-g*L.rA.x)*I,O=(S.x-x*G.rB.y-w.x+g*G.rA.y)*B+(S.y+x*G.rB.x-w.y-g*G.rA.x)*I,J=R-L.velocityBias,z=O-G.velocityBias;for(J-=(e=d.K).col1.x*E+e.col2.x*F,z-=e.col1.y*E+e.col2.y*F;;){var j=-((e=d.normalMass).col1.x*J+e.col2.x*z),N=-(e.col1.y*J+e.col2.y*z);if(j>=0&&N>=0){u=(c=j-E)*B,y=c*I,p=(m=N-F)*B,f=m*I,w.x-=A*(u+p),w.y-=A*(y+f),g-=M*(L.rA.x*y-L.rA.y*u+G.rA.x*f-G.rA.y*p),S.x+=D*(u+p),S.y+=D*(y+f),x+=k*(L.rB.x*y-L.rB.y*u+G.rB.x*f-G.rB.y*p),L.normalImpulse=j,G.normalImpulse=N;break}if(j=-L.normalMass*J,N=0,R=0,O=d.K.col1.y*j+z,j>=0&&O>=0){u=(c=j-E)*B,y=c*I,p=(m=N-F)*B,f=m*I,w.x-=A*(u+p),w.y-=A*(y+f),g-=M*(L.rA.x*y-L.rA.y*u+G.rA.x*f-G.rA.y*p),S.x+=D*(u+p),S.y+=D*(y+f),x+=k*(L.rB.x*y-L.rB.y*u+G.rB.x*f-G.rB.y*p),L.normalImpulse=j,G.normalImpulse=N;break}if(j=0,N=-G.normalMass*z,R=d.K.col2.x*N+J,O=0,N>=0&&R>=0){u=(c=j-E)*B,y=c*I,p=(m=N-F)*B,f=m*I,w.x-=A*(u+p),w.y-=A*(y+f),g-=M*(L.rA.x*y-L.rA.y*u+G.rA.x*f-G.rA.y*p),S.x+=D*(u+p),S.y+=D*(y+f),x+=k*(L.rB.x*y-L.rB.y*u+G.rB.x*f-G.rB.y*p),L.normalImpulse=j,G.normalImpulse=N;break}if(j=0,N=0,O=z,(R=J)>=0&&O>=0){u=(c=j-E)*B,y=c*I,p=(m=N-F)*B,f=m*I,w.x-=A*(u+p),w.y-=A*(y+f),g-=M*(L.rA.x*y-L.rA.y*u+G.rA.x*f-G.rA.y*p),S.x+=D*(u+p),S.y+=D*(y+f),x+=k*(L.rB.x*y-L.rB.y*u+G.rB.x*f-G.rB.y*p),L.normalImpulse=j,G.normalImpulse=N;break}break}}v.m_angularVelocity=g,b.m_angularVelocity=x}},u.prototype.FinalizeVelocityConstraints=function(){for(var t=0;t<this.m_constraintCount;++t)for(var e=this.m_constraints[t],i=e.manifold,n=0;n<e.pointCount;++n){var o=i.m_points[n],s=e.points[n];o.m_normalImpulse=s.normalImpulse,o.m_tangentImpulse=s.tangentImpulse}},u.prototype.SolvePositionConstraints=function(t){void 0===t&&(t=0);for(var e=0,i=0;i<this.m_constraintCount;i++){var n=this.m_constraints[i],o=n.bodyA,s=n.bodyB,r=o.m_mass*o.m_invMass,a=o.m_mass*o.m_invI,l=s.m_mass*s.m_invMass,h=s.m_mass*s.m_invI;u.s_psm.Initialize(n);for(var c=u.s_psm.m_normal,m=0;m<n.pointCount;m++){var y=n.points[m],p=u.s_psm.m_points[m],f=u.s_psm.m_separations[m],_=p.x-o.m_sweep.c.x,d=p.y-o.m_sweep.c.y,v=p.x-s.m_sweep.c.x,b=p.y-s.m_sweep.c.y;e=e<f?e:f;var g=C.Clamp(t*(f+x.b2_linearSlop),-x.b2_maxLinearCorrection,0),w=-y.equalizedMass*g,S=w*c.x,A=w*c.y;o.m_sweep.c.x-=r*S,o.m_sweep.c.y-=r*A,o.m_sweep.a-=a*(_*A-d*S),o.SynchronizeTransform(),s.m_sweep.c.x+=l*S,s.m_sweep.c.y+=l*A,s.m_sweep.a+=h*(v*A-b*S),s.SynchronizeTransform()}}return e>-1.5*x.b2_linearSlop},bt.postDefs.push(function(){bt.Dynamics.Contacts.b2ContactSolver.s_worldManifold=new I,bt.Dynamics.Contacts.b2ContactSolver.s_psm=new v}),bt.inherit(y,bt.Dynamics.Contacts.b2Contact),y.prototype.__super=bt.Dynamics.Contacts.b2Contact.prototype,y.b2EdgeAndCircleContact=function(){bt.Dynamics.Contacts.b2Contact.b2Contact.apply(this,arguments)},y.Create=function(t){return new y},y.Destroy=function(t,e){},y.prototype.Reset=function(t,e){this.__super.Reset.call(this,t,e)},y.prototype.Evaluate=function(){var i=this.m_fixtureA.GetBody(),n=this.m_fixtureB.GetBody();this.b2CollideEdgeAndCircle(this.m_manifold,this.m_fixtureA.GetShape()instanceof e?this.m_fixtureA.GetShape():null,i.m_xf,this.m_fixtureB.GetShape()instanceof t?this.m_fixtureB.GetShape():null,n.m_xf)},y.prototype.b2CollideEdgeAndCircle=function(t,e,i,n,o){},bt.inherit(p,bt.Dynamics.Contacts.b2Contact),p.prototype.__super=bt.Dynamics.Contacts.b2Contact.prototype,p.b2NullContact=function(){bt.Dynamics.Contacts.b2Contact.b2Contact.apply(this,arguments)},p.prototype.b2NullContact=function(){this.__super.b2Contact.call(this)},p.prototype.Evaluate=function(){},bt.inherit(f,bt.Dynamics.Contacts.b2Contact),f.prototype.__super=bt.Dynamics.Contacts.b2Contact.prototype,f.b2PolyAndCircleContact=function(){bt.Dynamics.Contacts.b2Contact.b2Contact.apply(this,arguments)},f.Create=function(t){return new f},f.Destroy=function(t,e){},f.prototype.Reset=function(t,e){this.__super.Reset.call(this,t,e),x.b2Assert(t.GetType()==n.e_polygonShape),x.b2Assert(e.GetType()==n.e_circleShape)},f.prototype.Evaluate=function(){var e=this.m_fixtureA.m_body,n=this.m_fixtureB.m_body;A.CollidePolygonAndCircle(this.m_manifold,this.m_fixtureA.GetShape()instanceof i?this.m_fixtureA.GetShape():null,e.m_xf,this.m_fixtureB.GetShape()instanceof t?this.m_fixtureB.GetShape():null,n.m_xf)},bt.inherit(_,bt.Dynamics.Contacts.b2Contact),_.prototype.__super=bt.Dynamics.Contacts.b2Contact.prototype,_.b2PolyAndEdgeContact=function(){bt.Dynamics.Contacts.b2Contact.b2Contact.apply(this,arguments)},_.Create=function(t){return new _},_.Destroy=function(t,e){},_.prototype.Reset=function(t,e){this.__super.Reset.call(this,t,e),x.b2Assert(t.GetType()==n.e_polygonShape),x.b2Assert(e.GetType()==n.e_edgeShape)},_.prototype.Evaluate=function(){var t=this.m_fixtureA.GetBody(),n=this.m_fixtureB.GetBody();this.b2CollidePolyAndEdge(this.m_manifold,this.m_fixtureA.GetShape()instanceof i?this.m_fixtureA.GetShape():null,t.m_xf,this.m_fixtureB.GetShape()instanceof e?this.m_fixtureB.GetShape():null,n.m_xf)},_.prototype.b2CollidePolyAndEdge=function(t,e,i,n,o){},bt.inherit(d,bt.Dynamics.Contacts.b2Contact),d.prototype.__super=bt.Dynamics.Contacts.b2Contact.prototype,d.b2PolygonContact=function(){bt.Dynamics.Contacts.b2Contact.b2Contact.apply(this,arguments)},d.Create=function(t){return new d},d.Destroy=function(t,e){},d.prototype.Reset=function(t,e){this.__super.Reset.call(this,t,e)},d.prototype.Evaluate=function(){var t=this.m_fixtureA.GetBody(),e=this.m_fixtureB.GetBody();A.CollidePolygons(this.m_manifold,this.m_fixtureA.GetShape()instanceof i?this.m_fixtureA.GetShape():null,t.m_xf,this.m_fixtureB.GetShape()instanceof i?this.m_fixtureB.GetShape():null,e.m_xf)},v.b2PositionSolverManifold=function(){},v.prototype.b2PositionSolverManifold=function(){this.m_normal=new S,this.m_separations=new Ct(x.b2_maxManifoldPoints),this.m_points=new wt(x.b2_maxManifoldPoints);for(var t=0;t<x.b2_maxManifoldPoints;t++)this.m_points[t]=new S},v.prototype.Initialize=function(t){x.b2Assert(t.pointCount>0);var e,i,n=0,o=0,s=0,r=0,a=0;switch(t.type){case D.e_circles:e=t.bodyA.m_xf.R,i=t.localPoint;var l=t.bodyA.m_xf.position.x+(e.col1.x*i.x+e.col2.x*i.y),h=t.bodyA.m_xf.position.y+(e.col1.y*i.x+e.col2.y*i.y);e=t.bodyB.m_xf.R,i=t.points[0].localPoint;var c=t.bodyB.m_xf.position.x+(e.col1.x*i.x+e.col2.x*i.y),m=t.bodyB.m_xf.position.y+(e.col1.y*i.x+e.col2.y*i.y),u=c-l,y=m-h,p=u*u+y*y;if(p>Number.MIN_VALUE*Number.MIN_VALUE){var f=Math.sqrt(p);this.m_normal.x=u/f,this.m_normal.y=y/f}else this.m_normal.x=1,this.m_normal.y=0;this.m_points[0].x=.5*(l+c),this.m_points[0].y=.5*(h+m),this.m_separations[0]=u*this.m_normal.x+y*this.m_normal.y-t.radius;break;case D.e_faceA:for(e=t.bodyA.m_xf.R,i=t.localPlaneNormal,this.m_normal.x=e.col1.x*i.x+e.col2.x*i.y,this.m_normal.y=e.col1.y*i.x+e.col2.y*i.y,e=t.bodyA.m_xf.R,i=t.localPoint,r=t.bodyA.m_xf.position.x+(e.col1.x*i.x+e.col2.x*i.y),a=t.bodyA.m_xf.position.y+(e.col1.y*i.x+e.col2.y*i.y),e=t.bodyB.m_xf.R,n=0;n<t.pointCount;++n)i=t.points[n].localPoint,o=t.bodyB.m_xf.position.x+(e.col1.x*i.x+e.col2.x*i.y),s=t.bodyB.m_xf.position.y+(e.col1.y*i.x+e.col2.y*i.y),this.m_separations[n]=(o-r)*this.m_normal.x+(s-a)*this.m_normal.y-t.radius,this.m_points[n].x=o,this.m_points[n].y=s;break;case D.e_faceB:for(e=t.bodyB.m_xf.R,i=t.localPlaneNormal,this.m_normal.x=e.col1.x*i.x+e.col2.x*i.y,this.m_normal.y=e.col1.y*i.x+e.col2.y*i.y,e=t.bodyB.m_xf.R,i=t.localPoint,r=t.bodyB.m_xf.position.x+(e.col1.x*i.x+e.col2.x*i.y),a=t.bodyB.m_xf.position.y+(e.col1.y*i.x+e.col2.y*i.y),e=t.bodyA.m_xf.R,n=0;n<t.pointCount;++n)i=t.points[n].localPoint,o=t.bodyA.m_xf.position.x+(e.col1.x*i.x+e.col2.x*i.y),s=t.bodyA.m_xf.position.y+(e.col1.y*i.x+e.col2.y*i.y),this.m_separations[n]=(o-r)*this.m_normal.x+(s-a)*this.m_normal.y-t.radius,this.m_points[n].Set(o,s);this.m_normal.x*=-1,this.m_normal.y*=-1}},bt.postDefs.push(function(){bt.Dynamics.Contacts.b2PositionSolverManifold.circlePointA=new S,bt.Dynamics.Contacts.b2PositionSolverManifold.circlePointB=new S})}(),function(){bt.Dynamics.b2Body,bt.Dynamics.b2BodyDef,bt.Dynamics.b2ContactFilter,bt.Dynamics.b2ContactImpulse,bt.Dynamics.b2ContactListener,bt.Dynamics.b2ContactManager,bt.Dynamics.b2DebugDraw,bt.Dynamics.b2DestructionListener,bt.Dynamics.b2FilterData,bt.Dynamics.b2Fixture,bt.Dynamics.b2FixtureDef,bt.Dynamics.b2Island,bt.Dynamics.b2TimeStep,bt.Dynamics.b2World;var t=bt.Common.Math.b2Mat22;bt.Common.Math.b2Mat33;var e=bt.Common.Math.b2Math;bt.Common.Math.b2Sweep,bt.Common.Math.b2Transform;var i=bt.Common.Math.b2Vec2;bt.Common.Math.b2Vec3;var n=bt.Common.b2Color;bt.Common.b2internal,bt.Common.b2Settings,bt.Collision.Shapes.b2CircleShape,bt.Collision.Shapes.b2EdgeChainDef,bt.Collision.Shapes.b2EdgeShape,bt.Collision.Shapes.b2MassData,bt.Collision.Shapes.b2PolygonShape,bt.Collision.Shapes.b2Shape;var o=bt.Dynamics.Controllers.b2BuoyancyController,s=bt.Dynamics.Controllers.b2ConstantAccelController,r=bt.Dynamics.Controllers.b2ConstantForceController,a=bt.Dynamics.Controllers.b2Controller,l=bt.Dynamics.Controllers.b2ControllerEdge,h=bt.Dynamics.Controllers.b2GravityController,c=bt.Dynamics.Controllers.b2TensorDampingController;bt.inherit(o,bt.Dynamics.Controllers.b2Controller),o.prototype.__super=bt.Dynamics.Controllers.b2Controller.prototype,o.b2BuoyancyController=function(){bt.Dynamics.Controllers.b2Controller.b2Controller.apply(this,arguments),this.normal=new i(0,-1),this.offset=0,this.density=0,this.velocity=new i(0,0),this.linearDrag=2,this.angularDrag=1,this.useDensity=!1,this.useWorldGravity=!0,this.gravity=null},o.prototype.Step=function(t){if(this.m_bodyList){this.useWorldGravity&&(this.gravity=this.GetWorld().GetGravity().Copy());for(var e=this.m_bodyList;e;e=e.nextBody){var n=e.body;if(0!=n.IsAwake()){for(var o=new i,s=new i,r=0,a=0,l=n.GetFixtureList();l;l=l.GetNext()){var h=new i,c=l.GetShape().ComputeSubmergedArea(this.normal,this.offset,n.GetTransform(),h);r+=c,o.x+=c*h.x,o.y+=c*h.y;var m=0;a+=c*(this.useDensity,m=1),s.x+=c*h.x*m,s.y+=c*h.y*m}if(o.x/=r,o.y/=r,s.x/=a,s.y/=a,!(r<Number.MIN_VALUE)){var u=this.gravity.GetNegative();u.Multiply(this.density*r),n.ApplyForce(u,s);var y=n.GetLinearVelocityFromWorldPoint(o);y.Subtract(this.velocity),y.Multiply(-this.linearDrag*r),n.ApplyForce(y,o),n.ApplyTorque(-n.GetInertia()/n.GetMass()*r*n.GetAngularVelocity()*this.angularDrag)}}}}},o.prototype.Draw=function(t){var e=1e3,o=new i,s=new i;o.x=this.normal.x*this.offset+this.normal.y*e,o.y=this.normal.y*this.offset-this.normal.x*e,s.x=this.normal.x*this.offset-this.normal.y*e,s.y=this.normal.y*this.offset+this.normal.x*e;var r=new n(0,0,1);t.DrawSegment(o,s,r)},bt.inherit(s,bt.Dynamics.Controllers.b2Controller),s.prototype.__super=bt.Dynamics.Controllers.b2Controller.prototype,s.b2ConstantAccelController=function(){bt.Dynamics.Controllers.b2Controller.b2Controller.apply(this,arguments),this.A=new i(0,0)},s.prototype.Step=function(t){for(var e=new i(this.A.x*t.dt,this.A.y*t.dt),n=this.m_bodyList;n;n=n.nextBody){var o=n.body;o.IsAwake()&&o.SetLinearVelocity(new i(o.GetLinearVelocity().x+e.x,o.GetLinearVelocity().y+e.y))}},bt.inherit(r,bt.Dynamics.Controllers.b2Controller),r.prototype.__super=bt.Dynamics.Controllers.b2Controller.prototype,r.b2ConstantForceController=function(){bt.Dynamics.Controllers.b2Controller.b2Controller.apply(this,arguments),this.F=new i(0,0)},r.prototype.Step=function(t){for(var e=this.m_bodyList;e;e=e.nextBody){var i=e.body;i.IsAwake()&&i.ApplyForce(this.F,i.GetWorldCenter())}},a.b2Controller=function(){},a.prototype.Step=function(t){},a.prototype.Draw=function(t){},a.prototype.AddBody=function(t){var e=new l;e.controller=this,e.body=t,e.nextBody=this.m_bodyList,e.prevBody=null,this.m_bodyList=e,e.nextBody&&(e.nextBody.prevBody=e),this.m_bodyCount++,e.nextController=t.m_controllerList,e.prevController=null,t.m_controllerList=e,e.nextController&&(e.nextController.prevController=e),t.m_controllerCount++},a.prototype.RemoveBody=function(t){for(var e=t.m_controllerList;e&&e.controller!=this;)e=e.nextController;e.prevBody&&(e.prevBody.nextBody=e.nextBody),e.nextBody&&(e.nextBody.prevBody=e.prevBody),e.nextController&&(e.nextController.prevController=e.prevController),e.prevController&&(e.prevController.nextController=e.nextController),this.m_bodyList==e&&(this.m_bodyList=e.nextBody),t.m_controllerList==e&&(t.m_controllerList=e.nextController),t.m_controllerCount--,this.m_bodyCount--},a.prototype.Clear=function(){for(;this.m_bodyList;)this.RemoveBody(this.m_bodyList.body)},a.prototype.GetNext=function(){return this.m_next},a.prototype.GetWorld=function(){return this.m_world},a.prototype.GetBodyList=function(){return this.m_bodyList},l.b2ControllerEdge=function(){},bt.inherit(h,bt.Dynamics.Controllers.b2Controller),h.prototype.__super=bt.Dynamics.Controllers.b2Controller.prototype,h.b2GravityController=function(){bt.Dynamics.Controllers.b2Controller.b2Controller.apply(this,arguments),this.G=1,this.invSqr=!0},h.prototype.Step=function(t){var e=null,n=null,o=null,s=0,r=null,a=null,l=null,h=0,c=0,m=0,u=null;if(this.invSqr)for(e=this.m_bodyList;e;e=e.nextBody)for(o=(n=e.body).GetWorldCenter(),s=n.GetMass(),r=this.m_bodyList;r!=e;r=r.nextBody)(m=(h=(l=(a=r.body).GetWorldCenter()).x-o.x)*h+(c=l.y-o.y)*c)<Number.MIN_VALUE||((u=new i(h,c)).Multiply(this.G/m/Math.sqrt(m)*s*a.GetMass()),n.IsAwake()&&n.ApplyForce(u,o),u.Multiply(-1),a.IsAwake()&&a.ApplyForce(u,l));else for(e=this.m_bodyList;e;e=e.nextBody)for(o=(n=e.body).GetWorldCenter(),s=n.GetMass(),r=this.m_bodyList;r!=e;r=r.nextBody)(m=(h=(l=(a=r.body).GetWorldCenter()).x-o.x)*h+(c=l.y-o.y)*c)<Number.MIN_VALUE||((u=new i(h,c)).Multiply(this.G/m*s*a.GetMass()),n.IsAwake()&&n.ApplyForce(u,o),u.Multiply(-1),a.IsAwake()&&a.ApplyForce(u,l))},bt.inherit(c,bt.Dynamics.Controllers.b2Controller),c.prototype.__super=bt.Dynamics.Controllers.b2Controller.prototype,c.b2TensorDampingController=function(){bt.Dynamics.Controllers.b2Controller.b2Controller.apply(this,arguments),this.T=new t,this.maxTimestep=0},c.prototype.SetAxisAligned=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.T.col1.x=-t,this.T.col1.y=0,this.T.col2.x=0,this.T.col2.y=-e,this.maxTimestep=t>0||e>0?1/Math.max(t,e):0},c.prototype.Step=function(t){var n=t.dt;if(!(n<=Number.MIN_VALUE)){n>this.maxTimestep&&this.maxTimestep>0&&(n=this.maxTimestep);for(var o=this.m_bodyList;o;o=o.nextBody){var s=o.body;if(s.IsAwake()){var r=s.GetWorldVector(e.MulMV(this.T,s.GetLocalVector(s.GetLinearVelocity())));s.SetLinearVelocity(new i(s.GetLinearVelocity().x+r.x*n,s.GetLinearVelocity().y+r.y*n))}}}}}(),function(){bt.Common.b2Color,bt.Common.b2internal;var t=bt.Common.b2Settings,e=bt.Common.Math.b2Mat22,i=bt.Common.Math.b2Mat33,n=bt.Common.Math.b2Math;bt.Common.Math.b2Sweep,bt.Common.Math.b2Transform;var o=bt.Common.Math.b2Vec2,s=bt.Common.Math.b2Vec3,r=bt.Dynamics.Joints.b2DistanceJoint,a=bt.Dynamics.Joints.b2DistanceJointDef,l=bt.Dynamics.Joints.b2FrictionJoint,h=bt.Dynamics.Joints.b2FrictionJointDef,c=bt.Dynamics.Joints.b2GearJoint,m=bt.Dynamics.Joints.b2GearJointDef,u=bt.Dynamics.Joints.b2Jacobian,y=bt.Dynamics.Joints.b2Joint,p=bt.Dynamics.Joints.b2JointDef,f=bt.Dynamics.Joints.b2JointEdge,_=bt.Dynamics.Joints.b2LineJoint,d=bt.Dynamics.Joints.b2LineJointDef,v=bt.Dynamics.Joints.b2MouseJoint,b=bt.Dynamics.Joints.b2MouseJointDef,g=bt.Dynamics.Joints.b2PrismaticJoint,x=bt.Dynamics.Joints.b2PrismaticJointDef,w=bt.Dynamics.Joints.b2PulleyJoint,C=bt.Dynamics.Joints.b2PulleyJointDef,S=bt.Dynamics.Joints.b2RevoluteJoint,A=bt.Dynamics.Joints.b2RevoluteJointDef,M=bt.Dynamics.Joints.b2WeldJoint,D=bt.Dynamics.Joints.b2WeldJointDef;bt.Dynamics.b2Body,bt.Dynamics.b2BodyDef,bt.Dynamics.b2ContactFilter,bt.Dynamics.b2ContactImpulse,bt.Dynamics.b2ContactListener,bt.Dynamics.b2ContactManager,bt.Dynamics.b2DebugDraw,bt.Dynamics.b2DestructionListener,bt.Dynamics.b2FilterData,bt.Dynamics.b2Fixture,bt.Dynamics.b2FixtureDef,bt.Dynamics.b2Island,bt.Dynamics.b2TimeStep,bt.Dynamics.b2World,bt.inherit(r,bt.Dynamics.Joints.b2Joint),r.prototype.__super=bt.Dynamics.Joints.b2Joint.prototype,r.b2DistanceJoint=function(){bt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_localAnchor1=new o,this.m_localAnchor2=new o,this.m_u=new o},r.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},r.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},r.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new o(t*this.m_impulse*this.m_u.x,t*this.m_impulse*this.m_u.y)},r.prototype.GetReactionTorque=function(t){return 0},r.prototype.GetLength=function(){return this.m_length},r.prototype.SetLength=function(t){void 0===t&&(t=0),this.m_length=t},r.prototype.GetFrequency=function(){return this.m_frequencyHz},r.prototype.SetFrequency=function(t){void 0===t&&(t=0),this.m_frequencyHz=t},r.prototype.GetDampingRatio=function(){return this.m_dampingRatio},r.prototype.SetDampingRatio=function(t){void 0===t&&(t=0),this.m_dampingRatio=t},r.prototype.b2DistanceJoint=function(t){this.__super.b2Joint.call(this,t),this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_length=t.length,this.m_frequencyHz=t.frequencyHz,this.m_dampingRatio=t.dampingRatio,this.m_impulse=0,this.m_gamma=0,this.m_bias=0},r.prototype.InitVelocityConstraints=function(e){var i,n=0,o=this.m_bodyA,s=this.m_bodyB;i=o.m_xf.R;var r=this.m_localAnchor1.x-o.m_sweep.localCenter.x,a=this.m_localAnchor1.y-o.m_sweep.localCenter.y;n=i.col1.x*r+i.col2.x*a,a=i.col1.y*r+i.col2.y*a,r=n,i=s.m_xf.R;var l=this.m_localAnchor2.x-s.m_sweep.localCenter.x,h=this.m_localAnchor2.y-s.m_sweep.localCenter.y;n=i.col1.x*l+i.col2.x*h,h=i.col1.y*l+i.col2.y*h,l=n,this.m_u.x=s.m_sweep.c.x+l-o.m_sweep.c.x-r,this.m_u.y=s.m_sweep.c.y+h-o.m_sweep.c.y-a;var c=Math.sqrt(this.m_u.x*this.m_u.x+this.m_u.y*this.m_u.y);c>t.b2_linearSlop?this.m_u.Multiply(1/c):this.m_u.SetZero();var m=r*this.m_u.y-a*this.m_u.x,u=l*this.m_u.y-h*this.m_u.x,y=o.m_invMass+o.m_invI*m*m+s.m_invMass+s.m_invI*u*u;if(this.m_mass=0!=y?1/y:0,this.m_frequencyHz>0){var p=c-this.m_length,f=2*Math.PI*this.m_frequencyHz,_=2*this.m_mass*this.m_dampingRatio*f,d=this.m_mass*f*f;this.m_gamma=e.dt*(_+e.dt*d),this.m_gamma=0!=this.m_gamma?1/this.m_gamma:0,this.m_bias=p*e.dt*d*this.m_gamma,this.m_mass=y+this.m_gamma,this.m_mass=0!=this.m_mass?1/this.m_mass:0}if(e.warmStarting){this.m_impulse*=e.dtRatio;var v=this.m_impulse*this.m_u.x,b=this.m_impulse*this.m_u.y;o.m_linearVelocity.x-=o.m_invMass*v,o.m_linearVelocity.y-=o.m_invMass*b,o.m_angularVelocity-=o.m_invI*(r*b-a*v),s.m_linearVelocity.x+=s.m_invMass*v,s.m_linearVelocity.y+=s.m_invMass*b,s.m_angularVelocity+=s.m_invI*(l*b-h*v)}else this.m_impulse=0},r.prototype.SolveVelocityConstraints=function(t){var e,i=this.m_bodyA,n=this.m_bodyB;e=i.m_xf.R;var o=this.m_localAnchor1.x-i.m_sweep.localCenter.x,s=this.m_localAnchor1.y-i.m_sweep.localCenter.y,r=e.col1.x*o+e.col2.x*s;s=e.col1.y*o+e.col2.y*s,o=r,e=n.m_xf.R;var a=this.m_localAnchor2.x-n.m_sweep.localCenter.x,l=this.m_localAnchor2.y-n.m_sweep.localCenter.y;r=e.col1.x*a+e.col2.x*l,l=e.col1.y*a+e.col2.y*l,a=r;var h=i.m_linearVelocity.x+-i.m_angularVelocity*s,c=i.m_linearVelocity.y+i.m_angularVelocity*o,m=n.m_linearVelocity.x+-n.m_angularVelocity*l,u=n.m_linearVelocity.y+n.m_angularVelocity*a,y=this.m_u.x*(m-h)+this.m_u.y*(u-c),p=-this.m_mass*(y+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=p;var f=p*this.m_u.x,_=p*this.m_u.y;i.m_linearVelocity.x-=i.m_invMass*f,i.m_linearVelocity.y-=i.m_invMass*_,i.m_angularVelocity-=i.m_invI*(o*_-s*f),n.m_linearVelocity.x+=n.m_invMass*f,n.m_linearVelocity.y+=n.m_invMass*_,n.m_angularVelocity+=n.m_invI*(a*_-l*f)},r.prototype.SolvePositionConstraints=function(e){var i;if(this.m_frequencyHz>0)return!0;var o=this.m_bodyA,s=this.m_bodyB;i=o.m_xf.R;var r=this.m_localAnchor1.x-o.m_sweep.localCenter.x,a=this.m_localAnchor1.y-o.m_sweep.localCenter.y,l=i.col1.x*r+i.col2.x*a;a=i.col1.y*r+i.col2.y*a,r=l,i=s.m_xf.R;var h=this.m_localAnchor2.x-s.m_sweep.localCenter.x,c=this.m_localAnchor2.y-s.m_sweep.localCenter.y;l=i.col1.x*h+i.col2.x*c,c=i.col1.y*h+i.col2.y*c,h=l;var m=s.m_sweep.c.x+h-o.m_sweep.c.x-r,u=s.m_sweep.c.y+c-o.m_sweep.c.y-a,y=Math.sqrt(m*m+u*u);m/=y,u/=y;var p=y-this.m_length;p=n.Clamp(p,-t.b2_maxLinearCorrection,t.b2_maxLinearCorrection);var f=-this.m_mass*p;this.m_u.Set(m,u);var _=f*this.m_u.x,d=f*this.m_u.y;return o.m_sweep.c.x-=o.m_invMass*_,o.m_sweep.c.y-=o.m_invMass*d,o.m_sweep.a-=o.m_invI*(r*d-a*_),s.m_sweep.c.x+=s.m_invMass*_,s.m_sweep.c.y+=s.m_invMass*d,s.m_sweep.a+=s.m_invI*(h*d-c*_),o.SynchronizeTransform(),s.SynchronizeTransform(),n.Abs(p)<t.b2_linearSlop},bt.inherit(a,bt.Dynamics.Joints.b2JointDef),a.prototype.__super=bt.Dynamics.Joints.b2JointDef.prototype,a.b2DistanceJointDef=function(){bt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.localAnchorA=new o,this.localAnchorB=new o},a.prototype.b2DistanceJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_distanceJoint,this.length=1,this.frequencyHz=0,this.dampingRatio=0},a.prototype.Initialize=function(t,e,i,n){this.bodyA=t,this.bodyB=e,this.localAnchorA.SetV(this.bodyA.GetLocalPoint(i)),this.localAnchorB.SetV(this.bodyB.GetLocalPoint(n));var o=n.x-i.x,s=n.y-i.y;this.length=Math.sqrt(o*o+s*s),this.frequencyHz=0,this.dampingRatio=0},bt.inherit(l,bt.Dynamics.Joints.b2Joint),l.prototype.__super=bt.Dynamics.Joints.b2Joint.prototype,l.b2FrictionJoint=function(){bt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_localAnchorA=new o,this.m_localAnchorB=new o,this.m_linearMass=new e,this.m_linearImpulse=new o},l.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA)},l.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB)},l.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new o(t*this.m_linearImpulse.x,t*this.m_linearImpulse.y)},l.prototype.GetReactionTorque=function(t){return void 0===t&&(t=0),t*this.m_angularImpulse},l.prototype.SetMaxForce=function(t){void 0===t&&(t=0),this.m_maxForce=t},l.prototype.GetMaxForce=function(){return this.m_maxForce},l.prototype.SetMaxTorque=function(t){void 0===t&&(t=0),this.m_maxTorque=t},l.prototype.GetMaxTorque=function(){return this.m_maxTorque},l.prototype.b2FrictionJoint=function(t){this.__super.b2Joint.call(this,t),this.m_localAnchorA.SetV(t.localAnchorA),this.m_localAnchorB.SetV(t.localAnchorB),this.m_linearMass.SetZero(),this.m_angularMass=0,this.m_linearImpulse.SetZero(),this.m_angularImpulse=0,this.m_maxForce=t.maxForce,this.m_maxTorque=t.maxTorque},l.prototype.InitVelocityConstraints=function(t){var i,n=0,o=this.m_bodyA,s=this.m_bodyB;i=o.m_xf.R;var r=this.m_localAnchorA.x-o.m_sweep.localCenter.x,a=this.m_localAnchorA.y-o.m_sweep.localCenter.y;n=i.col1.x*r+i.col2.x*a,a=i.col1.y*r+i.col2.y*a,r=n,i=s.m_xf.R;var l=this.m_localAnchorB.x-s.m_sweep.localCenter.x,h=this.m_localAnchorB.y-s.m_sweep.localCenter.y;n=i.col1.x*l+i.col2.x*h,h=i.col1.y*l+i.col2.y*h,l=n;var c=o.m_invMass,m=s.m_invMass,u=o.m_invI,y=s.m_invI,p=new e;if(p.col1.x=c+m,p.col2.x=0,p.col1.y=0,p.col2.y=c+m,p.col1.x+=u*a*a,p.col2.x+=-u*r*a,p.col1.y+=-u*r*a,p.col2.y+=u*r*r,p.col1.x+=y*h*h,p.col2.x+=-y*l*h,p.col1.y+=-y*l*h,p.col2.y+=y*l*l,p.GetInverse(this.m_linearMass),this.m_angularMass=u+y,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),t.warmStarting){this.m_linearImpulse.x*=t.dtRatio,this.m_linearImpulse.y*=t.dtRatio,this.m_angularImpulse*=t.dtRatio;var f=this.m_linearImpulse;o.m_linearVelocity.x-=c*f.x,o.m_linearVelocity.y-=c*f.y,o.m_angularVelocity-=u*(r*f.y-a*f.x+this.m_angularImpulse),s.m_linearVelocity.x+=m*f.x,s.m_linearVelocity.y+=m*f.y,s.m_angularVelocity+=y*(l*f.y-h*f.x+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0},l.prototype.SolveVelocityConstraints=function(t){var e,i=0,s=this.m_bodyA,r=this.m_bodyB,a=s.m_linearVelocity,l=s.m_angularVelocity,h=r.m_linearVelocity,c=r.m_angularVelocity,m=s.m_invMass,u=r.m_invMass,y=s.m_invI,p=r.m_invI;e=s.m_xf.R;var f=this.m_localAnchorA.x-s.m_sweep.localCenter.x,_=this.m_localAnchorA.y-s.m_sweep.localCenter.y;i=e.col1.x*f+e.col2.x*_,_=e.col1.y*f+e.col2.y*_,f=i,e=r.m_xf.R;var d=this.m_localAnchorB.x-r.m_sweep.localCenter.x,v=this.m_localAnchorB.y-r.m_sweep.localCenter.y;i=e.col1.x*d+e.col2.x*v,v=e.col1.y*d+e.col2.y*v,d=i;var b=0,g=c-l,x=-this.m_angularMass*g,w=this.m_angularImpulse;b=t.dt*this.m_maxTorque,this.m_angularImpulse=n.Clamp(this.m_angularImpulse+x,-b,b),l-=y*(x=this.m_angularImpulse-w),c+=p*x;var C=h.x-c*v-a.x+l*_,S=h.y+c*d-a.y-l*f,A=n.MulMV(this.m_linearMass,new o(-C,-S)),M=this.m_linearImpulse.Copy();this.m_linearImpulse.Add(A),b=t.dt*this.m_maxForce,this.m_linearImpulse.LengthSquared()>b*b&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.Multiply(b)),A=n.SubtractVV(this.m_linearImpulse,M),a.x-=m*A.x,a.y-=m*A.y,l-=y*(f*A.y-_*A.x),h.x+=u*A.x,h.y+=u*A.y,c+=p*(d*A.y-v*A.x),s.m_angularVelocity=l,r.m_angularVelocity=c},l.prototype.SolvePositionConstraints=function(t){return!0},bt.inherit(h,bt.Dynamics.Joints.b2JointDef),h.prototype.__super=bt.Dynamics.Joints.b2JointDef.prototype,h.b2FrictionJointDef=function(){bt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.localAnchorA=new o,this.localAnchorB=new o},h.prototype.b2FrictionJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_frictionJoint,this.maxForce=0,this.maxTorque=0},h.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.localAnchorA.SetV(this.bodyA.GetLocalPoint(i)),this.localAnchorB.SetV(this.bodyB.GetLocalPoint(i))},bt.inherit(c,bt.Dynamics.Joints.b2Joint),c.prototype.__super=bt.Dynamics.Joints.b2Joint.prototype,c.b2GearJoint=function(){bt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_groundAnchor1=new o,this.m_groundAnchor2=new o,this.m_localAnchor1=new o,this.m_localAnchor2=new o,this.m_J=new u},c.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},c.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},c.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new o(t*this.m_impulse*this.m_J.linearB.x,t*this.m_impulse*this.m_J.linearB.y)},c.prototype.GetReactionTorque=function(t){void 0===t&&(t=0);var e=this.m_bodyB.m_xf.R,i=this.m_localAnchor1.x-this.m_bodyB.m_sweep.localCenter.x,n=this.m_localAnchor1.y-this.m_bodyB.m_sweep.localCenter.y,o=e.col1.x*i+e.col2.x*n;n=e.col1.y*i+e.col2.y*n,i=o;var s=this.m_impulse*this.m_J.linearB.x,r=this.m_impulse*this.m_J.linearB.y;return t*(this.m_impulse*this.m_J.angularB-i*r+n*s)},c.prototype.GetRatio=function(){return this.m_ratio},c.prototype.SetRatio=function(t){void 0===t&&(t=0),this.m_ratio=t},c.prototype.b2GearJoint=function(t){this.__super.b2Joint.call(this,t);var e=parseInt(t.joint1.m_type),i=parseInt(t.joint2.m_type);this.m_revolute1=null,this.m_prismatic1=null,this.m_revolute2=null,this.m_prismatic2=null;var n=0,o=0;this.m_ground1=t.joint1.GetBodyA(),this.m_bodyA=t.joint1.GetBodyB(),e==y.e_revoluteJoint?(this.m_revolute1=t.joint1 instanceof S?t.joint1:null,this.m_groundAnchor1.SetV(this.m_revolute1.m_localAnchor1),this.m_localAnchor1.SetV(this.m_revolute1.m_localAnchor2),n=this.m_revolute1.GetJointAngle()):(this.m_prismatic1=t.joint1 instanceof g?t.joint1:null,this.m_groundAnchor1.SetV(this.m_prismatic1.m_localAnchor1),this.m_localAnchor1.SetV(this.m_prismatic1.m_localAnchor2),n=this.m_prismatic1.GetJointTranslation()),this.m_ground2=t.joint2.GetBodyA(),this.m_bodyB=t.joint2.GetBodyB(),i==y.e_revoluteJoint?(this.m_revolute2=t.joint2 instanceof S?t.joint2:null,this.m_groundAnchor2.SetV(this.m_revolute2.m_localAnchor1),this.m_localAnchor2.SetV(this.m_revolute2.m_localAnchor2),o=this.m_revolute2.GetJointAngle()):(this.m_prismatic2=t.joint2 instanceof g?t.joint2:null,this.m_groundAnchor2.SetV(this.m_prismatic2.m_localAnchor1),this.m_localAnchor2.SetV(this.m_prismatic2.m_localAnchor2),o=this.m_prismatic2.GetJointTranslation()),this.m_ratio=t.ratio,this.m_constant=n+this.m_ratio*o,this.m_impulse=0},c.prototype.InitVelocityConstraints=function(t){var e,i,n=this.m_ground1,o=this.m_ground2,s=this.m_bodyA,r=this.m_bodyB,a=0,l=0,h=0,c=0,m=0,u=0,y=0;this.m_J.SetZero(),this.m_revolute1?(this.m_J.angularA=-1,y+=s.m_invI):(e=n.m_xf.R,i=this.m_prismatic1.m_localXAxis1,a=e.col1.x*i.x+e.col2.x*i.y,l=e.col1.y*i.x+e.col2.y*i.y,e=s.m_xf.R,h=this.m_localAnchor1.x-s.m_sweep.localCenter.x,c=this.m_localAnchor1.y-s.m_sweep.localCenter.y,u=e.col1.x*h+e.col2.x*c,c=e.col1.y*h+e.col2.y*c,m=(h=u)*l-c*a,this.m_J.linearA.Set(-a,-l),this.m_J.angularA=-m,y+=s.m_invMass+s.m_invI*m*m),this.m_revolute2?(this.m_J.angularB=-this.m_ratio,y+=this.m_ratio*this.m_ratio*r.m_invI):(e=o.m_xf.R,i=this.m_prismatic2.m_localXAxis1,a=e.col1.x*i.x+e.col2.x*i.y,l=e.col1.y*i.x+e.col2.y*i.y,e=r.m_xf.R,h=this.m_localAnchor2.x-r.m_sweep.localCenter.x,c=this.m_localAnchor2.y-r.m_sweep.localCenter.y,u=e.col1.x*h+e.col2.x*c,c=e.col1.y*h+e.col2.y*c,m=(h=u)*l-c*a,this.m_J.linearB.Set(-this.m_ratio*a,-this.m_ratio*l),this.m_J.angularB=-this.m_ratio*m,y+=this.m_ratio*this.m_ratio*(r.m_invMass+r.m_invI*m*m)),this.m_mass=y>0?1/y:0,t.warmStarting?(s.m_linearVelocity.x+=s.m_invMass*this.m_impulse*this.m_J.linearA.x,s.m_linearVelocity.y+=s.m_invMass*this.m_impulse*this.m_J.linearA.y,s.m_angularVelocity+=s.m_invI*this.m_impulse*this.m_J.angularA,r.m_linearVelocity.x+=r.m_invMass*this.m_impulse*this.m_J.linearB.x,r.m_linearVelocity.y+=r.m_invMass*this.m_impulse*this.m_J.linearB.y,r.m_angularVelocity+=r.m_invI*this.m_impulse*this.m_J.angularB):this.m_impulse=0},c.prototype.SolveVelocityConstraints=function(t){var e=this.m_bodyA,i=this.m_bodyB,n=this.m_J.Compute(e.m_linearVelocity,e.m_angularVelocity,i.m_linearVelocity,i.m_angularVelocity),o=-this.m_mass*n;this.m_impulse+=o,e.m_linearVelocity.x+=e.m_invMass*o*this.m_J.linearA.x,e.m_linearVelocity.y+=e.m_invMass*o*this.m_J.linearA.y,e.m_angularVelocity+=e.m_invI*o*this.m_J.angularA,i.m_linearVelocity.x+=i.m_invMass*o*this.m_J.linearB.x,i.m_linearVelocity.y+=i.m_invMass*o*this.m_J.linearB.y,i.m_angularVelocity+=i.m_invI*o*this.m_J.angularB},c.prototype.SolvePositionConstraints=function(e){var i,n,o=this.m_bodyA,s=this.m_bodyB;i=this.m_revolute1?this.m_revolute1.GetJointAngle():this.m_prismatic1.GetJointTranslation(),n=this.m_revolute2?this.m_revolute2.GetJointAngle():this.m_prismatic2.GetJointTranslation();var r=this.m_constant-(i+this.m_ratio*n),a=-this.m_mass*r;return o.m_sweep.c.x+=o.m_invMass*a*this.m_J.linearA.x,o.m_sweep.c.y+=o.m_invMass*a*this.m_J.linearA.y,o.m_sweep.a+=o.m_invI*a*this.m_J.angularA,s.m_sweep.c.x+=s.m_invMass*a*this.m_J.linearB.x,s.m_sweep.c.y+=s.m_invMass*a*this.m_J.linearB.y,s.m_sweep.a+=s.m_invI*a*this.m_J.angularB,o.SynchronizeTransform(),s.SynchronizeTransform(),0<t.b2_linearSlop},bt.inherit(m,bt.Dynamics.Joints.b2JointDef),m.prototype.__super=bt.Dynamics.Joints.b2JointDef.prototype,m.b2GearJointDef=function(){bt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments)},m.prototype.b2GearJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_gearJoint,this.joint1=null,this.joint2=null,this.ratio=1},u.b2Jacobian=function(){this.linearA=new o,this.linearB=new o},u.prototype.SetZero=function(){this.linearA.SetZero(),this.angularA=0,this.linearB.SetZero(),this.angularB=0},u.prototype.Set=function(t,e,i,n){void 0===e&&(e=0),void 0===n&&(n=0),this.linearA.SetV(t),this.angularA=e,this.linearB.SetV(i),this.angularB=n},u.prototype.Compute=function(t,e,i,n){return void 0===e&&(e=0),void 0===n&&(n=0),this.linearA.x*t.x+this.linearA.y*t.y+this.angularA*e+(this.linearB.x*i.x+this.linearB.y*i.y)+this.angularB*n},y.b2Joint=function(){this.m_edgeA=new f,this.m_edgeB=new f,this.m_localCenterA=new o,this.m_localCenterB=new o},y.prototype.GetType=function(){return this.m_type},y.prototype.GetAnchorA=function(){return null},y.prototype.GetAnchorB=function(){return null},y.prototype.GetReactionForce=function(t){return null},y.prototype.GetReactionTorque=function(t){return 0},y.prototype.GetBodyA=function(){return this.m_bodyA},y.prototype.GetBodyB=function(){return this.m_bodyB},y.prototype.GetNext=function(){return this.m_next},y.prototype.GetUserData=function(){return this.m_userData},y.prototype.SetUserData=function(t){this.m_userData=t},y.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()},y.Create=function(t,e){var i=null;switch(t.type){case y.e_distanceJoint:i=new r(t instanceof a?t:null);break;case y.e_mouseJoint:i=new v(t instanceof b?t:null);break;case y.e_prismaticJoint:i=new g(t instanceof x?t:null);break;case y.e_revoluteJoint:i=new S(t instanceof A?t:null);break;case y.e_pulleyJoint:i=new w(t instanceof C?t:null);break;case y.e_gearJoint:i=new c(t instanceof m?t:null);break;case y.e_lineJoint:i=new _(t instanceof d?t:null);break;case y.e_weldJoint:i=new M(t instanceof D?t:null);break;case y.e_frictionJoint:i=new l(t instanceof h?t:null)}return i},y.Destroy=function(t,e){},y.prototype.b2Joint=function(e){t.b2Assert(e.bodyA!=e.bodyB),this.m_type=e.type,this.m_prev=null,this.m_next=null,this.m_bodyA=e.bodyA,this.m_bodyB=e.bodyB,this.m_collideConnected=e.collideConnected,this.m_islandFlag=!1,this.m_userData=e.userData},y.prototype.InitVelocityConstraints=function(t){},y.prototype.SolveVelocityConstraints=function(t){},y.prototype.FinalizeVelocityConstraints=function(){},y.prototype.SolvePositionConstraints=function(t){return!1},bt.postDefs.push(function(){bt.Dynamics.Joints.b2Joint.e_unknownJoint=0,bt.Dynamics.Joints.b2Joint.e_revoluteJoint=1,bt.Dynamics.Joints.b2Joint.e_prismaticJoint=2,bt.Dynamics.Joints.b2Joint.e_distanceJoint=3,bt.Dynamics.Joints.b2Joint.e_pulleyJoint=4,bt.Dynamics.Joints.b2Joint.e_mouseJoint=5,bt.Dynamics.Joints.b2Joint.e_gearJoint=6,bt.Dynamics.Joints.b2Joint.e_lineJoint=7,bt.Dynamics.Joints.b2Joint.e_weldJoint=8,bt.Dynamics.Joints.b2Joint.e_frictionJoint=9,bt.Dynamics.Joints.b2Joint.e_inactiveLimit=0,bt.Dynamics.Joints.b2Joint.e_atLowerLimit=1,bt.Dynamics.Joints.b2Joint.e_atUpperLimit=2,bt.Dynamics.Joints.b2Joint.e_equalLimits=3}),p.b2JointDef=function(){},p.prototype.b2JointDef=function(){this.type=y.e_unknownJoint,this.userData=null,this.bodyA=null,this.bodyB=null,this.collideConnected=!1},f.b2JointEdge=function(){},bt.inherit(_,bt.Dynamics.Joints.b2Joint),_.prototype.__super=bt.Dynamics.Joints.b2Joint.prototype,_.b2LineJoint=function(){bt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_localAnchor1=new o,this.m_localAnchor2=new o,this.m_localXAxis1=new o,this.m_localYAxis1=new o,this.m_axis=new o,this.m_perp=new o,this.m_K=new e,this.m_impulse=new o},_.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},_.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},_.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new o(t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.x),t*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.y))},_.prototype.GetReactionTorque=function(t){return void 0===t&&(t=0),t*this.m_impulse.y},_.prototype.GetJointTranslation=function(){var t=this.m_bodyA,e=this.m_bodyB,i=t.GetWorldPoint(this.m_localAnchor1),n=e.GetWorldPoint(this.m_localAnchor2),o=n.x-i.x,s=n.y-i.y,r=t.GetWorldVector(this.m_localXAxis1);return r.x*o+r.y*s},_.prototype.GetJointSpeed=function(){var t,e=this.m_bodyA,i=this.m_bodyB;t=e.m_xf.R;var n=this.m_localAnchor1.x-e.m_sweep.localCenter.x,o=this.m_localAnchor1.y-e.m_sweep.localCenter.y,s=t.col1.x*n+t.col2.x*o;o=t.col1.y*n+t.col2.y*o,n=s,t=i.m_xf.R;var r=this.m_localAnchor2.x-i.m_sweep.localCenter.x,a=this.m_localAnchor2.y-i.m_sweep.localCenter.y;s=t.col1.x*r+t.col2.x*a,a=t.col1.y*r+t.col2.y*a,r=s;var l=e.m_sweep.c.x+n,h=e.m_sweep.c.y+o,c=i.m_sweep.c.x+r-l,m=i.m_sweep.c.y+a-h,u=e.GetWorldVector(this.m_localXAxis1),y=e.m_linearVelocity,p=i.m_linearVelocity,f=e.m_angularVelocity,_=i.m_angularVelocity;return c*(-f*u.y)+m*(f*u.x)+(u.x*(p.x+-_*a-y.x- -f*o)+u.y*(p.y+_*r-y.y-f*n))},_.prototype.IsLimitEnabled=function(){return this.m_enableLimit},_.prototype.EnableLimit=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t},_.prototype.GetLowerLimit=function(){return this.m_lowerTranslation},_.prototype.GetUpperLimit=function(){return this.m_upperTranslation},_.prototype.SetLimits=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e},_.prototype.IsMotorEnabled=function(){return this.m_enableMotor},_.prototype.EnableMotor=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t},_.prototype.SetMotorSpeed=function(t){void 0===t&&(t=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t},_.prototype.GetMotorSpeed=function(){return this.m_motorSpeed},_.prototype.SetMaxMotorForce=function(t){void 0===t&&(t=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t},_.prototype.GetMaxMotorForce=function(){return this.m_maxMotorForce},_.prototype.GetMotorForce=function(){return this.m_motorImpulse},_.prototype.b2LineJoint=function(t){this.__super.b2Joint.call(this,t),this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_localXAxis1.SetV(t.localAxisA),this.m_localYAxis1.x=-this.m_localXAxis1.y,this.m_localYAxis1.y=this.m_localXAxis1.x,this.m_impulse.SetZero(),this.m_motorMass=0,this.m_motorImpulse=0,this.m_lowerTranslation=t.lowerTranslation,this.m_upperTranslation=t.upperTranslation,this.m_maxMotorForce=t.maxMotorForce,this.m_motorSpeed=t.motorSpeed,this.m_enableLimit=t.enableLimit,this.m_enableMotor=t.enableMotor,this.m_limitState=y.e_inactiveLimit,this.m_axis.SetZero(),this.m_perp.SetZero()},_.prototype.InitVelocityConstraints=function(e){var i,o=this.m_bodyA,s=this.m_bodyB,r=0;this.m_localCenterA.SetV(o.GetLocalCenter()),this.m_localCenterB.SetV(s.GetLocalCenter());var a=o.GetTransform();s.GetTransform(),i=o.m_xf.R;var l=this.m_localAnchor1.x-this.m_localCenterA.x,h=this.m_localAnchor1.y-this.m_localCenterA.y;r=i.col1.x*l+i.col2.x*h,h=i.col1.y*l+i.col2.y*h,l=r,i=s.m_xf.R;var c=this.m_localAnchor2.x-this.m_localCenterB.x,m=this.m_localAnchor2.y-this.m_localCenterB.y;r=i.col1.x*c+i.col2.x*m,m=i.col1.y*c+i.col2.y*m,c=r;var u=s.m_sweep.c.x+c-o.m_sweep.c.x-l,p=s.m_sweep.c.y+m-o.m_sweep.c.y-h;this.m_invMassA=o.m_invMass,this.m_invMassB=s.m_invMass,this.m_invIA=o.m_invI,this.m_invIB=s.m_invI,this.m_axis.SetV(n.MulMV(a.R,this.m_localXAxis1)),this.m_a1=(u+l)*this.m_axis.y-(p+h)*this.m_axis.x,this.m_a2=c*this.m_axis.y-m*this.m_axis.x,this.m_motorMass=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_a1*this.m_a1+this.m_invIB*this.m_a2*this.m_a2,this.m_motorMass=this.m_motorMass>Number.MIN_VALUE?1/this.m_motorMass:0,this.m_perp.SetV(n.MulMV(a.R,this.m_localYAxis1)),this.m_s1=(u+l)*this.m_perp.y-(p+h)*this.m_perp.x,this.m_s2=c*this.m_perp.y-m*this.m_perp.x;var f=this.m_invMassA,_=this.m_invMassB,d=this.m_invIA,v=this.m_invIB;if(this.m_K.col1.x=f+_+d*this.m_s1*this.m_s1+v*this.m_s2*this.m_s2,this.m_K.col1.y=d*this.m_s1*this.m_a1+v*this.m_s2*this.m_a2,this.m_K.col2.x=this.m_K.col1.y,this.m_K.col2.y=f+_+d*this.m_a1*this.m_a1+v*this.m_a2*this.m_a2,this.m_enableLimit){var b=this.m_axis.x*u+this.m_axis.y*p;n.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*t.b2_linearSlop?this.m_limitState=y.e_equalLimits:b<=this.m_lowerTranslation?this.m_limitState!=y.e_atLowerLimit&&(this.m_limitState=y.e_atLowerLimit,this.m_impulse.y=0):b>=this.m_upperTranslation?this.m_limitState!=y.e_atUpperLimit&&(this.m_limitState=y.e_atUpperLimit,this.m_impulse.y=0):(this.m_limitState=y.e_inactiveLimit,this.m_impulse.y=0)}else this.m_limitState=y.e_inactiveLimit;if(0==this.m_enableMotor&&(this.m_motorImpulse=0),e.warmStarting){this.m_impulse.x*=e.dtRatio,this.m_impulse.y*=e.dtRatio,this.m_motorImpulse*=e.dtRatio;var g=this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.x,x=this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.y,w=this.m_impulse.x*this.m_s1+(this.m_motorImpulse+this.m_impulse.y)*this.m_a1,C=this.m_impulse.x*this.m_s2+(this.m_motorImpulse+this.m_impulse.y)*this.m_a2;o.m_linearVelocity.x-=this.m_invMassA*g,o.m_linearVelocity.y-=this.m_invMassA*x,o.m_angularVelocity-=this.m_invIA*w,s.m_linearVelocity.x+=this.m_invMassB*g,s.m_linearVelocity.y+=this.m_invMassB*x,s.m_angularVelocity+=this.m_invIB*C}else this.m_impulse.SetZero(),this.m_motorImpulse=0},_.prototype.SolveVelocityConstraints=function(t){var e=this.m_bodyA,i=this.m_bodyB,s=e.m_linearVelocity,r=e.m_angularVelocity,a=i.m_linearVelocity,l=i.m_angularVelocity,h=0,c=0,m=0,u=0;if(this.m_enableMotor&&this.m_limitState!=y.e_equalLimits){var p=this.m_axis.x*(a.x-s.x)+this.m_axis.y*(a.y-s.y)+this.m_a2*l-this.m_a1*r,f=this.m_motorMass*(this.m_motorSpeed-p),_=this.m_motorImpulse,d=t.dt*this.m_maxMotorForce;this.m_motorImpulse=n.Clamp(this.m_motorImpulse+f,-d,d),h=(f=this.m_motorImpulse-_)*this.m_axis.x,c=f*this.m_axis.y,m=f*this.m_a1,u=f*this.m_a2,s.x-=this.m_invMassA*h,s.y-=this.m_invMassA*c,r-=this.m_invIA*m,a.x+=this.m_invMassB*h,a.y+=this.m_invMassB*c,l+=this.m_invIB*u}var v=this.m_perp.x*(a.x-s.x)+this.m_perp.y*(a.y-s.y)+this.m_s2*l-this.m_s1*r;if(this.m_enableLimit&&this.m_limitState!=y.e_inactiveLimit){var b=this.m_axis.x*(a.x-s.x)+this.m_axis.y*(a.y-s.y)+this.m_a2*l-this.m_a1*r,g=this.m_impulse.Copy(),x=this.m_K.Solve(new o,-v,-b);this.m_impulse.Add(x),this.m_limitState==y.e_atLowerLimit?this.m_impulse.y=n.Max(this.m_impulse.y,0):this.m_limitState==y.e_atUpperLimit&&(this.m_impulse.y=n.Min(this.m_impulse.y,0));var w,C=-v-(this.m_impulse.y-g.y)*this.m_K.col2.x;w=0!=this.m_K.col1.x?C/this.m_K.col1.x+g.x:g.x,this.m_impulse.x=w,x.x=this.m_impulse.x-g.x,x.y=this.m_impulse.y-g.y,h=x.x*this.m_perp.x+x.y*this.m_axis.x,c=x.x*this.m_perp.y+x.y*this.m_axis.y,m=x.x*this.m_s1+x.y*this.m_a1,u=x.x*this.m_s2+x.y*this.m_a2,s.x-=this.m_invMassA*h,s.y-=this.m_invMassA*c,r-=this.m_invIA*m,a.x+=this.m_invMassB*h,a.y+=this.m_invMassB*c,l+=this.m_invIB*u}else{var S;S=0!=this.m_K.col1.x?-v/this.m_K.col1.x:0,this.m_impulse.x+=S,h=S*this.m_perp.x,c=S*this.m_perp.y,m=S*this.m_s1,u=S*this.m_s2,s.x-=this.m_invMassA*h,s.y-=this.m_invMassA*c,r-=this.m_invIA*m,a.x+=this.m_invMassB*h,a.y+=this.m_invMassB*c,l+=this.m_invIB*u}e.m_linearVelocity.SetV(s),e.m_angularVelocity=r,i.m_linearVelocity.SetV(a),i.m_angularVelocity=l},_.prototype.SolvePositionConstraints=function(i){var s,r=this.m_bodyA,a=this.m_bodyB,l=r.m_sweep.c,h=r.m_sweep.a,c=a.m_sweep.c,m=a.m_sweep.a,u=0,y=0,p=0,f=0,_=0,d=0,v=!1,b=0,g=e.FromAngle(h),x=e.FromAngle(m);s=g;var w=this.m_localAnchor1.x-this.m_localCenterA.x,C=this.m_localAnchor1.y-this.m_localCenterA.y;u=s.col1.x*w+s.col2.x*C,C=s.col1.y*w+s.col2.y*C,w=u,s=x;var S=this.m_localAnchor2.x-this.m_localCenterB.x,A=this.m_localAnchor2.y-this.m_localCenterB.y;u=s.col1.x*S+s.col2.x*A,A=s.col1.y*S+s.col2.y*A,S=u;var M=c.x+S-l.x-w,D=c.y+A-l.y-C;if(this.m_enableLimit){this.m_axis=n.MulMV(g,this.m_localXAxis1),this.m_a1=(M+w)*this.m_axis.y-(D+C)*this.m_axis.x,this.m_a2=S*this.m_axis.y-A*this.m_axis.x;var k=this.m_axis.x*M+this.m_axis.y*D;n.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*t.b2_linearSlop?(b=n.Clamp(k,-t.b2_maxLinearCorrection,t.b2_maxLinearCorrection),d=n.Abs(k),v=!0):k<=this.m_lowerTranslation?(b=n.Clamp(k-this.m_lowerTranslation+t.b2_linearSlop,-t.b2_maxLinearCorrection,0),d=this.m_lowerTranslation-k,v=!0):k>=this.m_upperTranslation&&(b=n.Clamp(k-this.m_upperTranslation+t.b2_linearSlop,0,t.b2_maxLinearCorrection),d=k-this.m_upperTranslation,v=!0)}this.m_perp=n.MulMV(g,this.m_localYAxis1),this.m_s1=(M+w)*this.m_perp.y-(D+C)*this.m_perp.x,this.m_s2=S*this.m_perp.y-A*this.m_perp.x;var B=new o,I=this.m_perp.x*M+this.m_perp.y*D;if(d=n.Max(d,n.Abs(I)),v)y=this.m_invMassA,p=this.m_invMassB,f=this.m_invIA,_=this.m_invIB,this.m_K.col1.x=y+p+f*this.m_s1*this.m_s1+_*this.m_s2*this.m_s2,this.m_K.col1.y=f*this.m_s1*this.m_a1+_*this.m_s2*this.m_a2,this.m_K.col2.x=this.m_K.col1.y,this.m_K.col2.y=y+p+f*this.m_a1*this.m_a1+_*this.m_a2*this.m_a2,this.m_K.Solve(B,-I,-b);else{y=this.m_invMassA,p=this.m_invMassB,f=this.m_invIA,_=this.m_invIB;var V,P=y+p+f*this.m_s1*this.m_s1+_*this.m_s2*this.m_s2;V=0!=P?-I/P:0,B.x=V,B.y=0}var T=B.x*this.m_perp.x+B.y*this.m_axis.x,L=B.x*this.m_perp.y+B.y*this.m_axis.y,G=B.x*this.m_s1+B.y*this.m_a1,E=B.x*this.m_s2+B.y*this.m_a2;return l.x-=this.m_invMassA*T,l.y-=this.m_invMassA*L,h-=this.m_invIA*G,c.x+=this.m_invMassB*T,c.y+=this.m_invMassB*L,m+=this.m_invIB*E,r.m_sweep.a=h,a.m_sweep.a=m,r.SynchronizeTransform(),a.SynchronizeTransform(),d<=t.b2_linearSlop&&0<=t.b2_angularSlop},bt.inherit(d,bt.Dynamics.Joints.b2JointDef),d.prototype.__super=bt.Dynamics.Joints.b2JointDef.prototype,d.b2LineJointDef=function(){bt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.localAnchorA=new o,this.localAnchorB=new o,this.localAxisA=new o},d.prototype.b2LineJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_lineJoint,this.localAxisA.Set(1,0),this.enableLimit=!1,this.lowerTranslation=0,this.upperTranslation=0,this.enableMotor=!1,this.maxMotorForce=0,this.motorSpeed=0},d.prototype.Initialize=function(t,e,i,n){this.bodyA=t,this.bodyB=e,this.localAnchorA=this.bodyA.GetLocalPoint(i),this.localAnchorB=this.bodyB.GetLocalPoint(i),this.localAxisA=this.bodyA.GetLocalVector(n)},bt.inherit(v,bt.Dynamics.Joints.b2Joint),v.prototype.__super=bt.Dynamics.Joints.b2Joint.prototype,v.b2MouseJoint=function(){bt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.K=new e,this.K1=new e,this.K2=new e,this.m_localAnchor=new o,this.m_target=new o,this.m_impulse=new o,this.m_mass=new e,this.m_C=new o},v.prototype.GetAnchorA=function(){return this.m_target},v.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor)},v.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new o(t*this.m_impulse.x,t*this.m_impulse.y)},v.prototype.GetReactionTorque=function(t){return 0},v.prototype.GetTarget=function(){return this.m_target},v.prototype.SetTarget=function(t){0==this.m_bodyB.IsAwake()&&this.m_bodyB.SetAwake(!0),this.m_target=t},v.prototype.GetMaxForce=function(){return this.m_maxForce},v.prototype.SetMaxForce=function(t){void 0===t&&(t=0),this.m_maxForce=t},v.prototype.GetFrequency=function(){return this.m_frequencyHz},v.prototype.SetFrequency=function(t){void 0===t&&(t=0),this.m_frequencyHz=t},v.prototype.GetDampingRatio=function(){return this.m_dampingRatio},v.prototype.SetDampingRatio=function(t){void 0===t&&(t=0),this.m_dampingRatio=t},v.prototype.b2MouseJoint=function(t){this.__super.b2Joint.call(this,t),this.m_target.SetV(t.target);var e=this.m_target.x-this.m_bodyB.m_xf.position.x,i=this.m_target.y-this.m_bodyB.m_xf.position.y,n=this.m_bodyB.m_xf.R;this.m_localAnchor.x=e*n.col1.x+i*n.col1.y,this.m_localAnchor.y=e*n.col2.x+i*n.col2.y,this.m_maxForce=t.maxForce,this.m_impulse.SetZero(),this.m_frequencyHz=t.frequencyHz,this.m_dampingRatio=t.dampingRatio,this.m_beta=0,this.m_gamma=0},v.prototype.InitVelocityConstraints=function(t){var e,i=this.m_bodyB,n=i.GetMass(),o=2*Math.PI*this.m_frequencyHz,s=2*n*this.m_dampingRatio*o,r=n*o*o;this.m_gamma=t.dt*(s+t.dt*r),this.m_gamma=0!=this.m_gamma?1/this.m_gamma:0,this.m_beta=t.dt*r*this.m_gamma,e=i.m_xf.R;var a=this.m_localAnchor.x-i.m_sweep.localCenter.x,l=this.m_localAnchor.y-i.m_sweep.localCenter.y,h=e.col1.x*a+e.col2.x*l;l=e.col1.y*a+e.col2.y*l,a=h;var c=i.m_invMass,m=i.m_invI;this.K1.col1.x=c,this.K1.col2.x=0,this.K1.col1.y=0,this.K1.col2.y=c,this.K2.col1.x=m*l*l,this.K2.col2.x=-m*a*l,this.K2.col1.y=-m*a*l,this.K2.col2.y=m*a*a,this.K.SetM(this.K1),this.K.AddM(this.K2),this.K.col1.x+=this.m_gamma,this.K.col2.y+=this.m_gamma,this.K.GetInverse(this.m_mass),this.m_C.x=i.m_sweep.c.x+a-this.m_target.x,this.m_C.y=i.m_sweep.c.y+l-this.m_target.y,i.m_angularVelocity*=.98,this.m_impulse.x*=t.dtRatio,this.m_impulse.y*=t.dtRatio,i.m_linearVelocity.x+=c*this.m_impulse.x,i.m_linearVelocity.y+=c*this.m_impulse.y,i.m_angularVelocity+=m*(a*this.m_impulse.y-l*this.m_impulse.x)},v.prototype.SolveVelocityConstraints=function(t){var e,i,n=this.m_bodyB,o=0;e=n.m_xf.R;var s=this.m_localAnchor.x-n.m_sweep.localCenter.x,r=this.m_localAnchor.y-n.m_sweep.localCenter.y;o=e.col1.x*s+e.col2.x*r,r=e.col1.y*s+e.col2.y*r,s=o;var a=n.m_linearVelocity.x+-n.m_angularVelocity*r,l=n.m_linearVelocity.y+n.m_angularVelocity*s;e=this.m_mass,o=a+this.m_beta*this.m_C.x+this.m_gamma*this.m_impulse.x,i=l+this.m_beta*this.m_C.y+this.m_gamma*this.m_impulse.y;var h=-(e.col1.x*o+e.col2.x*i),c=-(e.col1.y*o+e.col2.y*i),m=this.m_impulse.x,u=this.m_impulse.y;this.m_impulse.x+=h,this.m_impulse.y+=c;var y=t.dt*this.m_maxForce;this.m_impulse.LengthSquared()>y*y&&this.m_impulse.Multiply(y/this.m_impulse.Length()),h=this.m_impulse.x-m,c=this.m_impulse.y-u,n.m_linearVelocity.x+=n.m_invMass*h,n.m_linearVelocity.y+=n.m_invMass*c,n.m_angularVelocity+=n.m_invI*(s*c-r*h)},v.prototype.SolvePositionConstraints=function(t){return!0},bt.inherit(b,bt.Dynamics.Joints.b2JointDef),b.prototype.__super=bt.Dynamics.Joints.b2JointDef.prototype,b.b2MouseJointDef=function(){bt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.target=new o},b.prototype.b2MouseJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_mouseJoint,this.maxForce=0,this.frequencyHz=5,this.dampingRatio=.7},bt.inherit(g,bt.Dynamics.Joints.b2Joint),g.prototype.__super=bt.Dynamics.Joints.b2Joint.prototype,g.b2PrismaticJoint=function(){bt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_localAnchor1=new o,this.m_localAnchor2=new o,this.m_localXAxis1=new o,this.m_localYAxis1=new o,this.m_axis=new o,this.m_perp=new o,this.m_K=new i,this.m_impulse=new s},g.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},g.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},g.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new o(t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x),t*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y))},g.prototype.GetReactionTorque=function(t){return void 0===t&&(t=0),t*this.m_impulse.y},g.prototype.GetJointTranslation=function(){var t=this.m_bodyA,e=this.m_bodyB,i=t.GetWorldPoint(this.m_localAnchor1),n=e.GetWorldPoint(this.m_localAnchor2),o=n.x-i.x,s=n.y-i.y,r=t.GetWorldVector(this.m_localXAxis1);return r.x*o+r.y*s},g.prototype.GetJointSpeed=function(){var t,e=this.m_bodyA,i=this.m_bodyB;t=e.m_xf.R;var n=this.m_localAnchor1.x-e.m_sweep.localCenter.x,o=this.m_localAnchor1.y-e.m_sweep.localCenter.y,s=t.col1.x*n+t.col2.x*o;o=t.col1.y*n+t.col2.y*o,n=s,t=i.m_xf.R;var r=this.m_localAnchor2.x-i.m_sweep.localCenter.x,a=this.m_localAnchor2.y-i.m_sweep.localCenter.y;s=t.col1.x*r+t.col2.x*a,a=t.col1.y*r+t.col2.y*a,r=s;var l=e.m_sweep.c.x+n,h=e.m_sweep.c.y+o,c=i.m_sweep.c.x+r-l,m=i.m_sweep.c.y+a-h,u=e.GetWorldVector(this.m_localXAxis1),y=e.m_linearVelocity,p=i.m_linearVelocity,f=e.m_angularVelocity,_=i.m_angularVelocity;return c*(-f*u.y)+m*(f*u.x)+(u.x*(p.x+-_*a-y.x- -f*o)+u.y*(p.y+_*r-y.y-f*n))},g.prototype.IsLimitEnabled=function(){return this.m_enableLimit},g.prototype.EnableLimit=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t},g.prototype.GetLowerLimit=function(){return this.m_lowerTranslation},g.prototype.GetUpperLimit=function(){return this.m_upperTranslation},g.prototype.SetLimits=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e},g.prototype.IsMotorEnabled=function(){return this.m_enableMotor},g.prototype.EnableMotor=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t},g.prototype.SetMotorSpeed=function(t){void 0===t&&(t=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t},g.prototype.GetMotorSpeed=function(){return this.m_motorSpeed},g.prototype.SetMaxMotorForce=function(t){void 0===t&&(t=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t},g.prototype.GetMotorForce=function(){return this.m_motorImpulse},g.prototype.b2PrismaticJoint=function(t){this.__super.b2Joint.call(this,t),this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_localXAxis1.SetV(t.localAxisA),this.m_localYAxis1.x=-this.m_localXAxis1.y,this.m_localYAxis1.y=this.m_localXAxis1.x,this.m_refAngle=t.referenceAngle,this.m_impulse.SetZero(),this.m_motorMass=0,this.m_motorImpulse=0,this.m_lowerTranslation=t.lowerTranslation,this.m_upperTranslation=t.upperTranslation,this.m_maxMotorForce=t.maxMotorForce,this.m_motorSpeed=t.motorSpeed,this.m_enableLimit=t.enableLimit,this.m_enableMotor=t.enableMotor,this.m_limitState=y.e_inactiveLimit,this.m_axis.SetZero(),this.m_perp.SetZero()},g.prototype.InitVelocityConstraints=function(e){var i,o=this.m_bodyA,s=this.m_bodyB,r=0;this.m_localCenterA.SetV(o.GetLocalCenter()),this.m_localCenterB.SetV(s.GetLocalCenter());var a=o.GetTransform();s.GetTransform(),i=o.m_xf.R;var l=this.m_localAnchor1.x-this.m_localCenterA.x,h=this.m_localAnchor1.y-this.m_localCenterA.y;r=i.col1.x*l+i.col2.x*h,h=i.col1.y*l+i.col2.y*h,l=r,i=s.m_xf.R;var c=this.m_localAnchor2.x-this.m_localCenterB.x,m=this.m_localAnchor2.y-this.m_localCenterB.y;r=i.col1.x*c+i.col2.x*m,m=i.col1.y*c+i.col2.y*m,c=r;var u=s.m_sweep.c.x+c-o.m_sweep.c.x-l,p=s.m_sweep.c.y+m-o.m_sweep.c.y-h;this.m_invMassA=o.m_invMass,this.m_invMassB=s.m_invMass,this.m_invIA=o.m_invI,this.m_invIB=s.m_invI,this.m_axis.SetV(n.MulMV(a.R,this.m_localXAxis1)),this.m_a1=(u+l)*this.m_axis.y-(p+h)*this.m_axis.x,this.m_a2=c*this.m_axis.y-m*this.m_axis.x,this.m_motorMass=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_a1*this.m_a1+this.m_invIB*this.m_a2*this.m_a2,this.m_motorMass>Number.MIN_VALUE&&(this.m_motorMass=1/this.m_motorMass),this.m_perp.SetV(n.MulMV(a.R,this.m_localYAxis1)),this.m_s1=(u+l)*this.m_perp.y-(p+h)*this.m_perp.x,this.m_s2=c*this.m_perp.y-m*this.m_perp.x;var f=this.m_invMassA,_=this.m_invMassB,d=this.m_invIA,v=this.m_invIB;if(this.m_K.col1.x=f+_+d*this.m_s1*this.m_s1+v*this.m_s2*this.m_s2,this.m_K.col1.y=d*this.m_s1+v*this.m_s2,this.m_K.col1.z=d*this.m_s1*this.m_a1+v*this.m_s2*this.m_a2,this.m_K.col2.x=this.m_K.col1.y,this.m_K.col2.y=d+v,this.m_K.col2.z=d*this.m_a1+v*this.m_a2,this.m_K.col3.x=this.m_K.col1.z,this.m_K.col3.y=this.m_K.col2.z,this.m_K.col3.z=f+_+d*this.m_a1*this.m_a1+v*this.m_a2*this.m_a2,this.m_enableLimit){var b=this.m_axis.x*u+this.m_axis.y*p;n.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*t.b2_linearSlop?this.m_limitState=y.e_equalLimits:b<=this.m_lowerTranslation?this.m_limitState!=y.e_atLowerLimit&&(this.m_limitState=y.e_atLowerLimit,this.m_impulse.z=0):b>=this.m_upperTranslation?this.m_limitState!=y.e_atUpperLimit&&(this.m_limitState=y.e_atUpperLimit,this.m_impulse.z=0):(this.m_limitState=y.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=y.e_inactiveLimit;if(0==this.m_enableMotor&&(this.m_motorImpulse=0),e.warmStarting){this.m_impulse.x*=e.dtRatio,this.m_impulse.y*=e.dtRatio,this.m_motorImpulse*=e.dtRatio;var g=this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x,x=this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y,w=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,C=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;o.m_linearVelocity.x-=this.m_invMassA*g,o.m_linearVelocity.y-=this.m_invMassA*x,o.m_angularVelocity-=this.m_invIA*w,s.m_linearVelocity.x+=this.m_invMassB*g,s.m_linearVelocity.y+=this.m_invMassB*x,s.m_angularVelocity+=this.m_invIB*C}else this.m_impulse.SetZero(),this.m_motorImpulse=0},g.prototype.SolveVelocityConstraints=function(t){var e=this.m_bodyA,i=this.m_bodyB,r=e.m_linearVelocity,a=e.m_angularVelocity,l=i.m_linearVelocity,h=i.m_angularVelocity,c=0,m=0,u=0,p=0;if(this.m_enableMotor&&this.m_limitState!=y.e_equalLimits){var f=this.m_axis.x*(l.x-r.x)+this.m_axis.y*(l.y-r.y)+this.m_a2*h-this.m_a1*a,_=this.m_motorMass*(this.m_motorSpeed-f),d=this.m_motorImpulse,v=t.dt*this.m_maxMotorForce;this.m_motorImpulse=n.Clamp(this.m_motorImpulse+_,-v,v),c=(_=this.m_motorImpulse-d)*this.m_axis.x,m=_*this.m_axis.y,u=_*this.m_a1,p=_*this.m_a2,r.x-=this.m_invMassA*c,r.y-=this.m_invMassA*m,a-=this.m_invIA*u,l.x+=this.m_invMassB*c,l.y+=this.m_invMassB*m,h+=this.m_invIB*p}var b=this.m_perp.x*(l.x-r.x)+this.m_perp.y*(l.y-r.y)+this.m_s2*h-this.m_s1*a,g=h-a;if(this.m_enableLimit&&this.m_limitState!=y.e_inactiveLimit){var x=this.m_axis.x*(l.x-r.x)+this.m_axis.y*(l.y-r.y)+this.m_a2*h-this.m_a1*a,w=this.m_impulse.Copy(),C=this.m_K.Solve33(new s,-b,-g,-x);this.m_impulse.Add(C),this.m_limitState==y.e_atLowerLimit?this.m_impulse.z=n.Max(this.m_impulse.z,0):this.m_limitState==y.e_atUpperLimit&&(this.m_impulse.z=n.Min(this.m_impulse.z,0));var S=-b-(this.m_impulse.z-w.z)*this.m_K.col3.x,A=-g-(this.m_impulse.z-w.z)*this.m_K.col3.y,M=this.m_K.Solve22(new o,S,A);M.x+=w.x,M.y+=w.y,this.m_impulse.x=M.x,this.m_impulse.y=M.y,C.x=this.m_impulse.x-w.x,C.y=this.m_impulse.y-w.y,C.z=this.m_impulse.z-w.z,c=C.x*this.m_perp.x+C.z*this.m_axis.x,m=C.x*this.m_perp.y+C.z*this.m_axis.y,u=C.x*this.m_s1+C.y+C.z*this.m_a1,p=C.x*this.m_s2+C.y+C.z*this.m_a2,r.x-=this.m_invMassA*c,r.y-=this.m_invMassA*m,a-=this.m_invIA*u,l.x+=this.m_invMassB*c,l.y+=this.m_invMassB*m,h+=this.m_invIB*p}else{var D=this.m_K.Solve22(new o,-b,-g);this.m_impulse.x+=D.x,this.m_impulse.y+=D.y,c=D.x*this.m_perp.x,m=D.x*this.m_perp.y,u=D.x*this.m_s1+D.y,p=D.x*this.m_s2+D.y,r.x-=this.m_invMassA*c,r.y-=this.m_invMassA*m,a-=this.m_invIA*u,l.x+=this.m_invMassB*c,l.y+=this.m_invMassB*m,h+=this.m_invIB*p}e.m_linearVelocity.SetV(r),e.m_angularVelocity=a,i.m_linearVelocity.SetV(l),i.m_angularVelocity=h},g.prototype.SolvePositionConstraints=function(i){var r,a,l=this.m_bodyA,h=this.m_bodyB,c=l.m_sweep.c,m=l.m_sweep.a,u=h.m_sweep.c,y=h.m_sweep.a,p=0,f=0,_=0,d=0,v=0,b=0,g=!1,x=0,w=e.FromAngle(m),C=e.FromAngle(y);r=w;var S=this.m_localAnchor1.x-this.m_localCenterA.x,A=this.m_localAnchor1.y-this.m_localCenterA.y;p=r.col1.x*S+r.col2.x*A,A=r.col1.y*S+r.col2.y*A,S=p,r=C;var M=this.m_localAnchor2.x-this.m_localCenterB.x,D=this.m_localAnchor2.y-this.m_localCenterB.y;p=r.col1.x*M+r.col2.x*D,D=r.col1.y*M+r.col2.y*D,M=p;var k=u.x+M-c.x-S,B=u.y+D-c.y-A;if(this.m_enableLimit){this.m_axis=n.MulMV(w,this.m_localXAxis1),this.m_a1=(k+S)*this.m_axis.y-(B+A)*this.m_axis.x,this.m_a2=M*this.m_axis.y-D*this.m_axis.x;var I=this.m_axis.x*k+this.m_axis.y*B;n.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*t.b2_linearSlop?(x=n.Clamp(I,-t.b2_maxLinearCorrection,t.b2_maxLinearCorrection),b=n.Abs(I),g=!0):I<=this.m_lowerTranslation?(x=n.Clamp(I-this.m_lowerTranslation+t.b2_linearSlop,-t.b2_maxLinearCorrection,0),b=this.m_lowerTranslation-I,g=!0):I>=this.m_upperTranslation&&(x=n.Clamp(I-this.m_upperTranslation+t.b2_linearSlop,0,t.b2_maxLinearCorrection),b=I-this.m_upperTranslation,g=!0)}this.m_perp=n.MulMV(w,this.m_localYAxis1),this.m_s1=(k+S)*this.m_perp.y-(B+A)*this.m_perp.x,this.m_s2=M*this.m_perp.y-D*this.m_perp.x;var V=new s,P=this.m_perp.x*k+this.m_perp.y*B,T=y-m-this.m_refAngle;if(b=n.Max(b,n.Abs(P)),a=n.Abs(T),g)f=this.m_invMassA,_=this.m_invMassB,d=this.m_invIA,v=this.m_invIB,this.m_K.col1.x=f+_+d*this.m_s1*this.m_s1+v*this.m_s2*this.m_s2,this.m_K.col1.y=d*this.m_s1+v*this.m_s2,this.m_K.col1.z=d*this.m_s1*this.m_a1+v*this.m_s2*this.m_a2,this.m_K.col2.x=this.m_K.col1.y,this.m_K.col2.y=d+v,this.m_K.col2.z=d*this.m_a1+v*this.m_a2,this.m_K.col3.x=this.m_K.col1.z,this.m_K.col3.y=this.m_K.col2.z,this.m_K.col3.z=f+_+d*this.m_a1*this.m_a1+v*this.m_a2*this.m_a2,this.m_K.Solve33(V,-P,-T,-x);else{f=this.m_invMassA,_=this.m_invMassB,d=this.m_invIA,v=this.m_invIB;var L=f+_+d*this.m_s1*this.m_s1+v*this.m_s2*this.m_s2,G=d*this.m_s1+v*this.m_s2,E=d+v;this.m_K.col1.Set(L,G,0),this.m_K.col2.Set(G,E,0);var F=this.m_K.Solve22(new o,-P,-T);V.x=F.x,V.y=F.y,V.z=0}var R=V.x*this.m_perp.x+V.z*this.m_axis.x,O=V.x*this.m_perp.y+V.z*this.m_axis.y,J=V.x*this.m_s1+V.y+V.z*this.m_a1,z=V.x*this.m_s2+V.y+V.z*this.m_a2;return c.x-=this.m_invMassA*R,c.y-=this.m_invMassA*O,m-=this.m_invIA*J,u.x+=this.m_invMassB*R,u.y+=this.m_invMassB*O,y+=this.m_invIB*z,l.m_sweep.a=m,h.m_sweep.a=y,l.SynchronizeTransform(),h.SynchronizeTransform(),b<=t.b2_linearSlop&&a<=t.b2_angularSlop},bt.inherit(x,bt.Dynamics.Joints.b2JointDef),x.prototype.__super=bt.Dynamics.Joints.b2JointDef.prototype,x.b2PrismaticJointDef=function(){bt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.localAnchorA=new o,this.localAnchorB=new o,this.localAxisA=new o},x.prototype.b2PrismaticJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_prismaticJoint,this.localAxisA.Set(1,0),this.referenceAngle=0,this.enableLimit=!1,this.lowerTranslation=0,this.upperTranslation=0,this.enableMotor=!1,this.maxMotorForce=0,this.motorSpeed=0},x.prototype.Initialize=function(t,e,i,n){this.bodyA=t,this.bodyB=e,this.localAnchorA=this.bodyA.GetLocalPoint(i),this.localAnchorB=this.bodyB.GetLocalPoint(i),this.localAxisA=this.bodyA.GetLocalVector(n),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},bt.inherit(w,bt.Dynamics.Joints.b2Joint),w.prototype.__super=bt.Dynamics.Joints.b2Joint.prototype,w.b2PulleyJoint=function(){bt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_groundAnchor1=new o,this.m_groundAnchor2=new o,this.m_localAnchor1=new o,this.m_localAnchor2=new o,this.m_u1=new o,this.m_u2=new o},w.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},w.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},w.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new o(t*this.m_impulse*this.m_u2.x,t*this.m_impulse*this.m_u2.y)},w.prototype.GetReactionTorque=function(t){return 0},w.prototype.GetGroundAnchorA=function(){var t=this.m_ground.m_xf.position.Copy();return t.Add(this.m_groundAnchor1),t},w.prototype.GetGroundAnchorB=function(){var t=this.m_ground.m_xf.position.Copy();return t.Add(this.m_groundAnchor2),t},w.prototype.GetLength1=function(){var t=this.m_bodyA.GetWorldPoint(this.m_localAnchor1),e=this.m_ground.m_xf.position.x+this.m_groundAnchor1.x,i=this.m_ground.m_xf.position.y+this.m_groundAnchor1.y,n=t.x-e,o=t.y-i;return Math.sqrt(n*n+o*o)},w.prototype.GetLength2=function(){var t=this.m_bodyB.GetWorldPoint(this.m_localAnchor2),e=this.m_ground.m_xf.position.x+this.m_groundAnchor2.x,i=this.m_ground.m_xf.position.y+this.m_groundAnchor2.y,n=t.x-e,o=t.y-i;return Math.sqrt(n*n+o*o)},w.prototype.GetRatio=function(){return this.m_ratio},w.prototype.b2PulleyJoint=function(t){this.__super.b2Joint.call(this,t),this.m_ground=this.m_bodyA.m_world.m_groundBody,this.m_groundAnchor1.x=t.groundAnchorA.x-this.m_ground.m_xf.position.x,this.m_groundAnchor1.y=t.groundAnchorA.y-this.m_ground.m_xf.position.y,this.m_groundAnchor2.x=t.groundAnchorB.x-this.m_ground.m_xf.position.x,this.m_groundAnchor2.y=t.groundAnchorB.y-this.m_ground.m_xf.position.y,this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_ratio=t.ratio,this.m_constant=t.lengthA+this.m_ratio*t.lengthB,this.m_maxLength1=n.Min(t.maxLengthA,this.m_constant-this.m_ratio*w.b2_minPulleyLength),this.m_maxLength2=n.Min(t.maxLengthB,(this.m_constant-w.b2_minPulleyLength)/this.m_ratio),this.m_impulse=0,this.m_limitImpulse1=0,this.m_limitImpulse2=0},w.prototype.InitVelocityConstraints=function(e){var i,n=this.m_bodyA,o=this.m_bodyB;i=n.m_xf.R;var s=this.m_localAnchor1.x-n.m_sweep.localCenter.x,r=this.m_localAnchor1.y-n.m_sweep.localCenter.y,a=i.col1.x*s+i.col2.x*r;r=i.col1.y*s+i.col2.y*r,s=a,i=o.m_xf.R;var l=this.m_localAnchor2.x-o.m_sweep.localCenter.x,h=this.m_localAnchor2.y-o.m_sweep.localCenter.y;a=i.col1.x*l+i.col2.x*h,h=i.col1.y*l+i.col2.y*h,l=a;var c=n.m_sweep.c.x+s,m=n.m_sweep.c.y+r,u=o.m_sweep.c.x+l,p=o.m_sweep.c.y+h,f=this.m_ground.m_xf.position.x+this.m_groundAnchor1.x,_=this.m_ground.m_xf.position.y+this.m_groundAnchor1.y,d=this.m_ground.m_xf.position.x+this.m_groundAnchor2.x,v=this.m_ground.m_xf.position.y+this.m_groundAnchor2.y;this.m_u1.Set(c-f,m-_),this.m_u2.Set(u-d,p-v);var b=this.m_u1.Length(),g=this.m_u2.Length();b>t.b2_linearSlop?this.m_u1.Multiply(1/b):this.m_u1.SetZero(),g>t.b2_linearSlop?this.m_u2.Multiply(1/g):this.m_u2.SetZero(),this.m_constant-b-this.m_ratio*g>0?(this.m_state=y.e_inactiveLimit,this.m_impulse=0):this.m_state=y.e_atUpperLimit,b<this.m_maxLength1?(this.m_limitState1=y.e_inactiveLimit,this.m_limitImpulse1=0):this.m_limitState1=y.e_atUpperLimit,g<this.m_maxLength2?(this.m_limitState2=y.e_inactiveLimit,this.m_limitImpulse2=0):this.m_limitState2=y.e_atUpperLimit;var x=s*this.m_u1.y-r*this.m_u1.x,w=l*this.m_u2.y-h*this.m_u2.x;if(this.m_limitMass1=n.m_invMass+n.m_invI*x*x,this.m_limitMass2=o.m_invMass+o.m_invI*w*w,this.m_pulleyMass=this.m_limitMass1+this.m_ratio*this.m_ratio*this.m_limitMass2,this.m_limitMass1=1/this.m_limitMass1,this.m_limitMass2=1/this.m_limitMass2,this.m_pulleyMass=1/this.m_pulleyMass,e.warmStarting){this.m_impulse*=e.dtRatio,this.m_limitImpulse1*=e.dtRatio,this.m_limitImpulse2*=e.dtRatio;var C=(-this.m_impulse-this.m_limitImpulse1)*this.m_u1.x,S=(-this.m_impulse-this.m_limitImpulse1)*this.m_u1.y,A=(-this.m_ratio*this.m_impulse-this.m_limitImpulse2)*this.m_u2.x,M=(-this.m_ratio*this.m_impulse-this.m_limitImpulse2)*this.m_u2.y;n.m_linearVelocity.x+=n.m_invMass*C,n.m_linearVelocity.y+=n.m_invMass*S,n.m_angularVelocity+=n.m_invI*(s*S-r*C),o.m_linearVelocity.x+=o.m_invMass*A,o.m_linearVelocity.y+=o.m_invMass*M,o.m_angularVelocity+=o.m_invI*(l*M-h*A)}else this.m_impulse=0,this.m_limitImpulse1=0,this.m_limitImpulse2=0},w.prototype.SolveVelocityConstraints=function(t){var e,i=this.m_bodyA,o=this.m_bodyB;e=i.m_xf.R;var s=this.m_localAnchor1.x-i.m_sweep.localCenter.x,r=this.m_localAnchor1.y-i.m_sweep.localCenter.y,a=e.col1.x*s+e.col2.x*r;r=e.col1.y*s+e.col2.y*r,s=a,e=o.m_xf.R;var l=this.m_localAnchor2.x-o.m_sweep.localCenter.x,h=this.m_localAnchor2.y-o.m_sweep.localCenter.y;a=e.col1.x*l+e.col2.x*h,h=e.col1.y*l+e.col2.y*h,l=a;var c=0,m=0,u=0,p=0,f=0,_=0,d=0,v=0,b=0,g=0,x=0;this.m_state==y.e_atUpperLimit&&(c=i.m_linearVelocity.x+-i.m_angularVelocity*r,m=i.m_linearVelocity.y+i.m_angularVelocity*s,u=o.m_linearVelocity.x+-o.m_angularVelocity*h,p=o.m_linearVelocity.y+o.m_angularVelocity*l,b=-(this.m_u1.x*c+this.m_u1.y*m)-this.m_ratio*(this.m_u2.x*u+this.m_u2.y*p),g=this.m_pulleyMass*-b,x=this.m_impulse,this.m_impulse=n.Max(0,this.m_impulse+g),f=-(g=this.m_impulse-x)*this.m_u1.x,_=-g*this.m_u1.y,d=-this.m_ratio*g*this.m_u2.x,v=-this.m_ratio*g*this.m_u2.y,i.m_linearVelocity.x+=i.m_invMass*f,i.m_linearVelocity.y+=i.m_invMass*_,i.m_angularVelocity+=i.m_invI*(s*_-r*f),o.m_linearVelocity.x+=o.m_invMass*d,o.m_linearVelocity.y+=o.m_invMass*v,o.m_angularVelocity+=o.m_invI*(l*v-h*d)),this.m_limitState1==y.e_atUpperLimit&&(c=i.m_linearVelocity.x+-i.m_angularVelocity*r,m=i.m_linearVelocity.y+i.m_angularVelocity*s,b=-(this.m_u1.x*c+this.m_u1.y*m),g=-this.m_limitMass1*b,x=this.m_limitImpulse1,this.m_limitImpulse1=n.Max(0,this.m_limitImpulse1+g),f=-(g=this.m_limitImpulse1-x)*this.m_u1.x,_=-g*this.m_u1.y,i.m_linearVelocity.x+=i.m_invMass*f,i.m_linearVelocity.y+=i.m_invMass*_,i.m_angularVelocity+=i.m_invI*(s*_-r*f)),this.m_limitState2==y.e_atUpperLimit&&(u=o.m_linearVelocity.x+-o.m_angularVelocity*h,p=o.m_linearVelocity.y+o.m_angularVelocity*l,b=-(this.m_u2.x*u+this.m_u2.y*p),g=-this.m_limitMass2*b,x=this.m_limitImpulse2,this.m_limitImpulse2=n.Max(0,this.m_limitImpulse2+g),d=-(g=this.m_limitImpulse2-x)*this.m_u2.x,v=-g*this.m_u2.y,o.m_linearVelocity.x+=o.m_invMass*d,o.m_linearVelocity.y+=o.m_invMass*v,o.m_angularVelocity+=o.m_invI*(l*v-h*d))},w.prototype.SolvePositionConstraints=function(e){var i,o=this.m_bodyA,s=this.m_bodyB,r=this.m_ground.m_xf.position.x+this.m_groundAnchor1.x,a=this.m_ground.m_xf.position.y+this.m_groundAnchor1.y,l=this.m_ground.m_xf.position.x+this.m_groundAnchor2.x,h=this.m_ground.m_xf.position.y+this.m_groundAnchor2.y,c=0,m=0,u=0,p=0,f=0,_=0,d=0,v=0,b=0,g=0,x=0,w=0,C=0,S=0;return this.m_state==y.e_atUpperLimit&&(i=o.m_xf.R,c=this.m_localAnchor1.x-o.m_sweep.localCenter.x,m=this.m_localAnchor1.y-o.m_sweep.localCenter.y,C=i.col1.x*c+i.col2.x*m,m=i.col1.y*c+i.col2.y*m,c=C,i=s.m_xf.R,u=this.m_localAnchor2.x-s.m_sweep.localCenter.x,p=this.m_localAnchor2.y-s.m_sweep.localCenter.y,C=i.col1.x*u+i.col2.x*p,p=i.col1.y*u+i.col2.y*p,u=C,f=o.m_sweep.c.x+c,_=o.m_sweep.c.y+m,d=s.m_sweep.c.x+u,v=s.m_sweep.c.y+p,this.m_u1.Set(f-r,_-a),this.m_u2.Set(d-l,v-h),b=this.m_u1.Length(),g=this.m_u2.Length(),b>t.b2_linearSlop?this.m_u1.Multiply(1/b):this.m_u1.SetZero(),g>t.b2_linearSlop?this.m_u2.Multiply(1/g):this.m_u2.SetZero(),x=this.m_constant-b-this.m_ratio*g,S=n.Max(S,-x),x=n.Clamp(x+t.b2_linearSlop,-t.b2_maxLinearCorrection,0),f=-(w=-this.m_pulleyMass*x)*this.m_u1.x,_=-w*this.m_u1.y,d=-this.m_ratio*w*this.m_u2.x,v=-this.m_ratio*w*this.m_u2.y,o.m_sweep.c.x+=o.m_invMass*f,o.m_sweep.c.y+=o.m_invMass*_,o.m_sweep.a+=o.m_invI*(c*_-m*f),s.m_sweep.c.x+=s.m_invMass*d,s.m_sweep.c.y+=s.m_invMass*v,s.m_sweep.a+=s.m_invI*(u*v-p*d),o.SynchronizeTransform(),s.SynchronizeTransform()),this.m_limitState1==y.e_atUpperLimit&&(i=o.m_xf.R,c=this.m_localAnchor1.x-o.m_sweep.localCenter.x,m=this.m_localAnchor1.y-o.m_sweep.localCenter.y,C=i.col1.x*c+i.col2.x*m,m=i.col1.y*c+i.col2.y*m,c=C,f=o.m_sweep.c.x+c,_=o.m_sweep.c.y+m,this.m_u1.Set(f-r,_-a),(b=this.m_u1.Length())>t.b2_linearSlop?(this.m_u1.x*=1/b,this.m_u1.y*=1/b):this.m_u1.SetZero(),x=this.m_maxLength1-b,S=n.Max(S,-x),x=n.Clamp(x+t.b2_linearSlop,-t.b2_maxLinearCorrection,0),f=-(w=-this.m_limitMass1*x)*this.m_u1.x,_=-w*this.m_u1.y,o.m_sweep.c.x+=o.m_invMass*f,o.m_sweep.c.y+=o.m_invMass*_,o.m_sweep.a+=o.m_invI*(c*_-m*f),o.SynchronizeTransform()),this.m_limitState2==y.e_atUpperLimit&&(i=s.m_xf.R,u=this.m_localAnchor2.x-s.m_sweep.localCenter.x,p=this.m_localAnchor2.y-s.m_sweep.localCenter.y,C=i.col1.x*u+i.col2.x*p,p=i.col1.y*u+i.col2.y*p,u=C,d=s.m_sweep.c.x+u,v=s.m_sweep.c.y+p,this.m_u2.Set(d-l,v-h),(g=this.m_u2.Length())>t.b2_linearSlop?(this.m_u2.x*=1/g,this.m_u2.y*=1/g):this.m_u2.SetZero(),x=this.m_maxLength2-g,S=n.Max(S,-x),x=n.Clamp(x+t.b2_linearSlop,-t.b2_maxLinearCorrection,0),d=-(w=-this.m_limitMass2*x)*this.m_u2.x,v=-w*this.m_u2.y,s.m_sweep.c.x+=s.m_invMass*d,s.m_sweep.c.y+=s.m_invMass*v,s.m_sweep.a+=s.m_invI*(u*v-p*d),s.SynchronizeTransform()),S<t.b2_linearSlop},bt.postDefs.push(function(){bt.Dynamics.Joints.b2PulleyJoint.b2_minPulleyLength=2}),bt.inherit(C,bt.Dynamics.Joints.b2JointDef),C.prototype.__super=bt.Dynamics.Joints.b2JointDef.prototype,C.b2PulleyJointDef=function(){bt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.groundAnchorA=new o,this.groundAnchorB=new o,this.localAnchorA=new o,this.localAnchorB=new o},C.prototype.b2PulleyJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_pulleyJoint,this.groundAnchorA.Set(-1,1),this.groundAnchorB.Set(1,1),this.localAnchorA.Set(-1,0),this.localAnchorB.Set(1,0),this.lengthA=0,this.maxLengthA=0,this.lengthB=0,this.maxLengthB=0,this.ratio=1,this.collideConnected=!0},C.prototype.Initialize=function(t,e,i,n,o,s,r){void 0===r&&(r=0),this.bodyA=t,this.bodyB=e,this.groundAnchorA.SetV(i),this.groundAnchorB.SetV(n),this.localAnchorA=this.bodyA.GetLocalPoint(o),this.localAnchorB=this.bodyB.GetLocalPoint(s);var a=o.x-i.x,l=o.y-i.y;this.lengthA=Math.sqrt(a*a+l*l);var h=s.x-n.x,c=s.y-n.y;this.lengthB=Math.sqrt(h*h+c*c),this.ratio=r;var m=this.lengthA+this.ratio*this.lengthB;this.maxLengthA=m-this.ratio*w.b2_minPulleyLength,this.maxLengthB=(m-w.b2_minPulleyLength)/this.ratio},bt.inherit(S,bt.Dynamics.Joints.b2Joint),S.prototype.__super=bt.Dynamics.Joints.b2Joint.prototype,S.b2RevoluteJoint=function(){bt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.K=new e,this.K1=new e,this.K2=new e,this.K3=new e,this.impulse3=new s,this.impulse2=new o,this.reduced=new o,this.m_localAnchor1=new o,this.m_localAnchor2=new o,this.m_impulse=new s,this.m_mass=new i},S.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},S.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},S.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new o(t*this.m_impulse.x,t*this.m_impulse.y)},S.prototype.GetReactionTorque=function(t){return void 0===t&&(t=0),t*this.m_impulse.z},S.prototype.GetJointAngle=function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle},S.prototype.GetJointSpeed=function(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity},S.prototype.IsLimitEnabled=function(){return this.m_enableLimit},S.prototype.EnableLimit=function(t){this.m_enableLimit=t},S.prototype.GetLowerLimit=function(){return this.m_lowerAngle},S.prototype.GetUpperLimit=function(){return this.m_upperAngle},S.prototype.SetLimits=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.m_lowerAngle=t,this.m_upperAngle=e},S.prototype.IsMotorEnabled=function(){return this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor},S.prototype.EnableMotor=function(t){this.m_enableMotor=t},S.prototype.SetMotorSpeed=function(t){void 0===t&&(t=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t},S.prototype.GetMotorSpeed=function(){return this.m_motorSpeed},S.prototype.SetMaxMotorTorque=function(t){void 0===t&&(t=0),this.m_maxMotorTorque=t},S.prototype.GetMotorTorque=function(){return this.m_maxMotorTorque},S.prototype.b2RevoluteJoint=function(t){this.__super.b2Joint.call(this,t),this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_referenceAngle=t.referenceAngle,this.m_impulse.SetZero(),this.m_motorImpulse=0,this.m_lowerAngle=t.lowerAngle,this.m_upperAngle=t.upperAngle,this.m_maxMotorTorque=t.maxMotorTorque,this.m_motorSpeed=t.motorSpeed,this.m_enableLimit=t.enableLimit,this.m_enableMotor=t.enableMotor,this.m_limitState=y.e_inactiveLimit},S.prototype.InitVelocityConstraints=function(e){var i,o=this.m_bodyA,s=this.m_bodyB,r=0;this.m_enableMotor||this.m_enableLimit,i=o.m_xf.R;var a=this.m_localAnchor1.x-o.m_sweep.localCenter.x,l=this.m_localAnchor1.y-o.m_sweep.localCenter.y;r=i.col1.x*a+i.col2.x*l,l=i.col1.y*a+i.col2.y*l,a=r,i=s.m_xf.R;var h=this.m_localAnchor2.x-s.m_sweep.localCenter.x,c=this.m_localAnchor2.y-s.m_sweep.localCenter.y;r=i.col1.x*h+i.col2.x*c,c=i.col1.y*h+i.col2.y*c,h=r;var m=o.m_invMass,u=s.m_invMass,p=o.m_invI,f=s.m_invI;if(this.m_mass.col1.x=m+u+l*l*p+c*c*f,this.m_mass.col2.x=-l*a*p-c*h*f,this.m_mass.col3.x=-l*p-c*f,this.m_mass.col1.y=this.m_mass.col2.x,this.m_mass.col2.y=m+u+a*a*p+h*h*f,this.m_mass.col3.y=a*p+h*f,this.m_mass.col1.z=this.m_mass.col3.x,this.m_mass.col2.z=this.m_mass.col3.y,this.m_mass.col3.z=p+f,this.m_motorMass=1/(p+f),0==this.m_enableMotor&&(this.m_motorImpulse=0),this.m_enableLimit){var _=s.m_sweep.a-o.m_sweep.a-this.m_referenceAngle;n.Abs(this.m_upperAngle-this.m_lowerAngle)<2*t.b2_angularSlop?this.m_limitState=y.e_equalLimits:_<=this.m_lowerAngle?(this.m_limitState!=y.e_atLowerLimit&&(this.m_impulse.z=0),this.m_limitState=y.e_atLowerLimit):_>=this.m_upperAngle?(this.m_limitState!=y.e_atUpperLimit&&(this.m_impulse.z=0),this.m_limitState=y.e_atUpperLimit):(this.m_limitState=y.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=y.e_inactiveLimit;if(e.warmStarting){this.m_impulse.x*=e.dtRatio,this.m_impulse.y*=e.dtRatio,this.m_motorImpulse*=e.dtRatio;var d=this.m_impulse.x,v=this.m_impulse.y;o.m_linearVelocity.x-=m*d,o.m_linearVelocity.y-=m*v,o.m_angularVelocity-=p*(a*v-l*d+this.m_motorImpulse+this.m_impulse.z),s.m_linearVelocity.x+=u*d,s.m_linearVelocity.y+=u*v,s.m_angularVelocity+=f*(h*v-c*d+this.m_motorImpulse+this.m_impulse.z)}else this.m_impulse.SetZero(),this.m_motorImpulse=0},S.prototype.SolveVelocityConstraints=function(t){var e,i=this.m_bodyA,o=this.m_bodyB,s=0,r=0,a=0,l=0,h=0,c=i.m_linearVelocity,m=i.m_angularVelocity,u=o.m_linearVelocity,p=o.m_angularVelocity,f=i.m_invMass,_=o.m_invMass,d=i.m_invI,v=o.m_invI;if(this.m_enableMotor&&this.m_limitState!=y.e_equalLimits){var b=p-m-this.m_motorSpeed,g=this.m_motorMass*-b,x=this.m_motorImpulse,w=t.dt*this.m_maxMotorTorque;this.m_motorImpulse=n.Clamp(this.m_motorImpulse+g,-w,w),m-=d*(g=this.m_motorImpulse-x),p+=v*g}if(this.m_enableLimit&&this.m_limitState!=y.e_inactiveLimit){e=i.m_xf.R,r=this.m_localAnchor1.x-i.m_sweep.localCenter.x,a=this.m_localAnchor1.y-i.m_sweep.localCenter.y,s=e.col1.x*r+e.col2.x*a,a=e.col1.y*r+e.col2.y*a,r=s,e=o.m_xf.R,l=this.m_localAnchor2.x-o.m_sweep.localCenter.x,h=this.m_localAnchor2.y-o.m_sweep.localCenter.y,s=e.col1.x*l+e.col2.x*h,h=e.col1.y*l+e.col2.y*h,l=s;var C=u.x+-p*h-c.x- -m*a,S=u.y+p*l-c.y-m*r,A=p-m;this.m_mass.Solve33(this.impulse3,-C,-S,-A),this.m_limitState==y.e_equalLimits?this.m_impulse.Add(this.impulse3):this.m_limitState==y.e_atLowerLimit?this.m_impulse.z+this.impulse3.z<0&&(this.m_mass.Solve22(this.reduced,-C,-S),this.impulse3.x=this.reduced.x,this.impulse3.y=this.reduced.y,this.impulse3.z=-this.m_impulse.z,this.m_impulse.x+=this.reduced.x,this.m_impulse.y+=this.reduced.y,this.m_impulse.z=0):this.m_limitState==y.e_atUpperLimit&&this.m_impulse.z+this.impulse3.z>0&&(this.m_mass.Solve22(this.reduced,-C,-S),this.impulse3.x=this.reduced.x,this.impulse3.y=this.reduced.y,this.impulse3.z=-this.m_impulse.z,this.m_impulse.x+=this.reduced.x,this.m_impulse.y+=this.reduced.y,this.m_impulse.z=0),c.x-=f*this.impulse3.x,c.y-=f*this.impulse3.y,m-=d*(r*this.impulse3.y-a*this.impulse3.x+this.impulse3.z),u.x+=_*this.impulse3.x,u.y+=_*this.impulse3.y,p+=v*(l*this.impulse3.y-h*this.impulse3.x+this.impulse3.z)}else{e=i.m_xf.R,r=this.m_localAnchor1.x-i.m_sweep.localCenter.x,a=this.m_localAnchor1.y-i.m_sweep.localCenter.y,s=e.col1.x*r+e.col2.x*a,a=e.col1.y*r+e.col2.y*a,r=s,e=o.m_xf.R,l=this.m_localAnchor2.x-o.m_sweep.localCenter.x,h=this.m_localAnchor2.y-o.m_sweep.localCenter.y,s=e.col1.x*l+e.col2.x*h,h=e.col1.y*l+e.col2.y*h,l=s;var M=u.x+-p*h-c.x- -m*a,D=u.y+p*l-c.y-m*r;this.m_mass.Solve22(this.impulse2,-M,-D),this.m_impulse.x+=this.impulse2.x,this.m_impulse.y+=this.impulse2.y,c.x-=f*this.impulse2.x,c.y-=f*this.impulse2.y,m-=d*(r*this.impulse2.y-a*this.impulse2.x),u.x+=_*this.impulse2.x,u.y+=_*this.impulse2.y,p+=v*(l*this.impulse2.y-h*this.impulse2.x)}i.m_linearVelocity.SetV(c),i.m_angularVelocity=m,o.m_linearVelocity.SetV(u),o.m_angularVelocity=p},S.prototype.SolvePositionConstraints=function(e){var i,o,s=0,r=this.m_bodyA,a=this.m_bodyB,l=0,h=0,c=0,m=0;if(this.m_enableLimit&&this.m_limitState!=y.e_inactiveLimit){var u=a.m_sweep.a-r.m_sweep.a-this.m_referenceAngle,p=0;this.m_limitState==y.e_equalLimits?(s=n.Clamp(u-this.m_lowerAngle,-t.b2_maxAngularCorrection,t.b2_maxAngularCorrection),p=-this.m_motorMass*s,l=n.Abs(s)):this.m_limitState==y.e_atLowerLimit?(l=-(s=u-this.m_lowerAngle),s=n.Clamp(s+t.b2_angularSlop,-t.b2_maxAngularCorrection,0),p=-this.m_motorMass*s):this.m_limitState==y.e_atUpperLimit&&(l=s=u-this.m_upperAngle,s=n.Clamp(s-t.b2_angularSlop,0,t.b2_maxAngularCorrection),p=-this.m_motorMass*s),r.m_sweep.a-=r.m_invI*p,a.m_sweep.a+=a.m_invI*p,r.SynchronizeTransform(),a.SynchronizeTransform()}i=r.m_xf.R;var f=this.m_localAnchor1.x-r.m_sweep.localCenter.x,_=this.m_localAnchor1.y-r.m_sweep.localCenter.y;h=i.col1.x*f+i.col2.x*_,_=i.col1.y*f+i.col2.y*_,f=h,i=a.m_xf.R;var d=this.m_localAnchor2.x-a.m_sweep.localCenter.x,v=this.m_localAnchor2.y-a.m_sweep.localCenter.y;h=i.col1.x*d+i.col2.x*v,v=i.col1.y*d+i.col2.y*v,d=h;var b=a.m_sweep.c.x+d-r.m_sweep.c.x-f,g=a.m_sweep.c.y+v-r.m_sweep.c.y-_,x=b*b+g*g;o=Math.sqrt(x);var w=r.m_invMass,C=a.m_invMass,A=r.m_invI,M=a.m_invI,D=10*t.b2_linearSlop;if(x>D*D){var k=1/(w+C);c=k*-b,m=k*-g;var B=.5;r.m_sweep.c.x-=B*w*c,r.m_sweep.c.y-=B*w*m,a.m_sweep.c.x+=B*C*c,a.m_sweep.c.y+=B*C*m,b=a.m_sweep.c.x+d-r.m_sweep.c.x-f,g=a.m_sweep.c.y+v-r.m_sweep.c.y-_}return this.K1.col1.x=w+C,this.K1.col2.x=0,this.K1.col1.y=0,this.K1.col2.y=w+C,this.K2.col1.x=A*_*_,this.K2.col2.x=-A*f*_,this.K2.col1.y=-A*f*_,this.K2.col2.y=A*f*f,this.K3.col1.x=M*v*v,this.K3.col2.x=-M*d*v,this.K3.col1.y=-M*d*v,this.K3.col2.y=M*d*d,this.K.SetM(this.K1),this.K.AddM(this.K2),this.K.AddM(this.K3),this.K.Solve(S.tImpulse,-b,-g),c=S.tImpulse.x,m=S.tImpulse.y,r.m_sweep.c.x-=r.m_invMass*c,r.m_sweep.c.y-=r.m_invMass*m,r.m_sweep.a-=r.m_invI*(f*m-_*c),a.m_sweep.c.x+=a.m_invMass*c,a.m_sweep.c.y+=a.m_invMass*m,a.m_sweep.a+=a.m_invI*(d*m-v*c),r.SynchronizeTransform(),a.SynchronizeTransform(),o<=t.b2_linearSlop&&l<=t.b2_angularSlop},bt.postDefs.push(function(){bt.Dynamics.Joints.b2RevoluteJoint.tImpulse=new o}),bt.inherit(A,bt.Dynamics.Joints.b2JointDef),A.prototype.__super=bt.Dynamics.Joints.b2JointDef.prototype,A.b2RevoluteJointDef=function(){bt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.localAnchorA=new o,this.localAnchorB=new o},A.prototype.b2RevoluteJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_revoluteJoint,this.localAnchorA.Set(0,0),this.localAnchorB.Set(0,0),this.referenceAngle=0,this.lowerAngle=0,this.upperAngle=0,this.maxMotorTorque=0,this.motorSpeed=0,this.enableLimit=!1,this.enableMotor=!1},A.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.localAnchorA=this.bodyA.GetLocalPoint(i),this.localAnchorB=this.bodyB.GetLocalPoint(i),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},bt.inherit(M,bt.Dynamics.Joints.b2Joint),M.prototype.__super=bt.Dynamics.Joints.b2Joint.prototype,M.b2WeldJoint=function(){bt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_localAnchorA=new o,this.m_localAnchorB=new o,this.m_impulse=new s,this.m_mass=new i},M.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA)},M.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB)},M.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new o(t*this.m_impulse.x,t*this.m_impulse.y)},M.prototype.GetReactionTorque=function(t){return void 0===t&&(t=0),t*this.m_impulse.z},M.prototype.b2WeldJoint=function(t){this.__super.b2Joint.call(this,t),this.m_localAnchorA.SetV(t.localAnchorA),this.m_localAnchorB.SetV(t.localAnchorB),this.m_referenceAngle=t.referenceAngle,this.m_impulse.SetZero(),this.m_mass=new i},M.prototype.InitVelocityConstraints=function(t){var e,i=0,n=this.m_bodyA,o=this.m_bodyB;e=n.m_xf.R;var s=this.m_localAnchorA.x-n.m_sweep.localCenter.x,r=this.m_localAnchorA.y-n.m_sweep.localCenter.y;i=e.col1.x*s+e.col2.x*r,r=e.col1.y*s+e.col2.y*r,s=i,e=o.m_xf.R;var a=this.m_localAnchorB.x-o.m_sweep.localCenter.x,l=this.m_localAnchorB.y-o.m_sweep.localCenter.y;i=e.col1.x*a+e.col2.x*l,l=e.col1.y*a+e.col2.y*l,a=i;var h=n.m_invMass,c=o.m_invMass,m=n.m_invI,u=o.m_invI;this.m_mass.col1.x=h+c+r*r*m+l*l*u,this.m_mass.col2.x=-r*s*m-l*a*u,this.m_mass.col3.x=-r*m-l*u,this.m_mass.col1.y=this.m_mass.col2.x,this.m_mass.col2.y=h+c+s*s*m+a*a*u,this.m_mass.col3.y=s*m+a*u,this.m_mass.col1.z=this.m_mass.col3.x,this.m_mass.col2.z=this.m_mass.col3.y,this.m_mass.col3.z=m+u,t.warmStarting?(this.m_impulse.x*=t.dtRatio,this.m_impulse.y*=t.dtRatio,this.m_impulse.z*=t.dtRatio,n.m_linearVelocity.x-=h*this.m_impulse.x,n.m_linearVelocity.y-=h*this.m_impulse.y,n.m_angularVelocity-=m*(s*this.m_impulse.y-r*this.m_impulse.x+this.m_impulse.z),o.m_linearVelocity.x+=c*this.m_impulse.x,o.m_linearVelocity.y+=c*this.m_impulse.y,o.m_angularVelocity+=u*(a*this.m_impulse.y-l*this.m_impulse.x+this.m_impulse.z)):this.m_impulse.SetZero()},M.prototype.SolveVelocityConstraints=function(t){var e,i=0,n=this.m_bodyA,o=this.m_bodyB,r=n.m_linearVelocity,a=n.m_angularVelocity,l=o.m_linearVelocity,h=o.m_angularVelocity,c=n.m_invMass,m=o.m_invMass,u=n.m_invI,y=o.m_invI;e=n.m_xf.R;var p=this.m_localAnchorA.x-n.m_sweep.localCenter.x,f=this.m_localAnchorA.y-n.m_sweep.localCenter.y;i=e.col1.x*p+e.col2.x*f,f=e.col1.y*p+e.col2.y*f,p=i,e=o.m_xf.R;var _=this.m_localAnchorB.x-o.m_sweep.localCenter.x,d=this.m_localAnchorB.y-o.m_sweep.localCenter.y;i=e.col1.x*_+e.col2.x*d,d=e.col1.y*_+e.col2.y*d,_=i;var v=l.x-h*d-r.x+a*f,b=l.y+h*_-r.y-a*p,g=h-a,x=new s;this.m_mass.Solve33(x,-v,-b,-g),this.m_impulse.Add(x),r.x-=c*x.x,r.y-=c*x.y,a-=u*(p*x.y-f*x.x+x.z),l.x+=m*x.x,l.y+=m*x.y,h+=y*(_*x.y-d*x.x+x.z),n.m_angularVelocity=a,o.m_angularVelocity=h},M.prototype.SolvePositionConstraints=function(e){var i,o=0,r=this.m_bodyA,a=this.m_bodyB;i=r.m_xf.R;var l=this.m_localAnchorA.x-r.m_sweep.localCenter.x,h=this.m_localAnchorA.y-r.m_sweep.localCenter.y;o=i.col1.x*l+i.col2.x*h,h=i.col1.y*l+i.col2.y*h,l=o,i=a.m_xf.R;var c=this.m_localAnchorB.x-a.m_sweep.localCenter.x,m=this.m_localAnchorB.y-a.m_sweep.localCenter.y;o=i.col1.x*c+i.col2.x*m,m=i.col1.y*c+i.col2.y*m,c=o;var u=r.m_invMass,y=a.m_invMass,p=r.m_invI,f=a.m_invI,_=a.m_sweep.c.x+c-r.m_sweep.c.x-l,d=a.m_sweep.c.y+m-r.m_sweep.c.y-h,v=a.m_sweep.a-r.m_sweep.a-this.m_referenceAngle,b=10*t.b2_linearSlop,g=Math.sqrt(_*_+d*d),x=n.Abs(v);g>b&&(p*=1,f*=1),this.m_mass.col1.x=u+y+h*h*p+m*m*f,this.m_mass.col2.x=-h*l*p-m*c*f,this.m_mass.col3.x=-h*p-m*f,this.m_mass.col1.y=this.m_mass.col2.x,this.m_mass.col2.y=u+y+l*l*p+c*c*f,this.m_mass.col3.y=l*p+c*f,this.m_mass.col1.z=this.m_mass.col3.x,this.m_mass.col2.z=this.m_mass.col3.y,this.m_mass.col3.z=p+f;var w=new s;return this.m_mass.Solve33(w,-_,-d,-v),r.m_sweep.c.x-=u*w.x,r.m_sweep.c.y-=u*w.y,r.m_sweep.a-=p*(l*w.y-h*w.x+w.z),a.m_sweep.c.x+=y*w.x,a.m_sweep.c.y+=y*w.y,a.m_sweep.a+=f*(c*w.y-m*w.x+w.z),r.SynchronizeTransform(),a.SynchronizeTransform(),g<=t.b2_linearSlop&&x<=t.b2_angularSlop},bt.inherit(D,bt.Dynamics.Joints.b2JointDef),D.prototype.__super=bt.Dynamics.Joints.b2JointDef.prototype,D.b2WeldJointDef=function(){bt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.localAnchorA=new o,this.localAnchorB=new o},D.prototype.b2WeldJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_weldJoint,this.referenceAngle=0},D.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.localAnchorA.SetV(this.bodyA.GetLocalPoint(i)),this.localAnchorB.SetV(this.bodyB.GetLocalPoint(i)),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}(),(gt=bt.Dynamics.b2DebugDraw).b2DebugDraw=function(){this.m_drawScale=1,this.m_lineThickness=1,this.m_alpha=1,this.m_fillAlpha=1,this.m_xformScale=1;var t=this;this.m_sprite={graphics:{clear:function(){t.m_ctx.clearRect(0,0,t.m_ctx.canvas.width,t.m_ctx.canvas.height)}}}},gt.prototype._color=function(t,e){return"rgba("+((16711680&t)>>16)+","+((65280&t)>>8)+","+(255&t)+","+e+")"},gt.prototype.b2DebugDraw=function(){this.m_drawFlags=0},gt.prototype.SetFlags=function(t){void 0===t&&(t=0),this.m_drawFlags=t},gt.prototype.GetFlags=function(){return this.m_drawFlags},gt.prototype.AppendFlags=function(t){void 0===t&&(t=0),this.m_drawFlags|=t},gt.prototype.ClearFlags=function(t){void 0===t&&(t=0),this.m_drawFlags&=~t},gt.prototype.SetSprite=function(t){this.m_ctx=t},gt.prototype.GetSprite=function(){return this.m_ctx},gt.prototype.SetDrawScale=function(t){void 0===t&&(t=0),this.m_drawScale=t},gt.prototype.GetDrawScale=function(){return this.m_drawScale},gt.prototype.SetLineThickness=function(t){void 0===t&&(t=0),this.m_lineThickness=t,this.m_ctx.strokeWidth=t},gt.prototype.GetLineThickness=function(){return this.m_lineThickness},gt.prototype.SetAlpha=function(t){void 0===t&&(t=0),this.m_alpha=t},gt.prototype.GetAlpha=function(){return this.m_alpha},gt.prototype.SetFillAlpha=function(t){void 0===t&&(t=0),this.m_fillAlpha=t},gt.prototype.GetFillAlpha=function(){return this.m_fillAlpha},gt.prototype.SetXFormScale=function(t){void 0===t&&(t=0),this.m_xformScale=t},gt.prototype.GetXFormScale=function(){return this.m_xformScale},gt.prototype.DrawPolygon=function(t,e,i){if(e){var n=this.m_ctx,o=this.m_drawScale;n.beginPath(),n.strokeStyle=this._color(i.color,this.m_alpha),n.moveTo(t[0].x*o,t[0].y*o);for(var s=1;s<e;s++)n.lineTo(t[s].x*o,t[s].y*o);n.lineTo(t[0].x*o,t[0].y*o),n.closePath(),n.stroke()}},gt.prototype.DrawSolidPolygon=function(t,e,i){if(e){var n=this.m_ctx,o=this.m_drawScale;n.beginPath(),n.strokeStyle=this._color(i.color,this.m_alpha),n.fillStyle=this._color(i.color,this.m_fillAlpha),n.moveTo(t[0].x*o,t[0].y*o);for(var s=1;s<e;s++)n.lineTo(t[s].x*o,t[s].y*o);n.lineTo(t[0].x*o,t[0].y*o),n.closePath(),n.fill(),n.stroke()}},gt.prototype.DrawCircle=function(t,e,i){if(e){var n=this.m_ctx,o=this.m_drawScale;n.beginPath(),n.strokeStyle=this._color(i.color,this.m_alpha),n.arc(t.x*o,t.y*o,e*o,0,2*Math.PI,!0),n.closePath(),n.stroke()}},gt.prototype.DrawSolidCircle=function(t,e,i,n){if(e){var o=this.m_ctx,s=this.m_drawScale,r=t.x*s,a=t.y*s;o.moveTo(0,0),o.beginPath(),o.strokeStyle=this._color(n.color,this.m_alpha),o.fillStyle=this._color(n.color,this.m_fillAlpha),o.arc(r,a,e*s,0,2*Math.PI,!0),o.moveTo(r,a),o.lineTo((t.x+i.x*e)*s,(t.y+i.y*e)*s),o.closePath(),o.fill(),o.stroke()}},gt.prototype.DrawSegment=function(t,e,i){var n=this.m_ctx,o=this.m_drawScale;n.strokeStyle=this._color(i.color,this.m_alpha),n.beginPath(),n.moveTo(t.x*o,t.y*o),n.lineTo(e.x*o,e.y*o),n.closePath(),n.stroke()},gt.prototype.DrawTransform=function(t){var e=this.m_ctx,i=this.m_drawScale;e.beginPath(),e.strokeStyle=this._color(16711680,this.m_alpha),e.moveTo(t.position.x*i,t.position.y*i),e.lineTo((t.position.x+this.m_xformScale*t.R.col1.x)*i,(t.position.y+this.m_xformScale*t.R.col1.y)*i),e.strokeStyle=this._color(65280,this.m_alpha),e.moveTo(t.position.x*i,t.position.y*i),e.lineTo((t.position.x+this.m_xformScale*t.R.col2.x)*i,(t.position.y+this.m_xformScale*t.R.col2.y)*i),e.closePath(),e.stroke()},xt=0;xt<bt.postDefs.length;++xt)bt.postDefs[xt]();var St=bt;St.postDefs;function At(t){return At="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},At(t)}function Mt(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,o,s,r,a=[],l=!0,h=!1;try{if(s=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;l=!1}else for(;!(l=(n=s.call(i)).done)&&(a.push(n.value),a.length!==e);l=!0);}catch(t){h=!0,o=t}finally{try{if(!l&&null!=i.return&&(r=i.return(),Object(r)!==r))return}finally{if(h)throw o}}return a}}(t,e)||kt(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Dt(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=kt(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return r=t.done,t},e:function(t){a=!0,s=t},f:function(){try{r||null==i.return||i.return()}finally{if(a)throw s}}}}function kt(t,e){if(t){if("string"==typeof t)return Bt(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?Bt(t,e):void 0}}function Bt(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function It(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function Vt(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?It(Object(i),!0).forEach(function(e){Pt(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):It(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function Pt(t,e,i){return(e=Lt(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function Tt(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Lt(n.key),n)}}function Lt(t){var e=function(t,e){if("object"!=At(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=At(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==At(e)?e:e+""}var Gt=function(){return function(t,e,i){return e&&Tt(t.prototype,e),i&&Tt(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(e){var i,n,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),e.physicsEnabled){this.engine=e,this.canvas=e.canvas,this.BASE_SCALE=o.scale||30,this.quality=o.quality||1,this.SCALE=this.BASE_SCALE*this.quality;var s=!1===o.gravity||void 0===o.gravity?{x:0,y:0}:{x:null!==(i=o.gravity.x)&&void 0!==i?i:0,y:null!==(n=o.gravity.y)&&void 0!==n?n:9.8*this.SCALE};this.originalConfig=Vt({scale:this.BASE_SCALE,quality:this.quality,gravity:s,sleep:void 0===o.sleep||o.sleep,friction:o.friction||.2,restitution:o.bounce||.2,density:o.density||1,maxVelocity:o.maxVelocity||1e3,velocityIterations:o.velocityIterations||8,positionIterations:o.positionIterations||3},o),this.config=Vt({},this.originalConfig),this.world=new St.Dynamics.b2World(new St.Common.Math.b2Vec2(s.x/this.SCALE,s.y/this.SCALE),this.originalConfig.sleep),this.bodies=new Map,this.velocities=new Map,this.materials=new Map,this._setupContactListener(),this.mouseJoints=new Map,this.draggedBodies=new Map,this.bodyTouchMap=new Map,this.mouseWorld=new St.Common.Math.b2Vec2(0,0),this._setupDragListeners()}},[{key:"update",value:function(t){var e=Math.min(t,20)/1e3;this.world.Step(e,this.config.velocityIterations||8,this.config.positionIterations||3);var i,n=Dt(this.bodies);try{for(n.s();!(i=n.n()).done;){var o=Mt(i.value,2),s=o[0],r=o[1],a=r.GetUserData();if(a){var l=r.GetPosition(),h=r.GetAngle();a.style({x:l.x*this.SCALE-a.width/2,y:l.y*this.SCALE-a.height/2,rotation:180*h/Math.PI});var c=r.GetLinearVelocity();this.velocities.set(s,{x:c.x*this.SCALE,y:c.y*this.SCALE})}}}catch(t){n.e(t)}finally{n.f()}this.world.ClearForces()}},{key:"_setupContactListener",value:function(){var t=this,e=new St.Dynamics.b2ContactListener;e.BeginContact=function(e){var i=e.GetFixtureA().GetBody().GetUserData(),n=e.GetFixtureB().GetBody().GetUserData(),o=new St.Collision.b2WorldManifold;e.GetWorldManifold(o);var s=o.m_points.map(function(e){return{x:e.x*t.SCALE,y:e.y*t.SCALE}}),r={x:o.m_normal.x,y:o.m_normal.y},a=e.GetFixtureA().GetBody(),l=e.GetFixtureB().GetBody(),h=a.GetLinearVelocity(),c=l.GetLinearVelocity(),m={x:(c.x-h.x)*t.SCALE,y:(c.y-h.y)*t.SCALE},u={entityA:i,entityB:n,contact:e,contactPoints:s,normal:r,relativeVelocity:m,type:"start",impactForce:Math.sqrt(m.x*m.x+m.y*m.y),angle:180*Math.atan2(r.y,r.x)/Math.PI};t.engine.trigger("collisions",u),i&&"function"==typeof i.trigger&&i.trigger("collide",Vt(Vt({},u),{},{target:n})),n&&"function"==typeof n.trigger&&n.trigger("collide",Vt(Vt({},u),{},{target:i,normal:{x:-r.x,y:-r.y},relativeVelocity:{x:-m.x,y:-m.y}}))},e.EndContact=function(e){var i=e.GetFixtureA().GetBody().GetUserData(),n=e.GetFixtureB().GetBody().GetUserData();t.engine.trigger("collisionEnd",{entityA:i,entityB:n,contact:e}),i&&"function"==typeof i.trigger&&i.trigger("collideEnd",{target:n,contact:e,type:"end"}),n&&"function"==typeof n.trigger&&n.trigger("collideEnd",{target:i,contact:e,type:"end"})},this.world.SetContactListener(e)}},{key:"addEntity",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=new St.Dynamics.b2BodyDef;switch(e.bodyType){case"static":i.type=St.Dynamics.b2Body.b2_staticBody;break;case"kinematic":i.type=St.Dynamics.b2Body.b2_kinematicBody;break;default:i.type=St.Dynamics.b2Body.b2_dynamicBody}i.position.x=(t.absoluteX+t.width/2)/this.SCALE,i.position.y=(t.absoluteY+t.height/2)/this.SCALE,i.angle=t.styles.rotation*Math.PI/180;var n=this.world.CreateBody(i),o=this._createShape(t),s=new St.Dynamics.b2FixtureDef;if(s.shape=o,e.material&&this.materials.has(e.material)){var r=this.materials.get(e.material);s.density=r.density,s.friction=r.friction,s.restitution=r.restitution}else s.density=e.density||this.config.density,s.friction=e.friction||this.config.friction,s.restitution=e.restitution||this.config.restitution;return e.collision&&(s.filter.categoryBits=e.collision.categoryBits||1,s.filter.maskBits=e.collision.maskBits||65535,s.filter.groupIndex=e.collision.groupIndex||0),n.CreateFixture(s),this.bodies.set(t.id,n),this.velocities.set(t.id,{x:0,y:0}),n.SetUserData(t),n}},{key:"removeEntity",value:function(t){var e=this.bodies.get(t.id);return e&&(this.world.DestroyBody(e),this.bodies.delete(t.id),this.velocities.delete(t.id)),this}},{key:"moveEntity",value:function(t){var e=this;"number"==typeof t&&(t={x:t,y:arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,duration:(arguments.length>2&&void 0!==arguments[2]?arguments[2]:0)||0,easing:arguments.length>3&&void 0!==arguments[3]?arguments[3]:"linear"});var i=Vt({x:0,y:0,duration:0,easing:"linear",relative:!1,onUpdate:null,onComplete:null},t),n=i.entity;if(!n||!this.engine.isEntity(n))throw new Error("Entity is required");var o=this.bodies.get(n.id);if(!o)return!1;try{var s,r=function(){return o.GetType()===St.Dynamics.b2Body.b2_staticBody&&(o.SetType(St.Dynamics.b2Body.b2_kinematicBody),!0)},a=function(t){t&&o.SetType(St.Dynamics.b2Body.b2_staticBody),o.SetAwake(!0)},l=o.GetPosition(),h={x:l.x*this.SCALE,y:l.y*this.SCALE},c={x:i.x,y:i.y};if(i.relative&&(c.x+=h.x,c.y+=h.y),!i.duration){var m,u=new St.Common.Math.b2Vec2(c.x/this.SCALE,c.y/this.SCALE),y=r();return o.SetPosition(u),a(y),null===(m=i.onComplete)||void 0===m||m.call(i,n),!0}var p=performance.now(),f=0,_=0,d=c.x-h.x,v=c.y-h.y,b="function"==typeof i.easing?i.easing:(null===(s=this.engine.Ease)||void 0===s?void 0:s[i.easing])||this.engine.Ease.linear,g=function(t){var s;if(!e.engine.running)return 0===f&&(f=t),void requestAnimationFrame(g);0!==f&&(_+=t-f,f=0);var l=t-_-p;if(l>=i.duration){var m,u=new St.Common.Math.b2Vec2(c.x/e.SCALE,c.y/e.SCALE),y=r();return o.SetPosition(u),a(y),void(null===(m=i.onComplete)||void 0===m||m.call(i,n))}var x=l/i.duration,w=b(x),C=new St.Common.Math.b2Vec2((h.x+d*w)/e.SCALE,(h.y+v*w)/e.SCALE),S=r();o.SetPosition(C),a(S),null===(s=i.onUpdate)||void 0===s||s.call(i,n,w),requestAnimationFrame(g)};return requestAnimationFrame(g),!0}catch(t){return this.engine.warn("Error moving entity:",t),!1}}},{key:"_createShape",value:function(t){var e=this;switch(t.styles.shape){case"circle":return new St.Collision.Shapes.b2CircleShape(Math.min(t.width,t.height)/2/this.SCALE);case"triangle":var i=new St.Collision.Shapes.b2PolygonShape,n=[new St.Common.Math.b2Vec2(0,-t.height/2/this.SCALE),new St.Common.Math.b2Vec2(t.width/2/this.SCALE,t.height/2/this.SCALE),new St.Common.Math.b2Vec2(-t.width/2/this.SCALE,t.height/2/this.SCALE)];return i.SetAsArray(n,n.length),i;case"star":for(var o=new St.Collision.Shapes.b2PolygonShape,s=t.styles.spikes||5,r=.99*(Math.min(t.width,t.height)/2/this.SCALE),a=[],l=2*s,h=0;h<l;h++){var c=2*h*Math.PI/l-Math.PI/2;a.push(new St.Common.Math.b2Vec2(Math.cos(c)*r,Math.sin(c)*r))}try{for(var m=[],u=0;u<8;u++){var y=2*u*Math.PI/8-Math.PI/2;m.push(new St.Common.Math.b2Vec2(Math.cos(y)*r,Math.sin(y)*r))}return o.SetAsArray(m,m.length),o}catch(t){return this.engine.warn("Creating circle shape as fallback for star"),new St.Collision.Shapes.b2CircleShape(r)}case"polygon":if(t.collision.points&&t.collision.points.length>=3){var p=new St.Collision.Shapes.b2PolygonShape,f=t.collision.points.map(function(t){return new St.Common.Math.b2Vec2(t.x/e.SCALE,t.y/e.SCALE)});try{var _=f.reduce(function(t,e,i){var n=f[(i+1)%f.length];return t+(n.x-e.x)*(n.y+e.y)},0);return _>0&&f.reverse(),p.SetAsArray(f,f.length),p}catch(e){return this.engine.warn("Failed to create polygon shape, falling back to rectangle"),this._createRectangleShape(t)}}return this._createRectangleShape(t);default:return this._createRectangleShape(t)}}},{key:"_createRectangleShape",value:function(t){var e=new St.Collision.Shapes.b2PolygonShape;return e.SetAsBox(t.width/2/this.SCALE,t.height/2/this.SCALE),e}},{key:"createMaterial",value:function(t,e){var i,n,o;return this.materials.set(t,{friction:null!==(i=e.friction)&&void 0!==i?i:this.config.friction,restitution:null!==(n=e.restitution)&&void 0!==n?n:this.config.restitution,density:null!==(o=e.density)&&void 0!==o?o:this.config.density}),this}},{key:"getMaterial",value:function(t){return this.materials.get(t)}},{key:"applyForce",value:function(t,e){var i;t=this.engine.isEntity(t)?null===(i=t)||void 0===i?void 0:i.id:t;var n=this.bodies.get(t);if(n){var o=n.GetWorldCenter();n.ApplyForce(new St.Common.Math.b2Vec2(e.x,e.y),o)}return this}},{key:"setVelocity",value:function(t,e){var i;t=this.engine.isEntity(t)?null===(i=t)||void 0===i?void 0:i.id:t;var n=this.bodies.get(t);return n&&n.SetLinearVelocity(new St.Common.Math.b2Vec2(e.x/this.SCALE,e.y/this.SCALE)),this}},{key:"setVelocityLimit",value:function(t,e){var i;t=this.engine.isEntity(t)?null===(i=t)||void 0===i?void 0:i.id:t;var n=this.bodies.get(t);return n&&n.SetLinearVelocity({x:Math.min(Math.max(n.GetLinearVelocity().x,-e),e),y:Math.min(Math.max(n.GetLinearVelocity().y,-e),e)}),this}},{key:"setGravity",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;!1===t&&(t=0,e=0),this.world.SetGravity(new St.Common.Math.b2Vec2(t/this.SCALE,e/this.SCALE));var i,n=Dt(this.bodies);try{for(n.s();!(i=n.n()).done;){var o=Mt(i.value,2)[1];o.GetType()!==St.Dynamics.b2Body.b2_staticBody&&this.applyImpulse(o.GetUserData(),{x:1e-4,y:1e-4})}}catch(t){n.e(t)}finally{n.f()}return this}},{key:"getBodyVelocity",value:function(t){var e;return t=this.engine.isEntity(t)?null===(e=t)||void 0===e?void 0:e.id:t,this.velocities.get(t)}},{key:"setAngularVelocity",value:function(t,e){var i;t=this.engine.isEntity(t)?null===(i=t)||void 0===i?void 0:i.id:t;var n=this.bodies.get(t);return n&&n.SetAngularVelocity(e),this}},{key:"applyTorque",value:function(t,e){var i;t=this.engine.isEntity(t)?null===(i=t)||void 0===i?void 0:i.id:t;var n=this.bodies.get(t);return n&&n.ApplyTorque(e),this}},{key:"applyImpulse",value:function(t,e){var i,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;t=this.engine.isEntity(t)?null===(i=t)||void 0===i?void 0:i.id:t;var o=this.bodies.get(t);if(o){var s=n?new St.Common.Math.b2Vec2(n.x/this.SCALE,n.y/this.SCALE):o.GetWorldCenter();o.ApplyImpulse(new St.Common.Math.b2Vec2(e.x,e.y),s)}return this}},{key:"isBodyAwake",value:function(t){var e;t=this.engine.isEntity(t)?null===(e=t)||void 0===e?void 0:e.id:t;var i=this.bodies.get(t);return!!i&&i.IsAwake()}},{key:"setBodyAwake",value:function(t,e){var i;t=this.engine.isEntity(t)?null===(i=t)||void 0===i?void 0:i.id:t;var n=this.bodies.get(t);return n&&n.SetAwake(e),this}},{key:"setBodyProperties",value:function(t,e){var i;t=this.engine.isEntity(t)?null===(i=t)||void 0===i?void 0:i.id:t;var n=this.bodies.get(t);if(n){var o=n.GetFixtureList();o&&(void 0!==e.friction&&o.SetFriction(e.friction),void 0!==e.restitution&&o.SetRestitution(e.restitution),void 0!==e.density&&(o.SetDensity(e.density),n.ResetMassData()))}return this}},{key:"_setupDragListeners",value:function(){var t=this,e=null,i=0,n={x:0,y:0},o="mouse",s=function(t,e,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s={x:i.x,y:i.y,worldX:i.x,worldY:i.y,screenX:t,screenY:e,timestamp:Date.now()};return null!==n&&(s.identifier=n),null!==o&&(s.target=o),s};this.engine.on("mousedown",function(e){if(t.engine.running)for(var i=t.canvas.getBoundingClientRect(),n=e.screenX-i.left,r=e.screenY-i.top,a={x:e.worldX,y:e.worldY},l=0,h=Array.from(t.bodies.entries());l<h.length;l++){var c=Mt(h[l],2),m=(c[0],c[1].GetUserData());if(m&&m.events.draggable&&t._isPointInEntity(n,r,m)){t._startDrag(m,a.x,a.y,o),m.trigger("drag",s(n,r,a,o,m));break}}}),this.engine.on("mousemove",function(i){if(t.engine.running){for(var n=t.canvas.getBoundingClientRect(),r=i.screenX-n.left,a=i.screenY-n.top,l={x:i.worldX,y:i.worldY},h=null,c=0,m=Array.from(t.bodies.entries());c<m.length;c++){var u=Mt(m[c],2),y=(u[0],u[1].GetUserData());if(y&&y.events.hoverable&&t._isPointInEntity(r,a,y)){h=y;break}}if(h!==e&&(e&&e.trigger("hoverOut",s(r,a,l,null,e)),h&&h.trigger("hover",s(r,a,l,null,h)),e=h),t.mouseJoints.has(o)){var p=t.draggedBodies.get(o);p&&p.entity&&p.entity.events.draggable&&(t._updateDrag(l.x,l.y,o),p.entity.trigger("dragMove",s(r,a,l,o,p.entity)))}}}),this.engine.on("mouseup",function(e){if(t.engine.running){var i=t.canvas.getBoundingClientRect(),n=e.screenX-i.left,r=e.screenY-i.top,a={x:e.worldX,y:e.worldY};if(t.mouseJoints.has(o)){var l=t.draggedBodies.get(o);l&&l.entity&&l.entity.trigger("drop",s(n,r,a,o,l.entity)),t._endDrag(o)}}}),this.engine.on("touchstart",function(e){if(t.engine.running){i=Date.now();var o=t.canvas.getBoundingClientRect(),r=e.screenX-o.left,a=e.screenY-o.top,l={x:e.worldX,y:e.worldY};n={x:r,y:a};var h,c=Array.from(t.bodies.entries()).filter(function(e){var i=Mt(e,2),n=i[0];i[1];return!t.bodyTouchMap.has(n)}),m=Dt(c);try{for(m.s();!(h=m.n()).done;){var u=Mt(h.value,2),y=(u[0],u[1].GetUserData());if(y&&y.events.draggable&&t._isPointInEntity(r,a,y)){t._startDrag(y,l.x,l.y,e.identifier),y.trigger("drag",s(r,a,l,e.identifier,y));break}}}catch(t){m.e(t)}finally{m.f()}}}),this.engine.on("touchmove",function(e){if(t.engine.running){var i=t.canvas.getBoundingClientRect(),n=e.screenX-i.left,o=e.screenY-i.top,r={x:e.worldX,y:e.worldY};if(t.mouseJoints.has(e.identifier)){var a=t.draggedBodies.get(e.identifier);a&&a.entity&&(t._updateDrag(r.x,r.y,e.identifier),a.entity.trigger("dragMove",s(n,o,r,e.identifier,a.entity)))}}}),this.engine.on("touchend",function(e){if(t.engine.running){var o=Date.now(),r=t.canvas.getBoundingClientRect(),a=e.screenX-r.left,l=e.screenY-r.top,h={x:e.worldX,y:e.worldY},c=a-n.x,m=l-n.y;if(Math.sqrt(c*c+m*m)<10&&o-i<200)for(var u=0,y=Array.from(t.bodies.entries());u<y.length;u++){var p=Mt(y[u],2),f=(p[0],p[1].GetUserData());if(f&&f.events.clickable&&t._isPointInEntity(a,l,f)){f.trigger("click",s(a,l,h,null,f));break}}if(t.mouseJoints.has(e.identifier)){var _=t.draggedBodies.get(e.identifier);_&&_.entity&&_.entity.trigger("drop",s(a,l,h,e.identifier,_.entity)),t._endDrag(e.identifier)}}}),this.engine.on("touchcancel",function(e){if(t.engine.running){var i=t.canvas.getBoundingClientRect(),n=e.screenX-i.left,o=e.screenY-i.top,r={x:e.worldX,y:e.worldY};if(t.mouseJoints.has(e.identifier)){var a=t.draggedBodies.get(e.identifier);a&&a.entity&&a.entity.trigger("drop",s(n,o,r,e.identifier,a.entity)),t._endDrag(e.identifier)}}})}},{key:"_startDrag",value:function(t,e,i,n){var o=this.bodies.get(t.id);if(o&&!this.mouseJoints.has(n)&&!this.bodyTouchMap.has(t.id)){var s=o.GetType();s!==St.Dynamics.b2Body.b2_dynamicBody&&o.SetType(St.Dynamics.b2Body.b2_dynamicBody);var r=new St.Common.Math.b2Vec2(e/this.SCALE,i/this.SCALE),a=new St.Dynamics.Joints.b2MouseJointDef,l=this.world.CreateBody(new St.Dynamics.b2BodyDef);a.bodyA=l,a.bodyB=o,a.target.Set(r.x,r.y),a.maxForce=1e3*o.GetMass(),a.collideConnected=!0,a.dampingRatio=.5,a.frequencyHz=5;var h=this.world.CreateJoint(a);this.mouseJoints.set(n,h),this.draggedBodies.set(n,{body:o,entity:t,originalType:s}),this.bodyTouchMap.set(t.id,n),o.SetAngularDamping(.1),o.SetLinearDamping(.1),o.SetFixedRotation(!0),t.halt(),"function"==typeof t.trigger&&t.trigger("drag",{x:e,y:i,identifier:n})}}},{key:"_updateDrag",value:function(t,e,i){var n=this.mouseJoints.get(i),o=this.draggedBodies.get(i);if(n&&o){var s=new St.Common.Math.b2Vec2(t/this.SCALE,e/this.SCALE);n.SetTarget(s);o.body;var r=o.entity;"function"==typeof r.trigger&&r.trigger("dragMove",{x:t,y:e,identifier:i})}}},{key:"_endDrag",value:function(t){var e=this.mouseJoints.get(t),i=this.draggedBodies.get(t);if(e&&i){var n=i.body,o=i.entity,s=i.originalType;if(n.SetFixedRotation(!1),n.SetAngularDamping(.1),n.SetLinearDamping(.1),s===St.Dynamics.b2Body.b2_kinematicBody&&(n.SetLinearVelocity(new St.Common.Math.b2Vec2(0,0)),n.SetAngularVelocity(0)),s!==St.Dynamics.b2Body.b2_dynamicBody&&n.SetType(s),"function"==typeof o.trigger){var r=n.GetPosition();o.trigger("drop",{x:r.x*this.SCALE,y:r.y*this.SCALE,identifier:t})}this.world.DestroyJoint(e),this.mouseJoints.delete(t),this.draggedBodies.delete(t),this.bodyTouchMap.delete(o.id)}}},{key:"_isPointInEntity",value:function(t,e,i){var n=this.bodies.get(i.id);if(!n)return!1;for(var o=i.engine.camera.screenToWorld(t,e),s=new St.Common.Math.b2Vec2(o.x/this.SCALE,o.y/this.SCALE),r=n.GetFixtureList();r;){if(r.TestPoint(s))return!0;r=r.GetNext()}return!1}},{key:"reset",value:function(){try{var t,e=Dt(this.mouseJoints);try{for(e.s();!(t=e.n()).done;){var i=Mt(t.value,2),n=(i[0],i[1]);this.world.DestroyJoint(n)}}catch(t){e.e(t)}finally{e.f()}this.mouseJoints.clear(),this.draggedBodies.clear(),this.bodyTouchMap.clear();var o,s=Dt(this.bodies);try{for(s.s();!(o=s.n()).done;){var r=Mt(o.value,2),a=r[0],l=r[1];pixalo.find(a).halt(),this.world.DestroyBody(l)}}catch(t){s.e(t)}finally{s.f()}return this.bodies.clear(),this.velocities.clear(),this.materials.clear(),this.world=new St.Dynamics.b2World(new St.Common.Math.b2Vec2(this.originalConfig.gravity.x/this.SCALE,this.originalConfig.gravity.y/this.SCALE),this.originalConfig.sleep),this.config={friction:this.originalConfig.friction,restitution:this.originalConfig.restitution,density:this.originalConfig.density,maxVelocity:this.originalConfig.maxVelocity,velocityIterations:this.originalConfig.velocityIterations,positionIterations:this.originalConfig.positionIterations},this.BASE_SCALE=this.originalConfig.scale,this.quality=this.originalConfig.quality,this.SCALE=this.BASE_SCALE*this.quality,this.mouseWorld.Set(0,0),this._setupContactListener(),this.engine&&"function"==typeof this.engine.trigger&&this.engine.trigger("physicsReset",{timestamp:Date.now(),config:this.originalConfig}),this}catch(t){return this.engine&&"function"==typeof this.engine.error&&this.engine.error("Error during physics reset:",t),!1}}}])}();const Et=Gt;function Ft(t){return Ft="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Ft(t)}function Rt(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=Nt(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return r=t.done,t},e:function(t){a=!0,s=t},f:function(){try{r||null==i.return||i.return()}finally{if(a)throw s}}}}function Ot(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function Jt(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Ot(Object(i),!0).forEach(function(e){zt(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Ot(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function zt(t,e,i){return(e=Yt(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function jt(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,o,s,r,a=[],l=!0,h=!1;try{if(s=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;l=!1}else for(;!(l=(n=s.call(i)).done)&&(a.push(n.value),a.length!==e);l=!0);}catch(t){h=!0,o=t}finally{try{if(!l&&null!=i.return&&(r=i.return(),Object(r)!==r))return}finally{if(h)throw o}}return a}}(t,e)||Nt(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Nt(t,e){if(t){if("string"==typeof t)return Xt(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?Xt(t,e):void 0}}function Xt(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function Wt(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Yt(n.key),n)}}function Yt(t){var e=function(t,e){if("object"!=Ft(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=Ft(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==Ft(e)?e:e+""}var qt=function(){return function(t,e,i){return e&&Wt(t.prototype,e),i&&Wt(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.engine=e,this.layers=new Map,this.tiles=new Map,this.defaultTileSize=32,this.activeCollisions=new Map,this.animatedTiles=new Map},[{key:"create",value:function(t){var e=t.layers,i=t.tiles;this.tiles.clear();for(var n=0,o=Object.entries(i);n<o.length;n++){var s=jt(o[n],2),r=s[0],a=s[1];"string"==typeof a?this.tiles.set(r,{tile:a,type:"default"}):this.tiles.set(r,Jt(Jt({},a),{},{tile:a.tile,collision:a.collision||null}))}return this.layers=this.parseLayers(e),this._initializeTileAnimations({tiles:this.tiles}),{layers:this.layers,tiles:this.tiles}}},{key:"_checkCollisions",value:function(t){var e;if(null!==(e=t.collision)&&void 0!==e&&e.enabled){t.previousX=t.absoluteX,t.previousY=t.absoluteY;for(var i=this.defaultTileSize,n=i/2,o={left:Math.floor((t.absoluteX-n)/i),top:Math.floor((t.absoluteY-n)/i),right:Math.ceil((t.absoluteX+t.width+n)/i),bottom:Math.ceil((t.absoluteY+t.height+n)/i)},s=new Map,r=null,a=o.top;a<=o.bottom;a++)for(var l=o.left;l<=o.right;l++){var h,c=Rt(this.getTilesAt(l*i,a*i));try{for(c.s();!(h=c.n()).done;){var m=h.value;if(m.config.collision){var u=this._checkTileCollision(t,m,l*i,a*i);if(null!=u&&u.collides){var y="".concat(t.id,"_").concat(l,"_").concat(a,"_").concat(m.layer);switch(m.config.collision.type){case"solid":r=Jt(Jt({},u),{},{tile:m,x:l*i,y:a*i});break;case"platform":"bottom"===u.side&&t.style({y:a*i-t.height/2})}s.set(y,{entity:t,tile:m,x:l,y:a,layer:m.layer,time:performance.now(),side:u.side,amount:u.amount}),this.activeCollisions.has(y)&&this.activeCollisions.get(y).side===u.side||!m.config.collision.onCollide||m.config.collision.onCollide({entity:t,tile:m.config,position:{x:l*i,y:a*i},layer:m.layer,collisionType:m.config.collision.type,side:u.side,amount:u.amount})}}}}catch(t){c.e(t)}finally{c.f()}}if(r)switch(r.side){case"left":t.move({x:-r.amount,relative:!0});break;case"right":t.move({x:r.amount,relative:!0});break;case"top":t.move({y:-r.amount,relative:!0});break;case"bottom":t.move({y:r.amount,relative:!0})}var p,f=Rt(this.activeCollisions);try{for(f.s();!(p=f.n()).done;){var _=jt(p.value,2),d=_[0],v=_[1];if(!s.has(d)){var b=v.tile;b.config.collision.onCollisionEnd&&b.config.collision.onCollisionEnd({entity:v.entity,tile:b.config,position:{x:v.x*i,y:v.y*i},layer:v.layer})}}}catch(t){f.e(t)}finally{f.f()}this.activeCollisions=s}}},{key:"_checkTileCollision",value:function(t,e,i,n){var o=e.config.collision.bounds||[0,0,this.defaultTileSize,this.defaultTileSize],s={x:i+o[0],y:n+o[1],width:o[2],height:o[3]},r={x:t.absoluteX,y:t.absoluteY,width:t.width,height:t.height};switch(e.config.collision.type){case"platform":var a=r.y+r.height,l=t.previousY+r.height,h=s.y;return l<=h&&a>=h?{collides:!0,side:"bottom",amount:a-h}:{collides:!1};case"trigger":var c=this._getOverlap(r,s);return c.collides?Jt(Jt({},c),{},{isTrigger:!0}):{collides:!1};default:return this._getOverlap(r,s)}}},{key:"_getOverlap",value:function(t,e){var i=t.x+t.width>e.x&&t.x<e.x+e.width,n=t.y+t.height>e.y&&t.y<e.y+e.height;if(!i||!n)return{collides:!1};var o=[{side:"left",amount:t.x+t.width-e.x},{side:"right",amount:e.x+e.width-t.x},{side:"top",amount:t.y+t.height-e.y},{side:"bottom",amount:e.y+e.height-t.y}].reduce(function(t,e){return e.amount<t.amount?e:t});return{collides:!0,side:o.side,amount:o.amount}}},{key:"update",value:function(){if(this.engine.collisionEnabled){var t,e=Rt(this.engine.entities);try{for(e.s();!(t=e.n()).done;){var i,n=jt(t.value,2),o=(n[0],n[1]);null!==(i=o.collision)&&void 0!==i&&i.enabled&&this._checkCollisions(o)}}catch(t){e.e(t)}finally{e.f()}this._updateAnimatedTiles()}}},{key:"_updateAnimatedTiles",value:function(){var t,e=performance.now(),i=Rt(this.animatedTiles);try{for(i.s();!(t=i.n()).done;){var n=jt(t.value,2),o=(n[0],n[1]);if(o.frames&&!(o.frames.length<=1)){var s=1e3/o.frameRate;e-o.lastFrameTime>=s&&(o.loop?o.currentFrame=(o.currentFrame+1)%o.frames.length:o.currentFrame<o.frames.length-1&&o.currentFrame++,o.lastFrameTime=e)}}}catch(t){i.e(t)}finally{i.f()}}},{key:"render",value:function(t){var e=this.engine.ctx,i=this.engine.camera,n=this.defaultTileSize,o=Math.floor(i.x),s=Math.floor(i.y),r=this.engine.baseWidth/i.zoom,a=this.engine.baseHeight/i.zoom,l=Math.floor(o/n)-1,h=Math.floor(s/n)-1,c=Math.ceil((o+r)/n)+1,m=Math.ceil((s+a)/n)+1;e.imageSmoothingEnabled=!1;var u,y=Rt(t.layers);try{for(y.s();!(u=y.n()).done;)for(var p=jt(u.value,2),f=(p[0],p[1]),_=Math.max(0,h),d=Math.min(f.length,m),v=_;v<d;v++){var b=f[v];if(b)for(var g=Math.max(0,l),x=Math.min(b.length,c),w=g;w<x;w++){var C,S=b[w];if(S){var A=t.tiles.get(S);A&&(A.parts?this._renderCompositeTile(e,Jt(Jt({},A),{},{symbol:S}),w,v,n,1):this._renderSingleTile(e,Jt(Jt({},A),{},{symbol:S}),w,v,n,1),null!==(C=this.engine.debugger)&&void 0!==C&&C.active&&A.collision&&this._renderTileDebug(e,A,w,v,n))}}}}catch(t){y.e(t)}finally{y.f()}}},{key:"_renderTileDebug",value:function(t,e,i,n,o){t.save();var s=jt(e.collision.bounds||[0,0,o,o],4),r=s[0],a=s[1],l=s[2],h=s[3],c=i*o+r,m=n*o+a;t.strokeStyle="rgba(255, 0, 0, 0.5)",t.fillStyle="rgba(255, 0, 0, 0.2)",t.lineWidth=1,t.beginPath(),t.rect(c,m,l,h),t.stroke(),t.fill(),e.collision.type&&(t.fillStyle="rgba(255, 255, 255, 0.8)",t.font="10px Arial",t.textAlign="left",t.fillText(e.collision.type,c+2,m+12)),t.fillStyle="rgba(255, 255, 0, 0.8)",[[c,m],[c+l,m],[c+l,m+h],[c,m+h]].forEach(function(e){var i=jt(e,2),n=i[0],o=i[1];t.beginPath(),t.arc(n,o,2,0,2*Math.PI),t.fill()}),t.fillStyle="rgba(0, 255, 255, 0.8)",t.beginPath(),t.arc(c+l/2,m+h/2,2,0,2*Math.PI),t.fill(),t.restore()}},{key:"_renderCompositeTile",value:function(t,e,i,n,o,s){this._renderSingleTile(t,Jt(Jt({},e),{},{symbol:e.symbol}),i,n,o,s);var r,a=Rt(e.parts);try{for(a.s();!(r=a.n()).done;){var l,h=r.value,c=h.offsetX||0,m=h.offsetY||0,u=i+c,y=n+m;this._renderSingleTile(t,h.tile,u,y,o,s),null!==(l=this.engine.debugger)&&void 0!==l&&l.active&&h.collision&&this._renderTileDebug(t,h,u,y,o)}}catch(t){a.e(t)}finally{a.f()}}},{key:"_renderSingleTile",value:function(t,e,i,n,o,s){var r="string"==typeof e?e:e.tile;if("object"===Ft(e)&&e.frames&&e.symbol){var a=this.getCurrentTileFrame(e.symbol);a&&(r=a)}var l=this.getTileInfo(r);if(l){var h=this.engine.getAsset(l.assetId);if(h){var c=h.config.tiles[l.tileName];if(c){var m=Math.floor(i*o-s),u=Math.floor(n*o-s),y=o+2*s;t.drawImage(h.asset,c.x,c.y,c.width,c.height,m,u,y,y)}}}}},{key:"_initializeTileAnimations",value:function(t){var e,i=Rt(t.tiles);try{for(i.s();!(e=i.n()).done;){var n=jt(e.value,2),o=n[0],s=n[1];if(s.frames&&s.frames.length>1){var r="tile_".concat(o);this.animatedTiles.set(r,{frames:s.frames,frameRate:s.frameRate||8,loop:!1!==s.loop,currentFrame:0,lastFrameTime:performance.now()})}}}catch(t){i.e(t)}finally{i.f()}}},{key:"getCurrentTileFrame",value:function(t){var e="tile_".concat(t),i=this.animatedTiles.get(e);return i&&i.frames?i.frames[i.currentFrame]:null}},{key:"addTile",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(i=Math.floor(Number(i)),n=Math.floor(Number(n)),!Number.isInteger(i)||!Number.isInteger(n)||i<0||n<0)return this.engine.warn("Invalid coordinates: x=".concat(i,", y=").concat(n,". Coordinates must be non-negative integers.")),!1;if(!this.tiles.has(e))return this.engine.warn("Symbol '".concat(e,"' not found in tiles configuration")),!1;this.layers.has(t)||(this.layers.set(t,[]),this.engine.log("Created new layer: ".concat(t)));for(var o=this.layers.get(t);o.length<=n;)o.push([]);for(var s=o[n];s.length<=i;)s.push(void 0);return o[n][i]=e,this.engine.info("Added tile '".concat(e,"' to layer '").concat(t,"' at position (").concat(i,", ").concat(n,")")),this}},{key:"getTileInfo",value:function(t){if("string"==typeof t){var e=jt(t.split("."),2);return{assetId:e[0],tileName:e[1]}}return null}},{key:"getTileSize",value:function(t){var e=this.getTileInfo(t);if(!e)return this.defaultTileSize;var i=this.engine.getAsset(e.assetId);return(null==i?void 0:i.config.tileSize)||this.defaultTileSize}},{key:"getTilesAt",value:function(t,e){var i=Math.floor(t/this.defaultTileSize),n=Math.floor(e/this.defaultTileSize),o=[];if(i<0||n<0)return o;var s,r=Rt(this.layers);try{for(r.s();!(s=r.n()).done;){var a=jt(s.value,2),l=a[0],h=a[1];if(h[n]&&void 0!==h[n][i]){var c=h[n][i];if(c){var m=this.tiles.get(c);m&&o.push({symbol:c,config:m,x:i,y:n,layer:l,worldX:i*this.defaultTileSize,worldY:n*this.defaultTileSize})}}}}catch(t){r.e(t)}finally{r.f()}return o}},{key:"getTileAt",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(i){var n=Math.floor(t/this.defaultTileSize),o=Math.floor(e/this.defaultTileSize),s=this.layers.get(i);if(!s||n<0||o<0||!s[o]||void 0===s[o][n])return null;var r=s[o][n];if(!r)return null;var a=this.tiles.get(r);return a?{symbol:r,config:a,x:n,y:o,layer:i,worldX:n*this.defaultTileSize,worldY:o*this.defaultTileSize}:null}var l=this.getTilesAt(t,e);return l.length>0?l[0]:null}},{key:"fillBoxWith",value:function(t){for(var e=this.engine.canvas,i=this.getTileSize(),n=Math.ceil(e.width/i),o=Math.ceil(e.height/i),s=[],r=0;r<o;r++){var a=new Array(n).fill(t);s.push(a)}return s}},{key:"fillWith",value:function(t,e){return new Array(e).fill(t)}},{key:"parseLayers",value:function(t){for(var e=new Map,i=0,n=Object.entries(t);i<n.length;i++){var o=jt(n[i],2),s=o[0],r=o[1];Array.isArray(r)?e.set(s,this.normalizeLayer(r)):e.set(s,r)}return e}},{key:"normalizeLayer",value:function(t){return t.map(function(t){return"string"==typeof t?t.split("").map(function(t){return" "===t?void 0:t}):Array.from(t,function(t){return void 0===t?void 0:t})})}},{key:"exportLayers",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0,e={};if(void 0!==t){if(!this.layers.has(t))return this.engine.warn("Layer '".concat(t,"' not found")),JSON.stringify({},null,2);var i=this.layers.get(t).map(function(t){return t.map(function(t){return void 0===t?" ":t}).join("")});e[t]=i}else{var n,o=Rt(this.layers);try{for(o.s();!(n=o.n()).done;){var s=jt(n.value,2),r=s[0],a=s[1].map(function(t){return t.map(function(t){return void 0===t?" ":t}).join("")});e[r]=a}}catch(t){o.e(t)}finally{o.f()}}return JSON.stringify(e,null,2)}}])}();const Ut=qt;function Kt(t){return Kt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Kt(t)}function Zt(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Ht(n.key),n)}}function Ht(t){var e=function(t,e){if("object"!=Kt(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=Kt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==Kt(e)?e:e+""}var Qt=function(){return function(t,e,i){return e&&Zt(t.prototype,e),i&&Zt(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.reset()},[{key:"init",value:function(t){this.x=t.x,this.y=t.y,this.vx=t.velocity.x,this.vy=t.velocity.y,this.ax=t.acceleration.x,this.ay=t.acceleration.y,this.size=t.size,this.currentSize=t.size,this.startColor=t.color.start,this.endColor=t.color.end,this.startAlpha=t.alpha.start,this.endAlpha=t.alpha.end,this.rotation=t.rotation,this.rotationSpeed=t.rotationSpeed,this.lifetime=t.lifetime,this.age=0,this.texture=t.texture}},{key:"render",value:function(t){if(!this.isDead()){var e=this.age/this.lifetime,i=this.startAlpha+(this.endAlpha-this.startAlpha)*e;if(t.save(),t.globalAlpha=i,t.translate(this.x,this.y),t.rotate(this.rotation*Math.PI/180),this.texture){var n=this.texture;t.drawImage(n,-this.size/2,-this.size/2,this.size,this.size)}else{var o=this.interpolateColor(this.startColor,this.endColor,e);t.fillStyle=o,t.beginPath(),t.arc(0,0,this.size/2,0,2*Math.PI),t.fill()}t.restore()}}},{key:"update",value:function(t){var e=t/1e3;this.vx+=this.ax*e,this.vy+=this.ay*e,this.x+=this.vx*e,this.y+=this.vy*e,this.rotation+=this.rotationSpeed*e,this.age+=t}},{key:"reset",value:function(){this.x=0,this.y=0,this.vx=0,this.vy=0,this.ax=0,this.ay=0,this.size=1,this.currentSize=1,this.startColor="#ffffff",this.endColor="#000000",this.startAlpha=1,this.endAlpha=0,this.rotation=0,this.rotationSpeed=0,this.lifetime=1e3,this.age=0,this.texture=null}},{key:"isDead",value:function(){return this.age>=this.lifetime}},{key:"interpolateColor",value:function(t,e,i){var n=parseInt(t.substr(1,2),16),o=parseInt(t.substr(3,2),16),s=parseInt(t.substr(5,2),16),r=parseInt(e.substr(1,2),16),a=parseInt(e.substr(3,2),16),l=parseInt(e.substr(5,2),16),h=Math.round(n+(r-n)*i),c=Math.round(o+(a-o)*i),m=Math.round(s+(l-s)*i);return"rgb(".concat(h,", ").concat(c,", ").concat(m,")")}}])}();const $t=Qt;function te(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function ee(t,e,i){return(e=re(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function ie(t){return ie="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ie(t)}function ne(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function oe(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,re(n.key),n)}}function se(t,e,i){return e&&oe(t.prototype,e),i&&oe(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function re(t){var e=function(t,e){if("object"!=ie(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=ie(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==ie(e)?e:e+""}var ae=function(){return se(function t(e){ne(this,t),this.engine=e,this.emitters=new Map,this.particlePool=[],this.maxPoolSize=1e3},[{key:"create",value:function(t){var e=new le(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},this.engine);return this.emitters.set(t,e),e}},{key:"get",value:function(t){return this.emitters.get(t)||null}},{key:"remove",value:function(t){var e=this.emitters.get(t);return!!e&&(e.destroy(),this.emitters.delete(t),!0)}},{key:"getAll",value:function(){return Array.from(this.emitters.values())}},{key:"clear",value:function(){this.emitters.forEach(function(t){return t.destroy()}),this.emitters.clear(),this.particlePool=[]}},{key:"getParticle",value:function(){return this.particlePool.length>0?this.particlePool.pop():new $t}},{key:"returnParticle",value:function(t){this.particlePool.length<this.maxPoolSize&&(t.reset(),this.particlePool.push(t))}},{key:"update",value:function(t){this.emitters.forEach(function(e){e.active&&e.update(t)})}},{key:"render",value:function(t){this.emitters.forEach(function(e){e.visible&&e.render(t)})}},{key:"explosion",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n={position:{x:t,y:e},shape:"invisible",emission:{type:"point",rate:0,burst:i.particleCount||30,lifetime:i.lifetime||1500},particle:{velocity:{min:{x:-150,y:-150},max:{x:150,y:-50}},acceleration:{x:0,y:100},size:{min:3,max:8},color:{start:i.startColor||"#ff4444",end:i.endColor||"#ffaa00"},alpha:{start:1,end:0},rotation:{min:0,max:360},rotationSpeed:{min:-360,max:360}},autoDestroy:!0},o=this.create("explosion_".concat(Date.now()),n);return o.start(),o.burst(i.particleCount||30),o}},{key:"fire",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n={position:{x:t,y:e},shape:"invisible",emission:{type:"point",rate:i.rate||40,lifetime:i.lifetime||1200},particle:{velocity:{min:{x:-30,y:-80},max:{x:30,y:-40}},acceleration:{x:0,y:-20},size:{min:2,max:6},color:{start:"#ff4444",end:"#ff8800"},alpha:{start:.8,end:0}}},o=this.create("fire_".concat(Date.now()),n);return o.start(),o}},{key:"smoke",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n={position:{x:t,y:e},shape:"invisible",emission:{type:"point",rate:i.rate||15,lifetime:i.lifetime||3e3},particle:{velocity:{min:{x:-20,y:-60},max:{x:20,y:-30}},acceleration:{x:0,y:-10},size:{min:8,max:16},color:{start:"#666666",end:"#cccccc"},alpha:{start:.6,end:0}}},o=this.create("smoke_".concat(Date.now()),n);return o.start(),o}}])}(),le=function(){return se(function t(e,i,n){var o,s,r,a,l,h,c,m,u,y,p,f,_,d;ne(this,t),this.id=e,this.engine=n,this.particles=[],this.active=!1,this.visible=!0,this.x=(null===(o=i.position)||void 0===o?void 0:o.x)||0,this.y=(null===(s=i.position)||void 0===s?void 0:s.y)||0,this.targetX=this.x,this.targetY=this.y,this.moveAnimation=null,this.shape=i.shape||"invisible",this.size=i.size||10,this.color=i.color||"#ff0000",this.opacity=i.opacity||.5,this.emission=function(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?te(Object(i),!0).forEach(function(e){ee(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):te(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}({type:(null===(r=i.emission)||void 0===r?void 0:r.type)||"point",rate:(null===(a=i.emission)||void 0===a?void 0:a.rate)||30,lifetime:(null===(l=i.emission)||void 0===l?void 0:l.lifetime)||2e3,burst:(null===(h=i.emission)||void 0===h?void 0:h.burst)||0},i.emission),this.particle={velocity:(null===(c=i.particle)||void 0===c?void 0:c.velocity)||{min:{x:-50,y:-50},max:{x:50,y:50}},acceleration:(null===(m=i.particle)||void 0===m?void 0:m.acceleration)||{x:0,y:0},size:(null===(u=i.particle)||void 0===u?void 0:u.size)||{min:2,max:4},color:(null===(y=i.particle)||void 0===y?void 0:y.color)||{start:"#ffffff",end:"#000000"},alpha:(null===(p=i.particle)||void 0===p?void 0:p.alpha)||{start:1,end:0},rotation:(null===(f=i.particle)||void 0===f?void 0:f.rotation)||{min:0,max:0},rotationSpeed:(null===(_=i.particle)||void 0===_?void 0:_.rotationSpeed)||{min:0,max:0},texture:(null===(d=i.particle)||void 0===d?void 0:d.texture)||null},this.lastEmissionTime=0,this.emissionInterval=1e3/this.emission.rate,this.autoDestroy=i.autoDestroy||!1},[{key:"start",value:function(){return this.active=!0,this.lastEmissionTime=performance.now(),this}},{key:"stop",value:function(){return this.active=!1,this}},{key:"pause",value:function(){return this.active=!1,this}},{key:"resume",value:function(){return this.active=!0,this.lastEmissionTime=performance.now(),this}},{key:"burst",value:function(t){for(var e=0;e<t;e++)this.emitParticle();return this}},{key:"move",value:function(t,e){return this.x=t,this.y=e,this.targetX=t,this.targetY=e,this.moveAnimation&&(this.moveAnimation=null),this}},{key:"moveTo",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.targetX=t,this.targetY=e;var n=this.x,o=this.y,s=i.duration||1e3,r=this.engine.Ease[i.easing]||this.engine.Ease.linear,a=performance.now();return this.moveAnimation={startX:n,startY:o,targetX:t,targetY:e,duration:s,easing:r,startTime:a},this}},{key:"emitParticle",value:function(){var t,e=this.engine.emitters.getParticle(),i=this.getEmissionPosition();e.init({x:i.x,y:i.y,velocity:this.randomizeValue(this.particle.velocity),acceleration:this.particle.acceleration,size:this.randomizeValue(this.particle.size),color:this.particle.color,alpha:this.particle.alpha,rotation:this.randomizeValue(this.particle.rotation),rotationSpeed:this.randomizeValue(this.particle.rotationSpeed),lifetime:this.emission.lifetime,texture:null===(t=this.engine.getAsset(this.particle.texture))||void 0===t?void 0:t.asset}),this.particles.push(e)}},{key:"getEmissionPosition",value:function(){switch(this.emission.type){case"point":return{x:this.x,y:this.y};case"circle":var t=Math.random()*Math.PI*2,e=this.emission.edge?this.emission.radius:Math.random()*this.emission.radius;return{x:this.x+Math.cos(t)*e,y:this.y+Math.sin(t)*e};case"rectangle":if(!this.emission.edge)return{x:this.x+(Math.random()-.5)*this.emission.width,y:this.y+(Math.random()-.5)*this.emission.height};var i=Math.floor(4*Math.random()),n=this.emission.width,o=this.emission.height;switch(i){case 0:return{x:this.x+Math.random()*n-n/2,y:this.y-o/2};case 1:return{x:this.x+n/2,y:this.y+Math.random()*o-o/2};case 2:return{x:this.x+Math.random()*n-n/2,y:this.y+o/2};case 3:return{x:this.x-n/2,y:this.y+Math.random()*o-o/2}}case"line":var s=Math.random();return{x:this.x+this.emission.start.x+s*(this.emission.end.x-this.emission.start.x),y:this.y+this.emission.start.y+s*(this.emission.end.y-this.emission.start.y)};default:return{x:this.x,y:this.y}}}},{key:"randomizeValue",value:function(t){return"number"==typeof t?t:void 0!==t.min&&void 0!==t.max?"object"===ie(t.min)?{x:t.min.x+Math.random()*(t.max.x-t.min.x),y:t.min.y+Math.random()*(t.max.y-t.min.y)}:t.min+Math.random()*(t.max-t.min):t}},{key:"update",value:function(t){if(this.moveAnimation){var e=performance.now()-this.moveAnimation.startTime,i=Math.min(e/this.moveAnimation.duration,1),n=this.moveAnimation.easing(i);this.x=this.moveAnimation.startX+(this.moveAnimation.targetX-this.moveAnimation.startX)*n,this.y=this.moveAnimation.startY+(this.moveAnimation.targetY-this.moveAnimation.startY)*n,i>=1&&(this.moveAnimation=null)}if(this.active&&this.emission.rate>0){var o=performance.now();o-this.lastEmissionTime>=this.emissionInterval&&(this.emitParticle(),this.lastEmissionTime=o)}for(var s=this.particles.length-1;s>=0;s--){var r=this.particles[s];r.update(t),r.isDead()&&(this.engine.emitters.returnParticle(r),this.particles.splice(s,1))}this.autoDestroy&&!this.active&&0===this.particles.length&&this.engine.emitters.remove(this.id)}},{key:"render",value:function(t){if(this.particles.forEach(function(e){e.render(t)}),"invisible"!==this.shape){switch(t.save(),t.globalAlpha=this.opacity,t.fillStyle=this.color,this.shape){case"circle":t.beginPath(),t.arc(this.x,this.y,this.size/2,0,2*Math.PI),t.fill();break;case"square":t.fillRect(this.x-this.size/2,this.y-this.size/2,this.size,this.size);break;case"diamond":t.beginPath(),t.moveTo(this.x,this.y-this.size/2),t.lineTo(this.x+this.size/2,this.y),t.lineTo(this.x,this.y+this.size/2),t.lineTo(this.x-this.size/2,this.y),t.closePath(),t.fill();break;case"cross":var e=this.size/6;t.fillRect(this.x-this.size/2,this.y-e,this.size,2*e),t.fillRect(this.x-e,this.y-this.size/2,2*e,this.size)}t.restore()}}},{key:"destroy",value:function(){var t=this;this.particles.forEach(function(e){t.engine.emitters.returnParticle(e)}),this.particles=[],this.active=!1}}])}();const he=ae;function ce(t){return ce="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ce(t)}function me(t){return function(t){if(Array.isArray(t))return fe(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||pe(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ue(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,o,s,r,a=[],l=!0,h=!1;try{if(s=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;l=!1}else for(;!(l=(n=s.call(i)).done)&&(a.push(n.value),a.length!==e);l=!0);}catch(t){h=!0,o=t}finally{try{if(!l&&null!=i.return&&(r=i.return(),Object(r)!==r))return}finally{if(h)throw o}}return a}}(t,e)||pe(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ye(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=pe(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return r=t.done,t},e:function(t){a=!0,s=t},f:function(){try{r||null==i.return||i.return()}finally{if(a)throw s}}}}function pe(t,e){if(t){if("string"==typeof t)return fe(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?fe(t,e):void 0}}function fe(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function _e(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var t,e,i="function"==typeof Symbol?Symbol:{},n=i.iterator||"@@iterator",o=i.toStringTag||"@@toStringTag";function s(i,n,o,s){var l=n&&n.prototype instanceof a?n:a,h=Object.create(l.prototype);return de(h,"_invoke",function(i,n,o){var s,a,l,h=0,c=o||[],m=!1,u={p:0,n:0,v:t,a:y,f:y.bind(t,4),d:function(e,i){return s=e,a=0,l=t,u.n=i,r}};function y(i,n){for(a=i,l=n,e=0;!m&&h&&!o&&e<c.length;e++){var o,s=c[e],y=u.p,p=s[2];i>3?(o=p===n)&&(l=s[(a=s[4])?5:(a=3,3)],s[4]=s[5]=t):s[0]<=y&&((o=i<2&&y<s[1])?(a=0,u.v=n,u.n=s[1]):y<p&&(o=i<3||s[0]>n||n>p)&&(s[4]=i,s[5]=n,u.n=p,a=0))}if(o||i>1)return r;throw m=!0,n}return function(o,c,p){if(h>1)throw TypeError("Generator is already running");for(m&&1===c&&y(c,p),a=c,l=p;(e=a<2?t:l)||!m;){s||(a?a<3?(a>1&&(u.n=-1),y(a,l)):u.n=l:u.v=l);try{if(h=2,s){if(a||(o="next"),e=s[o]){if(!(e=e.call(s,l)))throw TypeError("iterator result is not an object");if(!e.done)return e;l=e.value,a<2&&(a=0)}else 1===a&&(e=s.return)&&e.call(s),a<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),a=1);s=t}else if((e=(m=u.n<0)?l:i.call(n,u))!==r)break}catch(e){s=t,a=1,l=e}finally{h=1}}return{value:e,done:m}}}(i,o,s),!0),h}var r={};function a(){}function l(){}function h(){}e=Object.getPrototypeOf;var c=[][n]?e(e([][n]())):(de(e={},n,function(){return this}),e),m=h.prototype=a.prototype=Object.create(c);function u(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,h):(t.__proto__=h,de(t,o,"GeneratorFunction")),t.prototype=Object.create(m),t}return l.prototype=h,de(m,"constructor",h),de(h,"constructor",l),l.displayName="GeneratorFunction",de(h,o,"GeneratorFunction"),de(m),de(m,o,"Generator"),de(m,n,function(){return this}),de(m,"toString",function(){return"[object Generator]"}),(_e=function(){return{w:s,m:u}})()}function de(t,e,i,n){var o=Object.defineProperty;try{o({},"",{})}catch(t){o=0}de=function(t,e,i,n){if(e)o?o(t,e,{value:i,enumerable:!n,configurable:!n,writable:!n}):t[e]=i;else{var s=function(e,i){de(t,e,function(t){return this._invoke(e,i,t)})};s("next",0),s("throw",1),s("return",2)}},de(t,e,i,n)}function ve(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function be(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?ve(Object(i),!0).forEach(function(e){ge(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):ve(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function ge(t,e,i){return(e=Se(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function xe(t,e,i,n,o,s,r){try{var a=t[s](r),l=a.value}catch(t){return void i(t)}a.done?e(l):Promise.resolve(l).then(n,o)}function we(t){return function(){var e=this,i=arguments;return new Promise(function(n,o){var s=t.apply(e,i);function r(t){xe(s,n,o,r,a,"next",t)}function a(t){xe(s,n,o,r,a,"throw",t)}r(void 0)})}}function Ce(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Se(n.key),n)}}function Se(t){var e=function(t,e){if("object"!=ce(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=ce(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==ce(e)?e:e+""}var Ae=function(){return function(t,e,i){return e&&Ce(t.prototype,e),i&&Ce(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(e){if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.assets=new Map,this.workerID=e,this.isWorker="undefined"!=typeof importScripts&&"undefined"!=typeof DedicatedWorkerGlobalScope,this.instances=new Map,this.assetInstances=new Map,this.listener=null,this.masterVolume=1,this.nextInstanceId=0,!this.isWorker)try{this.context=new(window.AudioContext||window.webkitAudioContext),this.listener=this.context.listener,this._initSpatialAudio()}catch(t){this.error(t)}},[{key:"load",value:(e=we(_e().m(function t(e,i,n){var o=this;return _e().w(function(t){for(;;)switch(t.n){case 0:if(!this.isWorker){t.n=1;break}return this._sendWorker({action:"audio_load",args:[e,i,n]}),t.a(2);case 1:return t.a(2,new Promise(function(){var t=we(_e().m(function t(s,r){var a,l,h,c,m;return _e().w(function(t){for(;;)switch(t.p=t.n){case 0:return t.p=0,t.n=1,fetch(i,be({mode:"cors"},n.fetch||{}));case 1:return a=t.v,t.n=2,a.arrayBuffer();case 2:return l=t.v,t.n=3,o.context.decodeAudioData(l);case 3:h=t.v,c={id:e,asset:h,config:be(be({},n),{},{volume:n.volume||1,loop:n.loop||!1,autoplay:n.autoplay||!1,muted:n.muted||!1})},o.assets.set(e,c),o.isWorker?o._sendWorker(be(be({},c),{},{asset:null,type:"pixalo_audio_loaded"})):null!=o&&o.worker&&o.worker.postMessage(be(be({},c),{},{asset:null,type:"pixalo_audio_loaded"})),s({asset:h,config:c.config}),t.n=5;break;case 4:t.p=4,m=t.v,r(new Error("Failed to load audio: ".concat(m.message)));case 5:return t.a(2)}},t,null,[[0,4]])}));return function(e,i){return t.apply(this,arguments)}}()))}},t,this)})),function(t,i,n){return e.apply(this,arguments)})},{key:"play",value:(t=we(_e().m(function t(e){var i,n=this,o=arguments;return _e().w(function(t){for(;;)switch(t.n){case 0:if(i=o.length>1&&void 0!==o[1]?o[1]:{},!this.isWorker){t.n=1;break}return this._sendWorker({action:"audio_play",args:[e,i]}),t.a(2);case 1:return t.a(2,new Promise(function(t,o){try{var s=n.assets.get(e);if(!s)return void o(new Error("Audio asset with id '".concat(e,"' not found")));"suspended"===n.context.state&&n.context.resume();var r=n._generateInstanceId(),a=n.context.createBufferSource(),l=n.context.createGain();a.buffer=s.asset;var h=be(be({},s.config),i);l.gain.value=h.muted?0:h.volume*n.masterVolume,a.loop=h.loop;var c=n._setupAudioChain(a,l,h.spatial),m={instanceId:r,assetId:e,source:a,gainNode:l,spatialNodes:c,spatialConfig:h.spatial||null,startTime:n.context.currentTime,pauseTime:0,duration:s.asset.duration,isPlaying:!0,isPaused:!1,config:h};n.instances.set(r,m),n.assetInstances.has(e)||n.assetInstances.set(e,new Set),n.assetInstances.get(e).add(r),a.onended=function(){n.instances.delete(r),n.assetInstances.has(e)&&(n.assetInstances.get(e).delete(r),0===n.assetInstances.get(e).size&&n.assetInstances.delete(e))},a.start(0),t({instanceId:r,assetId:e,source:a,gainNode:l,spatialNodes:c})}catch(t){n.error("Failed to play audio '".concat(e,"':"),t.message),o(new Error("Failed to play audio: ".concat(t.message)))}}))}},t,this)})),function(e){return t.apply(this,arguments)})},{key:"pause",value:function(t){if(this.isWorker)return this._sendWorker({action:"audio_pause",args:[t]}),this;var e=this.instances.get(t);if(!e){var i,n=ye(this.instances);try{for(n.s();!(i=n.n()).done;){var o=ue(i.value,2),s=o[0],r=o[1];if(r.assetId===t&&r.isPlaying&&!r.isPaused){e=r,t=s;break}}}catch(t){n.e(t)}finally{n.f()}}if(e&&e.isPlaying&&!e.isPaused){var a=this.getCurrentTime(t);e.pauseTime=a,e.isPlaying=!1,e.isPaused=!0;try{e.source.onended=null,e.source.stop()}catch(t){this.warn("Source already stopped:",t.message)}}else this.warn("No active audio instance found for id '".concat(t,"' or already paused"));return this}},{key:"resume",value:function(t){var e=this;if(this.isWorker)return this._sendWorker({action:"audio_resume",args:[t]}),this;var i=this.instances.get(t),n=t;if(!i){var o=this.assetInstances.get(t);if(o){var s,r=ye(o);try{for(r.s();!(s=r.n()).done;){var a=s.value,l=this.instances.get(a);if(l&&l.isPaused){i=l,n=a;break}}}catch(t){r.e(t)}finally{r.f()}}}if(i&&i.isPaused){var h=this.assets.get(i.assetId);if(!h)return this.warn("Asset not found for instance '".concat(n,"'")),this;"suspended"===this.context.state&&this.context.resume();var c=this.context.createBufferSource(),m=this.context.createGain();c.buffer=h.asset,c.loop=i.config.loop,m.gain.value=i.config.volume*this.masterVolume;var u=this._setupAudioChain(c,m,i.spatialConfig);i.source=c,i.gainNode=m,i.spatialNodes=u,i.startTime=this.context.currentTime-i.pauseTime,i.isPlaying=!0,i.isPaused=!1,c.onended=function(){e.instances.delete(n),e.assetInstances.has(i.assetId)&&(e.assetInstances.get(i.assetId).delete(n),0===e.assetInstances.get(i.assetId).size&&e.assetInstances.delete(i.assetId))},h.asset.duration-i.pauseTime>0?c.start(0,i.pauseTime):c.start(0,0)}else this.warn("No paused audio instance found for id '".concat(t,"'"));return this}},{key:"stop",value:function(t){if(this.isWorker)return this._sendWorker({action:"audio_stop",args:[t]}),this;var e=this.instances.get(t),i=t;if(!e){var n,o=ye(this.instances);try{for(o.s();!(n=o.n()).done;){var s=ue(n.value,2),r=s[0],a=s[1];if(a.assetId===t){e=a,i=r;break}}}catch(t){o.e(t)}finally{o.f()}}if(e=this.instances.get(i)){try{e.source.onended=null,e.source.stop()}catch(t){this.warn("Error stopping source:",t.message)}this.instances.delete(i),this.assetInstances.has(e.assetId)&&(this.assetInstances.get(e.assetId).delete(i),0===this.assetInstances.get(e.assetId).size&&this.assetInstances.delete(e.assetId))}return this}},{key:"stopAsset",value:function(t){var e=this;if(this.isWorker)return this._sendWorker({action:"audio_stopAsset",args:[t]}),this;var i=this.assetInstances.get(t);i&&Array.from(i).forEach(function(t){return e.stop(t)});return this}},{key:"setVolume",value:function(t,e){if(this.isWorker)return this._sendWorker({action:"audio_setVolume",args:[t,e]}),this;var i=this.instances.get(t);if(i)i.gainNode.gain.value=e*this.masterVolume,i.config.volume=e;else{var n,o=ye(this.instances.values());try{for(o.s();!(n=o.n()).done;){var s=n.value;if(s.assetId===t){s.gainNode.gain.value=e*this.masterVolume,s.config.volume=e;break}}}catch(t){o.e(t)}finally{o.f()}}return this}},{key:"setAssetVolume",value:function(t,e){var i=this;if(this.isWorker)return this._sendWorker({action:"audio_setAssetVolume",args:[t,e]}),this;this.instances.forEach(function(n){n.assetId===t&&(n.gainNode.gain.value=e*i.masterVolume,n.config.volume=e)});var n=this.assets.get(t);return n&&(n.config.volume=e),this}},{key:"setMasterVolume",value:function(t){var e=this;return this.isWorker?(this._sendWorker({action:"audio_setMasterVolume",args:[t]}),this):(this.masterVolume=Math.max(0,Math.min(1,t)),this.instances.forEach(function(t){t.config.muted||(t.gainNode.gain.value=t.config.volume*e.masterVolume)}),this)}},{key:"setListenerPosition",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return this.isWorker?(this._sendWorker({action:"audio_setListenerPosition",args:[t,e,i]}),this):(this.listener.positionX?(this.listener.positionX.value=t,this.listener.positionY.value=e,this.listener.positionZ.value=i):this.listener.setPosition(t,e,i),this)}},{key:"setListenerOrientation",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;return this.isWorker?(this._sendWorker({action:"audio_setListenerOrientation",args:[t,e,i,n,o,s]}),this):(this.listener.forwardX?(this.listener.forwardX.value=t,this.listener.forwardY.value=e,this.listener.forwardZ.value=i,this.listener.upX.value=n,this.listener.upY.value=o,this.listener.upZ.value=s):this.listener.setOrientation(t,e,i,n,o,s),this)}},{key:"setSpatialPosition",value:function(t,e,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(this.isWorker)return this._sendWorker({action:"audio_setSpatialPosition",args:[t,e,i,n]}),this;var o=this.instances.get(t);if(!o){var s,r=ye(this.instances.values());try{for(r.s();!(s=r.n()).done;){var a=s.value;if(a.assetId===t&&a.spatialNodes&&a.spatialNodes.panner){o=a;break}}}catch(t){r.e(t)}finally{r.f()}}return o&&o.spatialNodes&&o.spatialNodes.panner?o.spatialNodes.panner.positionX?(o.spatialNodes.panner.positionX.value=e,o.spatialNodes.panner.positionY.value=i,o.spatialNodes.panner.positionZ.value=n):o.spatialNodes.panner.setPosition(e,i,n):this.warn("No spatial audio found for id '".concat(t,"'")),this}},{key:"setSpatialOrientation",value:function(t,e,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(this.isWorker)return this._sendWorker({action:"audio_setSpatialOrientation",args:[t,e,i,n]}),this;var o=this.instances.get(t);if(!o){var s,r=ye(this.instances.values());try{for(r.s();!(s=r.n()).done;){var a=s.value;if(a.assetId===t&&a.spatialNodes&&a.spatialNodes.panner){o=a;break}}}catch(t){r.e(t)}finally{r.f()}}return o&&o.spatialNodes&&o.spatialNodes.panner?o.spatialNodes.panner.orientationX?(o.spatialNodes.panner.orientationX.value=e,o.spatialNodes.panner.orientationY.value=i,o.spatialNodes.panner.orientationZ.value=n):o.spatialNodes.panner.setOrientation(e,i,n):this.warn("No spatial audio found for id '".concat(t,"'")),this}},{key:"playSpatial",value:function(t,e,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},s=be(be({},o),{},{spatial:be({position:{x:e,y:i,z:n},panningModel:"HRTF",distanceModel:"inverse",refDistance:1,maxDistance:1e4,rolloffFactor:1},o.spatial)});return this.play(t,s)}},{key:"updateSpatial",value:function(t,e){return e.position&&this.setSpatialPosition(t,e.position.x,e.position.y,e.position.z),e.orientation&&this.setSpatialOrientation(t,e.orientation.x,e.orientation.y,e.orientation.z),void 0!==e.volume&&this.setVolume(t,e.volume),this}},{key:"isPlaying",value:function(t){if(this.isWorker)return this._sendWorker({action:"audio_isPlaying",args:[t]}),!1;var e=this.instances.get(t);if(!e){var i,n=ye(this.instances.values());try{for(n.s();!(i=n.n()).done;){var o=i.value;if(o.assetId===t&&o.isPlaying)return!0}}catch(t){n.e(t)}finally{n.f()}return!1}return!!e&&e.isPlaying}},{key:"getAssetInstances",value:function(t){if(this.isWorker)return this._sendWorker({action:"audio_getAssetInstances",args:[t]}),[];var e=[],i=this.assetInstances.get(t);if(i){var n,o=ye(i);try{for(o.s();!(n=o.n()).done;){var s=n.value,r=this.instances.get(s);r&&e.push({instanceId:s,isPlaying:r.isPlaying,isPaused:r.isPaused,currentTime:this.getCurrentTime(s)})}}catch(t){o.e(t)}finally{o.f()}}return e}},{key:"getDuration",value:function(t){if(this.isWorker)return this._sendWorker({action:"audio_getDuration",args:[t]}),0;var e=this.assets.get(t);return e?e.asset.duration:0}},{key:"getCurrentTime",value:function(t){if(this.isWorker)return this._sendWorker({action:"audio_getCurrentTime",args:[t]}),0;var e=this.instances.get(t);if(!e){var i,n=ye(this.instances.values());try{for(n.s();!(i=n.n()).done;){var o=i.value;if(o.assetId===t){e=o;break}}}catch(t){n.e(t)}finally{n.f()}}if(!e)return 0;if(e.isPaused)return e.pauseTime;if(e.isPlaying){var s=this.context.currentTime-e.startTime;return Math.min(s,e.duration)}return 0}},{key:"getDistance",value:function(t){var e=this.instances.get(t);if(!e){var i,n=ye(this.instances.values());try{for(n.s();!(i=n.n()).done;){var o=i.value;if(o.assetId===t&&o.spatialNodes&&o.spatialNodes.panner){e=o;break}}}catch(t){n.e(t)}finally{n.f()}}if(!e||!e.spatialNodes||!e.spatialNodes.panner)return null;var s,r,a,l,h,c,m=e.spatialNodes.panner,u=this.listener;return m.positionX?(s=m.positionX.value,r=m.positionY.value,a=m.positionZ.value,l=u.positionX.value,h=u.positionY.value,c=u.positionZ.value,Math.sqrt(Math.pow(s-l,2)+Math.pow(r-h,2)+Math.pow(a-c,2))):null}},{key:"muteAll",value:function(){return this.isWorker?(this._sendWorker({action:"audio_muteAll",args:[]}),this):(this.instances.forEach(function(t){t.gainNode.gain.value=0}),this)}},{key:"unmuteAll",value:function(){var t=this;return this.isWorker?(this._sendWorker({action:"audio_unmuteAll",args:[]}),this):(this.instances.forEach(function(e){e.gainNode.gain.value=e.config.volume*t.masterVolume}),this)}},{key:"pauseAll",value:function(){var t=this;return this.isWorker?(this._sendWorker({action:"audio_pauseAll",args:[]}),this):(Array.from(this.instances.keys()).filter(function(e){var i=t.instances.get(e);return i.isPlaying&&!i.isPaused}).forEach(function(e){return t.pause(e)}),this)}},{key:"resumeAll",value:function(){var t=this;return this.isWorker?(this._sendWorker({action:"audio_resumeAll",args:[]}),this):(Array.from(this.instances.keys()).filter(function(e){return t.instances.get(e).isPaused}).forEach(function(e){return t.resume(e)}),this)}},{key:"stopAll",value:function(){return this.isWorker?(this._sendWorker({action:"audio_stopAll",args:[]}),this):(this.instances.forEach(function(t){try{t.source.stop()}catch(t){}}),this.instances.clear(),this.assetInstances.clear(),this)}},{key:"cleanup",value:function(){return this.isWorker?(this._sendWorker({action:"audio_cleanup",args:[]}),this):(this.stopAll(),this.assets.clear(),this.context&&"closed"!==this.context.state&&this.context.close(),this.instances.clear(),this.listener=null,this.masterVolume=1,this.nextInstanceId=0,this)}},{key:"warn",value:function(){for(var t,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return(t=console).warn.apply(t,["%c[AudioManager WARN]","color: #ff9800;"].concat(i)),this}},{key:"error",value:function(){for(var t,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return(t=console).error.apply(t,["%c[AudioManager ERROR]","color: #f44336;"].concat(i)),this}},{key:"_handleWorker",value:function(t){var e,i=t.data,n=null!==(e=null==i?void 0:i.action)&&void 0!==e?e:"";if(n.startsWith("audio_")){var o=n.replace("audio_","");"function"==typeof this[o]&&this[o].apply(this,me(i.args))}}},{key:"_sendWorker",value:function(t){postMessage(be({wid:this.workerID},t))}},{key:"_initSpatialAudio",value:function(){this.listener.forwardX?(this.listener.forwardX.value=0,this.listener.forwardY.value=0,this.listener.forwardZ.value=-1,this.listener.upX.value=0,this.listener.upY.value=1,this.listener.upZ.value=0,this.listener.positionX.value=0,this.listener.positionY.value=0,this.listener.positionZ.value=0):(this.listener.setOrientation(0,0,-1,0,1,0),this.listener.setPosition(0,0,0))}},{key:"_generateInstanceId",value:function(){return"instance_".concat(this.nextInstanceId++,"_").concat(performance.now().toString(36))}},{key:"_setupAudioChain",value:function(t,e,i){if(i){var n=this._createSpatialNodes(i);return t.connect(e),e.connect(n.panner),n.panner.connect(this.context.destination),n}return t.connect(e),e.connect(this.context.destination),null}},{key:"_createSpatialNodes",value:function(t){var e=this.context.createPanner();e.panningModel=t.panningModel||"HRTF",e.distanceModel=t.distanceModel||"inverse",e.refDistance=t.refDistance||1,e.maxDistance=t.maxDistance||1e4,e.rolloffFactor=t.rolloffFactor||1,e.coneInnerAngle=t.coneInnerAngle||360,e.coneOuterAngle=t.coneOuterAngle||360,e.coneOuterGain=t.coneOuterGain||0;var i=t.position||{x:0,y:0,z:0};e.positionX?(e.positionX.value=i.x,e.positionY.value=i.y,e.positionZ.value=i.z):e.setPosition(i.x,i.y,i.z);var n=t.orientation||{x:1,y:0,z:0};return e.orientationX?(e.orientationX.value=n.x,e.orientationY.value=n.y,e.orientationZ.value=n.z):e.setOrientation(n.x,n.y,n.z),{panner:e}}}]);var t,e}();const Me=Ae;function De(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,o,s,r,a=[],l=!0,h=!1;try{if(s=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;l=!1}else for(;!(l=(n=s.call(i)).done)&&(a.push(n.value),a.length!==e);l=!0);}catch(t){h=!0,o=t}finally{try{if(!l&&null!=i.return&&(r=i.return(),Object(r)!==r))return}finally{if(h)throw o}}return a}}(t,e)||Be(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ke(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=Be(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return r=t.done,t},e:function(t){a=!0,s=t},f:function(){try{r||null==i.return||i.return()}finally{if(a)throw s}}}}function Be(t,e){if(t){if("string"==typeof t)return Ie(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?Ie(t,e):void 0}}function Ie(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function Ve(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var t,e,i="function"==typeof Symbol?Symbol:{},n=i.iterator||"@@iterator",o=i.toStringTag||"@@toStringTag";function s(i,n,o,s){var l=n&&n.prototype instanceof a?n:a,h=Object.create(l.prototype);return Pe(h,"_invoke",function(i,n,o){var s,a,l,h=0,c=o||[],m=!1,u={p:0,n:0,v:t,a:y,f:y.bind(t,4),d:function(e,i){return s=e,a=0,l=t,u.n=i,r}};function y(i,n){for(a=i,l=n,e=0;!m&&h&&!o&&e<c.length;e++){var o,s=c[e],y=u.p,p=s[2];i>3?(o=p===n)&&(l=s[(a=s[4])?5:(a=3,3)],s[4]=s[5]=t):s[0]<=y&&((o=i<2&&y<s[1])?(a=0,u.v=n,u.n=s[1]):y<p&&(o=i<3||s[0]>n||n>p)&&(s[4]=i,s[5]=n,u.n=p,a=0))}if(o||i>1)return r;throw m=!0,n}return function(o,c,p){if(h>1)throw TypeError("Generator is already running");for(m&&1===c&&y(c,p),a=c,l=p;(e=a<2?t:l)||!m;){s||(a?a<3?(a>1&&(u.n=-1),y(a,l)):u.n=l:u.v=l);try{if(h=2,s){if(a||(o="next"),e=s[o]){if(!(e=e.call(s,l)))throw TypeError("iterator result is not an object");if(!e.done)return e;l=e.value,a<2&&(a=0)}else 1===a&&(e=s.return)&&e.call(s),a<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),a=1);s=t}else if((e=(m=u.n<0)?l:i.call(n,u))!==r)break}catch(e){s=t,a=1,l=e}finally{h=1}}return{value:e,done:m}}}(i,o,s),!0),h}var r={};function a(){}function l(){}function h(){}e=Object.getPrototypeOf;var c=[][n]?e(e([][n]())):(Pe(e={},n,function(){return this}),e),m=h.prototype=a.prototype=Object.create(c);function u(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,h):(t.__proto__=h,Pe(t,o,"GeneratorFunction")),t.prototype=Object.create(m),t}return l.prototype=h,Pe(m,"constructor",h),Pe(h,"constructor",l),l.displayName="GeneratorFunction",Pe(h,o,"GeneratorFunction"),Pe(m),Pe(m,o,"Generator"),Pe(m,n,function(){return this}),Pe(m,"toString",function(){return"[object Generator]"}),(Ve=function(){return{w:s,m:u}})()}function Pe(t,e,i,n){var o=Object.defineProperty;try{o({},"",{})}catch(t){o=0}Pe=function(t,e,i,n){if(e)o?o(t,e,{value:i,enumerable:!n,configurable:!n,writable:!n}):t[e]=i;else{var s=function(e,i){Pe(t,e,function(t){return this._invoke(e,i,t)})};s("next",0),s("throw",1),s("return",2)}},Pe(t,e,i,n)}function Te(t,e,i,n,o,s,r){try{var a=t[s](r),l=a.value}catch(t){return void i(t)}a.done?e(l):Promise.resolve(l).then(n,o)}function Le(t){return function(){var e=this,i=arguments;return new Promise(function(n,o){var s=t.apply(e,i);function r(t){Te(s,n,o,r,a,"next",t)}function a(t){Te(s,n,o,r,a,"throw",t)}r(void 0)})}}function Ge(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function Ee(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Ge(Object(i),!0).forEach(function(e){Fe(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Ge(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function Fe(t,e,i){return(e=Je(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function Re(t){return Re="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Re(t)}function Oe(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Je(n.key),n)}}function Je(t){var e=function(t,e){if("object"!=Re(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=Re(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==Re(e)?e:e+""}function ze(t,e,i){return e=Ne(e),function(t,e){if(e&&("object"==Re(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(t,je()?Reflect.construct(e,i||[],Ne(t).constructor):e.apply(t,i))}function je(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(t){}return(je=function(){return!!t})()}function Ne(t){return Ne=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},Ne(t)}function Xe(t,e){return Xe=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Xe(t,e)}function We(t,e){(function(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")})(t,e),e.add(t)}function Ye(t,e,i){if("function"==typeof t?t===e:t.has(e))return arguments.length<3?e:i;throw new TypeError("Private element is not present on this object")}var qe=new WeakSet,Ue=function(){function t(e){var i,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),We(i=ze(this,t),qe),e=e||{},n.worker="undefined"!=typeof DedicatedWorkerGlobalScope,"string"==typeof e){var o=document.querySelector(e);o||(o=document.createElement("canvas"),e.startsWith("#")?o.id=e.replace("#",""):(e=e.replace(".",""),o.classList.add(e)),document.body.appendChild(o)),i.canvas=o}else if("undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement)i.canvas=e;else{if("object"!==Re(e))throw new Error("Invalid selector");n=Ee(Ee({},e),n)}return i.eventListeners=new Map,i.assets=new Map,i.timers=new Map,Ye(qe,i,Ke).call(i,n),i}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&Xe(t,e)}(t,B),function(t,e,i){return e&&Oe(t.prototype,e),i&&Oe(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(t,[{key:"_setupEventListeners",value:function(){var t=this;if("undefined"==typeof window||"undefined"==typeof document)return this.config.worker?void this.on("worker_msg",this._workerEventListeners):void this.warn("Browser environment is required. This feature is only available in browser context.");new ResizeObserver(this._handleResize.bind(this)).observe(this.canvas);var e=this.config.resizeTarget;if("window"===e)window.addEventListener("resize",function(){t.resize(window.innerWidth,window.innerHeight)});else if("document"===e)window.addEventListener("resize",function(){t.resize(document.documentElement.clientWidth,document.documentElement.clientHeight)});else{var i=document.querySelector(e);i&&ResizeObserver&&new ResizeObserver(function(){return t._handleResize()}).observe(i)}document.addEventListener("visibilitychange",function(){if(document.hidden)return t.stop();t.start()}),this.canvas.addEventListener("click",this._handleClick.bind(this)),this.canvas.addEventListener("contextmenu",this._handleRightClick.bind(this)),this.canvas.addEventListener("mousemove",this._handleMouseMove.bind(this)),this.canvas.addEventListener("mousedown",this._handleMouseDown.bind(this)),this.canvas.addEventListener("mouseup",this._handleMouseUp.bind(this)),this.canvas.addEventListener("touchstart",this._handleTouchStart.bind(this)),this.canvas.addEventListener("touchmove",this._handleTouchMove.bind(this)),this.canvas.addEventListener("touchend",this._handleTouchEnd.bind(this)),this.canvas.addEventListener("touchcancel",this._handleTouchCancel.bind(this)),this.canvas.addEventListener("wheel",this._handleWheel.bind(this),{passive:!1}),this.canvas.addEventListener("keydown",this._handleKeyDown.bind(this)),this.canvas.addEventListener("keyup",this._handleKeyUp.bind(this))}},{key:"_workerEventListeners",value:function(t){var e=t.data;if("canvas_event"!==(null==e?void 0:e.action))"visibility_change"!==(null==e?void 0:e.action)?("boundingClientRect"===(null==e?void 0:e.action)&&(this.canvas.getBoundingClientRect=function(){return e.rect}),"resizedTarget"===(null==e?void 0:e.action)&&this._updateCanvasSize(e.width,e.height)):e.hidden?this.stop():this.start();else switch(e.event.type){case"click":this._handleClick(e.event);break;case"contextmenu":this._handleRightClick(e.event);break;case"keydown":this._handleKeyDown(e.event);break;case"keyup":this._handleKeyUp(e.event);break;case"mousemove":this._handleMouseMove(e.event);break;case"mousedown":this._handleMouseDown(e.event);break;case"mouseup":this._handleMouseUp(e.event);break;case"touchstart":this._handleTouchStart(e.event);break;case"touchmove":this._handleTouchMove(e.event);break;case"touchend":this._handleTouchEnd(e.event);break;case"touchcancel":this._handleTouchCancel(e.event);break;case"wheel":this._handleWheel(e.event)}}},{key:"workerSend",value:(n=Le(Ve().m(function t(){var e,i,n,o,s=this,r=arguments;return Ve().w(function(t){for(;;)switch(t.n){case 0:if(e=r.length>0&&void 0!==r[0]?r[0]:{},i=r.length>1&&void 0!==r[1]?r[1]:null,n=r.length>2&&void 0!==r[2]?r[2]:null,this.config.worker){t.n=1;break}return t.a(2,this);case 1:return postMessage(Ee({wid:this.config.worker},e)),i&&"function"==typeof n&&(o=function(t){t.data.action===i&&(n(t),s.off("worker_msg",o))},this.on("worker_msg",o)),t.a(2,this)}},t,this)})),function(){return n.apply(this,arguments)})},{key:"quality",value:function(t){return void 0===t?this.config.quality:(this.config.quality=t,this._applyQuality(t),this)}},{key:"_applyQuality",value:function(t){this.canvas.width=this.baseWidth*t,this.canvas.height=this.baseHeight*t,this.canvas.style.width=this.baseWidth+"px",this.canvas.style.height=this.baseHeight+"px",this.ctx.scale(t,t)}},{key:"on",value:function(t,e){var i=this;if(Array.isArray(t))return t.forEach(function(t){i.on(t,e)}),this;if("object"===Re(t)){for(var n in t)this.on(n,t[n]);return this}return this.eventListeners.has(t)||this.eventListeners.set(t,new Set),this.eventListeners.get(t).add(e),this}},{key:"one",value:function(t,e){var i=this;if(Array.isArray(t))return t.forEach(function(t){i.one(t,e)}),this;if("object"===Re(t)){for(var n in t)this.one(n,t[n]);return this}var o=function(n){e.call(i,n),i.off(t,o)};return this.on(t,o),this}},{key:"trigger",value:function(t){for(var e=this,i=arguments.length,n=new Array(i>1?i-1:0),o=1;o<i;o++)n[o-1]=arguments[o];if(Array.isArray(t))return t.forEach(function(t){e.trigger(t,n)}),this;if(!this.eventListeners.has(t))return this;var s,r=ke(this.eventListeners.get(t));try{for(r.s();!(s=r.n()).done;){s.value.apply(this,n)}}catch(t){r.e(t)}finally{r.f()}return this}},{key:"off",value:function(t,e){var i=this;return Array.isArray(t)?(t.forEach(function(t){return i.off(t,e)}),this):(this.eventListeners.has(t)&&this.eventListeners.get(t).delete(e),this)}},{key:"timer",value:function(t,e){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=Symbol(),o={callback:t,delay:e,repeat:i,lastTime:performance.now(),accumulated:0,isRunning:!0};return this.timers.set(n,o),n}},{key:"timeout",value:function(t,e){return this.timer(t,e,!1)}},{key:"clearTimer",value:function(t){return this.timers.delete(t)}},{key:"updateTimers",value:function(t){var e=this;this.timers.forEach(function(i,n){if(i.isRunning){var o=t-i.lastTime;for(i.accumulated+=o;i.accumulated>=i.delay;){if(i.callback(),!i.repeat){e.clearTimer(n);break}i.accumulated-=i.delay}i.lastTime=t}})}},{key:"delay",value:(i=Le(Ve().m(function t(e){var i=this;return Ve().w(function(t){for(;;)if(0===t.n)return t.a(2,new Promise(function(t){return i.timeout(t,e)}))},t)})),function(t){return i.apply(this,arguments)})},{key:"addBackground",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.background.add(t,e),this}},{key:"removeBackground",value:function(t){return this.background.remove(t),this}},{key:"updateBackground",value:function(t,e){return this.background.update(t,e),this}},{key:"clearBackgrounds",value:function(){return this.background.clear(),this}},{key:"getBackground",value:function(t){return this.background.get(t),this}},{key:"setBackgroundOrder",value:function(t,e){return this.background.setOrder(t,e),this}},{key:"setBackgroundVisible",value:function(t,e){return this.background.setVisible(t,e),this}},{key:"enableGrid",value:function(){return this.gridEnabled=!0,this}},{key:"disableGrid",value:function(){return this.gridEnabled=!1,this}},{key:"toggleGrid",value:function(){return this.gridEnabled=!this.gridEnabled,this}},{key:"setGridSize",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t;return this.grid.setSize(t,e),this}},{key:"setGridColors",value:function(t,e){return this.grid.setColors(t,e),this}},{key:"setGridLineWidth",value:function(t,e){return this.grid.setLineWidth(t,e),this}},{key:"setMajorGrid",value:function(t,e,i){return this.grid.setMajorGrid(t,e,i),this}},{key:"setGridBounds",value:function(t){return this.grid.setBounds(t),this}},{key:"setGridOrigin",value:function(t,e){return this.grid.setOrigin(t,e),this}},{key:"setGridVisibilityRange",value:function(t,e){return this.grid.setVisibilityRange(t,e),this}},{key:"snapToGrid",value:function(t,e){return this.grid.snapToGrid(t,e)}},{key:"getGridCell",value:function(t,e){return this.grid.getGridCell(t,e)}},{key:"cellToWorld",value:function(t,e){return this.grid.cellToWorld(t,e)}},{key:"startLoop",value:function(){this.running=!0,requestAnimationFrame(this.loop.bind(this))}},{key:"loop",value:function(t){if(this.running){var e=1e3/this.config.fps,i=t-this.lastTime;if(i=Math.min(i,this.maxDeltaTime),this.debugger.active){this.debugger.frameCount++;var n=t,o=n-this.debugger.lastFpsUpdate;if(o>=1e3){var s=Math.round(1e3*this.debugger.frameCount/o),r=this.config.fps,a=Math.min(Math.round(s/r*100),100);this.debugger.fps={target:r,actual:Math.min(s,r),ratio:a},this.debugger.frameCount=0,this.debugger.lastFpsUpdate=n}}i>=e&&(this.clear(),this.updateTimers(t),this.update(i),this.render(),this.lastTime=t-i%e),requestAnimationFrame(this.loop.bind(this))}}},{key:"update",value:function(t){this.camera.update(),this.background._updateLayers(t),this.physicsEnabled&&this.physics.update(t),this.activeTileMap&&this.tileMap.update();var e,i=ke(this.entities);try{for(i.s();!(e=i.n()).done;){var n=De(e.value,2),o=(n[0],n[1]);"function"==typeof o.update&&o.update(t)}}catch(t){i.e(t)}finally{i.f()}if(this.collisionEnabled&&!this.physicsEnabled){var s=Array.from(this.entities.values()).filter(function(t){var e;return null===(e=t.collision)||void 0===e?void 0:e.enabled});this.collision.updateCollisions(s)}this.emitters.update(t),this.trigger("update",t)}},{key:"render",value:function(){var t=this;this.clear(),this.ctx.save(),this.ctx.scale(this.config.quality,this.config.quality),this.camera.apply(),this.trigger("beforerender",this.ctx),this.background._renderLayers(this.ctx,!1),this.activeTileMap&&this.tileMap.render(this.activeTileMap),Array.from(this.entities.values()).sort(function(t,e){return t.zIndex-e.zIndex}).forEach(function(e){"function"==typeof e.render&&(t.ctx.save(),e.render(t.ctx),t.ctx.restore())}),this.trigger("render",this.ctx),this.emitters.render(this.ctx),this.background._renderLayers(this.ctx,!0),this.gridEnabled&&this.grid.render(this.ctx),this.ctx.restore(),this.renderDebugInfo()}},{key:"start",value:function(){return this.running||(this.timers.forEach(function(t){t.isRunning=!0,t.lastTime=performance.now()}),this.audio.resumeAll(),this.startLoop(),this.trigger("start")),this}},{key:"stop",value:function(){return this.running=!1,this.pressedKeys.clear(),this.timers.forEach(function(t){t.isRunning=!1}),this.audio.pauseAll(),this.trigger("stop"),this}},{key:"clear",value:function(){this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle=this.config.background,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}},{key:"reset",value:function(){var t;this.trigger("reset"),this.stop(),this.pressedKeys.clear(),this.entities.clear(),this.eventListeners.clear(),this.timers.clear(),this.assets.clear(),this.collision.reset(),this.audio.cleanup(),this.camera.reset(),this.background.clear(),this.emitters.clear(),this.physics.reset(),this.draggedEntity=null,this.draggedEntities.clear(),this.hoveredEntity=null,this.activeTileMap=null,this.animations={},this.lastTime=0,this.debugger={active:!1,level:"advanced",fps:{target:this.config.fps,actual:this.config.fps,ratio:100},lastFpsUpdate:performance.now(),frameCount:0,targetFrameCount:0},this.clear(),this._applyQuality(this.config.quality);var e={attributes:{tabIndex:0,width:this.config.width*this.config.quality,height:this.config.height*this.config.quality},style:{width:this.config.width+"px",height:this.config.height+"px",outline:"none",backgroundColor:this.config.background,imageRendering:this.config.imageRendering||(null===(t=this.canvas)||void 0===t||null===(t=t.style)||void 0===t?void 0:t.imageRendering)}};return Object.assign(this.canvas,e.attributes),Object.assign(this.canvas.style,e.style),this.gridEnabled=Boolean(this.config.grid),this.physicsEnabled=Boolean(this.config.physics),this.collisionEnabled=Boolean(this.config.collision),this.background=new H(this),this.camera=new Y(this,this.config.camera),this.grid=new it(this,this.config.grid||{}),this.physics=new Et(this,this.config.physics),this.collision=new m,this.tileMap=new Ut(this),this.emitters=new he(this),this.workerSend({action:"update_canvas",props:e}),this}},{key:"enableDebugger",value:function(){return this.debugger.active=!0,this}},{key:"disableDebugger",value:function(){var t=this;return this.debugger.active=!1,this.entities.forEach(function(e){t.disableEntityDebug(e)}),this}},{key:"renderDebugInfo",value:function(){if(this.debugger.active){var t=this.ctx,e=10,i=20,n=e;t.save(),t.fillStyle="rgba(0,0,0,0.6)",t.fillRect(e,e,300,500),t.font="12px monospace",t.fillStyle="#ffffff",t.fillStyle="#00ff00",t.fillText("=== Performance ===",15,n+=i),t.fillStyle="#ffffff",t.fillText("FPS: ".concat(this.debugger.fps.actual),15,n+=i),t.fillText("Max FPS: ".concat(this.debugger.fps.target),15,n+=i),t.fillText("FPS Ratio: ".concat(this.debugger.fps.ratio,"%"),15,n+=i),t.fillStyle="#00ff00",t.fillText("=== System ===",15,n+=30),t.fillStyle="#ffffff",t.fillText("Quality: ".concat(this.config.quality,"x"),15,n+=i),t.fillText("Canvas Size: ".concat(this.canvas.width,"x").concat(this.canvas.height),15,n+=i),t.fillStyle="#00ff00",t.fillText("=== State ===",15,n+=30),t.fillStyle="#ffffff";var o=0,s=0,r=function(t){o++,t.styles.visible&&s++,t.children.forEach(r)};this.entities.forEach(r),t.fillText("Total Entities: ".concat(o),15,n+=i),t.fillText("Visible Entities: ".concat(s),15,n+=i),t.fillStyle="#00ff00",t.fillText("=== Physics & Collision ===",15,n+=30),t.fillStyle="#ffffff";var a=0;this.entities.forEach(function(t){var e;null!==(e=t.collision)&&void 0!==e&&e.enabled&&a++}),t.fillText("Physics: ".concat(this.physicsEnabled?"Enabled":"Disabled"),15,n+=i),t.fillText("Collision: ".concat(this.collisionEnabled?"Enabled":"Disabled"),15,n+=i),t.fillText("Collision Objects: ".concat(a),15,n+=i),t.fillStyle="#00ff00",t.fillText("=== Grid System ===",15,n+=30),t.fillStyle="#ffffff",t.fillText("Grid Enabled: ".concat(this.gridEnabled?"Yes":"No"),15,n+=i),this.gridEnabled&&(t.fillText("Grid Size: ".concat(this.grid.width,"x").concat(this.grid.height),15,n+=i),t.fillText("Major Grid: Every ".concat(this.grid.majorGridEvery),15,n+=i),t.fillText("Zoom Range: ".concat(this.grid.minZoomToShow," - ").concat(this.grid.maxZoomToShow),15,n+=i)),t.restore()}}},{key:"log",value:function(){for(var t,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return this.debugger&&this.debugger.active&&(t=console).log.apply(t,["%c[Pixalo LOG]","color: #2196f3;"].concat(i)),this}},{key:"info",value:function(){for(var t,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return this.debugger&&this.debugger.active&&(t=console).info.apply(t,["%c[Pixalo INFO]","color: #4491F8;"].concat(i)),this}},{key:"warn",value:function(){for(var t,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return this.debugger&&this.debugger.active&&(t=console).warn.apply(t,["%c[Pixalo WARN]","color: #ff9800;"].concat(i)),this}},{key:"error",value:function(){for(var t,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return this.debugger&&this.debugger.active&&(t=console).error.apply(t,["%c[Pixalo ERROR]","color: #f44336;"].concat(i)),this}},{key:"loadAsset",value:(e=Le(Ve().m(function t(e,i,n){var o,s=this,r=arguments;return Ve().w(function(t){for(;;)switch(t.n){case 0:if(o=r.length>3&&void 0!==r[3]?r[3]:{},e&&i&&n){t.n=1;break}return t.a(2,Promise.reject(new Error("Invalid parameters for Assets.load")));case 1:if(!this.assets.has(i)){t.n=2;break}return t.a(2,Promise.resolve(this.assets.get(i)));case 2:return t.a(2,new Promise(function(){var t=Le(Ve().m(function t(r,a){var l,h,c,m,u,y,p,f,_,d,v,b,g,x,w,C,S,A,M,D,k,B;return Ve().w(function(t){for(;;)switch(t.p=t.n){case 0:D=e.toLowerCase(),t.n="image"===D||"tiles"===D?1:"spritesheet"===D?8:"audio"===D?18:19;break;case 1:return t.p=1,t.n=2,fetch(n);case 2:if((h=t.v).ok){t.n=3;break}throw new Error("Failed to fetch image: ".concat(h.statusText));case 3:return t.n=4,h.blob();case 4:return c=t.v,t.n=5,createImageBitmap(c);case 5:if(l=t.v,"tiles"===e.toLowerCase())for(o.tileSize||(s.warn("No tileSize specified for tiles"),o.tileSize=32),o.tiles||(s.warn("No tiles configuration specified for tiles"),o.tiles={}),o.columns=Math.floor(l.width/o.tileSize),o.rows=Math.floor(l.height/o.tileSize),m=0,u=Object.entries(o.tiles);m<u.length;m++)y=De(u[m],2),p=y[0],f=y[1],Array.isArray(f)&&(_=De(f,2),d=_[0],v=_[1],o.tiles[p]={x:d*o.tileSize,y:v*o.tileSize,width:o.tileSize,height:o.tileSize});Ye(qe,s,Qe).call(s,l,o),s.assets.set(i,{id:i,asset:l,config:o,type:e}),r({asset:l,config:o,type:e}),t.n=7;break;case 6:t.p=6,k=t.v,a(new Error("Failed to load image: ".concat(k.message)));case 7:return t.a(3,20);case 8:return t.p=8,t.n=9,fetch(n);case 9:if((b=t.v).ok){t.n=10;break}throw new Error("Failed to fetch spritesheet: ".concat(b.statusText));case 10:return t.n=11,b.blob();case 11:return g=t.v,t.n=12,createImageBitmap(g);case 12:l=t.v,x=0,w=["columns","rows","width","height"];case 13:if(!(x<w.length)){t.n=15;break}if(C=w[x],o[C]){t.n=14;break}throw s.error("Missing required parameter: ".concat(C)),new Error("Missing required parameter: ".concat(C));case 14:x++,t.n=13;break;case 15:for(o.originOffset=o.originOffset||[0,0],o.margin=o.margin||[0,0],Array.isArray(o.originOffset)&&2===o.originOffset.length||(o.originOffset=[0,0]),Array.isArray(o.margin)&&2===o.margin.length||(o.margin=[0,0]),o.totalFrames=o.columns*o.rows,o.frames=[],S=0;S<o.rows;S++)for(A=0;A<o.columns;A++)o.frames.push({x:o.originOffset[0]+A*(o.width+o.margin[0]),y:o.originOffset[1]+S*(o.height+o.margin[1]),width:o.width,height:o.height});s.assets.set(i,{id:i,asset:l,config:o,type:e}),r({asset:l,config:o,type:e}),t.n=17;break;case 16:t.p=16,B=t.v,a(new Error("Failed to load spritesheet: ".concat(B.message)));case 17:return t.a(3,20);case 18:return s.config.worker?(s.audio.load(i,n,o),M=function(t){"pixalo_audio_loaded"===t.data.type&&(r(),s.off("worker_msg",M))},s.on("worker_msg",M)):s.audio.load(i,n,o).then(r).catch(a),t.a(3,20);case 19:a(new Error("Unsupported asset type: ".concat(e)));case 20:return t.a(2)}},t,null,[[8,16],[1,6]])}));return function(e,i){return t.apply(this,arguments)}}()))}},t,this)})),function(t,i,n){return e.apply(this,arguments)})},{key:"getAsset",value:function(t){return this.assets.get(t)||null}},{key:"deleteAsset",value:function(t){return this.assets.delete(t),this}},{key:"clearAssets",value:function(){return this.assets.clear(),this}},{key:"defineAnimation",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.animations[t]={keyframes:e,options:{duration:i.duration||1e3,repeat:i.repeat||0,easing:i.easing||"linear"}},this}},{key:"append",value:function(t){var e,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t instanceof vt?t:i instanceof vt?i:new vt(t,Ee(Ee({},i),{},{engine:this}));return this.entities.has(n.id)&&(n.id="".concat(n.id,"_").concat(Date.now())),n.engine=this,this.entities.set(n.id,n),null===(e=n.updatePosition)||void 0===e||e.call(n),this.physicsEnabled&&(n.physics||i.physics)&&this.physics.addEntity(n,n.physics||i.physics),n}},{key:"getAllEntities",value:function(){return this.entities}},{key:"getSortedEntitiesByZIndex",value:function(){return Array.from(this.entities.values()).sort(function(t,e){return e.zIndex-t.zIndex})}},{key:"find",value:function(t){return this.entities.get(t)}},{key:"findByClass",value:function(t){return(t=t.trim())?Array.from(this.entities).filter(function(e){return De(e,2)[1].class.has(t)}).map(function(t){return De(t,2)[1]}):(this.warn("ClassName is required"),[])}},{key:"isEntity",value:function(t){return t instanceof vt}},{key:"kill",value:function(t){var e=this.entities.get(t);return!!e&&e.kill()}},{key:"enableCollisions",value:function(){return this.collisionEnabled=!0,this}},{key:"checkCollision",value:function(t,e){return this.collision.detectCollisionDetailed(t,e)}},{key:"checkGroupCollision",value:function(t,e){var i,n=ke(t);try{for(n.s();!(i=n.n()).done;){var o,s=i.value,r=ke(e);try{for(r.s();!(o=r.n()).done;){var a=o.value;if(this.detectCollisionDetailed(s,a))return{entity1:s,entity2:a}}}catch(t){r.e(t)}finally{r.f()}}}catch(t){n.e(t)}finally{n.f()}return!1}},{key:"disableCollisions",value:function(){return this.collisionEnabled=!1,this}},{key:"createTileMap",value:function(t){return this.tileMap.create(t)}},{key:"renderTileMap",value:function(t){return this.activeTileMap=t,this}},{key:"addTile",value:function(t,e){var i;return(i=this.tileMap).addTile.apply(i,arguments),this}},{key:"exportTileMap",value:function(t){return this.tileMap.exportLayers(t)}},{key:"createEmitter",value:function(t,e){return this.emitters.create(t,e)}},{key:"shot",value:function(){var e=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=i.format,o=void 0===n?"png":n,s=i.quality,r=void 0===s?1:s,a=i.backgroundColor,l=void 0===a?this.config.background:a,h=i.download,c=void 0!==h&&h,m=i.filename,u=void 0===m?"pixalo-screenshot-".concat(Date.now()):m;if(!["png","jpeg","webp"].includes(o.toLowerCase()))return this.error("Invalid format. Supported formats are: png, jpeg, webp");if(r<0||r>1)return this.error("Quality must be between 0 and 1");if(this.config.worker)return new Promise(function(t){e.workerSend(Ee({action:"take_screenshot"},i),"screenshot_taken",function(e){return t(Ee(Ee({},e.data.details),{},{revoke:function(){return URL.revokeObjectURL(v)}}))})});var y=document.createElement("canvas"),p=y.getContext("2d");y.width=this.canvas.width,y.height=this.canvas.height,l&&(p.fillStyle=l,p.fillRect(0,0,y.width,y.height)),p.drawImage(this.canvas,0,0);var f="image/".concat(o.toLowerCase()),_=y.toDataURL(f,r),d=t.dataURLToBlob(_),v=URL.createObjectURL(d);if(c){var b=document.createElement("a");b.download="".concat(u,".").concat(o.toLowerCase()),b.href=_,b.click()}return y.remove(),{dataURL:_,blob:d,blobURL:v,width:y.width,height:y.height,revoke:function(){return URL.revokeObjectURL(v)}}}}]);var e,i,n}();function Ke(t){return Ze.apply(this,arguments)}function Ze(){return Ze=Le(Ve().m(function t(e){var i,n,o,s,r,a,l,h=arguments;return Ve().w(function(t){for(;;)switch(t.n){case 0:if(a=h.length>1&&void 0!==h[1]&&h[1],null==e||!e.worker||a){t.n=1;break}return t.a(2,Ye(qe,this,He).call(this,e));case 1:this.ctx=this.canvas.getContext("2d"),this.entities=new Map,this.window={width:(null==e||null===(i=e.window)||void 0===i?void 0:i.width)||("undefined"!=typeof window?window.innerWidth:0),height:(null==e||null===(n=e.window)||void 0===n?void 0:n.height)||("undefined"!=typeof window?window.innerHeight:0),devicePixelRatio:(null==e||null===(o=e.window)||void 0===o?void 0:o.devicePixelRatio)||("undefined"!=typeof window?window.devicePixelRatio:0)},this.config={worker:e.worker||!1,width:e.width||this.canvas.width||0,height:e.height||this.canvas.height||0,fps:e.fps||60,grid:e.grid||!1,quality:e.quality||this.window.devicePixelRatio,physics:e.physics||{},collision:e.collision||{},background:e.background||"#ffffff",resizeTarget:e.resizeTarget||!1},this.baseWidth=this.config.width,this.baseHeight=this.config.height,this.debugger={active:e.debugger||!1,level:"advanced",fps:{target:this.config.fps,actual:this.config.fps,ratio:100},lastFpsUpdate:performance.now(),frameCount:0,targetFrameCount:0},this.running=!1,this.lastTime=0,this.draggedEntity=null,this.draggedEntities=new Map,this.hoveredEntity=null,this.background=new H(this),this.camera=new Y(this,e.camera),this.gridEnabled=Boolean(e.grid),this.grid=new it(this,e.grid||{}),this.physicsEnabled=Boolean(e.physics),this.physics=new Et(this,e.physics),this.collisionEnabled=Boolean(e.collision),this.collision=new m,this.activeTileMap=null,this.tileMap=new Ut(this),this.emitters=new he(this),this.audio=new Me(this.config.worker),this.animations={},this.maxDeltaTime=1e3/30,l={attributes:{tabIndex:0,width:this.config.width*this.config.quality,height:this.config.height*this.config.quality},style:{width:this.config.width+"px",height:this.config.height+"px",outline:"none",backgroundColor:this.config.background,imageRendering:this.config.imageRendering||(null===(s=this.canvas)||void 0===s||null===(s=s.style)||void 0===s?void 0:s.imageRendering)}},null!==(r=this.canvas)&&void 0!==r&&r.style||(this.canvas.style={}),Object.assign(this.canvas,l.attributes),Object.assign(this.canvas.style,l.style),this.workerSend({action:"update_canvas",props:l}),this.config.resizeTarget&&this.workerSend({action:"set_resize_target",target:this.config.resizeTarget}),this._setupEventListeners(),this.trigger("ready");case 2:return t.a(2)}},t,this)})),Ze.apply(this,arguments)}function He(t){var e=this;if("undefined"==typeof DedicatedWorkerGlobalScope)throw new Error("Please run Pixalo in the Worker environment.");onmessage=function(t){return e.trigger("worker_msg",t)},onerror=function(t){return e.trigger("worker_err",t)},this.one("worker_msg",function(i){var n=i.data;t.worker=n.wid,t.window=Ee(Ee({},t.window),n.window),e.canvas=n.canvas,Ye(qe,e,Ke).call(e,t,!0),e.workerSend({wid:t.worker,action:"ready"}),e.on("worker_msg",e.audio._handleWorker)})}function Qe(t,e){if(!e.tileSize)for(var i in e)if(i in t)try{t[i]=e[i]}catch(t){this.warn('Failed to set property "'.concat(i,'" on asset:'),t)}}Ue.prototype.Bezier=L,Ue.prototype.Ease=E;const $e=Ue;var ti;function ei(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=function(t,e){if(t){if("string"==typeof t)return ii(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?ii(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return r=t.done,t},e:function(t){a=!0,s=t},f:function(){try{r||null==i.return||i.return()}finally{if(a)throw s}}}}function ii(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function ni(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function oi(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var t,e,i="function"==typeof Symbol?Symbol:{},n=i.iterator||"@@iterator",o=i.toStringTag||"@@toStringTag";function s(i,n,o,s){var l=n&&n.prototype instanceof a?n:a,h=Object.create(l.prototype);return si(h,"_invoke",function(i,n,o){var s,a,l,h=0,c=o||[],m=!1,u={p:0,n:0,v:t,a:y,f:y.bind(t,4),d:function(e,i){return s=e,a=0,l=t,u.n=i,r}};function y(i,n){for(a=i,l=n,e=0;!m&&h&&!o&&e<c.length;e++){var o,s=c[e],y=u.p,p=s[2];i>3?(o=p===n)&&(l=s[(a=s[4])?5:(a=3,3)],s[4]=s[5]=t):s[0]<=y&&((o=i<2&&y<s[1])?(a=0,u.v=n,u.n=s[1]):y<p&&(o=i<3||s[0]>n||n>p)&&(s[4]=i,s[5]=n,u.n=p,a=0))}if(o||i>1)return r;throw m=!0,n}return function(o,c,p){if(h>1)throw TypeError("Generator is already running");for(m&&1===c&&y(c,p),a=c,l=p;(e=a<2?t:l)||!m;){s||(a?a<3?(a>1&&(u.n=-1),y(a,l)):u.n=l:u.v=l);try{if(h=2,s){if(a||(o="next"),e=s[o]){if(!(e=e.call(s,l)))throw TypeError("iterator result is not an object");if(!e.done)return e;l=e.value,a<2&&(a=0)}else 1===a&&(e=s.return)&&e.call(s),a<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),a=1);s=t}else if((e=(m=u.n<0)?l:i.call(n,u))!==r)break}catch(e){s=t,a=1,l=e}finally{h=1}}return{value:e,done:m}}}(i,o,s),!0),h}var r={};function a(){}function l(){}function h(){}e=Object.getPrototypeOf;var c=[][n]?e(e([][n]())):(si(e={},n,function(){return this}),e),m=h.prototype=a.prototype=Object.create(c);function u(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,h):(t.__proto__=h,si(t,o,"GeneratorFunction")),t.prototype=Object.create(m),t}return l.prototype=h,si(m,"constructor",h),si(h,"constructor",l),l.displayName="GeneratorFunction",si(h,o,"GeneratorFunction"),si(m),si(m,o,"Generator"),si(m,n,function(){return this}),si(m,"toString",function(){return"[object Generator]"}),(oi=function(){return{w:s,m:u}})()}function si(t,e,i,n){var o=Object.defineProperty;try{o({},"",{})}catch(t){o=0}si=function(t,e,i,n){if(e)o?o(t,e,{value:i,enumerable:!n,configurable:!n,writable:!n}):t[e]=i;else{var s=function(e,i){si(t,e,function(t){return this._invoke(e,i,t)})};s("next",0),s("throw",1),s("return",2)}},si(t,e,i,n)}function ri(t){return ri="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ri(t)}function ai(t,e,i,n,o,s,r){try{var a=t[s](r),l=a.value}catch(t){return void i(t)}a.done?e(l):Promise.resolve(l).then(n,o)}function li(t){return function(){var e=this,i=arguments;return new Promise(function(n,o){var s=t.apply(e,i);function r(t){ai(s,n,o,r,a,"next",t)}function a(t){ai(s,n,o,r,a,"throw",t)}r(void 0)})}}function hi(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,mi(n.key),n)}}function ci(t,e,i){return(e=mi(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function mi(t){var e=function(t,e){if("object"!=ri(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=ri(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==ri(e)?e:e+""}function ui(t,e,i){if("function"==typeof t?t===e:t.has(e))return arguments.length<3?e:i;throw new TypeError("Private element is not present on this object")}var yi=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t)}return function(t,e,i){return e&&hi(t.prototype,e),i&&hi(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(t,null,[{key:"register",value:(e=li(oi().m(function e(i,n){var o,s,r,a,l,h,c,m,u,y=arguments;return oi().w(function(e){for(;;)switch(e.p=e.n){case 0:if(o=y.length>2&&void 0!==y[2]?y[2]:{},s=ui(t,this,pi).call(this,i),r="worker_".concat(Math.floor(99999*Math.random())),a=s.transferControlToOffscreen(),l=null,!o.fetch){e.n=5;break}return e.p=1,e.n=2,ui(t,this,fi).call(this,n,"object"===ri(o.fetch)?o.fetch:{});case 2:l=e.v,e.n=4;break;case 3:throw e.p=3,u=e.v,null===(h=o.onerror)||void 0===h||h.call(o,{code:0,text:"Fetch worker failed",error:u}),u;case 4:e.n=6;break;case 5:n=$e.scriptToUrl(n);case 6:return(c=new Worker(l||n,{type:o.type||"module"})).postMessage({wid:r,canvas:a,window:{width:window.innerWidth,height:window.innerHeight,devicePixelRatio:window.devicePixelRatio}},[a]),c.onmessage=function(e){var i;l&&(URL.revokeObjectURL(l),l=null),di.call(t,e),null==o||null===(i=o.onmessage)||void 0===i||i.call(o,e)},c.onerror=function(e){var i;l&&(URL.revokeObjectURL(l),l=null),vi.call(t,e),null==o||null===(i=o.onerror)||void 0===i||i.call(o,e)},(m=new Me(r)).worker=c,t.workers.set(r,{canvas:s,offscreen:a,worker:c,audio:m}),e.a(2,r)}},e,this,[[1,3]])})),function(t,i){return e.apply(this,arguments)})},{key:"send",value:function(t,e){this.workers.has(t)&&this.workers.get(t).worker.postMessage(function(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?ni(Object(i),!0).forEach(function(e){ci(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):ni(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}({wid:t},e))}},{key:"destroy",value:function(t){if(this.workers.has(t)){var e=this.workers.get(t);e.audio.cleanup(),e.worker.terminate(),this.workers.delete(t)}}}]);var e}();function pi(t){var e;if("string"==typeof t)(e=document.querySelector(t))||(e=document.createElement("canvas"),t.startsWith("#")?e.id=t.replace("#",""):(t=t.replace(".",""),e.classList.add(t)),document.body.appendChild(e));else{if(!(t instanceof HTMLCanvasElement))throw new Error("Invalid selector");e=t}return e.tabIndex=0,e.style.outline="none",e}function fi(t){return _i.apply(this,arguments)}function _i(){return _i=li(oi().m(function t(e){var i,n,o,s=arguments;return oi().w(function(t){for(;;)switch(t.n){case 0:return i=s.length>1&&void 0!==s[1]?s[1]:{},t.n=1,fetch(e,i);case 1:if((n=t.v).ok){t.n=2;break}throw new Error("fetch failed ".concat(n.status));case 2:return t.n=3,n.blob();case 3:return o=t.v,t.a(2,URL.createObjectURL(o))}},t)})),_i.apply(this,arguments)}function di(t){var e=this,i=t.data;if(this.workers.has(i.wid)){var n=this.workers.get(i.wid);switch(i.action){case"ready":n.ready=!0,ui(ti,this,bi).call(this,i.wid);break;case"update_canvas":Object.assign(n.canvas.style,i.props.style);break;case"set_resize_target":var o=i.target;if("window"===o)window.addEventListener("resize",function(){e.send(i.wid,{action:"resizedTarget",width:window.innerWidth,height:window.innerHeight})});else if("document"===o)document.addEventListener("resize",function(){return e.send(i.wid,{action:"resizedTarget",width:document.innerWidth,height:document.innerHeight})});else{var s=document.querySelector(o);s&&ResizeObserver&&new ResizeObserver(function(){return e.send(i.wid,{action:"resizedTarget",width:s.offsetWidth,height:s.offsetHeight})}).observe(s)}break;case"take_screenshot":ui(ti,this,xi).call(this,i.wid,i)}n.audio._handleWorker(t)}}function vi(t){}function bi(t){gi.call(ti,t)}function gi(t){var e=this,i=this.workers.get(t),n=function(t,e){var n=i.canvas.getBoundingClientRect(),o={type:e,clientX:t.clientX,clientY:t.clientY,offsetX:t.offsetX,offsetY:t.offsetY,canvasRect:{x:n.x,y:n.y,width:n.width,height:n.height},relativeX:t.clientX-n.left,relativeY:t.clientY-n.top,button:t.button,buttons:t.buttons,altKey:t.altKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey,timeStamp:t.timeStamp};return"wheel"===e&&(o.deltaX=t.deltaX,o.deltaY=t.deltaY,o.deltaZ=t.deltaZ,o.deltaMode=t.deltaMode),o},o=function(t,e){return{type:e,key:t.key,code:t.code,keyCode:t.keyCode,altKey:t.altKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey,repeat:t.repeat,timeStamp:t.timeStamp}},s=function(t,e){return{type:e,touches:Array.from(t.touches).map(function(t){return{identifier:t.identifier,clientX:t.clientX,clientY:t.clientY,pageX:t.pageX,pageY:t.pageY,screenX:t.screenX,screenY:t.screenY}}),changedTouches:Array.from(t.changedTouches).map(function(t){return{identifier:t.identifier,clientX:t.clientX,clientY:t.clientY,pageX:t.pageX,pageY:t.pageY,screenX:t.screenX,screenY:t.screenY}}),altKey:t.altKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey,timeStamp:t.timeStamp}},r=function(){var n=i.canvas.getBoundingClientRect();e.send(t,{action:"boundingClientRect",rect:{x:n.x,y:n.y,width:n.width,height:n.height,top:n.top,left:n.left,right:n.right,bottom:n.bottom}})};r();var a=new ResizeObserver(function(t){var e,n=ei(t);try{for(n.s();!(e=n.n()).done;){e.value.target===i.canvas&&r()}}catch(t){n.e(t)}finally{n.f()}});a.observe(i.canvas),i.resizeObserver=a,i.canvas.addEventListener("contextmenu",function(i){i.preventDefault(),e.send(t,{action:"canvas_event",event:n(i,"contextmenu")})}),i.canvas.addEventListener("mousemove",function(i){e.send(t,{action:"canvas_event",event:n(i,"mousemove")})}),i.canvas.addEventListener("mousedown",function(i){e.send(t,{action:"canvas_event",event:n(i,"mousedown")})}),i.canvas.addEventListener("mouseup",function(i){e.send(t,{action:"canvas_event",event:n(i,"mouseup")})}),i.canvas.addEventListener("wheel",function(i){i.preventDefault(),e.send(t,{action:"canvas_event",event:n(i,"wheel")})}),i.canvas.addEventListener("keydown",function(i){i.preventDefault(),e.send(t,{action:"canvas_event",event:o(i,"keydown")})}),i.canvas.addEventListener("keyup",function(i){i.preventDefault(),e.send(t,{action:"canvas_event",event:o(i,"keyup")})}),i.canvas.addEventListener("touchstart",function(i){i.preventDefault(),e.send(t,{action:"canvas_event",event:s(i,"touchstart")})}),i.canvas.addEventListener("touchmove",function(i){i.preventDefault(),e.send(t,{action:"canvas_event",event:s(i,"touchmove")})}),i.canvas.addEventListener("touchend",function(i){i.preventDefault(),e.send(t,{action:"canvas_event",event:s(i,"touchend")})}),i.canvas.addEventListener("touchcancel",function(i){e.send(t,{action:"canvas_event",event:s(i,"touchcancel")})}),i.canvas.addEventListener("pointerdown",function(i){e.send(t,{action:"canvas_event",event:n(i,"click")})}),document.addEventListener("visibilitychange",function(){e.send(t,{action:"visibility_change",hidden:document.hidden})}),i.canvas.addEventListener("focus",function(){e.send(t,{action:"canvas_event",event:{type:"focus"}})}),i.canvas.addEventListener("blur",function(){e.send(t,{action:"canvas_event",event:{type:"blur"}})})}function xi(t,e){var i=e.format,n=void 0===i?"png":i,o=e.quality,s=void 0===o?1:o,r=e.backgroundColor,a=void 0===r?"transparent":r,l=e.download,h=void 0!==l&&l,c=e.filename,m=void 0===c?"pixalo-screenshot-".concat(Date.now()):c,u=this.workers.get(t),y=document.createElement("canvas"),p=y.getContext("2d");y.width=u.canvas.width,y.height=u.canvas.height,a&&(p.fillStyle=a,p.fillRect(0,0,y.width,y.height)),p.drawImage(u.canvas,0,0);var f="image/".concat(n.toLowerCase()),_=y.toDataURL(f,s),d=$e.dataURLToBlob(_),v=URL.createObjectURL(d);if(h){var b=document.createElement("a");b.download="".concat(m,".").concat(n.toLowerCase()),b.href=_,b.click()}y.remove(),this.send(t,{action:"screenshot_taken",details:{dataURL:_,blob:d,blobURL:v,width:y.width,height:y.height}})}ti=yi,ci(yi,"workers",new Map);const wi=yi;if("undefined"!=typeof window){var Ci={Pixalo:$e,Workers:wi,AudioManager:Me,Background:H,Bezier:L,Camera:Y,Collision:m,Ease:E,Emitters:he,Entity:vt,Grid:it,Particle:$t,Physics:Et,TileMap:Ut,Utils:B};Object.assign(Ci,{Workers:wi,AudioManager:Me,Background:H,Bezier:L,Camera:Y,Collision:m,Ease:E,Emitters:he,Entity:vt,Grid:it,Particle:$t,Physics:Et,TileMap:Ut,Utils:B}),"undefined"!=typeof module&&module.exports&&(module.exports=Ci)}export{Me as AudioManager,H as Background,L as Bezier,Y as Camera,m as Collision,E as Ease,he as Emitters,vt as Entity,it as Grid,$t as Particle,Et as Physics,Ut as TileMap,B as Utils,wi as Workers,$e as default};