/*!
 * Copyright (c) 2025 Pixalo
 * @Repository: https://github.com/pixalo 
 * @License: MIT
 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Pixalo=e():t.Pixalo=e()}(this,()=>(()=>{"use strict";var t={d:(e,i)=>{for(var n in i)t.o(i,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:i[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};function i(t){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i(t)}function n(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,o,s,r,a=[],l=!0,c=!1;try{if(s=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;l=!1}else for(;!(l=(n=s.call(i)).done)&&(a.push(n.value),a.length!==e);l=!0);}catch(t){c=!0,o=t}finally{try{if(!l&&null!=i.return&&(r=i.return(),Object(r)!==r))return}finally{if(c)throw o}}return a}}(t,e)||s(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=s(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,a=!0,l=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return a=t.done,t},e:function(t){l=!0,r=t},f:function(){try{a||null==i.return||i.return()}finally{if(l)throw r}}}}function s(t,e){if(t){if("string"==typeof t)return r(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?r(t,e):void 0}}function r(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function a(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function l(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?a(Object(i),!0).forEach(function(e){c(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):a(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function c(t,e,i){return(e=u(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function h(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,u(n.key),n)}}function u(t){var e=function(t,e){if("object"!=i(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var o=n.call(t,e||"default");if("object"!=i(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==i(e)?e:e+""}t.d(e,{default:()=>hi});var m=function(){return function(t,e,i){return e&&h(t.prototype,e),i&&h(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.decomposedShapes=new Map,this.activeCollisions=new Map,this.lastPositions=new Map,this.customPathCache=new Map},[{key:"updateCollisions",value:function(t){var e=this;t=t.filter(function(t){var e;return t&&(null===(e=t.collision)||void 0===e?void 0:e.enabled)});var i=new Map;t.forEach(function(t){var i=e.lastPositions.get(t.id);i&&i.x===t.absoluteX+t.collision.x&&i.y===t.absoluteY+t.collision.y&&i.rotation===t.styles.rotation&&i.scaleX===t.styles.scaleX&&i.scaleY===t.styles.scaleY&&i.skewX===t.styles.skewX&&i.skewY===t.styles.skewY&&i.borderRadius===t.styles.borderRadius||e.clearCache(t.id),e.lastPositions.set(t.id,{x:t.absoluteX+t.collision.x,y:t.absoluteY+t.collision.y,rotation:t.styles.rotation,scaleX:t.styles.scaleX,scaleY:t.styles.scaleY,skewX:t.styles.skewX,skewY:t.styles.skewY,borderRadius:t.styles.borderRadius})});for(var s=0;s<t.length;s++)for(var r=s+1;r<t.length;r++){var a,c,h=t[s],u=t[r];if(null!==(a=h.collision)&&void 0!==a&&a.enabled&&null!==(c=u.collision)&&void 0!==c&&c.enabled&&h.collision.group!==u.collision.group){var m="".concat(h.id,"-").concat(u.id),y=this.detectCollisionDetailed(h,u);if(y.colliding&&!this.activeCollisions.has(m)){var p=l(l({entityA:h,entityB:u},y),{},{timestamp:Date.now()});i.set(m,p),h.engine&&h.engine.trigger("collisions",p),h.trigger("collide",{entity:u,side:y.sideA,otherSide:y.sideB,point:y.point,overlap:y.overlap,normal:y.normal}),u.trigger("collide",{entity:h,side:y.sideB,otherSide:y.sideA,point:y.point,overlap:y.overlap,normal:{x:-y.normal.x,y:-y.normal.y}})}}}var d,f=o(this.activeCollisions);try{for(f.s();!(d=f.n()).done;){var _=n(d.value,2),v=_[0],g=_[1];if(!i.has(v)){var b=g.entityA,x=g.entityB,w=g.sideA,C=g.sideB,S=Date.now();b.engine&&b.engine.trigger("collisionEnd",{colliding:!1,entityA:b,entityB:x,sideA:w,sideB:C,timestamp:S}),b.trigger("collideEnd",{entity:x,side:w,timestamp:S}),x.trigger("collideEnd",{entity:b,side:C,timestamp:S})}}}catch(t){f.e(t)}finally{f.f()}this.activeCollisions=i}},{key:"detectCollisionDetailed",value:function(t,e){var i=t.styles.borderRadius>0||e.styles.borderRadius>0?.2*Math.max(t.styles.borderRadius,e.styles.borderRadius):0;if(!this.checkAABBCollision(t,e,i))return{colliding:!1};if("circle"===t.styles.shape&&"circle"===e.styles.shape)return this.detectCircleCollision(t,e);var n=this.getVertices(t),o=this.getVertices(e);return this.detectSATCollision(n,o,t,e,i)}},{key:"detectCircleCollision",value:function(t,e){var i=Math.min(t.collision.width,t.collision.height)/2,n=Math.min(e.collision.width,e.collision.height)/2,o=t.absoluteX+t.collision.x+t.collision.width/2,s=t.absoluteY+t.collision.y+t.collision.height/2,r=e.absoluteX+e.collision.x+e.collision.width/2-o,a=e.absoluteY+e.collision.y+e.collision.height/2-s,l=Math.sqrt(r*r+a*a),c=i+n;if(l>=c)return{colliding:!1};var h=c-l,u={x:r/l,y:a/l};return{colliding:!0,sideA:this.getSideFromNormal(u),sideB:this.getSideFromNormal({x:-u.x,y:-u.y}),point:{x:o+u.x*i,y:s+u.y*i},overlap:h,normal:u}}},{key:"detectSATCollision",value:function(t,e,i,n){var s,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=1/0,l={x:0,y:0},c=o(this.getAxes(t).concat(this.getAxes(e)));try{for(c.s();!(s=c.n()).done;){var h=s.value,u=this.projectVertices(t,h),m=this.projectVertices(e,h),y=this.getOverlap(u,m)-r;if(y<=0)return{colliding:!1};y<a&&(a=y,l=h)}}catch(t){c.e(t)}finally{c.f()}var p=this.findCollisionPoint(t,e),d=this.getEntityCenter(i),f=this.getEntityCenter(n),_=f.x-d.x,v=f.y-d.y;_*l.x+v*l.y<0&&(l.x=-l.x,l.y=-l.y);var g=this.getSideFromNormal(l);return{colliding:!0,sideA:g,sideB:this.getOppositeSide(g),point:p,overlap:a,normal:l}}},{key:"getEntityCenter",value:function(t){return{x:t.absoluteX+t.collision.x+t.collision.width/2,y:t.absoluteY+t.collision.y+t.collision.height/2}}},{key:"checkAABBCollision",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=this.getAABB(t),o=this.getAABB(e);return n.minX-i<=o.maxX+i&&n.maxX+i>=o.minX-i&&n.minY-i<=o.maxY+i&&n.maxY+i>=o.minY-i}},{key:"getSideFromNormal",value:function(t){var e=180*Math.atan2(t.y,t.x)/Math.PI;return e>-45&&e<=45?"right":e>45&&e<=135?"bottom":e>135||e<=-135?"left":"top"}},{key:"getSideFromCenters",value:function(t,e){var i=t.absoluteX+(t.width>>1),n=t.absoluteY+(t.height>>1),o=i-(e.absoluteX+(e.width>>1)),s=n-(e.absoluteY+(e.height>>1));return Math.abs(o)>Math.abs(s)?o>0?"right":"left":s>0?"bottom":"top"}},{key:"getOppositeSide",value:function(t){return{left:"right",right:"left",top:"bottom",bottom:"top"}[t]}},{key:"getOverlap",value:function(t,e){var i=Math.min(t.max-e.min,e.max-t.min);return Math.round(1e4*i)/1e4}},{key:"getAABB",value:function(t){var e=this.getVertices(t),i=1/0,n=1/0,o=-1/0,s=-1/0;return e.forEach(function(t){i=Math.min(i,t.x),n=Math.min(n,t.y),o=Math.max(o,t.x),s=Math.max(s,t.y)}),{minX:i,minY:n,maxX:o,maxY:s}}},{key:"getAxes",value:function(t){for(var e=[],i=0;i<t.length;i++){var n=t[i],o=t[(i+1)%t.length],s={x:o.x-n.x,y:o.y-n.y},r={x:-s.y,y:s.x},a=Math.sqrt(r.x*r.x+r.y*r.y);0!==a&&e.push({x:r.x/a,y:r.y/a})}return e}},{key:"projectVertices",value:function(t,e){var i=1/0,n=-1/0;return t.forEach(function(t){var o=t.x*e.x+t.y*e.y;i=Math.min(i,o),n=Math.max(n,o)}),{min:i,max:n}}},{key:"getVertices",value:function(t){if(this.decomposedShapes.has(t.id))return this.decomposedShapes.get(t.id);var e;if(t.collision.points&&t.collision.points.length>=3)e=t.collision.points;else if(t.styles.customPath)e=this.getCustomPathVertices(t);else switch(t.styles.shape){case"star":e=this.getStarVertices(t);break;case"circle":e=this.getCircleVertices(t);break;case"triangle":e=this.getTriangleVertices(t);break;case"polygon":e=t.styles.points;break;default:e=this.getRectangleVertices(t,t.styles.borderRadius)}return e=this.applyTransformations(e,t),this.decomposedShapes.set(t.id,e),e}},{key:"getStarVertices",value:function(t){for(var e=Math.min(t.collision.width,t.collision.height)/2,i=.4*e,n=t.styles.spikes||5,o=[],s=Math.PI/n,r=0;r<2*n;r++){var a=r%2==0?e:i,l=s*r-Math.PI/2;if(o.push({x:Math.cos(l)*a,y:Math.sin(l)*a}),r<2*n-1){var c=(r+1)%2==0?e:i,h=s*(r+1)-Math.PI/2,u=(Math.cos(l)*a+Math.cos(h)*c)/2,m=(Math.sin(l)*a+Math.sin(h)*c)/2;o.push({x:u,y:m})}}return o}},{key:"getCircleVertices",value:function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:16,i=[],n=Math.min(t.collision.width,t.collision.height)/2,o=0;o<e;o++){var s=o/e*Math.PI*2;i.push({x:Math.cos(s)*n,y:Math.sin(s)*n})}return i}},{key:"getTriangleVertices",value:function(t){var e=t.collision.width/2,i=t.collision.height/2;return[{x:0,y:-i},{x:e,y:i},{x:-e,y:i}]}},{key:"getRectangleVertices",value:function(t,e){var i=t.collision.width/2,n=t.collision.height/2;if(!e)return[{x:-i,y:-n},{x:i,y:-n},{x:i,y:n},{x:-i,y:n}];var o=Math.min(e,Math.min(i,n)),s=[];return s.push({x:i-o,y:-n}),s.push({x:-i+o,y:-n}),s.push({x:-i,y:-n+o}),s.push({x:-i,y:n-o}),s.push({x:-i+o,y:n}),s.push({x:i-o,y:n}),s.push({x:i,y:n-o}),s.push({x:i,y:-n+o}),this.addRoundedCornerVertices(s,i-o,-n+o,o,0,4),this.addRoundedCornerVertices(s,-i+o,-n+o,o,Math.PI/2,4),this.addRoundedCornerVertices(s,-i+o,n-o,o,Math.PI,4),this.addRoundedCornerVertices(s,i-o,n-o,o,3*Math.PI/2,4),s}},{key:"addRoundedCornerVertices",value:function(t,e,i,n,o,s){for(var r=0;r<=s;r++){var a=o+Math.PI/2*(r/s);t.push({x:e+Math.cos(a)*n,y:i+Math.sin(a)*n})}}},{key:"getCustomPathVertices",value:function(t){var e="".concat(t.id,"-").concat(t.styles.customPath);if(this.customPathCache.has(e))return this.customPathCache.get(e);var i=document.createElement("canvas"),n=i.getContext("2d");i.width=t.collision.width,i.height=t.collision.height,n.save(),n.translate(t.collision.width/2,t.collision.height/2),t.styles.customPath(n);var o=this.samplePathPoints(n,t.collision.width,t.collision.height);return n.restore(),this.customPathCache.set(e,o),o}},{key:"findCollisionPoint",value:function(t,e){var i=1/0,n={x:0,y:0};return t.forEach(function(t){e.forEach(function(e){var o=e.x-t.x,s=e.y-t.y,r=o*o+s*s;r<i&&(i=r,n={x:t.x+o/2,y:t.y+s/2})})}),n}},{key:"samplePathPoints",value:function(t,e,i){for(var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:16,o=[],s={minX:-e/2+2,maxX:e/2-2,minY:-i/2+2,maxY:i/2-2},r=0;r<2*Math.PI;r+=2*Math.PI/n){for(var a=0,l=Math.max(e,i),c=l,h=0;h<8;h++){var u=(a+l)/2,m=Math.cos(r)*u,y=Math.sin(r)*u;this.isPointInBounds(m,y,s)&&t.isPointInPath(m+e/2,y+i/2)?(c=u,l=u):a=u}var p=Math.cos(r)*c,d=Math.sin(r)*c;this.isPointInBounds(p,d,s)&&o.push({x:p,y:d})}if(o.length>2){for(var f=[],_=0;_<o.length;_++){var v=o[_],g=o[(_+1)%o.length];f.push(v),f.push({x:(v.x+g.x)/2,y:(v.y+g.y)/2})}return f}return o}},{key:"isPointInBounds",value:function(t,e,i){return t>=i.minX&&t<=i.maxX&&e>=i.minY&&e<=i.maxY}},{key:"applyTransformations",value:function(t,e){var i=e.styles.rotation*Math.PI/180,n=Math.cos(i),o=Math.sin(i),s=e.styles.scale*e.styles.scaleX,r=e.styles.scale*e.styles.scaleY,a=Math.tan(e.styles.skewX*Math.PI/180),l=Math.tan(e.styles.skewY*Math.PI/180);return t.map(function(t){var i=t.x*s,c=t.y*r,h=(i+=c*a)*o+(c+=i*l)*n;return{x:i*n-c*o+e.absoluteX+e.collision.x+e.collision.width/2,y:h+e.absoluteY+e.collision.y+e.collision.height/2}})}},{key:"remove",value:function(t){var e=this;this.decomposedShapes.delete(t.id),this.lastPositions.delete(t.id);var i=[];this.activeCollisions.forEach(function(e,n){e.entityA.id!==t.id&&e.entityB.id!==t.id||i.push(n)}),i.forEach(function(i){var n=e.activeCollisions.get(i);if(n){var o=n.entityA.id===t.id?n.entityB:n.entityA,s=n.entityA.id===t.id?n.sideB:n.sideA;o.trigger("collideEnd",{entity:t,side:s}),e.activeCollisions.delete(i)}})}},{key:"clearCache",value:function(t){this.decomposedShapes.delete(t)}},{key:"reset",value:function(){this.decomposedShapes.clear(),this.activeCollisions.clear(),this.lastPositions.clear(),this.customPathCache.clear()}}],[{key:"isPointInCollisionPoints",value:function(t,e,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2;return!!this.isPointOnBezierCurves(t,e,i,n)||this.isPointInShape(t,e,i)}},{key:"isPointInTriangle",value:function(t,e,i,n){var o=-n/2,s=i/2,r=n/2,a=-i/2,l=n/2,c=(t-a)*(o-l)-(0-a)*(e-l),h=(t-0)*(r-o)-(s-0)*(e-o),u=(t-s)*(l-r)-(a-s)*(e-r);return c>=0&&h>=0&&u>=0||c<=0&&h<=0&&u<=0}},{key:"isPointOnBezierCurves",value:function(t,e,i,n){for(var o=0;o<i.length-1;o++)for(var s=i[o],r=i[o+1],a=this.getIntermediatePoints(s,r,10),l=0;l<a.length-1;l++){var c=a[l],h=a[l+1];if(this.pointToLineDistance(t,e,c.x,c.y,h.x,h.y)<=n)return!0}if(i.length>0)for(var u=i[0],m=i[i.length-1],y=this.getIntermediatePoints(m,u,10),p=0;p<y.length-1;p++){var d=y[p],f=y[p+1];if(this.pointToLineDistance(t,e,d.x,d.y,f.x,f.y)<=n)return!0}return!1}},{key:"isPointInShape",value:function(t,e,i){for(var n=0,o=0;o<i.length;o++){var s=i[o],r=i[(o+1)%i.length];s.y<=e?r.y>e&&this.isLeft(s,r,{x:t,y:e})>0&&n++:r.y<=e&&this.isLeft(s,r,{x:t,y:e})<0&&n--}return 0!==n}},{key:"isLeft",value:function(t,e,i){return(e.x-t.x)*(i.y-t.y)-(i.x-t.x)*(e.y-t.y)}},{key:"getIntermediatePoints",value:function(t,e,i){for(var n=[],o=0;o<=i;o++){var s=o/i;n.push({x:t.x+(e.x-t.x)*s,y:t.y+(e.y-t.y)*s})}return n}},{key:"pointToLineDistance",value:function(t,e,i,n,o,s){var r,a,l=o-i,c=s-n,h=l*l+c*c,u=-1;0!==h&&(u=((t-i)*l+(e-n)*c)/h),u<0?(r=i,a=n):u>1?(r=o,a=s):(r=i+u*l,a=n+u*c);var m=t-r,y=e-a;return Math.sqrt(m*m+y*y)}},{key:"optimizeCollisionPoints",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;if(t.length<=2)return t;for(var i=[t[0]],n=t[0],o=1;o<t.length;o++){var s=t[o],r=s.x-n.x,a=s.y-n.y;Math.sqrt(r*r+a*a)>=e&&(i.push(s),n=s)}return i[0]!==i[i.length-1]&&i.push(i[0]),i}}])}();const y=m;function p(t){return p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},p(t)}function d(t){return function(t){if(Array.isArray(t))return x(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||b(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function f(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var t,e,i="function"==typeof Symbol?Symbol:{},n=i.iterator||"@@iterator",o=i.toStringTag||"@@toStringTag";function s(i,n,o,s){var l=n&&n.prototype instanceof a?n:a,c=Object.create(l.prototype);return _(c,"_invoke",function(i,n,o){var s,a,l,c=0,h=o||[],u=!1,m={p:0,n:0,v:t,a:y,f:y.bind(t,4),d:function(e,i){return s=e,a=0,l=t,m.n=i,r}};function y(i,n){for(a=i,l=n,e=0;!u&&c&&!o&&e<h.length;e++){var o,s=h[e],y=m.p,p=s[2];i>3?(o=p===n)&&(l=s[(a=s[4])?5:(a=3,3)],s[4]=s[5]=t):s[0]<=y&&((o=i<2&&y<s[1])?(a=0,m.v=n,m.n=s[1]):y<p&&(o=i<3||s[0]>n||n>p)&&(s[4]=i,s[5]=n,m.n=p,a=0))}if(o||i>1)return r;throw u=!0,n}return function(o,h,p){if(c>1)throw TypeError("Generator is already running");for(u&&1===h&&y(h,p),a=h,l=p;(e=a<2?t:l)||!u;){s||(a?a<3?(a>1&&(m.n=-1),y(a,l)):m.n=l:m.v=l);try{if(c=2,s){if(a||(o="next"),e=s[o]){if(!(e=e.call(s,l)))throw TypeError("iterator result is not an object");if(!e.done)return e;l=e.value,a<2&&(a=0)}else 1===a&&(e=s.return)&&e.call(s),a<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),a=1);s=t}else if((e=(u=m.n<0)?l:i.call(n,m))!==r)break}catch(e){s=t,a=1,l=e}finally{c=1}}return{value:e,done:u}}}(i,o,s),!0),c}var r={};function a(){}function l(){}function c(){}e=Object.getPrototypeOf;var h=[][n]?e(e([][n]())):(_(e={},n,function(){return this}),e),u=c.prototype=a.prototype=Object.create(h);function m(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,c):(t.__proto__=c,_(t,o,"GeneratorFunction")),t.prototype=Object.create(u),t}return l.prototype=c,_(u,"constructor",c),_(c,"constructor",l),l.displayName="GeneratorFunction",_(c,o,"GeneratorFunction"),_(u),_(u,o,"Generator"),_(u,n,function(){return this}),_(u,"toString",function(){return"[object Generator]"}),(f=function(){return{w:s,m}})()}function _(t,e,i,n){var o=Object.defineProperty;try{o({},"",{})}catch(t){o=0}_=function(t,e,i,n){if(e)o?o(t,e,{value:i,enumerable:!n,configurable:!n,writable:!n}):t[e]=i;else{var s=function(e,i){_(t,e,function(t){return this._invoke(e,i,t)})};s("next",0),s("throw",1),s("return",2)}},_(t,e,i,n)}function v(t,e,i,n,o,s,r){try{var a=t[s](r),l=a.value}catch(t){return void i(t)}a.done?e(l):Promise.resolve(l).then(n,o)}function g(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=b(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return r=t.done,t},e:function(t){a=!0,s=t},f:function(){try{r||null==i.return||i.return()}finally{if(a)throw s}}}}function b(t,e){if(t){if("string"==typeof t)return x(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?x(t,e):void 0}}function x(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function w(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,A(n.key),n)}}function C(t,e){(function(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")})(t,e),e.add(t)}function S(t,e,i){return(e=A(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function A(t){var e=function(t,e){if("object"!=p(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=p(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==p(e)?e:e+""}function M(t,e,i){if("function"==typeof t?t===e:t.has(e))return arguments.length<3?e:i;throw new TypeError("Private element is not present on this object")}var k=new WeakSet,D=function(){return function(t,e,i){return e&&w(t.prototype,e),i&&w(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),C(this,k),S(this,"pressedKeys",new Map),S(this,"keyMap",{control:"ctrl"," ":"space",arrowup:"up",arrowdown:"down",arrowleft:"left",arrowright:"right",escape:"esc",enter:"enter",shift:"shift",alt:"alt",meta:"meta",delete:"del",backspace:"backspace",tab:"tab",capslock:"caps",pageup:"pageup",pagedown:"pagedown",insert:"ins",home:"home",end:"end"})},[{key:"resize",value:function(t,e){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return this._updateCanvasSize(t,e,i,n),this}},{key:"_windowResizeListener",value:function(){var t=this;window.addEventListener("resize",function(){var e,i,n=t.config.resizeTarget,o=!1;t._createWindow(),"window"===n?(e=t.window.width,i=t.window.height,o=!0):"document"===n&&(e=document.documentElement.clientWidth,i=document.documentElement.clientHeight,o=!0),!o||t.config.autoResize?o&&t.resize(e,i,!0,"window"):t.trigger("resize",{width:e,height:i,target:"window"})})}},{key:"_setupResizeObserver",value:function(t){var e=this;!t instanceof HTMLElement||"undefined"==typeof document||"undefined"==typeof ResizeObserver||new ResizeObserver(function(){var i=t.offsetWidth,n=t.offsetHeight;e.config.autoResize?e.resize(i,n,!0,t):e.trigger("resize",{width:i,height:n,target:t})}).observe(t)}},{key:"_updateCanvasSize",value:function(t,e,i,n){this.baseWidth=t,this.baseHeight=e,this.config.width=t,this.config.height=e,this.canvas.width=t*this.config.quality,this.canvas.height=e*this.config.quality,this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",this.ctx.scale(this.config.quality,this.config.quality),this.workerSend({action:"update_canvas",props:{attributes:{width:this.canvas.width,height:this.canvas.height},style:this.canvas.style}}),i&&this.trigger("resize",{width:t,height:e,target:n})}},{key:"getSortedEntitiesForInteraction",value:function(){var t,e=[],i=0,n=function(t){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:0)+(t.zIndex||0);e.push({entity:t,level:o,effectiveZIndex:s,isChild:!!t.parent,addOrder:i++});var r,a=g(t.children.values());try{for(a.s();!(r=a.n()).done;){var l=r.value;n(l,o+1,s)}}catch(t){a.e(t)}finally{a.f()}},o=g(this.entities.values());try{for(o.s();!(t=o.n()).done;){var s=t.value;n(s)}}catch(t){o.e(t)}finally{o.f()}return e.sort(function(t,e){return e.effectiveZIndex!==t.effectiveZIndex?e.effectiveZIndex-t.effectiveZIndex:e.level!==t.level?e.level-t.level:t.addOrder-e.addOrder}).map(function(t){return t.entity})}},{key:"isPointInEntity",value:function(t,e,i){var n;if(!i.styles.visible)return!1;var o=i.absoluteX+i.width/2,s=i.absoluteY+i.height/2,r=-i.styles.rotation*Math.PI/180,a=Math.cos(r),l=Math.sin(r),c=a*(t-o)-l*(e-s),h=l*(t-o)+a*(e-s);if((null===(n=i.collision)||void 0===n||null===(n=n.points)||void 0===n?void 0:n.length)>0)return y.isPointInCollisionPoints(c,h,i.collision.points);var u=i.width*i.styles.scale*i.styles.scaleX,m=i.height*i.styles.scale*i.styles.scaleY;switch(i.styles.shape){case"circle":var p=Math.min(u,m)/2;return c*c+h*h<=p*p;case"triangle":return y.isPointInTriangle(c,h,u,m);default:return Math.abs(c)<=u/2&&Math.abs(h)<=m/2}}},{key:"_handleTouchStart",value:function(t){var e=this;if(this.running){var i,n=g(t.changedTouches);try{var o=function(){var n=i.value,o=n.identifier,s=e.camera.screenToWorld(n.clientX,n.clientY),r={x:s.x,y:s.y,worldX:s.x,worldY:s.y,screenX:n.clientX,screenY:n.clientY,timestamp:Date.now(),touches:e._handleTouches(t),identifier:o};if(e.trigger("touchstart",r),e.physicsEnabled)return 1;var a=e.getSortedEntitiesForInteraction().find(function(t){return(t.isDraggable()||t.isClickable()||t.isInteractive())&&e.isPointInEntity(s.x,s.y,t)});if(a){a.isInteractive()&&(a.trigger("touchstart",r),e.touchStartEntities.set(o,a)),e.entities.forEach(function(t){t.zIndex>a.zIndex&&t.zIndex--});var l=0;e.entities.forEach(function(t){l=Math.max(l,t.zIndex||0)}),a.zIndex=l+1,a.isDraggable()&&(e.draggedEntities.set(o,{entity:a,touchStartX:s.x,touchStartY:s.y,dragStartX:s.x-a.absoluteX,dragStartY:s.y-a.absoluteY}),a.trigger("drag",r))}};for(n.s();!(i=n.n()).done;)o()}catch(t){n.e(t)}finally{n.f()}}}},{key:"_handleTouchMove",value:function(t){var e,i=this;if(null==t||null===(e=t.preventDefault)||void 0===e||e.call(t),this.running){var n,o=g(t.changedTouches);try{var s=function(){var e=n.value,o=e.identifier,s=i.draggedEntities.get(o),r=i.camera.screenToWorld(e.clientX,e.clientY),a={x:r.x,y:r.y,worldX:r.x,worldY:r.y,screenX:e.clientX,screenY:e.clientY,timestamp:Date.now(),touches:i._handleTouches(t),identifier:o};if(i.trigger("touchmove",a),i.physicsEnabled)return 0;var l=i.touchStartEntities.get(o);if(l&&l.isInteractive())l.trigger("touchmove",a);else{var c=i.getSortedEntitiesForInteraction().find(function(t){return t.isInteractive()&&i.isPointInEntity(r.x,r.y,t)});c&&c.trigger("touchmove",a)}if(!s)return 0;var h=s.entity,u=r.x-s.dragStartX,m=r.y-s.dragStartY;if(h.parent&&h.constrainToParent){var y=h.parent,p=y.width-h.width,d=y.height-h.height;u=Math.max(0,Math.min(p,u-y.absoluteX)),m=Math.max(0,Math.min(d,m-y.absoluteY))}else h.parent&&(u-=h.parent.absoluteX,m-=h.parent.absoluteY);h.style({x:u,y:m}),h.trigger("dragMove",a)};for(o.s();!(n=o.n()).done;)s()}catch(t){o.e(t)}finally{o.f()}}}},{key:"_handleTouchEnd",value:function(t){if(this.running){var e,i=g(t.changedTouches);try{for(i.s();!(e=i.n()).done;){var n=e.value,o=n.identifier,s=this.draggedEntities.get(o),r=this.camera.screenToWorld(n.clientX,n.clientY),a={x:r.x,y:r.y,worldX:r.x,worldY:r.y,screenX:n.clientX,screenY:n.clientY,timestamp:Date.now(),touches:this._handleTouches(t),identifier:o};if(this.trigger("touchend",a),this.physicsEnabled)return;var l=this.touchStartEntities.get(o);if(l&&l.isInteractive()&&(l.trigger("touchend",a),this.touchStartEntities.delete(o)),s){var c=s.entity;Math.abs(r.x-s.touchStartX),Math.abs(r.y-s.touchStartY);c.isDraggable()&&c.trigger("drop",a),this.draggedEntities.delete(o)}}}catch(t){i.e(t)}finally{i.f()}}}},{key:"_handleTouchCancel",value:function(t){if(this.running){var e,i=g(t.changedTouches);try{for(i.s();!(e=i.n()).done;){var n=e.value.identifier;this.touchStartEntities.get(n)&&this.touchStartEntities.delete(n),this.draggedEntities.has(n)&&this.draggedEntities.delete(n)}}catch(t){i.e(t)}finally{i.f()}}}},{key:"_handleTouches",value:function(t){var e,i=[],n=g(t.touches);try{for(n.s();!(e=n.n()).done;){var o=e.value,s=this.camera.screenToWorld(o.clientX,o.clientY);i.push({identifier:o.identifier,screenX:o.clientX,screenY:o.clientY,worldX:s.x,worldY:s.y})}}catch(t){n.e(t)}finally{n.f()}return i}},{key:"_handleMouseDown",value:function(t){var e=this;if(this.running&&2!==t.buttons){var i=this.camera.screenToWorld(t.clientX,t.clientY),n={x:i.x,y:i.y,worldX:i.x,worldY:i.y,screenX:t.clientX,screenY:t.clientY,which:t.which,timestamp:Date.now()};if(this.trigger("mousedown",n),!this.physicsEnabled){var o=this.getSortedEntitiesForInteraction().find(function(t){return(t.isDraggable()||t.isInteractive())&&e.isPointInEntity(i.x,i.y,t)});if(o&&(o.isInteractive()&&(o.trigger("mousedown",n),this.mouseDownEntity=o),o.isDraggable())){this.draggedEntity=o,this.entities.forEach(function(t){t.zIndex>o.zIndex&&t.zIndex--});var s=0;this.entities.forEach(function(t){s=Math.max(s,t.zIndex||0)}),o.zIndex=s+1,this.draggedEntity.dragStartX=i.x-o.absoluteX,this.draggedEntity.dragStartY=i.y-o.absoluteY,o.trigger("drag",n)}}}}},{key:"_handleMouseUp",value:function(t){if(this.running&&2!==t.buttons){var e=this.camera.screenToWorld(t.clientX,t.clientY),i={x:e.x,y:e.y,worldX:e.x,worldY:e.y,screenX:t.clientX,screenY:t.clientY,which:t.which,timestamp:Date.now()};this.trigger("mouseup",i),this.physicsEnabled||(this.mouseDownEntity&&this.mouseDownEntity.isInteractive()&&(this.mouseDownEntity.trigger("mouseup",i),this.mouseDownEntity=null),this.draggedEntity&&(this.draggedEntity.trigger("drop",i),this.draggedEntity=null))}}},{key:"_handleMouseMove",value:function(t){var e=this;if(this.running&&2!==t.buttons){var i=this.camera.screenToWorld(t.clientX,t.clientY),n={x:i.x,y:i.y,worldX:i.x,worldY:i.y,screenX:t.clientX,screenY:t.clientY,which:t.which,timestamp:Date.now()};if(this.trigger("mousemove",n),!this.physicsEnabled){if(this.draggedEntity&&this.draggedEntity.isDraggable()){var o=i.x-this.draggedEntity.dragStartX,s=i.y-this.draggedEntity.dragStartY;if(this.draggedEntity.parent&&this.draggedEntity.constrainToParent){var r=this.draggedEntity.parent,a=r.width-this.draggedEntity.width,l=r.height-this.draggedEntity.height;o=Math.max(0,Math.min(a,o-r.absoluteX)),s=Math.max(0,Math.min(l,s-r.absoluteY))}else this.draggedEntity.parent&&(o-=this.draggedEntity.parent.absoluteX,s-=this.draggedEntity.parent.absoluteY);this.draggedEntity.style({x:o,y:s}),this.draggedEntity.trigger("dragMove",n)}if(this.mouseDownEntity&&this.mouseDownEntity.isInteractive())this.mouseDownEntity.trigger("mousemove",n);else{var c=this.getSortedEntitiesForInteraction().find(function(t){return e.isPointInEntity(i.x,i.y,t)});c&&c.isInteractive()&&c.trigger("mousemove",n)}var h=this.getSortedEntitiesForInteraction().find(function(t){return e.isPointInEntity(i.x,i.y,t)&&t.isHoverable()});h!==this.hoveredEntity&&(this.hoveredEntity&&this.hoveredEntity.trigger("hoverOut",n),h?(this.hoveredEntity=h,h.trigger("hover",n)):this.hoveredEntity=null)}}}},{key:"_handleWheel",value:function(t){var e,i=this;if(this.running){null==t||null===(e=t.preventDefault)||void 0===e||e.call(t);var n=this.camera.screenToWorld(t.clientX,t.clientY),o={x:n.x,y:n.y,worldX:n.x,worldY:n.y,screenX:t.clientX,screenY:t.clientY,deltaX:t.deltaX,deltaY:t.deltaY,deltaZ:t.deltaZ,deltaMode:t.deltaMode,timestamp:Date.now()};if(this.trigger("wheel",o),!this.physicsEnabled){var s=this.getSortedEntitiesForInteraction().find(function(t){return t.isInteractive()&&i.isPointInEntity(n.x,n.y,t)});s&&s.trigger("wheel",o)}}}},{key:"_handleClick",value:function(t){2!==t.button&&this._handleClicks(t,"click")}},{key:"_handleRightClick",value:function(t){this._handleClicks(t,"rightclick")}},{key:"_handleClicks",value:function(t,e){var i,n=this;if(null==t||null===(i=t.preventDefault)||void 0===i||i.call(t),Promise.resolve().then(function(){var t,e;return null===(t=n.canvas)||void 0===t||null===(e=t.focus)||void 0===e?void 0:e.call(t)}),this.running){var o=this.camera.screenToWorld(t.clientX,t.clientY),s={x:o.x,y:o.y,worldX:o.x,worldY:o.y,screenX:t.clientX,screenY:t.clientY,timestamp:Date.now()};if(this.trigger(e,s),!this.physicsEnabled){var r=this.getSortedEntitiesForInteraction().find(function(t){return(t.isClickable()||t.isInteractive())&&n.isPointInEntity(o.x,o.y,t)});r&&r.trigger(e,s)}}}},{key:"isKeyPressed",value:function(){for(var t=this,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return i.some(function(e){return t.pressedKeys.has(e)})}},{key:"isLogicalKeyPressed",value:function(){for(var t=this,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return i.some(function(e){return Array.from(t.pressedKeys.values()).some(function(t){return t.logical===e})})}},{key:"_handleKeyDown",value:function(t){var e;null==t||null===(e=t.preventDefault)||void 0===e||e.call(t);var i=M(k,this,I).call(this,t),n=M(k,this,B).call(this,t);this.pressedKeys.set(i,{physical:i,logical:n});var o=M(k,this,P).call(this,this.pressedKeys.keys()).join("+"),s={key:n,combo:o,physical:i,original:t.key};this.trigger("keydown",s,t),this.trigger(o,s,t)}},{key:"_handleKeyUp",value:function(t){var e;null==t||null===(e=t.preventDefault)||void 0===e||e.call(t);var i=M(k,this,I).call(this,t),n=M(k,this,B).call(this,t),o=M(k,this,P).call(this,this.pressedKeys.keys()).join("+");this.pressedKeys.delete(i);var s={key:n,combo:o,physical:i,original:t.key};this.trigger("keyup",s,t)}},{key:"hexToRgb",value:function(t){var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}},{key:"rgbToHex",value:function(t,e,i){return"#"+[t,e,i].map(function(t){var e=t.toString(16);return 1===e.length?"0"+e:e}).join("")}},{key:"hslToRgb",value:function(t,e,i){var n,o,s;if(0===e)n=o=s=i;else{var r=function(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t},a=i<.5?i*(1+e):i+e-i*e,l=2*i-a;n=r(l,a,t+1/3),o=r(l,a,t),s=r(l,a,t-1/3)}return{r:Math.round(255*n),g:Math.round(255*o),b:Math.round(255*s)}}},{key:"randHex",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=Math.floor(256*Math.random()),i=Math.floor(256*Math.random()),n=Math.floor(256*Math.random()),o=function(t){return t.toString(16).padStart(2,"0")};if(t){var s=Math.floor(256*Math.random());return"#".concat(o(e)).concat(o(i)).concat(o(n)).concat(o(s))}return"#".concat(o(e)).concat(o(i)).concat(o(n))}},{key:"randRgb",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=Math.floor(256*Math.random()),i=Math.floor(256*Math.random()),n=Math.floor(256*Math.random());if(t){var o=Math.random().toFixed(2);return"rgba(".concat(e,", ").concat(i,", ").concat(n,", ").concat(o,")")}return"rgb(".concat(e,", ").concat(i,", ").concat(n,")")}},{key:"randHsl",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=t.hueRange,n=void 0===i?[0,360]:i,o=t.saturationRange,s=void 0===o?[0,100]:o,r=t.lightnessRange,a=void 0===r?[0,100]:r,l=Math.floor(Math.random()*(n[1]-n[0])+n[0]),c=Math.floor(Math.random()*(s[1]-s[0])+s[0]),h=Math.floor(Math.random()*(a[1]-a[0])+a[0]);if(e){var u=Math.random().toFixed(2);return"hsla(".concat(l,", ").concat(c,"%, ").concat(h,"%, ").concat(u,")")}return"hsl(".concat(l,", ").concat(c,"%, ").concat(h,"%)")}},{key:"adjustAlpha",value:function(t,e){if(t.includes("rgba"))return t.replace(/rgba\((.+),\s*([0-9.]+)\)/,function(t,i,n){var o=Math.min(parseFloat(n)*e,1);return"rgba(".concat(i,", ").concat(o,")")});if(t.includes("rgb")){var i=t.match(/rgb\((.+)\)/)[1],n=Math.min(.5*e,1);return"rgba(".concat(i,", ").concat(n,")")}var o=t.replace("#",""),s=parseInt(o.substr(0,2),16),r=parseInt(o.substr(2,2),16),a=parseInt(o.substr(4,2),16),l=Math.min(.5*e,1);return"rgba(".concat(s,", ").concat(r,", ").concat(a,", ").concat(l,")")}},{key:"getDistance",value:function(t,e,i,n){return Math.sqrt(Math.pow(i-t,2)+Math.pow(n-e,2))}},{key:"randBetween",value:function(t,e){return Math.floor(Math.random()*(e-t+1)+t)}},{key:"clamp",value:function(t,e,i){return Math.min(Math.max(t,e),i)}},{key:"lerp",value:function(t,e,i){return t+(e-t)*i}},{key:"degToRad",value:function(t){return t*(Math.PI/180)}},{key:"radToDeg",value:function(t){return t*(180/Math.PI)}},{key:"getAngle",value:function(t,e,i,n){return Math.atan2(n-e,i-t)}},{key:"rotatePoint",value:function(t,e,i,n,o){var s=this.degToRad(o),r=Math.cos(s),a=Math.sin(s),l=i-t,c=n-e;return{x:t+(l*r-c*a),y:e+(l*a+c*r)}}},{key:"wait",value:(t=function(t){return function(){var e=this,i=arguments;return new Promise(function(n,o){var s=t.apply(e,i);function r(t){v(s,n,o,r,a,"next",t)}function a(t){v(s,n,o,r,a,"throw",t)}r(void 0)})}}(f().m(function t(){var e,i,n,o,s,r=arguments;return f().w(function(t){for(;;)switch(t.p=t.n){case 0:for(e=r.length,i=new Array(e),n=0;n<e;n++)i[n]=r[n];if(0!==i.length){t.n=1;break}return t.a(2,[]);case 1:if(0!==(o=this._flattenPromises(i)).length){t.n=2;break}return t.a(2,[]);case 2:return t.p=2,t.n=3,Promise.all(o);case 3:return t.a(2,t.v);case 4:throw t.p=4,s=t.v,new Error("Wait operation failed: ".concat(s.message));case 5:return t.a(2)}},t,this,[[2,4]])})),function(){return t.apply(this,arguments)})},{key:"_flattenPromises",value:function(t){var e,i=[],n=g(t);try{for(n.s();!(e=n.n()).done;){var o=e.value;Array.isArray(o)?i.push.apply(i,d(this._flattenPromises(o))):o&&"function"==typeof o.then?i.push(o):null!=o&&i.push(Promise.resolve(o))}}catch(t){n.e(t)}finally{n.f()}return i}}],[{key:"_handleCanvasSelector",value:function(t){var e,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if("string"!=typeof t){if(t instanceof HTMLCanvasElement)return t;throw new Error("Invalid HTMLCanvasElement")}return(e=document.querySelector(t))||(e=document.createElement("canvas"),t.startsWith("#")?e.id=t.replace("#",""):(t=t.replace(".",""),e.classList.add(t)),i&&"string"!=typeof i||(i=document.querySelector(i||"body")),i.appendChild(e)),e}},{key:"dataURLToBlob",value:function(t){for(var e=t.split(","),i=e[0].match(/:(.*?);/)[1],n=atob(e[1]),o=n.length,s=new Uint8Array(o);o--;)s[o]=n.charCodeAt(o);return new Blob([s],{type:i})}},{key:"scriptToUrl",value:function(t){try{return new URL(t),t}catch(t){}var e=function(t){return"function"==typeof t};if(e(t))t="".concat(t.toString(),"()");else{if(/^(?:\.\/|\.\.\/|\/|[^/]*\.[a-zA-Z0-9]{1,5}$)/.test(t)&&!/\s/.test(t))return t;if(/^[a-zA-Z_$][\w$]*$/.test(String(t).trim())){var i=String(t).trim(),n=globalThis[i];e(n)&&(t="(".concat(n.toString(),")();"))}else if(!/[(){}\[\];=>]/.test(t)&&!/\b(function|=>|var|let|const|if|for|while|return)\b/.test(t))throw new Error("".concat(t," is not valid"))}var o=new Blob([t],{type:"application/javascript"});return URL.createObjectURL(o)}}]);var t}();function I(t){if(t.code&&t.code.startsWith("Key"))return t.code.replace("Key","").toLowerCase();if(t.code&&t.code.startsWith("Digit"))return t.code.replace("Digit","");var e=t.key.toLowerCase();return this.keyMap[e]||e}function B(t){var e=t.key.toLowerCase();return this.keyMap[e]||e}function P(t){var e=["ctrl","shift","alt","meta"];return d(t).sort(function(t,i){var n=e.indexOf(t),o=e.indexOf(i);return(-1===n?99:n)-(-1===o?99:o)||t.localeCompare(i)})}const V=D;function T(t){return T="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},T(t)}function E(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function L(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?E(Object(i),!0).forEach(function(e){F(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):E(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function F(t,e,i){return(e=R(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function G(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,R(n.key),n)}}function R(t){var e=function(t,e){if("object"!=T(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=T(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==T(e)?e:e+""}var J=function(){return function(t,e,i){return e&&G(t.prototype,e),i&&G(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(e){var i,n,o,s,r=this,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.engine=e,this.active=a.active||!1,this.panel=null===(i=a.panel)||void 0===i||i,this.hotKey=null===(n=a.hotKey)||void 0===n||n,this.fps=a.fps||{target:60,actual:60,ratio:100},this.lastFpsUpdate=performance.now(),this.frameCount=0,this.items=new Map,this.styles=L({fillColor:a.fillColor||"rgba(255, 0, 0, 0.3)",strokeColor:a.stroke||"rgba(255, 0, 0, 0.8)",lineWidth:null!==(o=a.lineWidth)&&void 0!==o?o:1,pointColor:a.pointColor||"rgba(255, 255, 255, 0.8)",pointRadius:null!==(s=a.lineWidth)&&void 0!==s?s:2},a.styles),this.active&&this.engine.on("ctrl+d",function(){r.hotKey&&(r.active=!r.active)})},[{key:"enableDebugger",value:function(){return this.active=!0,this}},{key:"disableDebugger",value:function(){return this.active=!1,this}},{key:"showPanel",value:function(){this.panel=!0}},{key:"hidePanel",value:function(){this.panel=!1}},{key:"log",value:function(){for(var t,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return this.active&&(t=console).log.apply(t,["%c[Pixalo LOG]","color: #2196f3;"].concat(i)),this}},{key:"info",value:function(){for(var t,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return this.active&&(t=console).info.apply(t,["%c[Pixalo INFO]","color: #4491F8;"].concat(i)),this}},{key:"warn",value:function(){for(var t,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return this.active&&(t=console).warn.apply(t,["%c[Pixalo WARN]","color: #ff9800;"].concat(i)),this}},{key:"error",value:function(){for(var t,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return this.active&&(t=console).error.apply(t,["%c[Pixalo ERROR]","color: #f44336;"].concat(i)),this}},{key:"addItem",value:function(t,e){return this.engine.isEntity(e)?this.items.set(t,{entity:e,type:"entity"}):this.items.set(t,L(L({},this._normalizeItem(e)),{},{type:"static"})),this}},{key:"removeItem",value:function(t){return this.items.delete(t)}},{key:"hasItem",value:function(t){return this.items.has(t)}},{key:"getItem",value:function(t){return this.items.get(t)}},{key:"getAllItems",value:function(){return Array.from(this.items.entries())}},{key:"updateItem",value:function(t,e){if(!this.items.has(t))return!1;var i=this.items.get(t);if("static"===i.type){var n=L(L({},i),this._normalizeItem(e));this.items.set(t,n)}return!0}},{key:"clearItems",value:function(){return this.items.clear(),this}},{key:"_normalizeItem",value:function(t){var e,i,n,o,s,r,a=this.engine.isEntity(t),l=a?t.styles:t,c={x:(null===(e=t.collision)||void 0===e?void 0:e.x)||0,y:(null===(i=t.collision)||void 0===i?void 0:i.y)||0,width:(null===(n=t.collision)||void 0===n?void 0:n.width)||t.width,height:(null===(o=t.collision)||void 0===o?void 0:o.height)||t.height,points:(null===(s=t.collision)||void 0===s?void 0:s.points)||null};return L({x:t.absoluteX||t.x||0,y:t.absoluteY||t.y||0,width:c.width,height:c.height,shape:l.shape||"rectangle",scale:l.scale||1,scaleX:l.scaleX||1,scaleY:l.scaleY||1,skewX:l.skewX||0,skewY:l.skewY||0,rotation:l.rotation||0,borderRadius:l.borderRadius||0,spikes:l.spikes||5,flipX:l.flipX||!1,flipY:l.flipY||!1,points:l.points||[],customPath:l.customPath||null,collision:c,visible:null===(r=l.visible)||void 0===r||r,type:a?"entity":"static"},a&&{entity:t})}},{key:"renderPanel",value:function(){if(this.active&&this.panel){var t=this.engine.ctx,e=18,i=20,n=20,o=0,s=0,r=0,a=0,l=function(t){var e;o++,t.styles.visible||s++,null!==(e=t.collision)&&void 0!==e&&e.enabled&&r++,t.physics&&a++,t.children.forEach(l)};this.engine.entities.forEach(l),t.save(),t.fillStyle="rgba(0,0,0,0.8)",t.fillRect(0,0,125,this.engine.baseHeight),t.font='bold 14px "Consolas", "Monaco", monospace',t.textAlign="left",t.fillStyle="#F3A71B",t.fillText("⚡ PERFORMANCE",2,n),n+=i,t.font='12px "Consolas", "Monaco", monospace',t.fillStyle="#FFFFFF",t.fillText("FPS: ",8,n),t.fillStyle=this.fps.actual>=.9*this.fps.target?"#4AFF4A":this.fps.actual>=.7*this.fps.target?"#F3A71B":"#FF4444",t.fillText("".concat(this.fps.actual),40,n),t.fillStyle="#B0B0B0",t.fillText("/ ".concat(this.fps.target),55,n),n+=e,t.fillStyle="#FFFFFF",t.fillText("Ratio: ",8,n);var c=this.fps.ratio||0;t.fillStyle=c>=90?"#4AFF4A":c>=70?"#F3A71B":"#FF4444",t.fillText("".concat(c,"%"),55,n),n+=38,t.font='bold 14px "Consolas", "Monaco", monospace',t.fillStyle="#F3A71B",t.fillText("🔧 SYSTEM",2,n),n+=i,t.font='12px "Consolas", "Monaco", monospace',t.fillStyle="#FFFFFF",t.fillText("Quality: ",8,n),t.fillStyle="#8FE5D4",t.fillText("".concat(this.engine.config.quality,"x"),65,n),n+=e,t.fillStyle="#FFFFFF",t.fillText("Canvas: ",8,n),t.fillStyle="#8FE5D4",t.fillText("".concat(this.engine.canvas.width,"×").concat(this.engine.canvas.height),65,n),n+=38,t.font='bold 14px "Consolas", "Monaco", monospace',t.fillStyle="#F3A71B",t.fillText("📐 GRID",2,n),n+=i,t.font='12px "Consolas", "Monaco", monospace',t.fillStyle="#FFFFFF",t.fillText("Status: ",8,n),t.fillStyle=this.engine.gridEnabled?"#4AFF4A":"#666666",t.fillText("".concat(this.engine.gridEnabled?"ON":"OFF"),60,n),this.engine.gridEnabled&&(t.fillStyle="#FFFFFF",t.fillText("Size: ",8,n),t.fillStyle="#8FE5D4",t.fillText("".concat(this.engine.grid.width,"×").concat(this.engine.grid.height),45,n),n+=e,t.fillStyle="#FFFFFF",t.fillText("Major: ",8,n),t.fillStyle="#8FE5D4",t.fillText("".concat(this.engine.grid.majorGridEvery),50,n),n+=e),n+=38,t.font='bold 14px "Consolas", "Monaco", monospace',t.fillStyle="#F3A71B",t.fillText("🎭 ENTITIES",2,n),n+=i,t.font='12px "Consolas", "Monaco", monospace',t.fillStyle="#FFFFFF",t.fillText("Total: ",8,n),t.fillStyle="#4AFF4A",t.fillText("".concat(o),55,n),n+=e,t.fillStyle="#FFFFFF",t.fillText("Invisible: ",8,n),t.fillStyle="#F3A71B",t.fillText("".concat(s),80,n),n+=e,n+=i,t.font='bold 14px "Consolas", "Monaco", monospace',t.fillStyle="#F3A71B",t.fillText("⚙️ COLLISION",2,n),n+=i,t.font='12px "Consolas", "Monaco", monospace',t.fillStyle="#FFFFFF",t.fillText("Engine: ",8,n),t.fillStyle=this.engine.collisionEnabled?"#4AFF4A":"#666666",t.fillText("".concat(this.engine.collisionEnabled?"ON":"OFF"),60,n),n+=e,r>0&&(t.fillStyle="#FFFFFF",t.fillText("Objects: ",8,n),t.fillStyle="#F3A71B",t.fillText("".concat(r),65,n),n+=e),n+=i,t.font='bold 14px "Consolas", "Monaco", monospace',t.fillStyle="#F3A71B",t.fillText("⚙️ PHYSICS",2,n),n+=i,t.font='12px "Consolas", "Monaco", monospace',t.fillStyle="#FFFFFF",t.fillText("Engine: ",8,n),t.fillStyle=this.engine.physicsEnabled?"#4AFF4A":"#666666",t.fillText("".concat(this.engine.physicsEnabled?"Box2D":"OFF"),60,n),n+=e,a>0&&(t.fillStyle="#FFFFFF",t.fillText("Objects: ",8,n),t.fillStyle="#F3A71B",t.fillText("".concat(a),65,n)),t.restore()}}},{key:"render",value:function(t){var e=this;this.active&&this.items.forEach(function(i,n){var o;(o="entity"===i.type&&e.engine.isEntity(i.entity)?e._normalizeItem(i.entity):i).visible&&e.engine.camera.inView(o)&&e._renderItem(t,o)})}},{key:"_renderItem",value:function(t,e){t.save(),t.globalCompositeOperation="source-over";var i=-e.width/2+e.collision.x+e.collision.width/2,n=-e.height/2+e.collision.y+e.collision.height/2;t.translate(e.x+e.width/2,e.y+e.height/2),t.translate(i,n),t.rotate(e.rotation*Math.PI/180),t.scale((e.flipX?-1:1)*e.scaleX*e.scale,(e.flipY?-1:1)*e.scaleY*e.scale),t.transform(1,e.skewY,e.skewX,1,0,0),this._renderShape(t,e),e.collision&&e.collision.points&&this._renderCustomCollisionShape(t,e),t.restore()}},{key:"_renderShape",value:function(t,e){switch(t.strokeStyle=this.styles.strokeColor,t.fillStyle=this.styles.fillColor,t.lineWidth=this.styles.lineWidth,e.shape){case"circle":this._renderCircle(t,e);break;case"triangle":this._renderTriangle(t,e);break;case"star":this._renderStar(t,e);break;case"polygon":this._renderPolygon(t,e);break;default:this._renderRectangle(t,e)}}},{key:"_renderRectangle",value:function(t,e){var i=e.width,n=e.height;if(e.borderRadius>0){var o=e.borderRadius;t.beginPath(),t.moveTo(-i/2+o,-n/2),t.lineTo(i/2-o,-n/2),t.arcTo(i/2,-n/2,i/2,-n/2+o,o),t.lineTo(i/2,n/2-o),t.arcTo(i/2,n/2,i/2-o,n/2,o),t.lineTo(-i/2+o,n/2),t.arcTo(-i/2,n/2,-i/2,n/2-o,o),t.lineTo(-i/2,-n/2+o),t.arcTo(-i/2,-n/2,-i/2+o,-n/2,o),t.closePath()}else t.beginPath(),t.rect(-i/2,-n/2,i,n);t.fill(),t.stroke()}},{key:"_renderCircle",value:function(t,e){t.beginPath(),t.arc(0,0,Math.min(e.width,e.height)/2,0,2*Math.PI),t.fill(),t.stroke()}},{key:"_renderTriangle",value:function(t,e){var i=e.width,n=e.height;t.beginPath(),t.moveTo(0,-n/2),t.lineTo(i/2,n/2),t.lineTo(-i/2,n/2),t.closePath(),t.fill(),t.stroke()}},{key:"_renderPolygon",value:function(t,e){if(!(e.points.length<3)){if(e.borderRadius>0)this._renderPolygonWithRadius(t,e);else{t.beginPath(),t.moveTo(e.points[0].x,e.points[0].y);for(var i=1;i<e.points.length;i++)t.lineTo(e.points[i].x,e.points[i].y);t.closePath()}t.fill(),t.stroke()}}},{key:"_renderStar",value:function(t,e){var i=Math.min(e.width,e.height)/2,n=.4*i,o=e.spikes||5,s=Math.PI/o;t.beginPath(),t.moveTo(0,-i);for(var r=0;r<2*o;r++){var a=r%2==0?i:n,l=s*r-Math.PI/2;t.lineTo(Math.cos(l)*a,Math.sin(l)*a)}t.closePath(),t.fill(),t.stroke()}},{key:"_renderPolygonWithRadius",value:function(t,e){var i=e.points,n=e.borderRadius;t.beginPath();for(var o=0;o<i.length;o++){var s=i[o],r=i[(o+1)%i.length],a=i[(o-1+i.length)%i.length],l={x:a.x-s.x,y:a.y-s.y},c={x:r.x-s.x,y:r.y-s.y},h=Math.sqrt(l.x*l.x+l.y*l.y),u=Math.sqrt(c.x*c.x+c.y*c.y);l.x/=h,l.y/=h,c.x/=u,c.y/=u;var m=Math.min(n,h/2,u/2),y={x:s.x+l.x*m,y:s.y+l.y*m},p={x:s.x+c.x*m,y:s.y+c.y*m};0===o?t.moveTo(y.x,y.y):t.lineTo(y.x,y.y),t.quadraticCurveTo(s.x,s.y,p.x,p.y)}t.closePath(),t.fill(),t.stroke()}},{key:"_renderCustomCollisionShape",value:function(t,e){var i=this,n=e.collision.points;if(n&&!(n.length<2)){if(t.strokeStyle="rgba(255, 255, 255, 0.8)",t.beginPath(),t.moveTo(n[0].x,n[0].y),e.customPath)for(var o=0;o<n.length-1;){var s=n[o],r=n[o+1],a={x:s.x+(r.x-s.x)/3,y:s.y+(r.y-s.y)/3},l={x:s.x+2*(r.x-s.x)/3,y:s.y+2*(r.y-s.y)/3};t.bezierCurveTo(a.x,a.y,l.x,l.y,r.x,r.y),o++}else for(var c=1;c<n.length;c++)t.lineTo(n[c].x,n[c].y);t.closePath(),t.stroke(),t.strokeStyle=this.styles.strokeColor,t.fillStyle=this.styles.fillColor,t.fill(),t.stroke(),t.fillStyle=this.styles.pointColor,n.forEach(function(e){t.beginPath(),t.arc(e.x,e.y,i.styles.pointRadius,0,2*Math.PI),t.fill()})}}}])}();const O=J;function j(t){return j="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},j(t)}function z(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,X(n.key),n)}}function X(t){var e=function(t,e){if("object"!=j(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=j(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==j(e)?e:e+""}var N=function(){return function(t,e,i){return e&&z(t.prototype,e),i&&z(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t)},null,[{key:"getPoint",value:function(t,e,i,n,o){var s=1-o;return{x:s*s*s*t.x+3*s*s*o*e.x+3*s*o*o*i.x+o*o*o*n.x,y:s*s*s*t.y+3*s*s*o*e.y+3*s*o*o*i.y+o*o*o*n.y}}},{key:"getPoints",value:function(t,e,i,n){for(var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:20,s=[],r=0;r<=1;r+=1/o)s.push(this.getPoint(t,e,i,n,r));return s}},{key:"getQuadraticPoint",value:function(t,e,i,n){var o=1-n;return{x:o*o*t.x+2*o*n*e.x+n*n*i.x,y:o*o*t.y+2*o*n*e.y+n*n*i.y}}},{key:"getLength",value:function(t,e,i,n){for(var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:100,s=0,r=this.getPoint(t,e,i,n,0),a=1;a<=o;a++){var l=a/o,c=this.getPoint(t,e,i,n,l),h=c.x-r.x,u=c.y-r.y;s+=Math.sqrt(h*h+u*u),r=c}return s}}])}();const W=N;var Y={linear:function(t){return t},easeInQuad:function(t){return t*t},easeOutQuad:function(t){return t*(2-t)},easeInOutQuad:function(t){return t<.5?2*t*t:(4-2*t)*t-1},easeInCubic:function(t){return t*t*t},easeOutCubic:function(t){return--t*t*t+1},easeInOutCubic:function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1},easeInQuart:function(t){return t*t*t*t},easeOutQuart:function(t){return 1- --t*t*t*t},easeInOutQuart:function(t){return t<.5?8*t*t*t*t:1-8*--t*t*t*t},easeInQuint:function(t){return t*t*t*t*t},easeOutQuint:function(t){return 1+--t*t*t*t*t},easeInOutQuint:function(t){return t<.5?16*t*t*t*t*t:1+16*--t*t*t*t*t},easeInSine:function(t){return 1-Math.cos(t*Math.PI/2)},easeOutSine:function(t){return Math.sin(t*Math.PI/2)},easeInOutSine:function(t){return-(Math.cos(Math.PI*t)-1)/2},easeInExpo:function(t){return 0===t?0:Math.pow(2,10*(t-1))},easeOutExpo:function(t){return 1===t?1:1-Math.pow(2,-10*t)},easeInOutExpo:function(t){return 0===t?0:1===t?1:t<.5?Math.pow(2,20*t-10)/2:(2-Math.pow(2,-20*t+10))/2},easeInCirc:function(t){return 1-Math.sqrt(1-t*t)},easeOutCirc:function(t){return Math.sqrt(1- --t*t)},easeInOutCirc:function(t){return t<.5?(1-Math.sqrt(1-4*t*t))/2:(Math.sqrt(1-4*(t-1)*(t-1))+1)/2},easeInBounce:function(t){return 1-Y.easeOutBounce(1-t)},easeOutBounce:function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},easeInOutBounce:function(t){return t<.5?.5*Y.easeInBounce(2*t):.5*Y.easeOutBounce(2*t-1)+.5},easeInElastic:function(t){return 0===t?0:1===t?1:-Math.pow(2,10*(t-1))*Math.sin(5*(t-1.1)*Math.PI)},easeOutElastic:function(t){return 0===t?0:1===t?1:Math.pow(2,-10*t)*Math.sin(5*(t-.1)*Math.PI)+1},easeInOutElastic:function(t){return 0===t?0:1===t?1:(t*=2)<1?-.5*Math.pow(2,10*(t-1))*Math.sin(5*(t-1.1)*Math.PI):.5*Math.pow(2,-10*(t-1))*Math.sin(5*(t-1.1)*Math.PI)+1},easeStepStart:function(t){return 0===t?0:1},easeStepEnd:function(t){return 1===t?1:0},easeSteps:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;return Math.floor(t*e)/(e-1)},easeInBack:function(t){var e=1.70158;return e*t*t*t-e*t*t},easeOutBack:function(t){var e=1.70158;return 1+e*Math.pow(t-1,3)+e*Math.pow(t-1,2)},easeInOutBack:function(t){var e=2.5949095;return t<.5?Math.pow(2*t,2)*(7.189819*t-e)/2:(Math.pow(2*t-2,2)*((e+1)*(2*t-2)+e)+2)/2}};const q=Y;function U(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,o,s,r,a=[],l=!0,c=!1;try{if(s=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;l=!1}else for(;!(l=(n=s.call(i)).done)&&(a.push(n.value),a.length!==e);l=!0);}catch(t){c=!0,o=t}finally{try{if(!l&&null!=i.return&&(r=i.return(),Object(r)!==r))return}finally{if(c)throw o}}return a}}(t,e)||function(t,e){if(t){if("string"==typeof t)return K(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?K(t,e):void 0}}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function K(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function Z(t){return Z="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Z(t)}function H(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function Q(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?H(Object(i),!0).forEach(function(e){$(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):H(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function $(t,e,i){return(e=et(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function tt(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,et(n.key),n)}}function et(t){var e=function(t,e){if("object"!=Z(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=Z(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==Z(e)?e:e+""}var it=function(){return function(t,e,i){return e&&tt(t.prototype,e),i&&tt(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(e){var i,n,o,s,r,a,l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.engine=e,this.config={x:l.x||0,y:l.y||0,zoom:null!==(i=l.zoom)&&void 0!==i?i:1,bounds:l.bounds||null,minZoom:null!==(n=l.minZoom)&&void 0!==n?n:.1,maxZoom:null!==(o=l.maxZoom)&&void 0!==o?o:5,smoothing:null===(s=l.smoothing)||void 0===s||s,smoothSpeed:null!==(r=l.smoothSpeed)&&void 0!==r?r:.1,rotation:l.rotation||0,viewPadding:null!==(a=l.viewPadding)&&void 0!==a?a:100},this._originalConfig=Q({},this.config),this.x=this.config.x,this.y=this.config.y,this.zoom=this.config.zoom,this.bounds=this.config.bounds,this.minZoom=this.config.minZoom,this.maxZoom=this.config.maxZoom,this.smoothing=this.config.smoothing,this.smoothSpeed=this.config.smoothSpeed,this._targetX=this.x,this._targetY=this.y,this._targetZoom=this.zoom,this._lastX=this.x,this._lastY=this.y,this._lastZoom=this.zoom,this.deltaX=0,this.deltaY=0,this.deltaZoom=0,this._followedEntity=null,this._followConfig=null,this._followOffset={x:0,y:0},this._states=new Map,this._effects={shake:null},this.rotation=this.config.rotation,this._targetRotation=this.rotation,this._lastRotation=this.rotation,this.deltaRotation=0},[{key:"moveTo",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"easeInOutCubic";if(this.bounds){var r=this.engine.baseWidth/this.zoom,a=this.engine.baseHeight/this.zoom;t=this.bounds.width>r?Math.min(Math.max(t,this.bounds.x),this.bounds.x+this.bounds.width-r):this.bounds.x+(this.bounds.width-r)/2,i=this.bounds.height>a?Math.min(Math.max(i,this.bounds.y),this.bounds.y+this.bounds.height-a):this.bounds.y+(this.bounds.height-a)/2}if(n||!o)return this.x=this._targetX=t,this.y=this._targetY=i,this;var l=this.x,c=this.y,h=Date.now();this.smoothing=!1,s="function"==typeof s?s:this.engine.Ease[s]||this.engine.Ease.easeInOutCubic;var u=function(){var n=Math.min((Date.now()-h)/o,1),r=s(n);e.x=e._targetX=l+(t-l)*r,e.y=e._targetY=c+(i-c)*r,n<1?requestAnimationFrame(u):e.smoothing=!0};return u(),this}},{key:"moveBy",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"easeInOutCubic";return this.moveTo(this.x+t,this.y+e,i,n,o)}},{key:"getCurrentCenter",value:function(){var t=this.engine.baseWidth/this.zoom,e=this.engine.baseHeight/this.zoom;return{x:this.x+t/2,y:this.y+e/2}}},{key:"zoomTo",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"easeInOutCubic";if("object"===Z(t)){var r=t;t=r.zoom,i=r.centerX,n=r.centerY;var a=r.duration;o=void 0===a?500:a;var l=r.easing;s=void 0===l?"easeInOutCubic":l}t=Math.min(Math.max(t,this.minZoom),this.maxZoom);var c=this.getCurrentCenter();i=null!=i?i:c.x,n=null!=n?n:c.y;var h=this.zoom,u=this.x,m=this.y,y=Date.now(),p=(this.engine.baseWidth,this.engine.baseHeight,this.engine.baseWidth/t),d=this.engine.baseHeight/t,f=i-p/2,_=n-d/2;this.bounds&&(f=this.bounds.width>p?Math.min(Math.max(f,this.bounds.x),this.bounds.x+this.bounds.width-p):this.bounds.x+(this.bounds.width-p)/2,_=this.bounds.height>d?Math.min(Math.max(_,this.bounds.y),this.bounds.y+this.bounds.height-d):this.bounds.y+(this.bounds.height-d)/2);var v=this.smoothing;this.smoothing=!1,s="function"==typeof s?s:this.engine.Ease[s]||this.engine.Ease.easeInOutCubic;var g=function(){var i=Date.now()-y,n=Math.min(i/o,1),r=s(n);e.zoom=h+(t-h)*r;var a,l,c=e.engine.baseWidth/e.zoom,p=e.engine.baseHeight/e.zoom;e.bounds?(e.bounds.width>c?(a=u+(f-u)*r,a=Math.min(Math.max(a,e.bounds.x),e.bounds.x+e.bounds.width-c)):a=e.bounds.x+(e.bounds.width-c)/2,e.bounds.height>p?(l=m+(_-m)*r,l=Math.min(Math.max(l,e.bounds.y),e.bounds.y+e.bounds.height-p)):l=e.bounds.y+(e.bounds.height-p)/2):(a=u+(f-u)*r,l=m+(_-m)*r),e.x=a,e.y=l,e._targetZoom=e.zoom,e._targetX=e.x,e._targetY=e.y,n<1?requestAnimationFrame(g):e.smoothing=v};return g(),this}},{key:"zoomToLevel",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"easeInOutCubic";return this.zoomTo(t,e,i,n,o)}},{key:"zoomBy",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"easeInOutCubic";return this.zoomTo(this.zoom*t,e,i,n,o)}},{key:"zoomAtPoint",value:function(t,e,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"easeInOutCubic",s=this.screenToWorld(e,i);return this.zoomTo(this.zoom*t,s.x,s.y,n,o)}},{key:"rotate",value:function(t){var e=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:500,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"easeInOutCubic";if((t%=360)<0&&(t+=360),arguments.length>1&&void 0!==arguments[1]&&arguments[1]||!i)return this.rotation=this._targetRotation=t,this;var o=this.rotation,s=Date.now();this.smoothing=!1,n="function"==typeof n?n:this.engine.Ease[n]||this.engine.Ease.easeInOutCubic;var r=function(){var a=Math.min((Date.now()-s)/i,1),l=n(a),c=t-o;Math.abs(c)>180&&(c>0?c-=360:c+=360),e.rotation=e._targetRotation=o+c*l,a<1?requestAnimationFrame(r):e.smoothing=!0};return r(),this}},{key:"rotateBy",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:500,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"easeInOutCubic";return this.rotate(this.rotation+t,e,i,n)}},{key:"setBounds",value:function(t){return this.bounds=t,this._enforceBounds(),this}},{key:"_enforceBounds",value:function(){if(this.bounds){var t=this.engine.baseWidth/this._targetZoom,e=this.engine.baseHeight/this._targetZoom;this.bounds.width>t?this._targetX=Math.min(Math.max(this._targetX,this.bounds.x),this.bounds.x+this.bounds.width-t):this._targetX=this.bounds.x+(this.bounds.width-t)/2,this.bounds.height>e?this._targetY=Math.min(Math.max(this._targetY,this.bounds.y),this.bounds.y+this.bounds.height-e):this._targetY=this.bounds.y+(this.bounds.height-e)/2}}},{key:"focusOn",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.zoom,n=this.engine.baseWidth/i,o=this.engine.baseHeight/i;return this.moveTo(t-n/2,e-o/2).zoomTo(i)}},{key:"focusOnRect",value:function(t){var e,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this.engine.baseWidth/this.engine.baseHeight;return e=(t.width+2*i)/(t.height+2*i)>n?this.engine.baseWidth/(t.width+2*i):this.engine.baseHeight/(t.height+2*i),this.focusOn(t.x+t.width/2,t.y+t.height/2,Math.min(Math.max(e,this.minZoom),this.maxZoom))}},{key:"apply",value:function(){var t=this.engine.ctx;t.save(),t.translate(this.engine.baseWidth/2,this.engine.baseHeight/2),t.rotate(this.rotation*Math.PI/180),t.scale(this.zoom,this.zoom),t.translate(-this.engine.baseWidth/(2*this.zoom)-this.x,-this.engine.baseHeight/(2*this.zoom)-this.y)}},{key:"update",value:function(){var t;if(this._lastRotation=this.rotation,this._lastX=this.x,this._lastY=this.y,this._lastZoom=this.zoom,this._followedEntity&&this._followConfig){var e=this.calcFollowPosition();e&&(this._followConfig.smooth?(this._targetX=e.x,this._targetY=e.y):(this.x=this._targetX=e.x,this.y=this._targetY=e.y))}if(this.smoothing||this._followedEntity&&null!==(t=this._followConfig)&&void 0!==t&&t.smooth){var i,n=(null===(i=this._followConfig)||void 0===i?void 0:i.smoothSpeed)||this.smoothSpeed;this.x+=(this._targetX-this.x)*n,this.y+=(this._targetY-this.y)*n,this.zoom+=(this._targetZoom-this.zoom)*this.smoothSpeed,this.rotation+=(this._targetRotation-this.rotation)*this.smoothSpeed}else this.x=this._targetX,this.y=this._targetY,this.zoom=this._targetZoom,this.rotation=this._targetRotation;this.deltaX=this.x-this._lastX,this.deltaY=this.y-this._lastY,this.deltaZoom=this.zoom-this._lastZoom,this.deltaRotation=this.rotation-this._lastRotation,this._enforceBounds(),this._updateEffects(this.engine.ctx)}},{key:"screenToWorld",value:function(t,e){var i=this.engine.canvas.getBoundingClientRect(),n=(t-i.left)*(this.engine.canvas.width/i.width),o=(e-i.top)*(this.engine.canvas.height/i.height),s=n/this.engine.config.quality,r=o/this.engine.config.quality,a=s-this.engine.baseWidth/2,l=r-this.engine.baseHeight/2,c=-this.rotation*Math.PI/180,h=a*Math.cos(c)-l*Math.sin(c),u=a*Math.sin(c)+l*Math.cos(c);return{x:h/this.zoom+this.x+this.engine.baseWidth/(2*this.zoom),y:u/this.zoom+this.y+this.engine.baseHeight/(2*this.zoom)}}},{key:"worldToScreen",value:function(t,e){var i=(t-this.x)*this.zoom,n=(e-this.y)*this.zoom,o=this.rotation*Math.PI/180,s=i*Math.cos(o)-n*Math.sin(o),r=i*Math.sin(o)+n*Math.cos(o),a=s*this.engine.config.quality,l=r*this.engine.config.quality,c=this.engine.canvas.getBoundingClientRect();return{x:a*(c.width/this.engine.canvas.width)+c.left+c.width/2,y:l*(c.height/this.engine.canvas.height)+c.top+c.height/2}}},{key:"follow",value:function(t){var e,i,n,o,s,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!this.engine.isEntity(t))throw new Error("Entity is required");return this._followedEntity=t,this._followConfig={behavior:r.behavior||"center",offset:{x:(null===(e=r.offset)||void 0===e?void 0:e.x)||0,y:(null===(i=r.offset)||void 0===i?void 0:i.y)||0},deadzone:{x:(null===(n=r.deadzone)||void 0===n?void 0:n.x)||0,y:(null===(o=r.deadzone)||void 0===o?void 0:o.y)||0},smooth:null===(s=r.smooth)||void 0===s||s,smoothSpeed:r.smoothSpeed||.1},this._followConfig.smoothSpeed=Math.min(Math.max(this._followConfig.smoothSpeed,0),1),this}},{key:"cancelFollow",value:function(){return this._followedEntity=null,this._followConfig=null,this._followOffset={x:0,y:0},this}},{key:"calcFollowPosition",value:function(){if(!this._followedEntity||!this._followConfig)return null;var t=this._followedEntity,e=this._followConfig,i=this.engine.baseWidth/this.zoom,n=this.engine.baseHeight/this.zoom,o=this.x,s=this.y,r=t.absoluteX+t.width/2,a=t.absoluteY+t.height/2,l=this.x,c=this.x+i,h=this.y,u=this.y+n,m=e.deadzone.x,y=e.deadzone.y;switch(e.behavior){case"center":o=r-i/2+e.offset.x,s=a-n/2+e.offset.y;break;case"edge":r<l+m?o=r-m:r>c-m&&(o=r+m-i),a<h+y?s=a-y:a>u-y&&(s=a+y-n);break;case"horizontal-edge":r<l+m?o=r-m:r>c-m&&(o=r+m-i);break;case"vertical-edge":a<h+y?s=a-y:a>u-y&&(s=a+y-n);break;case"top":o=r-i/2+e.offset.x,s=a-y+e.offset.y;break;case"bottom":o=r-i/2+e.offset.x,s=a+y-n+e.offset.y;break;case"left":o=r-m+e.offset.x,s=a-n/2+e.offset.y;break;case"right":o=r+m-i+e.offset.x,s=a-n/2+e.offset.y}return this.bounds&&(o=this.bounds.width>i?Math.min(Math.max(o,this.bounds.x),this.bounds.x+this.bounds.width-i):this.bounds.x+(this.bounds.width-i)/2,s=this.bounds.height>n?Math.min(Math.max(s,this.bounds.y),this.bounds.y+this.bounds.height-n):this.bounds.y+(this.bounds.height-n)/2),{x:o,y:s}}},{key:"calcFixedPosition",value:function(t,e){var i=this.engine.camera,n=this.engine.baseWidth/i.zoom,o=this.engine.baseHeight/i.zoom,s=i.x+t/this.engine.baseWidth*n,r=i.y+e/this.engine.baseHeight*o;return t<0&&(s=i.x+n+t/this.engine.baseWidth*n),e<0&&(r=i.y+o+e/this.engine.baseHeight*o),{x:s,y:r}}},{key:"inView",value:function(t){var e,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.config.viewPadding,n=this.engine.baseWidth/this.zoom,o=this.engine.baseHeight/this.zoom,s=this.x-i,r=this.y-i,a=this.x+n+i,l=this.y+o+i;if(this.engine.isEntity(t)){var c=t.collision||{};e={left:t.absoluteX+(c.x||0),top:t.absoluteY+(c.y||0),right:t.absoluteX+(c.x||0)+(c.width||t.width),bottom:t.absoluteY+(c.y||0)+(c.height||t.height)}}else e=t.collision?{left:t.x+t.collision.x,top:t.y+t.collision.y,right:t.x+t.collision.x+t.collision.width,bottom:t.y+t.collision.y+t.collision.height}:{left:t.x||0,top:t.y||0,right:(t.x||0)+(t.width||0),bottom:(t.y||0)+(t.height||0)};return!(e.right<s||e.left>a||e.bottom<r||e.top>l)}},{key:"pointInView",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.config.viewPadding,n=this.engine.baseWidth/this.zoom,o=this.engine.baseHeight/this.zoom;return t>=this.x-i&&t<=this.x+n+i&&e>=this.y-i&&e<=this.y+o+i}},{key:"saveState",value:function(t){if(!t)throw new Error("Status name cannot be empty.");var e={x:this.x,y:this.y,zoom:this.zoom,_targetX:this._targetX,_targetY:this._targetY,_targetZoom:this._targetZoom,smoothing:this.smoothing,smoothSpeed:this.smoothSpeed,bounds:this.bounds?Q({},this.bounds):null,minZoom:this.minZoom,maxZoom:this.maxZoom,_followedEntity:this._followedEntity,_followConfig:this._followConfig?Q({},this._followConfig):null,_followOffset:Q({},this._followOffset),timestamp:(new Date).toISOString()};return this._states.set(t,e),this}},{key:"loadState",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=this._states.get(t);if(!i)throw new Error('No status with name "'.concat(t,'" found.'));var n=e.smooth,o=void 0!==n&&n,s=e.duration,r=void 0===s?500:s;return o?this.zoomTo({zoom:i.zoom,centerX:i.x+this.engine.baseWidth/i.zoom/2,centerY:i.y+this.engine.baseHeight/i.zoom/2,duration:r}):(this.x=this._targetX=i.x,this.y=this._targetY=i.y,this.zoom=this._targetZoom=i.zoom),this.smoothing=i.smoothing,this.smoothSpeed=i.smoothSpeed,this.bounds=i.bounds?Q({},i.bounds):null,this.minZoom=i.minZoom,this.maxZoom=i.maxZoom,i._followedEntity?(this._followedEntity=i._followedEntity,this._followConfig=i._followConfig?Q({},i._followConfig):null,this._followOffset=Q({},i._followOffset)):this.cancelFollow(),this}},{key:"deleteState",value:function(t){return this._states.delete(t)}},{key:"getStatesList",value:function(){return Array.from(this._states.keys())}},{key:"hasState",value:function(t){return this._states.has(t)}},{key:"shake",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};"number"==typeof e&&(e={intensity:e});var i=e,n=i.intensity,o=void 0===n?5:n,s=i.duration,r=void 0===s?500:s,a=(i.frequency,i.falloff),l=void 0===a?"linear":a,c=Date.now(),h=this.x,u=this.y;return this._effects.shake={animate:function(){var e=Date.now()-c;if(e<r){var i=e/r,n="linear"===l?o*(1-i):o*Math.pow(1-i,2),s=2*(Math.random()-.5)*n,a=2*(Math.random()-.5)*n,m=h+s,y=u+a;if(t.bounds){var p=t.engine.baseWidth/t.zoom,d=t.engine.baseHeight/t.zoom;m=t.bounds.width>p?Math.min(Math.max(m,t.bounds.x),t.bounds.x+t.bounds.width-p):t.bounds.x+(t.bounds.width-p)/2,y=t.bounds.height>d?Math.min(Math.max(y,t.bounds.y),t.bounds.y+t.bounds.height-d):t.bounds.y+(t.bounds.height-d)/2}return t.x=m,t.y=y,!0}if(t.bounds){var f=t.engine.baseWidth/t.zoom,_=t.engine.baseHeight/t.zoom;t.bounds.width>f?t.x=Math.min(Math.max(h,t.bounds.x),t.bounds.x+t.bounds.width-f):t.x=t.bounds.x+(t.bounds.width-f)/2,t.bounds.height>_?t.y=Math.min(Math.max(u,t.bounds.y),t.bounds.y+t.bounds.height-_):t.y=t.bounds.y+(t.bounds.height-_)/2}else t.x=h,t.y=u;return t._effects.shake=null,!1}},this}},{key:"dramaticFocus",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,o=this.zoom,s=this.x,r=this.y,a=Date.now(),l=t.x-this.engine.baseWidth/n/2,c=t.y-this.engine.baseHeight/n/2;return this._effects.dramaticFocus={animate:function(){var t=Date.now()-a,h=Math.min(t/i,1),u=e.engine.Ease.easeInOutCubic(h);return e.zoom=o+(n-o)*u,e.x=s+(l-s)*u,e.y=r+(c-r)*u,h<1}},this}},{key:"_updateEffects",value:function(t){for(var e=0,i=Object.entries(this._effects);e<i.length;e++){var n=U(i[e],2),o=n[0],s=n[1];s&&!s.animate(t)&&(this._effects[o]=null)}}},{key:"reset",value:function(){return this.x=this._originalConfig.x,this.y=this._originalConfig.y,this.zoom=this._originalConfig.zoom,this.rotation=this._originalConfig.rotation,this._targetX=this.x,this._targetY=this.y,this._targetZoom=this.zoom,this._targetRotation=this.rotation,this._lastX=this.x,this._lastY=this.y,this._lastZoom=this.zoom,this._lastRotation=this.rotation,this.deltaX=0,this.deltaY=0,this.deltaZoom=0,this.deltaRotation=0,this.bounds=this._originalConfig.bounds,this.minZoom=this._originalConfig.minZoom,this.maxZoom=this._originalConfig.maxZoom,this.smoothing=this._originalConfig.smoothing,this.smoothSpeed=this._originalConfig.smoothSpeed,this.cancelFollow(),this._states.clear(),this._effects={shake:null},this}}])}();const nt=it;function ot(t){return ot="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ot(t)}function st(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,rt(n.key),n)}}function rt(t){var e=function(t,e){if("object"!=ot(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=ot(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==ot(e)?e:e+""}var at=function(){return function(t,e,i){return e&&st(t.prototype,e),i&&st(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.engine=e,this.layers=new Map,this.layerCounter=0},[{key:"add",value:function(t){var e,i,n,o,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=s.id||"bg_layer_".concat(++this.layerCounter),a=this._detectSourceType(t),l={id:r,source:t,sourceType:a,asset:"asset"===a?this.engine.getAsset(t):null,width:s.width||null,height:s.height||null,x:s.x||0,y:s.y||0,scale:s.scale||1,rotation:s.rotation||0,opacity:void 0!==s.opacity?s.opacity:1,parallax:void 0!==s.parallax?s.parallax:1,parallaxX:void 0!==s.parallaxX?s.parallaxX:s.parallax||1,parallaxY:void 0!==s.parallaxY?s.parallaxY:s.parallax||1,repeat:s.repeat||"none",speed:{x:(null===(e=s.speed)||void 0===e?void 0:e.x)||0,y:(null===(i=s.speed)||void 0===i?void 0:i.y)||0},offset:{x:(null===(n=s.offset)||void 0===n?void 0:n.x)||0,y:(null===(o=s.offset)||void 0===o?void 0:o.y)||0},top:s.top||!1,zIndex:s.zIndex||0,visible:void 0===s.visible||s.visible,_currentOffset:{x:0,y:0}};return"asset"!==a||l.asset?(this.layers.set(r,l),r):(this.engine.warn("Background asset '".concat(t,"' not found")),null)}},{key:"get",value:function(t){return this.layers.get(t)||null}},{key:"remove",value:function(t){return this.layers.delete(t)}},{key:"clear",value:function(){return this.layers.clear(),this.layerCounter=0,this}},{key:"setOrder",value:function(t,e){var i=this.layers.get(t);return!!i&&(i.zIndex=e,!0)}},{key:"setVisible",value:function(t,e){var i=this.layers.get(t);return!!i&&(i.visible=e,!0)}},{key:"update",value:function(t,e){var i=this.layers.get(t);return!!i&&(Object.keys(e).forEach(function(t){"speed"===t||"offset"===t?Object.assign(i[t],e[t]):i[t]=e[t]}),!0)}},{key:"_updateLayers",value:function(t){this.layers.forEach(function(e){e.visible&&(e._currentOffset.x+=e.speed.x*(t/1e3),e._currentOffset.y+=e.speed.y*(t/1e3))})}},{key:"_renderLayers",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];Array.from(this.layers.values()).filter(function(t){return t.visible&&t.top===i}).sort(function(t,e){return t.zIndex-e.zIndex}).forEach(function(i){e._renderLayer(t,i)})}},{key:"_renderLayer",value:function(t,e){t.save(),e.opacity<1&&(t.globalAlpha=e.opacity);var i=this.engine.camera,n=Math.floor(i.x),o=Math.floor(i.y),s=this.engine.baseWidth/i.zoom,r=this.engine.baseHeight/i.zoom,a=n*(1-e.parallaxX),l=o*(1-e.parallaxY),c=e.x+a+e.offset.x+e._currentOffset.x,h=e.y+l+e.offset.y+e._currentOffset.y;"color"===e.sourceType?this._renderColorBackground(t,e,c,h,n,o,s,r):"asset"===e.sourceType&&e.asset&&this._renderImageBackground(t,e,c,h,n,o,s,r),t.restore()}},{key:"_renderColorBackground",value:function(t,e,i,n,o,s,r,a){t.fillStyle=e.source,t.fillRect(o,s,r,a)}},{key:"_renderImageBackground",value:function(t,e,i,n,o,s,r,a){var l=e.asset.asset;t.imageSmoothingEnabled=!1,"none"===e.repeat?this._renderSingleImage(t,e,l,i,n):this._renderRepeatingBackground(t,e,l,i,n,o,s,r,a)}},{key:"_renderSingleImage",value:function(t,e,i,n,o){var s=null!=e.width?e.width:i.width*e.scale,r=null!=e.height?e.height:i.height*e.scale;0!==e.rotation?(t.save(),t.translate(n+s/2,o+r/2),t.rotate(e.rotation),t.drawImage(i,-s/2,-r/2,s,r),t.restore()):t.drawImage(i,n,o,s,r)}},{key:"_renderRepeatingBackground",value:function(t,e,i,n,o,s,r,a,l){var c=null!=e.width?e.width:i.width*e.scale,h=null!=e.height?e.height:i.height*e.scale,u=0,m=1,y=0,p=1;if("x"===e.repeat||"both"===e.repeat){var d=s-n;u=Math.floor(d/c)-1,m=Math.ceil((d+a)/c)+1}if("y"===e.repeat||"both"===e.repeat){var f=r-o;y=Math.floor(f/h)-1,p=Math.ceil((f+l)/h)+1}for(var _=y;_<p;_++)for(var v=u;v<m;v++){var g=n+v*c,b=o+_*h;g+c<s||g>s+a||b+h<r||b>r+l||(0!==e.rotation?(t.save(),t.translate(g+c/2,b+h/2),t.rotate(e.rotation),t.drawImage(i,-c/2,-h/2,c,h),t.restore()):t.drawImage(i,g,b,c,h))}}},{key:"_detectSourceType",value:function(t){if(this.engine.getAsset(t))return"asset";return"string"==typeof t&&/^(#[0-9a-fA-F]{3,8}|rgb\(|rgba\(|hsl\(|hsla\(|[a-zA-Z]+)$/.test(t.trim())?"color":void 0}}])}();const lt=at;function ct(t){return ct="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ct(t)}function ht(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,ut(n.key),n)}}function ut(t){var e=function(t,e){if("object"!=ct(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=ct(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==ct(e)?e:e+""}var mt=function(){return function(t,e,i){return e&&ht(t.prototype,e),i&&ht(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.engine=e,this.enabled=!1!==i.enabled,this.width=i.width||32,this.height=i.height||32,this.color=i.color||"rgba(0,0,0,0.3)",this.lineWidth=i.lineWidth||1,this.majorGridEvery=i.majorGridEvery||5,this.majorColor=i.majorColor||"rgba(0,0,0,0.6)",this.majorLineWidth=i.majorLineWidth||2,this.bounds=i.bounds||null,this.minZoomToShow=i.minZoomToShow||.1,this.maxZoomToShow=i.maxZoomToShow||10,this.maxLines=i.maxLines||1e3,this.originX=i.originX||0,this.originY=i.originY||0},[{key:"render",value:function(t){if(this.enabled){var e=this.engine.camera,i=e.zoom;if(!(i<this.minZoomToShow||i>this.maxZoomToShow)){t.save();var n=this.engine.baseWidth/i,o=this.engine.baseHeight/i,s=e.x,r=e.y,a=s+n,l=r+o,c=this.bounds?Math.max(s,this.bounds.x):s,h=this.bounds?Math.max(r,this.bounds.y):r,u=this.bounds?Math.min(a,this.bounds.x+this.bounds.width):a,m=this.bounds?Math.min(l,this.bounds.y+this.bounds.height):l,y=Math.floor((c-this.originX)/this.width)*this.width+this.originX,p=Math.floor((h-this.originY)/this.height)*this.height+this.originY;if(Math.ceil((u-y)/this.width)+Math.ceil((m-p)/this.height)>this.maxLines)t.restore();else{var d=Math.min(i/2,1);t.beginPath(),t.strokeStyle=this.engine.adjustAlpha(this.color,d),t.lineWidth=this.lineWidth/i;for(var f=y;f<=u;f+=this.width)if(!(f<c)){var _,v=Math.round((f-this.originX)/this.width);if(!(this.majorGridEvery>0&&v%this.majorGridEvery===0))t.moveTo(f,Math.max(h,(null===(_=this.bounds)||void 0===_?void 0:_.y)||h)),t.lineTo(f,Math.min(m,this.bounds?this.bounds.y+this.bounds.height:m))}t.stroke(),t.beginPath();for(var g=p;g<=m;g+=this.height)if(!(g<h)){var b,x=Math.round((g-this.originY)/this.height);if(!(this.majorGridEvery>0&&x%this.majorGridEvery===0))t.moveTo(Math.max(c,(null===(b=this.bounds)||void 0===b?void 0:b.x)||c),g),t.lineTo(Math.min(u,this.bounds?this.bounds.x+this.bounds.width:u),g)}if(t.stroke(),this.majorGridEvery>0){t.beginPath(),t.strokeStyle=this.engine.adjustAlpha(this.majorColor,d),t.lineWidth=this.majorLineWidth/i;for(var w=y;w<=u;w+=this.width){var C;if(!(w<c))if(Math.round((w-this.originX)/this.width)%this.majorGridEvery===0)t.moveTo(w,Math.max(h,(null===(C=this.bounds)||void 0===C?void 0:C.y)||h)),t.lineTo(w,Math.min(m,this.bounds?this.bounds.y+this.bounds.height:m))}for(var S=p;S<=m;S+=this.height){var A;if(!(S<h))if(Math.round((S-this.originY)/this.height)%this.majorGridEvery===0)t.moveTo(Math.max(c,(null===(A=this.bounds)||void 0===A?void 0:A.x)||c),S),t.lineTo(Math.min(u,this.bounds?this.bounds.x+this.bounds.width:u),S)}t.stroke()}t.restore()}}}}},{key:"snapToGrid",value:function(t,e){return{x:Math.round((t-this.originX)/this.width)*this.width+this.originX,y:Math.round((e-this.originY)/this.height)*this.height+this.originY}}},{key:"getGridCell",value:function(t,e){return{x:Math.floor((t-this.originX)/this.width),y:Math.floor((e-this.originY)/this.height)}}},{key:"cellToWorld",value:function(t,e){return{x:t*this.width+this.originX,y:e*this.height+this.originY}}},{key:"setEnabled",value:function(t){return this.enabled=t,this}},{key:"setSize",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t;return this.width=t,this.height=e,this}},{key:"setColors",value:function(t,e){return t&&(this.color=t),e&&(this.majorColor=e),this}},{key:"setLineWidth",value:function(t,e){return void 0!==t&&(this.lineWidth=t),void 0!==e&&(this.majorLineWidth=e),this}},{key:"setMajorGrid",value:function(t,e,i){return void 0!==t&&(this.majorGridEvery=t),e&&(this.majorColor=e),void 0!==i&&(this.majorLineWidth=i),this}},{key:"setBounds",value:function(t){return this.bounds=t,this}},{key:"setOrigin",value:function(t,e){return this.originX=t,this.originY=e,this}},{key:"setVisibilityRange",value:function(t,e){return void 0!==t&&(this.minZoomToShow=t),void 0!==e&&(this.maxZoomToShow=e),this}}])}();const yt=mt;var pt=["x","y","width","height"];function dt(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,o,s,r,a=[],l=!0,c=!1;try{if(s=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;l=!1}else for(;!(l=(n=s.call(i)).done)&&(a.push(n.value),a.length!==e);l=!0);}catch(t){c=!0,o=t}finally{try{if(!l&&null!=i.return&&(r=i.return(),Object(r)!==r))return}finally{if(c)throw o}}return a}}(t,e)||ft(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ft(t,e){if(t){if("string"==typeof t)return _t(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?_t(t,e):void 0}}function _t(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function vt(t){return vt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},vt(t)}function gt(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function bt(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?gt(Object(i),!0).forEach(function(e){xt(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):gt(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function xt(t,e,i){return(e=Ct(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function wt(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Ct(n.key),n)}}function Ct(t){var e=function(t,e){if("object"!=vt(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=vt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==vt(e)?e:e+""}function St(t,e){(function(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")})(t,e),e.add(t)}function At(t,e,i){if("function"==typeof t?t===e:t.has(e))return arguments.length<3?e:i;throw new TypeError("Private element is not present on this object")}var Mt=new WeakSet,kt=function(){function t(e){var i,n,o,s,r,a,l,c,h,u,m,y,p,d,f=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),St(this,Mt),this.engine=f.engine,this.id=e;var _=f.class||"";if(this.class=new Set(_.split(/\s+/).filter(Boolean)),this.x=f.x||0,this.y=f.y||0,this.absoluteX=this.x,this.absoluteY=this.y,this.width=f.width||32,this.height=f.height||32,this.parent=null,this.children=new Map,this.constrainToParent=null===(i=f.constrainToParent)||void 0===i||i,this.styles=bt(bt({},At(Mt,this,Dt).call(this,f)),{},{shape:f.shape||"rectangle",position:f.position||"absolute",blur:f.blur||0,opacity:null!==(n=f.opacity)&&void 0!==n?n:1,borderColor:f.borderColor,borderWidth:f.borderWidth||0,borderStyle:f.borderStyle||"solid",borderRadius:f.borderRadius||0,shadowColor:f.shadowColor,shadowBlur:f.shadowBlur||0,shadowOffsetX:f.shadowOffsetX||0,shadowOffsetY:f.shadowOffsetY||0,rotation:f.rotation||0,scale:f.scale||1,scaleX:f.scaleX||1,scaleY:f.scaleY||1,skewX:f.skewX||0,skewY:f.skewY||0,flipX:f.flipX||!1,flipY:f.flipY||!1,text:f.text,font:f.font||"16px Arial",color:f.color||"#000000",textAlign:f.textAlign||"center",lineHeight:f.lineHeight||1.2,textBaseline:f.textBaseline||"middle",transition:f.transition||{},visible:null===(o=f.visible)||void 0===o||o,blendMode:f.blendMode||"source-over",clip:f.clip,mask:f.mask,filter:f.filter,points:f.points||[],customPath:f.customPath?f.customPath.bind(this):null,spikes:f.spikes||5}),this._data=new Map,null!=f&&f.data)for(var v in f.data)this.data(v,f.data[v]);this.collision={enabled:Boolean(f.collision),group:(null===(s=f.collision)||void 0===s?void 0:s.group)||"group_".concat(e),width:(null===(r=f.collision)||void 0===r?void 0:r.width)||this.width,height:(null===(a=f.collision)||void 0===a?void 0:a.height)||this.height,points:(null===(l=f.collision)||void 0===l?void 0:l.points)||f.points||null,x:(null===(c=f.collision)||void 0===c?void 0:c.x)||0,y:(null===(h=f.collision)||void 0===h?void 0:h.y)||0},this.physics=null!==(u=f.physics)&&void 0!==u&&u,this.events={hoverable:Boolean(f.hoverable),draggable:Boolean(f.draggable),clickable:Boolean(f.clickable),interactive:Boolean(f.interactive)},this.eventListeners=new Map,this.animationStates=new Map,this.layer(f.layer||0),this.defaultZIndex=this.zIndex,this.sprite=f.sprite?{asset:this.engine.getAsset(f.sprite.asset),width:(null===(m=f.sprite)||void 0===m?void 0:m.width)||null,height:(null===(y=f.sprite)||void 0===y?void 0:y.height)||null,x:(null===(p=f.sprite)||void 0===p?void 0:p.x)||0,y:(null===(d=f.sprite)||void 0===d?void 0:d.y)||0,currentFrame:0,currentAnimation:null,lastFrameUpdate:0,animations:f.sprite.animations||{},defaultAnimation:f.sprite.defaultAnimation,playing:!1,frameTimer:null}:null,this.sprite&&this.sprite.defaultAnimation&&this.play(this.sprite.defaultAnimation)}return function(t,e,i){return e&&wt(t.prototype,e),i&&wt(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(t,[{key:"on",value:function(t,e){var i=this;if(Array.isArray(t))return t.forEach(function(t){i.on(t,e)}),this;if("object"===vt(t)){for(var n in t)this.on(n,t[n]);return this}return this.eventListeners.has(t)||this.eventListeners.set(t,new Set),this.eventListeners.get(t).add(e),this}},{key:"one",value:function(t,e){var i=this;if(Array.isArray(t))return t.forEach(function(t){i.one(t,e)}),this;if("object"===vt(t)){for(var n in t)this.one(n,t[n]);return this}var o=function(n){e.call(i,n),i.off(t,o)};return this.on(t,o),this}},{key:"off",value:function(t,e){var i=this;return Array.isArray(t)?(t.forEach(function(t){return i.off(t,e)}),this):(this.eventListeners.has(t)&&this.eventListeners.get(t).delete(e),this)}},{key:"trigger",value:function(t){for(var e=this,i=arguments.length,n=new Array(i>1?i-1:0),o=1;o<i;o++)n[o-1]=arguments[o];if(Array.isArray(t))return t.forEach(function(t){e.trigger(t,n)}),this;if(!this.eventListeners.has(t))return this;var s,r=function(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=ft(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return r=t.done,t},e:function(t){a=!0,s=t},f:function(){try{r||null==i.return||i.return()}finally{if(a)throw s}}}}(this.eventListeners.get(t));try{for(r.s();!(s=r.n()).done;){s.value.apply(this,n)}}catch(t){r.e(t)}finally{r.f()}return this}},{key:"isHoverable",value:function(){return this.events.hoverable}},{key:"isDraggable",value:function(){return this.events.draggable}},{key:"isClickable",value:function(){return this.events.clickable}},{key:"isInteractive",value:function(){return this.events.interactive}},{key:"append",value:function(e){var i,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e instanceof t?e=(i=e).id:i=new t(e,bt(bt({},n),{},{engine:this.engine})),this.children.has(i.id)?(this.engine.error("Entity (".concat(i.id,") exists with this ID")),i):(i.parent=this,this.children.set(e,i),this.engine.debugger.addItem(i.id,i),i.updatePosition(),i)}},{key:"layer",value:function(t){if(void 0===t)return this.zIndex;if("number"==typeof t)this.zIndex=t;else switch(t){case"above":this.zIndex=999999;break;case"below":this.zIndex=-999999;break;case"top":this.zIndex=100;break;case"bottom":this.zIndex=-100;break;case"reset":this.zIndex=this.defaultZIndex;break;default:this.zIndex=0}return this}},{key:"find",value:function(t){return this.children.get(t)}},{key:"findByClass",value:function(t){return(t=t.trim())?Array.from(this.children).filter(function(e){return dt(e,2)[1].class.has(t)}).map(function(t){return dt(t,2)[1]}):(this.engine.warn("ClassName is required"),[])}},{key:"getEntities",value:function(){var t=[this],e=function(i){i.children.forEach(function(i){t.push(i),e(i)})};return e(this),t}},{key:"clone",value:function(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=bt(bt(bt({x:this.x,y:this.y,absoluteX:this.absoluteX,absoluteY:this.absoluteY,width:this.width,height:this.height,_data:this._data,engine:this.engine,constrainToParent:this.constrainToParent,zIndex:this.zIndex},this.styles),this.events),{},{collision:bt(bt({},this.collision),{},{points:null!==(e=this.collision)&&void 0!==e&&e.points?JSON.parse(JSON.stringify(this.collision.points)):null}),physics:this.physics}),o=new t(i||"".concat(this.id,"_clone_").concat(Date.now()),n);return o.defaultZIndex=this.defaultZIndex,this.eventListeners.forEach(function(t,e){t.forEach(function(t){o.on(e,t)})}),this.animationStates.forEach(function(t,e){o.animationStates.set(e,bt({},t))}),this.sprite&&(o.sprite=bt(bt({},this.sprite),{},{animations:JSON.parse(JSON.stringify(this.sprite.animations)),asset:this.sprite.asset,currentFrame:0,currentAnimation:null,lastFrameUpdate:0,playing:!1,frameTimer:null}),o.sprite.defaultAnimation&&o.play(o.sprite.defaultAnimation)),this.styles.mask instanceof t&&(o.styles.mask=this.styles.mask.clone()),this.styles.backgroundImage&&o.style({backgroundImage:this.styles.backgroundImage,backgroundImageFit:this.styles.backgroundImageFit,backgroundImagePosition:this.styles.backgroundImagePosition,backgroundImageRepeat:this.styles.backgroundImageRepeat}),this.children.forEach(function(t,e){var i=t.clone();i.parent=o,o.children.set(e,i)}),o}},{key:"updatePosition",value:function(){if("fixed"===this.styles.position){var t=this.engine.camera.calcFixedPosition(this.x,this.y);this.absoluteX=t.x,this.absoluteY=t.y}else this.parent?(this.absoluteX=this.parent.absoluteX+this.x,this.absoluteY=this.parent.absoluteY+this.y):(this.absoluteX=this.x,this.absoluteY=this.y);this.children.forEach(function(t){t.updatePosition()})}},{key:"transition",value:function(t){var e,i=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};"string"==typeof t&&(n=arguments[2]||{},t=xt({},t,arguments[1]));n=bt({duration:300,easing:"linear",delay:0},n);var o={};Object.keys(t).forEach(function(t){return o[t]=i.styles[t]});var s=performance.now()+n.delay,r=0,a=0,l="function"==typeof n.easing?n.easing:null!==(e=this.engine.Ease[n.easing])&&void 0!==e?e:this.engine.Ease.linear,c=function(e){var h;if(null===(h=i.engine)||void 0===h||!h.running)return 0===r&&(r=e),void requestAnimationFrame(c);0!==r&&(a+=e-r,r=0);var u=e-a;if(u<s)requestAnimationFrame(c);else{var m,y=u-s;if(y>=n.duration)return i.style(t),void(null===(m=n.onComplete)||void 0===m||m.call(i));var p=y/n.duration,d=l(p),f={};Object.keys(t).forEach(function(e){var n=o[e],s=t[e];"number"==typeof n?f[e]=n+(s-n)*d:"string"==typeof n&&n.startsWith("#")&&(f[e]=i._interpolateColor(n,s,d))}),i.style(f),requestAnimationFrame(c)}};return requestAnimationFrame(c),this}},{key:"startAnimation",value:function(t){var e=this,i=this.engine.animations[t];if(!i)return this;var n=this.animationStates.get(t)||{currentFrame:0,repeat:i.options.repeat,isRunning:!0};n.isRunning=!0,this.animationStates.set(t,n);var o=function(){var t;if(n.isRunning){if(null!==(t=e.engine)&&void 0!==t&&t.running){var s=i.keyframes[n.currentFrame];if(e.style(s),n.currentFrame++,n.currentFrame>=i.keyframes.length){if(!("infinite"===n.repeat||n.repeat>0))return void(n.isRunning=!1);n.currentFrame=0,"number"==typeof n.repeat&&n.repeat--}}e.engine.timeout(function(){return requestAnimationFrame(o)},i.options.duration/i.keyframes.length)}};return requestAnimationFrame(o),this}},{key:"stopAnimation",value:function(t){if(!this.animationStates)return this;if(t){var e=this.animationStates.get(t);e&&(e.isRunning=!1,e.currentFrame=0)}else this.animationStates.forEach(function(t){t.isRunning=!1,t.currentFrame=0});return this}},{key:"style",value:function(t,e){return void 0===e&&"object"!==vt(t)?"x"===t||"y"===t||"width"===t||"height"===t?this[t]:this.styles[t]:"object"===vt(t)?this._handleObjStyle(t,e):this._handleSingleStyle(t,e)}},{key:"_handleObjStyle",value:function(t,e){var i,n=t.x,o=t.y,s=t.width,r=t.height,a=function(t,e){if(null==t)return{};var i,n,o=function(t,e){if(null==t)return{};var i={};for(var n in t)if({}.hasOwnProperty.call(t,n)){if(-1!==e.indexOf(n))continue;i[n]=t[n]}return i}(t,e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);for(n=0;n<s.length;n++)i=s[n],-1===e.indexOf(i)&&{}.propertyIsEnumerable.call(t,i)&&(o[i]=t[i])}return o}(t,pt),l=!1;return null!==(i=this.engine)&&void 0!==i&&i.physicsEnabled&&this.physics&&(void 0!==n||void 0!==o||void 0!==t.rotation)&&this.engine.physics.setTransform(this,{x:n,y:o,rotation:t.rotation}),void 0!==n&&(this.x=n),void 0!==o&&(this.y=o),void 0!==s&&(this.width===this.collision.width&&(this.collision.width=e),this.width=s,l=!0),void 0!==r&&(this.height===this.collision.height&&(this.collision.height=e),this.height=r,l=!0),void 0!==t.scale&&(l=!0),Object.keys(a).length&&Object.assign(this.styles,a),void 0===n&&void 0===o||this.updatePosition(),this.engine.physicsEnabled&&this.physics&&l&&this.engine.physics.updateShape(this),this}},{key:"_handleSingleStyle",value:function(t,e){var i;return"x"===t||"y"===t||"rotation"===t?(null!==(i=this.engine)&&void 0!==i&&i.physicsEnabled&&this.physics&&this.engine.physics.setTransform(this,xt({},t,e)),this[t]=e,this.styles[t]=e,"x"!==t&&"y"!==t||this.updatePosition(),this):"width"===t||"height"===t?(this[t]===this.collision[t]&&(this.collision[t]=e),this[t]=e,this.engine.physicsEnabled&&this.physics&&this.engine.physics.updateShape(this),this):"scale"===t?(this.styles[t]=e,this.engine.physicsEnabled&&this.physics&&this.engine.physics.updateShape(this),this):(this.styles[t]=e,this)}},{key:"text",value:function(t){return void 0===t?this.styles.text:(this.styles.text=t,this)}},{key:"img",value:function(t){var e,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof t&&t.includes("."))e=At(Mt,this,It).call(this,t);else{var n=this.engine.getAsset(t);if(!n)throw new Error("Asset not found.");e={asset:n.asset,source:null,type:n.type}}if(!e)throw new Error("Asset not found.");return this.style({backgroundColor:"transparent",backgroundImage:e.asset,backgroundImageSource:e.source,backgroundImageFit:i.fit||"contain",backgroundImagePosition:i.position||"center",backgroundImageRepeat:i.repeat||!1})}},{key:"halt",value:function(){var t=this,e=this.data("moveAnimation");return e&&(cancelAnimationFrame(e),this.unset("moveAnimation"),this.engine.timeout(function(){t.trigger("moveStop",{x:t.x,y:t.y})},5)),this}},{key:"move",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this.halt(),"number"==typeof t&&(t={x:t,y:i,duration:n||0});var o=bt({x:this.x,y:this.y,easing:"linear",duration:0,relative:!0},t);if(this.engine.physicsEnabled){var s={entity:this,x:o.relative?t.x||0:o.x,y:o.relative?t.y||0:o.y,duration:o.duration,easing:o.easing,relative:o.relative,onUpdate:o.onUpdate,onComplete:o.onComplete};if(this.engine.physics.moveEntity(s))return this}o.relative&&("x"in t&&(o.x=this.x+(t.x||0)),"y"in t&&(o.y=this.y+(t.y||0)));var r,a=o.x-this.x,l=o.y-this.y;if(!o.duration)return this.style({x:o.x,y:o.y}),null===(r=o.onComplete)||void 0===r||r.call(this),this;var c=this.getEntities(),h=new Map;c.forEach(function(t){return h.set(t,{x:t.x,y:t.y,absoluteX:t.absoluteX,absoluteY:t.absoluteY})});var u=performance.now(),m=0,y=0,p="function"==typeof o.easing?o.easing:this.engine.Ease[o.easing]||this.engine.Ease.linear,d=function(t){var i,n;if(null===(i=e.engine)||void 0===i||!i.running)return 0===m&&(m=t),void requestAnimationFrame(d);0!==m&&(y+=t-m,m=0);var s,r=t-y-u;if(r>=o.duration)return e.style({x:o.x,y:o.y}),null===(s=o.onComplete)||void 0===s||s.call(e),void e.unset("moveAnimation");var f=r/o.duration,_=p(f);c.forEach(function(t){var i=h.get(t);t===e?t.style({x:i.x+a*_,y:i.y+l*_}):t.style({x:i.x,y:i.y})}),null===(n=o.onUpdate)||void 0===n||n.call(e,_);var v=requestAnimationFrame(d);e.data("moveAnimation",v)},f=requestAnimationFrame(d);return this.data("moveAnimation",f),this}},{key:"jump",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.data("jumped",!0),this.move(bt(bt({y:-t,duration:300,easing:"linear"},i),{},{onComplete:function(){return e.unset("jumped")}})),this}},{key:"hide",value:function(){return this.style("visible",!1),this}},{key:"show",value:function(){return this.style("visible",!0),this}},{key:"data",value:function(t,e){return void 0===e?this._data.get(t):(this._data.set(t,e),this)}},{key:"unset",value:function(t){return this._data.delete(t),this}},{key:"addClass",value:function(){for(var t=this,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return i.forEach(function(e){return t.class.add(e)}),this}},{key:"removeClass",value:function(){for(var t=this,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return i.forEach(function(e){return t.class.delete(e)}),this}},{key:"toggleClass",value:function(t){return this.class.delete(t)||this.class.add(t),this}},{key:"hasClass",value:function(t){return this.class.has(t)}},{key:"setFixed",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.styles.position="fixed",null!==t&&(this.x=t),null!==e&&(this.y=e),this.updatePosition(),this}},{key:"setAbsolute",value:function(){return this.styles.position="absolute",this.updatePosition(),this}},{key:"play",value:function(t){var e,i=this;if(t=t||this.sprite.currentAnimation,!this.sprite||!this.sprite.animations[t])return this;var n=this.sprite.currentAnimation;this.stop();var o=this.sprite.animations[t];this.sprite.currentAnimation=t,this.sprite.currentFrame=0,this.sprite.playing=!0,this.sprite.lastFrameUpdate=performance.now(),this.trigger("animationStart",t),null===(e=o.onStart)||void 0===e||e.call(this,t),n!==t&&this.trigger("animationChange",n,t);var s=function(){if(i.sprite.playing){var e=performance.now();if(e-i.sprite.lastFrameUpdate>=1e3/o.frameRate){var n,r=i.sprite.currentFrame;if(i.sprite.currentFrame++,i.sprite.lastFrameUpdate=e,r!==i.sprite.currentFrame)i.trigger("frameChange",i.sprite.currentFrame),null===(n=o.onFrame)||void 0===n||n.call(i,i.sprite.currentFrame);if(i.sprite.currentFrame>=o.frames.length){var a,l;if(!o.loop)return i.stop(),i.trigger("animationEnd",t),void(null===(a=o.onEnd)||void 0===a||a.call(i,t));i.sprite.currentFrame=0,i.trigger("animationOnLoop",i.sprite.currentAnimation),null===(l=o.onLoop)||void 0===l||l.call(i,i.sprite.currentAnimation)}}i.sprite.frameTimer=requestAnimationFrame(s)}};return s(),this}},{key:"pause",value:function(){return this.sprite&&this.sprite.playing?(this.sprite.playing=!1,this.sprite.frameTimer&&(cancelAnimationFrame(this.sprite.frameTimer),this.sprite.frameTimer=null),this.trigger("animationPause",this.sprite.currentAnimation),this):this}},{key:"resume",value:function(){if(!this.sprite||this.sprite.playing)return this;var t=this.sprite.currentFrame;return this.sprite.playing=!0,this.play(this.sprite.currentAnimation),this.sprite.currentFrame=t,this.trigger("animationResume",this.sprite.currentAnimation),this}},{key:"stop",value:function(){if(!this.sprite)return this;var t=this.sprite.currentAnimation;return this.sprite.playing=!1,this.sprite.currentFrame=0,this.sprite.frameTimer&&(cancelAnimationFrame(this.sprite.frameTimer),this.sprite.frameTimer=null),t&&this.trigger("animationStop",t),this}},{key:"isPlaying",value:function(){var t;return(null===(t=this.sprite)||void 0===t?void 0:t.playing)||!1}},{key:"setSpriteAsset",value:function(t){return"spritesheet"!==(t=this.engine.getAsset(t)).type||(this.sprite.asset=t,this.trigger("spriteAssetChanged",t.id)),this}},{key:"addAnimation",value:function(t,e){return this.sprite?(this.sprite.animations[t]=e,this):this}},{key:"setAnimations",value:function(t){return this.sprite?(this.sprite.animations=t,this):this}},{key:"getCurrentAnimation",value:function(){var t;return(null===(t=this.sprite)||void 0===t?void 0:t.currentAnimation)||null}},{key:"setFrame",value:function(t){return!this.sprite||!this.sprite.currentAnimation||t>=this.sprite.animations[this.sprite.currentAnimation].frames.length||(this.sprite.currentFrame=t),this}},{key:"getCurrentFrame",value:function(){return this.sprite&&this.sprite.currentAnimation?this.sprite.animations[this.sprite.currentAnimation].frames[this.sprite.currentFrame]:null}},{key:"setFrameRate",value:function(t,e){return this.sprite&&this.sprite.animations[t]?(this.sprite.animations[t].frameRate=e,this):this}},{key:"render",value:function(t){if(this.styles.visible&&this.engine.camera.inView(this)){"fixed"===this.styles.position&&this.updatePosition(),t.save(),this.trigger("beforeRender",t),t.translate(this.absoluteX+this.width/2,this.absoluteY+this.height/2),t.rotate(this.styles.rotation*Math.PI/180),t.scale((this.styles.flipX?-1:1)*this.styles.scaleX*this.styles.scale,(this.styles.flipY?-1:1)*this.styles.scaleY*this.styles.scale),t.transform(1,this.styles.skewY,this.styles.skewX,1,0,0),t.globalAlpha=this.styles.opacity,t.globalCompositeOperation=this.styles.blendMode,this._applyFilters(t),this._applyClip(t),this.styles.shadowColor&&(t.shadowColor=this.styles.shadowColor,t.shadowBlur=this.styles.shadowBlur,t.shadowOffsetX=this.styles.shadowOffsetX,t.shadowOffsetY=this.styles.shadowOffsetY);var e=this.styles.borderRadius>0;e&&(t.save(),this._clipPath(t)),this.trigger("render",t),this.sprite?this._renderSprite(t):(this.styles.backgroundImage&&this._renderBackgroundImage(t),this.styles.customPath?this._renderCustomPath(t):this.renderShape(t)),this.styles.text&&this._renderText(t),this._applyMask(t),e&&t.restore(),this.trigger("afterRender",t),t.restore(),this.children.size>0&&this.children.forEach(function(e){e.styles.visible&&e.render(t)})}}},{key:"renderShape",value:function(t){switch(this.styles.shape){case"circle":this.renderCircle(t);break;case"triangle":this.renderTriangle(t);break;case"star":this.renderStar(t);break;case"polygon":this.renderPolygon(t);break;default:this.renderRectangle(t)}}},{key:"renderRectangle",value:function(t){var e=this.width,i=this.height;if(this.styles.borderRadius>0){var n=this.styles.borderRadius;t.beginPath(),t.moveTo(-e/2+n,-i/2),t.lineTo(e/2-n,-i/2),t.arcTo(e/2,-i/2,e/2,-i/2+n,n),t.lineTo(e/2,i/2-n),t.arcTo(e/2,i/2,e/2-n,i/2,n),t.lineTo(-e/2+n,i/2),t.arcTo(-e/2,i/2,-e/2,i/2-n,n),t.lineTo(-e/2,-i/2+n),t.arcTo(-e/2,-i/2,-e/2+n,-i/2,n),t.closePath()}else t.beginPath(),t.rect(-e/2,-i/2,e,i);this.fillAndStroke(t)}},{key:"renderCircle",value:function(t){t.beginPath(),t.arc(0,0,Math.min(this.width,this.height)/2,0,2*Math.PI),this.fillAndStroke(t)}},{key:"renderTriangle",value:function(t){var e=this.width,i=this.height;t.beginPath(),t.moveTo(0,-i/2),t.lineTo(e/2,i/2),t.lineTo(-e/2,i/2),t.closePath(),this.fillAndStroke(t)}},{key:"renderPolygon",value:function(t){if(!(this.styles.points.length<3)){if(this.styles.borderRadius>0)this._renderPolygonWithRadius(t);else{t.beginPath(),t.moveTo(this.styles.points[0].x,this.styles.points[0].y);for(var e=1;e<this.styles.points.length;e++)t.lineTo(this.styles.points[e].x,this.styles.points[e].y);t.closePath()}this.fillAndStroke(t)}}},{key:"renderStar",value:function(t){var e=Math.min(this.width,this.height)/2,i=.4*e,n=this.styles.spikes||5,o=Math.PI/n;t.beginPath(),t.moveTo(0,-e);for(var s=0;s<2*n;s++){var r=s%2==0?e:i,a=o*s-Math.PI/2;t.lineTo(Math.cos(a)*r,Math.sin(a)*r)}t.closePath(),this.fillAndStroke(t)}},{key:"fillAndStroke",value:function(t){if(this.styles.backgroundGradient){var e=this._createGradient(t);t.fillStyle=e}else t.fillStyle=this.styles.backgroundColor||this.styles.fill;this.styles.borderWidth>0&&(t.strokeStyle=this.styles.borderColor,t.lineWidth=this.styles.borderWidth,"dashed"===this.styles.borderStyle?t.setLineDash([2*this.styles.borderWidth]):"dotted"===this.styles.borderStyle&&t.setLineDash([this.styles.borderWidth])),t.fill(),this.styles.borderWidth>0&&t.stroke()}},{key:"_renderPolygonWithRadius",value:function(t){var e=this.styles.points,i=this.styles.borderRadius;t.beginPath();for(var n=0;n<e.length;n++){var o=e[n],s=e[(n+1)%e.length],r=e[(n-1+e.length)%e.length],a={x:r.x-o.x,y:r.y-o.y},l={x:s.x-o.x,y:s.y-o.y},c=Math.sqrt(a.x*a.x+a.y*a.y),h=Math.sqrt(l.x*l.x+l.y*l.y);a.x/=c,a.y/=c,l.x/=h,l.y/=h;var u=Math.min(i,c/2,h/2),m={x:o.x+a.x*u,y:o.y+a.y*u},y={x:o.x+l.x*u,y:o.y+l.y*u};0===n?t.moveTo(m.x,m.y):t.lineTo(m.x,m.y),t.quadraticCurveTo(o.x,o.y,y.x,y.y)}t.closePath()}},{key:"_renderBackgroundImage",value:function(t){if(this.styles.backgroundImage){this.styles.borderRadius>0&&this._clipPath(t),this.style("backgroundColor","transparent");var e=this.styles.backgroundImage,i=this.styles.backgroundImageSource,n=this.styles.backgroundImageFit,o=this.styles.backgroundImagePosition,s=this.styles.backgroundImageRepeat,r=this.width,a=this.height,l=-this.width/2,c=-this.height/2;if(s)t.fillStyle=t.createPattern(e,"repeat"),t.fillRect(-this.width/2,-this.height/2,this.width,this.height);else{var h=i?i.width:e.width,u=i?i.height:e.height,m="contain"===n?Math.min(this.width/h,this.height/u):"cover"===n?Math.max(this.width/h,this.height/u):1;"stretch"!==n&&(r=h*m,a=u*m),o.includes("center")?(l=-r/2,c=-a/2):(o.includes("left")&&(l=-this.width/2),o.includes("right")&&(l=this.width/2-r),o.includes("top")&&(c=-this.height/2),o.includes("bottom")&&(c=this.height/2-a)),i?t.drawImage(e,i.x,i.y,i.width,i.height,l,c,r,a):t.drawImage(e,l,c,r,a)}}}},{key:"_renderText",value:function(t){var e=this;if(this.styles.text){t.font=this.styles.font,t.textAlign=this.styles.textAlign,t.textBaseline=this.styles.textBaseline,t.fillStyle=this.styles.color;var i=this.styles.text.toString().split("\n"),n=parseInt(this.styles.font)*this.styles.lineHeight;i.forEach(function(o,s){var r=0,a=(s-(i.length-1)/2)*n;switch(e.styles.textAlign){case"left":r=-e.width/2;break;case"right":r=e.width/2;break;default:r=0}t.fillText(o,r,a)})}}},{key:"_clipPath",value:function(t){var e=this.width,i=this.height,n=this.styles.borderRadius;n>0&&(t.beginPath(),t.moveTo(-e/2+n,-i/2),t.lineTo(e/2-n,-i/2),t.arcTo(e/2,-i/2,e/2,-i/2+n,n),t.lineTo(e/2,i/2-n),t.arcTo(e/2,i/2,e/2-n,i/2,n),t.lineTo(-e/2+n,i/2),t.arcTo(-e/2,i/2,-e/2,i/2-n,n),t.lineTo(-e/2,-i/2+n),t.arcTo(-e/2,-i/2,-e/2+n,-i/2,n),t.closePath(),t.clip())}},{key:"_applyClip",value:function(t){if(this.styles.clip)if("function"==typeof this.styles.clip)t.beginPath(),this.styles.clip.call(this,t),t.clip();else if(Array.isArray(this.styles.clip)){t.beginPath(),t.moveTo(this.styles.clip[0].x,this.styles.clip[0].y);for(var e=1;e<this.styles.clip.length;e++)t.lineTo(this.styles.clip[e].x,this.styles.clip[e].y);t.closePath(),t.clip()}}},{key:"_applyFilters",value:function(t){this.styles.blur>0&&(t.filter="blur(".concat(this.styles.blur,"px)")),this.styles.filter&&(t.filter=this.styles.filter)}},{key:"_applyMask",value:function(e){this.styles.mask&&(e.save(),"function"==typeof this.styles.mask?this.styles.mask.call(this,e):this.styles.mask instanceof t&&(e.globalCompositeOperation="destination-in",this.styles.mask.render(e)),e.restore())}},{key:"_renderCustomPath",value:function(t){"function"==typeof this.styles.customPath&&this.styles.customPath(t)}},{key:"_renderSprite",value:function(t){var e;if(this.sprite&&this.sprite.asset){var i=this.sprite.asset;if("spritesheet"===i.type){var n=this.sprite.animations[this.sprite.currentAnimation];if(n){var o=n.frames[this.sprite.currentFrame];if(i.config.frames[o]){t.save(),t.translate(-this.width/2,-this.height/2),(this.styles.backgroundColor||this.styles.backgroundGradient)&&(this.styles.backgroundGradient?t.fillStyle=this._createGradient(t):t.fillStyle=this.styles.backgroundColor,t.fillRect(0,0,this.width,this.height));var s,r,a,l=i.config,c=l.width,h=l.height,u=l.columns,m=l.margin,y=void 0===m?[0,0]:m,p=l.originOffset,d=void 0===p?[0,0]:p;if(null!==this.sprite.width&&null!==this.sprite.height)s=this.sprite.width,r=this.sprite.height,a=s/c;else{var f=this.width/c,_=this.height/h;s=c*(a=Math.max(f,_)),r=h*a}var v=.5*(this.width-s)+(this.sprite.x||0),g=.5*(this.height-r)+(this.sprite.y||0),b=o%u,x=Math.floor(o/u),w=d[0]+b*(c+y[0]),C=d[1]+x*(h+y[1]);t.drawImage(i.asset,w,C,c,h,v,g,s,r);var S={frame:{current:this.sprite.currentFrame,total:n.frames.length,index:o,data:{x:w,y:C,width:c,height:h,column:b,row:x}},timing:{lastUpdate:this.sprite.lastFrameUpdate,frameRate:n.frameRate,elapsedSinceLastFrame:performance.now()-this.sprite.lastFrameUpdate},render:{source:{x:w,y:C,width:c,height:h},target:{x:v,y:g,width:s,height:r,scale:a}},animation:{name:this.sprite.currentAnimation,isPlaying:this.sprite.playing,loop:n.loop},sprite:{asset:i.id,totalFrames:n.frames.length,config:{columns:u,rows:i.config.rows,width:c,height:h,originOffset:d,margin:y}}};this.trigger("spriteRender",S),null===(e=n.onRender)||void 0===e||e.call(this,S),this.styles.borderWidth>0&&(t.strokeStyle=this.styles.borderColor,t.lineWidth=this.styles.borderWidth,"dashed"===this.styles.borderStyle?t.setLineDash([2*this.styles.borderWidth]):"dotted"===this.styles.borderStyle&&t.setLineDash([this.styles.borderWidth]),t.strokeRect(0,0,this.width,this.height)),t.restore()}}}}}},{key:"isCollidable",value:function(){return this.collision.enabled}},{key:"enableCollision",value:function(){return this.collision.enabled=!0,this}},{key:"disableCollision",value:function(){return this.collision.enabled=!1,this}},{key:"setCollisionGroup",value:function(t){return this.collision.group=t,this}},{key:"setCollisionPoints",value:function(t){if(!Array.isArray(t)||t.length<3)throw new Error("Collision points must be an array with at least 3 points");return t.forEach(function(t){if(!t.x||!t.y)throw new Error("Each collision point must have x and y coordinates")}),this.collision.points=t,this.engine&&this.engine.collision&&this.engine.collision.clearCache(this.id),this}},{key:"clearCollisionPoints",value:function(){return this.collision.points=null,this.engine&&this.engine.collision&&this.engine.collision.clearCache(this.id),this}},{key:"getBounds",value:function(){var t={x:this.absoluteX+this.collision.x,y:this.absoluteY+this.collision.y,width:this.collision.width*Math.abs(this.styles.scaleX*this.styles.scale),height:this.collision.height*Math.abs(this.styles.scaleY*this.styles.scale)};if(0!==this.styles.rotation){var e=this.styles.rotation*Math.PI/180,i=Math.abs(Math.cos(e)),n=Math.abs(Math.sin(e)),o=t.width*i+t.height*n,s=t.width*n+t.height*i;t.width=o,t.height=s}return t}},{key:"_createGradient",value:function(t){var e,i=this.styles.backgroundGradient;return"linear"===i.type?e=t.createLinearGradient(i.x1||-this.width/2,i.y1||-this.height/2,i.x2||this.width/2,i.y2||this.height/2):"radial"===i.type&&(e=t.createRadialGradient(0,0,0,0,0,Math.max(this.width,this.height)/2)),i.stops.forEach(function(t){e.addColorStop(t.offset,t.color)}),e}},{key:"_interpolateColor",value:function(t,e,i){var n=this.engine.hexToRgb(t),o=this.engine.hexToRgb(e),s=Math.round(n.r+(o.r-n.r)*i),r=Math.round(n.g+(o.g-n.g)*i),a=Math.round(n.b+(o.b-n.b)*i);return"rgb(".concat(s,",").concat(r,",").concat(a,")")}},{key:"kill",value:function(){var t=this;Promise.resolve().then(function(){return t._destroy()})}},{key:"_destroy",value:function(){var t;return!!this.engine&&(this.engine.physics&&this.physics&&this.engine.physics.removeEntity(this),this.engine.draggedEntity===this&&(this.engine.draggedEntity=null),this.engine.hoveredEntity===this&&(this.engine.hoveredEntity=null),this.engine.collisionEnabled&&null!==(t=this.collision)&&void 0!==t&&t.enabled&&this.engine.collision.remove(this),this.parent&&this.parent.children.delete(this.id),this.children.forEach(function(t){return t.kill()}),this.engine.entities.delete(this.id),this.trigger("kill"),this.engine.trigger("kill",this.id),this.engine.debugger.removeItem(this.id),this.parent=null,this.engine=null,!0)}}])}();function Dt(){var t,e,i,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o={};o.backgroundColor=null!==(t=n.fill)&&void 0!==t?t:n.backgroundColor,void 0===o.backgroundColor&&(o.backgroundColor="transparent"),o.backgroundGradient=null!==(e=n.gradient)&&void 0!==e?e:n.backgroundGradient,o.fill=o.backgroundColor;var s=null!==(i=n.image)&&void 0!==i?i:n.backgroundImage;if("string"==typeof s){var r=At(Mt,this,It).call(this,s);r&&(o.backgroundImage=r.asset,o.backgroundImageSource=r.source||null,o.backgroundImageFit=n.backgroundImageFit||"contain",o.backgroundImagePosition=n.backgroundImagePosition||"center",o.backgroundImageRepeat=n.backgroundImageRepeat||!1)}else if("object"===vt(s)&&(null!=s&&s.asset||null!=s&&s.src)){var a=(null==s?void 0:s.asset)||At(Mt,this,It).call(this,s.src);a&&(o.backgroundImage=a.asset||a,o.backgroundImageSource=a.source||null,o.backgroundImageFit=s.fit||"contain",o.backgroundImagePosition=s.position||"center",o.backgroundImageRepeat=s.repeat||!1)}return o}function It(t){var e,i;if("object"===vt(t)&&null!=t&&t.asset)return t.asset;if("string"==typeof t&&t.includes(".")){var n,o,s=dt(t.split("."),2),r=s[0],a=s[1],l=null===(n=(o=this.engine).getAsset)||void 0===n?void 0:n.call(o,r);if(l&&"tiles"===l.type&&l.config.tiles[a])return{asset:l.asset,source:l.config.tiles[a],type:"tiles"}}var c=null===(e=(i=this.engine).getAsset)||void 0===e?void 0:e.call(i,t);return c?{asset:c.asset,source:null,type:c.type}:null}const Bt=kt;var Pt={};!function(t,e){function i(){}t.inherit=function(t,e){var n=t;i.prototype=e.prototype,t.prototype=new i,t.prototype.constructor=n},t.generateCallback=function(t,e){return function(){e.apply(t,arguments)}},t.NVector=function(t){t===e&&(t=0);for(var i=new Array(t||0),n=0;n<t;++n)i[n]=0;return i},t.is=function(t,i){return null!==t&&(i instanceof Function&&t instanceof i||!(t.constructor.__implements==e||!t.constructor.__implements[i]))},t.parseUInt=function(t){return Math.abs(parseInt(t))}}(Pt);var Vt,Tt,Et=Array,Lt=Pt.NVector;for(void 0===Pt&&(Pt={}),void 0===Pt.Collision&&(Pt.Collision={}),void 0===Pt.Collision.Shapes&&(Pt.Collision.Shapes={}),void 0===Pt.Common&&(Pt.Common={}),void 0===Pt.Common.Math&&(Pt.Common.Math={}),void 0===Pt.Dynamics&&(Pt.Dynamics={}),void 0===Pt.Dynamics.Contacts&&(Pt.Dynamics.Contacts={}),void 0===Pt.Dynamics.Controllers&&(Pt.Dynamics.Controllers={}),void 0===Pt.Dynamics.Joints&&(Pt.Dynamics.Joints={}),Pt.Collision.IBroadPhase="Box2D.Collision.IBroadPhase",Pt.Collision.b2AABB=function t(){t.b2AABB.apply(this,arguments)},Pt.Collision.b2Bound=function t(){t.b2Bound.apply(this,arguments)},Pt.Collision.b2BoundValues=function t(){t.b2BoundValues.apply(this,arguments),this.constructor===t&&this.b2BoundValues.apply(this,arguments)},Pt.Collision.b2Collision=function t(){t.b2Collision.apply(this,arguments)},Pt.Collision.b2ContactID=function t(){t.b2ContactID.apply(this,arguments),this.constructor===t&&this.b2ContactID.apply(this,arguments)},Pt.Collision.b2ContactPoint=function t(){t.b2ContactPoint.apply(this,arguments)},Pt.Collision.b2Distance=function t(){t.b2Distance.apply(this,arguments)},Pt.Collision.b2DistanceInput=function t(){t.b2DistanceInput.apply(this,arguments)},Pt.Collision.b2DistanceOutput=function t(){t.b2DistanceOutput.apply(this,arguments)},Pt.Collision.b2DistanceProxy=function t(){t.b2DistanceProxy.apply(this,arguments)},Pt.Collision.b2DynamicTree=function t(){t.b2DynamicTree.apply(this,arguments),this.constructor===t&&this.b2DynamicTree.apply(this,arguments)},Pt.Collision.b2DynamicTreeBroadPhase=function t(){t.b2DynamicTreeBroadPhase.apply(this,arguments)},Pt.Collision.b2DynamicTreeNode=function t(){t.b2DynamicTreeNode.apply(this,arguments)},Pt.Collision.b2DynamicTreePair=function t(){t.b2DynamicTreePair.apply(this,arguments)},Pt.Collision.b2Manifold=function t(){t.b2Manifold.apply(this,arguments),this.constructor===t&&this.b2Manifold.apply(this,arguments)},Pt.Collision.b2ManifoldPoint=function t(){t.b2ManifoldPoint.apply(this,arguments),this.constructor===t&&this.b2ManifoldPoint.apply(this,arguments)},Pt.Collision.b2Point=function t(){t.b2Point.apply(this,arguments)},Pt.Collision.b2RayCastInput=function t(){t.b2RayCastInput.apply(this,arguments),this.constructor===t&&this.b2RayCastInput.apply(this,arguments)},Pt.Collision.b2RayCastOutput=function t(){t.b2RayCastOutput.apply(this,arguments)},Pt.Collision.b2Segment=function t(){t.b2Segment.apply(this,arguments)},Pt.Collision.b2SeparationFunction=function t(){t.b2SeparationFunction.apply(this,arguments)},Pt.Collision.b2Simplex=function t(){t.b2Simplex.apply(this,arguments),this.constructor===t&&this.b2Simplex.apply(this,arguments)},Pt.Collision.b2SimplexCache=function t(){t.b2SimplexCache.apply(this,arguments)},Pt.Collision.b2SimplexVertex=function t(){t.b2SimplexVertex.apply(this,arguments)},Pt.Collision.b2TimeOfImpact=function t(){t.b2TimeOfImpact.apply(this,arguments)},Pt.Collision.b2TOIInput=function t(){t.b2TOIInput.apply(this,arguments)},Pt.Collision.b2WorldManifold=function t(){t.b2WorldManifold.apply(this,arguments),this.constructor===t&&this.b2WorldManifold.apply(this,arguments)},Pt.Collision.ClipVertex=function t(){t.ClipVertex.apply(this,arguments)},Pt.Collision.Features=function t(){t.Features.apply(this,arguments)},Pt.Collision.Shapes.b2CircleShape=function t(){t.b2CircleShape.apply(this,arguments),this.constructor===t&&this.b2CircleShape.apply(this,arguments)},Pt.Collision.Shapes.b2EdgeChainDef=function t(){t.b2EdgeChainDef.apply(this,arguments),this.constructor===t&&this.b2EdgeChainDef.apply(this,arguments)},Pt.Collision.Shapes.b2EdgeShape=function t(){t.b2EdgeShape.apply(this,arguments),this.constructor===t&&this.b2EdgeShape.apply(this,arguments)},Pt.Collision.Shapes.b2MassData=function t(){t.b2MassData.apply(this,arguments)},Pt.Collision.Shapes.b2PolygonShape=function t(){t.b2PolygonShape.apply(this,arguments),this.constructor===t&&this.b2PolygonShape.apply(this,arguments)},Pt.Collision.Shapes.b2Shape=function t(){t.b2Shape.apply(this,arguments),this.constructor===t&&this.b2Shape.apply(this,arguments)},Pt.Common.b2internal="Box2D.Common.b2internal",Pt.Common.b2Color=function t(){t.b2Color.apply(this,arguments),this.constructor===t&&this.b2Color.apply(this,arguments)},Pt.Common.b2Settings=function t(){t.b2Settings.apply(this,arguments)},Pt.Common.Math.b2Mat22=function t(){t.b2Mat22.apply(this,arguments),this.constructor===t&&this.b2Mat22.apply(this,arguments)},Pt.Common.Math.b2Mat33=function t(){t.b2Mat33.apply(this,arguments),this.constructor===t&&this.b2Mat33.apply(this,arguments)},Pt.Common.Math.b2Math=function t(){t.b2Math.apply(this,arguments)},Pt.Common.Math.b2Sweep=function t(){t.b2Sweep.apply(this,arguments)},Pt.Common.Math.b2Transform=function t(){t.b2Transform.apply(this,arguments),this.constructor===t&&this.b2Transform.apply(this,arguments)},Pt.Common.Math.b2Vec2=function t(){t.b2Vec2.apply(this,arguments),this.constructor===t&&this.b2Vec2.apply(this,arguments)},Pt.Common.Math.b2Vec3=function t(){t.b2Vec3.apply(this,arguments),this.constructor===t&&this.b2Vec3.apply(this,arguments)},Pt.Dynamics.b2Body=function t(){t.b2Body.apply(this,arguments),this.constructor===t&&this.b2Body.apply(this,arguments)},Pt.Dynamics.b2BodyDef=function t(){t.b2BodyDef.apply(this,arguments),this.constructor===t&&this.b2BodyDef.apply(this,arguments)},Pt.Dynamics.b2ContactFilter=function t(){t.b2ContactFilter.apply(this,arguments)},Pt.Dynamics.b2ContactImpulse=function t(){t.b2ContactImpulse.apply(this,arguments)},Pt.Dynamics.b2ContactListener=function t(){t.b2ContactListener.apply(this,arguments)},Pt.Dynamics.b2ContactManager=function t(){t.b2ContactManager.apply(this,arguments),this.constructor===t&&this.b2ContactManager.apply(this,arguments)},Pt.Dynamics.b2DebugDraw=function t(){t.b2DebugDraw.apply(this,arguments),this.constructor===t&&this.b2DebugDraw.apply(this,arguments)},Pt.Dynamics.b2DestructionListener=function t(){t.b2DestructionListener.apply(this,arguments)},Pt.Dynamics.b2FilterData=function t(){t.b2FilterData.apply(this,arguments)},Pt.Dynamics.b2Fixture=function t(){t.b2Fixture.apply(this,arguments),this.constructor===t&&this.b2Fixture.apply(this,arguments)},Pt.Dynamics.b2FixtureDef=function t(){t.b2FixtureDef.apply(this,arguments),this.constructor===t&&this.b2FixtureDef.apply(this,arguments)},Pt.Dynamics.b2Island=function t(){t.b2Island.apply(this,arguments),this.constructor===t&&this.b2Island.apply(this,arguments)},Pt.Dynamics.b2TimeStep=function t(){t.b2TimeStep.apply(this,arguments)},Pt.Dynamics.b2World=function t(){t.b2World.apply(this,arguments),this.constructor===t&&this.b2World.apply(this,arguments)},Pt.Dynamics.Contacts.b2CircleContact=function t(){t.b2CircleContact.apply(this,arguments)},Pt.Dynamics.Contacts.b2Contact=function t(){t.b2Contact.apply(this,arguments),this.constructor===t&&this.b2Contact.apply(this,arguments)},Pt.Dynamics.Contacts.b2ContactConstraint=function t(){t.b2ContactConstraint.apply(this,arguments),this.constructor===t&&this.b2ContactConstraint.apply(this,arguments)},Pt.Dynamics.Contacts.b2ContactConstraintPoint=function t(){t.b2ContactConstraintPoint.apply(this,arguments)},Pt.Dynamics.Contacts.b2ContactEdge=function t(){t.b2ContactEdge.apply(this,arguments)},Pt.Dynamics.Contacts.b2ContactFactory=function t(){t.b2ContactFactory.apply(this,arguments),this.constructor===t&&this.b2ContactFactory.apply(this,arguments)},Pt.Dynamics.Contacts.b2ContactRegister=function t(){t.b2ContactRegister.apply(this,arguments)},Pt.Dynamics.Contacts.b2ContactResult=function t(){t.b2ContactResult.apply(this,arguments)},Pt.Dynamics.Contacts.b2ContactSolver=function t(){t.b2ContactSolver.apply(this,arguments),this.constructor===t&&this.b2ContactSolver.apply(this,arguments)},Pt.Dynamics.Contacts.b2EdgeAndCircleContact=function t(){t.b2EdgeAndCircleContact.apply(this,arguments)},Pt.Dynamics.Contacts.b2NullContact=function t(){t.b2NullContact.apply(this,arguments),this.constructor===t&&this.b2NullContact.apply(this,arguments)},Pt.Dynamics.Contacts.b2PolyAndCircleContact=function t(){t.b2PolyAndCircleContact.apply(this,arguments)},Pt.Dynamics.Contacts.b2PolyAndEdgeContact=function t(){t.b2PolyAndEdgeContact.apply(this,arguments)},Pt.Dynamics.Contacts.b2PolygonContact=function t(){t.b2PolygonContact.apply(this,arguments)},Pt.Dynamics.Contacts.b2PositionSolverManifold=function t(){t.b2PositionSolverManifold.apply(this,arguments),this.constructor===t&&this.b2PositionSolverManifold.apply(this,arguments)},Pt.Dynamics.Controllers.b2BuoyancyController=function t(){t.b2BuoyancyController.apply(this,arguments)},Pt.Dynamics.Controllers.b2ConstantAccelController=function t(){t.b2ConstantAccelController.apply(this,arguments)},Pt.Dynamics.Controllers.b2ConstantForceController=function t(){t.b2ConstantForceController.apply(this,arguments)},Pt.Dynamics.Controllers.b2Controller=function t(){t.b2Controller.apply(this,arguments)},Pt.Dynamics.Controllers.b2ControllerEdge=function t(){t.b2ControllerEdge.apply(this,arguments)},Pt.Dynamics.Controllers.b2GravityController=function t(){t.b2GravityController.apply(this,arguments)},Pt.Dynamics.Controllers.b2TensorDampingController=function t(){t.b2TensorDampingController.apply(this,arguments)},Pt.Dynamics.Joints.b2DistanceJoint=function t(){t.b2DistanceJoint.apply(this,arguments),this.constructor===t&&this.b2DistanceJoint.apply(this,arguments)},Pt.Dynamics.Joints.b2DistanceJointDef=function t(){t.b2DistanceJointDef.apply(this,arguments),this.constructor===t&&this.b2DistanceJointDef.apply(this,arguments)},Pt.Dynamics.Joints.b2FrictionJoint=function t(){t.b2FrictionJoint.apply(this,arguments),this.constructor===t&&this.b2FrictionJoint.apply(this,arguments)},Pt.Dynamics.Joints.b2FrictionJointDef=function t(){t.b2FrictionJointDef.apply(this,arguments),this.constructor===t&&this.b2FrictionJointDef.apply(this,arguments)},Pt.Dynamics.Joints.b2GearJoint=function t(){t.b2GearJoint.apply(this,arguments),this.constructor===t&&this.b2GearJoint.apply(this,arguments)},Pt.Dynamics.Joints.b2GearJointDef=function t(){t.b2GearJointDef.apply(this,arguments),this.constructor===t&&this.b2GearJointDef.apply(this,arguments)},Pt.Dynamics.Joints.b2Jacobian=function t(){t.b2Jacobian.apply(this,arguments)},Pt.Dynamics.Joints.b2Joint=function t(){t.b2Joint.apply(this,arguments),this.constructor===t&&this.b2Joint.apply(this,arguments)},Pt.Dynamics.Joints.b2JointDef=function t(){t.b2JointDef.apply(this,arguments),this.constructor===t&&this.b2JointDef.apply(this,arguments)},Pt.Dynamics.Joints.b2JointEdge=function t(){t.b2JointEdge.apply(this,arguments)},Pt.Dynamics.Joints.b2LineJoint=function t(){t.b2LineJoint.apply(this,arguments),this.constructor===t&&this.b2LineJoint.apply(this,arguments)},Pt.Dynamics.Joints.b2LineJointDef=function t(){t.b2LineJointDef.apply(this,arguments),this.constructor===t&&this.b2LineJointDef.apply(this,arguments)},Pt.Dynamics.Joints.b2MouseJoint=function t(){t.b2MouseJoint.apply(this,arguments),this.constructor===t&&this.b2MouseJoint.apply(this,arguments)},Pt.Dynamics.Joints.b2MouseJointDef=function t(){t.b2MouseJointDef.apply(this,arguments),this.constructor===t&&this.b2MouseJointDef.apply(this,arguments)},Pt.Dynamics.Joints.b2PrismaticJoint=function t(){t.b2PrismaticJoint.apply(this,arguments),this.constructor===t&&this.b2PrismaticJoint.apply(this,arguments)},Pt.Dynamics.Joints.b2PrismaticJointDef=function t(){t.b2PrismaticJointDef.apply(this,arguments),this.constructor===t&&this.b2PrismaticJointDef.apply(this,arguments)},Pt.Dynamics.Joints.b2PulleyJoint=function t(){t.b2PulleyJoint.apply(this,arguments),this.constructor===t&&this.b2PulleyJoint.apply(this,arguments)},Pt.Dynamics.Joints.b2PulleyJointDef=function t(){t.b2PulleyJointDef.apply(this,arguments),this.constructor===t&&this.b2PulleyJointDef.apply(this,arguments)},Pt.Dynamics.Joints.b2RevoluteJoint=function t(){t.b2RevoluteJoint.apply(this,arguments),this.constructor===t&&this.b2RevoluteJoint.apply(this,arguments)},Pt.Dynamics.Joints.b2RevoluteJointDef=function t(){t.b2RevoluteJointDef.apply(this,arguments),this.constructor===t&&this.b2RevoluteJointDef.apply(this,arguments)},Pt.Dynamics.Joints.b2WeldJoint=function t(){t.b2WeldJoint.apply(this,arguments),this.constructor===t&&this.b2WeldJoint.apply(this,arguments)},Pt.Dynamics.Joints.b2WeldJointDef=function t(){t.b2WeldJointDef.apply(this,arguments),this.constructor===t&&this.b2WeldJointDef.apply(this,arguments)},Pt.postDefs=[],function(){var t=Pt.Collision.Shapes.b2CircleShape;Pt.Collision.Shapes.b2EdgeChainDef,Pt.Collision.Shapes.b2EdgeShape,Pt.Collision.Shapes.b2MassData;var e=Pt.Collision.Shapes.b2PolygonShape,i=Pt.Collision.Shapes.b2Shape;Pt.Common.b2Color,Pt.Common.b2internal;var n=Pt.Common.b2Settings;Pt.Common.Math.b2Mat22,Pt.Common.Math.b2Mat33;var o=Pt.Common.Math.b2Math,s=Pt.Common.Math.b2Sweep,r=Pt.Common.Math.b2Transform,a=Pt.Common.Math.b2Vec2;Pt.Common.Math.b2Vec3;var l=Pt.Collision.b2AABB,c=Pt.Collision.b2Bound,h=Pt.Collision.b2BoundValues,u=Pt.Collision.b2Collision,m=Pt.Collision.b2ContactID,y=Pt.Collision.b2ContactPoint,p=Pt.Collision.b2Distance,d=Pt.Collision.b2DistanceInput,f=Pt.Collision.b2DistanceOutput,_=Pt.Collision.b2DistanceProxy,v=Pt.Collision.b2DynamicTree,g=Pt.Collision.b2DynamicTreeBroadPhase,b=Pt.Collision.b2DynamicTreeNode,x=Pt.Collision.b2DynamicTreePair,w=Pt.Collision.b2Manifold,C=Pt.Collision.b2ManifoldPoint,S=Pt.Collision.b2Point,A=Pt.Collision.b2RayCastInput,M=Pt.Collision.b2RayCastOutput,k=Pt.Collision.b2Segment,D=Pt.Collision.b2SeparationFunction,I=Pt.Collision.b2Simplex,B=Pt.Collision.b2SimplexCache,P=Pt.Collision.b2SimplexVertex,V=Pt.Collision.b2TimeOfImpact,T=Pt.Collision.b2TOIInput,E=Pt.Collision.b2WorldManifold,L=Pt.Collision.ClipVertex,F=Pt.Collision.Features,G=Pt.Collision.IBroadPhase;l.b2AABB=function(){this.lowerBound=new a,this.upperBound=new a},l.prototype.IsValid=function(){var t=this.upperBound.x-this.lowerBound.x,e=this.upperBound.y-this.lowerBound.y,i=t>=0&&e>=0;return i&&this.lowerBound.IsValid()&&this.upperBound.IsValid()},l.prototype.GetCenter=function(){return new a((this.lowerBound.x+this.upperBound.x)/2,(this.lowerBound.y+this.upperBound.y)/2)},l.prototype.GetExtents=function(){return new a((this.upperBound.x-this.lowerBound.x)/2,(this.upperBound.y-this.lowerBound.y)/2)},l.prototype.Contains=function(t){var e=!0;return(e=(e=(e=e&&this.lowerBound.x<=t.lowerBound.x)&&this.lowerBound.y<=t.lowerBound.y)&&t.upperBound.x<=this.upperBound.x)&&t.upperBound.y<=this.upperBound.y},l.prototype.RayCast=function(t,e){var i=-Number.MAX_VALUE,n=Number.MAX_VALUE,o=e.p1.x,s=e.p1.y,r=e.p2.x-e.p1.x,a=e.p2.y-e.p1.y,l=Math.abs(r),c=Math.abs(a),h=t.normal,u=0,m=0,y=0,p=0,d=0;if(l<Number.MIN_VALUE){if(o<this.lowerBound.x||this.upperBound.x<o)return!1}else if(u=1/r,d=-1,(m=(this.lowerBound.x-o)*u)>(y=(this.upperBound.x-o)*u)&&(p=m,m=y,y=p,d=1),m>i&&(h.x=d,h.y=0,i=m),i>(n=Math.min(n,y)))return!1;if(c<Number.MIN_VALUE){if(s<this.lowerBound.y||this.upperBound.y<s)return!1}else if(u=1/a,d=-1,(m=(this.lowerBound.y-s)*u)>(y=(this.upperBound.y-s)*u)&&(p=m,m=y,y=p,d=1),m>i&&(h.y=d,h.x=0,i=m),i>(n=Math.min(n,y)))return!1;return t.fraction=i,!0},l.prototype.TestOverlap=function(t){var e=t.lowerBound.x-this.upperBound.x,i=t.lowerBound.y-this.upperBound.y,n=this.lowerBound.x-t.upperBound.x,o=this.lowerBound.y-t.upperBound.y;return!(e>0||i>0||n>0||o>0)},l.Combine=function(t,e){var i=new l;return i.Combine(t,e),i},l.prototype.Combine=function(t,e){this.lowerBound.x=Math.min(t.lowerBound.x,e.lowerBound.x),this.lowerBound.y=Math.min(t.lowerBound.y,e.lowerBound.y),this.upperBound.x=Math.max(t.upperBound.x,e.upperBound.x),this.upperBound.y=Math.max(t.upperBound.y,e.upperBound.y)},c.b2Bound=function(){},c.prototype.IsLower=function(){return!(1&this.value)},c.prototype.IsUpper=function(){return!(1&~this.value)},c.prototype.Swap=function(t){var e=this.value,i=this.proxy,n=this.stabbingCount;this.value=t.value,this.proxy=t.proxy,this.stabbingCount=t.stabbingCount,t.value=e,t.proxy=i,t.stabbingCount=n},h.b2BoundValues=function(){},h.prototype.b2BoundValues=function(){this.lowerValues=new Lt,this.lowerValues[0]=0,this.lowerValues[1]=0,this.upperValues=new Lt,this.upperValues[0]=0,this.upperValues[1]=0},u.b2Collision=function(){},u.ClipSegmentToLine=function(t,e,i,n){var o;void 0===n&&(n=0);var s=0,r=(o=e[0]).v,a=(o=e[1]).v,l=i.x*r.x+i.y*r.y-n,c=i.x*a.x+i.y*a.y-n;if(l<=0&&t[s++].Set(e[0]),c<=0&&t[s++].Set(e[1]),l*c<0){var h,u=l/(l-c),m=(o=t[s]).v;m.x=r.x+u*(a.x-r.x),m.y=r.y+u*(a.y-r.y),o=t[s],l>0?(h=e[0],o.id=h.id):(h=e[1],o.id=h.id),++s}return s},u.EdgeSeparation=function(t,e,i,n,o){void 0===i&&(i=0),parseInt(t.m_vertexCount);var s,r,a=t.m_vertices,l=t.m_normals,c=parseInt(n.m_vertexCount),h=n.m_vertices;s=e.R,r=l[i];for(var u=s.col1.x*r.x+s.col2.x*r.y,m=s.col1.y*r.x+s.col2.y*r.y,y=(s=o.R).col1.x*u+s.col1.y*m,p=s.col2.x*u+s.col2.y*m,d=0,f=Number.MAX_VALUE,_=0;_<c;++_){var v=(r=h[_]).x*y+r.y*p;v<f&&(f=v,d=_)}r=a[i],s=e.R;var g=e.position.x+(s.col1.x*r.x+s.col2.x*r.y),b=e.position.y+(s.col1.y*r.x+s.col2.y*r.y);r=h[d],s=o.R;var x=o.position.x+(s.col1.x*r.x+s.col2.x*r.y),w=o.position.y+(s.col1.y*r.x+s.col2.y*r.y);return(x-=g)*u+(w-=b)*m},u.FindMaxSeparation=function(t,e,i,n,o){var s,r,a=parseInt(e.m_vertexCount),l=e.m_normals;r=o.R,s=n.m_centroid;var c=o.position.x+(r.col1.x*s.x+r.col2.x*s.y),h=o.position.y+(r.col1.y*s.x+r.col2.y*s.y);r=i.R,s=e.m_centroid,c-=i.position.x+(r.col1.x*s.x+r.col2.x*s.y),h-=i.position.y+(r.col1.y*s.x+r.col2.y*s.y);for(var m=c*i.R.col1.x+h*i.R.col1.y,y=c*i.R.col2.x+h*i.R.col2.y,p=0,d=-Number.MAX_VALUE,f=0;f<a;++f){var _=(s=l[f]).x*m+s.y*y;_>d&&(d=_,p=f)}var v=u.EdgeSeparation(e,i,p,n,o),g=parseInt(p-1>=0?p-1:a-1),b=u.EdgeSeparation(e,i,g,n,o),x=parseInt(p+1<a?p+1:0),w=u.EdgeSeparation(e,i,x,n,o),C=0,S=0,A=0;if(b>v&&b>w)A=-1,C=g,S=b;else{if(!(w>v))return t[0]=p,v;A=1,C=x,S=w}for(;p=-1==A?C-1>=0?C-1:a-1:C+1<a?C+1:0,(v=u.EdgeSeparation(e,i,p,n,o))>S;)C=p,S=v;return t[0]=C,S},u.FindIncidentEdge=function(t,e,i,n,o,s){void 0===n&&(n=0),parseInt(e.m_vertexCount);var r,a,l=e.m_normals,c=parseInt(o.m_vertexCount),h=o.m_vertices,u=o.m_normals;r=i.R,a=l[n];var m=r.col1.x*a.x+r.col2.x*a.y,y=r.col1.y*a.x+r.col2.y*a.y,p=(r=s.R).col1.x*m+r.col1.y*y;y=r.col2.x*m+r.col2.y*y,m=p;for(var d,f=0,_=Number.MAX_VALUE,v=0;v<c;++v){var g=m*(a=u[v]).x+y*a.y;g<_&&(_=g,f=v)}var b=parseInt(f),x=parseInt(b+1<c?b+1:0);d=t[0],a=h[b],r=s.R,d.v.x=s.position.x+(r.col1.x*a.x+r.col2.x*a.y),d.v.y=s.position.y+(r.col1.y*a.x+r.col2.y*a.y),d.id.features.referenceEdge=n,d.id.features.incidentEdge=b,d.id.features.incidentVertex=0,d=t[1],a=h[x],r=s.R,d.v.x=s.position.x+(r.col1.x*a.x+r.col2.x*a.y),d.v.y=s.position.y+(r.col1.y*a.x+r.col2.y*a.y),d.id.features.referenceEdge=n,d.id.features.incidentEdge=x,d.id.features.incidentVertex=1},u.MakeClipPointVector=function(){var t=new Et(2);return t[0]=new L,t[1]=new L,t},u.CollidePolygons=function(t,e,i,o,s){var r;t.m_pointCount=0;var a=e.m_radius+o.m_radius,l=0;u.s_edgeAO[0]=l;var c=u.FindMaxSeparation(u.s_edgeAO,e,i,o,s);if(l=u.s_edgeAO[0],!(c>a)){var h=0;u.s_edgeBO[0]=h;var m=u.FindMaxSeparation(u.s_edgeBO,o,s,e,i);if(h=u.s_edgeBO[0],!(m>a)){var y,p,d,f,_,v=0,g=0;m>.98*c+.001?(y=o,p=e,d=s,f=i,v=h,t.m_type=w.e_faceB,g=1):(y=e,p=o,d=i,f=s,v=l,t.m_type=w.e_faceA,g=0);var b=u.s_incidentEdge;u.FindIncidentEdge(b,y,d,v,p,f);var x,C=parseInt(y.m_vertexCount),S=y.m_vertices,A=S[v];x=v+1<C?S[parseInt(v+1)]:S[0];var M=u.s_localTangent;M.Set(x.x-A.x,x.y-A.y),M.Normalize();var k=u.s_localNormal;k.x=M.y,k.y=-M.x;var D=u.s_planePoint;D.Set(.5*(A.x+x.x),.5*(A.y+x.y));var I=u.s_tangent;_=d.R,I.x=_.col1.x*M.x+_.col2.x*M.y,I.y=_.col1.y*M.x+_.col2.y*M.y;var B=u.s_tangent2;B.x=-I.x,B.y=-I.y;var P=u.s_normal;P.x=I.y,P.y=-I.x;var V=u.s_v11,T=u.s_v12;V.x=d.position.x+(_.col1.x*A.x+_.col2.x*A.y),V.y=d.position.y+(_.col1.y*A.x+_.col2.y*A.y),T.x=d.position.x+(_.col1.x*x.x+_.col2.x*x.y),T.y=d.position.y+(_.col1.y*x.x+_.col2.y*x.y);var E=P.x*V.x+P.y*V.y,L=-I.x*V.x-I.y*V.y+a,F=I.x*T.x+I.y*T.y+a,G=u.s_clipPoints1,R=u.s_clipPoints2;if(!(u.ClipSegmentToLine(G,b,B,L)<2||u.ClipSegmentToLine(R,G,I,F)<2)){t.m_localPlaneNormal.SetV(k),t.m_localPoint.SetV(D);for(var J=0,O=0;O<n.b2_maxManifoldPoints;++O)if(r=R[O],P.x*r.v.x+P.y*r.v.y-E<=a){var j=t.m_points[J];_=f.R;var z=r.v.x-f.position.x,X=r.v.y-f.position.y;j.m_localPoint.x=z*_.col1.x+X*_.col1.y,j.m_localPoint.y=z*_.col2.x+X*_.col2.y,j.m_id.Set(r.id),j.m_id.features.flip=g,++J}t.m_pointCount=J}}}},u.CollideCircles=function(t,e,i,n,o){var s,r;t.m_pointCount=0,s=i.R,r=e.m_p;var a=i.position.x+(s.col1.x*r.x+s.col2.x*r.y),l=i.position.y+(s.col1.y*r.x+s.col2.y*r.y);s=o.R,r=n.m_p;var c=o.position.x+(s.col1.x*r.x+s.col2.x*r.y)-a,h=o.position.y+(s.col1.y*r.x+s.col2.y*r.y)-l,u=c*c+h*h,m=e.m_radius+n.m_radius;u>m*m||(t.m_type=w.e_circles,t.m_localPoint.SetV(e.m_p),t.m_localPlaneNormal.SetZero(),t.m_pointCount=1,t.m_points[0].m_localPoint.SetV(n.m_p),t.m_points[0].m_id.key=0)},u.CollidePolygonAndCircle=function(t,e,i,n,o){t.m_pointCount=0;var s,r,a=0,l=0;r=o.R,s=n.m_p;var c=o.position.x+(r.col1.x*s.x+r.col2.x*s.y),h=o.position.y+(r.col1.y*s.x+r.col2.y*s.y);a=c-i.position.x,l=h-i.position.y;for(var u=a*(r=i.R).col1.x+l*r.col1.y,m=a*r.col2.x+l*r.col2.y,y=0,p=-Number.MAX_VALUE,d=e.m_radius+n.m_radius,f=parseInt(e.m_vertexCount),_=e.m_vertices,v=e.m_normals,g=0;g<f;++g){a=u-(s=_[g]).x,l=m-s.y;var b=(s=v[g]).x*a+s.y*l;if(b>d)return;b>p&&(p=b,y=g)}var x=parseInt(y),C=parseInt(x+1<f?x+1:0),S=_[x],A=_[C];if(p<Number.MIN_VALUE)return t.m_pointCount=1,t.m_type=w.e_faceA,t.m_localPlaneNormal.SetV(v[y]),t.m_localPoint.x=.5*(S.x+A.x),t.m_localPoint.y=.5*(S.y+A.y),t.m_points[0].m_localPoint.SetV(n.m_p),void(t.m_points[0].m_id.key=0);var M=(u-S.x)*(A.x-S.x)+(m-S.y)*(A.y-S.y),k=(u-A.x)*(S.x-A.x)+(m-A.y)*(S.y-A.y);if(M<=0){if((u-S.x)*(u-S.x)+(m-S.y)*(m-S.y)>d*d)return;t.m_pointCount=1,t.m_type=w.e_faceA,t.m_localPlaneNormal.x=u-S.x,t.m_localPlaneNormal.y=m-S.y,t.m_localPlaneNormal.Normalize(),t.m_localPoint.SetV(S),t.m_points[0].m_localPoint.SetV(n.m_p),t.m_points[0].m_id.key=0}else if(k<=0){if((u-A.x)*(u-A.x)+(m-A.y)*(m-A.y)>d*d)return;t.m_pointCount=1,t.m_type=w.e_faceA,t.m_localPlaneNormal.x=u-A.x,t.m_localPlaneNormal.y=m-A.y,t.m_localPlaneNormal.Normalize(),t.m_localPoint.SetV(A),t.m_points[0].m_localPoint.SetV(n.m_p),t.m_points[0].m_id.key=0}else{var D=.5*(S.x+A.x),I=.5*(S.y+A.y);if((p=(u-D)*v[x].x+(m-I)*v[x].y)>d)return;t.m_pointCount=1,t.m_type=w.e_faceA,t.m_localPlaneNormal.x=v[x].x,t.m_localPlaneNormal.y=v[x].y,t.m_localPlaneNormal.Normalize(),t.m_localPoint.Set(D,I),t.m_points[0].m_localPoint.SetV(n.m_p),t.m_points[0].m_id.key=0}},u.TestOverlap=function(t,e){var i=e.lowerBound,n=t.upperBound,o=i.x-n.x,s=i.y-n.y;i=t.lowerBound,n=e.upperBound;var r=i.x-n.x,a=i.y-n.y;return!(o>0||s>0||r>0||a>0)},Pt.postDefs.push(function(){Pt.Collision.b2Collision.s_incidentEdge=u.MakeClipPointVector(),Pt.Collision.b2Collision.s_clipPoints1=u.MakeClipPointVector(),Pt.Collision.b2Collision.s_clipPoints2=u.MakeClipPointVector(),Pt.Collision.b2Collision.s_edgeAO=new Lt(1),Pt.Collision.b2Collision.s_edgeBO=new Lt(1),Pt.Collision.b2Collision.s_localTangent=new a,Pt.Collision.b2Collision.s_localNormal=new a,Pt.Collision.b2Collision.s_planePoint=new a,Pt.Collision.b2Collision.s_normal=new a,Pt.Collision.b2Collision.s_tangent=new a,Pt.Collision.b2Collision.s_tangent2=new a,Pt.Collision.b2Collision.s_v11=new a,Pt.Collision.b2Collision.s_v12=new a,Pt.Collision.b2Collision.b2CollidePolyTempVec=new a,Pt.Collision.b2Collision.b2_nullFeature=255}),m.b2ContactID=function(){this.features=new F},m.prototype.b2ContactID=function(){this.features._m_id=this},m.prototype.Set=function(t){this.key=t._key},m.prototype.Copy=function(){var t=new m;return t.key=this.key,t},Object.defineProperty(m.prototype,"key",{enumerable:!1,configurable:!0,get:function(){return this._key}}),Object.defineProperty(m.prototype,"key",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._key=t,this.features._referenceEdge=255&this._key,this.features._incidentEdge=(65280&this._key)>>8&255,this.features._incidentVertex=(16711680&this._key)>>16&255,this.features._flip=(4278190080&this._key)>>24&255}}),y.b2ContactPoint=function(){this.position=new a,this.velocity=new a,this.normal=new a,this.id=new m},p.b2Distance=function(){},p.Distance=function(t,e,i){++p.b2_gjkCalls;var s=i.proxyA,r=i.proxyB,l=i.transformA,c=i.transformB,h=p.s_simplex;h.ReadCache(e,s,l,r,c);var u=h.m_vertices,m=p.s_saveA,y=p.s_saveB,d=0;h.GetClosestPoint().LengthSquared();for(var f,_=0,v=0;v<20;){for(d=h.m_count,_=0;_<d;_++)m[_]=u[_].indexA,y[_]=u[_].indexB;switch(h.m_count){case 1:break;case 2:h.Solve2();break;case 3:h.Solve3();break;default:n.b2Assert(!1)}if(3==h.m_count)break;(f=h.GetClosestPoint()).LengthSquared();var g=h.GetSearchDirection();if(g.LengthSquared()<Number.MIN_VALUE*Number.MIN_VALUE)break;var b=u[h.m_count];b.indexA=s.GetSupport(o.MulTMV(l.R,g.GetNegative())),b.wA=o.MulX(l,s.GetVertex(b.indexA)),b.indexB=r.GetSupport(o.MulTMV(c.R,g)),b.wB=o.MulX(c,r.GetVertex(b.indexB)),b.w=o.SubtractVV(b.wB,b.wA),++v,++p.b2_gjkIters;var x=!1;for(_=0;_<d;_++)if(b.indexA==m[_]&&b.indexB==y[_]){x=!0;break}if(x)break;++h.m_count}if(p.b2_gjkMaxIters=o.Max(p.b2_gjkMaxIters,v),h.GetWitnessPoints(t.pointA,t.pointB),t.distance=o.SubtractVV(t.pointA,t.pointB).Length(),t.iterations=v,h.WriteCache(e),i.useRadii){var w=s.m_radius,C=r.m_radius;if(t.distance>w+C&&t.distance>Number.MIN_VALUE){t.distance-=w+C;var S=o.SubtractVV(t.pointB,t.pointA);S.Normalize(),t.pointA.x+=w*S.x,t.pointA.y+=w*S.y,t.pointB.x-=C*S.x,t.pointB.y-=C*S.y}else(f=new a).x=.5*(t.pointA.x+t.pointB.x),f.y=.5*(t.pointA.y+t.pointB.y),t.pointA.x=t.pointB.x=f.x,t.pointA.y=t.pointB.y=f.y,t.distance=0}},Pt.postDefs.push(function(){Pt.Collision.b2Distance.s_simplex=new I,Pt.Collision.b2Distance.s_saveA=new Lt(3),Pt.Collision.b2Distance.s_saveB=new Lt(3)}),d.b2DistanceInput=function(){},f.b2DistanceOutput=function(){this.pointA=new a,this.pointB=new a},_.b2DistanceProxy=function(){},_.prototype.Set=function(o){switch(o.GetType()){case i.e_circleShape:var s=o instanceof t?o:null;this.m_vertices=new Et(1,!0),this.m_vertices[0]=s.m_p,this.m_count=1,this.m_radius=s.m_radius;break;case i.e_polygonShape:var r=o instanceof e?o:null;this.m_vertices=r.m_vertices,this.m_count=r.m_vertexCount,this.m_radius=r.m_radius;break;default:n.b2Assert(!1)}},_.prototype.GetSupport=function(t){for(var e=0,i=this.m_vertices[0].x*t.x+this.m_vertices[0].y*t.y,n=1;n<this.m_count;++n){var o=this.m_vertices[n].x*t.x+this.m_vertices[n].y*t.y;o>i&&(e=n,i=o)}return e},_.prototype.GetSupportVertex=function(t){for(var e=0,i=this.m_vertices[0].x*t.x+this.m_vertices[0].y*t.y,n=1;n<this.m_count;++n){var o=this.m_vertices[n].x*t.x+this.m_vertices[n].y*t.y;o>i&&(e=n,i=o)}return this.m_vertices[e]},_.prototype.GetVertexCount=function(){return this.m_count},_.prototype.GetVertex=function(t){return void 0===t&&(t=0),n.b2Assert(0<=t&&t<this.m_count),this.m_vertices[t]},v.b2DynamicTree=function(){},v.prototype.b2DynamicTree=function(){this.m_root=null,this.m_freeList=null,this.m_path=0,this.m_insertionCount=0},v.prototype.CreateProxy=function(t,e){var i=this.AllocateNode(),o=n.b2_aabbExtension,s=n.b2_aabbExtension;return i.aabb.lowerBound.x=t.lowerBound.x-o,i.aabb.lowerBound.y=t.lowerBound.y-s,i.aabb.upperBound.x=t.upperBound.x+o,i.aabb.upperBound.y=t.upperBound.y+s,i.userData=e,this.InsertLeaf(i),i},v.prototype.DestroyProxy=function(t){this.RemoveLeaf(t),this.FreeNode(t)},v.prototype.MoveProxy=function(t,e,i){if(n.b2Assert(t.IsLeaf()),t.aabb.Contains(e))return!1;this.RemoveLeaf(t);var o=n.b2_aabbExtension+n.b2_aabbMultiplier*(i.x>0?i.x:-i.x),s=n.b2_aabbExtension+n.b2_aabbMultiplier*(i.y>0?i.y:-i.y);return t.aabb.lowerBound.x=e.lowerBound.x-o,t.aabb.lowerBound.y=e.lowerBound.y-s,t.aabb.upperBound.x=e.upperBound.x+o,t.aabb.upperBound.y=e.upperBound.y+s,this.InsertLeaf(t),!0},v.prototype.Rebalance=function(t){if(void 0===t&&(t=0),null!=this.m_root)for(var e=0;e<t;e++){for(var i=this.m_root,n=0;0==i.IsLeaf();)i=this.m_path>>n&1?i.child2:i.child1,n=n+1&31;++this.m_path,this.RemoveLeaf(i),this.InsertLeaf(i)}},v.prototype.GetFatAABB=function(t){return t.aabb},v.prototype.GetUserData=function(t){return t.userData},v.prototype.Query=function(t,e){if(null!=this.m_root){var i=new Et,n=0;for(i[n++]=this.m_root;n>0;){var o=i[--n];if(o.aabb.TestOverlap(e))if(o.IsLeaf()){if(!t(o))return}else i[n++]=o.child1,i[n++]=o.child2}}},v.prototype.RayCast=function(t,e){if(null!=this.m_root){var i=e.p1,n=e.p2,s=o.SubtractVV(i,n);s.Normalize();var r=o.CrossFV(1,s),a=o.AbsV(r),c=e.maxFraction,h=new l,u=0,m=0;u=i.x+c*(n.x-i.x),m=i.y+c*(n.y-i.y),h.lowerBound.x=Math.min(i.x,u),h.lowerBound.y=Math.min(i.y,m),h.upperBound.x=Math.max(i.x,u),h.upperBound.y=Math.max(i.y,m);var y=new Et,p=0;for(y[p++]=this.m_root;p>0;){var d=y[--p];if(0!=d.aabb.TestOverlap(h)){var f=d.aabb.GetCenter(),_=d.aabb.GetExtents();if(!(Math.abs(r.x*(i.x-f.x)+r.y*(i.y-f.y))-a.x*_.x-a.y*_.y>0))if(d.IsLeaf()){var v=new A;if(v.p1=e.p1,v.p2=e.p2,v.maxFraction=e.maxFraction,0==(c=t(v,d)))return;c>0&&(u=i.x+c*(n.x-i.x),m=i.y+c*(n.y-i.y),h.lowerBound.x=Math.min(i.x,u),h.lowerBound.y=Math.min(i.y,m),h.upperBound.x=Math.max(i.x,u),h.upperBound.y=Math.max(i.y,m))}else y[p++]=d.child1,y[p++]=d.child2}}}},v.prototype.AllocateNode=function(){if(this.m_freeList){var t=this.m_freeList;return this.m_freeList=t.parent,t.parent=null,t.child1=null,t.child2=null,t}return new b},v.prototype.FreeNode=function(t){t.parent=this.m_freeList,this.m_freeList=t},v.prototype.InsertLeaf=function(t){if(++this.m_insertionCount,null==this.m_root)return this.m_root=t,void(this.m_root.parent=null);var e=t.aabb.GetCenter(),i=this.m_root;if(0==i.IsLeaf())do{var n=i.child1,o=i.child2;i=Math.abs((n.aabb.lowerBound.x+n.aabb.upperBound.x)/2-e.x)+Math.abs((n.aabb.lowerBound.y+n.aabb.upperBound.y)/2-e.y)<Math.abs((o.aabb.lowerBound.x+o.aabb.upperBound.x)/2-e.x)+Math.abs((o.aabb.lowerBound.y+o.aabb.upperBound.y)/2-e.y)?n:o}while(0==i.IsLeaf());var s=i.parent,r=this.AllocateNode();if(r.parent=s,r.userData=null,r.aabb.Combine(t.aabb,i.aabb),s){i.parent.child1==i?s.child1=r:s.child2=r,r.child1=i,r.child2=t,i.parent=r,t.parent=r;do{if(s.aabb.Contains(r.aabb))break;s.aabb.Combine(s.child1.aabb,s.child2.aabb),r=s,s=s.parent}while(s)}else r.child1=i,r.child2=t,i.parent=r,t.parent=r,this.m_root=r},v.prototype.RemoveLeaf=function(t){if(t!=this.m_root){var e,i=t.parent,n=i.parent;if(e=i.child1==t?i.child2:i.child1,n)for(n.child1==i?n.child1=e:n.child2=e,e.parent=n,this.FreeNode(i);n;){var o=n.aabb;if(n.aabb=l.Combine(n.child1.aabb,n.child2.aabb),o.Contains(n.aabb))break;n=n.parent}else this.m_root=e,e.parent=null,this.FreeNode(i)}else this.m_root=null},g.b2DynamicTreeBroadPhase=function(){this.m_tree=new v,this.m_moveBuffer=new Et,this.m_pairBuffer=new Et,this.m_pairCount=0},g.prototype.CreateProxy=function(t,e){var i=this.m_tree.CreateProxy(t,e);return++this.m_proxyCount,this.BufferMove(i),i},g.prototype.DestroyProxy=function(t){this.UnBufferMove(t),--this.m_proxyCount,this.m_tree.DestroyProxy(t)},g.prototype.MoveProxy=function(t,e,i){this.m_tree.MoveProxy(t,e,i)&&this.BufferMove(t)},g.prototype.TestOverlap=function(t,e){var i=this.m_tree.GetFatAABB(t),n=this.m_tree.GetFatAABB(e);return i.TestOverlap(n)},g.prototype.GetUserData=function(t){return this.m_tree.GetUserData(t)},g.prototype.GetFatAABB=function(t){return this.m_tree.GetFatAABB(t)},g.prototype.GetProxyCount=function(){return this.m_proxyCount},g.prototype.UpdatePairs=function(t){var e=this;e.m_pairCount=0;var i,n=0;function o(t){if(t==i)return!0;e.m_pairCount==e.m_pairBuffer.length&&(e.m_pairBuffer[e.m_pairCount]=new x);var n=e.m_pairBuffer[e.m_pairCount];return n.proxyA=t<i?t:i,n.proxyB=t>=i?t:i,++e.m_pairCount,!0}for(n=0;n<e.m_moveBuffer.length;++n){i=e.m_moveBuffer[n];var s=e.m_tree.GetFatAABB(i);e.m_tree.Query(o,s)}for(e.m_moveBuffer.length=0,n=0;n<e.m_pairCount;){var r=e.m_pairBuffer[n];for(t(e.m_tree.GetUserData(r.proxyA),e.m_tree.GetUserData(r.proxyB)),++n;n<e.m_pairCount;){var a=e.m_pairBuffer[n];if(a.proxyA!=r.proxyA||a.proxyB!=r.proxyB)break;++n}}},g.prototype.Query=function(t,e){this.m_tree.Query(t,e)},g.prototype.RayCast=function(t,e){this.m_tree.RayCast(t,e)},g.prototype.Validate=function(){},g.prototype.Rebalance=function(t){void 0===t&&(t=0),this.m_tree.Rebalance(t)},g.prototype.BufferMove=function(t){this.m_moveBuffer[this.m_moveBuffer.length]=t},g.prototype.UnBufferMove=function(t){var e=parseInt(this.m_moveBuffer.indexOf(t));this.m_moveBuffer.splice(e,1)},g.prototype.ComparePairs=function(t,e){return 0},g.__implements={},g.__implements[G]=!0,b.b2DynamicTreeNode=function(){this.aabb=new l},b.prototype.IsLeaf=function(){return null==this.child1},x.b2DynamicTreePair=function(){},w.b2Manifold=function(){this.m_pointCount=0},w.prototype.b2Manifold=function(){this.m_points=new Et(n.b2_maxManifoldPoints);for(var t=0;t<n.b2_maxManifoldPoints;t++)this.m_points[t]=new C;this.m_localPlaneNormal=new a,this.m_localPoint=new a},w.prototype.Reset=function(){for(var t=0;t<n.b2_maxManifoldPoints;t++)(this.m_points[t]instanceof C?this.m_points[t]:null).Reset();this.m_localPlaneNormal.SetZero(),this.m_localPoint.SetZero(),this.m_type=0,this.m_pointCount=0},w.prototype.Set=function(t){this.m_pointCount=t.m_pointCount;for(var e=0;e<n.b2_maxManifoldPoints;e++)(this.m_points[e]instanceof C?this.m_points[e]:null).Set(t.m_points[e]);this.m_localPlaneNormal.SetV(t.m_localPlaneNormal),this.m_localPoint.SetV(t.m_localPoint),this.m_type=t.m_type},w.prototype.Copy=function(){var t=new w;return t.Set(this),t},Pt.postDefs.push(function(){Pt.Collision.b2Manifold.e_circles=1,Pt.Collision.b2Manifold.e_faceA=2,Pt.Collision.b2Manifold.e_faceB=4}),C.b2ManifoldPoint=function(){this.m_localPoint=new a,this.m_id=new m},C.prototype.b2ManifoldPoint=function(){this.Reset()},C.prototype.Reset=function(){this.m_localPoint.SetZero(),this.m_normalImpulse=0,this.m_tangentImpulse=0,this.m_id.key=0},C.prototype.Set=function(t){this.m_localPoint.SetV(t.m_localPoint),this.m_normalImpulse=t.m_normalImpulse,this.m_tangentImpulse=t.m_tangentImpulse,this.m_id.Set(t.m_id)},S.b2Point=function(){this.p=new a},S.prototype.Support=function(t,e,i){return this.p},S.prototype.GetFirstVertex=function(t){return this.p},A.b2RayCastInput=function(){this.p1=new a,this.p2=new a},A.prototype.b2RayCastInput=function(t,e,i){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=1),t&&this.p1.SetV(t),e&&this.p2.SetV(e),this.maxFraction=i},M.b2RayCastOutput=function(){this.normal=new a},k.b2Segment=function(){this.p1=new a,this.p2=new a},k.prototype.TestSegment=function(t,e,i,n){void 0===n&&(n=0);var o=i.p1,s=i.p2.x-o.x,r=i.p2.y-o.y,a=this.p2.x-this.p1.x,l=this.p2.y-this.p1.y,c=-a,h=100*Number.MIN_VALUE,u=-(s*l+r*c);if(u>h){var m=o.x-this.p1.x,y=o.y-this.p1.y,p=m*l+y*c;if(0<=p&&p<=n*u){var d=-s*y+r*m;if(-h*u<=d&&d<=u*(1+h)){p/=u;var f=Math.sqrt(l*l+c*c);return l/=f,c/=f,t[0]=p,e.Set(l,c),!0}}}return!1},k.prototype.Extend=function(t){this.ExtendForward(t),this.ExtendBackward(t)},k.prototype.ExtendForward=function(t){var e=this.p2.x-this.p1.x,i=this.p2.y-this.p1.y,n=Math.min(e>0?(t.upperBound.x-this.p1.x)/e:e<0?(t.lowerBound.x-this.p1.x)/e:Number.POSITIVE_INFINITY,i>0?(t.upperBound.y-this.p1.y)/i:i<0?(t.lowerBound.y-this.p1.y)/i:Number.POSITIVE_INFINITY);this.p2.x=this.p1.x+e*n,this.p2.y=this.p1.y+i*n},k.prototype.ExtendBackward=function(t){var e=-this.p2.x+this.p1.x,i=-this.p2.y+this.p1.y,n=Math.min(e>0?(t.upperBound.x-this.p2.x)/e:e<0?(t.lowerBound.x-this.p2.x)/e:Number.POSITIVE_INFINITY,i>0?(t.upperBound.y-this.p2.y)/i:i<0?(t.lowerBound.y-this.p2.y)/i:Number.POSITIVE_INFINITY);this.p1.x=this.p2.x+e*n,this.p1.y=this.p2.y+i*n},D.b2SeparationFunction=function(){this.m_localPoint=new a,this.m_axis=new a},D.prototype.Initialize=function(t,e,i,s,r){this.m_proxyA=e,this.m_proxyB=s;var l,c,h,u,m,y,p=parseInt(t.count);n.b2Assert(0<p&&p<3);var d,f,_=0,v=0,g=0,b=0,x=0,w=0,C=0;if(1==p)this.m_type=D.e_points,l=this.m_proxyA.GetVertex(t.indexA[0]),u=this.m_proxyB.GetVertex(t.indexB[0]),f=l,d=i.R,_=i.position.x+(d.col1.x*f.x+d.col2.x*f.y),v=i.position.y+(d.col1.y*f.x+d.col2.y*f.y),f=u,d=r.R,g=r.position.x+(d.col1.x*f.x+d.col2.x*f.y),b=r.position.y+(d.col1.y*f.x+d.col2.y*f.y),this.m_axis.x=g-_,this.m_axis.y=b-v,this.m_axis.Normalize();else if(t.indexB[0]==t.indexB[1])this.m_type=D.e_faceA,c=this.m_proxyA.GetVertex(t.indexA[0]),h=this.m_proxyA.GetVertex(t.indexA[1]),u=this.m_proxyB.GetVertex(t.indexB[0]),this.m_localPoint.x=.5*(c.x+h.x),this.m_localPoint.y=.5*(c.y+h.y),this.m_axis=o.CrossVF(o.SubtractVV(h,c),1),this.m_axis.Normalize(),f=this.m_axis,x=(d=i.R).col1.x*f.x+d.col2.x*f.y,w=d.col1.y*f.x+d.col2.y*f.y,f=this.m_localPoint,d=i.R,_=i.position.x+(d.col1.x*f.x+d.col2.x*f.y),v=i.position.y+(d.col1.y*f.x+d.col2.y*f.y),f=u,d=r.R,(C=((g=r.position.x+(d.col1.x*f.x+d.col2.x*f.y))-_)*x+((b=r.position.y+(d.col1.y*f.x+d.col2.y*f.y))-v)*w)<0&&this.m_axis.NegativeSelf();else if(t.indexA[0]==t.indexA[0])this.m_type=D.e_faceB,m=this.m_proxyB.GetVertex(t.indexB[0]),y=this.m_proxyB.GetVertex(t.indexB[1]),l=this.m_proxyA.GetVertex(t.indexA[0]),this.m_localPoint.x=.5*(m.x+y.x),this.m_localPoint.y=.5*(m.y+y.y),this.m_axis=o.CrossVF(o.SubtractVV(y,m),1),this.m_axis.Normalize(),f=this.m_axis,x=(d=r.R).col1.x*f.x+d.col2.x*f.y,w=d.col1.y*f.x+d.col2.y*f.y,f=this.m_localPoint,d=r.R,g=r.position.x+(d.col1.x*f.x+d.col2.x*f.y),b=r.position.y+(d.col1.y*f.x+d.col2.y*f.y),f=l,d=i.R,(C=((_=i.position.x+(d.col1.x*f.x+d.col2.x*f.y))-g)*x+((v=i.position.y+(d.col1.y*f.x+d.col2.y*f.y))-b)*w)<0&&this.m_axis.NegativeSelf();else{c=this.m_proxyA.GetVertex(t.indexA[0]),h=this.m_proxyA.GetVertex(t.indexA[1]),m=this.m_proxyB.GetVertex(t.indexB[0]),y=this.m_proxyB.GetVertex(t.indexB[1]),o.MulX(i,l);var S=o.MulMV(i.R,o.SubtractVV(h,c));o.MulX(r,u);var A=o.MulMV(r.R,o.SubtractVV(y,m)),M=S.x*S.x+S.y*S.y,k=A.x*A.x+A.y*A.y,I=o.SubtractVV(A,S),B=S.x*I.x+S.y*I.y,P=A.x*I.x+A.y*I.y,V=S.x*A.x+S.y*A.y,T=M*k-V*V;C=0,0!=T&&(C=o.Clamp((V*P-B*k)/T,0,1));var E=(V*C+P)/k;E<0&&(E=0,C=o.Clamp((V-B)/M,0,1)),(l=new a).x=c.x+C*(h.x-c.x),l.y=c.y+C*(h.y-c.y),(u=new a).x=m.x+C*(y.x-m.x),u.y=m.y+C*(y.y-m.y),0==C||1==C?(this.m_type=D.e_faceB,this.m_axis=o.CrossVF(o.SubtractVV(y,m),1),this.m_axis.Normalize(),this.m_localPoint=u,f=this.m_axis,x=(d=r.R).col1.x*f.x+d.col2.x*f.y,w=d.col1.y*f.x+d.col2.y*f.y,f=this.m_localPoint,d=r.R,g=r.position.x+(d.col1.x*f.x+d.col2.x*f.y),b=r.position.y+(d.col1.y*f.x+d.col2.y*f.y),f=l,d=i.R,_=i.position.x+(d.col1.x*f.x+d.col2.x*f.y),v=i.position.y+(d.col1.y*f.x+d.col2.y*f.y),C<0&&this.m_axis.NegativeSelf()):(this.m_type=D.e_faceA,this.m_axis=o.CrossVF(o.SubtractVV(h,c),1),this.m_localPoint=l,f=this.m_axis,x=(d=i.R).col1.x*f.x+d.col2.x*f.y,w=d.col1.y*f.x+d.col2.y*f.y,f=this.m_localPoint,d=i.R,_=i.position.x+(d.col1.x*f.x+d.col2.x*f.y),v=i.position.y+(d.col1.y*f.x+d.col2.y*f.y),f=u,d=r.R,g=r.position.x+(d.col1.x*f.x+d.col2.x*f.y),b=r.position.y+(d.col1.y*f.x+d.col2.y*f.y),C<0&&this.m_axis.NegativeSelf())}},D.prototype.Evaluate=function(t,e){var i,s,r,a,l,c,h;switch(this.m_type){case D.e_points:return i=o.MulTMV(t.R,this.m_axis),s=o.MulTMV(e.R,this.m_axis.GetNegative()),r=this.m_proxyA.GetSupportVertex(i),a=this.m_proxyB.GetSupportVertex(s),l=o.MulX(t,r),((c=o.MulX(e,a)).x-l.x)*this.m_axis.x+(c.y-l.y)*this.m_axis.y;case D.e_faceA:return h=o.MulMV(t.R,this.m_axis),l=o.MulX(t,this.m_localPoint),s=o.MulTMV(e.R,h.GetNegative()),a=this.m_proxyB.GetSupportVertex(s),((c=o.MulX(e,a)).x-l.x)*h.x+(c.y-l.y)*h.y;case D.e_faceB:return h=o.MulMV(e.R,this.m_axis),c=o.MulX(e,this.m_localPoint),i=o.MulTMV(t.R,h.GetNegative()),r=this.m_proxyA.GetSupportVertex(i),((l=o.MulX(t,r)).x-c.x)*h.x+(l.y-c.y)*h.y;default:return n.b2Assert(!1),0}},Pt.postDefs.push(function(){Pt.Collision.b2SeparationFunction.e_points=1,Pt.Collision.b2SeparationFunction.e_faceA=2,Pt.Collision.b2SeparationFunction.e_faceB=4}),I.b2Simplex=function(){this.m_v1=new P,this.m_v2=new P,this.m_v3=new P,this.m_vertices=new Et(3)},I.prototype.b2Simplex=function(){this.m_vertices[0]=this.m_v1,this.m_vertices[1]=this.m_v2,this.m_vertices[2]=this.m_v3},I.prototype.ReadCache=function(t,e,i,s,r){var a,l;n.b2Assert(0<=t.count&&t.count<=3),this.m_count=t.count;for(var c=this.m_vertices,h=0;h<this.m_count;h++){var u=c[h];u.indexA=t.indexA[h],u.indexB=t.indexB[h],a=e.GetVertex(u.indexA),l=s.GetVertex(u.indexB),u.wA=o.MulX(i,a),u.wB=o.MulX(r,l),u.w=o.SubtractVV(u.wB,u.wA),u.a=0}if(this.m_count>1){var m=t.metric,y=this.GetMetric();(y<.5*m||2*m<y||y<Number.MIN_VALUE)&&(this.m_count=0)}0==this.m_count&&((u=c[0]).indexA=0,u.indexB=0,a=e.GetVertex(0),l=s.GetVertex(0),u.wA=o.MulX(i,a),u.wB=o.MulX(r,l),u.w=o.SubtractVV(u.wB,u.wA),this.m_count=1)},I.prototype.WriteCache=function(t){t.metric=this.GetMetric(),t.count=Pt.parseUInt(this.m_count);for(var e=this.m_vertices,i=0;i<this.m_count;i++)t.indexA[i]=Pt.parseUInt(e[i].indexA),t.indexB[i]=Pt.parseUInt(e[i].indexB)},I.prototype.GetSearchDirection=function(){switch(this.m_count){case 1:return this.m_v1.w.GetNegative();case 2:var t=o.SubtractVV(this.m_v2.w,this.m_v1.w);return o.CrossVV(t,this.m_v1.w.GetNegative())>0?o.CrossFV(1,t):o.CrossVF(t,1);default:return n.b2Assert(!1),new a}},I.prototype.GetClosestPoint=function(){switch(this.m_count){case 0:default:return n.b2Assert(!1),new a;case 1:return this.m_v1.w;case 2:return new a(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y)}},I.prototype.GetWitnessPoints=function(t,e){switch(this.m_count){case 0:default:n.b2Assert(!1);break;case 1:t.SetV(this.m_v1.wA),e.SetV(this.m_v1.wB);break;case 2:t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x,t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y,e.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x,e.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:e.x=t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x,e.y=t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y}},I.prototype.GetMetric=function(){switch(this.m_count){case 0:default:return n.b2Assert(!1),0;case 1:return 0;case 2:return o.SubtractVV(this.m_v1.w,this.m_v2.w).Length();case 3:return o.CrossVV(o.SubtractVV(this.m_v2.w,this.m_v1.w),o.SubtractVV(this.m_v3.w,this.m_v1.w))}},I.prototype.Solve2=function(){var t=this.m_v1.w,e=this.m_v2.w,i=o.SubtractVV(e,t),n=-(t.x*i.x+t.y*i.y);if(n<=0)return this.m_v1.a=1,void(this.m_count=1);var s=e.x*i.x+e.y*i.y;if(s<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Set(this.m_v2);var r=1/(s+n);this.m_v1.a=s*r,this.m_v2.a=n*r,this.m_count=2},I.prototype.Solve3=function(){var t=this.m_v1.w,e=this.m_v2.w,i=this.m_v3.w,n=o.SubtractVV(e,t),s=o.Dot(t,n),r=o.Dot(e,n),a=-s,l=o.SubtractVV(i,t),c=o.Dot(t,l),h=o.Dot(i,l),u=-c,m=o.SubtractVV(i,e),y=o.Dot(e,m),p=o.Dot(i,m),d=-y,f=o.CrossVV(n,l),_=f*o.CrossVV(e,i),v=f*o.CrossVV(i,t),g=f*o.CrossVV(t,e);if(a<=0&&u<=0)return this.m_v1.a=1,void(this.m_count=1);if(r>0&&a>0&&g<=0){var b=1/(r+a);return this.m_v1.a=r*b,this.m_v2.a=a*b,void(this.m_count=2)}if(h>0&&u>0&&v<=0){var x=1/(h+u);return this.m_v1.a=h*x,this.m_v3.a=u*x,this.m_count=2,void this.m_v2.Set(this.m_v3)}if(r<=0&&d<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Set(this.m_v2);if(h<=0&&p<=0)return this.m_v3.a=1,this.m_count=1,void this.m_v1.Set(this.m_v3);if(p>0&&d>0&&_<=0){var w=1/(p+d);return this.m_v2.a=p*w,this.m_v3.a=d*w,this.m_count=2,void this.m_v1.Set(this.m_v3)}var C=1/(_+v+g);this.m_v1.a=_*C,this.m_v2.a=v*C,this.m_v3.a=g*C,this.m_count=3},B.b2SimplexCache=function(){this.indexA=new Lt(3),this.indexB=new Lt(3)},P.b2SimplexVertex=function(){},P.prototype.Set=function(t){this.wA.SetV(t.wA),this.wB.SetV(t.wB),this.w.SetV(t.w),this.a=t.a,this.indexA=t.indexA,this.indexB=t.indexB},V.b2TimeOfImpact=function(){},V.TimeOfImpact=function(t){++V.b2_toiCalls;var e=t.proxyA,i=t.proxyB,s=t.sweepA,r=t.sweepB;n.b2Assert(s.t0==r.t0),n.b2Assert(1-s.t0>Number.MIN_VALUE);var a=e.m_radius+i.m_radius,l=t.tolerance,c=0,h=0,u=0;for(V.s_cache.count=0,V.s_distanceInput.useRadii=!1;;){if(s.GetTransform(V.s_xfA,c),r.GetTransform(V.s_xfB,c),V.s_distanceInput.proxyA=e,V.s_distanceInput.proxyB=i,V.s_distanceInput.transformA=V.s_xfA,V.s_distanceInput.transformB=V.s_xfB,p.Distance(V.s_distanceOutput,V.s_cache,V.s_distanceInput),V.s_distanceOutput.distance<=0){c=1;break}V.s_fcn.Initialize(V.s_cache,e,V.s_xfA,i,V.s_xfB);var m=V.s_fcn.Evaluate(V.s_xfA,V.s_xfB);if(m<=0){c=1;break}if(0==h&&(u=m>a?o.Max(a-l,.75*a):o.Max(m-l,.02*a)),m-u<.5*l){if(0==h){c=1;break}break}var y=c,d=c,f=1,_=m;s.GetTransform(V.s_xfA,f),r.GetTransform(V.s_xfB,f);var v=V.s_fcn.Evaluate(V.s_xfA,V.s_xfB);if(v>=u){c=1;break}for(var g=0;;){var b;b=1&g?d+(u-_)*(f-d)/(v-_):.5*(d+f),s.GetTransform(V.s_xfA,b),r.GetTransform(V.s_xfB,b);var x=V.s_fcn.Evaluate(V.s_xfA,V.s_xfB);if(o.Abs(x-u)<.025*l){y=b;break}if(x>u?(d=b,_=x):(f=b,v=x),++g,++V.b2_toiRootIters,50==g)break}if(V.b2_toiMaxRootIters=o.Max(V.b2_toiMaxRootIters,g),y<(1+100*Number.MIN_VALUE)*c)break;if(c=y,h++,++V.b2_toiIters,1e3==h)break}return V.b2_toiMaxIters=o.Max(V.b2_toiMaxIters,h),c},Pt.postDefs.push(function(){Pt.Collision.b2TimeOfImpact.b2_toiCalls=0,Pt.Collision.b2TimeOfImpact.b2_toiIters=0,Pt.Collision.b2TimeOfImpact.b2_toiMaxIters=0,Pt.Collision.b2TimeOfImpact.b2_toiRootIters=0,Pt.Collision.b2TimeOfImpact.b2_toiMaxRootIters=0,Pt.Collision.b2TimeOfImpact.s_cache=new B,Pt.Collision.b2TimeOfImpact.s_distanceInput=new d,Pt.Collision.b2TimeOfImpact.s_xfA=new r,Pt.Collision.b2TimeOfImpact.s_xfB=new r,Pt.Collision.b2TimeOfImpact.s_fcn=new D,Pt.Collision.b2TimeOfImpact.s_distanceOutput=new f}),T.b2TOIInput=function(){this.proxyA=new _,this.proxyB=new _,this.sweepA=new s,this.sweepB=new s},E.b2WorldManifold=function(){this.m_normal=new a},E.prototype.b2WorldManifold=function(){this.m_points=new Et(n.b2_maxManifoldPoints);for(var t=0;t<n.b2_maxManifoldPoints;t++)this.m_points[t]=new a},E.prototype.Initialize=function(t,e,i,n,o){if(void 0===i&&(i=0),void 0===o&&(o=0),0!=t.m_pointCount){var s,r,a=0,l=0,c=0,h=0,u=0,m=0,y=0;switch(t.m_type){case w.e_circles:r=e.R,s=t.m_localPoint;var p=e.position.x+r.col1.x*s.x+r.col2.x*s.y,d=e.position.y+r.col1.y*s.x+r.col2.y*s.y;r=n.R,s=t.m_points[0].m_localPoint;var f=n.position.x+r.col1.x*s.x+r.col2.x*s.y,_=n.position.y+r.col1.y*s.x+r.col2.y*s.y,v=f-p,g=_-d,b=v*v+g*g;if(b>Number.MIN_VALUE*Number.MIN_VALUE){var x=Math.sqrt(b);this.m_normal.x=v/x,this.m_normal.y=g/x}else this.m_normal.x=1,this.m_normal.y=0;var C=p+i*this.m_normal.x,S=d+i*this.m_normal.y,A=f-o*this.m_normal.x,M=_-o*this.m_normal.y;this.m_points[0].x=.5*(C+A),this.m_points[0].y=.5*(S+M);break;case w.e_faceA:for(r=e.R,s=t.m_localPlaneNormal,l=r.col1.x*s.x+r.col2.x*s.y,c=r.col1.y*s.x+r.col2.y*s.y,r=e.R,s=t.m_localPoint,h=e.position.x+r.col1.x*s.x+r.col2.x*s.y,u=e.position.y+r.col1.y*s.x+r.col2.y*s.y,this.m_normal.x=l,this.m_normal.y=c,a=0;a<t.m_pointCount;a++)r=n.R,s=t.m_points[a].m_localPoint,m=n.position.x+r.col1.x*s.x+r.col2.x*s.y,y=n.position.y+r.col1.y*s.x+r.col2.y*s.y,this.m_points[a].x=m+.5*(i-(m-h)*l-(y-u)*c-o)*l,this.m_points[a].y=y+.5*(i-(m-h)*l-(y-u)*c-o)*c;break;case w.e_faceB:for(r=n.R,s=t.m_localPlaneNormal,l=r.col1.x*s.x+r.col2.x*s.y,c=r.col1.y*s.x+r.col2.y*s.y,r=n.R,s=t.m_localPoint,h=n.position.x+r.col1.x*s.x+r.col2.x*s.y,u=n.position.y+r.col1.y*s.x+r.col2.y*s.y,this.m_normal.x=-l,this.m_normal.y=-c,a=0;a<t.m_pointCount;a++)r=e.R,s=t.m_points[a].m_localPoint,m=e.position.x+r.col1.x*s.x+r.col2.x*s.y,y=e.position.y+r.col1.y*s.x+r.col2.y*s.y,this.m_points[a].x=m+.5*(o-(m-h)*l-(y-u)*c-i)*l,this.m_points[a].y=y+.5*(o-(m-h)*l-(y-u)*c-i)*c}}},L.ClipVertex=function(){this.v=new a,this.id=new m},L.prototype.Set=function(t){this.v.SetV(t.v),this.id.Set(t.id)},F.Features=function(){},Object.defineProperty(F.prototype,"referenceEdge",{enumerable:!1,configurable:!0,get:function(){return this._referenceEdge}}),Object.defineProperty(F.prototype,"referenceEdge",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._referenceEdge=t,this._m_id._key=4294967040&this._m_id._key|255&this._referenceEdge}}),Object.defineProperty(F.prototype,"incidentEdge",{enumerable:!1,configurable:!0,get:function(){return this._incidentEdge}}),Object.defineProperty(F.prototype,"incidentEdge",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._incidentEdge=t,this._m_id._key=4294902015&this._m_id._key|this._incidentEdge<<8&65280}}),Object.defineProperty(F.prototype,"incidentVertex",{enumerable:!1,configurable:!0,get:function(){return this._incidentVertex}}),Object.defineProperty(F.prototype,"incidentVertex",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._incidentVertex=t,this._m_id._key=4278255615&this._m_id._key|this._incidentVertex<<16&16711680}}),Object.defineProperty(F.prototype,"flip",{enumerable:!1,configurable:!0,get:function(){return this._flip}}),Object.defineProperty(F.prototype,"flip",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._flip=t,this._m_id._key=16777215&this._m_id._key|this._flip<<24&4278190080}})}(),function(){Pt.Common.b2Color,Pt.Common.b2internal;var t=Pt.Common.b2Settings,e=Pt.Collision.Shapes.b2CircleShape,i=Pt.Collision.Shapes.b2EdgeChainDef,n=Pt.Collision.Shapes.b2EdgeShape,o=Pt.Collision.Shapes.b2MassData,s=Pt.Collision.Shapes.b2PolygonShape,r=Pt.Collision.Shapes.b2Shape,a=Pt.Common.Math.b2Mat22;Pt.Common.Math.b2Mat33;var l=Pt.Common.Math.b2Math;Pt.Common.Math.b2Sweep;var c=Pt.Common.Math.b2Transform,h=Pt.Common.Math.b2Vec2;Pt.Common.Math.b2Vec3,Pt.Dynamics.b2Body,Pt.Dynamics.b2BodyDef,Pt.Dynamics.b2ContactFilter,Pt.Dynamics.b2ContactImpulse,Pt.Dynamics.b2ContactListener,Pt.Dynamics.b2ContactManager,Pt.Dynamics.b2DebugDraw,Pt.Dynamics.b2DestructionListener,Pt.Dynamics.b2FilterData,Pt.Dynamics.b2Fixture,Pt.Dynamics.b2FixtureDef,Pt.Dynamics.b2Island,Pt.Dynamics.b2TimeStep,Pt.Dynamics.b2World,Pt.Collision.b2AABB,Pt.Collision.b2Bound,Pt.Collision.b2BoundValues,Pt.Collision.b2Collision,Pt.Collision.b2ContactID,Pt.Collision.b2ContactPoint;var u=Pt.Collision.b2Distance,m=Pt.Collision.b2DistanceInput,y=Pt.Collision.b2DistanceOutput,p=Pt.Collision.b2DistanceProxy;Pt.Collision.b2DynamicTree,Pt.Collision.b2DynamicTreeBroadPhase,Pt.Collision.b2DynamicTreeNode,Pt.Collision.b2DynamicTreePair,Pt.Collision.b2Manifold,Pt.Collision.b2ManifoldPoint,Pt.Collision.b2Point,Pt.Collision.b2RayCastInput,Pt.Collision.b2RayCastOutput,Pt.Collision.b2Segment,Pt.Collision.b2SeparationFunction,Pt.Collision.b2Simplex;var d=Pt.Collision.b2SimplexCache;Pt.Collision.b2SimplexVertex,Pt.Collision.b2TimeOfImpact,Pt.Collision.b2TOIInput,Pt.Collision.b2WorldManifold,Pt.Collision.ClipVertex,Pt.Collision.Features,Pt.Collision.IBroadPhase,Pt.inherit(e,Pt.Collision.Shapes.b2Shape),e.prototype.__super=Pt.Collision.Shapes.b2Shape.prototype,e.b2CircleShape=function(){Pt.Collision.Shapes.b2Shape.b2Shape.apply(this,arguments),this.m_p=new h},e.prototype.Copy=function(){var t=new e;return t.Set(this),t},e.prototype.Set=function(t){if(this.__super.Set.call(this,t),Pt.is(t,e)){var i=t instanceof e?t:null;this.m_p.SetV(i.m_p)}},e.prototype.TestPoint=function(t,e){var i=t.R,n=t.position.x+(i.col1.x*this.m_p.x+i.col2.x*this.m_p.y),o=t.position.y+(i.col1.y*this.m_p.x+i.col2.y*this.m_p.y);return(n=e.x-n)*n+(o=e.y-o)*o<=this.m_radius*this.m_radius},e.prototype.RayCast=function(t,e,i){var n=i.R,o=i.position.x+(n.col1.x*this.m_p.x+n.col2.x*this.m_p.y),s=i.position.y+(n.col1.y*this.m_p.x+n.col2.y*this.m_p.y),r=e.p1.x-o,a=e.p1.y-s,l=r*r+a*a-this.m_radius*this.m_radius,c=e.p2.x-e.p1.x,h=e.p2.y-e.p1.y,u=r*c+a*h,m=c*c+h*h,y=u*u-m*l;if(y<0||m<Number.MIN_VALUE)return!1;var p=-(u+Math.sqrt(y));return 0<=p&&p<=e.maxFraction*m&&(p/=m,t.fraction=p,t.normal.x=r+p*c,t.normal.y=a+p*h,t.normal.Normalize(),!0)},e.prototype.ComputeAABB=function(t,e){var i=e.R,n=e.position.x+(i.col1.x*this.m_p.x+i.col2.x*this.m_p.y),o=e.position.y+(i.col1.y*this.m_p.x+i.col2.y*this.m_p.y);t.lowerBound.Set(n-this.m_radius,o-this.m_radius),t.upperBound.Set(n+this.m_radius,o+this.m_radius)},e.prototype.ComputeMass=function(e,i){void 0===i&&(i=0),e.mass=i*t.b2_pi*this.m_radius*this.m_radius,e.center.SetV(this.m_p),e.I=e.mass*(.5*this.m_radius*this.m_radius+(this.m_p.x*this.m_p.x+this.m_p.y*this.m_p.y))},e.prototype.ComputeSubmergedArea=function(t,e,i,n){void 0===e&&(e=0);var o=l.MulX(i,this.m_p),s=-(l.Dot(t,o)-e);if(s<-this.m_radius+Number.MIN_VALUE)return 0;if(s>this.m_radius)return n.SetV(o),Math.PI*this.m_radius*this.m_radius;var r=this.m_radius*this.m_radius,a=s*s,c=r*(Math.asin(s/this.m_radius)+Math.PI/2)+s*Math.sqrt(r-a),h=-2/3*Math.pow(r-a,1.5)/c;return n.x=o.x+t.x*h,n.y=o.y+t.y*h,c},e.prototype.GetLocalPosition=function(){return this.m_p},e.prototype.SetLocalPosition=function(t){this.m_p.SetV(t)},e.prototype.GetRadius=function(){return this.m_radius},e.prototype.SetRadius=function(t){void 0===t&&(t=0),this.m_radius=t},e.prototype.b2CircleShape=function(t){void 0===t&&(t=0),this.__super.b2Shape.call(this),this.m_type=r.e_circleShape,this.m_radius=t},i.b2EdgeChainDef=function(){},i.prototype.b2EdgeChainDef=function(){this.vertexCount=0,this.isALoop=!0,this.vertices=[]},Pt.inherit(n,Pt.Collision.Shapes.b2Shape),n.prototype.__super=Pt.Collision.Shapes.b2Shape.prototype,n.b2EdgeShape=function(){Pt.Collision.Shapes.b2Shape.b2Shape.apply(this,arguments),this.s_supportVec=new h,this.m_v1=new h,this.m_v2=new h,this.m_coreV1=new h,this.m_coreV2=new h,this.m_normal=new h,this.m_direction=new h,this.m_cornerDir1=new h,this.m_cornerDir2=new h},n.prototype.TestPoint=function(t,e){return!1},n.prototype.RayCast=function(t,e,i){var n,o=e.p2.x-e.p1.x,s=e.p2.y-e.p1.y;n=i.R;var r=i.position.x+(n.col1.x*this.m_v1.x+n.col2.x*this.m_v1.y),a=i.position.y+(n.col1.y*this.m_v1.x+n.col2.y*this.m_v1.y),l=i.position.y+(n.col1.y*this.m_v2.x+n.col2.y*this.m_v2.y)-a,c=-(i.position.x+(n.col1.x*this.m_v2.x+n.col2.x*this.m_v2.y)-r),h=100*Number.MIN_VALUE,u=-(o*l+s*c);if(u>h){var m=e.p1.x-r,y=e.p1.y-a,p=m*l+y*c;if(0<=p&&p<=e.maxFraction*u){var d=-o*y+s*m;if(-h*u<=d&&d<=u*(1+h)){p/=u,t.fraction=p;var f=Math.sqrt(l*l+c*c);return t.normal.x=l/f,t.normal.y=c/f,!0}}}return!1},n.prototype.ComputeAABB=function(t,e){var i=e.R,n=e.position.x+(i.col1.x*this.m_v1.x+i.col2.x*this.m_v1.y),o=e.position.y+(i.col1.y*this.m_v1.x+i.col2.y*this.m_v1.y),s=e.position.x+(i.col1.x*this.m_v2.x+i.col2.x*this.m_v2.y),r=e.position.y+(i.col1.y*this.m_v2.x+i.col2.y*this.m_v2.y);n<s?(t.lowerBound.x=n,t.upperBound.x=s):(t.lowerBound.x=s,t.upperBound.x=n),o<r?(t.lowerBound.y=o,t.upperBound.y=r):(t.lowerBound.y=r,t.upperBound.y=o)},n.prototype.ComputeMass=function(t,e){t.mass=0,t.center.SetV(this.m_v1),t.I=0},n.prototype.ComputeSubmergedArea=function(t,e,i,n){void 0===e&&(e=0);var o=new h(t.x*e,t.y*e),s=l.MulX(i,this.m_v1),r=l.MulX(i,this.m_v2),a=l.Dot(t,s)-e,c=l.Dot(t,r)-e;if(a>0){if(c>0)return 0;s.x=-c/(a-c)*s.x+a/(a-c)*r.x,s.y=-c/(a-c)*s.y+a/(a-c)*r.y}else c>0&&(r.x=-c/(a-c)*s.x+a/(a-c)*r.x,r.y=-c/(a-c)*s.y+a/(a-c)*r.y);return n.x=(o.x+s.x+r.x)/3,n.y=(o.y+s.y+r.y)/3,.5*((s.x-o.x)*(r.y-o.y)-(s.y-o.y)*(r.x-o.x))},n.prototype.GetLength=function(){return this.m_length},n.prototype.GetVertex1=function(){return this.m_v1},n.prototype.GetVertex2=function(){return this.m_v2},n.prototype.GetCoreVertex1=function(){return this.m_coreV1},n.prototype.GetCoreVertex2=function(){return this.m_coreV2},n.prototype.GetNormalVector=function(){return this.m_normal},n.prototype.GetDirectionVector=function(){return this.m_direction},n.prototype.GetCorner1Vector=function(){return this.m_cornerDir1},n.prototype.GetCorner2Vector=function(){return this.m_cornerDir2},n.prototype.Corner1IsConvex=function(){return this.m_cornerConvex1},n.prototype.Corner2IsConvex=function(){return this.m_cornerConvex2},n.prototype.GetFirstVertex=function(t){var e=t.R;return new h(t.position.x+(e.col1.x*this.m_coreV1.x+e.col2.x*this.m_coreV1.y),t.position.y+(e.col1.y*this.m_coreV1.x+e.col2.y*this.m_coreV1.y))},n.prototype.GetNextEdge=function(){return this.m_nextEdge},n.prototype.GetPrevEdge=function(){return this.m_prevEdge},n.prototype.Support=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0);var n=t.R,o=t.position.x+(n.col1.x*this.m_coreV1.x+n.col2.x*this.m_coreV1.y),s=t.position.y+(n.col1.y*this.m_coreV1.x+n.col2.y*this.m_coreV1.y),r=t.position.x+(n.col1.x*this.m_coreV2.x+n.col2.x*this.m_coreV2.y),a=t.position.y+(n.col1.y*this.m_coreV2.x+n.col2.y*this.m_coreV2.y);return o*e+s*i>r*e+a*i?(this.s_supportVec.x=o,this.s_supportVec.y=s):(this.s_supportVec.x=r,this.s_supportVec.y=a),this.s_supportVec},n.prototype.b2EdgeShape=function(e,i){this.__super.b2Shape.call(this),this.m_type=r.e_edgeShape,this.m_prevEdge=null,this.m_nextEdge=null,this.m_v1=e,this.m_v2=i,this.m_direction.Set(this.m_v2.x-this.m_v1.x,this.m_v2.y-this.m_v1.y),this.m_length=this.m_direction.Normalize(),this.m_normal.Set(this.m_direction.y,-this.m_direction.x),this.m_coreV1.Set(-t.b2_toiSlop*(this.m_normal.x-this.m_direction.x)+this.m_v1.x,-t.b2_toiSlop*(this.m_normal.y-this.m_direction.y)+this.m_v1.y),this.m_coreV2.Set(-t.b2_toiSlop*(this.m_normal.x+this.m_direction.x)+this.m_v2.x,-t.b2_toiSlop*(this.m_normal.y+this.m_direction.y)+this.m_v2.y),this.m_cornerDir1=this.m_normal,this.m_cornerDir2.Set(-this.m_normal.x,-this.m_normal.y)},n.prototype.SetPrevEdge=function(t,e,i,n){this.m_prevEdge=t,this.m_coreV1=e,this.m_cornerDir1=i,this.m_cornerConvex1=n},n.prototype.SetNextEdge=function(t,e,i,n){this.m_nextEdge=t,this.m_coreV2=e,this.m_cornerDir2=i,this.m_cornerConvex2=n},o.b2MassData=function(){this.mass=0,this.center=new h(0,0),this.I=0},Pt.inherit(s,Pt.Collision.Shapes.b2Shape),s.prototype.__super=Pt.Collision.Shapes.b2Shape.prototype,s.b2PolygonShape=function(){Pt.Collision.Shapes.b2Shape.b2Shape.apply(this,arguments)},s.prototype.Copy=function(){var t=new s;return t.Set(this),t},s.prototype.Set=function(t){if(this.__super.Set.call(this,t),Pt.is(t,s)){var e=t instanceof s?t:null;this.m_centroid.SetV(e.m_centroid),this.m_vertexCount=e.m_vertexCount,this.Reserve(this.m_vertexCount);for(var i=0;i<this.m_vertexCount;i++)this.m_vertices[i].SetV(e.m_vertices[i]),this.m_normals[i].SetV(e.m_normals[i])}},s.prototype.SetAsArray=function(t,e){void 0===e&&(e=0);var i,n=new Et,o=0;for(o=0;o<t.length;++o)i=t[o],n.push(i);this.SetAsVector(n,e)},s.AsArray=function(t,e){void 0===e&&(e=0);var i=new s;return i.SetAsArray(t,e),i},s.prototype.SetAsVector=function(e,i){void 0===i&&(i=0),0==i&&(i=e.length),t.b2Assert(2<=i),this.m_vertexCount=i,this.Reserve(i);var n=0;for(n=0;n<this.m_vertexCount;n++)this.m_vertices[n].SetV(e[n]);for(n=0;n<this.m_vertexCount;++n){var o=parseInt(n),r=parseInt(n+1<this.m_vertexCount?n+1:0),a=l.SubtractVV(this.m_vertices[r],this.m_vertices[o]);t.b2Assert(a.LengthSquared()>Number.MIN_VALUE),this.m_normals[n].SetV(l.CrossVF(a,1)),this.m_normals[n].Normalize()}this.m_centroid=s.ComputeCentroid(this.m_vertices,this.m_vertexCount)},s.AsVector=function(t,e){void 0===e&&(e=0);var i=new s;return i.SetAsVector(t,e),i},s.prototype.SetAsBox=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.m_vertexCount=4,this.Reserve(4),this.m_vertices[0].Set(-t,-e),this.m_vertices[1].Set(t,-e),this.m_vertices[2].Set(t,e),this.m_vertices[3].Set(-t,e),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid.SetZero()},s.AsBox=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0);var i=new s;return i.SetAsBox(t,e),i},s.prototype.SetAsOrientedBox=function(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=null),void 0===n&&(n=0),this.m_vertexCount=4,this.Reserve(4),this.m_vertices[0].Set(-t,-e),this.m_vertices[1].Set(t,-e),this.m_vertices[2].Set(t,e),this.m_vertices[3].Set(-t,e),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid=i;var o=new c;o.position=i,o.R.Set(n);for(var s=0;s<this.m_vertexCount;++s)this.m_vertices[s]=l.MulX(o,this.m_vertices[s]),this.m_normals[s]=l.MulMV(o.R,this.m_normals[s])},s.AsOrientedBox=function(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=null),void 0===n&&(n=0);var o=new s;return o.SetAsOrientedBox(t,e,i,n),o},s.prototype.SetAsEdge=function(t,e){this.m_vertexCount=2,this.Reserve(2),this.m_vertices[0].SetV(t),this.m_vertices[1].SetV(e),this.m_centroid.x=.5*(t.x+e.x),this.m_centroid.y=.5*(t.y+e.y),this.m_normals[0]=l.CrossVF(l.SubtractVV(e,t),1),this.m_normals[0].Normalize(),this.m_normals[1].x=-this.m_normals[0].x,this.m_normals[1].y=-this.m_normals[0].y},s.AsEdge=function(t,e){var i=new s;return i.SetAsEdge(t,e),i},s.prototype.TestPoint=function(t,e){for(var i,n=t.R,o=e.x-t.position.x,s=e.y-t.position.y,r=o*n.col1.x+s*n.col1.y,a=o*n.col2.x+s*n.col2.y,l=0;l<this.m_vertexCount;++l)if(o=r-(i=this.m_vertices[l]).x,s=a-i.y,(i=this.m_normals[l]).x*o+i.y*s>0)return!1;return!0},s.prototype.RayCast=function(t,e,i){var n,o,s=0,r=e.maxFraction,a=0,l=0;a=e.p1.x-i.position.x,l=e.p1.y-i.position.y;var c=a*(n=i.R).col1.x+l*n.col1.y,h=a*n.col2.x+l*n.col2.y;a=e.p2.x-i.position.x,l=e.p2.y-i.position.y;for(var u=a*(n=i.R).col1.x+l*n.col1.y-c,m=a*n.col2.x+l*n.col2.y-h,y=parseInt(-1),p=0;p<this.m_vertexCount;++p){a=(o=this.m_vertices[p]).x-c,l=o.y-h;var d=(o=this.m_normals[p]).x*a+o.y*l,f=o.x*u+o.y*m;if(0==f){if(d<0)return!1}else f<0&&d<s*f?(s=d/f,y=p):f>0&&d<r*f&&(r=d/f);if(r<s-Number.MIN_VALUE)return!1}return y>=0&&(t.fraction=s,n=i.R,o=this.m_normals[y],t.normal.x=n.col1.x*o.x+n.col2.x*o.y,t.normal.y=n.col1.y*o.x+n.col2.y*o.y,!0)},s.prototype.ComputeAABB=function(t,e){for(var i=e.R,n=this.m_vertices[0],o=e.position.x+(i.col1.x*n.x+i.col2.x*n.y),s=e.position.y+(i.col1.y*n.x+i.col2.y*n.y),r=o,a=s,l=1;l<this.m_vertexCount;++l){n=this.m_vertices[l];var c=e.position.x+(i.col1.x*n.x+i.col2.x*n.y),h=e.position.y+(i.col1.y*n.x+i.col2.y*n.y);o=o<c?o:c,s=s<h?s:h,r=r>c?r:c,a=a>h?a:h}t.lowerBound.x=o-this.m_radius,t.lowerBound.y=s-this.m_radius,t.upperBound.x=r+this.m_radius,t.upperBound.y=a+this.m_radius},s.prototype.ComputeMass=function(t,e){if(void 0===e&&(e=0),2==this.m_vertexCount)return t.center.x=.5*(this.m_vertices[0].x+this.m_vertices[1].x),t.center.y=.5*(this.m_vertices[0].y+this.m_vertices[1].y),t.mass=0,void(t.I=0);for(var i=0,n=0,o=0,s=0,r=1/3,a=0;a<this.m_vertexCount;++a){var l=this.m_vertices[a],c=a+1<this.m_vertexCount?this.m_vertices[parseInt(a+1)]:this.m_vertices[0],h=l.x-0,u=l.y-0,m=c.x-0,y=c.y-0,p=h*y-u*m,d=.5*p;o+=d,i+=d*r*(0+l.x+c.x),n+=d*r*(0+l.y+c.y),s+=p*(r*(.25*(h*h+m*h+m*m)+(0*h+0*m))+0+(r*(.25*(u*u+y*u+y*y)+(0*u+0*y))+0))}t.mass=e*o,i*=1/o,n*=1/o,t.center.Set(i,n),t.I=e*s},s.prototype.ComputeSubmergedArea=function(t,e,i,n){void 0===e&&(e=0);var s=l.MulTMV(i.R,t),r=e-l.Dot(t,i.position),a=new Lt,c=0,u=parseInt(-1),m=parseInt(-1),y=!1,p=0;for(p=0;p<this.m_vertexCount;++p){a[p]=l.Dot(s,this.m_vertices[p])-r;var d=a[p]<-Number.MIN_VALUE;p>0&&(d?y||(u=p-1,c++):y&&(m=p-1,c++)),y=d}switch(c){case 0:if(y){var f=new o;return this.ComputeMass(f,1),n.SetV(l.MulX(i,f.center)),f.mass}return 0;case 1:-1==u?u=this.m_vertexCount-1:m=this.m_vertexCount-1}var _,v=parseInt((u+1)%this.m_vertexCount),g=parseInt((m+1)%this.m_vertexCount),b=(0-a[u])/(a[v]-a[u]),x=(0-a[m])/(a[g]-a[m]),w=new h(this.m_vertices[u].x*(1-b)+this.m_vertices[v].x*b,this.m_vertices[u].y*(1-b)+this.m_vertices[v].y*b),C=new h(this.m_vertices[m].x*(1-x)+this.m_vertices[g].x*x,this.m_vertices[m].y*(1-x)+this.m_vertices[g].y*x),S=0,A=new h,M=this.m_vertices[v];for(p=v;p!=g;){_=(p=(p+1)%this.m_vertexCount)==g?C:this.m_vertices[p];var k=.5*((M.x-w.x)*(_.y-w.y)-(M.y-w.y)*(_.x-w.x));S+=k,A.x+=k*(w.x+M.x+_.x)/3,A.y+=k*(w.y+M.y+_.y)/3,M=_}return A.Multiply(1/S),n.SetV(l.MulX(i,A)),S},s.prototype.GetVertexCount=function(){return this.m_vertexCount},s.prototype.GetVertices=function(){return this.m_vertices},s.prototype.GetNormals=function(){return this.m_normals},s.prototype.GetSupport=function(t){for(var e=0,i=this.m_vertices[0].x*t.x+this.m_vertices[0].y*t.y,n=1;n<this.m_vertexCount;++n){var o=this.m_vertices[n].x*t.x+this.m_vertices[n].y*t.y;o>i&&(e=n,i=o)}return e},s.prototype.GetSupportVertex=function(t){for(var e=0,i=this.m_vertices[0].x*t.x+this.m_vertices[0].y*t.y,n=1;n<this.m_vertexCount;++n){var o=this.m_vertices[n].x*t.x+this.m_vertices[n].y*t.y;o>i&&(e=n,i=o)}return this.m_vertices[e]},s.prototype.Validate=function(){return!1},s.prototype.b2PolygonShape=function(){this.__super.b2Shape.call(this),this.m_type=r.e_polygonShape,this.m_centroid=new h,this.m_vertices=new Et,this.m_normals=new Et},s.prototype.Reserve=function(t){void 0===t&&(t=0);for(var e=parseInt(this.m_vertices.length);e<t;e++)this.m_vertices[e]=new h,this.m_normals[e]=new h},s.ComputeCentroid=function(t,e){void 0===e&&(e=0);for(var i=new h,n=0,o=1/3,s=0;s<e;++s){var r=t[s],a=s+1<e?t[parseInt(s+1)]:t[0],l=r.x-0,c=r.y-0,u=a.x-0,m=.5*(l*(a.y-0)-c*u);n+=m,i.x+=m*o*(0+r.x+a.x),i.y+=m*o*(0+r.y+a.y)}return i.x*=1/n,i.y*=1/n,i},s.ComputeOBB=function(t,e,i){void 0===i&&(i=0);var n=0,o=new Et(i+1);for(n=0;n<i;++n)o[n]=e[n];o[i]=o[0];var s=Number.MAX_VALUE;for(n=1;n<=i;++n){for(var r=o[parseInt(n-1)],a=o[n].x-r.x,l=o[n].y-r.y,c=Math.sqrt(a*a+l*l),h=-(l/=c),u=a/=c,m=Number.MAX_VALUE,y=Number.MAX_VALUE,p=-Number.MAX_VALUE,d=-Number.MAX_VALUE,f=0;f<i;++f){var _=o[f].x-r.x,v=o[f].y-r.y,g=a*_+l*v,b=h*_+u*v;g<m&&(m=g),b<y&&(y=b),g>p&&(p=g),b>d&&(d=b)}var x=(p-m)*(d-y);if(x<.95*s){s=x,t.R.col1.x=a,t.R.col1.y=l,t.R.col2.x=h,t.R.col2.y=u;var w=.5*(m+p),C=.5*(y+d),S=t.R;t.center.x=r.x+(S.col1.x*w+S.col2.x*C),t.center.y=r.y+(S.col1.y*w+S.col2.y*C),t.extents.x=.5*(p-m),t.extents.y=.5*(d-y)}}},Pt.postDefs.push(function(){Pt.Collision.Shapes.b2PolygonShape.s_mat=new a}),r.b2Shape=function(){},r.prototype.Copy=function(){return null},r.prototype.Set=function(t){this.m_radius=t.m_radius},r.prototype.GetType=function(){return this.m_type},r.prototype.TestPoint=function(t,e){return!1},r.prototype.RayCast=function(t,e,i){return!1},r.prototype.ComputeAABB=function(t,e){},r.prototype.ComputeMass=function(t,e){},r.prototype.ComputeSubmergedArea=function(t,e,i,n){return 0},r.TestOverlap=function(t,e,i,n){var o=new m;o.proxyA=new p,o.proxyA.Set(t),o.proxyB=new p,o.proxyB.Set(i),o.transformA=e,o.transformB=n,o.useRadii=!0;var s=new d;s.count=0;var r=new y;return u.Distance(r,s,o),r.distance<10*Number.MIN_VALUE},r.prototype.b2Shape=function(){this.m_type=r.e_unknownShape,this.m_radius=t.b2_linearSlop},Pt.postDefs.push(function(){Pt.Collision.Shapes.b2Shape.e_unknownShape=parseInt(-1),Pt.Collision.Shapes.b2Shape.e_circleShape=0,Pt.Collision.Shapes.b2Shape.e_polygonShape=1,Pt.Collision.Shapes.b2Shape.e_edgeShape=2,Pt.Collision.Shapes.b2Shape.e_shapeTypeCount=3,Pt.Collision.Shapes.b2Shape.e_hitCollide=1,Pt.Collision.Shapes.b2Shape.e_missCollide=0,Pt.Collision.Shapes.b2Shape.e_startsInsideCollide=parseInt(-1)})}(),function(){var t=Pt.Common.b2Color;Pt.Common.b2internal;var e=Pt.Common.b2Settings;Pt.Common.Math.b2Mat22,Pt.Common.Math.b2Mat33;var i=Pt.Common.Math.b2Math;Pt.Common.Math.b2Sweep,Pt.Common.Math.b2Transform,Pt.Common.Math.b2Vec2,Pt.Common.Math.b2Vec3,t.b2Color=function(){this._r=0,this._g=0,this._b=0},t.prototype.b2Color=function(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this._r=Pt.parseUInt(255*i.Clamp(t,0,1)),this._g=Pt.parseUInt(255*i.Clamp(e,0,1)),this._b=Pt.parseUInt(255*i.Clamp(n,0,1))},t.prototype.Set=function(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this._r=Pt.parseUInt(255*i.Clamp(t,0,1)),this._g=Pt.parseUInt(255*i.Clamp(e,0,1)),this._b=Pt.parseUInt(255*i.Clamp(n,0,1))},Object.defineProperty(t.prototype,"r",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._r=Pt.parseUInt(255*i.Clamp(t,0,1))}}),Object.defineProperty(t.prototype,"g",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._g=Pt.parseUInt(255*i.Clamp(t,0,1))}}),Object.defineProperty(t.prototype,"b",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._b=Pt.parseUInt(255*i.Clamp(t,0,1))}}),Object.defineProperty(t.prototype,"color",{enumerable:!1,configurable:!0,get:function(){return this._r<<16|this._g<<8|this._b}}),e.b2Settings=function(){},e.b2MixFriction=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),Math.sqrt(t*e)},e.b2MixRestitution=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),t>e?t:e},e.b2Assert=function(t){if(!t)throw"Assertion Failed"},Pt.postDefs.push(function(){Pt.Common.b2Settings.VERSION="2.1alpha",Pt.Common.b2Settings.USHRT_MAX=65535,Pt.Common.b2Settings.b2_pi=Math.PI,Pt.Common.b2Settings.b2_maxManifoldPoints=2,Pt.Common.b2Settings.b2_aabbExtension=.1,Pt.Common.b2Settings.b2_aabbMultiplier=2,Pt.Common.b2Settings.b2_polygonRadius=2*e.b2_linearSlop,Pt.Common.b2Settings.b2_linearSlop=.005,Pt.Common.b2Settings.b2_angularSlop=2/180*e.b2_pi,Pt.Common.b2Settings.b2_toiSlop=8*e.b2_linearSlop,Pt.Common.b2Settings.b2_maxTOIContactsPerIsland=32,Pt.Common.b2Settings.b2_maxTOIJointsPerIsland=32,Pt.Common.b2Settings.b2_velocityThreshold=1,Pt.Common.b2Settings.b2_maxLinearCorrection=.2,Pt.Common.b2Settings.b2_maxAngularCorrection=8/180*e.b2_pi,Pt.Common.b2Settings.b2_maxTranslation=2,Pt.Common.b2Settings.b2_maxTranslationSquared=e.b2_maxTranslation*e.b2_maxTranslation,Pt.Common.b2Settings.b2_maxRotation=.5*e.b2_pi,Pt.Common.b2Settings.b2_maxRotationSquared=e.b2_maxRotation*e.b2_maxRotation,Pt.Common.b2Settings.b2_contactBaumgarte=.2,Pt.Common.b2Settings.b2_timeToSleep=.5,Pt.Common.b2Settings.b2_linearSleepTolerance=.01,Pt.Common.b2Settings.b2_angularSleepTolerance=2/180*e.b2_pi})}(),function(){Pt.Collision.b2AABB,Pt.Common.b2Color,Pt.Common.b2internal,Pt.Common.b2Settings;var t=Pt.Common.Math.b2Mat22,e=Pt.Common.Math.b2Mat33,i=Pt.Common.Math.b2Math,n=Pt.Common.Math.b2Sweep,o=Pt.Common.Math.b2Transform,s=Pt.Common.Math.b2Vec2,r=Pt.Common.Math.b2Vec3;t.b2Mat22=function(){this.col1=new s,this.col2=new s},t.prototype.b2Mat22=function(){this.SetIdentity()},t.FromAngle=function(e){void 0===e&&(e=0);var i=new t;return i.Set(e),i},t.FromVV=function(e,i){var n=new t;return n.SetVV(e,i),n},t.prototype.Set=function(t){void 0===t&&(t=0);var e=Math.cos(t),i=Math.sin(t);this.col1.x=e,this.col2.x=-i,this.col1.y=i,this.col2.y=e},t.prototype.SetVV=function(t,e){this.col1.SetV(t),this.col2.SetV(e)},t.prototype.Copy=function(){var e=new t;return e.SetM(this),e},t.prototype.SetM=function(t){this.col1.SetV(t.col1),this.col2.SetV(t.col2)},t.prototype.AddM=function(t){this.col1.x+=t.col1.x,this.col1.y+=t.col1.y,this.col2.x+=t.col2.x,this.col2.y+=t.col2.y},t.prototype.SetIdentity=function(){this.col1.x=1,this.col2.x=0,this.col1.y=0,this.col2.y=1},t.prototype.SetZero=function(){this.col1.x=0,this.col2.x=0,this.col1.y=0,this.col2.y=0},t.prototype.GetAngle=function(){return Math.atan2(this.col1.y,this.col1.x)},t.prototype.GetInverse=function(t){var e=this.col1.x,i=this.col2.x,n=this.col1.y,o=this.col2.y,s=e*o-i*n;return 0!=s&&(s=1/s),t.col1.x=s*o,t.col2.x=-s*i,t.col1.y=-s*n,t.col2.y=s*e,t},t.prototype.Solve=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0);var n=this.col1.x,o=this.col2.x,s=this.col1.y,r=this.col2.y,a=n*r-o*s;return 0!=a&&(a=1/a),t.x=a*(r*e-o*i),t.y=a*(n*i-s*e),t},t.prototype.Abs=function(){this.col1.Abs(),this.col2.Abs()},e.b2Mat33=function(){this.col1=new r,this.col2=new r,this.col3=new r},e.prototype.b2Mat33=function(t,e,i){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=null),t||e||i?(this.col1.SetV(t),this.col2.SetV(e),this.col3.SetV(i)):(this.col1.SetZero(),this.col2.SetZero(),this.col3.SetZero())},e.prototype.SetVVV=function(t,e,i){this.col1.SetV(t),this.col2.SetV(e),this.col3.SetV(i)},e.prototype.Copy=function(){return new e(this.col1,this.col2,this.col3)},e.prototype.SetM=function(t){this.col1.SetV(t.col1),this.col2.SetV(t.col2),this.col3.SetV(t.col3)},e.prototype.AddM=function(t){this.col1.x+=t.col1.x,this.col1.y+=t.col1.y,this.col1.z+=t.col1.z,this.col2.x+=t.col2.x,this.col2.y+=t.col2.y,this.col2.z+=t.col2.z,this.col3.x+=t.col3.x,this.col3.y+=t.col3.y,this.col3.z+=t.col3.z},e.prototype.SetIdentity=function(){this.col1.x=1,this.col2.x=0,this.col3.x=0,this.col1.y=0,this.col2.y=1,this.col3.y=0,this.col1.z=0,this.col2.z=0,this.col3.z=1},e.prototype.SetZero=function(){this.col1.x=0,this.col2.x=0,this.col3.x=0,this.col1.y=0,this.col2.y=0,this.col3.y=0,this.col1.z=0,this.col2.z=0,this.col3.z=0},e.prototype.Solve22=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0);var n=this.col1.x,o=this.col2.x,s=this.col1.y,r=this.col2.y,a=n*r-o*s;return 0!=a&&(a=1/a),t.x=a*(r*e-o*i),t.y=a*(n*i-s*e),t},e.prototype.Solve33=function(t,e,i,n){void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0);var o=this.col1.x,s=this.col1.y,r=this.col1.z,a=this.col2.x,l=this.col2.y,c=this.col2.z,h=this.col3.x,u=this.col3.y,m=this.col3.z,y=o*(l*m-c*u)+s*(c*h-a*m)+r*(a*u-l*h);return 0!=y&&(y=1/y),t.x=y*(e*(l*m-c*u)+i*(c*h-a*m)+n*(a*u-l*h)),t.y=y*(o*(i*m-n*u)+s*(n*h-e*m)+r*(e*u-i*h)),t.z=y*(o*(l*n-c*i)+s*(c*e-a*n)+r*(a*i-l*e)),t},i.b2Math=function(){},i.IsValid=function(t){return void 0===t&&(t=0),isFinite(t)},i.Dot=function(t,e){return t.x*e.x+t.y*e.y},i.CrossVV=function(t,e){return t.x*e.y-t.y*e.x},i.CrossVF=function(t,e){return void 0===e&&(e=0),new s(e*t.y,-e*t.x)},i.CrossFV=function(t,e){return void 0===t&&(t=0),new s(-t*e.y,t*e.x)},i.MulMV=function(t,e){return new s(t.col1.x*e.x+t.col2.x*e.y,t.col1.y*e.x+t.col2.y*e.y)},i.MulTMV=function(t,e){return new s(i.Dot(e,t.col1),i.Dot(e,t.col2))},i.MulX=function(t,e){var n=i.MulMV(t.R,e);return n.x+=t.position.x,n.y+=t.position.y,n},i.MulXT=function(t,e){var n=i.SubtractVV(e,t.position),o=n.x*t.R.col1.x+n.y*t.R.col1.y;return n.y=n.x*t.R.col2.x+n.y*t.R.col2.y,n.x=o,n},i.AddVV=function(t,e){return new s(t.x+e.x,t.y+e.y)},i.SubtractVV=function(t,e){return new s(t.x-e.x,t.y-e.y)},i.Distance=function(t,e){var i=t.x-e.x,n=t.y-e.y;return Math.sqrt(i*i+n*n)},i.DistanceSquared=function(t,e){var i=t.x-e.x,n=t.y-e.y;return i*i+n*n},i.MulFV=function(t,e){return void 0===t&&(t=0),new s(t*e.x,t*e.y)},i.AddMM=function(e,n){return t.FromVV(i.AddVV(e.col1,n.col1),i.AddVV(e.col2,n.col2))},i.MulMM=function(e,n){return t.FromVV(i.MulMV(e,n.col1),i.MulMV(e,n.col2))},i.MulTMM=function(e,n){var o=new s(i.Dot(e.col1,n.col1),i.Dot(e.col2,n.col1)),r=new s(i.Dot(e.col1,n.col2),i.Dot(e.col2,n.col2));return t.FromVV(o,r)},i.Abs=function(t){return void 0===t&&(t=0),t>0?t:-t},i.AbsV=function(t){return new s(i.Abs(t.x),i.Abs(t.y))},i.AbsM=function(e){return t.FromVV(i.AbsV(e.col1),i.AbsV(e.col2))},i.Min=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),t<e?t:e},i.MinV=function(t,e){return new s(i.Min(t.x,e.x),i.Min(t.y,e.y))},i.Max=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),t>e?t:e},i.MaxV=function(t,e){return new s(i.Max(t.x,e.x),i.Max(t.y,e.y))},i.Clamp=function(t,e,i){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),t<e?e:t>i?i:t},i.ClampV=function(t,e,n){return i.MaxV(e,i.MinV(t,n))},i.Swap=function(t,e){var i=t[0];t[0]=e[0],e[0]=i},i.Random=function(){return 2*Math.random()-1},i.RandomRange=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0);var i=Math.random();return(e-t)*i+t},i.NextPowerOfTwo=function(t){return void 0===t&&(t=0),t|=t>>1&2147483647,t|=t>>2&1073741823,t|=t>>4&268435455,t|=t>>8&16777215,1+(t|=t>>16&65535)},i.IsPowerOfTwo=function(t){return void 0===t&&(t=0),t>0&&!(t&t-1)},Pt.postDefs.push(function(){Pt.Common.Math.b2Math.b2Vec2_zero=new s(0,0),Pt.Common.Math.b2Math.b2Mat22_identity=t.FromVV(new s(1,0),new s(0,1)),Pt.Common.Math.b2Math.b2Transform_identity=new o(i.b2Vec2_zero,i.b2Mat22_identity)}),n.b2Sweep=function(){this.localCenter=new s,this.c0=new s,this.c=new s},n.prototype.Set=function(t){this.localCenter.SetV(t.localCenter),this.c0.SetV(t.c0),this.c.SetV(t.c),this.a0=t.a0,this.a=t.a,this.t0=t.t0},n.prototype.Copy=function(){var t=new n;return t.localCenter.SetV(this.localCenter),t.c0.SetV(this.c0),t.c.SetV(this.c),t.a0=this.a0,t.a=this.a,t.t0=this.t0,t},n.prototype.GetTransform=function(t,e){void 0===e&&(e=0),t.position.x=(1-e)*this.c0.x+e*this.c.x,t.position.y=(1-e)*this.c0.y+e*this.c.y;var i=(1-e)*this.a0+e*this.a;t.R.Set(i);var n=t.R;t.position.x-=n.col1.x*this.localCenter.x+n.col2.x*this.localCenter.y,t.position.y-=n.col1.y*this.localCenter.x+n.col2.y*this.localCenter.y},n.prototype.Advance=function(t){if(void 0===t&&(t=0),this.t0<t&&1-this.t0>Number.MIN_VALUE){var e=(t-this.t0)/(1-this.t0);this.c0.x=(1-e)*this.c0.x+e*this.c.x,this.c0.y=(1-e)*this.c0.y+e*this.c.y,this.a0=(1-e)*this.a0+e*this.a,this.t0=t}},o.b2Transform=function(){this.position=new s,this.R=new t},o.prototype.b2Transform=function(t,e){void 0===t&&(t=null),void 0===e&&(e=null),t&&(this.position.SetV(t),this.R.SetM(e))},o.prototype.Initialize=function(t,e){this.position.SetV(t),this.R.SetM(e)},o.prototype.SetIdentity=function(){this.position.SetZero(),this.R.SetIdentity()},o.prototype.Set=function(t){this.position.SetV(t.position),this.R.SetM(t.R)},o.prototype.GetAngle=function(){return Math.atan2(this.R.col1.y,this.R.col1.x)},s.b2Vec2=function(){},s.prototype.b2Vec2=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e},s.prototype.SetZero=function(){this.x=0,this.y=0},s.prototype.Set=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e},s.prototype.SetV=function(t){this.x=t.x,this.y=t.y},s.prototype.GetNegative=function(){return new s(-this.x,-this.y)},s.prototype.NegativeSelf=function(){this.x=-this.x,this.y=-this.y},s.Make=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),new s(t,e)},s.prototype.Copy=function(){return new s(this.x,this.y)},s.prototype.Add=function(t){this.x+=t.x,this.y+=t.y},s.prototype.Subtract=function(t){this.x-=t.x,this.y-=t.y},s.prototype.Multiply=function(t){void 0===t&&(t=0),this.x*=t,this.y*=t},s.prototype.MulM=function(t){var e=this.x;this.x=t.col1.x*e+t.col2.x*this.y,this.y=t.col1.y*e+t.col2.y*this.y},s.prototype.MulTM=function(t){var e=i.Dot(this,t.col1);this.y=i.Dot(this,t.col2),this.x=e},s.prototype.CrossVF=function(t){void 0===t&&(t=0);var e=this.x;this.x=t*this.y,this.y=-t*e},s.prototype.CrossFV=function(t){void 0===t&&(t=0);var e=this.x;this.x=-t*this.y,this.y=t*e},s.prototype.MinV=function(t){this.x=this.x<t.x?this.x:t.x,this.y=this.y<t.y?this.y:t.y},s.prototype.MaxV=function(t){this.x=this.x>t.x?this.x:t.x,this.y=this.y>t.y?this.y:t.y},s.prototype.Abs=function(){this.x<0&&(this.x=-this.x),this.y<0&&(this.y=-this.y)},s.prototype.Length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},s.prototype.LengthSquared=function(){return this.x*this.x+this.y*this.y},s.prototype.Normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y);if(t<Number.MIN_VALUE)return 0;var e=1/t;return this.x*=e,this.y*=e,t},s.prototype.IsValid=function(){return i.IsValid(this.x)&&i.IsValid(this.y)},r.b2Vec3=function(){},r.prototype.b2Vec3=function(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=i},r.prototype.SetZero=function(){this.x=this.y=this.z=0},r.prototype.Set=function(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=i},r.prototype.SetV=function(t){this.x=t.x,this.y=t.y,this.z=t.z},r.prototype.GetNegative=function(){return new r(-this.x,-this.y,-this.z)},r.prototype.NegativeSelf=function(){this.x=-this.x,this.y=-this.y,this.z=-this.z},r.prototype.Copy=function(){return new r(this.x,this.y,this.z)},r.prototype.Add=function(t){this.x+=t.x,this.y+=t.y,this.z+=t.z},r.prototype.Subtract=function(t){this.x-=t.x,this.y-=t.y,this.z-=t.z},r.prototype.Multiply=function(t){void 0===t&&(t=0),this.x*=t,this.y*=t,this.z*=t}}(),function(){Pt.Dynamics.Controllers.b2ControllerEdge,Pt.Common.Math.b2Mat22,Pt.Common.Math.b2Mat33;var t=Pt.Common.Math.b2Math,e=Pt.Common.Math.b2Sweep,i=Pt.Common.Math.b2Transform,n=Pt.Common.Math.b2Vec2;Pt.Common.Math.b2Vec3;var o=Pt.Common.b2Color;Pt.Common.b2internal;var s=Pt.Common.b2Settings,r=Pt.Collision.b2AABB;Pt.Collision.b2Bound,Pt.Collision.b2BoundValues,Pt.Collision.b2Collision,Pt.Collision.b2ContactID;var a=Pt.Collision.b2ContactPoint;Pt.Collision.b2Distance,Pt.Collision.b2DistanceInput,Pt.Collision.b2DistanceOutput,Pt.Collision.b2DistanceProxy,Pt.Collision.b2DynamicTree;var l=Pt.Collision.b2DynamicTreeBroadPhase;Pt.Collision.b2DynamicTreeNode,Pt.Collision.b2DynamicTreePair,Pt.Collision.b2Manifold,Pt.Collision.b2ManifoldPoint,Pt.Collision.b2Point;var c=Pt.Collision.b2RayCastInput,h=Pt.Collision.b2RayCastOutput;Pt.Collision.b2Segment,Pt.Collision.b2SeparationFunction,Pt.Collision.b2Simplex,Pt.Collision.b2SimplexCache,Pt.Collision.b2SimplexVertex,Pt.Collision.b2TimeOfImpact,Pt.Collision.b2TOIInput,Pt.Collision.b2WorldManifold,Pt.Collision.ClipVertex,Pt.Collision.Features,Pt.Collision.IBroadPhase;var u=Pt.Collision.Shapes.b2CircleShape;Pt.Collision.Shapes.b2EdgeChainDef;var m=Pt.Collision.Shapes.b2EdgeShape,y=Pt.Collision.Shapes.b2MassData,p=Pt.Collision.Shapes.b2PolygonShape,d=Pt.Collision.Shapes.b2Shape,f=Pt.Dynamics.b2Body,_=Pt.Dynamics.b2BodyDef,v=Pt.Dynamics.b2ContactFilter,g=Pt.Dynamics.b2ContactImpulse,b=Pt.Dynamics.b2ContactListener,x=Pt.Dynamics.b2ContactManager,w=Pt.Dynamics.b2DebugDraw,C=Pt.Dynamics.b2DestructionListener,S=Pt.Dynamics.b2FilterData,A=Pt.Dynamics.b2Fixture,M=Pt.Dynamics.b2FixtureDef,k=Pt.Dynamics.b2Island,D=Pt.Dynamics.b2TimeStep,I=Pt.Dynamics.b2World;Pt.Dynamics.Contacts.b2CircleContact;var B=Pt.Dynamics.Contacts.b2Contact;Pt.Dynamics.Contacts.b2ContactConstraint,Pt.Dynamics.Contacts.b2ContactConstraintPoint,Pt.Dynamics.Contacts.b2ContactEdge;var P=Pt.Dynamics.Contacts.b2ContactFactory;Pt.Dynamics.Contacts.b2ContactRegister,Pt.Dynamics.Contacts.b2ContactResult;var V=Pt.Dynamics.Contacts.b2ContactSolver;Pt.Dynamics.Contacts.b2EdgeAndCircleContact,Pt.Dynamics.Contacts.b2NullContact,Pt.Dynamics.Contacts.b2PolyAndCircleContact,Pt.Dynamics.Contacts.b2PolyAndEdgeContact,Pt.Dynamics.Contacts.b2PolygonContact,Pt.Dynamics.Contacts.b2PositionSolverManifold,Pt.Dynamics.Controllers.b2Controller,Pt.Dynamics.Joints.b2DistanceJoint,Pt.Dynamics.Joints.b2DistanceJointDef,Pt.Dynamics.Joints.b2FrictionJoint,Pt.Dynamics.Joints.b2FrictionJointDef,Pt.Dynamics.Joints.b2GearJoint,Pt.Dynamics.Joints.b2GearJointDef,Pt.Dynamics.Joints.b2Jacobian;var T=Pt.Dynamics.Joints.b2Joint;Pt.Dynamics.Joints.b2JointDef,Pt.Dynamics.Joints.b2JointEdge,Pt.Dynamics.Joints.b2LineJoint,Pt.Dynamics.Joints.b2LineJointDef,Pt.Dynamics.Joints.b2MouseJoint,Pt.Dynamics.Joints.b2MouseJointDef,Pt.Dynamics.Joints.b2PrismaticJoint,Pt.Dynamics.Joints.b2PrismaticJointDef;var E=Pt.Dynamics.Joints.b2PulleyJoint;Pt.Dynamics.Joints.b2PulleyJointDef,Pt.Dynamics.Joints.b2RevoluteJoint,Pt.Dynamics.Joints.b2RevoluteJointDef,Pt.Dynamics.Joints.b2WeldJoint,Pt.Dynamics.Joints.b2WeldJointDef,f.b2Body=function(){this.m_xf=new i,this.m_sweep=new e,this.m_linearVelocity=new n,this.m_force=new n},f.prototype.connectEdges=function(e,i,n){void 0===n&&(n=0);var o=Math.atan2(i.GetDirectionVector().y,i.GetDirectionVector().x),r=Math.tan(.5*(o-n)),a=t.MulFV(r,i.GetDirectionVector());a=t.SubtractVV(a,i.GetNormalVector()),a=t.MulFV(s.b2_toiSlop,a),a=t.AddVV(a,i.GetVertex1());var l=t.AddVV(e.GetDirectionVector(),i.GetDirectionVector());l.Normalize();var c=t.Dot(e.GetDirectionVector(),i.GetNormalVector())>0;return e.SetNextEdge(i,a,l,c),i.SetPrevEdge(e,a,l,c),o},f.prototype.CreateFixture=function(t){if(1==this.m_world.IsLocked())return null;var e=new A;if(e.Create(this,this.m_xf,t),this.m_flags&f.e_activeFlag){var i=this.m_world.m_contactManager.m_broadPhase;e.CreateProxy(i,this.m_xf)}return e.m_next=this.m_fixtureList,this.m_fixtureList=e,++this.m_fixtureCount,e.m_body=this,e.m_density>0&&this.ResetMassData(),this.m_world.m_flags|=I.e_newFixture,e},f.prototype.CreateFixture2=function(t,e){void 0===e&&(e=0);var i=new M;return i.shape=t,i.density=e,this.CreateFixture(i)},f.prototype.DestroyFixture=function(t){if(1!=this.m_world.IsLocked()){for(var e=this.m_fixtureList,i=null;null!=e;){if(e==t){i?i.m_next=t.m_next:this.m_fixtureList=t.m_next;break}i=e,e=e.m_next}for(var n=this.m_contactList;n;){var o=n.contact;n=n.next;var s=o.GetFixtureA(),r=o.GetFixtureB();t!=s&&t!=r||this.m_world.m_contactManager.Destroy(o)}if(this.m_flags&f.e_activeFlag){var a=this.m_world.m_contactManager.m_broadPhase;t.DestroyProxy(a)}t.Destroy(),t.m_body=null,t.m_next=null,--this.m_fixtureCount,this.ResetMassData()}},f.prototype.SetPositionAndAngle=function(t,e){var i;if(void 0===e&&(e=0),1!=this.m_world.IsLocked()){this.m_xf.R.Set(e),this.m_xf.position.SetV(t);var n=this.m_xf.R,o=this.m_sweep.localCenter;this.m_sweep.c.x=n.col1.x*o.x+n.col2.x*o.y,this.m_sweep.c.y=n.col1.y*o.x+n.col2.y*o.y,this.m_sweep.c.x+=this.m_xf.position.x,this.m_sweep.c.y+=this.m_xf.position.y,this.m_sweep.c0.SetV(this.m_sweep.c),this.m_sweep.a0=this.m_sweep.a=e;var s=this.m_world.m_contactManager.m_broadPhase;for(i=this.m_fixtureList;i;i=i.m_next)i.Synchronize(s,this.m_xf,this.m_xf);this.m_world.m_contactManager.FindNewContacts()}},f.prototype.SetTransform=function(t){this.SetPositionAndAngle(t.position,t.GetAngle())},f.prototype.GetTransform=function(){return this.m_xf},f.prototype.GetPosition=function(){return this.m_xf.position},f.prototype.SetPosition=function(t){this.SetPositionAndAngle(t,this.GetAngle())},f.prototype.GetAngle=function(){return this.m_sweep.a},f.prototype.SetAngle=function(t){void 0===t&&(t=0),this.SetPositionAndAngle(this.GetPosition(),t)},f.prototype.GetWorldCenter=function(){return this.m_sweep.c},f.prototype.GetLocalCenter=function(){return this.m_sweep.localCenter},f.prototype.SetLinearVelocity=function(t){this.m_type!=f.b2_staticBody&&this.m_linearVelocity.SetV(t)},f.prototype.GetLinearVelocity=function(){return this.m_linearVelocity},f.prototype.SetAngularVelocity=function(t){void 0===t&&(t=0),this.m_type!=f.b2_staticBody&&(this.m_angularVelocity=t)},f.prototype.GetAngularVelocity=function(){return this.m_angularVelocity},f.prototype.GetDefinition=function(){var t=new _;return t.type=this.GetType(),t.allowSleep=(this.m_flags&f.e_allowSleepFlag)==f.e_allowSleepFlag,t.angle=this.GetAngle(),t.angularDamping=this.m_angularDamping,t.angularVelocity=this.m_angularVelocity,t.fixedRotation=(this.m_flags&f.e_fixedRotationFlag)==f.e_fixedRotationFlag,t.bullet=(this.m_flags&f.e_bulletFlag)==f.e_bulletFlag,t.awake=(this.m_flags&f.e_awakeFlag)==f.e_awakeFlag,t.linearDamping=this.m_linearDamping,t.linearVelocity.SetV(this.GetLinearVelocity()),t.position=this.GetPosition(),t.userData=this.GetUserData(),t},f.prototype.ApplyForce=function(t,e){this.m_type==f.b2_dynamicBody&&(0==this.IsAwake()&&this.SetAwake(!0),this.m_force.x+=t.x,this.m_force.y+=t.y,this.m_torque+=(e.x-this.m_sweep.c.x)*t.y-(e.y-this.m_sweep.c.y)*t.x)},f.prototype.ApplyTorque=function(t){void 0===t&&(t=0),this.m_type==f.b2_dynamicBody&&(0==this.IsAwake()&&this.SetAwake(!0),this.m_torque+=t)},f.prototype.ApplyImpulse=function(t,e){this.m_type==f.b2_dynamicBody&&(0==this.IsAwake()&&this.SetAwake(!0),this.m_linearVelocity.x+=this.m_invMass*t.x,this.m_linearVelocity.y+=this.m_invMass*t.y,this.m_angularVelocity+=this.m_invI*((e.x-this.m_sweep.c.x)*t.y-(e.y-this.m_sweep.c.y)*t.x))},f.prototype.Split=function(e){for(var i,n=this.GetLinearVelocity().Copy(),o=this.GetAngularVelocity(),s=this.GetWorldCenter(),r=this,a=this.m_world.CreateBody(this.GetDefinition()),l=r.m_fixtureList;l;)if(e(l)){var c=l.m_next;i?i.m_next=c:r.m_fixtureList=c,r.m_fixtureCount--,l.m_next=a.m_fixtureList,a.m_fixtureList=l,a.m_fixtureCount++,l.m_body=a,l=c}else i=l,l=l.m_next;r.ResetMassData(),a.ResetMassData();var h=r.GetWorldCenter(),u=a.GetWorldCenter(),m=t.AddVV(n,t.CrossFV(o,t.SubtractVV(h,s))),y=t.AddVV(n,t.CrossFV(o,t.SubtractVV(u,s)));return r.SetLinearVelocity(m),a.SetLinearVelocity(y),r.SetAngularVelocity(o),a.SetAngularVelocity(o),r.SynchronizeFixtures(),a.SynchronizeFixtures(),a},f.prototype.Merge=function(t){var e;for(e=t.m_fixtureList;e;){var i=e.m_next;t.m_fixtureCount--,e.m_next=this.m_fixtureList,this.m_fixtureList=e,this.m_fixtureCount++,e.m_body=o,e=i}n.m_fixtureCount=0;var n=this,o=t;n.GetWorldCenter(),o.GetWorldCenter(),n.GetLinearVelocity().Copy(),o.GetLinearVelocity().Copy(),n.GetAngularVelocity(),o.GetAngularVelocity(),n.ResetMassData(),this.SynchronizeFixtures()},f.prototype.GetMass=function(){return this.m_mass},f.prototype.GetInertia=function(){return this.m_I},f.prototype.GetMassData=function(t){t.mass=this.m_mass,t.I=this.m_I,t.center.SetV(this.m_sweep.localCenter)},f.prototype.SetMassData=function(e){if(s.b2Assert(0==this.m_world.IsLocked()),1!=this.m_world.IsLocked()&&this.m_type==f.b2_dynamicBody){this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=e.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,e.I>0&&!(this.m_flags&f.e_fixedRotationFlag)&&(this.m_I=e.I-this.m_mass*(e.center.x*e.center.x+e.center.y*e.center.y),this.m_invI=1/this.m_I);var i=this.m_sweep.c.Copy();this.m_sweep.localCenter.SetV(e.center),this.m_sweep.c0.SetV(t.MulX(this.m_xf,this.m_sweep.localCenter)),this.m_sweep.c.SetV(this.m_sweep.c0),this.m_linearVelocity.x+=this.m_angularVelocity*-(this.m_sweep.c.y-i.y),this.m_linearVelocity.y+=this.m_angularVelocity*+(this.m_sweep.c.x-i.x)}},f.prototype.ResetMassData=function(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_sweep.localCenter.SetZero(),this.m_type!=f.b2_staticBody&&this.m_type!=f.b2_kinematicBody){for(var e=n.Make(0,0),i=this.m_fixtureList;i;i=i.m_next)if(0!=i.m_density){var o=i.GetMassData();this.m_mass+=o.mass,e.x+=o.center.x*o.mass,e.y+=o.center.y*o.mass,this.m_I+=o.I}this.m_mass>0?(this.m_invMass=1/this.m_mass,e.x*=this.m_invMass,e.y*=this.m_invMass):(this.m_mass=1,this.m_invMass=1),this.m_I>0&&!(this.m_flags&f.e_fixedRotationFlag)?(this.m_I-=this.m_mass*(e.x*e.x+e.y*e.y),this.m_I*=this.m_inertiaScale,s.b2Assert(this.m_I>0),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0);var r=this.m_sweep.c.Copy();this.m_sweep.localCenter.SetV(e),this.m_sweep.c0.SetV(t.MulX(this.m_xf,this.m_sweep.localCenter)),this.m_sweep.c.SetV(this.m_sweep.c0),this.m_linearVelocity.x+=this.m_angularVelocity*-(this.m_sweep.c.y-r.y),this.m_linearVelocity.y+=this.m_angularVelocity*+(this.m_sweep.c.x-r.x)}},f.prototype.GetWorldPoint=function(t){var e=this.m_xf.R,i=new n(e.col1.x*t.x+e.col2.x*t.y,e.col1.y*t.x+e.col2.y*t.y);return i.x+=this.m_xf.position.x,i.y+=this.m_xf.position.y,i},f.prototype.GetWorldVector=function(e){return t.MulMV(this.m_xf.R,e)},f.prototype.GetLocalPoint=function(e){return t.MulXT(this.m_xf,e)},f.prototype.GetLocalVector=function(e){return t.MulTMV(this.m_xf.R,e)},f.prototype.GetLinearVelocityFromWorldPoint=function(t){return new n(this.m_linearVelocity.x-this.m_angularVelocity*(t.y-this.m_sweep.c.y),this.m_linearVelocity.y+this.m_angularVelocity*(t.x-this.m_sweep.c.x))},f.prototype.GetLinearVelocityFromLocalPoint=function(t){var e=this.m_xf.R,i=new n(e.col1.x*t.x+e.col2.x*t.y,e.col1.y*t.x+e.col2.y*t.y);return i.x+=this.m_xf.position.x,i.y+=this.m_xf.position.y,new n(this.m_linearVelocity.x-this.m_angularVelocity*(i.y-this.m_sweep.c.y),this.m_linearVelocity.y+this.m_angularVelocity*(i.x-this.m_sweep.c.x))},f.prototype.GetLinearDamping=function(){return this.m_linearDamping},f.prototype.SetLinearDamping=function(t){void 0===t&&(t=0),this.m_linearDamping=t},f.prototype.GetAngularDamping=function(){return this.m_angularDamping},f.prototype.SetAngularDamping=function(t){void 0===t&&(t=0),this.m_angularDamping=t},f.prototype.SetType=function(t){if(void 0===t&&(t=0),this.m_type!=t){this.m_type=t,this.ResetMassData(),this.m_type==f.b2_staticBody&&(this.m_linearVelocity.SetZero(),this.m_angularVelocity=0),this.SetAwake(!0),this.m_force.SetZero(),this.m_torque=0;for(var e=this.m_contactList;e;e=e.next)e.contact.FlagForFiltering()}},f.prototype.GetType=function(){return this.m_type},f.prototype.SetBullet=function(t){t?this.m_flags|=f.e_bulletFlag:this.m_flags&=~f.e_bulletFlag},f.prototype.IsBullet=function(){return(this.m_flags&f.e_bulletFlag)==f.e_bulletFlag},f.prototype.SetSleepingAllowed=function(t){t?this.m_flags|=f.e_allowSleepFlag:(this.m_flags&=~f.e_allowSleepFlag,this.SetAwake(!0))},f.prototype.SetAwake=function(t){t?(this.m_flags|=f.e_awakeFlag,this.m_sleepTime=0):(this.m_flags&=~f.e_awakeFlag,this.m_sleepTime=0,this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_force.SetZero(),this.m_torque=0)},f.prototype.IsAwake=function(){return(this.m_flags&f.e_awakeFlag)==f.e_awakeFlag},f.prototype.SetFixedRotation=function(t){t?this.m_flags|=f.e_fixedRotationFlag:this.m_flags&=~f.e_fixedRotationFlag,this.ResetMassData()},f.prototype.IsFixedRotation=function(){return(this.m_flags&f.e_fixedRotationFlag)==f.e_fixedRotationFlag},f.prototype.SetActive=function(t){var e,i;if(t!=this.IsActive())if(t)for(this.m_flags|=f.e_activeFlag,e=this.m_world.m_contactManager.m_broadPhase,i=this.m_fixtureList;i;i=i.m_next)i.CreateProxy(e,this.m_xf);else{for(this.m_flags&=~f.e_activeFlag,e=this.m_world.m_contactManager.m_broadPhase,i=this.m_fixtureList;i;i=i.m_next)i.DestroyProxy(e);for(var n=this.m_contactList;n;){var o=n;n=n.next,this.m_world.m_contactManager.Destroy(o.contact)}this.m_contactList=null}},f.prototype.IsActive=function(){return(this.m_flags&f.e_activeFlag)==f.e_activeFlag},f.prototype.IsSleepingAllowed=function(){return(this.m_flags&f.e_allowSleepFlag)==f.e_allowSleepFlag},f.prototype.GetFixtureList=function(){return this.m_fixtureList},f.prototype.GetJointList=function(){return this.m_jointList},f.prototype.GetControllerList=function(){return this.m_controllerList},f.prototype.GetContactList=function(){return this.m_contactList},f.prototype.GetNext=function(){return this.m_next},f.prototype.GetUserData=function(){return this.m_userData},f.prototype.SetUserData=function(t){this.m_userData=t},f.prototype.GetWorld=function(){return this.m_world},f.prototype.b2Body=function(t,e){this.m_flags=0,t.bullet&&(this.m_flags|=f.e_bulletFlag),t.fixedRotation&&(this.m_flags|=f.e_fixedRotationFlag),t.allowSleep&&(this.m_flags|=f.e_allowSleepFlag),t.awake&&(this.m_flags|=f.e_awakeFlag),t.active&&(this.m_flags|=f.e_activeFlag),this.m_world=e,this.m_xf.position.SetV(t.position),this.m_xf.R.Set(t.angle),this.m_sweep.localCenter.SetZero(),this.m_sweep.t0=1,this.m_sweep.a0=this.m_sweep.a=t.angle;var i=this.m_xf.R,n=this.m_sweep.localCenter;this.m_sweep.c.x=i.col1.x*n.x+i.col2.x*n.y,this.m_sweep.c.y=i.col1.y*n.x+i.col2.y*n.y,this.m_sweep.c.x+=this.m_xf.position.x,this.m_sweep.c.y+=this.m_xf.position.y,this.m_sweep.c0.SetV(this.m_sweep.c),this.m_jointList=null,this.m_controllerList=null,this.m_contactList=null,this.m_controllerCount=0,this.m_prev=null,this.m_next=null,this.m_linearVelocity.SetV(t.linearVelocity),this.m_angularVelocity=t.angularVelocity,this.m_linearDamping=t.linearDamping,this.m_angularDamping=t.angularDamping,this.m_force.Set(0,0),this.m_torque=0,this.m_sleepTime=0,this.m_type=t.type,this.m_type==f.b2_dynamicBody?(this.m_mass=1,this.m_invMass=1):(this.m_mass=0,this.m_invMass=0),this.m_I=0,this.m_invI=0,this.m_inertiaScale=t.inertiaScale,this.m_userData=t.userData,this.m_fixtureList=null,this.m_fixtureCount=0},f.prototype.SynchronizeFixtures=function(){var t=f.s_xf1;t.R.Set(this.m_sweep.a0);var e,i=t.R,n=this.m_sweep.localCenter;t.position.x=this.m_sweep.c0.x-(i.col1.x*n.x+i.col2.x*n.y),t.position.y=this.m_sweep.c0.y-(i.col1.y*n.x+i.col2.y*n.y);var o=this.m_world.m_contactManager.m_broadPhase;for(e=this.m_fixtureList;e;e=e.m_next)e.Synchronize(o,t,this.m_xf)},f.prototype.SynchronizeTransform=function(){this.m_xf.R.Set(this.m_sweep.a);var t=this.m_xf.R,e=this.m_sweep.localCenter;this.m_xf.position.x=this.m_sweep.c.x-(t.col1.x*e.x+t.col2.x*e.y),this.m_xf.position.y=this.m_sweep.c.y-(t.col1.y*e.x+t.col2.y*e.y)},f.prototype.ShouldCollide=function(t){if(this.m_type!=f.b2_dynamicBody&&t.m_type!=f.b2_dynamicBody)return!1;for(var e=this.m_jointList;e;e=e.next)if(e.other==t&&0==e.joint.m_collideConnected)return!1;return!0},f.prototype.Advance=function(t){void 0===t&&(t=0),this.m_sweep.Advance(t),this.m_sweep.c.SetV(this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.SynchronizeTransform()},Pt.postDefs.push(function(){Pt.Dynamics.b2Body.s_xf1=new i,Pt.Dynamics.b2Body.e_islandFlag=1,Pt.Dynamics.b2Body.e_awakeFlag=2,Pt.Dynamics.b2Body.e_allowSleepFlag=4,Pt.Dynamics.b2Body.e_bulletFlag=8,Pt.Dynamics.b2Body.e_fixedRotationFlag=16,Pt.Dynamics.b2Body.e_activeFlag=32,Pt.Dynamics.b2Body.b2_staticBody=0,Pt.Dynamics.b2Body.b2_kinematicBody=1,Pt.Dynamics.b2Body.b2_dynamicBody=2}),_.b2BodyDef=function(){this.position=new n,this.linearVelocity=new n},_.prototype.b2BodyDef=function(){this.userData=null,this.position.Set(0,0),this.angle=0,this.linearVelocity.Set(0,0),this.angularVelocity=0,this.linearDamping=0,this.angularDamping=0,this.allowSleep=!0,this.awake=!0,this.fixedRotation=!1,this.bullet=!1,this.type=f.b2_staticBody,this.active=!0,this.inertiaScale=1},v.b2ContactFilter=function(){},v.prototype.ShouldCollide=function(t,e){var i=t.GetFilterData(),n=e.GetFilterData();return i.groupIndex==n.groupIndex&&0!=i.groupIndex?i.groupIndex>0:!!(i.maskBits&n.categoryBits)&&!!(i.categoryBits&n.maskBits)},v.prototype.RayCollide=function(t,e){return!t||this.ShouldCollide(t instanceof A?t:null,e)},Pt.postDefs.push(function(){Pt.Dynamics.b2ContactFilter.b2_defaultFilter=new v}),g.b2ContactImpulse=function(){this.normalImpulses=new Lt(s.b2_maxManifoldPoints),this.tangentImpulses=new Lt(s.b2_maxManifoldPoints)},b.b2ContactListener=function(){},b.prototype.BeginContact=function(t){},b.prototype.EndContact=function(t){},b.prototype.PreSolve=function(t,e){},b.prototype.PostSolve=function(t,e){},Pt.postDefs.push(function(){Pt.Dynamics.b2ContactListener.b2_defaultListener=new b}),x.b2ContactManager=function(){},x.prototype.b2ContactManager=function(){this.m_world=null,this.m_contactCount=0,this.m_contactFilter=v.b2_defaultFilter,this.m_contactListener=b.b2_defaultListener,this.m_contactFactory=new P(this.m_allocator),this.m_broadPhase=new l},x.prototype.AddPair=function(t,e){var i=t instanceof A?t:null,n=e instanceof A?e:null,o=i.GetBody(),s=n.GetBody();if(o!=s){for(var r=s.GetContactList();r;){if(r.other==o){var a=r.contact.GetFixtureA(),l=r.contact.GetFixtureB();if(a==i&&l==n)return;if(a==n&&l==i)return}r=r.next}if(0!=s.ShouldCollide(o)&&0!=this.m_contactFilter.ShouldCollide(i,n)){var c=this.m_contactFactory.Create(i,n);i=c.GetFixtureA(),n=c.GetFixtureB(),o=i.m_body,s=n.m_body,c.m_prev=null,c.m_next=this.m_world.m_contactList,null!=this.m_world.m_contactList&&(this.m_world.m_contactList.m_prev=c),this.m_world.m_contactList=c,c.m_nodeA.contact=c,c.m_nodeA.other=s,c.m_nodeA.prev=null,c.m_nodeA.next=o.m_contactList,null!=o.m_contactList&&(o.m_contactList.prev=c.m_nodeA),o.m_contactList=c.m_nodeA,c.m_nodeB.contact=c,c.m_nodeB.other=o,c.m_nodeB.prev=null,c.m_nodeB.next=s.m_contactList,null!=s.m_contactList&&(s.m_contactList.prev=c.m_nodeB),s.m_contactList=c.m_nodeB,++this.m_world.m_contactCount}}},x.prototype.FindNewContacts=function(){this.m_broadPhase.UpdatePairs(Pt.generateCallback(this,this.AddPair))},x.prototype.Destroy=function(t){var e=t.GetFixtureA(),i=t.GetFixtureB(),n=e.GetBody(),o=i.GetBody();t.IsTouching()&&this.m_contactListener.EndContact(t),t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_world.m_contactList&&(this.m_world.m_contactList=t.m_next),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA==n.m_contactList&&(n.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB==o.m_contactList&&(o.m_contactList=t.m_nodeB.next),this.m_contactFactory.Destroy(t),--this.m_contactCount},x.prototype.Collide=function(){for(var t=this.m_world.m_contactList;t;){var e=t.GetFixtureA(),i=t.GetFixtureB(),n=e.GetBody(),o=i.GetBody();if(0!=n.IsAwake()||0!=o.IsAwake()){if(t.m_flags&B.e_filterFlag){if(0==o.ShouldCollide(n)){var s=t;t=s.GetNext(),this.Destroy(s);continue}if(0==this.m_contactFilter.ShouldCollide(e,i)){t=(s=t).GetNext(),this.Destroy(s);continue}t.m_flags&=~B.e_filterFlag}var r=e.m_proxy,a=i.m_proxy;0!=this.m_broadPhase.TestOverlap(r,a)?(t.Update(this.m_contactListener),t=t.GetNext()):(t=(s=t).GetNext(),this.Destroy(s))}else t=t.GetNext()}},Pt.postDefs.push(function(){Pt.Dynamics.b2ContactManager.s_evalCP=new a}),w.b2DebugDraw=function(){},w.prototype.b2DebugDraw=function(){},w.prototype.SetFlags=function(t){},w.prototype.GetFlags=function(){},w.prototype.AppendFlags=function(t){},w.prototype.ClearFlags=function(t){},w.prototype.SetSprite=function(t){},w.prototype.GetSprite=function(){},w.prototype.SetDrawScale=function(t){},w.prototype.GetDrawScale=function(){},w.prototype.SetLineThickness=function(t){},w.prototype.GetLineThickness=function(){},w.prototype.SetAlpha=function(t){},w.prototype.GetAlpha=function(){},w.prototype.SetFillAlpha=function(t){},w.prototype.GetFillAlpha=function(){},w.prototype.SetXFormScale=function(t){},w.prototype.GetXFormScale=function(){},w.prototype.DrawPolygon=function(t,e,i){},w.prototype.DrawSolidPolygon=function(t,e,i){},w.prototype.DrawCircle=function(t,e,i){},w.prototype.DrawSolidCircle=function(t,e,i,n){},w.prototype.DrawSegment=function(t,e,i){},w.prototype.DrawTransform=function(t){},Pt.postDefs.push(function(){Pt.Dynamics.b2DebugDraw.e_shapeBit=1,Pt.Dynamics.b2DebugDraw.e_jointBit=2,Pt.Dynamics.b2DebugDraw.e_aabbBit=4,Pt.Dynamics.b2DebugDraw.e_pairBit=8,Pt.Dynamics.b2DebugDraw.e_centerOfMassBit=16,Pt.Dynamics.b2DebugDraw.e_controllerBit=32}),C.b2DestructionListener=function(){},C.prototype.SayGoodbyeJoint=function(t){},C.prototype.SayGoodbyeFixture=function(t){},S.b2FilterData=function(){this.categoryBits=1,this.maskBits=65535,this.groupIndex=0},S.prototype.Copy=function(){var t=new S;return t.categoryBits=this.categoryBits,t.maskBits=this.maskBits,t.groupIndex=this.groupIndex,t},A.b2Fixture=function(){this.m_filter=new S},A.prototype.GetType=function(){return this.m_shape.GetType()},A.prototype.GetShape=function(){return this.m_shape},A.prototype.SetSensor=function(t){if(this.m_isSensor!=t&&(this.m_isSensor=t,null!=this.m_body))for(var e=this.m_body.GetContactList();e;){var i=e.contact,n=i.GetFixtureA(),o=i.GetFixtureB();n!=this&&o!=this||i.SetSensor(n.IsSensor()||o.IsSensor()),e=e.next}},A.prototype.IsSensor=function(){return this.m_isSensor},A.prototype.SetFilterData=function(t){if(this.m_filter=t.Copy(),!this.m_body)for(var e=this.m_body.GetContactList();e;){var i=e.contact,n=i.GetFixtureA(),o=i.GetFixtureB();n!=this&&o!=this||i.FlagForFiltering(),e=e.next}},A.prototype.GetFilterData=function(){return this.m_filter.Copy()},A.prototype.GetBody=function(){return this.m_body},A.prototype.GetNext=function(){return this.m_next},A.prototype.GetUserData=function(){return this.m_userData},A.prototype.SetUserData=function(t){this.m_userData=t},A.prototype.TestPoint=function(t){return this.m_shape.TestPoint(this.m_body.GetTransform(),t)},A.prototype.RayCast=function(t,e){return this.m_shape.RayCast(t,e,this.m_body.GetTransform())},A.prototype.GetMassData=function(t){return void 0===t&&(t=null),null==t&&(t=new y),this.m_shape.ComputeMass(t,this.m_density),t},A.prototype.SetDensity=function(t){void 0===t&&(t=0),this.m_density=t},A.prototype.GetDensity=function(){return this.m_density},A.prototype.GetFriction=function(){return this.m_friction},A.prototype.SetFriction=function(t){void 0===t&&(t=0),this.m_friction=t},A.prototype.GetRestitution=function(){return this.m_restitution},A.prototype.SetRestitution=function(t){void 0===t&&(t=0),this.m_restitution=t},A.prototype.GetAABB=function(){return this.m_aabb},A.prototype.b2Fixture=function(){this.m_aabb=new r,this.m_userData=null,this.m_body=null,this.m_next=null,this.m_shape=null,this.m_density=0,this.m_friction=0,this.m_restitution=0},A.prototype.Create=function(t,e,i){this.m_userData=i.userData,this.m_friction=i.friction,this.m_restitution=i.restitution,this.m_body=t,this.m_next=null,this.m_filter=i.filter.Copy(),this.m_isSensor=i.isSensor,this.m_shape=i.shape.Copy(),this.m_density=i.density},A.prototype.Destroy=function(){this.m_shape=null},A.prototype.CreateProxy=function(t,e){this.m_shape.ComputeAABB(this.m_aabb,e),this.m_proxy=t.CreateProxy(this.m_aabb,this)},A.prototype.DestroyProxy=function(t){null!=this.m_proxy&&(t.DestroyProxy(this.m_proxy),this.m_proxy=null)},A.prototype.Synchronize=function(e,i,n){if(this.m_proxy){var o=new r,s=new r;this.m_shape.ComputeAABB(o,i),this.m_shape.ComputeAABB(s,n),this.m_aabb.Combine(o,s);var a=t.SubtractVV(n.position,i.position);e.MoveProxy(this.m_proxy,this.m_aabb,a)}},M.b2FixtureDef=function(){this.filter=new S},M.prototype.b2FixtureDef=function(){this.shape=null,this.userData=null,this.friction=.2,this.restitution=0,this.density=0,this.filter.categoryBits=1,this.filter.maskBits=65535,this.filter.groupIndex=0,this.isSensor=!1},k.b2Island=function(){},k.prototype.b2Island=function(){this.m_bodies=new Et,this.m_contacts=new Et,this.m_joints=new Et},k.prototype.Initialize=function(t,e,i,n,o,s){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0);var r=0;for(this.m_bodyCapacity=t,this.m_contactCapacity=e,this.m_jointCapacity=i,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_allocator=n,this.m_listener=o,this.m_contactSolver=s,r=this.m_bodies.length;r<t;r++)this.m_bodies[r]=null;for(r=this.m_contacts.length;r<e;r++)this.m_contacts[r]=null;for(r=this.m_joints.length;r<i;r++)this.m_joints[r]=null},k.prototype.Clear=function(){this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0},k.prototype.Solve=function(e,i,n){var o,r=0,a=0;for(r=0;r<this.m_bodyCount;++r)(o=this.m_bodies[r]).GetType()==f.b2_dynamicBody&&(o.m_linearVelocity.x+=e.dt*(i.x+o.m_invMass*o.m_force.x),o.m_linearVelocity.y+=e.dt*(i.y+o.m_invMass*o.m_force.y),o.m_angularVelocity+=e.dt*o.m_invI*o.m_torque,o.m_linearVelocity.Multiply(t.Clamp(1-e.dt*o.m_linearDamping,0,1)),o.m_angularVelocity*=t.Clamp(1-e.dt*o.m_angularDamping,0,1));this.m_contactSolver.Initialize(e,this.m_contacts,this.m_contactCount,this.m_allocator);var l=this.m_contactSolver;for(l.InitVelocityConstraints(e),r=0;r<this.m_jointCount;++r)this.m_joints[r].InitVelocityConstraints(e);for(r=0;r<e.velocityIterations;++r){for(a=0;a<this.m_jointCount;++a)this.m_joints[a].SolveVelocityConstraints(e);l.SolveVelocityConstraints()}for(r=0;r<this.m_jointCount;++r)this.m_joints[r].FinalizeVelocityConstraints();for(l.FinalizeVelocityConstraints(),r=0;r<this.m_bodyCount;++r)if((o=this.m_bodies[r]).GetType()!=f.b2_staticBody){var c=e.dt*o.m_linearVelocity.x,h=e.dt*o.m_linearVelocity.y;c*c+h*h>s.b2_maxTranslationSquared&&(o.m_linearVelocity.Normalize(),o.m_linearVelocity.x*=s.b2_maxTranslation*e.inv_dt,o.m_linearVelocity.y*=s.b2_maxTranslation*e.inv_dt);var u=e.dt*o.m_angularVelocity;u*u>s.b2_maxRotationSquared&&(o.m_angularVelocity<0?o.m_angularVelocity=-s.b2_maxRotation*e.inv_dt:o.m_angularVelocity=s.b2_maxRotation*e.inv_dt),o.m_sweep.c0.SetV(o.m_sweep.c),o.m_sweep.a0=o.m_sweep.a,o.m_sweep.c.x+=e.dt*o.m_linearVelocity.x,o.m_sweep.c.y+=e.dt*o.m_linearVelocity.y,o.m_sweep.a+=e.dt*o.m_angularVelocity,o.SynchronizeTransform()}for(r=0;r<e.positionIterations;++r){var m=l.SolvePositionConstraints(s.b2_contactBaumgarte),y=!0;for(a=0;a<this.m_jointCount;++a){var p=this.m_joints[a].SolvePositionConstraints(s.b2_contactBaumgarte);y=y&&p}if(m&&y)break}if(this.Report(l.m_constraints),n){var d=Number.MAX_VALUE,_=s.b2_linearSleepTolerance*s.b2_linearSleepTolerance,v=s.b2_angularSleepTolerance*s.b2_angularSleepTolerance;for(r=0;r<this.m_bodyCount;++r)(o=this.m_bodies[r]).GetType()!=f.b2_staticBody&&(o.m_flags&f.e_allowSleepFlag||(o.m_sleepTime=0,d=0),!(o.m_flags&f.e_allowSleepFlag)||o.m_angularVelocity*o.m_angularVelocity>v||t.Dot(o.m_linearVelocity,o.m_linearVelocity)>_?(o.m_sleepTime=0,d=0):(o.m_sleepTime+=e.dt,d=t.Min(d,o.m_sleepTime)));if(d>=s.b2_timeToSleep)for(r=0;r<this.m_bodyCount;++r)(o=this.m_bodies[r]).SetAwake(!1)}},k.prototype.SolveTOI=function(t){var e=0,i=0;this.m_contactSolver.Initialize(t,this.m_contacts,this.m_contactCount,this.m_allocator);var n=this.m_contactSolver;for(e=0;e<this.m_jointCount;++e)this.m_joints[e].InitVelocityConstraints(t);for(e=0;e<t.velocityIterations;++e)for(n.SolveVelocityConstraints(),i=0;i<this.m_jointCount;++i)this.m_joints[i].SolveVelocityConstraints(t);for(e=0;e<this.m_bodyCount;++e){var o=this.m_bodies[e];if(o.GetType()!=f.b2_staticBody){var r=t.dt*o.m_linearVelocity.x,a=t.dt*o.m_linearVelocity.y;r*r+a*a>s.b2_maxTranslationSquared&&(o.m_linearVelocity.Normalize(),o.m_linearVelocity.x*=s.b2_maxTranslation*t.inv_dt,o.m_linearVelocity.y*=s.b2_maxTranslation*t.inv_dt);var l=t.dt*o.m_angularVelocity;l*l>s.b2_maxRotationSquared&&(o.m_angularVelocity<0?o.m_angularVelocity=-s.b2_maxRotation*t.inv_dt:o.m_angularVelocity=s.b2_maxRotation*t.inv_dt),o.m_sweep.c0.SetV(o.m_sweep.c),o.m_sweep.a0=o.m_sweep.a,o.m_sweep.c.x+=t.dt*o.m_linearVelocity.x,o.m_sweep.c.y+=t.dt*o.m_linearVelocity.y,o.m_sweep.a+=t.dt*o.m_angularVelocity,o.SynchronizeTransform()}}for(e=0;e<t.positionIterations;++e){var c=n.SolvePositionConstraints(.75),h=!0;for(i=0;i<this.m_jointCount;++i){var u=this.m_joints[i].SolvePositionConstraints(s.b2_contactBaumgarte);h=h&&u}if(c&&h)break}this.Report(n.m_constraints)},k.prototype.Report=function(t){if(null!=this.m_listener)for(var e=0;e<this.m_contactCount;++e){for(var i=this.m_contacts[e],n=t[e],o=0;o<n.pointCount;++o)k.s_impulse.normalImpulses[o]=n.points[o].normalImpulse,k.s_impulse.tangentImpulses[o]=n.points[o].tangentImpulse;this.m_listener.PostSolve(i,k.s_impulse)}},k.prototype.AddBody=function(t){t.m_islandIndex=this.m_bodyCount,this.m_bodies[this.m_bodyCount++]=t},k.prototype.AddContact=function(t){this.m_contacts[this.m_contactCount++]=t},k.prototype.AddJoint=function(t){this.m_joints[this.m_jointCount++]=t},Pt.postDefs.push(function(){Pt.Dynamics.b2Island.s_impulse=new g}),D.b2TimeStep=function(){},D.prototype.Set=function(t){this.dt=t.dt,this.inv_dt=t.inv_dt,this.positionIterations=t.positionIterations,this.velocityIterations=t.velocityIterations,this.warmStarting=t.warmStarting},I.b2World=function(){this.s_stack=new Et,this.m_contactManager=new x,this.m_contactSolver=new V,this.m_island=new k},I.prototype.b2World=function(t,e){this.m_destructionListener=null,this.m_debugDraw=null,this.m_bodyList=null,this.m_contactList=null,this.m_jointList=null,this.m_controllerList=null,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_controllerCount=0,I.m_warmStarting=!0,I.m_continuousPhysics=!0,this.m_allowSleep=e,this.m_gravity=t,this.m_inv_dt0=0,this.m_contactManager.m_world=this;var i=new _;this.m_groundBody=this.CreateBody(i)},I.prototype.SetDestructionListener=function(t){this.m_destructionListener=t},I.prototype.SetContactFilter=function(t){this.m_contactManager.m_contactFilter=t},I.prototype.SetContactListener=function(t){this.m_contactManager.m_contactListener=t},I.prototype.SetDebugDraw=function(t){this.m_debugDraw=t},I.prototype.SetBroadPhase=function(t){var e=this.m_contactManager.m_broadPhase;this.m_contactManager.m_broadPhase=t;for(var i=this.m_bodyList;i;i=i.m_next)for(var n=i.m_fixtureList;n;n=n.m_next)n.m_proxy=t.CreateProxy(e.GetFatAABB(n.m_proxy),n)},I.prototype.Validate=function(){this.m_contactManager.m_broadPhase.Validate()},I.prototype.GetProxyCount=function(){return this.m_contactManager.m_broadPhase.GetProxyCount()},I.prototype.CreateBody=function(t){if(1==this.IsLocked())return null;var e=new f(t,this);return e.m_prev=null,e.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=e),this.m_bodyList=e,++this.m_bodyCount,e},I.prototype.DestroyBody=function(t){if(1!=this.IsLocked()){for(var e=t.m_jointList;e;){var i=e;e=e.next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeJoint(i.joint),this.DestroyJoint(i.joint)}for(var n=t.m_controllerList;n;){var o=n;n=n.nextController,o.controller.RemoveBody(t)}for(var s=t.m_contactList;s;){var r=s;s=s.next,this.m_contactManager.Destroy(r.contact)}t.m_contactList=null;for(var a=t.m_fixtureList;a;){var l=a;a=a.m_next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeFixture(l),l.DestroyProxy(this.m_contactManager.m_broadPhase),l.Destroy()}t.m_fixtureList=null,t.m_fixtureCount=0,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_bodyList&&(this.m_bodyList=t.m_next),--this.m_bodyCount}},I.prototype.CreateJoint=function(t){var e=T.Create(t,null);e.m_prev=null,e.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=e),this.m_jointList=e,++this.m_jointCount,e.m_edgeA.joint=e,e.m_edgeA.other=e.m_bodyB,e.m_edgeA.prev=null,e.m_edgeA.next=e.m_bodyA.m_jointList,e.m_bodyA.m_jointList&&(e.m_bodyA.m_jointList.prev=e.m_edgeA),e.m_bodyA.m_jointList=e.m_edgeA,e.m_edgeB.joint=e,e.m_edgeB.other=e.m_bodyA,e.m_edgeB.prev=null,e.m_edgeB.next=e.m_bodyB.m_jointList,e.m_bodyB.m_jointList&&(e.m_bodyB.m_jointList.prev=e.m_edgeB),e.m_bodyB.m_jointList=e.m_edgeB;var i=t.bodyA,n=t.bodyB;if(0==t.collideConnected)for(var o=n.GetContactList();o;)o.other==i&&o.contact.FlagForFiltering(),o=o.next;return e},I.prototype.DestroyJoint=function(t){var e=t.m_collideConnected;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_jointList&&(this.m_jointList=t.m_next);var i=t.m_bodyA,n=t.m_bodyB;if(i.SetAwake(!0),n.SetAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA==i.m_jointList&&(i.m_jointList=t.m_edgeA.next),t.m_edgeA.prev=null,t.m_edgeA.next=null,t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB==n.m_jointList&&(n.m_jointList=t.m_edgeB.next),t.m_edgeB.prev=null,t.m_edgeB.next=null,T.Destroy(t,null),--this.m_jointCount,0==e)for(var o=n.GetContactList();o;)o.other==i&&o.contact.FlagForFiltering(),o=o.next},I.prototype.AddController=function(t){return t.m_next=this.m_controllerList,t.m_prev=null,this.m_controllerList=t,t.m_world=this,this.m_controllerCount++,t},I.prototype.RemoveController=function(t){t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),this.m_controllerList==t&&(this.m_controllerList=t.m_next),this.m_controllerCount--},I.prototype.CreateController=function(t){if(t.m_world!=this)throw new Error("Controller can only be a member of one world");return t.m_next=this.m_controllerList,t.m_prev=null,this.m_controllerList&&(this.m_controllerList.m_prev=t),this.m_controllerList=t,++this.m_controllerCount,t.m_world=this,t},I.prototype.DestroyController=function(t){t.Clear(),t.m_next&&(t.m_next.m_prev=t.m_prev),t.m_prev&&(t.m_prev.m_next=t.m_next),t==this.m_controllerList&&(this.m_controllerList=t.m_next),--this.m_controllerCount},I.prototype.SetWarmStarting=function(t){I.m_warmStarting=t},I.prototype.SetContinuousPhysics=function(t){I.m_continuousPhysics=t},I.prototype.GetBodyCount=function(){return this.m_bodyCount},I.prototype.GetJointCount=function(){return this.m_jointCount},I.prototype.GetContactCount=function(){return this.m_contactCount},I.prototype.SetGravity=function(t){this.m_gravity=t},I.prototype.GetGravity=function(){return this.m_gravity},I.prototype.GetGroundBody=function(){return this.m_groundBody},I.prototype.Step=function(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.m_flags&I.e_newFixture&&(this.m_contactManager.FindNewContacts(),this.m_flags&=~I.e_newFixture),this.m_flags|=I.e_locked;var n=I.s_timestep2;n.dt=t,n.velocityIterations=e,n.positionIterations=i,n.inv_dt=t>0?1/t:0,n.dtRatio=this.m_inv_dt0*t,n.warmStarting=I.m_warmStarting,this.m_contactManager.Collide(),n.dt>0&&this.Solve(n),I.m_continuousPhysics&&n.dt>0&&this.SolveTOI(n),n.dt>0&&(this.m_inv_dt0=n.inv_dt),this.m_flags&=~I.e_locked},I.prototype.ClearForces=function(){for(var t=this.m_bodyList;t;t=t.m_next)t.m_force.SetZero(),t.m_torque=0},I.prototype.DrawDebugData=function(){if(null!=this.m_debugDraw){this.m_debugDraw.m_sprite.graphics.clear();var t,e,i,s,a,l,c=this.m_debugDraw.GetFlags();new n,new n,new n,new r,new r;var h=[new n,new n,new n,new n],u=new o(0,0,0);if(c&w.e_shapeBit)for(t=this.m_bodyList;t;t=t.m_next)for(l=t.m_xf,e=t.GetFixtureList();e;e=e.m_next)i=e.GetShape(),0==t.IsActive()?(u.Set(.5,.5,.3),this.DrawShape(i,l,u)):t.GetType()==f.b2_staticBody?(u.Set(.5,.9,.5),this.DrawShape(i,l,u)):t.GetType()==f.b2_kinematicBody?(u.Set(.5,.5,.9),this.DrawShape(i,l,u)):0==t.IsAwake()?(u.Set(.6,.6,.6),this.DrawShape(i,l,u)):(u.Set(.9,.7,.7),this.DrawShape(i,l,u));if(c&w.e_jointBit)for(s=this.m_jointList;s;s=s.m_next)this.DrawJoint(s);if(c&w.e_controllerBit)for(var m=this.m_controllerList;m;m=m.m_next)m.Draw(this.m_debugDraw);if(c&w.e_pairBit){u.Set(.3,.9,.9);for(var y=this.m_contactManager.m_contactList;y;y=y.GetNext()){var p=y.GetFixtureA(),d=y.GetFixtureB(),_=p.GetAABB().GetCenter(),v=d.GetAABB().GetCenter();this.m_debugDraw.DrawSegment(_,v,u)}}if(c&w.e_aabbBit)for(a=this.m_contactManager.m_broadPhase,h=[new n,new n,new n,new n],t=this.m_bodyList;t;t=t.GetNext())if(0!=t.IsActive())for(e=t.GetFixtureList();e;e=e.GetNext()){var g=a.GetFatAABB(e.m_proxy);h[0].Set(g.lowerBound.x,g.lowerBound.y),h[1].Set(g.upperBound.x,g.lowerBound.y),h[2].Set(g.upperBound.x,g.upperBound.y),h[3].Set(g.lowerBound.x,g.upperBound.y),this.m_debugDraw.DrawPolygon(h,4,u)}if(c&w.e_centerOfMassBit)for(t=this.m_bodyList;t;t=t.m_next)(l=I.s_xf).R=t.m_xf.R,l.position=t.GetWorldCenter(),this.m_debugDraw.DrawTransform(l)}},I.prototype.QueryAABB=function(t,e){var i=this.m_contactManager.m_broadPhase;i.Query(function(e){return t(i.GetUserData(e))},e)},I.prototype.QueryShape=function(t,e,n){void 0===n&&(n=null),null==n&&(n=new i).SetIdentity();var o=this.m_contactManager.m_broadPhase,s=new r;e.ComputeAABB(s,n),o.Query(function(i){var s=o.GetUserData(i)instanceof A?o.GetUserData(i):null;return!d.TestOverlap(e,n,s.GetShape(),s.GetBody().GetTransform())||t(s)},s)},I.prototype.QueryPoint=function(t,e){var i=this.m_contactManager.m_broadPhase,n=new r;n.lowerBound.Set(e.x-s.b2_linearSlop,e.y-s.b2_linearSlop),n.upperBound.Set(e.x+s.b2_linearSlop,e.y+s.b2_linearSlop),i.Query(function(n){var o=i.GetUserData(n)instanceof A?i.GetUserData(n):null;return!o.TestPoint(e)||t(o)},n)},I.prototype.RayCast=function(t,e,i){var o=this.m_contactManager.m_broadPhase,s=new h,r=new c(e,i);o.RayCast(function(r,a){var l=o.GetUserData(a),c=l instanceof A?l:null;if(c.RayCast(s,r)){var h=s.fraction,u=new n((1-h)*e.x+h*i.x,(1-h)*e.y+h*i.y);return t(c,u,s.normal,h)}return r.maxFraction},r)},I.prototype.RayCastOne=function(t,e){var i;return this.RayCast(function(t,e,n,o){return void 0===o&&(o=0),i=t,o},t,e),i},I.prototype.RayCastAll=function(t,e){var i=new Et;return this.RayCast(function(t,e,n,o){return i[i.length]=t,1},t,e),i},I.prototype.GetBodyList=function(){return this.m_bodyList},I.prototype.GetJointList=function(){return this.m_jointList},I.prototype.GetContactList=function(){return this.m_contactList},I.prototype.IsLocked=function(){return(this.m_flags&I.e_locked)>0},I.prototype.Solve=function(t){for(var e,i=this.m_controllerList;i;i=i.m_next)i.Step(t);var n=this.m_island;for(n.Initialize(this.m_bodyCount,this.m_contactCount,this.m_jointCount,null,this.m_contactManager.m_contactListener,this.m_contactSolver),e=this.m_bodyList;e;e=e.m_next)e.m_flags&=~f.e_islandFlag;for(var o=this.m_contactList;o;o=o.m_next)o.m_flags&=~B.e_islandFlag;for(var s=this.m_jointList;s;s=s.m_next)s.m_islandFlag=!1;parseInt(this.m_bodyCount);for(var r=this.s_stack,a=this.m_bodyList;a;a=a.m_next)if(!(a.m_flags&f.e_islandFlag)&&0!=a.IsAwake()&&0!=a.IsActive()&&a.GetType()!=f.b2_staticBody){n.Clear();var l=0;for(r[l++]=a,a.m_flags|=f.e_islandFlag;l>0;)if(e=r[--l],n.AddBody(e),0==e.IsAwake()&&e.SetAwake(!0),e.GetType()!=f.b2_staticBody){for(var c,h=e.m_contactList;h;h=h.next)h.contact.m_flags&B.e_islandFlag||1!=h.contact.IsSensor()&&0!=h.contact.IsEnabled()&&0!=h.contact.IsTouching()&&(n.AddContact(h.contact),h.contact.m_flags|=B.e_islandFlag,(c=h.other).m_flags&f.e_islandFlag||(r[l++]=c,c.m_flags|=f.e_islandFlag));for(var u=e.m_jointList;u;u=u.next)1!=u.joint.m_islandFlag&&0!=(c=u.other).IsActive()&&(n.AddJoint(u.joint),u.joint.m_islandFlag=!0,c.m_flags&f.e_islandFlag||(r[l++]=c,c.m_flags|=f.e_islandFlag))}n.Solve(t,this.m_gravity,this.m_allowSleep);for(var m=0;m<n.m_bodyCount;++m)(e=n.m_bodies[m]).GetType()==f.b2_staticBody&&(e.m_flags&=~f.e_islandFlag)}for(m=0;m<r.length&&r[m];++m)r[m]=null;for(e=this.m_bodyList;e;e=e.m_next)0!=e.IsAwake()&&0!=e.IsActive()&&e.GetType()!=f.b2_staticBody&&e.SynchronizeFixtures();this.m_contactManager.FindNewContacts()},I.prototype.SolveTOI=function(t){var e,i,n,o,r,a,l,c=this.m_island;c.Initialize(this.m_bodyCount,s.b2_maxTOIContactsPerIsland,s.b2_maxTOIJointsPerIsland,null,this.m_contactManager.m_contactListener,this.m_contactSolver);var h,u=I.s_queue;for(e=this.m_bodyList;e;e=e.m_next)e.m_flags&=~f.e_islandFlag,e.m_sweep.t0=0;for(h=this.m_contactList;h;h=h.m_next)h.m_flags&=~(B.e_toiFlag|B.e_islandFlag);for(l=this.m_jointList;l;l=l.m_next)l.m_islandFlag=!1;for(;;){var m=null,y=1;for(h=this.m_contactList;h;h=h.m_next)if(1!=h.IsSensor()&&0!=h.IsEnabled()&&0!=h.IsContinuous()){var p=1;if(h.m_flags&B.e_toiFlag)p=h.m_toi;else{if(i=h.m_fixtureA,n=h.m_fixtureB,o=i.m_body,r=n.m_body,!(o.GetType()==f.b2_dynamicBody&&0!=o.IsAwake()||r.GetType()==f.b2_dynamicBody&&0!=r.IsAwake()))continue;var d=o.m_sweep.t0;o.m_sweep.t0<r.m_sweep.t0?(d=r.m_sweep.t0,o.m_sweep.Advance(d)):r.m_sweep.t0<o.m_sweep.t0&&(d=o.m_sweep.t0,r.m_sweep.Advance(d)),p=h.ComputeTOI(o.m_sweep,r.m_sweep),s.b2Assert(0<=p&&p<=1),p>0&&p<1&&(p=(1-p)*d+p)>1&&(p=1),h.m_toi=p,h.m_flags|=B.e_toiFlag}Number.MIN_VALUE<p&&p<y&&(m=h,y=p)}if(null==m||1-100*Number.MIN_VALUE<y)break;if(i=m.m_fixtureA,n=m.m_fixtureB,o=i.m_body,r=n.m_body,I.s_backupA.Set(o.m_sweep),I.s_backupB.Set(r.m_sweep),o.Advance(y),r.Advance(y),m.Update(this.m_contactManager.m_contactListener),m.m_flags&=~B.e_toiFlag,1!=m.IsSensor()&&0!=m.IsEnabled()){if(0!=m.IsTouching()){var _=o;_.GetType()!=f.b2_dynamicBody&&(_=r),c.Clear();var v=0,g=0;for(u[v+g++]=_,_.m_flags|=f.e_islandFlag;g>0;)if(e=u[v++],--g,c.AddBody(e),0==e.IsAwake()&&e.SetAwake(!0),e.GetType()==f.b2_dynamicBody){for(a=e.m_contactList;a&&c.m_contactCount!=c.m_contactCapacity;a=a.next)if(!(a.contact.m_flags&B.e_islandFlag)&&1!=a.contact.IsSensor()&&0!=a.contact.IsEnabled()&&0!=a.contact.IsTouching()){c.AddContact(a.contact),a.contact.m_flags|=B.e_islandFlag;var b=a.other;b.m_flags&f.e_islandFlag||(b.GetType()!=f.b2_staticBody&&(b.Advance(y),b.SetAwake(!0)),u[v+g]=b,++g,b.m_flags|=f.e_islandFlag)}for(var x=e.m_jointList;x;x=x.next)c.m_jointCount!=c.m_jointCapacity&&1!=x.joint.m_islandFlag&&0!=(b=x.other).IsActive()&&(c.AddJoint(x.joint),x.joint.m_islandFlag=!0,b.m_flags&f.e_islandFlag||(b.GetType()!=f.b2_staticBody&&(b.Advance(y),b.SetAwake(!0)),u[v+g]=b,++g,b.m_flags|=f.e_islandFlag))}var w=I.s_timestep;w.warmStarting=!1,w.dt=(1-y)*t.dt,w.inv_dt=1/w.dt,w.dtRatio=0,w.velocityIterations=t.velocityIterations,w.positionIterations=t.positionIterations,c.SolveTOI(w);var C=0;for(C=0;C<c.m_bodyCount;++C)if((e=c.m_bodies[C]).m_flags&=~f.e_islandFlag,0!=e.IsAwake()&&e.GetType()==f.b2_dynamicBody)for(e.SynchronizeFixtures(),a=e.m_contactList;a;a=a.next)a.contact.m_flags&=~B.e_toiFlag;for(C=0;C<c.m_contactCount;++C)(h=c.m_contacts[C]).m_flags&=~(B.e_toiFlag|B.e_islandFlag);for(C=0;C<c.m_jointCount;++C)(l=c.m_joints[C]).m_islandFlag=!1;this.m_contactManager.FindNewContacts()}}else o.m_sweep.Set(I.s_backupA),r.m_sweep.Set(I.s_backupB),o.SynchronizeTransform(),r.SynchronizeTransform()}},I.prototype.DrawJoint=function(t){var e=t.GetBodyA(),i=t.GetBodyB(),n=e.m_xf,o=i.m_xf,s=n.position,r=o.position,a=t.GetAnchorA(),l=t.GetAnchorB(),c=I.s_jointColor;switch(t.m_type){case T.e_distanceJoint:this.m_debugDraw.DrawSegment(a,l,c);break;case T.e_pulleyJoint:var h=t instanceof E?t:null,u=h.GetGroundAnchorA(),m=h.GetGroundAnchorB();this.m_debugDraw.DrawSegment(u,a,c),this.m_debugDraw.DrawSegment(m,l,c),this.m_debugDraw.DrawSegment(u,m,c);break;case T.e_mouseJoint:this.m_debugDraw.DrawSegment(a,l,c);break;default:e!=this.m_groundBody&&this.m_debugDraw.DrawSegment(s,a,c),this.m_debugDraw.DrawSegment(a,l,c),i!=this.m_groundBody&&this.m_debugDraw.DrawSegment(r,l,c)}},I.prototype.DrawShape=function(e,i,n){switch(e.m_type){case d.e_circleShape:var o=e instanceof u?e:null,s=t.MulX(i,o.m_p),r=o.m_radius,a=i.R.col1;this.m_debugDraw.DrawSolidCircle(s,r,a,n);break;case d.e_polygonShape:var l=0,c=e instanceof p?e:null,h=parseInt(c.GetVertexCount()),y=c.GetVertices(),f=new Et(h);for(l=0;l<h;++l)f[l]=t.MulX(i,y[l]);this.m_debugDraw.DrawSolidPolygon(f,h,n);break;case d.e_edgeShape:var _=e instanceof m?e:null;this.m_debugDraw.DrawSegment(t.MulX(i,_.GetVertex1()),t.MulX(i,_.GetVertex2()),n)}},Pt.postDefs.push(function(){Pt.Dynamics.b2World.s_timestep2=new D,Pt.Dynamics.b2World.s_xf=new i,Pt.Dynamics.b2World.s_backupA=new e,Pt.Dynamics.b2World.s_backupB=new e,Pt.Dynamics.b2World.s_timestep=new D,Pt.Dynamics.b2World.s_queue=new Et,Pt.Dynamics.b2World.s_jointColor=new o(.5,.8,.8),Pt.Dynamics.b2World.e_newFixture=1,Pt.Dynamics.b2World.e_locked=2})}(),function(){var t=Pt.Collision.Shapes.b2CircleShape;Pt.Collision.Shapes.b2EdgeChainDef;var e=Pt.Collision.Shapes.b2EdgeShape;Pt.Collision.Shapes.b2MassData;var i=Pt.Collision.Shapes.b2PolygonShape,n=Pt.Collision.Shapes.b2Shape,o=Pt.Dynamics.Contacts.b2CircleContact,s=Pt.Dynamics.Contacts.b2Contact,r=Pt.Dynamics.Contacts.b2ContactConstraint,a=Pt.Dynamics.Contacts.b2ContactConstraintPoint,l=Pt.Dynamics.Contacts.b2ContactEdge,c=Pt.Dynamics.Contacts.b2ContactFactory,h=Pt.Dynamics.Contacts.b2ContactRegister,u=Pt.Dynamics.Contacts.b2ContactResult,m=Pt.Dynamics.Contacts.b2ContactSolver,y=Pt.Dynamics.Contacts.b2EdgeAndCircleContact,p=Pt.Dynamics.Contacts.b2NullContact,d=Pt.Dynamics.Contacts.b2PolyAndCircleContact,f=Pt.Dynamics.Contacts.b2PolyAndEdgeContact,_=Pt.Dynamics.Contacts.b2PolygonContact,v=Pt.Dynamics.Contacts.b2PositionSolverManifold,g=Pt.Dynamics.b2Body;Pt.Dynamics.b2BodyDef,Pt.Dynamics.b2ContactFilter,Pt.Dynamics.b2ContactImpulse,Pt.Dynamics.b2ContactListener,Pt.Dynamics.b2ContactManager,Pt.Dynamics.b2DebugDraw,Pt.Dynamics.b2DestructionListener,Pt.Dynamics.b2FilterData,Pt.Dynamics.b2Fixture,Pt.Dynamics.b2FixtureDef,Pt.Dynamics.b2Island;var b=Pt.Dynamics.b2TimeStep;Pt.Dynamics.b2World,Pt.Common.b2Color,Pt.Common.b2internal;var x=Pt.Common.b2Settings,w=Pt.Common.Math.b2Mat22;Pt.Common.Math.b2Mat33;var C=Pt.Common.Math.b2Math;Pt.Common.Math.b2Sweep,Pt.Common.Math.b2Transform;var S=Pt.Common.Math.b2Vec2;Pt.Common.Math.b2Vec3,Pt.Collision.b2AABB,Pt.Collision.b2Bound,Pt.Collision.b2BoundValues;var A=Pt.Collision.b2Collision,M=Pt.Collision.b2ContactID;Pt.Collision.b2ContactPoint,Pt.Collision.b2Distance,Pt.Collision.b2DistanceInput,Pt.Collision.b2DistanceOutput,Pt.Collision.b2DistanceProxy,Pt.Collision.b2DynamicTree,Pt.Collision.b2DynamicTreeBroadPhase,Pt.Collision.b2DynamicTreeNode,Pt.Collision.b2DynamicTreePair;var k=Pt.Collision.b2Manifold;Pt.Collision.b2ManifoldPoint,Pt.Collision.b2Point,Pt.Collision.b2RayCastInput,Pt.Collision.b2RayCastOutput,Pt.Collision.b2Segment,Pt.Collision.b2SeparationFunction,Pt.Collision.b2Simplex,Pt.Collision.b2SimplexCache,Pt.Collision.b2SimplexVertex;var D=Pt.Collision.b2TimeOfImpact,I=Pt.Collision.b2TOIInput,B=Pt.Collision.b2WorldManifold;Pt.Collision.ClipVertex,Pt.Collision.Features,Pt.Collision.IBroadPhase,Pt.inherit(o,Pt.Dynamics.Contacts.b2Contact),o.prototype.__super=Pt.Dynamics.Contacts.b2Contact.prototype,o.b2CircleContact=function(){Pt.Dynamics.Contacts.b2Contact.b2Contact.apply(this,arguments)},o.Create=function(t){return new o},o.Destroy=function(t,e){},o.prototype.Reset=function(t,e){this.__super.Reset.call(this,t,e)},o.prototype.Evaluate=function(){var e=this.m_fixtureA.GetBody(),i=this.m_fixtureB.GetBody();A.CollideCircles(this.m_manifold,this.m_fixtureA.GetShape()instanceof t?this.m_fixtureA.GetShape():null,e.m_xf,this.m_fixtureB.GetShape()instanceof t?this.m_fixtureB.GetShape():null,i.m_xf)},s.b2Contact=function(){this.m_nodeA=new l,this.m_nodeB=new l,this.m_manifold=new k,this.m_oldManifold=new k},s.prototype.GetManifold=function(){return this.m_manifold},s.prototype.GetWorldManifold=function(t){var e=this.m_fixtureA.GetBody(),i=this.m_fixtureB.GetBody(),n=this.m_fixtureA.GetShape(),o=this.m_fixtureB.GetShape();t.Initialize(this.m_manifold,e.GetTransform(),n.m_radius,i.GetTransform(),o.m_radius)},s.prototype.IsTouching=function(){return(this.m_flags&s.e_touchingFlag)==s.e_touchingFlag},s.prototype.IsContinuous=function(){return(this.m_flags&s.e_continuousFlag)==s.e_continuousFlag},s.prototype.SetSensor=function(t){t?this.m_flags|=s.e_sensorFlag:this.m_flags&=~s.e_sensorFlag},s.prototype.IsSensor=function(){return(this.m_flags&s.e_sensorFlag)==s.e_sensorFlag},s.prototype.SetEnabled=function(t){t?this.m_flags|=s.e_enabledFlag:this.m_flags&=~s.e_enabledFlag},s.prototype.IsEnabled=function(){return(this.m_flags&s.e_enabledFlag)==s.e_enabledFlag},s.prototype.GetNext=function(){return this.m_next},s.prototype.GetFixtureA=function(){return this.m_fixtureA},s.prototype.GetFixtureB=function(){return this.m_fixtureB},s.prototype.FlagForFiltering=function(){this.m_flags|=s.e_filterFlag},s.prototype.b2Contact=function(){},s.prototype.Reset=function(t,e){if(void 0===t&&(t=null),void 0===e&&(e=null),this.m_flags=s.e_enabledFlag,!t||!e)return this.m_fixtureA=null,void(this.m_fixtureB=null);(t.IsSensor()||e.IsSensor())&&(this.m_flags|=s.e_sensorFlag);var i=t.GetBody(),n=e.GetBody();(i.GetType()!=g.b2_dynamicBody||i.IsBullet()||n.GetType()!=g.b2_dynamicBody||n.IsBullet())&&(this.m_flags|=s.e_continuousFlag),this.m_fixtureA=t,this.m_fixtureB=e,this.m_manifold.m_pointCount=0,this.m_prev=null,this.m_next=null,this.m_nodeA.contact=null,this.m_nodeA.prev=null,this.m_nodeA.next=null,this.m_nodeA.other=null,this.m_nodeB.contact=null,this.m_nodeB.prev=null,this.m_nodeB.next=null,this.m_nodeB.other=null},s.prototype.Update=function(t){var e=this.m_oldManifold;this.m_oldManifold=this.m_manifold,this.m_manifold=e,this.m_flags|=s.e_enabledFlag;var i=!1,o=(this.m_flags&s.e_touchingFlag)==s.e_touchingFlag,r=this.m_fixtureA.m_body,a=this.m_fixtureB.m_body,l=this.m_fixtureA.m_aabb.TestOverlap(this.m_fixtureB.m_aabb);if(this.m_flags&s.e_sensorFlag){if(l){var c=this.m_fixtureA.GetShape(),h=this.m_fixtureB.GetShape(),u=r.GetTransform(),m=a.GetTransform();i=n.TestOverlap(c,u,h,m)}this.m_manifold.m_pointCount=0}else{if(r.GetType()!=g.b2_dynamicBody||r.IsBullet()||a.GetType()!=g.b2_dynamicBody||a.IsBullet()?this.m_flags|=s.e_continuousFlag:this.m_flags&=~s.e_continuousFlag,l){this.Evaluate(),i=this.m_manifold.m_pointCount>0;for(var y=0;y<this.m_manifold.m_pointCount;++y){var p=this.m_manifold.m_points[y];p.m_normalImpulse=0,p.m_tangentImpulse=0;for(var d=p.m_id,f=0;f<this.m_oldManifold.m_pointCount;++f){var _=this.m_oldManifold.m_points[f];if(_.m_id.key==d.key){p.m_normalImpulse=_.m_normalImpulse,p.m_tangentImpulse=_.m_tangentImpulse;break}}}}else this.m_manifold.m_pointCount=0;i!=o&&(r.SetAwake(!0),a.SetAwake(!0))}i?this.m_flags|=s.e_touchingFlag:this.m_flags&=~s.e_touchingFlag,0==o&&1==i&&t.BeginContact(this),1==o&&0==i&&t.EndContact(this),this.m_flags&s.e_sensorFlag||t.PreSolve(this,this.m_oldManifold)},s.prototype.Evaluate=function(){},s.prototype.ComputeTOI=function(t,e){return s.s_input.proxyA.Set(this.m_fixtureA.GetShape()),s.s_input.proxyB.Set(this.m_fixtureB.GetShape()),s.s_input.sweepA=t,s.s_input.sweepB=e,s.s_input.tolerance=x.b2_linearSlop,D.TimeOfImpact(s.s_input)},Pt.postDefs.push(function(){Pt.Dynamics.Contacts.b2Contact.e_sensorFlag=1,Pt.Dynamics.Contacts.b2Contact.e_continuousFlag=2,Pt.Dynamics.Contacts.b2Contact.e_islandFlag=4,Pt.Dynamics.Contacts.b2Contact.e_toiFlag=8,Pt.Dynamics.Contacts.b2Contact.e_touchingFlag=16,Pt.Dynamics.Contacts.b2Contact.e_enabledFlag=32,Pt.Dynamics.Contacts.b2Contact.e_filterFlag=64,Pt.Dynamics.Contacts.b2Contact.s_input=new I}),r.b2ContactConstraint=function(){this.localPlaneNormal=new S,this.localPoint=new S,this.normal=new S,this.normalMass=new w,this.K=new w},r.prototype.b2ContactConstraint=function(){this.points=new Et(x.b2_maxManifoldPoints);for(var t=0;t<x.b2_maxManifoldPoints;t++)this.points[t]=new a},a.b2ContactConstraintPoint=function(){this.localPoint=new S,this.rA=new S,this.rB=new S},l.b2ContactEdge=function(){},c.b2ContactFactory=function(){},c.prototype.b2ContactFactory=function(t){this.m_allocator=t,this.InitializeRegisters()},c.prototype.AddType=function(t,e,i,n){void 0===i&&(i=0),void 0===n&&(n=0),this.m_registers[i][n].createFcn=t,this.m_registers[i][n].destroyFcn=e,this.m_registers[i][n].primary=!0,i!=n&&(this.m_registers[n][i].createFcn=t,this.m_registers[n][i].destroyFcn=e,this.m_registers[n][i].primary=!1)},c.prototype.InitializeRegisters=function(){this.m_registers=new Et(n.e_shapeTypeCount);for(var t=0;t<n.e_shapeTypeCount;t++){this.m_registers[t]=new Et(n.e_shapeTypeCount);for(var e=0;e<n.e_shapeTypeCount;e++)this.m_registers[t][e]=new h}this.AddType(o.Create,o.Destroy,n.e_circleShape,n.e_circleShape),this.AddType(d.Create,d.Destroy,n.e_polygonShape,n.e_circleShape),this.AddType(_.Create,_.Destroy,n.e_polygonShape,n.e_polygonShape),this.AddType(y.Create,y.Destroy,n.e_edgeShape,n.e_circleShape),this.AddType(f.Create,f.Destroy,n.e_polygonShape,n.e_edgeShape)},c.prototype.Create=function(t,e){var i,n=parseInt(t.GetType()),o=parseInt(e.GetType()),s=this.m_registers[n][o];if(s.pool)return i=s.pool,s.pool=i.m_next,s.poolCount--,i.Reset(t,e),i;var r=s.createFcn;return null!=r?s.primary?((i=r(this.m_allocator)).Reset(t,e),i):((i=r(this.m_allocator)).Reset(e,t),i):null},c.prototype.Destroy=function(t){t.m_manifold.m_pointCount>0&&(t.m_fixtureA.m_body.SetAwake(!0),t.m_fixtureB.m_body.SetAwake(!0));var e=parseInt(t.m_fixtureA.GetType()),i=parseInt(t.m_fixtureB.GetType()),n=this.m_registers[e][i];n.poolCount++,t.m_next=n.pool,n.pool=t,(0,n.destroyFcn)(t,this.m_allocator)},h.b2ContactRegister=function(){},u.b2ContactResult=function(){this.position=new S,this.normal=new S,this.id=new M},m.b2ContactSolver=function(){this.m_step=new b,this.m_constraints=new Et},m.prototype.b2ContactSolver=function(){},m.prototype.Initialize=function(t,e,i,n){var o;void 0===i&&(i=0),this.m_step.Set(t),this.m_allocator=n;var s=0;for(this.m_constraintCount=i;this.m_constraints.length<this.m_constraintCount;)this.m_constraints[this.m_constraints.length]=new r;for(s=0;s<i;++s){var a=(o=e[s]).m_fixtureA,l=o.m_fixtureB,c=a.m_shape,h=l.m_shape,u=c.m_radius,y=h.m_radius,p=a.m_body,d=l.m_body,f=o.GetManifold(),_=x.b2MixFriction(a.GetFriction(),l.GetFriction()),v=x.b2MixRestitution(a.GetRestitution(),l.GetRestitution()),g=p.m_linearVelocity.x,b=p.m_linearVelocity.y,w=d.m_linearVelocity.x,C=d.m_linearVelocity.y,S=p.m_angularVelocity,A=d.m_angularVelocity;x.b2Assert(f.m_pointCount>0),m.s_worldManifold.Initialize(f,p.m_xf,u,d.m_xf,y);var M=m.s_worldManifold.m_normal.x,k=m.s_worldManifold.m_normal.y,D=this.m_constraints[s];D.bodyA=p,D.bodyB=d,D.manifold=f,D.normal.x=M,D.normal.y=k,D.pointCount=f.m_pointCount,D.friction=_,D.restitution=v,D.localPlaneNormal.x=f.m_localPlaneNormal.x,D.localPlaneNormal.y=f.m_localPlaneNormal.y,D.localPoint.x=f.m_localPoint.x,D.localPoint.y=f.m_localPoint.y,D.radius=u+y,D.type=f.m_type;for(var I=0;I<D.pointCount;++I){var B=f.m_points[I],P=D.points[I];P.normalImpulse=B.m_normalImpulse,P.tangentImpulse=B.m_tangentImpulse,P.localPoint.SetV(B.m_localPoint);var V=P.rA.x=m.s_worldManifold.m_points[I].x-p.m_sweep.c.x,T=P.rA.y=m.s_worldManifold.m_points[I].y-p.m_sweep.c.y,E=P.rB.x=m.s_worldManifold.m_points[I].x-d.m_sweep.c.x,L=P.rB.y=m.s_worldManifold.m_points[I].y-d.m_sweep.c.y,F=V*k-T*M,G=E*k-L*M;F*=F,G*=G;var R=p.m_invMass+d.m_invMass+p.m_invI*F+d.m_invI*G;P.normalMass=1/R;var J=p.m_mass*p.m_invMass+d.m_mass*d.m_invMass;J+=p.m_mass*p.m_invI*F+d.m_mass*d.m_invI*G,P.equalizedMass=1/J;var O=-M,j=V*O-T*k,z=E*O-L*k;j*=j,z*=z;var X=p.m_invMass+d.m_invMass+p.m_invI*j+d.m_invI*z;P.tangentMass=1/X,P.velocityBias=0;var N=w+-A*L-g- -S*T,W=C+A*E-b-S*V,Y=D.normal.x*N+D.normal.y*W;Y<-x.b2_velocityThreshold&&(P.velocityBias+=-D.restitution*Y)}if(2==D.pointCount){var q=D.points[0],U=D.points[1],K=p.m_invMass,Z=p.m_invI,H=d.m_invMass,Q=d.m_invI,$=q.rA.x*k-q.rA.y*M,tt=q.rB.x*k-q.rB.y*M,et=U.rA.x*k-U.rA.y*M,it=U.rB.x*k-U.rB.y*M,nt=K+H+Z*$*$+Q*tt*tt,ot=K+H+Z*et*et+Q*it*it,st=K+H+Z*$*et+Q*tt*it;nt*nt<100*(nt*ot-st*st)?(D.K.col1.Set(nt,st),D.K.col2.Set(st,ot),D.K.GetInverse(D.normalMass)):D.pointCount=1}}},m.prototype.InitVelocityConstraints=function(t){for(var e=0;e<this.m_constraintCount;++e){var i=this.m_constraints[e],n=i.bodyA,o=i.bodyB,s=n.m_invMass,r=n.m_invI,a=o.m_invMass,l=o.m_invI,c=i.normal.x,h=i.normal.y,u=h,m=-c,y=0,p=0;if(t.warmStarting)for(p=i.pointCount,y=0;y<p;++y){var d=i.points[y];d.normalImpulse*=t.dtRatio,d.tangentImpulse*=t.dtRatio;var f=d.normalImpulse*c+d.tangentImpulse*u,_=d.normalImpulse*h+d.tangentImpulse*m;n.m_angularVelocity-=r*(d.rA.x*_-d.rA.y*f),n.m_linearVelocity.x-=s*f,n.m_linearVelocity.y-=s*_,o.m_angularVelocity+=l*(d.rB.x*_-d.rB.y*f),o.m_linearVelocity.x+=a*f,o.m_linearVelocity.y+=a*_}else for(p=i.pointCount,y=0;y<p;++y){var v=i.points[y];v.normalImpulse=0,v.tangentImpulse=0}}},m.prototype.SolveVelocityConstraints=function(){for(var t,e,i=0,n=0,o=0,s=0,r=0,a=0,l=0,c=0,h=0,u=0,m=0,y=0,p=0,d=0,f=0;f<this.m_constraintCount;++f){var _=this.m_constraints[f],v=_.bodyA,g=_.bodyB,b=v.m_angularVelocity,x=g.m_angularVelocity,w=v.m_linearVelocity,S=g.m_linearVelocity,A=v.m_invMass,M=v.m_invI,k=g.m_invMass,D=g.m_invI,I=_.normal.x,B=_.normal.y,P=B,V=-I,T=_.friction;for(i=0;i<_.pointCount;i++)t=_.points[i],o=(S.x-x*t.rB.y-w.x+b*t.rA.y)*P+(S.y+x*t.rB.x-w.y-b*t.rA.x)*V,s=t.tangentMass*-o,r=T*t.normalImpulse,l=(s=(a=C.Clamp(t.tangentImpulse+s,-r,r))-t.tangentImpulse)*P,c=s*V,w.x-=A*l,w.y-=A*c,b-=M*(t.rA.x*c-t.rA.y*l),S.x+=k*l,S.y+=k*c,x+=D*(t.rB.x*c-t.rB.y*l),t.tangentImpulse=a;if(parseInt(_.pointCount),1==_.pointCount)t=_.points[0],n=(S.x+-x*t.rB.y-w.x- -b*t.rA.y)*I+(S.y+x*t.rB.x-w.y-b*t.rA.x)*B,s=-t.normalMass*(n-t.velocityBias),l=(s=(a=(a=t.normalImpulse+s)>0?a:0)-t.normalImpulse)*I,c=s*B,w.x-=A*l,w.y-=A*c,b-=M*(t.rA.x*c-t.rA.y*l),S.x+=k*l,S.y+=k*c,x+=D*(t.rB.x*c-t.rB.y*l),t.normalImpulse=a;else{var E=_.points[0],L=_.points[1],F=E.normalImpulse,G=L.normalImpulse,R=(S.x-x*E.rB.y-w.x+b*E.rA.y)*I+(S.y+x*E.rB.x-w.y-b*E.rA.x)*B,J=(S.x-x*L.rB.y-w.x+b*L.rA.y)*I+(S.y+x*L.rB.x-w.y-b*L.rA.x)*B,O=R-E.velocityBias,j=J-L.velocityBias;for(O-=(e=_.K).col1.x*F+e.col2.x*G,j-=e.col1.y*F+e.col2.y*G;;){var z=-((e=_.normalMass).col1.x*O+e.col2.x*j),X=-(e.col1.y*O+e.col2.y*j);if(z>=0&&X>=0){m=(h=z-F)*I,y=h*B,p=(u=X-G)*I,d=u*B,w.x-=A*(m+p),w.y-=A*(y+d),b-=M*(E.rA.x*y-E.rA.y*m+L.rA.x*d-L.rA.y*p),S.x+=k*(m+p),S.y+=k*(y+d),x+=D*(E.rB.x*y-E.rB.y*m+L.rB.x*d-L.rB.y*p),E.normalImpulse=z,L.normalImpulse=X;break}if(z=-E.normalMass*O,X=0,R=0,J=_.K.col1.y*z+j,z>=0&&J>=0){m=(h=z-F)*I,y=h*B,p=(u=X-G)*I,d=u*B,w.x-=A*(m+p),w.y-=A*(y+d),b-=M*(E.rA.x*y-E.rA.y*m+L.rA.x*d-L.rA.y*p),S.x+=k*(m+p),S.y+=k*(y+d),x+=D*(E.rB.x*y-E.rB.y*m+L.rB.x*d-L.rB.y*p),E.normalImpulse=z,L.normalImpulse=X;break}if(z=0,X=-L.normalMass*j,R=_.K.col2.x*X+O,J=0,X>=0&&R>=0){m=(h=z-F)*I,y=h*B,p=(u=X-G)*I,d=u*B,w.x-=A*(m+p),w.y-=A*(y+d),b-=M*(E.rA.x*y-E.rA.y*m+L.rA.x*d-L.rA.y*p),S.x+=k*(m+p),S.y+=k*(y+d),x+=D*(E.rB.x*y-E.rB.y*m+L.rB.x*d-L.rB.y*p),E.normalImpulse=z,L.normalImpulse=X;break}if(z=0,X=0,J=j,(R=O)>=0&&J>=0){m=(h=z-F)*I,y=h*B,p=(u=X-G)*I,d=u*B,w.x-=A*(m+p),w.y-=A*(y+d),b-=M*(E.rA.x*y-E.rA.y*m+L.rA.x*d-L.rA.y*p),S.x+=k*(m+p),S.y+=k*(y+d),x+=D*(E.rB.x*y-E.rB.y*m+L.rB.x*d-L.rB.y*p),E.normalImpulse=z,L.normalImpulse=X;break}break}}v.m_angularVelocity=b,g.m_angularVelocity=x}},m.prototype.FinalizeVelocityConstraints=function(){for(var t=0;t<this.m_constraintCount;++t)for(var e=this.m_constraints[t],i=e.manifold,n=0;n<e.pointCount;++n){var o=i.m_points[n],s=e.points[n];o.m_normalImpulse=s.normalImpulse,o.m_tangentImpulse=s.tangentImpulse}},m.prototype.SolvePositionConstraints=function(t){void 0===t&&(t=0);for(var e=0,i=0;i<this.m_constraintCount;i++){var n=this.m_constraints[i],o=n.bodyA,s=n.bodyB,r=o.m_mass*o.m_invMass,a=o.m_mass*o.m_invI,l=s.m_mass*s.m_invMass,c=s.m_mass*s.m_invI;m.s_psm.Initialize(n);for(var h=m.s_psm.m_normal,u=0;u<n.pointCount;u++){var y=n.points[u],p=m.s_psm.m_points[u],d=m.s_psm.m_separations[u],f=p.x-o.m_sweep.c.x,_=p.y-o.m_sweep.c.y,v=p.x-s.m_sweep.c.x,g=p.y-s.m_sweep.c.y;e=e<d?e:d;var b=C.Clamp(t*(d+x.b2_linearSlop),-x.b2_maxLinearCorrection,0),w=-y.equalizedMass*b,S=w*h.x,A=w*h.y;o.m_sweep.c.x-=r*S,o.m_sweep.c.y-=r*A,o.m_sweep.a-=a*(f*A-_*S),o.SynchronizeTransform(),s.m_sweep.c.x+=l*S,s.m_sweep.c.y+=l*A,s.m_sweep.a+=c*(v*A-g*S),s.SynchronizeTransform()}}return e>-1.5*x.b2_linearSlop},Pt.postDefs.push(function(){Pt.Dynamics.Contacts.b2ContactSolver.s_worldManifold=new B,Pt.Dynamics.Contacts.b2ContactSolver.s_psm=new v}),Pt.inherit(y,Pt.Dynamics.Contacts.b2Contact),y.prototype.__super=Pt.Dynamics.Contacts.b2Contact.prototype,y.b2EdgeAndCircleContact=function(){Pt.Dynamics.Contacts.b2Contact.b2Contact.apply(this,arguments)},y.Create=function(t){return new y},y.Destroy=function(t,e){},y.prototype.Reset=function(t,e){this.__super.Reset.call(this,t,e)},y.prototype.Evaluate=function(){var i=this.m_fixtureA.GetBody(),n=this.m_fixtureB.GetBody();this.b2CollideEdgeAndCircle(this.m_manifold,this.m_fixtureA.GetShape()instanceof e?this.m_fixtureA.GetShape():null,i.m_xf,this.m_fixtureB.GetShape()instanceof t?this.m_fixtureB.GetShape():null,n.m_xf)},y.prototype.b2CollideEdgeAndCircle=function(t,e,i,n,o){},Pt.inherit(p,Pt.Dynamics.Contacts.b2Contact),p.prototype.__super=Pt.Dynamics.Contacts.b2Contact.prototype,p.b2NullContact=function(){Pt.Dynamics.Contacts.b2Contact.b2Contact.apply(this,arguments)},p.prototype.b2NullContact=function(){this.__super.b2Contact.call(this)},p.prototype.Evaluate=function(){},Pt.inherit(d,Pt.Dynamics.Contacts.b2Contact),d.prototype.__super=Pt.Dynamics.Contacts.b2Contact.prototype,d.b2PolyAndCircleContact=function(){Pt.Dynamics.Contacts.b2Contact.b2Contact.apply(this,arguments)},d.Create=function(t){return new d},d.Destroy=function(t,e){},d.prototype.Reset=function(t,e){this.__super.Reset.call(this,t,e),x.b2Assert(t.GetType()==n.e_polygonShape),x.b2Assert(e.GetType()==n.e_circleShape)},d.prototype.Evaluate=function(){var e=this.m_fixtureA.m_body,n=this.m_fixtureB.m_body;A.CollidePolygonAndCircle(this.m_manifold,this.m_fixtureA.GetShape()instanceof i?this.m_fixtureA.GetShape():null,e.m_xf,this.m_fixtureB.GetShape()instanceof t?this.m_fixtureB.GetShape():null,n.m_xf)},Pt.inherit(f,Pt.Dynamics.Contacts.b2Contact),f.prototype.__super=Pt.Dynamics.Contacts.b2Contact.prototype,f.b2PolyAndEdgeContact=function(){Pt.Dynamics.Contacts.b2Contact.b2Contact.apply(this,arguments)},f.Create=function(t){return new f},f.Destroy=function(t,e){},f.prototype.Reset=function(t,e){this.__super.Reset.call(this,t,e),x.b2Assert(t.GetType()==n.e_polygonShape),x.b2Assert(e.GetType()==n.e_edgeShape)},f.prototype.Evaluate=function(){var t=this.m_fixtureA.GetBody(),n=this.m_fixtureB.GetBody();this.b2CollidePolyAndEdge(this.m_manifold,this.m_fixtureA.GetShape()instanceof i?this.m_fixtureA.GetShape():null,t.m_xf,this.m_fixtureB.GetShape()instanceof e?this.m_fixtureB.GetShape():null,n.m_xf)},f.prototype.b2CollidePolyAndEdge=function(t,e,i,n,o){},Pt.inherit(_,Pt.Dynamics.Contacts.b2Contact),_.prototype.__super=Pt.Dynamics.Contacts.b2Contact.prototype,_.b2PolygonContact=function(){Pt.Dynamics.Contacts.b2Contact.b2Contact.apply(this,arguments)},_.Create=function(t){return new _},_.Destroy=function(t,e){},_.prototype.Reset=function(t,e){this.__super.Reset.call(this,t,e)},_.prototype.Evaluate=function(){var t=this.m_fixtureA.GetBody(),e=this.m_fixtureB.GetBody();A.CollidePolygons(this.m_manifold,this.m_fixtureA.GetShape()instanceof i?this.m_fixtureA.GetShape():null,t.m_xf,this.m_fixtureB.GetShape()instanceof i?this.m_fixtureB.GetShape():null,e.m_xf)},v.b2PositionSolverManifold=function(){},v.prototype.b2PositionSolverManifold=function(){this.m_normal=new S,this.m_separations=new Lt(x.b2_maxManifoldPoints),this.m_points=new Et(x.b2_maxManifoldPoints);for(var t=0;t<x.b2_maxManifoldPoints;t++)this.m_points[t]=new S},v.prototype.Initialize=function(t){x.b2Assert(t.pointCount>0);var e,i,n=0,o=0,s=0,r=0,a=0;switch(t.type){case k.e_circles:e=t.bodyA.m_xf.R,i=t.localPoint;var l=t.bodyA.m_xf.position.x+(e.col1.x*i.x+e.col2.x*i.y),c=t.bodyA.m_xf.position.y+(e.col1.y*i.x+e.col2.y*i.y);e=t.bodyB.m_xf.R,i=t.points[0].localPoint;var h=t.bodyB.m_xf.position.x+(e.col1.x*i.x+e.col2.x*i.y),u=t.bodyB.m_xf.position.y+(e.col1.y*i.x+e.col2.y*i.y),m=h-l,y=u-c,p=m*m+y*y;if(p>Number.MIN_VALUE*Number.MIN_VALUE){var d=Math.sqrt(p);this.m_normal.x=m/d,this.m_normal.y=y/d}else this.m_normal.x=1,this.m_normal.y=0;this.m_points[0].x=.5*(l+h),this.m_points[0].y=.5*(c+u),this.m_separations[0]=m*this.m_normal.x+y*this.m_normal.y-t.radius;break;case k.e_faceA:for(e=t.bodyA.m_xf.R,i=t.localPlaneNormal,this.m_normal.x=e.col1.x*i.x+e.col2.x*i.y,this.m_normal.y=e.col1.y*i.x+e.col2.y*i.y,e=t.bodyA.m_xf.R,i=t.localPoint,r=t.bodyA.m_xf.position.x+(e.col1.x*i.x+e.col2.x*i.y),a=t.bodyA.m_xf.position.y+(e.col1.y*i.x+e.col2.y*i.y),e=t.bodyB.m_xf.R,n=0;n<t.pointCount;++n)i=t.points[n].localPoint,o=t.bodyB.m_xf.position.x+(e.col1.x*i.x+e.col2.x*i.y),s=t.bodyB.m_xf.position.y+(e.col1.y*i.x+e.col2.y*i.y),this.m_separations[n]=(o-r)*this.m_normal.x+(s-a)*this.m_normal.y-t.radius,this.m_points[n].x=o,this.m_points[n].y=s;break;case k.e_faceB:for(e=t.bodyB.m_xf.R,i=t.localPlaneNormal,this.m_normal.x=e.col1.x*i.x+e.col2.x*i.y,this.m_normal.y=e.col1.y*i.x+e.col2.y*i.y,e=t.bodyB.m_xf.R,i=t.localPoint,r=t.bodyB.m_xf.position.x+(e.col1.x*i.x+e.col2.x*i.y),a=t.bodyB.m_xf.position.y+(e.col1.y*i.x+e.col2.y*i.y),e=t.bodyA.m_xf.R,n=0;n<t.pointCount;++n)i=t.points[n].localPoint,o=t.bodyA.m_xf.position.x+(e.col1.x*i.x+e.col2.x*i.y),s=t.bodyA.m_xf.position.y+(e.col1.y*i.x+e.col2.y*i.y),this.m_separations[n]=(o-r)*this.m_normal.x+(s-a)*this.m_normal.y-t.radius,this.m_points[n].Set(o,s);this.m_normal.x*=-1,this.m_normal.y*=-1}},Pt.postDefs.push(function(){Pt.Dynamics.Contacts.b2PositionSolverManifold.circlePointA=new S,Pt.Dynamics.Contacts.b2PositionSolverManifold.circlePointB=new S})}(),function(){Pt.Dynamics.b2Body,Pt.Dynamics.b2BodyDef,Pt.Dynamics.b2ContactFilter,Pt.Dynamics.b2ContactImpulse,Pt.Dynamics.b2ContactListener,Pt.Dynamics.b2ContactManager,Pt.Dynamics.b2DebugDraw,Pt.Dynamics.b2DestructionListener,Pt.Dynamics.b2FilterData,Pt.Dynamics.b2Fixture,Pt.Dynamics.b2FixtureDef,Pt.Dynamics.b2Island,Pt.Dynamics.b2TimeStep,Pt.Dynamics.b2World;var t=Pt.Common.Math.b2Mat22;Pt.Common.Math.b2Mat33;var e=Pt.Common.Math.b2Math;Pt.Common.Math.b2Sweep,Pt.Common.Math.b2Transform;var i=Pt.Common.Math.b2Vec2;Pt.Common.Math.b2Vec3;var n=Pt.Common.b2Color;Pt.Common.b2internal,Pt.Common.b2Settings,Pt.Collision.Shapes.b2CircleShape,Pt.Collision.Shapes.b2EdgeChainDef,Pt.Collision.Shapes.b2EdgeShape,Pt.Collision.Shapes.b2MassData,Pt.Collision.Shapes.b2PolygonShape,Pt.Collision.Shapes.b2Shape;var o=Pt.Dynamics.Controllers.b2BuoyancyController,s=Pt.Dynamics.Controllers.b2ConstantAccelController,r=Pt.Dynamics.Controllers.b2ConstantForceController,a=Pt.Dynamics.Controllers.b2Controller,l=Pt.Dynamics.Controllers.b2ControllerEdge,c=Pt.Dynamics.Controllers.b2GravityController,h=Pt.Dynamics.Controllers.b2TensorDampingController;Pt.inherit(o,Pt.Dynamics.Controllers.b2Controller),o.prototype.__super=Pt.Dynamics.Controllers.b2Controller.prototype,o.b2BuoyancyController=function(){Pt.Dynamics.Controllers.b2Controller.b2Controller.apply(this,arguments),this.normal=new i(0,-1),this.offset=0,this.density=0,this.velocity=new i(0,0),this.linearDrag=2,this.angularDrag=1,this.useDensity=!1,this.useWorldGravity=!0,this.gravity=null},o.prototype.Step=function(t){if(this.m_bodyList){this.useWorldGravity&&(this.gravity=this.GetWorld().GetGravity().Copy());for(var e=this.m_bodyList;e;e=e.nextBody){var n=e.body;if(0!=n.IsAwake()){for(var o=new i,s=new i,r=0,a=0,l=n.GetFixtureList();l;l=l.GetNext()){var c=new i,h=l.GetShape().ComputeSubmergedArea(this.normal,this.offset,n.GetTransform(),c);r+=h,o.x+=h*c.x,o.y+=h*c.y;var u=0;a+=h*(this.useDensity,u=1),s.x+=h*c.x*u,s.y+=h*c.y*u}if(o.x/=r,o.y/=r,s.x/=a,s.y/=a,!(r<Number.MIN_VALUE)){var m=this.gravity.GetNegative();m.Multiply(this.density*r),n.ApplyForce(m,s);var y=n.GetLinearVelocityFromWorldPoint(o);y.Subtract(this.velocity),y.Multiply(-this.linearDrag*r),n.ApplyForce(y,o),n.ApplyTorque(-n.GetInertia()/n.GetMass()*r*n.GetAngularVelocity()*this.angularDrag)}}}}},o.prototype.Draw=function(t){var e=1e3,o=new i,s=new i;o.x=this.normal.x*this.offset+this.normal.y*e,o.y=this.normal.y*this.offset-this.normal.x*e,s.x=this.normal.x*this.offset-this.normal.y*e,s.y=this.normal.y*this.offset+this.normal.x*e;var r=new n(0,0,1);t.DrawSegment(o,s,r)},Pt.inherit(s,Pt.Dynamics.Controllers.b2Controller),s.prototype.__super=Pt.Dynamics.Controllers.b2Controller.prototype,s.b2ConstantAccelController=function(){Pt.Dynamics.Controllers.b2Controller.b2Controller.apply(this,arguments),this.A=new i(0,0)},s.prototype.Step=function(t){for(var e=new i(this.A.x*t.dt,this.A.y*t.dt),n=this.m_bodyList;n;n=n.nextBody){var o=n.body;o.IsAwake()&&o.SetLinearVelocity(new i(o.GetLinearVelocity().x+e.x,o.GetLinearVelocity().y+e.y))}},Pt.inherit(r,Pt.Dynamics.Controllers.b2Controller),r.prototype.__super=Pt.Dynamics.Controllers.b2Controller.prototype,r.b2ConstantForceController=function(){Pt.Dynamics.Controllers.b2Controller.b2Controller.apply(this,arguments),this.F=new i(0,0)},r.prototype.Step=function(t){for(var e=this.m_bodyList;e;e=e.nextBody){var i=e.body;i.IsAwake()&&i.ApplyForce(this.F,i.GetWorldCenter())}},a.b2Controller=function(){},a.prototype.Step=function(t){},a.prototype.Draw=function(t){},a.prototype.AddBody=function(t){var e=new l;e.controller=this,e.body=t,e.nextBody=this.m_bodyList,e.prevBody=null,this.m_bodyList=e,e.nextBody&&(e.nextBody.prevBody=e),this.m_bodyCount++,e.nextController=t.m_controllerList,e.prevController=null,t.m_controllerList=e,e.nextController&&(e.nextController.prevController=e),t.m_controllerCount++},a.prototype.RemoveBody=function(t){for(var e=t.m_controllerList;e&&e.controller!=this;)e=e.nextController;e.prevBody&&(e.prevBody.nextBody=e.nextBody),e.nextBody&&(e.nextBody.prevBody=e.prevBody),e.nextController&&(e.nextController.prevController=e.prevController),e.prevController&&(e.prevController.nextController=e.nextController),this.m_bodyList==e&&(this.m_bodyList=e.nextBody),t.m_controllerList==e&&(t.m_controllerList=e.nextController),t.m_controllerCount--,this.m_bodyCount--},a.prototype.Clear=function(){for(;this.m_bodyList;)this.RemoveBody(this.m_bodyList.body)},a.prototype.GetNext=function(){return this.m_next},a.prototype.GetWorld=function(){return this.m_world},a.prototype.GetBodyList=function(){return this.m_bodyList},l.b2ControllerEdge=function(){},Pt.inherit(c,Pt.Dynamics.Controllers.b2Controller),c.prototype.__super=Pt.Dynamics.Controllers.b2Controller.prototype,c.b2GravityController=function(){Pt.Dynamics.Controllers.b2Controller.b2Controller.apply(this,arguments),this.G=1,this.invSqr=!0},c.prototype.Step=function(t){var e=null,n=null,o=null,s=0,r=null,a=null,l=null,c=0,h=0,u=0,m=null;if(this.invSqr)for(e=this.m_bodyList;e;e=e.nextBody)for(o=(n=e.body).GetWorldCenter(),s=n.GetMass(),r=this.m_bodyList;r!=e;r=r.nextBody)(u=(c=(l=(a=r.body).GetWorldCenter()).x-o.x)*c+(h=l.y-o.y)*h)<Number.MIN_VALUE||((m=new i(c,h)).Multiply(this.G/u/Math.sqrt(u)*s*a.GetMass()),n.IsAwake()&&n.ApplyForce(m,o),m.Multiply(-1),a.IsAwake()&&a.ApplyForce(m,l));else for(e=this.m_bodyList;e;e=e.nextBody)for(o=(n=e.body).GetWorldCenter(),s=n.GetMass(),r=this.m_bodyList;r!=e;r=r.nextBody)(u=(c=(l=(a=r.body).GetWorldCenter()).x-o.x)*c+(h=l.y-o.y)*h)<Number.MIN_VALUE||((m=new i(c,h)).Multiply(this.G/u*s*a.GetMass()),n.IsAwake()&&n.ApplyForce(m,o),m.Multiply(-1),a.IsAwake()&&a.ApplyForce(m,l))},Pt.inherit(h,Pt.Dynamics.Controllers.b2Controller),h.prototype.__super=Pt.Dynamics.Controllers.b2Controller.prototype,h.b2TensorDampingController=function(){Pt.Dynamics.Controllers.b2Controller.b2Controller.apply(this,arguments),this.T=new t,this.maxTimestep=0},h.prototype.SetAxisAligned=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.T.col1.x=-t,this.T.col1.y=0,this.T.col2.x=0,this.T.col2.y=-e,this.maxTimestep=t>0||e>0?1/Math.max(t,e):0},h.prototype.Step=function(t){var n=t.dt;if(!(n<=Number.MIN_VALUE)){n>this.maxTimestep&&this.maxTimestep>0&&(n=this.maxTimestep);for(var o=this.m_bodyList;o;o=o.nextBody){var s=o.body;if(s.IsAwake()){var r=s.GetWorldVector(e.MulMV(this.T,s.GetLocalVector(s.GetLinearVelocity())));s.SetLinearVelocity(new i(s.GetLinearVelocity().x+r.x*n,s.GetLinearVelocity().y+r.y*n))}}}}}(),function(){Pt.Common.b2Color,Pt.Common.b2internal;var t=Pt.Common.b2Settings,e=Pt.Common.Math.b2Mat22,i=Pt.Common.Math.b2Mat33,n=Pt.Common.Math.b2Math;Pt.Common.Math.b2Sweep,Pt.Common.Math.b2Transform;var o=Pt.Common.Math.b2Vec2,s=Pt.Common.Math.b2Vec3,r=Pt.Dynamics.Joints.b2DistanceJoint,a=Pt.Dynamics.Joints.b2DistanceJointDef,l=Pt.Dynamics.Joints.b2FrictionJoint,c=Pt.Dynamics.Joints.b2FrictionJointDef,h=Pt.Dynamics.Joints.b2GearJoint,u=Pt.Dynamics.Joints.b2GearJointDef,m=Pt.Dynamics.Joints.b2Jacobian,y=Pt.Dynamics.Joints.b2Joint,p=Pt.Dynamics.Joints.b2JointDef,d=Pt.Dynamics.Joints.b2JointEdge,f=Pt.Dynamics.Joints.b2LineJoint,_=Pt.Dynamics.Joints.b2LineJointDef,v=Pt.Dynamics.Joints.b2MouseJoint,g=Pt.Dynamics.Joints.b2MouseJointDef,b=Pt.Dynamics.Joints.b2PrismaticJoint,x=Pt.Dynamics.Joints.b2PrismaticJointDef,w=Pt.Dynamics.Joints.b2PulleyJoint,C=Pt.Dynamics.Joints.b2PulleyJointDef,S=Pt.Dynamics.Joints.b2RevoluteJoint,A=Pt.Dynamics.Joints.b2RevoluteJointDef,M=Pt.Dynamics.Joints.b2WeldJoint,k=Pt.Dynamics.Joints.b2WeldJointDef;Pt.Dynamics.b2Body,Pt.Dynamics.b2BodyDef,Pt.Dynamics.b2ContactFilter,Pt.Dynamics.b2ContactImpulse,Pt.Dynamics.b2ContactListener,Pt.Dynamics.b2ContactManager,Pt.Dynamics.b2DebugDraw,Pt.Dynamics.b2DestructionListener,Pt.Dynamics.b2FilterData,Pt.Dynamics.b2Fixture,Pt.Dynamics.b2FixtureDef,Pt.Dynamics.b2Island,Pt.Dynamics.b2TimeStep,Pt.Dynamics.b2World,Pt.inherit(r,Pt.Dynamics.Joints.b2Joint),r.prototype.__super=Pt.Dynamics.Joints.b2Joint.prototype,r.b2DistanceJoint=function(){Pt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_localAnchor1=new o,this.m_localAnchor2=new o,this.m_u=new o},r.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},r.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},r.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new o(t*this.m_impulse*this.m_u.x,t*this.m_impulse*this.m_u.y)},r.prototype.GetReactionTorque=function(t){return 0},r.prototype.GetLength=function(){return this.m_length},r.prototype.SetLength=function(t){void 0===t&&(t=0),this.m_length=t},r.prototype.GetFrequency=function(){return this.m_frequencyHz},r.prototype.SetFrequency=function(t){void 0===t&&(t=0),this.m_frequencyHz=t},r.prototype.GetDampingRatio=function(){return this.m_dampingRatio},r.prototype.SetDampingRatio=function(t){void 0===t&&(t=0),this.m_dampingRatio=t},r.prototype.b2DistanceJoint=function(t){this.__super.b2Joint.call(this,t),this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_length=t.length,this.m_frequencyHz=t.frequencyHz,this.m_dampingRatio=t.dampingRatio,this.m_impulse=0,this.m_gamma=0,this.m_bias=0},r.prototype.InitVelocityConstraints=function(e){var i,n=0,o=this.m_bodyA,s=this.m_bodyB;i=o.m_xf.R;var r=this.m_localAnchor1.x-o.m_sweep.localCenter.x,a=this.m_localAnchor1.y-o.m_sweep.localCenter.y;n=i.col1.x*r+i.col2.x*a,a=i.col1.y*r+i.col2.y*a,r=n,i=s.m_xf.R;var l=this.m_localAnchor2.x-s.m_sweep.localCenter.x,c=this.m_localAnchor2.y-s.m_sweep.localCenter.y;n=i.col1.x*l+i.col2.x*c,c=i.col1.y*l+i.col2.y*c,l=n,this.m_u.x=s.m_sweep.c.x+l-o.m_sweep.c.x-r,this.m_u.y=s.m_sweep.c.y+c-o.m_sweep.c.y-a;var h=Math.sqrt(this.m_u.x*this.m_u.x+this.m_u.y*this.m_u.y);h>t.b2_linearSlop?this.m_u.Multiply(1/h):this.m_u.SetZero();var u=r*this.m_u.y-a*this.m_u.x,m=l*this.m_u.y-c*this.m_u.x,y=o.m_invMass+o.m_invI*u*u+s.m_invMass+s.m_invI*m*m;if(this.m_mass=0!=y?1/y:0,this.m_frequencyHz>0){var p=h-this.m_length,d=2*Math.PI*this.m_frequencyHz,f=2*this.m_mass*this.m_dampingRatio*d,_=this.m_mass*d*d;this.m_gamma=e.dt*(f+e.dt*_),this.m_gamma=0!=this.m_gamma?1/this.m_gamma:0,this.m_bias=p*e.dt*_*this.m_gamma,this.m_mass=y+this.m_gamma,this.m_mass=0!=this.m_mass?1/this.m_mass:0}if(e.warmStarting){this.m_impulse*=e.dtRatio;var v=this.m_impulse*this.m_u.x,g=this.m_impulse*this.m_u.y;o.m_linearVelocity.x-=o.m_invMass*v,o.m_linearVelocity.y-=o.m_invMass*g,o.m_angularVelocity-=o.m_invI*(r*g-a*v),s.m_linearVelocity.x+=s.m_invMass*v,s.m_linearVelocity.y+=s.m_invMass*g,s.m_angularVelocity+=s.m_invI*(l*g-c*v)}else this.m_impulse=0},r.prototype.SolveVelocityConstraints=function(t){var e,i=this.m_bodyA,n=this.m_bodyB;e=i.m_xf.R;var o=this.m_localAnchor1.x-i.m_sweep.localCenter.x,s=this.m_localAnchor1.y-i.m_sweep.localCenter.y,r=e.col1.x*o+e.col2.x*s;s=e.col1.y*o+e.col2.y*s,o=r,e=n.m_xf.R;var a=this.m_localAnchor2.x-n.m_sweep.localCenter.x,l=this.m_localAnchor2.y-n.m_sweep.localCenter.y;r=e.col1.x*a+e.col2.x*l,l=e.col1.y*a+e.col2.y*l,a=r;var c=i.m_linearVelocity.x+-i.m_angularVelocity*s,h=i.m_linearVelocity.y+i.m_angularVelocity*o,u=n.m_linearVelocity.x+-n.m_angularVelocity*l,m=n.m_linearVelocity.y+n.m_angularVelocity*a,y=this.m_u.x*(u-c)+this.m_u.y*(m-h),p=-this.m_mass*(y+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=p;var d=p*this.m_u.x,f=p*this.m_u.y;i.m_linearVelocity.x-=i.m_invMass*d,i.m_linearVelocity.y-=i.m_invMass*f,i.m_angularVelocity-=i.m_invI*(o*f-s*d),n.m_linearVelocity.x+=n.m_invMass*d,n.m_linearVelocity.y+=n.m_invMass*f,n.m_angularVelocity+=n.m_invI*(a*f-l*d)},r.prototype.SolvePositionConstraints=function(e){var i;if(this.m_frequencyHz>0)return!0;var o=this.m_bodyA,s=this.m_bodyB;i=o.m_xf.R;var r=this.m_localAnchor1.x-o.m_sweep.localCenter.x,a=this.m_localAnchor1.y-o.m_sweep.localCenter.y,l=i.col1.x*r+i.col2.x*a;a=i.col1.y*r+i.col2.y*a,r=l,i=s.m_xf.R;var c=this.m_localAnchor2.x-s.m_sweep.localCenter.x,h=this.m_localAnchor2.y-s.m_sweep.localCenter.y;l=i.col1.x*c+i.col2.x*h,h=i.col1.y*c+i.col2.y*h,c=l;var u=s.m_sweep.c.x+c-o.m_sweep.c.x-r,m=s.m_sweep.c.y+h-o.m_sweep.c.y-a,y=Math.sqrt(u*u+m*m);u/=y,m/=y;var p=y-this.m_length;p=n.Clamp(p,-t.b2_maxLinearCorrection,t.b2_maxLinearCorrection);var d=-this.m_mass*p;this.m_u.Set(u,m);var f=d*this.m_u.x,_=d*this.m_u.y;return o.m_sweep.c.x-=o.m_invMass*f,o.m_sweep.c.y-=o.m_invMass*_,o.m_sweep.a-=o.m_invI*(r*_-a*f),s.m_sweep.c.x+=s.m_invMass*f,s.m_sweep.c.y+=s.m_invMass*_,s.m_sweep.a+=s.m_invI*(c*_-h*f),o.SynchronizeTransform(),s.SynchronizeTransform(),n.Abs(p)<t.b2_linearSlop},Pt.inherit(a,Pt.Dynamics.Joints.b2JointDef),a.prototype.__super=Pt.Dynamics.Joints.b2JointDef.prototype,a.b2DistanceJointDef=function(){Pt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.localAnchorA=new o,this.localAnchorB=new o},a.prototype.b2DistanceJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_distanceJoint,this.length=1,this.frequencyHz=0,this.dampingRatio=0},a.prototype.Initialize=function(t,e,i,n){this.bodyA=t,this.bodyB=e,this.localAnchorA.SetV(this.bodyA.GetLocalPoint(i)),this.localAnchorB.SetV(this.bodyB.GetLocalPoint(n));var o=n.x-i.x,s=n.y-i.y;this.length=Math.sqrt(o*o+s*s),this.frequencyHz=0,this.dampingRatio=0},Pt.inherit(l,Pt.Dynamics.Joints.b2Joint),l.prototype.__super=Pt.Dynamics.Joints.b2Joint.prototype,l.b2FrictionJoint=function(){Pt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_localAnchorA=new o,this.m_localAnchorB=new o,this.m_linearMass=new e,this.m_linearImpulse=new o},l.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA)},l.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB)},l.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new o(t*this.m_linearImpulse.x,t*this.m_linearImpulse.y)},l.prototype.GetReactionTorque=function(t){return void 0===t&&(t=0),t*this.m_angularImpulse},l.prototype.SetMaxForce=function(t){void 0===t&&(t=0),this.m_maxForce=t},l.prototype.GetMaxForce=function(){return this.m_maxForce},l.prototype.SetMaxTorque=function(t){void 0===t&&(t=0),this.m_maxTorque=t},l.prototype.GetMaxTorque=function(){return this.m_maxTorque},l.prototype.b2FrictionJoint=function(t){this.__super.b2Joint.call(this,t),this.m_localAnchorA.SetV(t.localAnchorA),this.m_localAnchorB.SetV(t.localAnchorB),this.m_linearMass.SetZero(),this.m_angularMass=0,this.m_linearImpulse.SetZero(),this.m_angularImpulse=0,this.m_maxForce=t.maxForce,this.m_maxTorque=t.maxTorque},l.prototype.InitVelocityConstraints=function(t){var i,n=0,o=this.m_bodyA,s=this.m_bodyB;i=o.m_xf.R;var r=this.m_localAnchorA.x-o.m_sweep.localCenter.x,a=this.m_localAnchorA.y-o.m_sweep.localCenter.y;n=i.col1.x*r+i.col2.x*a,a=i.col1.y*r+i.col2.y*a,r=n,i=s.m_xf.R;var l=this.m_localAnchorB.x-s.m_sweep.localCenter.x,c=this.m_localAnchorB.y-s.m_sweep.localCenter.y;n=i.col1.x*l+i.col2.x*c,c=i.col1.y*l+i.col2.y*c,l=n;var h=o.m_invMass,u=s.m_invMass,m=o.m_invI,y=s.m_invI,p=new e;if(p.col1.x=h+u,p.col2.x=0,p.col1.y=0,p.col2.y=h+u,p.col1.x+=m*a*a,p.col2.x+=-m*r*a,p.col1.y+=-m*r*a,p.col2.y+=m*r*r,p.col1.x+=y*c*c,p.col2.x+=-y*l*c,p.col1.y+=-y*l*c,p.col2.y+=y*l*l,p.GetInverse(this.m_linearMass),this.m_angularMass=m+y,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),t.warmStarting){this.m_linearImpulse.x*=t.dtRatio,this.m_linearImpulse.y*=t.dtRatio,this.m_angularImpulse*=t.dtRatio;var d=this.m_linearImpulse;o.m_linearVelocity.x-=h*d.x,o.m_linearVelocity.y-=h*d.y,o.m_angularVelocity-=m*(r*d.y-a*d.x+this.m_angularImpulse),s.m_linearVelocity.x+=u*d.x,s.m_linearVelocity.y+=u*d.y,s.m_angularVelocity+=y*(l*d.y-c*d.x+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0},l.prototype.SolveVelocityConstraints=function(t){var e,i=0,s=this.m_bodyA,r=this.m_bodyB,a=s.m_linearVelocity,l=s.m_angularVelocity,c=r.m_linearVelocity,h=r.m_angularVelocity,u=s.m_invMass,m=r.m_invMass,y=s.m_invI,p=r.m_invI;e=s.m_xf.R;var d=this.m_localAnchorA.x-s.m_sweep.localCenter.x,f=this.m_localAnchorA.y-s.m_sweep.localCenter.y;i=e.col1.x*d+e.col2.x*f,f=e.col1.y*d+e.col2.y*f,d=i,e=r.m_xf.R;var _=this.m_localAnchorB.x-r.m_sweep.localCenter.x,v=this.m_localAnchorB.y-r.m_sweep.localCenter.y;i=e.col1.x*_+e.col2.x*v,v=e.col1.y*_+e.col2.y*v,_=i;var g=0,b=h-l,x=-this.m_angularMass*b,w=this.m_angularImpulse;g=t.dt*this.m_maxTorque,this.m_angularImpulse=n.Clamp(this.m_angularImpulse+x,-g,g),l-=y*(x=this.m_angularImpulse-w),h+=p*x;var C=c.x-h*v-a.x+l*f,S=c.y+h*_-a.y-l*d,A=n.MulMV(this.m_linearMass,new o(-C,-S)),M=this.m_linearImpulse.Copy();this.m_linearImpulse.Add(A),g=t.dt*this.m_maxForce,this.m_linearImpulse.LengthSquared()>g*g&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.Multiply(g)),A=n.SubtractVV(this.m_linearImpulse,M),a.x-=u*A.x,a.y-=u*A.y,l-=y*(d*A.y-f*A.x),c.x+=m*A.x,c.y+=m*A.y,h+=p*(_*A.y-v*A.x),s.m_angularVelocity=l,r.m_angularVelocity=h},l.prototype.SolvePositionConstraints=function(t){return!0},Pt.inherit(c,Pt.Dynamics.Joints.b2JointDef),c.prototype.__super=Pt.Dynamics.Joints.b2JointDef.prototype,c.b2FrictionJointDef=function(){Pt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.localAnchorA=new o,this.localAnchorB=new o},c.prototype.b2FrictionJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_frictionJoint,this.maxForce=0,this.maxTorque=0},c.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.localAnchorA.SetV(this.bodyA.GetLocalPoint(i)),this.localAnchorB.SetV(this.bodyB.GetLocalPoint(i))},Pt.inherit(h,Pt.Dynamics.Joints.b2Joint),h.prototype.__super=Pt.Dynamics.Joints.b2Joint.prototype,h.b2GearJoint=function(){Pt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_groundAnchor1=new o,this.m_groundAnchor2=new o,this.m_localAnchor1=new o,this.m_localAnchor2=new o,this.m_J=new m},h.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},h.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},h.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new o(t*this.m_impulse*this.m_J.linearB.x,t*this.m_impulse*this.m_J.linearB.y)},h.prototype.GetReactionTorque=function(t){void 0===t&&(t=0);var e=this.m_bodyB.m_xf.R,i=this.m_localAnchor1.x-this.m_bodyB.m_sweep.localCenter.x,n=this.m_localAnchor1.y-this.m_bodyB.m_sweep.localCenter.y,o=e.col1.x*i+e.col2.x*n;n=e.col1.y*i+e.col2.y*n,i=o;var s=this.m_impulse*this.m_J.linearB.x,r=this.m_impulse*this.m_J.linearB.y;return t*(this.m_impulse*this.m_J.angularB-i*r+n*s)},h.prototype.GetRatio=function(){return this.m_ratio},h.prototype.SetRatio=function(t){void 0===t&&(t=0),this.m_ratio=t},h.prototype.b2GearJoint=function(t){this.__super.b2Joint.call(this,t);var e=parseInt(t.joint1.m_type),i=parseInt(t.joint2.m_type);this.m_revolute1=null,this.m_prismatic1=null,this.m_revolute2=null,this.m_prismatic2=null;var n=0,o=0;this.m_ground1=t.joint1.GetBodyA(),this.m_bodyA=t.joint1.GetBodyB(),e==y.e_revoluteJoint?(this.m_revolute1=t.joint1 instanceof S?t.joint1:null,this.m_groundAnchor1.SetV(this.m_revolute1.m_localAnchor1),this.m_localAnchor1.SetV(this.m_revolute1.m_localAnchor2),n=this.m_revolute1.GetJointAngle()):(this.m_prismatic1=t.joint1 instanceof b?t.joint1:null,this.m_groundAnchor1.SetV(this.m_prismatic1.m_localAnchor1),this.m_localAnchor1.SetV(this.m_prismatic1.m_localAnchor2),n=this.m_prismatic1.GetJointTranslation()),this.m_ground2=t.joint2.GetBodyA(),this.m_bodyB=t.joint2.GetBodyB(),i==y.e_revoluteJoint?(this.m_revolute2=t.joint2 instanceof S?t.joint2:null,this.m_groundAnchor2.SetV(this.m_revolute2.m_localAnchor1),this.m_localAnchor2.SetV(this.m_revolute2.m_localAnchor2),o=this.m_revolute2.GetJointAngle()):(this.m_prismatic2=t.joint2 instanceof b?t.joint2:null,this.m_groundAnchor2.SetV(this.m_prismatic2.m_localAnchor1),this.m_localAnchor2.SetV(this.m_prismatic2.m_localAnchor2),o=this.m_prismatic2.GetJointTranslation()),this.m_ratio=t.ratio,this.m_constant=n+this.m_ratio*o,this.m_impulse=0},h.prototype.InitVelocityConstraints=function(t){var e,i,n=this.m_ground1,o=this.m_ground2,s=this.m_bodyA,r=this.m_bodyB,a=0,l=0,c=0,h=0,u=0,m=0,y=0;this.m_J.SetZero(),this.m_revolute1?(this.m_J.angularA=-1,y+=s.m_invI):(e=n.m_xf.R,i=this.m_prismatic1.m_localXAxis1,a=e.col1.x*i.x+e.col2.x*i.y,l=e.col1.y*i.x+e.col2.y*i.y,e=s.m_xf.R,c=this.m_localAnchor1.x-s.m_sweep.localCenter.x,h=this.m_localAnchor1.y-s.m_sweep.localCenter.y,m=e.col1.x*c+e.col2.x*h,h=e.col1.y*c+e.col2.y*h,u=(c=m)*l-h*a,this.m_J.linearA.Set(-a,-l),this.m_J.angularA=-u,y+=s.m_invMass+s.m_invI*u*u),this.m_revolute2?(this.m_J.angularB=-this.m_ratio,y+=this.m_ratio*this.m_ratio*r.m_invI):(e=o.m_xf.R,i=this.m_prismatic2.m_localXAxis1,a=e.col1.x*i.x+e.col2.x*i.y,l=e.col1.y*i.x+e.col2.y*i.y,e=r.m_xf.R,c=this.m_localAnchor2.x-r.m_sweep.localCenter.x,h=this.m_localAnchor2.y-r.m_sweep.localCenter.y,m=e.col1.x*c+e.col2.x*h,h=e.col1.y*c+e.col2.y*h,u=(c=m)*l-h*a,this.m_J.linearB.Set(-this.m_ratio*a,-this.m_ratio*l),this.m_J.angularB=-this.m_ratio*u,y+=this.m_ratio*this.m_ratio*(r.m_invMass+r.m_invI*u*u)),this.m_mass=y>0?1/y:0,t.warmStarting?(s.m_linearVelocity.x+=s.m_invMass*this.m_impulse*this.m_J.linearA.x,s.m_linearVelocity.y+=s.m_invMass*this.m_impulse*this.m_J.linearA.y,s.m_angularVelocity+=s.m_invI*this.m_impulse*this.m_J.angularA,r.m_linearVelocity.x+=r.m_invMass*this.m_impulse*this.m_J.linearB.x,r.m_linearVelocity.y+=r.m_invMass*this.m_impulse*this.m_J.linearB.y,r.m_angularVelocity+=r.m_invI*this.m_impulse*this.m_J.angularB):this.m_impulse=0},h.prototype.SolveVelocityConstraints=function(t){var e=this.m_bodyA,i=this.m_bodyB,n=this.m_J.Compute(e.m_linearVelocity,e.m_angularVelocity,i.m_linearVelocity,i.m_angularVelocity),o=-this.m_mass*n;this.m_impulse+=o,e.m_linearVelocity.x+=e.m_invMass*o*this.m_J.linearA.x,e.m_linearVelocity.y+=e.m_invMass*o*this.m_J.linearA.y,e.m_angularVelocity+=e.m_invI*o*this.m_J.angularA,i.m_linearVelocity.x+=i.m_invMass*o*this.m_J.linearB.x,i.m_linearVelocity.y+=i.m_invMass*o*this.m_J.linearB.y,i.m_angularVelocity+=i.m_invI*o*this.m_J.angularB},h.prototype.SolvePositionConstraints=function(e){var i,n,o=this.m_bodyA,s=this.m_bodyB;i=this.m_revolute1?this.m_revolute1.GetJointAngle():this.m_prismatic1.GetJointTranslation(),n=this.m_revolute2?this.m_revolute2.GetJointAngle():this.m_prismatic2.GetJointTranslation();var r=this.m_constant-(i+this.m_ratio*n),a=-this.m_mass*r;return o.m_sweep.c.x+=o.m_invMass*a*this.m_J.linearA.x,o.m_sweep.c.y+=o.m_invMass*a*this.m_J.linearA.y,o.m_sweep.a+=o.m_invI*a*this.m_J.angularA,s.m_sweep.c.x+=s.m_invMass*a*this.m_J.linearB.x,s.m_sweep.c.y+=s.m_invMass*a*this.m_J.linearB.y,s.m_sweep.a+=s.m_invI*a*this.m_J.angularB,o.SynchronizeTransform(),s.SynchronizeTransform(),0<t.b2_linearSlop},Pt.inherit(u,Pt.Dynamics.Joints.b2JointDef),u.prototype.__super=Pt.Dynamics.Joints.b2JointDef.prototype,u.b2GearJointDef=function(){Pt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments)},u.prototype.b2GearJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_gearJoint,this.joint1=null,this.joint2=null,this.ratio=1},m.b2Jacobian=function(){this.linearA=new o,this.linearB=new o},m.prototype.SetZero=function(){this.linearA.SetZero(),this.angularA=0,this.linearB.SetZero(),this.angularB=0},m.prototype.Set=function(t,e,i,n){void 0===e&&(e=0),void 0===n&&(n=0),this.linearA.SetV(t),this.angularA=e,this.linearB.SetV(i),this.angularB=n},m.prototype.Compute=function(t,e,i,n){return void 0===e&&(e=0),void 0===n&&(n=0),this.linearA.x*t.x+this.linearA.y*t.y+this.angularA*e+(this.linearB.x*i.x+this.linearB.y*i.y)+this.angularB*n},y.b2Joint=function(){this.m_edgeA=new d,this.m_edgeB=new d,this.m_localCenterA=new o,this.m_localCenterB=new o},y.prototype.GetType=function(){return this.m_type},y.prototype.GetAnchorA=function(){return null},y.prototype.GetAnchorB=function(){return null},y.prototype.GetReactionForce=function(t){return null},y.prototype.GetReactionTorque=function(t){return 0},y.prototype.GetBodyA=function(){return this.m_bodyA},y.prototype.GetBodyB=function(){return this.m_bodyB},y.prototype.GetNext=function(){return this.m_next},y.prototype.GetUserData=function(){return this.m_userData},y.prototype.SetUserData=function(t){this.m_userData=t},y.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()},y.Create=function(t,e){var i=null;switch(t.type){case y.e_distanceJoint:i=new r(t instanceof a?t:null);break;case y.e_mouseJoint:i=new v(t instanceof g?t:null);break;case y.e_prismaticJoint:i=new b(t instanceof x?t:null);break;case y.e_revoluteJoint:i=new S(t instanceof A?t:null);break;case y.e_pulleyJoint:i=new w(t instanceof C?t:null);break;case y.e_gearJoint:i=new h(t instanceof u?t:null);break;case y.e_lineJoint:i=new f(t instanceof _?t:null);break;case y.e_weldJoint:i=new M(t instanceof k?t:null);break;case y.e_frictionJoint:i=new l(t instanceof c?t:null)}return i},y.Destroy=function(t,e){},y.prototype.b2Joint=function(e){t.b2Assert(e.bodyA!=e.bodyB),this.m_type=e.type,this.m_prev=null,this.m_next=null,this.m_bodyA=e.bodyA,this.m_bodyB=e.bodyB,this.m_collideConnected=e.collideConnected,this.m_islandFlag=!1,this.m_userData=e.userData},y.prototype.InitVelocityConstraints=function(t){},y.prototype.SolveVelocityConstraints=function(t){},y.prototype.FinalizeVelocityConstraints=function(){},y.prototype.SolvePositionConstraints=function(t){return!1},Pt.postDefs.push(function(){Pt.Dynamics.Joints.b2Joint.e_unknownJoint=0,Pt.Dynamics.Joints.b2Joint.e_revoluteJoint=1,Pt.Dynamics.Joints.b2Joint.e_prismaticJoint=2,Pt.Dynamics.Joints.b2Joint.e_distanceJoint=3,Pt.Dynamics.Joints.b2Joint.e_pulleyJoint=4,Pt.Dynamics.Joints.b2Joint.e_mouseJoint=5,Pt.Dynamics.Joints.b2Joint.e_gearJoint=6,Pt.Dynamics.Joints.b2Joint.e_lineJoint=7,Pt.Dynamics.Joints.b2Joint.e_weldJoint=8,Pt.Dynamics.Joints.b2Joint.e_frictionJoint=9,Pt.Dynamics.Joints.b2Joint.e_inactiveLimit=0,Pt.Dynamics.Joints.b2Joint.e_atLowerLimit=1,Pt.Dynamics.Joints.b2Joint.e_atUpperLimit=2,Pt.Dynamics.Joints.b2Joint.e_equalLimits=3}),p.b2JointDef=function(){},p.prototype.b2JointDef=function(){this.type=y.e_unknownJoint,this.userData=null,this.bodyA=null,this.bodyB=null,this.collideConnected=!1},d.b2JointEdge=function(){},Pt.inherit(f,Pt.Dynamics.Joints.b2Joint),f.prototype.__super=Pt.Dynamics.Joints.b2Joint.prototype,f.b2LineJoint=function(){Pt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_localAnchor1=new o,this.m_localAnchor2=new o,this.m_localXAxis1=new o,this.m_localYAxis1=new o,this.m_axis=new o,this.m_perp=new o,this.m_K=new e,this.m_impulse=new o},f.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},f.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},f.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new o(t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.x),t*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.y))},f.prototype.GetReactionTorque=function(t){return void 0===t&&(t=0),t*this.m_impulse.y},f.prototype.GetJointTranslation=function(){var t=this.m_bodyA,e=this.m_bodyB,i=t.GetWorldPoint(this.m_localAnchor1),n=e.GetWorldPoint(this.m_localAnchor2),o=n.x-i.x,s=n.y-i.y,r=t.GetWorldVector(this.m_localXAxis1);return r.x*o+r.y*s},f.prototype.GetJointSpeed=function(){var t,e=this.m_bodyA,i=this.m_bodyB;t=e.m_xf.R;var n=this.m_localAnchor1.x-e.m_sweep.localCenter.x,o=this.m_localAnchor1.y-e.m_sweep.localCenter.y,s=t.col1.x*n+t.col2.x*o;o=t.col1.y*n+t.col2.y*o,n=s,t=i.m_xf.R;var r=this.m_localAnchor2.x-i.m_sweep.localCenter.x,a=this.m_localAnchor2.y-i.m_sweep.localCenter.y;s=t.col1.x*r+t.col2.x*a,a=t.col1.y*r+t.col2.y*a,r=s;var l=e.m_sweep.c.x+n,c=e.m_sweep.c.y+o,h=i.m_sweep.c.x+r-l,u=i.m_sweep.c.y+a-c,m=e.GetWorldVector(this.m_localXAxis1),y=e.m_linearVelocity,p=i.m_linearVelocity,d=e.m_angularVelocity,f=i.m_angularVelocity;return h*(-d*m.y)+u*(d*m.x)+(m.x*(p.x+-f*a-y.x- -d*o)+m.y*(p.y+f*r-y.y-d*n))},f.prototype.IsLimitEnabled=function(){return this.m_enableLimit},f.prototype.EnableLimit=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t},f.prototype.GetLowerLimit=function(){return this.m_lowerTranslation},f.prototype.GetUpperLimit=function(){return this.m_upperTranslation},f.prototype.SetLimits=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e},f.prototype.IsMotorEnabled=function(){return this.m_enableMotor},f.prototype.EnableMotor=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t},f.prototype.SetMotorSpeed=function(t){void 0===t&&(t=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t},f.prototype.GetMotorSpeed=function(){return this.m_motorSpeed},f.prototype.SetMaxMotorForce=function(t){void 0===t&&(t=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t},f.prototype.GetMaxMotorForce=function(){return this.m_maxMotorForce},f.prototype.GetMotorForce=function(){return this.m_motorImpulse},f.prototype.b2LineJoint=function(t){this.__super.b2Joint.call(this,t),this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_localXAxis1.SetV(t.localAxisA),this.m_localYAxis1.x=-this.m_localXAxis1.y,this.m_localYAxis1.y=this.m_localXAxis1.x,this.m_impulse.SetZero(),this.m_motorMass=0,this.m_motorImpulse=0,this.m_lowerTranslation=t.lowerTranslation,this.m_upperTranslation=t.upperTranslation,this.m_maxMotorForce=t.maxMotorForce,this.m_motorSpeed=t.motorSpeed,this.m_enableLimit=t.enableLimit,this.m_enableMotor=t.enableMotor,this.m_limitState=y.e_inactiveLimit,this.m_axis.SetZero(),this.m_perp.SetZero()},f.prototype.InitVelocityConstraints=function(e){var i,o=this.m_bodyA,s=this.m_bodyB,r=0;this.m_localCenterA.SetV(o.GetLocalCenter()),this.m_localCenterB.SetV(s.GetLocalCenter());var a=o.GetTransform();s.GetTransform(),i=o.m_xf.R;var l=this.m_localAnchor1.x-this.m_localCenterA.x,c=this.m_localAnchor1.y-this.m_localCenterA.y;r=i.col1.x*l+i.col2.x*c,c=i.col1.y*l+i.col2.y*c,l=r,i=s.m_xf.R;var h=this.m_localAnchor2.x-this.m_localCenterB.x,u=this.m_localAnchor2.y-this.m_localCenterB.y;r=i.col1.x*h+i.col2.x*u,u=i.col1.y*h+i.col2.y*u,h=r;var m=s.m_sweep.c.x+h-o.m_sweep.c.x-l,p=s.m_sweep.c.y+u-o.m_sweep.c.y-c;this.m_invMassA=o.m_invMass,this.m_invMassB=s.m_invMass,this.m_invIA=o.m_invI,this.m_invIB=s.m_invI,this.m_axis.SetV(n.MulMV(a.R,this.m_localXAxis1)),this.m_a1=(m+l)*this.m_axis.y-(p+c)*this.m_axis.x,this.m_a2=h*this.m_axis.y-u*this.m_axis.x,this.m_motorMass=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_a1*this.m_a1+this.m_invIB*this.m_a2*this.m_a2,this.m_motorMass=this.m_motorMass>Number.MIN_VALUE?1/this.m_motorMass:0,this.m_perp.SetV(n.MulMV(a.R,this.m_localYAxis1)),this.m_s1=(m+l)*this.m_perp.y-(p+c)*this.m_perp.x,this.m_s2=h*this.m_perp.y-u*this.m_perp.x;var d=this.m_invMassA,f=this.m_invMassB,_=this.m_invIA,v=this.m_invIB;if(this.m_K.col1.x=d+f+_*this.m_s1*this.m_s1+v*this.m_s2*this.m_s2,this.m_K.col1.y=_*this.m_s1*this.m_a1+v*this.m_s2*this.m_a2,this.m_K.col2.x=this.m_K.col1.y,this.m_K.col2.y=d+f+_*this.m_a1*this.m_a1+v*this.m_a2*this.m_a2,this.m_enableLimit){var g=this.m_axis.x*m+this.m_axis.y*p;n.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*t.b2_linearSlop?this.m_limitState=y.e_equalLimits:g<=this.m_lowerTranslation?this.m_limitState!=y.e_atLowerLimit&&(this.m_limitState=y.e_atLowerLimit,this.m_impulse.y=0):g>=this.m_upperTranslation?this.m_limitState!=y.e_atUpperLimit&&(this.m_limitState=y.e_atUpperLimit,this.m_impulse.y=0):(this.m_limitState=y.e_inactiveLimit,this.m_impulse.y=0)}else this.m_limitState=y.e_inactiveLimit;if(0==this.m_enableMotor&&(this.m_motorImpulse=0),e.warmStarting){this.m_impulse.x*=e.dtRatio,this.m_impulse.y*=e.dtRatio,this.m_motorImpulse*=e.dtRatio;var b=this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.x,x=this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.y,w=this.m_impulse.x*this.m_s1+(this.m_motorImpulse+this.m_impulse.y)*this.m_a1,C=this.m_impulse.x*this.m_s2+(this.m_motorImpulse+this.m_impulse.y)*this.m_a2;o.m_linearVelocity.x-=this.m_invMassA*b,o.m_linearVelocity.y-=this.m_invMassA*x,o.m_angularVelocity-=this.m_invIA*w,s.m_linearVelocity.x+=this.m_invMassB*b,s.m_linearVelocity.y+=this.m_invMassB*x,s.m_angularVelocity+=this.m_invIB*C}else this.m_impulse.SetZero(),this.m_motorImpulse=0},f.prototype.SolveVelocityConstraints=function(t){var e=this.m_bodyA,i=this.m_bodyB,s=e.m_linearVelocity,r=e.m_angularVelocity,a=i.m_linearVelocity,l=i.m_angularVelocity,c=0,h=0,u=0,m=0;if(this.m_enableMotor&&this.m_limitState!=y.e_equalLimits){var p=this.m_axis.x*(a.x-s.x)+this.m_axis.y*(a.y-s.y)+this.m_a2*l-this.m_a1*r,d=this.m_motorMass*(this.m_motorSpeed-p),f=this.m_motorImpulse,_=t.dt*this.m_maxMotorForce;this.m_motorImpulse=n.Clamp(this.m_motorImpulse+d,-_,_),c=(d=this.m_motorImpulse-f)*this.m_axis.x,h=d*this.m_axis.y,u=d*this.m_a1,m=d*this.m_a2,s.x-=this.m_invMassA*c,s.y-=this.m_invMassA*h,r-=this.m_invIA*u,a.x+=this.m_invMassB*c,a.y+=this.m_invMassB*h,l+=this.m_invIB*m}var v=this.m_perp.x*(a.x-s.x)+this.m_perp.y*(a.y-s.y)+this.m_s2*l-this.m_s1*r;if(this.m_enableLimit&&this.m_limitState!=y.e_inactiveLimit){var g=this.m_axis.x*(a.x-s.x)+this.m_axis.y*(a.y-s.y)+this.m_a2*l-this.m_a1*r,b=this.m_impulse.Copy(),x=this.m_K.Solve(new o,-v,-g);this.m_impulse.Add(x),this.m_limitState==y.e_atLowerLimit?this.m_impulse.y=n.Max(this.m_impulse.y,0):this.m_limitState==y.e_atUpperLimit&&(this.m_impulse.y=n.Min(this.m_impulse.y,0));var w,C=-v-(this.m_impulse.y-b.y)*this.m_K.col2.x;w=0!=this.m_K.col1.x?C/this.m_K.col1.x+b.x:b.x,this.m_impulse.x=w,x.x=this.m_impulse.x-b.x,x.y=this.m_impulse.y-b.y,c=x.x*this.m_perp.x+x.y*this.m_axis.x,h=x.x*this.m_perp.y+x.y*this.m_axis.y,u=x.x*this.m_s1+x.y*this.m_a1,m=x.x*this.m_s2+x.y*this.m_a2,s.x-=this.m_invMassA*c,s.y-=this.m_invMassA*h,r-=this.m_invIA*u,a.x+=this.m_invMassB*c,a.y+=this.m_invMassB*h,l+=this.m_invIB*m}else{var S;S=0!=this.m_K.col1.x?-v/this.m_K.col1.x:0,this.m_impulse.x+=S,c=S*this.m_perp.x,h=S*this.m_perp.y,u=S*this.m_s1,m=S*this.m_s2,s.x-=this.m_invMassA*c,s.y-=this.m_invMassA*h,r-=this.m_invIA*u,a.x+=this.m_invMassB*c,a.y+=this.m_invMassB*h,l+=this.m_invIB*m}e.m_linearVelocity.SetV(s),e.m_angularVelocity=r,i.m_linearVelocity.SetV(a),i.m_angularVelocity=l},f.prototype.SolvePositionConstraints=function(i){var s,r=this.m_bodyA,a=this.m_bodyB,l=r.m_sweep.c,c=r.m_sweep.a,h=a.m_sweep.c,u=a.m_sweep.a,m=0,y=0,p=0,d=0,f=0,_=0,v=!1,g=0,b=e.FromAngle(c),x=e.FromAngle(u);s=b;var w=this.m_localAnchor1.x-this.m_localCenterA.x,C=this.m_localAnchor1.y-this.m_localCenterA.y;m=s.col1.x*w+s.col2.x*C,C=s.col1.y*w+s.col2.y*C,w=m,s=x;var S=this.m_localAnchor2.x-this.m_localCenterB.x,A=this.m_localAnchor2.y-this.m_localCenterB.y;m=s.col1.x*S+s.col2.x*A,A=s.col1.y*S+s.col2.y*A,S=m;var M=h.x+S-l.x-w,k=h.y+A-l.y-C;if(this.m_enableLimit){this.m_axis=n.MulMV(b,this.m_localXAxis1),this.m_a1=(M+w)*this.m_axis.y-(k+C)*this.m_axis.x,this.m_a2=S*this.m_axis.y-A*this.m_axis.x;var D=this.m_axis.x*M+this.m_axis.y*k;n.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*t.b2_linearSlop?(g=n.Clamp(D,-t.b2_maxLinearCorrection,t.b2_maxLinearCorrection),_=n.Abs(D),v=!0):D<=this.m_lowerTranslation?(g=n.Clamp(D-this.m_lowerTranslation+t.b2_linearSlop,-t.b2_maxLinearCorrection,0),_=this.m_lowerTranslation-D,v=!0):D>=this.m_upperTranslation&&(g=n.Clamp(D-this.m_upperTranslation+t.b2_linearSlop,0,t.b2_maxLinearCorrection),_=D-this.m_upperTranslation,v=!0)}this.m_perp=n.MulMV(b,this.m_localYAxis1),this.m_s1=(M+w)*this.m_perp.y-(k+C)*this.m_perp.x,this.m_s2=S*this.m_perp.y-A*this.m_perp.x;var I=new o,B=this.m_perp.x*M+this.m_perp.y*k;if(_=n.Max(_,n.Abs(B)),v)y=this.m_invMassA,p=this.m_invMassB,d=this.m_invIA,f=this.m_invIB,this.m_K.col1.x=y+p+d*this.m_s1*this.m_s1+f*this.m_s2*this.m_s2,this.m_K.col1.y=d*this.m_s1*this.m_a1+f*this.m_s2*this.m_a2,this.m_K.col2.x=this.m_K.col1.y,this.m_K.col2.y=y+p+d*this.m_a1*this.m_a1+f*this.m_a2*this.m_a2,this.m_K.Solve(I,-B,-g);else{y=this.m_invMassA,p=this.m_invMassB,d=this.m_invIA,f=this.m_invIB;var P,V=y+p+d*this.m_s1*this.m_s1+f*this.m_s2*this.m_s2;P=0!=V?-B/V:0,I.x=P,I.y=0}var T=I.x*this.m_perp.x+I.y*this.m_axis.x,E=I.x*this.m_perp.y+I.y*this.m_axis.y,L=I.x*this.m_s1+I.y*this.m_a1,F=I.x*this.m_s2+I.y*this.m_a2;return l.x-=this.m_invMassA*T,l.y-=this.m_invMassA*E,c-=this.m_invIA*L,h.x+=this.m_invMassB*T,h.y+=this.m_invMassB*E,u+=this.m_invIB*F,r.m_sweep.a=c,a.m_sweep.a=u,r.SynchronizeTransform(),a.SynchronizeTransform(),_<=t.b2_linearSlop&&0<=t.b2_angularSlop},Pt.inherit(_,Pt.Dynamics.Joints.b2JointDef),_.prototype.__super=Pt.Dynamics.Joints.b2JointDef.prototype,_.b2LineJointDef=function(){Pt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.localAnchorA=new o,this.localAnchorB=new o,this.localAxisA=new o},_.prototype.b2LineJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_lineJoint,this.localAxisA.Set(1,0),this.enableLimit=!1,this.lowerTranslation=0,this.upperTranslation=0,this.enableMotor=!1,this.maxMotorForce=0,this.motorSpeed=0},_.prototype.Initialize=function(t,e,i,n){this.bodyA=t,this.bodyB=e,this.localAnchorA=this.bodyA.GetLocalPoint(i),this.localAnchorB=this.bodyB.GetLocalPoint(i),this.localAxisA=this.bodyA.GetLocalVector(n)},Pt.inherit(v,Pt.Dynamics.Joints.b2Joint),v.prototype.__super=Pt.Dynamics.Joints.b2Joint.prototype,v.b2MouseJoint=function(){Pt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.K=new e,this.K1=new e,this.K2=new e,this.m_localAnchor=new o,this.m_target=new o,this.m_impulse=new o,this.m_mass=new e,this.m_C=new o},v.prototype.GetAnchorA=function(){return this.m_target},v.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor)},v.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new o(t*this.m_impulse.x,t*this.m_impulse.y)},v.prototype.GetReactionTorque=function(t){return 0},v.prototype.GetTarget=function(){return this.m_target},v.prototype.SetTarget=function(t){0==this.m_bodyB.IsAwake()&&this.m_bodyB.SetAwake(!0),this.m_target=t},v.prototype.GetMaxForce=function(){return this.m_maxForce},v.prototype.SetMaxForce=function(t){void 0===t&&(t=0),this.m_maxForce=t},v.prototype.GetFrequency=function(){return this.m_frequencyHz},v.prototype.SetFrequency=function(t){void 0===t&&(t=0),this.m_frequencyHz=t},v.prototype.GetDampingRatio=function(){return this.m_dampingRatio},v.prototype.SetDampingRatio=function(t){void 0===t&&(t=0),this.m_dampingRatio=t},v.prototype.b2MouseJoint=function(t){this.__super.b2Joint.call(this,t),this.m_target.SetV(t.target);var e=this.m_target.x-this.m_bodyB.m_xf.position.x,i=this.m_target.y-this.m_bodyB.m_xf.position.y,n=this.m_bodyB.m_xf.R;this.m_localAnchor.x=e*n.col1.x+i*n.col1.y,this.m_localAnchor.y=e*n.col2.x+i*n.col2.y,this.m_maxForce=t.maxForce,this.m_impulse.SetZero(),this.m_frequencyHz=t.frequencyHz,this.m_dampingRatio=t.dampingRatio,this.m_beta=0,this.m_gamma=0},v.prototype.InitVelocityConstraints=function(t){var e,i=this.m_bodyB,n=i.GetMass(),o=2*Math.PI*this.m_frequencyHz,s=2*n*this.m_dampingRatio*o,r=n*o*o;this.m_gamma=t.dt*(s+t.dt*r),this.m_gamma=0!=this.m_gamma?1/this.m_gamma:0,this.m_beta=t.dt*r*this.m_gamma,e=i.m_xf.R;var a=this.m_localAnchor.x-i.m_sweep.localCenter.x,l=this.m_localAnchor.y-i.m_sweep.localCenter.y,c=e.col1.x*a+e.col2.x*l;l=e.col1.y*a+e.col2.y*l,a=c;var h=i.m_invMass,u=i.m_invI;this.K1.col1.x=h,this.K1.col2.x=0,this.K1.col1.y=0,this.K1.col2.y=h,this.K2.col1.x=u*l*l,this.K2.col2.x=-u*a*l,this.K2.col1.y=-u*a*l,this.K2.col2.y=u*a*a,this.K.SetM(this.K1),this.K.AddM(this.K2),this.K.col1.x+=this.m_gamma,this.K.col2.y+=this.m_gamma,this.K.GetInverse(this.m_mass),this.m_C.x=i.m_sweep.c.x+a-this.m_target.x,this.m_C.y=i.m_sweep.c.y+l-this.m_target.y,i.m_angularVelocity*=.98,this.m_impulse.x*=t.dtRatio,this.m_impulse.y*=t.dtRatio,i.m_linearVelocity.x+=h*this.m_impulse.x,i.m_linearVelocity.y+=h*this.m_impulse.y,i.m_angularVelocity+=u*(a*this.m_impulse.y-l*this.m_impulse.x)},v.prototype.SolveVelocityConstraints=function(t){var e,i,n=this.m_bodyB,o=0;e=n.m_xf.R;var s=this.m_localAnchor.x-n.m_sweep.localCenter.x,r=this.m_localAnchor.y-n.m_sweep.localCenter.y;o=e.col1.x*s+e.col2.x*r,r=e.col1.y*s+e.col2.y*r,s=o;var a=n.m_linearVelocity.x+-n.m_angularVelocity*r,l=n.m_linearVelocity.y+n.m_angularVelocity*s;e=this.m_mass,o=a+this.m_beta*this.m_C.x+this.m_gamma*this.m_impulse.x,i=l+this.m_beta*this.m_C.y+this.m_gamma*this.m_impulse.y;var c=-(e.col1.x*o+e.col2.x*i),h=-(e.col1.y*o+e.col2.y*i),u=this.m_impulse.x,m=this.m_impulse.y;this.m_impulse.x+=c,this.m_impulse.y+=h;var y=t.dt*this.m_maxForce;this.m_impulse.LengthSquared()>y*y&&this.m_impulse.Multiply(y/this.m_impulse.Length()),c=this.m_impulse.x-u,h=this.m_impulse.y-m,n.m_linearVelocity.x+=n.m_invMass*c,n.m_linearVelocity.y+=n.m_invMass*h,n.m_angularVelocity+=n.m_invI*(s*h-r*c)},v.prototype.SolvePositionConstraints=function(t){return!0},Pt.inherit(g,Pt.Dynamics.Joints.b2JointDef),g.prototype.__super=Pt.Dynamics.Joints.b2JointDef.prototype,g.b2MouseJointDef=function(){Pt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.target=new o},g.prototype.b2MouseJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_mouseJoint,this.maxForce=0,this.frequencyHz=5,this.dampingRatio=.7},Pt.inherit(b,Pt.Dynamics.Joints.b2Joint),b.prototype.__super=Pt.Dynamics.Joints.b2Joint.prototype,b.b2PrismaticJoint=function(){Pt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_localAnchor1=new o,this.m_localAnchor2=new o,this.m_localXAxis1=new o,this.m_localYAxis1=new o,this.m_axis=new o,this.m_perp=new o,this.m_K=new i,this.m_impulse=new s},b.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},b.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},b.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new o(t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x),t*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y))},b.prototype.GetReactionTorque=function(t){return void 0===t&&(t=0),t*this.m_impulse.y},b.prototype.GetJointTranslation=function(){var t=this.m_bodyA,e=this.m_bodyB,i=t.GetWorldPoint(this.m_localAnchor1),n=e.GetWorldPoint(this.m_localAnchor2),o=n.x-i.x,s=n.y-i.y,r=t.GetWorldVector(this.m_localXAxis1);return r.x*o+r.y*s},b.prototype.GetJointSpeed=function(){var t,e=this.m_bodyA,i=this.m_bodyB;t=e.m_xf.R;var n=this.m_localAnchor1.x-e.m_sweep.localCenter.x,o=this.m_localAnchor1.y-e.m_sweep.localCenter.y,s=t.col1.x*n+t.col2.x*o;o=t.col1.y*n+t.col2.y*o,n=s,t=i.m_xf.R;var r=this.m_localAnchor2.x-i.m_sweep.localCenter.x,a=this.m_localAnchor2.y-i.m_sweep.localCenter.y;s=t.col1.x*r+t.col2.x*a,a=t.col1.y*r+t.col2.y*a,r=s;var l=e.m_sweep.c.x+n,c=e.m_sweep.c.y+o,h=i.m_sweep.c.x+r-l,u=i.m_sweep.c.y+a-c,m=e.GetWorldVector(this.m_localXAxis1),y=e.m_linearVelocity,p=i.m_linearVelocity,d=e.m_angularVelocity,f=i.m_angularVelocity;return h*(-d*m.y)+u*(d*m.x)+(m.x*(p.x+-f*a-y.x- -d*o)+m.y*(p.y+f*r-y.y-d*n))},b.prototype.IsLimitEnabled=function(){return this.m_enableLimit},b.prototype.EnableLimit=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t},b.prototype.GetLowerLimit=function(){return this.m_lowerTranslation},b.prototype.GetUpperLimit=function(){return this.m_upperTranslation},b.prototype.SetLimits=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e},b.prototype.IsMotorEnabled=function(){return this.m_enableMotor},b.prototype.EnableMotor=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t},b.prototype.SetMotorSpeed=function(t){void 0===t&&(t=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t},b.prototype.GetMotorSpeed=function(){return this.m_motorSpeed},b.prototype.SetMaxMotorForce=function(t){void 0===t&&(t=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t},b.prototype.GetMotorForce=function(){return this.m_motorImpulse},b.prototype.b2PrismaticJoint=function(t){this.__super.b2Joint.call(this,t),this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_localXAxis1.SetV(t.localAxisA),this.m_localYAxis1.x=-this.m_localXAxis1.y,this.m_localYAxis1.y=this.m_localXAxis1.x,this.m_refAngle=t.referenceAngle,this.m_impulse.SetZero(),this.m_motorMass=0,this.m_motorImpulse=0,this.m_lowerTranslation=t.lowerTranslation,this.m_upperTranslation=t.upperTranslation,this.m_maxMotorForce=t.maxMotorForce,this.m_motorSpeed=t.motorSpeed,this.m_enableLimit=t.enableLimit,this.m_enableMotor=t.enableMotor,this.m_limitState=y.e_inactiveLimit,this.m_axis.SetZero(),this.m_perp.SetZero()},b.prototype.InitVelocityConstraints=function(e){var i,o=this.m_bodyA,s=this.m_bodyB,r=0;this.m_localCenterA.SetV(o.GetLocalCenter()),this.m_localCenterB.SetV(s.GetLocalCenter());var a=o.GetTransform();s.GetTransform(),i=o.m_xf.R;var l=this.m_localAnchor1.x-this.m_localCenterA.x,c=this.m_localAnchor1.y-this.m_localCenterA.y;r=i.col1.x*l+i.col2.x*c,c=i.col1.y*l+i.col2.y*c,l=r,i=s.m_xf.R;var h=this.m_localAnchor2.x-this.m_localCenterB.x,u=this.m_localAnchor2.y-this.m_localCenterB.y;r=i.col1.x*h+i.col2.x*u,u=i.col1.y*h+i.col2.y*u,h=r;var m=s.m_sweep.c.x+h-o.m_sweep.c.x-l,p=s.m_sweep.c.y+u-o.m_sweep.c.y-c;this.m_invMassA=o.m_invMass,this.m_invMassB=s.m_invMass,this.m_invIA=o.m_invI,this.m_invIB=s.m_invI,this.m_axis.SetV(n.MulMV(a.R,this.m_localXAxis1)),this.m_a1=(m+l)*this.m_axis.y-(p+c)*this.m_axis.x,this.m_a2=h*this.m_axis.y-u*this.m_axis.x,this.m_motorMass=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_a1*this.m_a1+this.m_invIB*this.m_a2*this.m_a2,this.m_motorMass>Number.MIN_VALUE&&(this.m_motorMass=1/this.m_motorMass),this.m_perp.SetV(n.MulMV(a.R,this.m_localYAxis1)),this.m_s1=(m+l)*this.m_perp.y-(p+c)*this.m_perp.x,this.m_s2=h*this.m_perp.y-u*this.m_perp.x;var d=this.m_invMassA,f=this.m_invMassB,_=this.m_invIA,v=this.m_invIB;if(this.m_K.col1.x=d+f+_*this.m_s1*this.m_s1+v*this.m_s2*this.m_s2,this.m_K.col1.y=_*this.m_s1+v*this.m_s2,this.m_K.col1.z=_*this.m_s1*this.m_a1+v*this.m_s2*this.m_a2,this.m_K.col2.x=this.m_K.col1.y,this.m_K.col2.y=_+v,this.m_K.col2.z=_*this.m_a1+v*this.m_a2,this.m_K.col3.x=this.m_K.col1.z,this.m_K.col3.y=this.m_K.col2.z,this.m_K.col3.z=d+f+_*this.m_a1*this.m_a1+v*this.m_a2*this.m_a2,this.m_enableLimit){var g=this.m_axis.x*m+this.m_axis.y*p;n.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*t.b2_linearSlop?this.m_limitState=y.e_equalLimits:g<=this.m_lowerTranslation?this.m_limitState!=y.e_atLowerLimit&&(this.m_limitState=y.e_atLowerLimit,this.m_impulse.z=0):g>=this.m_upperTranslation?this.m_limitState!=y.e_atUpperLimit&&(this.m_limitState=y.e_atUpperLimit,this.m_impulse.z=0):(this.m_limitState=y.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=y.e_inactiveLimit;if(0==this.m_enableMotor&&(this.m_motorImpulse=0),e.warmStarting){this.m_impulse.x*=e.dtRatio,this.m_impulse.y*=e.dtRatio,this.m_motorImpulse*=e.dtRatio;var b=this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x,x=this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y,w=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,C=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;o.m_linearVelocity.x-=this.m_invMassA*b,o.m_linearVelocity.y-=this.m_invMassA*x,o.m_angularVelocity-=this.m_invIA*w,s.m_linearVelocity.x+=this.m_invMassB*b,s.m_linearVelocity.y+=this.m_invMassB*x,s.m_angularVelocity+=this.m_invIB*C}else this.m_impulse.SetZero(),this.m_motorImpulse=0},b.prototype.SolveVelocityConstraints=function(t){var e=this.m_bodyA,i=this.m_bodyB,r=e.m_linearVelocity,a=e.m_angularVelocity,l=i.m_linearVelocity,c=i.m_angularVelocity,h=0,u=0,m=0,p=0;if(this.m_enableMotor&&this.m_limitState!=y.e_equalLimits){var d=this.m_axis.x*(l.x-r.x)+this.m_axis.y*(l.y-r.y)+this.m_a2*c-this.m_a1*a,f=this.m_motorMass*(this.m_motorSpeed-d),_=this.m_motorImpulse,v=t.dt*this.m_maxMotorForce;this.m_motorImpulse=n.Clamp(this.m_motorImpulse+f,-v,v),h=(f=this.m_motorImpulse-_)*this.m_axis.x,u=f*this.m_axis.y,m=f*this.m_a1,p=f*this.m_a2,r.x-=this.m_invMassA*h,r.y-=this.m_invMassA*u,a-=this.m_invIA*m,l.x+=this.m_invMassB*h,l.y+=this.m_invMassB*u,c+=this.m_invIB*p}var g=this.m_perp.x*(l.x-r.x)+this.m_perp.y*(l.y-r.y)+this.m_s2*c-this.m_s1*a,b=c-a;if(this.m_enableLimit&&this.m_limitState!=y.e_inactiveLimit){var x=this.m_axis.x*(l.x-r.x)+this.m_axis.y*(l.y-r.y)+this.m_a2*c-this.m_a1*a,w=this.m_impulse.Copy(),C=this.m_K.Solve33(new s,-g,-b,-x);this.m_impulse.Add(C),this.m_limitState==y.e_atLowerLimit?this.m_impulse.z=n.Max(this.m_impulse.z,0):this.m_limitState==y.e_atUpperLimit&&(this.m_impulse.z=n.Min(this.m_impulse.z,0));var S=-g-(this.m_impulse.z-w.z)*this.m_K.col3.x,A=-b-(this.m_impulse.z-w.z)*this.m_K.col3.y,M=this.m_K.Solve22(new o,S,A);M.x+=w.x,M.y+=w.y,this.m_impulse.x=M.x,this.m_impulse.y=M.y,C.x=this.m_impulse.x-w.x,C.y=this.m_impulse.y-w.y,C.z=this.m_impulse.z-w.z,h=C.x*this.m_perp.x+C.z*this.m_axis.x,u=C.x*this.m_perp.y+C.z*this.m_axis.y,m=C.x*this.m_s1+C.y+C.z*this.m_a1,p=C.x*this.m_s2+C.y+C.z*this.m_a2,r.x-=this.m_invMassA*h,r.y-=this.m_invMassA*u,a-=this.m_invIA*m,l.x+=this.m_invMassB*h,l.y+=this.m_invMassB*u,c+=this.m_invIB*p}else{var k=this.m_K.Solve22(new o,-g,-b);this.m_impulse.x+=k.x,this.m_impulse.y+=k.y,h=k.x*this.m_perp.x,u=k.x*this.m_perp.y,m=k.x*this.m_s1+k.y,p=k.x*this.m_s2+k.y,r.x-=this.m_invMassA*h,r.y-=this.m_invMassA*u,a-=this.m_invIA*m,l.x+=this.m_invMassB*h,l.y+=this.m_invMassB*u,c+=this.m_invIB*p}e.m_linearVelocity.SetV(r),e.m_angularVelocity=a,i.m_linearVelocity.SetV(l),i.m_angularVelocity=c},b.prototype.SolvePositionConstraints=function(i){var r,a,l=this.m_bodyA,c=this.m_bodyB,h=l.m_sweep.c,u=l.m_sweep.a,m=c.m_sweep.c,y=c.m_sweep.a,p=0,d=0,f=0,_=0,v=0,g=0,b=!1,x=0,w=e.FromAngle(u),C=e.FromAngle(y);r=w;var S=this.m_localAnchor1.x-this.m_localCenterA.x,A=this.m_localAnchor1.y-this.m_localCenterA.y;p=r.col1.x*S+r.col2.x*A,A=r.col1.y*S+r.col2.y*A,S=p,r=C;var M=this.m_localAnchor2.x-this.m_localCenterB.x,k=this.m_localAnchor2.y-this.m_localCenterB.y;p=r.col1.x*M+r.col2.x*k,k=r.col1.y*M+r.col2.y*k,M=p;var D=m.x+M-h.x-S,I=m.y+k-h.y-A;if(this.m_enableLimit){this.m_axis=n.MulMV(w,this.m_localXAxis1),this.m_a1=(D+S)*this.m_axis.y-(I+A)*this.m_axis.x,this.m_a2=M*this.m_axis.y-k*this.m_axis.x;var B=this.m_axis.x*D+this.m_axis.y*I;n.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*t.b2_linearSlop?(x=n.Clamp(B,-t.b2_maxLinearCorrection,t.b2_maxLinearCorrection),g=n.Abs(B),b=!0):B<=this.m_lowerTranslation?(x=n.Clamp(B-this.m_lowerTranslation+t.b2_linearSlop,-t.b2_maxLinearCorrection,0),g=this.m_lowerTranslation-B,b=!0):B>=this.m_upperTranslation&&(x=n.Clamp(B-this.m_upperTranslation+t.b2_linearSlop,0,t.b2_maxLinearCorrection),g=B-this.m_upperTranslation,b=!0)}this.m_perp=n.MulMV(w,this.m_localYAxis1),this.m_s1=(D+S)*this.m_perp.y-(I+A)*this.m_perp.x,this.m_s2=M*this.m_perp.y-k*this.m_perp.x;var P=new s,V=this.m_perp.x*D+this.m_perp.y*I,T=y-u-this.m_refAngle;if(g=n.Max(g,n.Abs(V)),a=n.Abs(T),b)d=this.m_invMassA,f=this.m_invMassB,_=this.m_invIA,v=this.m_invIB,this.m_K.col1.x=d+f+_*this.m_s1*this.m_s1+v*this.m_s2*this.m_s2,this.m_K.col1.y=_*this.m_s1+v*this.m_s2,this.m_K.col1.z=_*this.m_s1*this.m_a1+v*this.m_s2*this.m_a2,this.m_K.col2.x=this.m_K.col1.y,this.m_K.col2.y=_+v,this.m_K.col2.z=_*this.m_a1+v*this.m_a2,this.m_K.col3.x=this.m_K.col1.z,this.m_K.col3.y=this.m_K.col2.z,this.m_K.col3.z=d+f+_*this.m_a1*this.m_a1+v*this.m_a2*this.m_a2,this.m_K.Solve33(P,-V,-T,-x);else{d=this.m_invMassA,f=this.m_invMassB,_=this.m_invIA,v=this.m_invIB;var E=d+f+_*this.m_s1*this.m_s1+v*this.m_s2*this.m_s2,L=_*this.m_s1+v*this.m_s2,F=_+v;this.m_K.col1.Set(E,L,0),this.m_K.col2.Set(L,F,0);var G=this.m_K.Solve22(new o,-V,-T);P.x=G.x,P.y=G.y,P.z=0}var R=P.x*this.m_perp.x+P.z*this.m_axis.x,J=P.x*this.m_perp.y+P.z*this.m_axis.y,O=P.x*this.m_s1+P.y+P.z*this.m_a1,j=P.x*this.m_s2+P.y+P.z*this.m_a2;return h.x-=this.m_invMassA*R,h.y-=this.m_invMassA*J,u-=this.m_invIA*O,m.x+=this.m_invMassB*R,m.y+=this.m_invMassB*J,y+=this.m_invIB*j,l.m_sweep.a=u,c.m_sweep.a=y,l.SynchronizeTransform(),c.SynchronizeTransform(),g<=t.b2_linearSlop&&a<=t.b2_angularSlop},Pt.inherit(x,Pt.Dynamics.Joints.b2JointDef),x.prototype.__super=Pt.Dynamics.Joints.b2JointDef.prototype,x.b2PrismaticJointDef=function(){Pt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.localAnchorA=new o,this.localAnchorB=new o,this.localAxisA=new o},x.prototype.b2PrismaticJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_prismaticJoint,this.localAxisA.Set(1,0),this.referenceAngle=0,this.enableLimit=!1,this.lowerTranslation=0,this.upperTranslation=0,this.enableMotor=!1,this.maxMotorForce=0,this.motorSpeed=0},x.prototype.Initialize=function(t,e,i,n){this.bodyA=t,this.bodyB=e,this.localAnchorA=this.bodyA.GetLocalPoint(i),this.localAnchorB=this.bodyB.GetLocalPoint(i),this.localAxisA=this.bodyA.GetLocalVector(n),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},Pt.inherit(w,Pt.Dynamics.Joints.b2Joint),w.prototype.__super=Pt.Dynamics.Joints.b2Joint.prototype,w.b2PulleyJoint=function(){Pt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_groundAnchor1=new o,this.m_groundAnchor2=new o,this.m_localAnchor1=new o,this.m_localAnchor2=new o,this.m_u1=new o,this.m_u2=new o},w.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},w.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},w.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new o(t*this.m_impulse*this.m_u2.x,t*this.m_impulse*this.m_u2.y)},w.prototype.GetReactionTorque=function(t){return 0},w.prototype.GetGroundAnchorA=function(){var t=this.m_ground.m_xf.position.Copy();return t.Add(this.m_groundAnchor1),t},w.prototype.GetGroundAnchorB=function(){var t=this.m_ground.m_xf.position.Copy();return t.Add(this.m_groundAnchor2),t},w.prototype.GetLength1=function(){var t=this.m_bodyA.GetWorldPoint(this.m_localAnchor1),e=this.m_ground.m_xf.position.x+this.m_groundAnchor1.x,i=this.m_ground.m_xf.position.y+this.m_groundAnchor1.y,n=t.x-e,o=t.y-i;return Math.sqrt(n*n+o*o)},w.prototype.GetLength2=function(){var t=this.m_bodyB.GetWorldPoint(this.m_localAnchor2),e=this.m_ground.m_xf.position.x+this.m_groundAnchor2.x,i=this.m_ground.m_xf.position.y+this.m_groundAnchor2.y,n=t.x-e,o=t.y-i;return Math.sqrt(n*n+o*o)},w.prototype.GetRatio=function(){return this.m_ratio},w.prototype.b2PulleyJoint=function(t){this.__super.b2Joint.call(this,t),this.m_ground=this.m_bodyA.m_world.m_groundBody,this.m_groundAnchor1.x=t.groundAnchorA.x-this.m_ground.m_xf.position.x,this.m_groundAnchor1.y=t.groundAnchorA.y-this.m_ground.m_xf.position.y,this.m_groundAnchor2.x=t.groundAnchorB.x-this.m_ground.m_xf.position.x,this.m_groundAnchor2.y=t.groundAnchorB.y-this.m_ground.m_xf.position.y,this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_ratio=t.ratio,this.m_constant=t.lengthA+this.m_ratio*t.lengthB,this.m_maxLength1=n.Min(t.maxLengthA,this.m_constant-this.m_ratio*w.b2_minPulleyLength),this.m_maxLength2=n.Min(t.maxLengthB,(this.m_constant-w.b2_minPulleyLength)/this.m_ratio),this.m_impulse=0,this.m_limitImpulse1=0,this.m_limitImpulse2=0},w.prototype.InitVelocityConstraints=function(e){var i,n=this.m_bodyA,o=this.m_bodyB;i=n.m_xf.R;var s=this.m_localAnchor1.x-n.m_sweep.localCenter.x,r=this.m_localAnchor1.y-n.m_sweep.localCenter.y,a=i.col1.x*s+i.col2.x*r;r=i.col1.y*s+i.col2.y*r,s=a,i=o.m_xf.R;var l=this.m_localAnchor2.x-o.m_sweep.localCenter.x,c=this.m_localAnchor2.y-o.m_sweep.localCenter.y;a=i.col1.x*l+i.col2.x*c,c=i.col1.y*l+i.col2.y*c,l=a;var h=n.m_sweep.c.x+s,u=n.m_sweep.c.y+r,m=o.m_sweep.c.x+l,p=o.m_sweep.c.y+c,d=this.m_ground.m_xf.position.x+this.m_groundAnchor1.x,f=this.m_ground.m_xf.position.y+this.m_groundAnchor1.y,_=this.m_ground.m_xf.position.x+this.m_groundAnchor2.x,v=this.m_ground.m_xf.position.y+this.m_groundAnchor2.y;this.m_u1.Set(h-d,u-f),this.m_u2.Set(m-_,p-v);var g=this.m_u1.Length(),b=this.m_u2.Length();g>t.b2_linearSlop?this.m_u1.Multiply(1/g):this.m_u1.SetZero(),b>t.b2_linearSlop?this.m_u2.Multiply(1/b):this.m_u2.SetZero(),this.m_constant-g-this.m_ratio*b>0?(this.m_state=y.e_inactiveLimit,this.m_impulse=0):this.m_state=y.e_atUpperLimit,g<this.m_maxLength1?(this.m_limitState1=y.e_inactiveLimit,this.m_limitImpulse1=0):this.m_limitState1=y.e_atUpperLimit,b<this.m_maxLength2?(this.m_limitState2=y.e_inactiveLimit,this.m_limitImpulse2=0):this.m_limitState2=y.e_atUpperLimit;var x=s*this.m_u1.y-r*this.m_u1.x,w=l*this.m_u2.y-c*this.m_u2.x;if(this.m_limitMass1=n.m_invMass+n.m_invI*x*x,this.m_limitMass2=o.m_invMass+o.m_invI*w*w,this.m_pulleyMass=this.m_limitMass1+this.m_ratio*this.m_ratio*this.m_limitMass2,this.m_limitMass1=1/this.m_limitMass1,this.m_limitMass2=1/this.m_limitMass2,this.m_pulleyMass=1/this.m_pulleyMass,e.warmStarting){this.m_impulse*=e.dtRatio,this.m_limitImpulse1*=e.dtRatio,this.m_limitImpulse2*=e.dtRatio;var C=(-this.m_impulse-this.m_limitImpulse1)*this.m_u1.x,S=(-this.m_impulse-this.m_limitImpulse1)*this.m_u1.y,A=(-this.m_ratio*this.m_impulse-this.m_limitImpulse2)*this.m_u2.x,M=(-this.m_ratio*this.m_impulse-this.m_limitImpulse2)*this.m_u2.y;n.m_linearVelocity.x+=n.m_invMass*C,n.m_linearVelocity.y+=n.m_invMass*S,n.m_angularVelocity+=n.m_invI*(s*S-r*C),o.m_linearVelocity.x+=o.m_invMass*A,o.m_linearVelocity.y+=o.m_invMass*M,o.m_angularVelocity+=o.m_invI*(l*M-c*A)}else this.m_impulse=0,this.m_limitImpulse1=0,this.m_limitImpulse2=0},w.prototype.SolveVelocityConstraints=function(t){var e,i=this.m_bodyA,o=this.m_bodyB;e=i.m_xf.R;var s=this.m_localAnchor1.x-i.m_sweep.localCenter.x,r=this.m_localAnchor1.y-i.m_sweep.localCenter.y,a=e.col1.x*s+e.col2.x*r;r=e.col1.y*s+e.col2.y*r,s=a,e=o.m_xf.R;var l=this.m_localAnchor2.x-o.m_sweep.localCenter.x,c=this.m_localAnchor2.y-o.m_sweep.localCenter.y;a=e.col1.x*l+e.col2.x*c,c=e.col1.y*l+e.col2.y*c,l=a;var h=0,u=0,m=0,p=0,d=0,f=0,_=0,v=0,g=0,b=0,x=0;this.m_state==y.e_atUpperLimit&&(h=i.m_linearVelocity.x+-i.m_angularVelocity*r,u=i.m_linearVelocity.y+i.m_angularVelocity*s,m=o.m_linearVelocity.x+-o.m_angularVelocity*c,p=o.m_linearVelocity.y+o.m_angularVelocity*l,g=-(this.m_u1.x*h+this.m_u1.y*u)-this.m_ratio*(this.m_u2.x*m+this.m_u2.y*p),b=this.m_pulleyMass*-g,x=this.m_impulse,this.m_impulse=n.Max(0,this.m_impulse+b),d=-(b=this.m_impulse-x)*this.m_u1.x,f=-b*this.m_u1.y,_=-this.m_ratio*b*this.m_u2.x,v=-this.m_ratio*b*this.m_u2.y,i.m_linearVelocity.x+=i.m_invMass*d,i.m_linearVelocity.y+=i.m_invMass*f,i.m_angularVelocity+=i.m_invI*(s*f-r*d),o.m_linearVelocity.x+=o.m_invMass*_,o.m_linearVelocity.y+=o.m_invMass*v,o.m_angularVelocity+=o.m_invI*(l*v-c*_)),this.m_limitState1==y.e_atUpperLimit&&(h=i.m_linearVelocity.x+-i.m_angularVelocity*r,u=i.m_linearVelocity.y+i.m_angularVelocity*s,g=-(this.m_u1.x*h+this.m_u1.y*u),b=-this.m_limitMass1*g,x=this.m_limitImpulse1,this.m_limitImpulse1=n.Max(0,this.m_limitImpulse1+b),d=-(b=this.m_limitImpulse1-x)*this.m_u1.x,f=-b*this.m_u1.y,i.m_linearVelocity.x+=i.m_invMass*d,i.m_linearVelocity.y+=i.m_invMass*f,i.m_angularVelocity+=i.m_invI*(s*f-r*d)),this.m_limitState2==y.e_atUpperLimit&&(m=o.m_linearVelocity.x+-o.m_angularVelocity*c,p=o.m_linearVelocity.y+o.m_angularVelocity*l,g=-(this.m_u2.x*m+this.m_u2.y*p),b=-this.m_limitMass2*g,x=this.m_limitImpulse2,this.m_limitImpulse2=n.Max(0,this.m_limitImpulse2+b),_=-(b=this.m_limitImpulse2-x)*this.m_u2.x,v=-b*this.m_u2.y,o.m_linearVelocity.x+=o.m_invMass*_,o.m_linearVelocity.y+=o.m_invMass*v,o.m_angularVelocity+=o.m_invI*(l*v-c*_))},w.prototype.SolvePositionConstraints=function(e){var i,o=this.m_bodyA,s=this.m_bodyB,r=this.m_ground.m_xf.position.x+this.m_groundAnchor1.x,a=this.m_ground.m_xf.position.y+this.m_groundAnchor1.y,l=this.m_ground.m_xf.position.x+this.m_groundAnchor2.x,c=this.m_ground.m_xf.position.y+this.m_groundAnchor2.y,h=0,u=0,m=0,p=0,d=0,f=0,_=0,v=0,g=0,b=0,x=0,w=0,C=0,S=0;return this.m_state==y.e_atUpperLimit&&(i=o.m_xf.R,h=this.m_localAnchor1.x-o.m_sweep.localCenter.x,u=this.m_localAnchor1.y-o.m_sweep.localCenter.y,C=i.col1.x*h+i.col2.x*u,u=i.col1.y*h+i.col2.y*u,h=C,i=s.m_xf.R,m=this.m_localAnchor2.x-s.m_sweep.localCenter.x,p=this.m_localAnchor2.y-s.m_sweep.localCenter.y,C=i.col1.x*m+i.col2.x*p,p=i.col1.y*m+i.col2.y*p,m=C,d=o.m_sweep.c.x+h,f=o.m_sweep.c.y+u,_=s.m_sweep.c.x+m,v=s.m_sweep.c.y+p,this.m_u1.Set(d-r,f-a),this.m_u2.Set(_-l,v-c),g=this.m_u1.Length(),b=this.m_u2.Length(),g>t.b2_linearSlop?this.m_u1.Multiply(1/g):this.m_u1.SetZero(),b>t.b2_linearSlop?this.m_u2.Multiply(1/b):this.m_u2.SetZero(),x=this.m_constant-g-this.m_ratio*b,S=n.Max(S,-x),x=n.Clamp(x+t.b2_linearSlop,-t.b2_maxLinearCorrection,0),d=-(w=-this.m_pulleyMass*x)*this.m_u1.x,f=-w*this.m_u1.y,_=-this.m_ratio*w*this.m_u2.x,v=-this.m_ratio*w*this.m_u2.y,o.m_sweep.c.x+=o.m_invMass*d,o.m_sweep.c.y+=o.m_invMass*f,o.m_sweep.a+=o.m_invI*(h*f-u*d),s.m_sweep.c.x+=s.m_invMass*_,s.m_sweep.c.y+=s.m_invMass*v,s.m_sweep.a+=s.m_invI*(m*v-p*_),o.SynchronizeTransform(),s.SynchronizeTransform()),this.m_limitState1==y.e_atUpperLimit&&(i=o.m_xf.R,h=this.m_localAnchor1.x-o.m_sweep.localCenter.x,u=this.m_localAnchor1.y-o.m_sweep.localCenter.y,C=i.col1.x*h+i.col2.x*u,u=i.col1.y*h+i.col2.y*u,h=C,d=o.m_sweep.c.x+h,f=o.m_sweep.c.y+u,this.m_u1.Set(d-r,f-a),(g=this.m_u1.Length())>t.b2_linearSlop?(this.m_u1.x*=1/g,this.m_u1.y*=1/g):this.m_u1.SetZero(),x=this.m_maxLength1-g,S=n.Max(S,-x),x=n.Clamp(x+t.b2_linearSlop,-t.b2_maxLinearCorrection,0),d=-(w=-this.m_limitMass1*x)*this.m_u1.x,f=-w*this.m_u1.y,o.m_sweep.c.x+=o.m_invMass*d,o.m_sweep.c.y+=o.m_invMass*f,o.m_sweep.a+=o.m_invI*(h*f-u*d),o.SynchronizeTransform()),this.m_limitState2==y.e_atUpperLimit&&(i=s.m_xf.R,m=this.m_localAnchor2.x-s.m_sweep.localCenter.x,p=this.m_localAnchor2.y-s.m_sweep.localCenter.y,C=i.col1.x*m+i.col2.x*p,p=i.col1.y*m+i.col2.y*p,m=C,_=s.m_sweep.c.x+m,v=s.m_sweep.c.y+p,this.m_u2.Set(_-l,v-c),(b=this.m_u2.Length())>t.b2_linearSlop?(this.m_u2.x*=1/b,this.m_u2.y*=1/b):this.m_u2.SetZero(),x=this.m_maxLength2-b,S=n.Max(S,-x),x=n.Clamp(x+t.b2_linearSlop,-t.b2_maxLinearCorrection,0),_=-(w=-this.m_limitMass2*x)*this.m_u2.x,v=-w*this.m_u2.y,s.m_sweep.c.x+=s.m_invMass*_,s.m_sweep.c.y+=s.m_invMass*v,s.m_sweep.a+=s.m_invI*(m*v-p*_),s.SynchronizeTransform()),S<t.b2_linearSlop},Pt.postDefs.push(function(){Pt.Dynamics.Joints.b2PulleyJoint.b2_minPulleyLength=2}),Pt.inherit(C,Pt.Dynamics.Joints.b2JointDef),C.prototype.__super=Pt.Dynamics.Joints.b2JointDef.prototype,C.b2PulleyJointDef=function(){Pt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.groundAnchorA=new o,this.groundAnchorB=new o,this.localAnchorA=new o,this.localAnchorB=new o},C.prototype.b2PulleyJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_pulleyJoint,this.groundAnchorA.Set(-1,1),this.groundAnchorB.Set(1,1),this.localAnchorA.Set(-1,0),this.localAnchorB.Set(1,0),this.lengthA=0,this.maxLengthA=0,this.lengthB=0,this.maxLengthB=0,this.ratio=1,this.collideConnected=!0},C.prototype.Initialize=function(t,e,i,n,o,s,r){void 0===r&&(r=0),this.bodyA=t,this.bodyB=e,this.groundAnchorA.SetV(i),this.groundAnchorB.SetV(n),this.localAnchorA=this.bodyA.GetLocalPoint(o),this.localAnchorB=this.bodyB.GetLocalPoint(s);var a=o.x-i.x,l=o.y-i.y;this.lengthA=Math.sqrt(a*a+l*l);var c=s.x-n.x,h=s.y-n.y;this.lengthB=Math.sqrt(c*c+h*h),this.ratio=r;var u=this.lengthA+this.ratio*this.lengthB;this.maxLengthA=u-this.ratio*w.b2_minPulleyLength,this.maxLengthB=(u-w.b2_minPulleyLength)/this.ratio},Pt.inherit(S,Pt.Dynamics.Joints.b2Joint),S.prototype.__super=Pt.Dynamics.Joints.b2Joint.prototype,S.b2RevoluteJoint=function(){Pt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.K=new e,this.K1=new e,this.K2=new e,this.K3=new e,this.impulse3=new s,this.impulse2=new o,this.reduced=new o,this.m_localAnchor1=new o,this.m_localAnchor2=new o,this.m_impulse=new s,this.m_mass=new i},S.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},S.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},S.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new o(t*this.m_impulse.x,t*this.m_impulse.y)},S.prototype.GetReactionTorque=function(t){return void 0===t&&(t=0),t*this.m_impulse.z},S.prototype.GetJointAngle=function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle},S.prototype.GetJointSpeed=function(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity},S.prototype.IsLimitEnabled=function(){return this.m_enableLimit},S.prototype.EnableLimit=function(t){this.m_enableLimit=t},S.prototype.GetLowerLimit=function(){return this.m_lowerAngle},S.prototype.GetUpperLimit=function(){return this.m_upperAngle},S.prototype.SetLimits=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.m_lowerAngle=t,this.m_upperAngle=e},S.prototype.IsMotorEnabled=function(){return this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor},S.prototype.EnableMotor=function(t){this.m_enableMotor=t},S.prototype.SetMotorSpeed=function(t){void 0===t&&(t=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t},S.prototype.GetMotorSpeed=function(){return this.m_motorSpeed},S.prototype.SetMaxMotorTorque=function(t){void 0===t&&(t=0),this.m_maxMotorTorque=t},S.prototype.GetMotorTorque=function(){return this.m_maxMotorTorque},S.prototype.b2RevoluteJoint=function(t){this.__super.b2Joint.call(this,t),this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_referenceAngle=t.referenceAngle,this.m_impulse.SetZero(),this.m_motorImpulse=0,this.m_lowerAngle=t.lowerAngle,this.m_upperAngle=t.upperAngle,this.m_maxMotorTorque=t.maxMotorTorque,this.m_motorSpeed=t.motorSpeed,this.m_enableLimit=t.enableLimit,this.m_enableMotor=t.enableMotor,this.m_limitState=y.e_inactiveLimit},S.prototype.InitVelocityConstraints=function(e){var i,o=this.m_bodyA,s=this.m_bodyB,r=0;this.m_enableMotor||this.m_enableLimit,i=o.m_xf.R;var a=this.m_localAnchor1.x-o.m_sweep.localCenter.x,l=this.m_localAnchor1.y-o.m_sweep.localCenter.y;r=i.col1.x*a+i.col2.x*l,l=i.col1.y*a+i.col2.y*l,a=r,i=s.m_xf.R;var c=this.m_localAnchor2.x-s.m_sweep.localCenter.x,h=this.m_localAnchor2.y-s.m_sweep.localCenter.y;r=i.col1.x*c+i.col2.x*h,h=i.col1.y*c+i.col2.y*h,c=r;var u=o.m_invMass,m=s.m_invMass,p=o.m_invI,d=s.m_invI;if(this.m_mass.col1.x=u+m+l*l*p+h*h*d,this.m_mass.col2.x=-l*a*p-h*c*d,this.m_mass.col3.x=-l*p-h*d,this.m_mass.col1.y=this.m_mass.col2.x,this.m_mass.col2.y=u+m+a*a*p+c*c*d,this.m_mass.col3.y=a*p+c*d,this.m_mass.col1.z=this.m_mass.col3.x,this.m_mass.col2.z=this.m_mass.col3.y,this.m_mass.col3.z=p+d,this.m_motorMass=1/(p+d),0==this.m_enableMotor&&(this.m_motorImpulse=0),this.m_enableLimit){var f=s.m_sweep.a-o.m_sweep.a-this.m_referenceAngle;n.Abs(this.m_upperAngle-this.m_lowerAngle)<2*t.b2_angularSlop?this.m_limitState=y.e_equalLimits:f<=this.m_lowerAngle?(this.m_limitState!=y.e_atLowerLimit&&(this.m_impulse.z=0),this.m_limitState=y.e_atLowerLimit):f>=this.m_upperAngle?(this.m_limitState!=y.e_atUpperLimit&&(this.m_impulse.z=0),this.m_limitState=y.e_atUpperLimit):(this.m_limitState=y.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=y.e_inactiveLimit;if(e.warmStarting){this.m_impulse.x*=e.dtRatio,this.m_impulse.y*=e.dtRatio,this.m_motorImpulse*=e.dtRatio;var _=this.m_impulse.x,v=this.m_impulse.y;o.m_linearVelocity.x-=u*_,o.m_linearVelocity.y-=u*v,o.m_angularVelocity-=p*(a*v-l*_+this.m_motorImpulse+this.m_impulse.z),s.m_linearVelocity.x+=m*_,s.m_linearVelocity.y+=m*v,s.m_angularVelocity+=d*(c*v-h*_+this.m_motorImpulse+this.m_impulse.z)}else this.m_impulse.SetZero(),this.m_motorImpulse=0},S.prototype.SolveVelocityConstraints=function(t){var e,i=this.m_bodyA,o=this.m_bodyB,s=0,r=0,a=0,l=0,c=0,h=i.m_linearVelocity,u=i.m_angularVelocity,m=o.m_linearVelocity,p=o.m_angularVelocity,d=i.m_invMass,f=o.m_invMass,_=i.m_invI,v=o.m_invI;if(this.m_enableMotor&&this.m_limitState!=y.e_equalLimits){var g=p-u-this.m_motorSpeed,b=this.m_motorMass*-g,x=this.m_motorImpulse,w=t.dt*this.m_maxMotorTorque;this.m_motorImpulse=n.Clamp(this.m_motorImpulse+b,-w,w),u-=_*(b=this.m_motorImpulse-x),p+=v*b}if(this.m_enableLimit&&this.m_limitState!=y.e_inactiveLimit){e=i.m_xf.R,r=this.m_localAnchor1.x-i.m_sweep.localCenter.x,a=this.m_localAnchor1.y-i.m_sweep.localCenter.y,s=e.col1.x*r+e.col2.x*a,a=e.col1.y*r+e.col2.y*a,r=s,e=o.m_xf.R,l=this.m_localAnchor2.x-o.m_sweep.localCenter.x,c=this.m_localAnchor2.y-o.m_sweep.localCenter.y,s=e.col1.x*l+e.col2.x*c,c=e.col1.y*l+e.col2.y*c,l=s;var C=m.x+-p*c-h.x- -u*a,S=m.y+p*l-h.y-u*r,A=p-u;this.m_mass.Solve33(this.impulse3,-C,-S,-A),this.m_limitState==y.e_equalLimits?this.m_impulse.Add(this.impulse3):this.m_limitState==y.e_atLowerLimit?this.m_impulse.z+this.impulse3.z<0&&(this.m_mass.Solve22(this.reduced,-C,-S),this.impulse3.x=this.reduced.x,this.impulse3.y=this.reduced.y,this.impulse3.z=-this.m_impulse.z,this.m_impulse.x+=this.reduced.x,this.m_impulse.y+=this.reduced.y,this.m_impulse.z=0):this.m_limitState==y.e_atUpperLimit&&this.m_impulse.z+this.impulse3.z>0&&(this.m_mass.Solve22(this.reduced,-C,-S),this.impulse3.x=this.reduced.x,this.impulse3.y=this.reduced.y,this.impulse3.z=-this.m_impulse.z,this.m_impulse.x+=this.reduced.x,this.m_impulse.y+=this.reduced.y,this.m_impulse.z=0),h.x-=d*this.impulse3.x,h.y-=d*this.impulse3.y,u-=_*(r*this.impulse3.y-a*this.impulse3.x+this.impulse3.z),m.x+=f*this.impulse3.x,m.y+=f*this.impulse3.y,p+=v*(l*this.impulse3.y-c*this.impulse3.x+this.impulse3.z)}else{e=i.m_xf.R,r=this.m_localAnchor1.x-i.m_sweep.localCenter.x,a=this.m_localAnchor1.y-i.m_sweep.localCenter.y,s=e.col1.x*r+e.col2.x*a,a=e.col1.y*r+e.col2.y*a,r=s,e=o.m_xf.R,l=this.m_localAnchor2.x-o.m_sweep.localCenter.x,c=this.m_localAnchor2.y-o.m_sweep.localCenter.y,s=e.col1.x*l+e.col2.x*c,c=e.col1.y*l+e.col2.y*c,l=s;var M=m.x+-p*c-h.x- -u*a,k=m.y+p*l-h.y-u*r;this.m_mass.Solve22(this.impulse2,-M,-k),this.m_impulse.x+=this.impulse2.x,this.m_impulse.y+=this.impulse2.y,h.x-=d*this.impulse2.x,h.y-=d*this.impulse2.y,u-=_*(r*this.impulse2.y-a*this.impulse2.x),m.x+=f*this.impulse2.x,m.y+=f*this.impulse2.y,p+=v*(l*this.impulse2.y-c*this.impulse2.x)}i.m_linearVelocity.SetV(h),i.m_angularVelocity=u,o.m_linearVelocity.SetV(m),o.m_angularVelocity=p},S.prototype.SolvePositionConstraints=function(e){var i,o,s=0,r=this.m_bodyA,a=this.m_bodyB,l=0,c=0,h=0,u=0;if(this.m_enableLimit&&this.m_limitState!=y.e_inactiveLimit){var m=a.m_sweep.a-r.m_sweep.a-this.m_referenceAngle,p=0;this.m_limitState==y.e_equalLimits?(s=n.Clamp(m-this.m_lowerAngle,-t.b2_maxAngularCorrection,t.b2_maxAngularCorrection),p=-this.m_motorMass*s,l=n.Abs(s)):this.m_limitState==y.e_atLowerLimit?(l=-(s=m-this.m_lowerAngle),s=n.Clamp(s+t.b2_angularSlop,-t.b2_maxAngularCorrection,0),p=-this.m_motorMass*s):this.m_limitState==y.e_atUpperLimit&&(l=s=m-this.m_upperAngle,s=n.Clamp(s-t.b2_angularSlop,0,t.b2_maxAngularCorrection),p=-this.m_motorMass*s),r.m_sweep.a-=r.m_invI*p,a.m_sweep.a+=a.m_invI*p,r.SynchronizeTransform(),a.SynchronizeTransform()}i=r.m_xf.R;var d=this.m_localAnchor1.x-r.m_sweep.localCenter.x,f=this.m_localAnchor1.y-r.m_sweep.localCenter.y;c=i.col1.x*d+i.col2.x*f,f=i.col1.y*d+i.col2.y*f,d=c,i=a.m_xf.R;var _=this.m_localAnchor2.x-a.m_sweep.localCenter.x,v=this.m_localAnchor2.y-a.m_sweep.localCenter.y;c=i.col1.x*_+i.col2.x*v,v=i.col1.y*_+i.col2.y*v,_=c;var g=a.m_sweep.c.x+_-r.m_sweep.c.x-d,b=a.m_sweep.c.y+v-r.m_sweep.c.y-f,x=g*g+b*b;o=Math.sqrt(x);var w=r.m_invMass,C=a.m_invMass,A=r.m_invI,M=a.m_invI,k=10*t.b2_linearSlop;if(x>k*k){var D=1/(w+C);h=D*-g,u=D*-b;var I=.5;r.m_sweep.c.x-=I*w*h,r.m_sweep.c.y-=I*w*u,a.m_sweep.c.x+=I*C*h,a.m_sweep.c.y+=I*C*u,g=a.m_sweep.c.x+_-r.m_sweep.c.x-d,b=a.m_sweep.c.y+v-r.m_sweep.c.y-f}return this.K1.col1.x=w+C,this.K1.col2.x=0,this.K1.col1.y=0,this.K1.col2.y=w+C,this.K2.col1.x=A*f*f,this.K2.col2.x=-A*d*f,this.K2.col1.y=-A*d*f,this.K2.col2.y=A*d*d,this.K3.col1.x=M*v*v,this.K3.col2.x=-M*_*v,this.K3.col1.y=-M*_*v,this.K3.col2.y=M*_*_,this.K.SetM(this.K1),this.K.AddM(this.K2),this.K.AddM(this.K3),this.K.Solve(S.tImpulse,-g,-b),h=S.tImpulse.x,u=S.tImpulse.y,r.m_sweep.c.x-=r.m_invMass*h,r.m_sweep.c.y-=r.m_invMass*u,r.m_sweep.a-=r.m_invI*(d*u-f*h),a.m_sweep.c.x+=a.m_invMass*h,a.m_sweep.c.y+=a.m_invMass*u,a.m_sweep.a+=a.m_invI*(_*u-v*h),r.SynchronizeTransform(),a.SynchronizeTransform(),o<=t.b2_linearSlop&&l<=t.b2_angularSlop},Pt.postDefs.push(function(){Pt.Dynamics.Joints.b2RevoluteJoint.tImpulse=new o}),Pt.inherit(A,Pt.Dynamics.Joints.b2JointDef),A.prototype.__super=Pt.Dynamics.Joints.b2JointDef.prototype,A.b2RevoluteJointDef=function(){Pt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.localAnchorA=new o,this.localAnchorB=new o},A.prototype.b2RevoluteJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_revoluteJoint,this.localAnchorA.Set(0,0),this.localAnchorB.Set(0,0),this.referenceAngle=0,this.lowerAngle=0,this.upperAngle=0,this.maxMotorTorque=0,this.motorSpeed=0,this.enableLimit=!1,this.enableMotor=!1},A.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.localAnchorA=this.bodyA.GetLocalPoint(i),this.localAnchorB=this.bodyB.GetLocalPoint(i),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},Pt.inherit(M,Pt.Dynamics.Joints.b2Joint),M.prototype.__super=Pt.Dynamics.Joints.b2Joint.prototype,M.b2WeldJoint=function(){Pt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_localAnchorA=new o,this.m_localAnchorB=new o,this.m_impulse=new s,this.m_mass=new i},M.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA)},M.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB)},M.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new o(t*this.m_impulse.x,t*this.m_impulse.y)},M.prototype.GetReactionTorque=function(t){return void 0===t&&(t=0),t*this.m_impulse.z},M.prototype.b2WeldJoint=function(t){this.__super.b2Joint.call(this,t),this.m_localAnchorA.SetV(t.localAnchorA),this.m_localAnchorB.SetV(t.localAnchorB),this.m_referenceAngle=t.referenceAngle,this.m_impulse.SetZero(),this.m_mass=new i},M.prototype.InitVelocityConstraints=function(t){var e,i=0,n=this.m_bodyA,o=this.m_bodyB;e=n.m_xf.R;var s=this.m_localAnchorA.x-n.m_sweep.localCenter.x,r=this.m_localAnchorA.y-n.m_sweep.localCenter.y;i=e.col1.x*s+e.col2.x*r,r=e.col1.y*s+e.col2.y*r,s=i,e=o.m_xf.R;var a=this.m_localAnchorB.x-o.m_sweep.localCenter.x,l=this.m_localAnchorB.y-o.m_sweep.localCenter.y;i=e.col1.x*a+e.col2.x*l,l=e.col1.y*a+e.col2.y*l,a=i;var c=n.m_invMass,h=o.m_invMass,u=n.m_invI,m=o.m_invI;this.m_mass.col1.x=c+h+r*r*u+l*l*m,this.m_mass.col2.x=-r*s*u-l*a*m,this.m_mass.col3.x=-r*u-l*m,this.m_mass.col1.y=this.m_mass.col2.x,this.m_mass.col2.y=c+h+s*s*u+a*a*m,this.m_mass.col3.y=s*u+a*m,this.m_mass.col1.z=this.m_mass.col3.x,this.m_mass.col2.z=this.m_mass.col3.y,this.m_mass.col3.z=u+m,t.warmStarting?(this.m_impulse.x*=t.dtRatio,this.m_impulse.y*=t.dtRatio,this.m_impulse.z*=t.dtRatio,n.m_linearVelocity.x-=c*this.m_impulse.x,n.m_linearVelocity.y-=c*this.m_impulse.y,n.m_angularVelocity-=u*(s*this.m_impulse.y-r*this.m_impulse.x+this.m_impulse.z),o.m_linearVelocity.x+=h*this.m_impulse.x,o.m_linearVelocity.y+=h*this.m_impulse.y,o.m_angularVelocity+=m*(a*this.m_impulse.y-l*this.m_impulse.x+this.m_impulse.z)):this.m_impulse.SetZero()},M.prototype.SolveVelocityConstraints=function(t){var e,i=0,n=this.m_bodyA,o=this.m_bodyB,r=n.m_linearVelocity,a=n.m_angularVelocity,l=o.m_linearVelocity,c=o.m_angularVelocity,h=n.m_invMass,u=o.m_invMass,m=n.m_invI,y=o.m_invI;e=n.m_xf.R;var p=this.m_localAnchorA.x-n.m_sweep.localCenter.x,d=this.m_localAnchorA.y-n.m_sweep.localCenter.y;i=e.col1.x*p+e.col2.x*d,d=e.col1.y*p+e.col2.y*d,p=i,e=o.m_xf.R;var f=this.m_localAnchorB.x-o.m_sweep.localCenter.x,_=this.m_localAnchorB.y-o.m_sweep.localCenter.y;i=e.col1.x*f+e.col2.x*_,_=e.col1.y*f+e.col2.y*_,f=i;var v=l.x-c*_-r.x+a*d,g=l.y+c*f-r.y-a*p,b=c-a,x=new s;this.m_mass.Solve33(x,-v,-g,-b),this.m_impulse.Add(x),r.x-=h*x.x,r.y-=h*x.y,a-=m*(p*x.y-d*x.x+x.z),l.x+=u*x.x,l.y+=u*x.y,c+=y*(f*x.y-_*x.x+x.z),n.m_angularVelocity=a,o.m_angularVelocity=c},M.prototype.SolvePositionConstraints=function(e){var i,o=0,r=this.m_bodyA,a=this.m_bodyB;i=r.m_xf.R;var l=this.m_localAnchorA.x-r.m_sweep.localCenter.x,c=this.m_localAnchorA.y-r.m_sweep.localCenter.y;o=i.col1.x*l+i.col2.x*c,c=i.col1.y*l+i.col2.y*c,l=o,i=a.m_xf.R;var h=this.m_localAnchorB.x-a.m_sweep.localCenter.x,u=this.m_localAnchorB.y-a.m_sweep.localCenter.y;o=i.col1.x*h+i.col2.x*u,u=i.col1.y*h+i.col2.y*u,h=o;var m=r.m_invMass,y=a.m_invMass,p=r.m_invI,d=a.m_invI,f=a.m_sweep.c.x+h-r.m_sweep.c.x-l,_=a.m_sweep.c.y+u-r.m_sweep.c.y-c,v=a.m_sweep.a-r.m_sweep.a-this.m_referenceAngle,g=10*t.b2_linearSlop,b=Math.sqrt(f*f+_*_),x=n.Abs(v);b>g&&(p*=1,d*=1),this.m_mass.col1.x=m+y+c*c*p+u*u*d,this.m_mass.col2.x=-c*l*p-u*h*d,this.m_mass.col3.x=-c*p-u*d,this.m_mass.col1.y=this.m_mass.col2.x,this.m_mass.col2.y=m+y+l*l*p+h*h*d,this.m_mass.col3.y=l*p+h*d,this.m_mass.col1.z=this.m_mass.col3.x,this.m_mass.col2.z=this.m_mass.col3.y,this.m_mass.col3.z=p+d;var w=new s;return this.m_mass.Solve33(w,-f,-_,-v),r.m_sweep.c.x-=m*w.x,r.m_sweep.c.y-=m*w.y,r.m_sweep.a-=p*(l*w.y-c*w.x+w.z),a.m_sweep.c.x+=y*w.x,a.m_sweep.c.y+=y*w.y,a.m_sweep.a+=d*(h*w.y-u*w.x+w.z),r.SynchronizeTransform(),a.SynchronizeTransform(),b<=t.b2_linearSlop&&x<=t.b2_angularSlop},Pt.inherit(k,Pt.Dynamics.Joints.b2JointDef),k.prototype.__super=Pt.Dynamics.Joints.b2JointDef.prototype,k.b2WeldJointDef=function(){Pt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.localAnchorA=new o,this.localAnchorB=new o},k.prototype.b2WeldJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_weldJoint,this.referenceAngle=0},k.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.localAnchorA.SetV(this.bodyA.GetLocalPoint(i)),this.localAnchorB.SetV(this.bodyB.GetLocalPoint(i)),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}(),(Vt=Pt.Dynamics.b2DebugDraw).b2DebugDraw=function(){this.m_drawScale=1,this.m_lineThickness=1,this.m_alpha=1,this.m_fillAlpha=1,this.m_xformScale=1;var t=this;this.m_sprite={graphics:{clear:function(){t.m_ctx.clearRect(0,0,t.m_ctx.canvas.width,t.m_ctx.canvas.height)}}}},Vt.prototype._color=function(t,e){return"rgba("+((16711680&t)>>16)+","+((65280&t)>>8)+","+(255&t)+","+e+")"},Vt.prototype.b2DebugDraw=function(){this.m_drawFlags=0},Vt.prototype.SetFlags=function(t){void 0===t&&(t=0),this.m_drawFlags=t},Vt.prototype.GetFlags=function(){return this.m_drawFlags},Vt.prototype.AppendFlags=function(t){void 0===t&&(t=0),this.m_drawFlags|=t},Vt.prototype.ClearFlags=function(t){void 0===t&&(t=0),this.m_drawFlags&=~t},Vt.prototype.SetSprite=function(t){this.m_ctx=t},Vt.prototype.GetSprite=function(){return this.m_ctx},Vt.prototype.SetDrawScale=function(t){void 0===t&&(t=0),this.m_drawScale=t},Vt.prototype.GetDrawScale=function(){return this.m_drawScale},Vt.prototype.SetLineThickness=function(t){void 0===t&&(t=0),this.m_lineThickness=t,this.m_ctx.strokeWidth=t},Vt.prototype.GetLineThickness=function(){return this.m_lineThickness},Vt.prototype.SetAlpha=function(t){void 0===t&&(t=0),this.m_alpha=t},Vt.prototype.GetAlpha=function(){return this.m_alpha},Vt.prototype.SetFillAlpha=function(t){void 0===t&&(t=0),this.m_fillAlpha=t},Vt.prototype.GetFillAlpha=function(){return this.m_fillAlpha},Vt.prototype.SetXFormScale=function(t){void 0===t&&(t=0),this.m_xformScale=t},Vt.prototype.GetXFormScale=function(){return this.m_xformScale},Vt.prototype.DrawPolygon=function(t,e,i){if(e){var n=this.m_ctx,o=this.m_drawScale;n.beginPath(),n.strokeStyle=this._color(i.color,this.m_alpha),n.moveTo(t[0].x*o,t[0].y*o);for(var s=1;s<e;s++)n.lineTo(t[s].x*o,t[s].y*o);n.lineTo(t[0].x*o,t[0].y*o),n.closePath(),n.stroke()}},Vt.prototype.DrawSolidPolygon=function(t,e,i){if(e){var n=this.m_ctx,o=this.m_drawScale;n.beginPath(),n.strokeStyle=this._color(i.color,this.m_alpha),n.fillStyle=this._color(i.color,this.m_fillAlpha),n.moveTo(t[0].x*o,t[0].y*o);for(var s=1;s<e;s++)n.lineTo(t[s].x*o,t[s].y*o);n.lineTo(t[0].x*o,t[0].y*o),n.closePath(),n.fill(),n.stroke()}},Vt.prototype.DrawCircle=function(t,e,i){if(e){var n=this.m_ctx,o=this.m_drawScale;n.beginPath(),n.strokeStyle=this._color(i.color,this.m_alpha),n.arc(t.x*o,t.y*o,e*o,0,2*Math.PI,!0),n.closePath(),n.stroke()}},Vt.prototype.DrawSolidCircle=function(t,e,i,n){if(e){var o=this.m_ctx,s=this.m_drawScale,r=t.x*s,a=t.y*s;o.moveTo(0,0),o.beginPath(),o.strokeStyle=this._color(n.color,this.m_alpha),o.fillStyle=this._color(n.color,this.m_fillAlpha),o.arc(r,a,e*s,0,2*Math.PI,!0),o.moveTo(r,a),o.lineTo((t.x+i.x*e)*s,(t.y+i.y*e)*s),o.closePath(),o.fill(),o.stroke()}},Vt.prototype.DrawSegment=function(t,e,i){var n=this.m_ctx,o=this.m_drawScale;n.strokeStyle=this._color(i.color,this.m_alpha),n.beginPath(),n.moveTo(t.x*o,t.y*o),n.lineTo(e.x*o,e.y*o),n.closePath(),n.stroke()},Vt.prototype.DrawTransform=function(t){var e=this.m_ctx,i=this.m_drawScale;e.beginPath(),e.strokeStyle=this._color(16711680,this.m_alpha),e.moveTo(t.position.x*i,t.position.y*i),e.lineTo((t.position.x+this.m_xformScale*t.R.col1.x)*i,(t.position.y+this.m_xformScale*t.R.col1.y)*i),e.strokeStyle=this._color(65280,this.m_alpha),e.moveTo(t.position.x*i,t.position.y*i),e.lineTo((t.position.x+this.m_xformScale*t.R.col2.x)*i,(t.position.y+this.m_xformScale*t.R.col2.y)*i),e.closePath(),e.stroke()},Tt=0;Tt<Pt.postDefs.length;++Tt)Pt.postDefs[Tt]();var Ft=Pt;Ft.postDefs;function Gt(t){return Gt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Gt(t)}function Rt(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,o,s,r,a=[],l=!0,c=!1;try{if(s=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;l=!1}else for(;!(l=(n=s.call(i)).done)&&(a.push(n.value),a.length!==e);l=!0);}catch(t){c=!0,o=t}finally{try{if(!l&&null!=i.return&&(r=i.return(),Object(r)!==r))return}finally{if(c)throw o}}return a}}(t,e)||Ot(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Jt(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=Ot(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return r=t.done,t},e:function(t){a=!0,s=t},f:function(){try{r||null==i.return||i.return()}finally{if(a)throw s}}}}function Ot(t,e){if(t){if("string"==typeof t)return jt(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?jt(t,e):void 0}}function jt(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function zt(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function Xt(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?zt(Object(i),!0).forEach(function(e){Nt(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):zt(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function Nt(t,e,i){return(e=Yt(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function Wt(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Yt(n.key),n)}}function Yt(t){var e=function(t,e){if("object"!=Gt(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=Gt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==Gt(e)?e:e+""}var qt=function(){return function(t,e,i){return e&&Wt(t.prototype,e),i&&Wt(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(e){var i,n,o,s,r,a,l,c,h,u,m,y,p,d,f=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),e.physicsEnabled){this.engine=e,this.canvas=e.canvas,this.BASE_SCALE=f.scale||30,this.quality=f.quality||1,this.SCALE=this.BASE_SCALE*this.quality;var _=!1===f.gravity||void 0===f.gravity?{x:0,y:0}:{x:null!==(i=f.gravity.x)&&void 0!==i?i:0,y:null!==(n=f.gravity.y)&&void 0!==n?n:9.8*this.SCALE};this.originalConfig=Xt(Xt({scale:this.BASE_SCALE,quality:this.quality,gravity:_,sleep:void 0===f.sleep||f.sleep,friction:null!==(o=f.friction)&&void 0!==o?o:.2,restitution:null!==(s=f.bounce)&&void 0!==s?s:.2,density:null!==(r=f.density)&&void 0!==r?r:1,maxVelocity:null!==(a=f.maxVelocity)&&void 0!==a?a:1e3,velocityIterations:null!==(l=f.velocityIterations)&&void 0!==l?l:8,positionIterations:null!==(c=f.positionIterations)&&void 0!==c?c:3},f),{},{drag:{angularDamping:null!==(h=null===(u=f.drag)||void 0===u?void 0:u.angularDamping)&&void 0!==h?h:1,linearDamping:null!==(m=null===(y=f.drag)||void 0===y?void 0:y.linearDamping)&&void 0!==m?m:.1,fixedRotation:null!==(p=null===(d=f.drag)||void 0===d?void 0:d.fixedRotation)&&void 0!==p&&p}}),this.config=Xt({},this.originalConfig),this.world=new Ft.Dynamics.b2World(new Ft.Common.Math.b2Vec2(_.x/this.SCALE,_.y/this.SCALE),this.originalConfig.sleep),this.bodies=new Map,this.joints=new Map,this.velocities=new Map,this.materials=new Map,this.activeContacts=new Map,this._setupContactListener(),this.mouseJoints=new Map,this.draggedBodies=new Map,this.bodyTouchMap=new Map,this.mouseWorld=new Ft.Common.Math.b2Vec2(0,0),this._setupDragListeners()}},[{key:"update",value:function(t){var e=Math.min(t,20)/1e3;this.world.Step(e,this.config.velocityIterations||8,this.config.positionIterations||3);var i,n=Jt(this.bodies);try{for(n.s();!(i=n.n()).done;){var o=Rt(i.value,2),s=o[0],r=o[1],a=r.GetUserData();if(a){var l=r.GetPosition(),c=r.GetAngle();a.style({x:l.x*this.SCALE-a.width/2,y:l.y*this.SCALE-a.height/2,rotation:180*c/Math.PI});var h=r.GetLinearVelocity();this.velocities.set(s,{x:h.x*this.SCALE,y:h.y*this.SCALE})}}}catch(t){n.e(t)}finally{n.f()}this.world.ClearForces()}},{key:"isTouching",value:function(t,e){var i=this._getEntityId(t),n=this._getEntityId(e),o=this.activeContacts.get(i);return!!o&&o.includes(n)}},{key:"getCollisionSides",value:function(t,e){var i=t.GetFixtureA(),n=t.GetFixtureB();if(i.IsSensor()||n.IsSensor()){var o,s,r=i.GetBody(),a=n.GetBody(),l=r.GetPosition(),c=a.GetPosition(),h=c.x-l.x,u=c.y-l.y;return Math.abs(h)>Math.abs(u)?(o=h>0?"right":"left",s=h>0?"left":"right"):(o=u>0?"bottom":"top",s=u>0?"top":"bottom"),{sideA:o,sideB:s}}var m,y,p=e.m_normal;return Math.abs(p.x)>Math.abs(p.y)?(m=p.x>0?"left":"right",y=p.x>0?"right":"left"):(m=p.y>0?"top":"bottom",y=p.y>0?"bottom":"top"),{sideA:m,sideB:y}}},{key:"_setupContactListener",value:function(){var t=this,e=new Ft.Dynamics.b2ContactListener;e.BeginContact=function(e){var i=e.GetFixtureA().GetBody().GetUserData(),n=e.GetFixtureB().GetBody().GetUserData();if(i&&n){t._addContact(i.id,n.id),t._addContact(n.id,i.id);var o=new Ft.Collision.b2WorldManifold;e.GetWorldManifold(o);var s=o.m_points.map(function(e){return{x:e.x*t.SCALE,y:e.y*t.SCALE}}),r={x:o.m_normal.x,y:o.m_normal.y},a=t.getCollisionSides(e,o),l=a.sideA,c=a.sideB,h=e.GetFixtureA().GetBody(),u=e.GetFixtureB().GetBody(),m=h.GetLinearVelocity(),y=u.GetLinearVelocity(),p={x:(y.x-m.x)*t.SCALE,y:(y.y-m.y)*t.SCALE},d={entityA:i,entityB:n,sideA:l,sideB:c,contact:e,contactPoints:s,normal:r,relativeVelocity:p,type:"start",impactForce:Math.sqrt(p.x*p.x+p.y*p.y),angle:180*Math.atan2(r.y,r.x)/Math.PI};t.engine.trigger("collisions",d),i&&"function"==typeof i.trigger&&i.trigger("collide",Xt(Xt({},d),{},{target:n,side:l})),n&&"function"==typeof n.trigger&&n.trigger("collide",Xt(Xt({},d),{},{target:i,side:c,normal:{x:-r.x,y:-r.y},relativeVelocity:{x:-p.x,y:-p.y}}))}},e.EndContact=function(e){var i=e.GetFixtureA().GetBody().GetUserData(),n=e.GetFixtureB().GetBody().GetUserData();t._removeContact(i.id,n.id),t._removeContact(n.id,i.id),t.engine.trigger("collisionEnd",{entityA:i,entityB:n,contact:e}),i&&"function"==typeof i.trigger&&i.trigger("collideEnd",{target:n,contact:e,type:"end"}),n&&"function"==typeof n.trigger&&n.trigger("collideEnd",{target:i,contact:e,type:"end"})},this.world.SetContactListener(e)}},{key:"_addContact",value:function(t,e){this.activeContacts.has(t)||this.activeContacts.set(t,[]);var i=this.activeContacts.get(t);i.includes(e)||i.push(e)}},{key:"_removeContact",value:function(t,e){if(this.activeContacts.has(t)){var i=this.activeContacts.get(t),n=i.indexOf(e);-1!==n&&(i.splice(n,1),0===i.length&&this.activeContacts.delete(t))}}},{key:"hasEntity",value:function(t){return this.bodies.has(t)}},{key:"addEntity",value:function(t){var e,i,n,o,s,r,a,l,c,h,u,m,y,p,d,f=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},_=new Ft.Dynamics.b2BodyDef,v=this._getScaledDimensions(t),g=this.materials.get(f.material)||{},b=Xt(Xt({},g),f);switch(b.bodyType){case"static":_.type=Ft.Dynamics.b2Body.b2_staticBody;break;case"kinematic":_.type=Ft.Dynamics.b2Body.b2_kinematicBody;break;default:_.type=Ft.Dynamics.b2Body.b2_dynamicBody}_.position.x=(t.absoluteX+v.width/2)/this.SCALE,_.position.y=(t.absoluteY+v.height/2)/this.SCALE,_.angle=(t.styles.rotation||0)*Math.PI/180,_.gravityScale=null!==(e=b.gravityScale)&&void 0!==e?e:1,_.bullet=null!==(i=b.bullet)&&void 0!==i&&i,_.allowSleep=null===(n=b.sleeping)||void 0===n||n;var x=this.world.CreateBody(_),w=this._createShape(t),C=new Ft.Dynamics.b2FixtureDef;C.shape=w,C.isSensor=b.sensor||!1,C.density=null!==(o=b.density)&&void 0!==o?o:this.config.density,C.friction=null!==(s=b.friction)&&void 0!==s?s:this.config.friction,C.restitution=null!==(r=b.restitution)&&void 0!==r?r:this.config.restitution;var S=new Ft.Dynamics.b2FilterData,A=b.collision,M=g.filter;return S.categoryBits=null!==(a=null!==(l=null==A?void 0:A.categoryBits)&&void 0!==l?l:null==M?void 0:M.categoryBits)&&void 0!==a?a:1,S.maskBits=null!==(c=null!==(h=null==A?void 0:A.maskBits)&&void 0!==h?h:null==M?void 0:M.maskBits)&&void 0!==c?c:65535,S.groupIndex=null!==(u=null!==(m=null==A?void 0:A.groupIndex)&&void 0!==m?m:null==M?void 0:M.groupIndex)&&void 0!==u?u:0,C.filter=S,x.CreateFixture(C),x.SetFixedRotation(null!==(y=b.fixedRotation)&&void 0!==y&&y),x.SetLinearDamping(null!==(p=b.linearDamping)&&void 0!==p?p:.1),x.SetAngularDamping(null!==(d=b.angularDamping)&&void 0!==d?d:1),this.bodies.set(t.id,x),this.velocities.set(t.id,{x:0,y:0}),x.SetUserData(t),x}},{key:"removeEntity",value:function(t){var e=this,i=this.bodies.get(t.id);return i&&Promise.resolve().then(function(){i.SetActive(!1),i.SetUserData(null),e.world.DestroyBody(i),e.bodies.delete(t.id),e.velocities.delete(t.id),e.activeContacts.delete(t.id),e.bodies.delete(t.id)}),this}},{key:"moveEntity",value:function(t){var e=this;"number"==typeof t&&(t={x:t,y:arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,duration:(arguments.length>2&&void 0!==arguments[2]?arguments[2]:0)||0,easing:arguments.length>3&&void 0!==arguments[3]?arguments[3]:"linear"});var i=Xt({x:0,y:0,duration:0,easing:"linear",relative:!1,onUpdate:null,onComplete:null},t),n=i.entity;if(!n||!this.engine.isEntity(n))throw new Error("Entity is required");var o=this.bodies.get(n.id);if(!o)return this;try{var s,r=function(){return o.GetType()===Ft.Dynamics.b2Body.b2_staticBody&&(o.SetType(Ft.Dynamics.b2Body.b2_kinematicBody),!0)},a=function(t){t&&o.SetType(Ft.Dynamics.b2Body.b2_staticBody),o.SetAwake(!0)},l=o.GetPosition(),c={x:l.x*this.SCALE,y:l.y*this.SCALE},h={x:i.x,y:i.y};if(i.relative&&(h.x+=c.x,h.y+=c.y),!i.duration){var u,m=new Ft.Common.Math.b2Vec2(h.x/this.SCALE,h.y/this.SCALE),y=r();return o.SetPosition(m),a(y),null===(u=i.onComplete)||void 0===u||u.call(i,n),!0}var p=performance.now(),d=0,f=0,_=h.x-c.x,v=h.y-c.y,g="function"==typeof i.easing?i.easing:(null===(s=this.engine.Ease)||void 0===s?void 0:s[i.easing])||this.engine.Ease.linear,b=function(t){var s;if(!e.engine.running)return 0===d&&(d=t),void requestAnimationFrame(b);0!==d&&(f+=t-d,d=0);var l=t-f-p;if(l>=i.duration){var u,m=new Ft.Common.Math.b2Vec2(h.x/e.SCALE,h.y/e.SCALE),y=r();return o.SetPosition(m),a(y),void(null===(u=i.onComplete)||void 0===u||u.call(i,n))}var x=l/i.duration,w=g(x),C=new Ft.Common.Math.b2Vec2((c.x+_*w)/e.SCALE,(c.y+v*w)/e.SCALE),S=r();o.SetPosition(C),a(S),null===(s=i.onUpdate)||void 0===s||s.call(i,n,w),requestAnimationFrame(b)};return requestAnimationFrame(b),this}catch(t){return this.engine.warn("Error moving entity:",t),this}}},{key:"_getEntityId",value:function(t){return this.engine.isEntity(t)?t.id:t}},{key:"updateShape",value:function(t){var e=this.bodies.get(t.id);return e?(e.m_fixtureList.m_shape=this._createShape(t),this):this}},{key:"_createShape",value:function(t){var e=this;switch(t.styles.shape){case"circle":return new Ft.Collision.Shapes.b2CircleShape(Math.min(t.width,t.height)/2/this.SCALE);case"triangle":var i=new Ft.Collision.Shapes.b2PolygonShape,n=[new Ft.Common.Math.b2Vec2(0,-t.height/2/this.SCALE),new Ft.Common.Math.b2Vec2(t.width/2/this.SCALE,t.height/2/this.SCALE),new Ft.Common.Math.b2Vec2(-t.width/2/this.SCALE,t.height/2/this.SCALE)];return i.SetAsArray(n,n.length),i;case"star":for(var o=new Ft.Collision.Shapes.b2PolygonShape,s=t.styles.spikes||5,r=.99*(Math.min(t.width,t.height)/2/this.SCALE),a=[],l=2*s,c=0;c<l;c++){var h=2*c*Math.PI/l-Math.PI/2;a.push(new Ft.Common.Math.b2Vec2(Math.cos(h)*r,Math.sin(h)*r))}try{for(var u=[],m=0;m<8;m++){var y=2*m*Math.PI/8-Math.PI/2;u.push(new Ft.Common.Math.b2Vec2(Math.cos(y)*r,Math.sin(y)*r))}return o.SetAsArray(u,u.length),o}catch(t){return this.engine.warn("Creating circle shape as fallback for star"),new Ft.Collision.Shapes.b2CircleShape(r)}case"polygon":if(t.collision.points&&t.collision.points.length>=3){var p=new Ft.Collision.Shapes.b2PolygonShape,d=t.collision.points.map(function(t){return new Ft.Common.Math.b2Vec2(t.x/e.SCALE,t.y/e.SCALE)});try{var f=d.reduce(function(t,e,i){var n=d[(i+1)%d.length];return t+(n.x-e.x)*(n.y+e.y)},0);return f>0&&d.reverse(),p.SetAsArray(d,d.length),p}catch(e){return this.engine.warn("Failed to create polygon shape, falling back to rectangle"),this._createRectangleShape(t)}}return this._createRectangleShape(t);default:return this._createRectangleShape(t)}}},{key:"_createRectangleShape",value:function(t){var e=new Ft.Collision.Shapes.b2PolygonShape,i=this._getScaledDimensions(t);return e.SetAsBox(i.width/2/this.SCALE,i.height/2/this.SCALE),e}},{key:"_getScaledDimensions",value:function(t){var e=t.styles.scaleX*t.styles.scale,i=t.styles.scaleY*t.styles.scale;return{width:t.width*Math.abs(e),height:t.height*Math.abs(i),scaleX:e,scaleY:i}}},{key:"createMaterial",value:function(t,e){var i=e.bodyType,n=void 0===i?"dynamic":i,o=e.density,s=void 0===o?1:o,r=e.friction,a=void 0===r?.3:r,l=e.restitution,c=void 0===l?.2:l,h=e.linearDamping,u=void 0===h?.1:h,m=e.angularDamping,y=void 0===m?1:m,p=e.fixedRotation,d=void 0!==p&&p,f=e.gravityScale,_=void 0===f?1:f,v=e.bullet,g=void 0!==v&&v,b=e.sleeping,x=void 0===b||b,w=e.categoryBits,C=void 0===w?1:w,S=e.maskBits,A=void 0===S?65535:S,M=e.groupIndex,k=void 0===M?0:M;return this.materials.set(t,{bodyType:n,density:s,friction:a,restitution:c,linearDamping:u,angularDamping:y,fixedRotation:d,gravityScale:_,bullet:g,sleeping:x,filter:{categoryBits:C,maskBits:A,groupIndex:k}}),this}},{key:"getMaterial",value:function(t){return this.materials.get(t)}},{key:"setGravity",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;!1===t&&(t=0,e=0),this.world.SetGravity(new Ft.Common.Math.b2Vec2(t/this.SCALE,e/this.SCALE));var i,n=Jt(this.bodies);try{for(n.s();!(i=n.n()).done;){var o=Rt(i.value,2)[1];o.GetType()!==Ft.Dynamics.b2Body.b2_staticBody&&this.applyImpulse(o.GetUserData(),{x:1e-4,y:1e-4})}}catch(t){n.e(t)}finally{n.f()}return this}},{key:"applyForce",value:function(t,e){t=this._getEntityId(t);var i=this.bodies.get(t);if(i){var n=i.GetWorldCenter();i.ApplyForce(new Ft.Common.Math.b2Vec2(e.x,e.y),n)}return this}},{key:"setVelocity",value:function(t,e){t=this._getEntityId(t);var i=this.bodies.get(t);return i&&i.SetLinearVelocity(new Ft.Common.Math.b2Vec2(e.x/this.SCALE,e.y/this.SCALE)),this}},{key:"setVelocityLimit",value:function(t,e){t=this._getEntityId(t);var i=this.bodies.get(t);return i&&i.SetLinearVelocity({x:Math.min(Math.max(i.GetLinearVelocity().x,-e),e),y:Math.min(Math.max(i.GetLinearVelocity().y,-e),e)}),this}},{key:"setTransform",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=e.x,n=e.y,o=e.rotation;if(!this.bodies.has(t.id))return this;var s=this.bodies.get(t.id),r=this.SCALE;if(void 0!==i||void 0!==n){var a=void 0!==i?(i+t.width/2)/r:s.GetPosition().x,l=void 0!==n?(n+t.height/2)/r:s.GetPosition().y;s.SetPosition(new Ft.Common.Math.b2Vec2(a,l))}return void 0!==o&&s.SetAngle(o*Math.PI/180),this}},{key:"setAngularVelocity",value:function(t,e){t=this._getEntityId(t);var i=this.bodies.get(t);return i&&i.SetAngularVelocity(e),this}},{key:"applyTorque",value:function(t,e){t=this._getEntityId(t);var i=this.bodies.get(t);return i&&i.ApplyTorque(e),this}},{key:"applyImpulse",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;t=this._getEntityId(t);var n=this.bodies.get(t);if(n){var o=i?new Ft.Common.Math.b2Vec2(i.x/this.SCALE,i.y/this.SCALE):n.GetWorldCenter();n.ApplyImpulse(new Ft.Common.Math.b2Vec2(e.x,e.y),o)}return this}},{key:"setBodyType",value:function(t,e){t=this._getEntityId(t);var i,n=this.bodies.get(t);if(!n)return this;switch(e){case"static":i=Ft.Dynamics.b2Body.b2_staticBody;break;case"kinematic":i=Ft.Dynamics.b2Body.b2_kinematicBody;break;case"dynamic":i=Ft.Dynamics.b2Body.b2_dynamicBody;break;default:return this.engine.warn("Unknown body type: ".concat(e)),this}return n.SetType(i),n.SetAwake(!0),this}},{key:"isBodyAwake",value:function(t){t=this._getEntityId(t);var e=this.bodies.get(t);return!!e&&e.IsAwake()}},{key:"setBodyAwake",value:function(t,e){t=this._getEntityId(t);var i=this.bodies.get(t);return i&&i.SetAwake(e),this}},{key:"setBodyProperties",value:function(t,e){t=this._getEntityId(t);var i=this.bodies.get(t);if(i){var n=i.GetFixtureList();n&&(void 0!==e.friction&&n.SetFriction(e.friction),void 0!==e.restitution&&n.SetRestitution(e.restitution),void 0!==e.density&&(n.SetDensity(e.density),i.ResetMassData()),void 0!==e.fixedRotation&&i.SetFixedRotation(e.fixedRotation))}return this}},{key:"haltBody",value:function(t){t=this._getEntityId(t);var e=this.bodies.get(t);if(e)return e.SetLinearVelocity(new Ft.Common.Math.b2Vec2(0,0)),this}},{key:"brakeBody",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.9,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.05;t=this._getEntityId(t);var n=this.bodies.get(t);if(!n)return this;var o=n.GetLinearVelocity(),s=o.Length();if(s<i)return this.haltBody(t),this;var r=s*e/s;return n.SetLinearVelocity(new Ft.Common.Math.b2Vec2(o.x*r,o.y*r)),this}},{key:"toggleSensor",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];t=this._getEntityId(t);var i=this.bodies.get(t);if(!i)return this;for(var n=i.GetFixtureList();n;)n.SetSensor(!!e),n=n.GetNext();return this}},{key:"enableSensor",value:function(t){return this.toggleSensor(t,!0)}},{key:"disableSensor",value:function(t){return this.toggleSensor(t,!1)}},{key:"getBodyVelocity",value:function(t){return t=this._getEntityId(t),this.velocities.get(t)}},{key:"getBodyType",value:function(t){t=this._getEntityId(t);var e=this.bodies.get(t);if(!e)return null;var i=e.GetType();return i===Ft.Dynamics.b2Body.b2_staticBody?"static":i===Ft.Dynamics.b2Body.b2_kinematicBody?"kinematic":"dynamic"}},{key:"getBodySpeed",value:function(t){t=this._getEntityId(t);var e=this.getBodyVelocity(t);return Math.sqrt(e.x*e.x+e.y*e.y)}},{key:"joint",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=this.bodies.get(t.id),o=this.bodies.get(e.id);if(!n||!o)return this.engine.warn("Both entities must have physics bodies"),null;var s=i.type||"revolute",r=null;switch(s){case"revolute":r=this._createRevoluteJoint(n,o,i);break;case"distance":r=this._createDistanceJoint(n,o,i);break;case"prismatic":r=this._createPrismaticJoint(n,o,i);break;case"weld":r=this._createWeldJoint(n,o,i);break;case"rope":r=this._createRopeJoint(n,o,i);break;case"pulley":r=this._createPulleyJoint(n,o,i);break;case"gear":r=this._createGearJoint(n,o,i);break;case"friction":r=this._createFrictionJoint(n,o,i);break;default:return this.engine.warn("Unknown joint type: ".concat(s)),null}if(r){this.joints||(this.joints=new Map);var a="".concat(t.id,"_").concat(e.id,"_").concat(Date.now());return this.joints.set(a,{joint:r,entityA:t,entityB:e,type:s,config:i}),this.engine.trigger("jointCreated",{jointId:a,entityA:t,entityB:e,type:s,joint:r}),a}return null}},{key:"_createRevoluteJoint",value:function(t,e,i){var n,o,s,r=new Ft.Dynamics.Joints.b2RevoluteJointDef;if(i.anchor)o=i.anchor.x/this.SCALE,s=i.anchor.y/this.SCALE;else{var a=t.GetPosition(),l=e.GetPosition();o=(a.x+l.x)/2,s=(a.y+l.y)/2}return r.Initialize(t,e,new Ft.Common.Math.b2Vec2(o,s)),i.motor&&(r.enableMotor=!0,r.motorSpeed=(i.motor.speed||0)*Math.PI/180,r.maxMotorTorque=i.motor.torque||1e3),i.limits&&(r.enableLimit=!0,r.lowerAngle=(i.limits.lower||0)*Math.PI/180,r.upperAngle=(i.limits.upper||360)*Math.PI/180),r.collideConnected=null!==(n=i.collideConnected)&&void 0!==n&&n,this.world.CreateJoint(r)}},{key:"_createDistanceJoint",value:function(t,e,i){var n,o,s,r=new Ft.Dynamics.Joints.b2DistanceJointDef,a=i.anchorA?new Ft.Common.Math.b2Vec2(i.anchorA.x/this.SCALE,i.anchorA.y/this.SCALE):t.GetWorldCenter(),l=i.anchorB?new Ft.Common.Math.b2Vec2(i.anchorB.x/this.SCALE,i.anchorB.y/this.SCALE):e.GetWorldCenter();return r.Initialize(t,e,a,l),void 0!==i.length&&(r.length=i.length/this.SCALE),r.frequencyHz=null!==(n=i.frequency)&&void 0!==n?n:4,r.dampingRatio=null!==(o=i.damping)&&void 0!==o?o:.5,r.collideConnected=null!==(s=i.collideConnected)&&void 0!==s&&s,this.world.CreateJoint(r)}},{key:"_createPrismaticJoint",value:function(t,e,i){var n,o=new Ft.Dynamics.Joints.b2PrismaticJointDef,s=i.anchor?new Ft.Common.Math.b2Vec2(i.anchor.x/this.SCALE,i.anchor.y/this.SCALE):t.GetWorldCenter(),r=i.axis||{x:1,y:0},a=new Ft.Common.Math.b2Vec2(r.x,r.y);return o.Initialize(t,e,s,a),i.motor&&(o.enableMotor=!0,o.motorSpeed=i.motor.speed/this.SCALE||0,o.maxMotorForce=i.motor.force||1e3),i.limits&&(o.enableLimit=!0,o.lowerTranslation=(i.limits.lower||0)/this.SCALE,o.upperTranslation=(i.limits.upper||100)/this.SCALE),o.collideConnected=null!==(n=i.collideConnected)&&void 0!==n&&n,this.world.CreateJoint(o)}},{key:"_createWeldJoint",value:function(t,e,i){var n,o,s,r=new Ft.Dynamics.Joints.b2WeldJointDef,a=i.anchor?new Ft.Common.Math.b2Vec2(i.anchor.x/this.SCALE,i.anchor.y/this.SCALE):t.GetWorldCenter();return r.Initialize(t,e,a),r.frequencyHz=null!==(n=i.frequency)&&void 0!==n?n:0,r.dampingRatio=null!==(o=i.damping)&&void 0!==o?o:0,r.collideConnected=null!==(s=i.collideConnected)&&void 0!==s&&s,this.world.CreateJoint(r)}},{key:"_createRopeJoint",value:function(t,e,i){var n,o=new Ft.Dynamics.Joints.b2RopeJointDef;return o.localAnchorA=i.anchorA?new Ft.Common.Math.b2Vec2(i.anchorA.x/this.SCALE,i.anchorA.y/this.SCALE):new Ft.Common.Math.b2Vec2(0,0),o.localAnchorB=i.anchorB?new Ft.Common.Math.b2Vec2(i.anchorB.x/this.SCALE,i.anchorB.y/this.SCALE):new Ft.Common.Math.b2Vec2(0,0),o.bodyA=t,o.bodyB=e,o.maxLength=(i.maxLength||100)/this.SCALE,o.collideConnected=null===(n=i.collideConnected)||void 0===n||n,this.world.CreateJoint(o)}},{key:"_createPulleyJoint",value:function(t,e,i){var n,o=new Ft.Dynamics.Joints.b2PulleyJointDef;if(!i.groundAnchorA||!i.groundAnchorB)return this.engine.warn("Pulley joint requires groundAnchorA and groundAnchorB"),null;var s=new Ft.Common.Math.b2Vec2(i.groundAnchorA.x/this.SCALE,i.groundAnchorA.y/this.SCALE),r=new Ft.Common.Math.b2Vec2(i.groundAnchorB.x/this.SCALE,i.groundAnchorB.y/this.SCALE),a=i.anchorA?new Ft.Common.Math.b2Vec2(i.anchorA.x/this.SCALE,i.anchorA.y/this.SCALE):t.GetWorldCenter(),l=i.anchorB?new Ft.Common.Math.b2Vec2(i.anchorB.x/this.SCALE,i.anchorB.y/this.SCALE):e.GetWorldCenter(),c=i.ratio||1;return o.Initialize(t,e,s,r,a,l,c),o.collideConnected=null===(n=i.collideConnected)||void 0===n||n,this.world.CreateJoint(o)}},{key:"_createGearJoint",value:function(t,e,i){var n;if(!i.joint1||!i.joint2)return this.engine.warn("Gear joint requires joint1 and joint2"),null;var o=new Ft.Dynamics.Joints.b2GearJointDef;return o.bodyA=t,o.bodyB=e,o.joint1=i.joint1,o.joint2=i.joint2,o.ratio=i.ratio||1,o.collideConnected=null!==(n=i.collideConnected)&&void 0!==n&&n,this.world.CreateJoint(o)}},{key:"_createFrictionJoint",value:function(t,e,i){var n,o=new Ft.Dynamics.Joints.b2FrictionJointDef,s=i.anchor?new Ft.Common.Math.b2Vec2(i.anchor.x/this.SCALE,i.anchor.y/this.SCALE):t.GetWorldCenter();return o.Initialize(t,e,s),o.maxForce=i.maxForce||1e3,o.maxTorque=i.maxTorque||1e3,o.collideConnected=null!==(n=i.collideConnected)&&void 0!==n&&n,this.world.CreateJoint(o)}},{key:"getJoint",value:function(t){return this.joints?this.joints.get(t):null}},{key:"getAllJoints",value:function(){return this.joints?Array.from(this.joints.entries()):[]}},{key:"updateJointMotor",value:function(t,e,i){var n=this.getJoint(t);if(!n)return this;var o=n.joint,s=n.type;try{"revolute"===s?(o.SetMotorSpeed(e*Math.PI/180),void 0!==i&&o.SetMaxMotorTorque(i)):"prismatic"===s?(o.SetMotorSpeed(e/this.SCALE),void 0!==i&&o.SetMaxMotorForce(i)):this.engine.warn("Motor control not available for ".concat(s," joints"))}catch(t){this.engine.warn("Error updating joint motor:",t)}return this}},{key:"enableJointMotor",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this.getJoint(t);if(!i)return this;var n=i.joint,o=i.type;try{"revolute"===o||"prismatic"===o?n.EnableMotor(e):this.engine.warn("Motor control not available for ".concat(o," joints"))}catch(t){this.engine.warn("Error toggling joint motor:",t)}return this}},{key:"setJointLimits",value:function(t,e,i){var n=this.getJoint(t);if(!n)return this;var o=n.joint,s=n.type;try{"revolute"===s?o.SetLimits(e*Math.PI/180,i*Math.PI/180):"prismatic"===s?o.SetLimits(e/this.SCALE,i/this.SCALE):this.engine.warn("Limits not available for ".concat(s," joints"))}catch(t){this.engine.warn("Error setting joint limits:",t)}return this}},{key:"enableJointLimits",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this.getJoint(t);if(!i)return this;var n=i.joint,o=i.type;try{"revolute"===o||"prismatic"===o?n.EnableLimit(e):this.engine.warn("Limits not available for ".concat(o," joints"))}catch(t){this.engine.warn("Error toggling joint limits:",t)}return this}},{key:"getJointReactionForce",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:60,i=this.getJoint(t);if(!i)return null;var n=i.joint;try{var o=n.GetReactionForce(1/e);return{x:o.x*this.SCALE,y:o.y*this.SCALE,magnitude:Math.sqrt(o.x*o.x+o.y*o.y)*this.SCALE}}catch(t){return this.engine.warn("Error getting joint reaction force:",t),null}}},{key:"getJointReactionTorque",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:60,i=this.getJoint(t);if(!i)return null;var n=i.joint;try{return n.GetReactionTorque(1/e)}catch(t){return this.engine.warn("Error getting joint reaction torque:",t),null}}},{key:"getJointAngle",value:function(t){var e=this.getJoint(t);if(!e)return null;var i=e.joint,n=e.type;try{return"revolute"===n?180*i.GetJointAngle()/Math.PI:(this.engine.warn("Angle not available for ".concat(n," joints")),null)}catch(t){return this.engine.warn("Error getting joint angle:",t),null}}},{key:"getJointSpeed",value:function(t){var e=this.getJoint(t);if(!e)return null;var i=e.joint,n=e.type;try{return"revolute"===n?180*i.GetJointSpeed()/Math.PI:"prismatic"===n?i.GetJointSpeed()*this.SCALE:(this.engine.warn("Speed not available for ".concat(n," joints")),null)}catch(t){return this.engine.warn("Error getting joint speed:",t),null}}},{key:"getJointTranslation",value:function(t){var e=this.getJoint(t);if(!e)return null;var i=e.joint,n=e.type;try{return"prismatic"===n?i.GetJointTranslation()*this.SCALE:(this.engine.warn("Translation not available for ".concat(n," joints")),null)}catch(t){return this.engine.warn("Error getting joint translation:",t),null}}},{key:"isJointLimitEnabled",value:function(t){var e=this.getJoint(t);if(!e)return!1;var i=e.joint,n=e.type;try{return("revolute"===n||"prismatic"===n)&&i.IsLimitEnabled()}catch(t){return this.engine.warn("Error checking joint limit status:",t),!1}}},{key:"isJointMotorEnabled",value:function(t){var e=this.getJoint(t);if(!e)return!1;var i=e.joint,n=e.type;try{return("revolute"===n||"prismatic"===n)&&i.IsMotorEnabled()}catch(t){return this.engine.warn("Error checking joint motor status:",t),!1}}},{key:"createHinge",value:function(t,e){var i,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.joint(t,e,{type:"revolute",anchor:n.anchor,motor:n.motor,limits:n.limits,collideConnected:null!==(i=n.collideConnected)&&void 0!==i&&i})}},{key:"createSpring",value:function(t,e){var i,n,o,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.joint(t,e,{type:"distance",anchorA:s.anchorA,anchorB:s.anchorB,length:s.length,frequency:null!==(i=s.stiffness)&&void 0!==i?i:4,damping:null!==(n=s.damping)&&void 0!==n?n:.5,collideConnected:null!==(o=s.collideConnected)&&void 0!==o&&o})}},{key:"createSlider",value:function(t,e){var i,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.joint(t,e,{type:"prismatic",anchor:n.anchor,axis:n.axis||{x:1,y:0},motor:n.motor,limits:n.limits,collideConnected:null!==(i=n.collideConnected)&&void 0!==i&&i})}},{key:"createChain",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!t||t.length<2)return this.engine.warn("Chain requires at least 2 entities"),[];for(var i=[],n=e.type||"revolute",o=e.spacing||0,s=0;s<t.length-1;s++){var r,a=t[s],l=t[s+1],c=null;if(0===o){var h={x:a.absoluteX+a.width/2,y:a.absoluteY+a.height/2},u={x:l.absoluteX+l.width/2,y:l.absoluteY+l.height/2};c={x:(h.x+u.x)/2,y:(h.y+u.y)/2}}var m=Xt({type:n,anchor:c,collideConnected:null!==(r=e.collideConnected)&&void 0!==r&&r},e.jointConfig),y=this.joint(a,l,m);y&&i.push(y)}return this.engine.trigger("chainCreated",{entities:t,joints:i,options:e}),i}},{key:"createRope",value:function(t){var e,i,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.createChain(t,Xt(Xt({},n),{},{type:"distance",jointConfig:Xt({frequency:null!==(e=n.flexibility)&&void 0!==e?e:2,damping:null!==(i=n.damping)&&void 0!==i?i:.3},n.jointConfig)}))}},{key:"monitorJointStress",value:function(t,e,i,n){var o=this;if(!this.getJoint(t))return this;var s=function(){if(o.joints&&o.joints.has(t)){var r=o.getJointReactionForce(t),a=o.getJointReactionTorque(t),l=!1,c={jointId:t,force:r,torque:a,maxForce:e,maxTorque:i};r&&e&&r.magnitude>e&&(l=!0,c.forceExceeded=!0),a&&i&&Math.abs(a)>i&&(l=!0,c.torqueExceeded=!0),l&&n&&n(c),o.engine.running&&requestAnimationFrame(s)}};return requestAnimationFrame(s),this}},{key:"destroyJoint",value:function(t){if(!this.joints||!this.joints.has(t))return this.engine.warn("Joint with ID ".concat(t," not found")),!1;var e=this.joints.get(t),i=e.joint,n=e.entityA,o=e.entityB,s=e.type;try{return this.world.DestroyJoint(i),this.joints.delete(t),this.engine.trigger("jointDestroyed",{jointId:t,entityA:n,entityB:o,type:s}),!0}catch(t){return this.engine.warn("Error destroying joint:",t),!1}}},{key:"destroyAllJoints",value:function(){if(!this.joints)return this;for(var t=0,e=Array.from(this.joints.keys());t<e.length;t++){var i=e[t];this.destroyJoint(i)}return this}},{key:"debugJoint",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=this.getJoint(t);if(i){i.joint;var n=i.type,o=i.entityA,s=i.entityB,r={id:t,type:n,entityA:o.id,entityB:s.id,angle:this.getJointAngle(t),speed:this.getJointSpeed(t),translation:this.getJointTranslation(t),reactionForce:this.getJointReactionForce(t),reactionTorque:this.getJointReactionTorque(t),motorEnabled:this.isJointMotorEnabled(t),limitEnabled:this.isJointLimitEnabled(t)};return!1!==e.log&&console.table(r),r}}},{key:"_setupDragListeners",value:function(){var t=this,e=null,i=0,n={x:0,y:0},o="mouse";this.mouseDownEntity=null,this.touchStartEntities=new Map;var s=function(t,e,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,r={x:i.x,y:i.y,worldX:i.x,worldY:i.y,screenX:t,screenY:e,timestamp:Date.now()};return null!==n&&(r.identifier=n),null!==o&&(r.target=o),null!==s&&(r.which=s),r};this.engine.on("mousedown",function(e){if(t.engine.running)for(var i=t.canvas.getBoundingClientRect(),n=e.screenX-i.left,r=e.screenY-i.top,a={x:e.worldX,y:e.worldY},l=0,c=Array.from(t.bodies.entries());l<c.length;l++){var h=Rt(c[l],2),u=(h[0],h[1].GetUserData());if(u&&t._isPointInEntity(n,r,u)){u.isInteractive&&u.isInteractive()&&(u.trigger("mousedown",s(n,r,a,o,u,e.which)),t.mouseDownEntity=u),u.events.draggable&&(t._startDrag(u,a.x,a.y,o),u.trigger("drag",s(n,r,a,o,u)));break}}}),this.engine.on("mousemove",function(i){if(t.engine.running){var n=t.canvas.getBoundingClientRect(),r=i.screenX-n.left,a=i.screenY-n.top,l={x:i.worldX,y:i.worldY};if(t.mouseDownEntity&&t.mouseDownEntity.isInteractive&&t.mouseDownEntity.isInteractive())t.mouseDownEntity.trigger("mousemove",s(r,a,l,o,t.mouseDownEntity,i.which));else for(var c=0,h=Array.from(t.bodies.entries());c<h.length;c++){var u=Rt(h[c],2),m=(u[0],u[1].GetUserData());if(m&&m.isInteractive&&m.isInteractive()&&t._isPointInEntity(r,a,m)){m.trigger("mousemove",s(r,a,l,o,m,i.which));break}}for(var y=null,p=0,d=Array.from(t.bodies.entries());p<d.length;p++){var f=Rt(d[p],2),_=(f[0],f[1].GetUserData());if(_&&_.events.hoverable&&t._isPointInEntity(r,a,_)){y=_;break}}if(y!==e&&(e&&e.trigger("hoverOut",s(r,a,l,null,e)),y&&y.trigger("hover",s(r,a,l,null,y)),e=y),t.mouseJoints.has(o)){var v=t.draggedBodies.get(o);v&&v.entity&&v.entity.events.draggable&&(t._updateDrag(l.x,l.y,o),v.entity.trigger("dragMove",s(r,a,l,o,v.entity,i.which)))}}}),this.engine.on("mouseup",function(e){if(t.engine.running){var i=t.canvas.getBoundingClientRect(),n=e.screenX-i.left,r=e.screenY-i.top,a={x:e.worldX,y:e.worldY};if(t.mouseDownEntity&&t.mouseDownEntity.isInteractive&&t.mouseDownEntity.isInteractive()&&(t.mouseDownEntity.trigger("mouseup",s(n,r,a,o,t.mouseDownEntity,e.which)),t.mouseDownEntity=null),t.mouseJoints.has(o)){var l=t.draggedBodies.get(o);l&&l.entity&&l.entity.trigger("drop",s(n,r,a,o,l.entity,e.which)),t._endDrag(o)}}}),this.engine.on("wheel",function(e){if(t.engine.running)for(var i=t.canvas.getBoundingClientRect(),n=e.screenX-i.left,o=e.screenY-i.top,r={x:e.worldX,y:e.worldY},a=0,l=Array.from(t.bodies.entries());a<l.length;a++){var c=Rt(l[a],2),h=(c[0],c[1].GetUserData());if(h&&h.isInteractive&&h.isInteractive()&&t._isPointInEntity(n,o,h)){var u=s(n,o,r,null,h);u.deltaX=e.deltaX,u.deltaY=e.deltaY,u.deltaZ=e.deltaZ,u.deltaMode=e.deltaMode,h.trigger("wheel",u);break}}}),this.engine.on("touchstart",function(e){if(t.engine.running){i=Date.now();var o=t.canvas.getBoundingClientRect(),r=e.screenX-o.left,a=e.screenY-o.top,l={x:e.worldX,y:e.worldY};n={x:r,y:a};var c,h=Array.from(t.bodies.entries()).filter(function(e){var i=Rt(e,2),n=i[0];i[1];return!t.bodyTouchMap.has(n)}),u=Jt(h);try{for(u.s();!(c=u.n()).done;){var m=Rt(c.value,2),y=(m[0],m[1].GetUserData());if(y&&t._isPointInEntity(r,a,y)){y.isInteractive&&y.isInteractive()&&(y.trigger("touchstart",s(r,a,l,e.identifier,y)),t.touchStartEntities.set(e.identifier,y)),y.events.draggable&&(t._startDrag(y,l.x,l.y,e.identifier),y.trigger("drag",s(r,a,l,e.identifier,y)));break}}}catch(t){u.e(t)}finally{u.f()}}}),this.engine.on("touchmove",function(e){if(t.engine.running){var i=t.canvas.getBoundingClientRect(),n=e.screenX-i.left,o=e.screenY-i.top,r={x:e.worldX,y:e.worldY},a=t.touchStartEntities.get(e.identifier);if(a&&a.isInteractive&&a.isInteractive())a.trigger("touchmove",s(n,o,r,e.identifier,a));else for(var l=0,c=Array.from(t.bodies.entries());l<c.length;l++){var h=Rt(c[l],2),u=(h[0],h[1].GetUserData());if(u&&u.isInteractive&&u.isInteractive()&&t._isPointInEntity(n,o,u)){u.trigger("touchmove",s(n,o,r,e.identifier,u));break}}if(t.mouseJoints.has(e.identifier)){var m=t.draggedBodies.get(e.identifier);m&&m.entity&&(t._updateDrag(r.x,r.y,e.identifier),m.entity.trigger("dragMove",s(n,o,r,e.identifier,m.entity)))}}}),this.engine.on("touchend",function(e){if(t.engine.running){var o=Date.now(),r=t.canvas.getBoundingClientRect(),a=e.screenX-r.left,l=e.screenY-r.top,c={x:e.worldX,y:e.worldY},h=t.touchStartEntities.get(e.identifier);h&&h.isInteractive&&h.isInteractive()&&(h.trigger("touchend",s(a,l,c,e.identifier,h)),t.touchStartEntities.delete(e.identifier));var u=a-n.x,m=l-n.y;if(Math.sqrt(u*u+m*m)<10&&o-i<200)for(var y=0,p=Array.from(t.bodies.entries());y<p.length;y++){var d=Rt(p[y],2),f=(d[0],d[1].GetUserData());if(f&&f.events.clickable&&t._isPointInEntity(a,l,f)){f.trigger("click",s(a,l,c,null,f));break}}if(t.mouseJoints.has(e.identifier)){var _=t.draggedBodies.get(e.identifier);_&&_.entity&&_.entity.trigger("drop",s(a,l,c,e.identifier,_.entity)),t._endDrag(e.identifier)}}}),this.engine.on("touchcancel",function(e){if(t.engine.running){var i=t.canvas.getBoundingClientRect(),n=e.screenX-i.left,o=e.screenY-i.top,r={x:e.worldX,y:e.worldY};if(t.touchStartEntities.has(e.identifier)&&t.touchStartEntities.delete(e.identifier),t.mouseJoints.has(e.identifier)){var a=t.draggedBodies.get(e.identifier);a&&a.entity&&a.entity.trigger("drop",s(n,o,r,e.identifier,a.entity)),t._endDrag(e.identifier)}}}),this.engine.on("click",function(e){if(t.engine.running)for(var i=t.canvas.getBoundingClientRect(),n=e.screenX-i.left,o=e.screenY-i.top,r={x:e.worldX,y:e.worldY},a=0,l=Array.from(t.bodies.entries());a<l.length;a++){var c=Rt(l[a],2),h=(c[0],c[1].GetUserData());if(h&&t._isPointInEntity(n,o,h)&&h.isInteractive&&h.isInteractive()){h.trigger("click",s(n,o,r,null,h));break}}}),this.engine.on("rightclick",function(e){if(t.engine.running)for(var i=t.canvas.getBoundingClientRect(),n=e.screenX-i.left,o=e.screenY-i.top,r={x:e.worldX,y:e.worldY},a=0,l=Array.from(t.bodies.entries());a<l.length;a++){var c=Rt(l[a],2),h=(c[0],c[1].GetUserData());if(h&&t._isPointInEntity(n,o,h)&&h.isInteractive&&h.isInteractive()){h.trigger("rightclick",s(n,o,r,null,h));break}}})}},{key:"_startDrag",value:function(t,e,i,n){var o=this.bodies.get(t.id);if(o&&!this.mouseJoints.has(n)&&!this.bodyTouchMap.has(t.id)){var s=o.GetType();s!==Ft.Dynamics.b2Body.b2_dynamicBody&&o.SetType(Ft.Dynamics.b2Body.b2_dynamicBody);var r=new Ft.Common.Math.b2Vec2(e/this.SCALE,i/this.SCALE),a=new Ft.Dynamics.Joints.b2MouseJointDef,l=this.world.CreateBody(new Ft.Dynamics.b2BodyDef);a.bodyA=l,a.bodyB=o,a.target.Set(r.x,r.y),a.maxForce=1e3*o.GetMass(),a.collideConnected=!0,a.dampingRatio=.5,a.frequencyHz=5;var c=this.world.CreateJoint(a);this.mouseJoints.set(n,c),this.draggedBodies.set(n,{body:o,entity:t,originalType:s}),this.bodyTouchMap.set(t.id,n);var h=this.config.drag,u=h.angularDamping,m=h.linearDamping,y=h.fixedRotation;o.SetAngularDamping(u),o.SetLinearDamping(m),o.SetFixedRotation(y),t.halt(),"function"==typeof t.trigger&&t.trigger("drag",{x:e,y:i,identifier:n})}}},{key:"_updateDrag",value:function(t,e,i){var n=this.mouseJoints.get(i),o=this.draggedBodies.get(i);if(n&&o){var s=new Ft.Common.Math.b2Vec2(t/this.SCALE,e/this.SCALE);n.SetTarget(s);o.body;var r=o.entity;"function"==typeof r.trigger&&r.trigger("dragMove",{x:t,y:e,identifier:i})}}},{key:"_endDrag",value:function(t){var e=this.mouseJoints.get(t),i=this.draggedBodies.get(t);if(e&&i){var n=i.body,o=i.entity,s=i.originalType,r=this.config.drag,a=r.angularDamping,l=r.linearDamping;if(n.SetFixedRotation(!1),n.SetAngularDamping(a),n.SetLinearDamping(l),s===Ft.Dynamics.b2Body.b2_kinematicBody&&(n.SetLinearVelocity(new Ft.Common.Math.b2Vec2(0,0)),n.SetAngularVelocity(0)),s!==Ft.Dynamics.b2Body.b2_dynamicBody&&n.SetType(s),"function"==typeof o.trigger){var c=n.GetPosition();o.trigger("drop",{x:c.x*this.SCALE,y:c.y*this.SCALE,identifier:t})}this.world.DestroyJoint(e),this.mouseJoints.delete(t),this.draggedBodies.delete(t),this.bodyTouchMap.delete(o.id)}}},{key:"_isPointInEntity",value:function(t,e,i){var n=this.bodies.get(i.id);if(!n)return!1;for(var o=i.engine.camera.screenToWorld(t,e),s=new Ft.Common.Math.b2Vec2(o.x/this.SCALE,o.y/this.SCALE),r=n.GetFixtureList();r;){if(r.TestPoint(s))return!0;r=r.GetNext()}return!1}},{key:"reset",value:function(){try{var t,e=Jt(this.mouseJoints);try{for(e.s();!(t=e.n()).done;){var i=Rt(t.value,2),n=(i[0],i[1]);this.world.DestroyJoint(n)}}catch(t){e.e(t)}finally{e.f()}this.mouseJoints.clear(),this.draggedBodies.clear(),this.bodyTouchMap.clear(),this.mouseDownEntity=null,this.touchStartEntities&&this.touchStartEntities.clear();var o,s=Jt(this.bodies);try{for(s.s();!(o=s.n()).done;){var r=Rt(o.value,2),a=r[0],l=r[1];pixalo.find(a).halt(),this.world.DestroyBody(l)}}catch(t){s.e(t)}finally{s.f()}if(this.bodies.clear(),this.velocities.clear(),this.materials.clear(),this.activeContacts.clear(),this.joints){var c,h=Jt(this.joints);try{for(h.s();!(c=h.n()).done;){var u=Rt(c.value,2),m=(u[0],u[1]);try{this.world.DestroyJoint(m.joint)}catch(t){}}}catch(t){h.e(t)}finally{h.f()}this.joints.clear()}return this.world=new Ft.Dynamics.b2World(new Ft.Common.Math.b2Vec2(this.originalConfig.gravity.x/this.SCALE,this.originalConfig.gravity.y/this.SCALE),this.originalConfig.sleep),this.config={friction:this.originalConfig.friction,restitution:this.originalConfig.restitution,density:this.originalConfig.density,maxVelocity:this.originalConfig.maxVelocity,velocityIterations:this.originalConfig.velocityIterations,positionIterations:this.originalConfig.positionIterations},this.BASE_SCALE=this.originalConfig.scale,this.quality=this.originalConfig.quality,this.SCALE=this.BASE_SCALE*this.quality,this.mouseWorld.Set(0,0),this._setupContactListener(),this.mouseDownEntity=null,this.touchStartEntities=new Map,this.engine&&"function"==typeof this.engine.trigger&&this.engine.trigger("physicsReset",{timestamp:Date.now(),config:this.originalConfig}),this}catch(t){return this.engine&&"function"==typeof this.engine.error&&this.engine.error("Error during physics reset:",t),!1}}}])}();function Ut(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=$t(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return r=t.done,t},e:function(t){a=!0,s=t},f:function(){try{r||null==i.return||i.return()}finally{if(a)throw s}}}}function Kt(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function Zt(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Kt(Object(i),!0).forEach(function(e){Ht(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Kt(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function Ht(t,e,i){return(e=ne(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function Qt(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,o,s,r,a=[],l=!0,c=!1;try{if(s=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;l=!1}else for(;!(l=(n=s.call(i)).done)&&(a.push(n.value),a.length!==e);l=!0);}catch(t){c=!0,o=t}finally{try{if(!l&&null!=i.return&&(r=i.return(),Object(r)!==r))return}finally{if(c)throw o}}return a}}(t,e)||$t(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function $t(t,e){if(t){if("string"==typeof t)return te(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?te(t,e):void 0}}function te(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function ee(t){return ee="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ee(t)}function ie(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,ne(n.key),n)}}function ne(t){var e=function(t,e){if("object"!=ee(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=ee(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==ee(e)?e:e+""}var oe=function(){return function(t,e,i){return e&&ie(t.prototype,e),i&&ie(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.engine=e,this.running=!1,this.maps=new Map,this.activeMap=null,this.animatedTiles=new Map,this.activeCollisions=new Map,this._bindInputEvents(),this._bindPhysicsEvents()},[{key:"create",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"!=typeof t)throw new Error("name must be a non-empty string");if("object"!==ee(e))throw new Error("config must be a plain object");if("object"!==ee(e.tiles))throw new Error("config.tiles is required and must be a plain object");if("object"!==ee(e.layers))throw new Error("config.layers is required and must be a plain object");for(var i=e.layers,n=e.tiles,o=e.overlap,s=Number(e.tileBaseSize)||32,r=new Map,a=0,l=Object.entries(n);a<l.length;a++){var c,h,u=Qt(l[a],2),m=u[0],y=u[1],p="string"==typeof y?{tile:y}:y;r.set(m,Zt(Zt({},p),{},{tile:null!==(c=p.tile)&&void 0!==c?c:y,collision:null!==(h=p.collision)&&void 0!==h?h:null}))}return this.maps.set(t,{layers:new Map,tiles:r,tileBaseSize:s,overlap:o}),this.maps.get(t).layers=this.parseLayersWithWorldCoords(i,t),this}},{key:"update",value:function(){if(this.running&&this.activeMap&&(this._updateAnimatedTiles(),this.engine.collisionEnabled&&!this.engine.physicsEnabled)){var t,e=Ut(this.engine.entities);try{for(e.s();!(t=e.n()).done;){var i,n=Qt(t.value,2),o=(n[0],n[1]);null!==(i=o.collision)&&void 0!==i&&i.enabled&&this._checkCollisions(o)}}catch(t){e.e(t)}finally{e.f()}}}},{key:"render",value:function(t){if(!this.maps.has(t))throw new Error("TileMap(".concat(t,") not found"));this.clear(),this.running=!0,this.activeMap=t,this._initializeTileAnimations(),this.engine.physicsEnabled&&this._addTilePhysicsEntities(),this._addTilesToDebugger()}},{key:"_renderMap",value:function(){var t;if(this.running&&this.activeMap){var e=this.engine.ctx,i=this.engine.camera,n=this.getTileBaseSize(),o=this.maps.get(this.activeMap),s=null!==(t=o.overlap)&&void 0!==t?t:1,r=Math.floor(i.x),a=Math.floor(i.y),l=this.engine.baseWidth/i.zoom,c=this.engine.baseHeight/i.zoom,h=Math.floor(r/n)-1,u=Math.floor(a/n)-1,m=Math.ceil((r+l)/n)+1,y=Math.ceil((a+c)/n)+1;e.imageSmoothingEnabled=!1;var p,d=Ut(o.layers);try{for(d.s();!(p=d.n()).done;)for(var f=Qt(p.value,2),_=f[0],v=f[1],g=Math.max(0,u),b=Math.min(v.length,y),x=g;x<b;x++){var w=v[x];if(w)for(var C=Math.max(0,h),S=Math.min(w.length,m),A=C;A<S;A++){var M,k=w[A];if(k){var D=o.tiles.get(k.symbol);D&&(D.parts?this._renderCompositeTile(e,Zt(Zt({},D),{},{symbol:k.symbol}),k.tileX,k.tileY,n,s,_):this._renderSingleTile(e,Zt(Zt({},D),{},{symbol:k.symbol}),k.tileX,k.tileY,n,s,_),null!==(M=this.engine.debugger)&&void 0!==M&&M.active&&this._renderTileDebug(e,D,A,x,n))}}}}catch(t){d.e(t)}finally{d.f()}}}},{key:"_renderTileDebug",value:function(t,e,i,n,o){var s;t.save();var r=null!==(s=e.collision)&&void 0!==s?s:{},a=Qt((null==r?void 0:r.bounds)||[0,0,o,o],4),l=a[0],c=a[1],h=(a[2],a[3],i*o+l),u=n*o+c,m=Math.max(6,8/this.engine.camera.zoom);t.font="".concat(m,"px monospace"),t.textAlign="left",t.textBaseline="top";var y=u+2;if(r.type){t.fillStyle="rgba(255, 255, 255, 0.9)",t.strokeStyle="rgba(0, 0, 0, 0.7)",t.lineWidth=.5;var p=r.type;t.strokeText(p,h+2,y),t.fillText(p,h+2,y),y+=m+1}t.fillStyle="rgba(255, 255, 0, 0.9)",t.strokeStyle="rgba(0, 0, 0, 0.7)";var d="".concat(i,",").concat(n);t.strokeText(d,h+2,y),t.fillText(d,h+2,y),t.restore()}},{key:"_renderCompositeTile",value:function(t,e,i,n,o,s,r){this._renderSingleTile(t,Zt(Zt({},e),{},{symbol:e.symbol}),i,n,o,s,r);var a,l=Ut(e.parts);try{for(l.s();!(a=l.n()).done;){var c,h=a.value,u=h.offsetX||0,m=h.offsetY||0,y=i+u,p=n+m;this._renderSingleTile(t,h.tile,y,p,o,s,r),null!==(c=this.engine.debugger)&&void 0!==c&&c.active&&this._renderTileDebug(t,h,y,p,o)}}catch(t){l.e(t)}finally{l.f()}}},{key:"_renderSingleTile",value:function(t,e,i,n,o,s,r){var a,l,c,h,u="string"==typeof e?e:e.tile;if("object"===ee(e)&&e.frames&&e.symbol){var m=r?this.getCurrentTileFrame(e.symbol,i,n,r):null,y=this.getCurrentTileFrame(e.symbol),p=m||y;p&&(u=p)}var d=this.getAssetTileInfo(u);if(d){var f=this.engine.getAsset(d.assetId);if(f){var _=f.config.tiles[d.tileName];if(_){var v=Math.floor(i*o-s),g=Math.floor(n*o-s),b=o+2*s;t.save(),t.translate(v+b/2,g+b/2),t.rotate((e.rotation||0)*Math.PI/180),t.scale(null!==(a=null!==(l=e.scaleX)&&void 0!==l?l:e.scale)&&void 0!==a?a:1,null!==(c=null!==(h=e.scaleY)&&void 0!==h?h:e.scale)&&void 0!==c?c:1),t.transform(1,Math.tan((e.skewY||0)*Math.PI/180),Math.tan((e.skewX||0)*Math.PI/180),1,0,0),t.translate(-b/2,-b/2),t.drawImage(f.asset,_.x,_.y,_.width,_.height,0,0,b,b),t.restore()}}}}},{key:"normalizeLayer",value:function(t){return t.map(function(t){return"string"==typeof t?t.split("").map(function(t){return" "===t?void 0:t}):Array.from(t,function(t){return void 0===t?void 0:t})})}},{key:"exportLayers",value:function(t){var e=this.maps.get(this.activeMap),i={};if(void 0!==t){if(!e.layers.has(t))return this.engine.warn("Layer '".concat(t,"' not found")),JSON.stringify({},null,2);var n=e.layers.get(t).map(function(t){return t.map(function(t){return t&&t.symbol||" "}).join("")});i[t]=n}else{var o,s=Ut(e.layers);try{for(s.s();!(o=s.n()).done;){var r=Qt(o.value,2),a=r[0],l=r[1].map(function(t){return t.map(function(t){return t&&t.symbol||" "}).join("")});i[a]=l}}catch(t){s.e(t)}finally{s.f()}}return JSON.stringify(i,null,2)}},{key:"fillBoxWith",value:function(t){for(var e=this.engine.canvas,i=this.getTileSize(),n=Math.ceil(e.width/i),o=Math.ceil(e.height/i),s=[],r=0;r<o;r++){var a=new Array(n).fill(t);s.push(a)}return s}},{key:"fillWith",value:function(t,e){return new Array(e).fill(t)}},{key:"getAssetTileInfo",value:function(t){var e,i;if("string"!=typeof t)return null;var n=Qt(t.split("."),2),o=n[0],s=n[1];if(!o||!s)return null;var r=this.engine.getAsset(o);return r?{assetId:o,tileName:s,asset:r,tileSize:(null===(e=r.config)||void 0===e?void 0:e.tileSize)||this.getTileBaseSize(),exists:!!(null===(i=r.config)||void 0===i||null===(i=i.tiles)||void 0===i?void 0:i[s])}:{assetId:o,tileName:s,exists:!1}}},{key:"getTileSize",value:function(t){var e=this.getAssetTileInfo(t);if(!e)return this.getTileBaseSize();var i=this.engine.getAsset(e.assetId);return(null==i?void 0:i.config.tileSize)||this.getTileBaseSize()}},{key:"getTileBaseSize",value:function(){var t,e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.activeMap;return null!==(t=null===(e=this.maps.get(i))||void 0===e?void 0:e.tileBaseSize)&&void 0!==t?t:32}},{key:"addTile",value:function(t,e){var i,n=this,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=this.maps.get(this.activeMap),a=this.getTileBaseSize();if(o=Math.floor(Number(o)),s=Math.floor(Number(s)),!Number.isInteger(o)||!Number.isInteger(s)||o<0||s<0)return this.engine.warn("Invalid coordinates: x=".concat(o,", y=").concat(s,". Coordinates must be non-negative integers.")),this;if(!r.tiles.has(e))return this.engine.warn("Symbol '".concat(e,"' not found in tiles configuration")),this;r.layers.has(t)||(r.layers.set(t,[]),this.engine.log("Created new layer: ".concat(t)));for(var l=r.layers.get(t);l.length<=s;)l.push([]);for(var c=l[s];c.length<=o;)c.push(void 0);c[o]&&this.removeTile(t,o,s);var h=r.tiles.get(e),u=(null==h||null===(i=h.collision)||void 0===i?void 0:i.bounds)||[0,0,a,a],m={symbol:e,tileX:o,tileY:s,worldX:o*a+u[0],worldY:s*a+u[1]};if(c[o]=m,this.running&&h.collision&&this.engine.physicsEnabled){var y=this.tileToEntity(Zt({config:h,layer:t},m),m.worldX,m.worldY);Promise.resolve().then(function(){var t;n.engine.physics.hasEntity(y.id)||n.engine.physics.addEntity(y,null!==(t=y.physics)&&void 0!==t?t:{})})}return h.collision&&this.engine.debugger.addItem("tile_".concat(o,"_").concat(s,"_").concat(t),this._normalizeTileConfig(h,m.worldX,m.worldY)),this.engine.info("Added tile '".concat(e,"' to layer '").concat(t,"' at position (").concat(o,", ").concat(s,")")),this}},{key:"removeTile",value:function(t,e,i){var n=this.maps.get(this.activeMap);if(!n)return this.engine.warn("No active map"),this;var o=n.layers.get(t);if(!o)return this.engine.warn("Layer '".concat(t,"' not found")),this;if(e=Math.floor(Number(e)),i=Math.floor(Number(i)),!Number.isInteger(e)||!Number.isInteger(i)||e<0||i<0)return this.engine.warn("Invalid coordinates: x=".concat(e,", y=").concat(i)),this;if(i>=o.length||!o[i]||e>=o[i].length)return this.engine.warn("Tile position (".concat(e,", ").concat(i,") out of bounds")),this;var s=o[i][e];if(!s)return this.engine.warn("No tile found at position (".concat(e,", ").concat(i,")")),this;if(this.engine.physicsEnabled){var r="tile_".concat(e,"_").concat(i,"_").concat(t);this.engine.physics.hasEntity(r)&&this.engine.physics.removeEntity({id:r})}var a="tile_".concat(s.symbol,"_").concat(e,"_").concat(i,"_").concat(t);this.animatedTiles.has(a)&&this.animatedTiles.delete(a);var l="tile_".concat(e,"_").concat(i,"_").concat(t);this.activeCollisions.has(l)&&this.activeCollisions.delete(l);var c="tile_".concat(e,"_").concat(i,"_").concat(t);return this.engine.debugger.removeItem(c),o[i][e]=void 0,this.engine.info("Removed tile '".concat(s.symbol,"' from layer '").concat(t,"' at position (").concat(e,", ").concat(i,")")),this}},{key:"getTileInfo",value:function(t){var e=this.maps.get(this.activeMap);if(!e||!t)return[];var i,n=[],o=Ut(e.layers);try{for(o.s();!(i=o.n()).done;)for(var s=Qt(i.value,2),r=s[0],a=s[1],l=0;l<a.length;l++)for(var c=a[l],h=0;h<c.length;h++){var u=c[h];if(u&&u.symbol===t){var m=e.tiles.get(t);n.push(Zt(Zt({},u),{},{config:m,layer:r}))}}}catch(t){o.e(t)}finally{o.f()}return n}},{key:"moveTile",value:function(t,e,i,n,o,s){var r=this.maps.get(this.activeMap);if(!r)return this.engine.warn("No active map"),this;if(e=Math.floor(Number(e)),i=Math.floor(Number(i)),o=Math.floor(Number(o)),s=Math.floor(Number(s)),!(Number.isInteger(e)&&Number.isInteger(i)&&Number.isInteger(o)&&Number.isInteger(s)))return this.engine.warn("Coordinates must be integer numbers"),this;var a=r.layers.get(t);if(!a||i>=a.length||e>=a[i].length)return this.engine.warn("Source tile (".concat(e,", ").concat(i,") is out of range")),this;var l=a[i][e];if(!l)return this.engine.warn("No tile found at (".concat(e,", ").concat(i,", layer:").concat(t,")")),this;if(this.engine.physicsEnabled){var c="tile_".concat(e,"_").concat(i,"_").concat(t);this.engine.physics.hasEntity(c)&&this.engine.physics.removeEntity({id:c})}return a[i][e]=void 0,this.addTile(null!=n?n:t,l.symbol,o,s),this}},{key:"getTilesAt",value:function(t,e){var i=this.maps.get(this.activeMap),n=this.getTileBaseSize(),o=Math.floor(t/n),s=Math.floor(e/n),r=[];if(o<0||s<0)return r;var a,l=Ut(i.layers);try{for(l.s();!(a=l.n()).done;){var c=Qt(a.value,2),h=c[0],u=c[1];if(u[s]&&u[s][o]){var m=u[s][o];if(m){var y=i.tiles.get(m.symbol);y&&r.push(Zt(Zt({},m),{},{config:y,layer:h}))}}}}catch(t){l.e(t)}finally{l.f()}return r}},{key:"findTilesIn",value:function(t,e){var i=this,n=this.maps.get(this.activeMap);if(!n)return[];for(var o=this.getTileBaseSize(),s=Math.floor(t/o),r=Math.floor(e/o),a=[],l=-1;l<=1;l++)for(var c=-1;c<=1;c++){var h=s+c,u=r+l;if(!(u<0||h<0)){var m,y=Ut(n.layers);try{var p=function(){var s=Qt(m.value,2),r=s[0],l=s[1];if(u>=l.length)return 0;var c=l[u];if(!c||h>=c.length)return 0;var y=c[h];if(!y)return 0;var p=n.tiles.get(y.symbol);if(!p)return 0;if(!i.isPointInTileShape(t,e,h,u,p,o,r))return 0;var d=Zt(Zt({},y),{},{config:p,layer:r});p.parts&&(d.parts=p.parts.map(function(t){return{offsetX:t.offsetX||0,offsetY:t.offsetY||0,config:Object.assign(Object.create(null),p,t,{isPart:!0})}})),a.push(d)};for(y.s();!(m=y.n()).done;)p()}catch(t){y.e(t)}finally{y.f()}}}return a}},{key:"findTileByEntityId",value:function(t){if(!t.startsWith("tile_"))return null;var e=Qt(t.split("_"),4),i=e[1],n=e[2],o=e[3],s=this.maps.get(this.activeMap),r=s.layers.get(o);if(!r||!r[n]||!r[n][i])return null;var a=r[n][i],l=s.tiles.get(a.symbol);return Zt(Zt({},a),{},{config:l,layer:o})}},{key:"tileToEntity",value:function(t,e,i){var n=this.getTileBaseSize(),o="tile_".concat(t.tileX||Math.floor(e/n),"_").concat(t.tileY||Math.floor(i/n),"_").concat(t.layer);return new Bt(o,Zt({engine:this.engine,hoverable:!1,clickable:!1,draggable:!1,data:{tile:t}},this._normalizeTileConfig(t.config,e,i)))}},{key:"_normalizeTileConfig",value:function(t,e,i){var n,o,s=this.getTileBaseSize(),r=(null==t||null===(n=t.collision)||void 0===n?void 0:n.bounds)||[0,0,s,s];return{x:e,y:i,width:r[2],height:r[3],shape:(null==t?void 0:t.shape)||"rectangle",scale:(null==t?void 0:t.scale)||1,scaleX:(null==t?void 0:t.scaleX)||1,scaleY:(null==t?void 0:t.scaleY)||1,skewX:(null==t?void 0:t.skewX)||0,skewY:(null==t?void 0:t.skewY)||0,rotation:(null==t?void 0:t.rotation)||0,borderRadius:(null==t?void 0:t.borderRadius)||0,spikes:(null==t?void 0:t.spikes)||5,collision:Zt({x:r[0],y:r[1],width:r[2],height:r[3],points:null},(null==t?void 0:t.collision)||{}),physics:Zt(Zt({friction:0,density:0,restitution:0},(null==t?void 0:t.physics)||{}),{},{bodyType:"static",sensor:"sensor"===(null==t||null===(o=t.collision)||void 0===o?void 0:o.type)})}}},{key:"_addTilesToDebugger",value:function(){var t=this.maps.get(this.activeMap);if(t){var e,i=Ut(t.layers);try{for(i.s();!(e=i.n()).done;)for(var n=Qt(e.value,2),o=n[0],s=n[1],r=0;r<s.length;r++){var a=s[r];if(a)for(var l=0;l<a.length;l++){var c=a[l];if(c){var h=t.tiles.get(c.symbol),u="tile_".concat(c.tileX,"_").concat(c.tileY,"_").concat(o);null!=h&&h.collision&&this.engine.debugger.addItem(u,this._normalizeTileConfig(h,c.worldX,c.worldY))}}}}catch(t){i.e(t)}finally{i.f()}}}},{key:"parseLayersWithWorldCoords",value:function(t,e){for(var i=new Map,n=this.maps.get(e),o=n.tiles,s=n.tileBaseSize,r=0,a=Object.entries(t);r<a.length;r++){for(var l=Qt(a[r],2),c=l[0],h=l[1],u=Array.isArray(h)?this.normalizeLayer(h):h,m=[],y=0;y<u.length;y++){for(var p=u[y],d=[],f=0;f<p.length;f++){var _=p[f];if(_){var v,g=o.get(_),b=(null==g||null===(v=g.collision)||void 0===v?void 0:v.bounds)||[0,0,s,s];d.push({symbol:_,tileX:f,tileY:y,worldX:f*s+b[0],worldY:y*s+b[1]})}else d.push(void 0)}m.push(d)}i.set(c,m)}return i}},{key:"tileToWorld",value:function(t,e){var i,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.activeMap;if(!n||!this.maps.has(n))return null===(i=this.engine)||void 0===i||i.warn("Map '".concat(n,"' not found")),{worldX:0,worldY:0};var o=this.getTileBaseSize(n);return{x:t*o,y:e*o}}},{key:"worldToTile",value:function(t,e){var i,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.activeMap;if(!n||!this.maps.has(n))return null===(i=this.engine)||void 0===i||i.warn("Map '".concat(n,"' not found")),{tileX:0,tileY:0};var o=this.getTileBaseSize(n);return{x:Math.floor(t/o),y:Math.floor(e/o)}}},{key:"isPointInTileShape",value:function(t,e,i,n,o,s){var r,a,l,c,h,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"points",m=this.maps.get(this.activeMap).layers.get(u),p=null==m||null===(r=m[n])||void 0===r?void 0:r[i];if(!p){var d,f=(null==o||null===(d=o.collision)||void 0===d?void 0:d.bounds)||[0,0,s,s],_=i*s+f[0],v=n*s+f[1];return t>=_&&t<=_+f[2]&&e>=v&&e<=v+f[3]}if(!(null!==(a=o.collision)&&void 0!==a&&a.points||null!==(l=o.styles)&&void 0!==l&&l.customPath||null!==(c=o.styles)&&void 0!==c&&c.shape||null!==(h=o.collision)&&void 0!==h&&h.bounds)){var g,b=(null==o||null===(g=o.collision)||void 0===g?void 0:g.bounds)||[0,0,s,s];return t>=p.worldX&&t<=p.worldX+b[2]&&e>=p.worldY&&e<=p.worldY+b[3]}var x=this.tileToEntity(Zt({config:o,layer:u},p),p.worldX,p.worldY),w=this.engine.collision.getVertices(x);return y.isPointInShape(t,e,w)}},{key:"_bindPhysicsEvents",value:function(){var t=this;this.engine.physicsEnabled&&(this.engine.on("collisions",function(e){var i,n,o,s,r,a,l=e.entityA,c=e.entityB;if(l.data("tile"))a=e.sideA,s=e.entityA,r=e.entityB;else{if(!c.data("tile"))return;a=e.sideB,s=e.entityB,r=e.entityA}var h=s.data("tile").config;if(e.entityA=s,e.entityB=r,null==h||null===(i=h.collision)||void 0===i||null===(n=i.onCollide)||void 0===n||n.call(i,e),"platform"===(null==h||null===(o=h.collision)||void 0===o?void 0:o.type)){if(void 0!==h.collision.side&&h.collision.side!==a)return;t._applyPlatform(r,s,e)}}),this.engine.on("collisionEnd",function(t){var e,i,n,o,s,r=t.entityA,a=t.entityB;if(r.data("tile"))o=t.entityA,s=t.entityB;else{if(!a.data("tile"))return;o=t.entityB,s=t.entityA}var l=o.data("tile").config;"platform"===(null==l||null===(e=l.collision)||void 0===e?void 0:e.type)&&Promise.resolve().then(function(){return s.unset("onGround")}),t.entityA=o,t.entityB=s,null==l||null===(i=l.collision)||void 0===i||null===(n=i.onCollisionEnd)||void 0===n||n.call(i,t)}))}},{key:"_checkCollisions",value:function(t){var e,i=this;if(null!==(e=t.collision)&&void 0!==e&&e.enabled){var n,o=this._scanSurroundingTiles(t),s=Ut(this.activeCollisions);try{var r=function(){var e,s,r=Qt(n.value,2),a=r[0],l=r[1];if(o.has(a))return 1;"platform"===l.tile.config.collision.type&&Promise.resolve().then(function(){if(i.engine.physicsEnabled&&t.physics){var e,n=t.data("onGround");i.engine.physics.setBodyType(t.id,(null==n||null===(e=n.physics)||void 0===e?void 0:e.bodyType)||"dynamic")}l.entity.unset("onGround")}),null===(e=(s=l.tile.config.collision).onCollisionEnd)||void 0===e||e.call(s,{entity:l.entity,tile:l.tile.config,position:{x:l.tile.worldX,y:l.tile.worldY},worldX:l.tile.worldX,worldY:l.tile.worldY,layer:l.layer})};for(s.s();!(n=s.n()).done;)r()}catch(t){s.e(t)}finally{s.f()}this.activeCollisions=o}}},{key:"_scanSurroundingTiles",value:function(t){for(var e,i=this.getTileBaseSize(),n=i/2,o={left:Math.floor((t.absoluteX-n)/i),top:Math.floor((t.absoluteY-n)/i),right:Math.ceil((t.absoluteX+t.width+n)/i),bottom:Math.ceil((t.absoluteY+t.height+n)/i)},s=new Map,r=o.top;r<=o.bottom;r++)for(var a=o.left;a<=o.right;a++){var l,c=Ut(this.getTilesAt(a*i,r*i));try{for(c.s();!(l=c.n()).done;){var h,u,m=l.value;if(m.config.collision){var y=this._checkTileCollision(t,m,m.worldX,m.worldY);if(null!=y&&y.collides){var p="tile_".concat(m.tileX,"_").concat(m.tileY,"_").concat(m.layer),d={entity:t,tile:m,position:{x:m.worldX,y:m.worldY},worldX:m.worldX,worldY:m.worldY,layer:m.layer,side:y.side,amount:y.amount,collisionType:m.config.collision.type};switch(s.set(p,{entity:t,tile:m,x:m.tileX,y:m.tileY,layer:m.layer,time:performance.now(),side:y.side,amount:y.amount}),m.config.collision.type){case"solid":this._applySolid(t,Zt(Zt({},y),{},{tile:m}));break;case"platform":void 0!==(null===(e=m.collision)||void 0===e?void 0:e.side)?m.collision.side===y.side&&this._applyPlatform(t,m,y):this._applyPlatform(t,m,y)}(!this.activeCollisions.has(p)||this.activeCollisions.get(p).side!==y.side)&&(null===(h=(u=m.config.collision).onCollide)||void 0===h||h.call(u,d))}}}}catch(t){c.e(t)}finally{c.f()}}return s}},{key:"_checkTileCollision",value:function(t,e,i,n){var o=this.tileToEntity(e,i,n),s=this.engine.collision.detectCollisionDetailed(t,o);if(!s.colliding)return{collides:!1};var r=this.engine.collision.getSideFromCenters(t,o);switch(e.config.collision.type){case"platform":return"top"===r?{collides:!0,side:"top",amount:s.overlap}:{collides:!1};case"sensor":return{collides:!0,side:r,amount:s.overlap,isTrigger:!0};default:return{collides:!0,side:r,amount:s.overlap}}}},{key:"_applySolid",value:function(t,e){var i=e.side,n=e.amount,o=0,s=0;switch(i){case"left":o-=n;break;case"right":o+=n;break;case"top":s-=n;break;case"bottom":s+=n}0===o&&0===s||(this.engine.physicsEnabled&&t.physics&&this.engine.physics.haltBody(t.id),t.style({x:t.absoluteX+o,y:t.absoluteY+s}))}},{key:"_applyPlatform",value:function(t,e,i){if(this.engine.physicsEnabled)return t.data("onGround",e.data("tile")),this;t.data("onGround",e)}},{key:"_addTilePhysicsEntities",value:function(){var t=this.maps.get(this.activeMap);if(t){var e,i=Ut(t.layers);try{for(i.s();!(e=i.n()).done;)for(var n=Qt(e.value,2),o=n[0],s=n[1],r=0;r<s.length;r++){var a=s[r];if(a)for(var l=0;l<a.length;l++){var c=a[l];if(c){var h=t.tiles.get(c.symbol);if(h&&h.collision){var u,m=this.tileToEntity(Zt({config:h,layer:o},c),c.worldX,c.worldY);if(!this.engine.physics.hasEntity(m.id))this.engine.physics.addEntity(m,null!==(u=m.physics)&&void 0!==u?u:{})}}}}}catch(t){i.e(t)}finally{i.f()}}}},{key:"_removeTilePhysicsEntities",value:function(){var t=this.maps.get(this.activeMap);if(t){var e,i=Ut(t.layers);try{for(i.s();!(e=i.n()).done;)for(var n=Qt(e.value,2),o=n[0],s=n[1],r=0;r<s.length;r++){var a=s[r];if(a)for(var l=0;l<a.length;l++){var c=a[l];if(c){var h="tile_".concat(c.tileX,"_").concat(c.tileY,"_").concat(o);this.engine.physics.hasEntity(h)&&this.engine.physics.removeEntity({id:h})}}}}catch(t){i.e(t)}finally{i.f()}}}},{key:"getCurrentTileFrame",value:function(t){var e,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;e=null!==i&&null!==n&&o?"tile_".concat(t,"_").concat(i,"_").concat(n,"_").concat(o):"tile_".concat(t);var s=this.animatedTiles.get(e);return s&&s.frames?s.frames[s.currentFrame]:null}},{key:"playTileAnimation",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(null!==e&&null!==i&&null!==n){var o="tile_".concat(t,"_").concat(e,"_").concat(i,"_").concat(n),s=this.animatedTiles.get(o);s?(s.playing=!0,s.lastFrameTime=performance.now()):this.engine.warn("Animation data not found for: ".concat(o))}else{var r,a=Ut(this.animatedTiles);try{for(a.s();!(r=a.n()).done;){var l=Qt(r.value,2),c=l[0],h=l[1];c.includes("tile_".concat(t))&&(h.playing=!0,h.lastFrameTime=performance.now())}}catch(t){a.e(t)}finally{a.f()}}return this}},{key:"pauseTileAnimation",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(null!==e&&null!==i&&null!==n){var o="tile_".concat(t,"_").concat(e,"_").concat(i,"_").concat(n),s=this.animatedTiles.get(o);s&&(s.playing=!1)}else{var r,a=Ut(this.animatedTiles);try{for(a.s();!(r=a.n()).done;){var l=Qt(r.value,2),c=l[0],h=l[1];c.includes("tile_".concat(t))&&(h.playing=!1)}}catch(t){a.e(t)}finally{a.f()}}return this}},{key:"stopTileAnimation",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(null!==e&&null!==i&&null!==n){var o="tile_".concat(t,"_").concat(e,"_").concat(i,"_").concat(n),s=this.animatedTiles.get(o);s&&(s.playing=!1,s.currentFrame=0)}else{var r,a=Ut(this.animatedTiles);try{for(a.s();!(r=a.n()).done;){var l=Qt(r.value,2),c=l[0],h=l[1];c.includes("tile_".concat(t))&&(h.playing=!1,h.currentFrame=0)}}catch(t){a.e(t)}finally{a.f()}}return this}},{key:"setTileAnimationFrame",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;if(null!==i&&null!==n&&null!==o){var s="tile_".concat(t,"_").concat(i,"_").concat(n,"_").concat(o),r=this.animatedTiles.get(s);r&&e>=0&&e<r.frames.length&&(r.currentFrame=e)}else{var a,l=Ut(this.animatedTiles);try{for(l.s();!(a=l.n()).done;){var c=Qt(a.value,2),h=c[0],u=c[1];h.includes("tile_".concat(t))&&e>=0&&e<u.frames.length&&(u.currentFrame=e)}}catch(t){l.e(t)}finally{l.f()}}return this}},{key:"setTileAnimationSpeed",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;if(null!==i&&null!==n&&null!==o){var s="tile_".concat(t,"_").concat(i,"_").concat(n,"_").concat(o),r=this.animatedTiles.get(s);r&&(r.frameRate=e)}else{var a,l=Ut(this.animatedTiles);try{for(l.s();!(a=l.n()).done;){var c=Qt(a.value,2),h=c[0],u=c[1];h.includes("tile_".concat(t))&&(u.frameRate=e)}}catch(t){l.e(t)}finally{l.f()}}return this}},{key:"_initializeTileAnimations",value:function(){var t=this;if(this.running&&this.activeMap){var e,i=Ut(this.maps.get(this.activeMap).tiles);try{var n=function(){var i=Qt(e.value,2),n=i[0],o=i[1];if(o.frames&&o.frames.length>1){var s,r;t.getTileInfo(n).forEach(function(e){var i,s,r="tile_".concat(n,"_").concat(e.tileX,"_").concat(e.tileY,"_").concat(e.layer);t.animatedTiles.set(r,{frames:o.frames,frameRate:o.frameRate||8,loop:null!==(i=o.loop)&&void 0!==i&&i,currentFrame:0,playing:null===(s=o.playing)||void 0===s||s,lastFrameTime:performance.now()})});var a="tile_".concat(n);t.animatedTiles.set(a,{frames:o.frames,frameRate:o.frameRate||8,loop:null!==(s=o.loop)&&void 0!==s&&s,currentFrame:0,playing:null===(r=o.playing)||void 0===r||r,lastFrameTime:performance.now()})}};for(i.s();!(e=i.n()).done;)n()}catch(t){i.e(t)}finally{i.f()}}}},{key:"_updateAnimatedTiles",value:function(){var t,e=performance.now(),i=Ut(this.animatedTiles);try{for(i.s();!(t=i.n()).done;){var n=Qt(t.value,2),o=(n[0],n[1]);if(o.frames&&!(o.frames.length<=1)&&!1!==o.playing){var s=1e3/o.frameRate;e-o.lastFrameTime>=s&&(o.loop?o.currentFrame=(o.currentFrame+1)%o.frames.length:o.currentFrame<o.frames.length-1&&o.currentFrame++,o.lastFrameTime=e)}}}catch(t){i.e(t)}finally{i.f()}}},{key:"_bindInputEvents",value:function(){var t=this,e=this.engine;e.on("click",function(e){return t.running&&t.activeMap&&t._onTileClick(e)}),e.on("rightclick",function(e){return t.running&&t.activeMap&&t._onTileRightClick(e)}),this.lastHoverStack=[],e.on("mousemove",function(e){return t.running&&t.activeMap&&t._onTileHover(e)})}},{key:"_buildTileEvent",value:function(t,e,i,n){return{symbol:i.symbol,config:i.config,tileX:i.tileX,tileY:i.tileY,worldX:i.worldX,worldY:i.worldY,layer:i.layer,screenX:n.screenX,screenY:n.screenY,originalEvent:n,stopPropagation:function(){this.__stopped=!0}}}},{key:"_onTileHover",value:function(t){var e,i=this,n=this.findTilesIn(t.worldX,t.worldY).reverse(),o=this.lastHoverStack,s=Ut(o);try{var r=function(){var o=e.value;if(!n.some(function(t){return t.layer===o.layer&&t.tileX===o.tileX&&t.tileY===o.tileY})){var s,r,a=i._buildTileEvent(t.worldX,t.worldY,o,t);null===(s=o.config)||void 0===s||null===(r=s.onHoverOut)||void 0===r||r.call(s,a)}};for(s.s();!(e=s.n()).done;)r()}catch(t){s.e(t)}finally{s.f()}var a,l=Ut(n);try{var c=function(){var e=a.value;if(!o.some(function(t){return t.layer===e.layer&&t.tileX===e.tileX&&t.tileY===e.tileY})){var n,s,r=i._buildTileEvent(t.worldX,t.worldY,e,t);null===(n=e.config)||void 0===n||null===(s=n.onHover)||void 0===s||s.call(n,r)}};for(l.s();!(a=l.n()).done;)c()}catch(t){l.e(t)}finally{l.f()}this.lastHoverStack=n}},{key:"_onTileClick",value:function(t){var e,i=Ut(this.findTilesIn(t.worldX,t.worldY).reverse());try{for(i.s();!(e=i.n()).done;){var n,o,s=e.value,r=this._buildTileEvent(t.worldX,t.worldY,s,t);if(null===(n=s.config)||void 0===n||null===(o=n.onClick)||void 0===o||o.call(n,r),r.__stopped)break}}catch(t){i.e(t)}finally{i.f()}}},{key:"_onTileRightClick",value:function(t){var e,i=Ut(this.findTilesIn(t.worldX,t.worldY).reverse());try{for(i.s();!(e=i.n()).done;){var n,o,s=e.value,r=this._buildTileEvent(t.worldX,t.worldY,s,t);if(null===(n=s.config)||void 0===n||null===(o=n.onRightClick)||void 0===o||o.call(n,r),r.__stopped)break}}catch(t){i.e(t)}finally{i.f()}}},{key:"enableTileDebug",value:function(){return this._addTilesToDebugger(),this}},{key:"disableTileDebug",value:function(){var t=this.maps.get(this.activeMap);if(!t)return this;var e,i=Ut(t.layers);try{for(i.s();!(e=i.n()).done;)for(var n=Qt(e.value,2),o=n[0],s=n[1],r=0;r<s.length;r++){var a=s[r];if(a)for(var l=0;l<a.length;l++){var c=a[l];if(c){var h="tile_".concat(c.tileX,"_").concat(c.tileY,"_").concat(o);this.engine.debugger.removeItem(h)}}}}catch(t){i.e(t)}finally{i.f()}return this}},{key:"clear",value:function(){var t=this;this.disableTileDebug(),this.activeCollisions.clear(),this.animatedTiles.clear(),this.engine.physicsEnabled?this._removeTilePhysicsEntities():this.engine.collisionEnabled&&this.engine.collision.decomposedShapes.forEach(function(e,i){i.startsWith("tile_")&&t.engine.collision.decomposedShapes.delete(i)}),this.lastHoverStack=[]}},{key:"reset",value:function(){this.clear(),this.maps.clear(),this.activeMap=null,this.running=!1}},{key:"destroy",value:function(){this.reset();var t=this.engine;t.off("click",this._onTileClick),t.off("rightclick",this._onTileRightClick),t.off("mousemove",this._onTileHover),this.engine=null,this.maps=null,this.activeMap=null,this.animatedTiles=null,this.activeCollisions=null,this.lastHoverStack=null}}])}();const se=oe;function re(t){return re="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},re(t)}function ae(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,le(n.key),n)}}function le(t){var e=function(t,e){if("object"!=re(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=re(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==re(e)?e:e+""}var ce=function(){return function(t,e,i){return e&&ae(t.prototype,e),i&&ae(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.reset()},[{key:"init",value:function(t){this.x=t.x,this.y=t.y,this.vx=t.velocity.x,this.vy=t.velocity.y,this.ax=t.acceleration.x,this.ay=t.acceleration.y,this.size=t.size,this.currentSize=t.size,this.startColor=t.color.start,this.endColor=t.color.end,this.startAlpha=t.alpha.start,this.endAlpha=t.alpha.end,this.rotation=t.rotation,this.rotationSpeed=t.rotationSpeed,this.lifetime=t.lifetime,this.age=0,this.texture=t.texture}},{key:"render",value:function(t){if(!this.isDead()){var e=this.age/this.lifetime,i=this.startAlpha+(this.endAlpha-this.startAlpha)*e;if(t.save(),t.globalAlpha=i,t.translate(this.x,this.y),t.rotate(this.rotation*Math.PI/180),this.texture){var n=this.texture;t.drawImage(n,-this.size/2,-this.size/2,this.size,this.size)}else{var o=this.interpolateColor(this.startColor,this.endColor,e);t.fillStyle=o,t.beginPath(),t.arc(0,0,this.size/2,0,2*Math.PI),t.fill()}t.restore()}}},{key:"update",value:function(t){var e=t/1e3;this.vx+=this.ax*e,this.vy+=this.ay*e,this.x+=this.vx*e,this.y+=this.vy*e,this.rotation+=this.rotationSpeed*e,this.age+=t}},{key:"reset",value:function(){this.x=0,this.y=0,this.vx=0,this.vy=0,this.ax=0,this.ay=0,this.size=1,this.currentSize=1,this.startColor="#ffffff",this.endColor="#000000",this.startAlpha=1,this.endAlpha=0,this.rotation=0,this.rotationSpeed=0,this.lifetime=1e3,this.age=0,this.texture=null}},{key:"isDead",value:function(){return this.age>=this.lifetime}},{key:"interpolateColor",value:function(t,e,i){var n=parseInt(t.substr(1,2),16),o=parseInt(t.substr(3,2),16),s=parseInt(t.substr(5,2),16),r=parseInt(e.substr(1,2),16),a=parseInt(e.substr(3,2),16),l=parseInt(e.substr(5,2),16),c=Math.round(n+(r-n)*i),h=Math.round(o+(a-o)*i),u=Math.round(s+(l-s)*i);return"rgb(".concat(c,", ").concat(h,", ").concat(u,")")}}])}();const he=ce;function ue(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function me(t,e,i){return(e=_e(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function ye(t){return ye="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ye(t)}function pe(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function de(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,_e(n.key),n)}}function fe(t,e,i){return e&&de(t.prototype,e),i&&de(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function _e(t){var e=function(t,e){if("object"!=ye(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=ye(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==ye(e)?e:e+""}var ve=function(){return fe(function t(e){pe(this,t),this.engine=e,this.emitters=new Map,this.particlePool=[],this.maxPoolSize=1e3},[{key:"create",value:function(t){var e=new ge(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},this.engine);return this.emitters.set(t,e),e}},{key:"get",value:function(t){return this.emitters.get(t)||null}},{key:"remove",value:function(t){var e=this.emitters.get(t);return!!e&&(e.destroy(),this.emitters.delete(t),!0)}},{key:"getAll",value:function(){return Array.from(this.emitters.values())}},{key:"clear",value:function(){this.emitters.forEach(function(t){return t.destroy()}),this.emitters.clear(),this.particlePool=[]}},{key:"getParticle",value:function(){return this.particlePool.length>0?this.particlePool.pop():new he}},{key:"returnParticle",value:function(t){this.particlePool.length<this.maxPoolSize&&(t.reset(),this.particlePool.push(t))}},{key:"update",value:function(t){this.emitters.forEach(function(e){e.active&&e.update(t)})}},{key:"render",value:function(t){this.emitters.forEach(function(e){e.visible&&e.render(t)})}},{key:"explosion",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n={position:{x:t,y:e},shape:"invisible",emission:{type:"point",rate:0,burst:i.particleCount||30,lifetime:i.lifetime||1500},particle:{velocity:{min:{x:-150,y:-150},max:{x:150,y:-50}},acceleration:{x:0,y:100},size:{min:3,max:8},color:{start:i.startColor||"#ff4444",end:i.endColor||"#ffaa00"},alpha:{start:1,end:0},rotation:{min:0,max:360},rotationSpeed:{min:-360,max:360}},autoDestroy:!0},o=this.create("explosion_".concat(Date.now()),n);return o.start(),o.burst(i.particleCount||30),o}},{key:"fire",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n={position:{x:t,y:e},shape:"invisible",emission:{type:"point",rate:i.rate||40,lifetime:i.lifetime||1200},particle:{velocity:{min:{x:-30,y:-80},max:{x:30,y:-40}},acceleration:{x:0,y:-20},size:{min:2,max:6},color:{start:"#ff4444",end:"#ff8800"},alpha:{start:.8,end:0}}},o=this.create("fire_".concat(Date.now()),n);return o.start(),o}},{key:"smoke",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n={position:{x:t,y:e},shape:"invisible",emission:{type:"point",rate:i.rate||15,lifetime:i.lifetime||3e3},particle:{velocity:{min:{x:-20,y:-60},max:{x:20,y:-30}},acceleration:{x:0,y:-10},size:{min:8,max:16},color:{start:"#666666",end:"#cccccc"},alpha:{start:.6,end:0}}},o=this.create("smoke_".concat(Date.now()),n);return o.start(),o}}])}(),ge=function(){return fe(function t(e,i,n){var o,s,r,a,l,c,h,u,m,y,p,d,f,_;pe(this,t),this.id=e,this.engine=n,this.particles=[],this.active=!1,this.visible=!0,this.x=(null===(o=i.position)||void 0===o?void 0:o.x)||0,this.y=(null===(s=i.position)||void 0===s?void 0:s.y)||0,this.targetX=this.x,this.targetY=this.y,this.moveAnimation=null,this.shape=i.shape||"invisible",this.size=i.size||10,this.color=i.color||"#ff0000",this.opacity=i.opacity||.5,this.emission=function(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?ue(Object(i),!0).forEach(function(e){me(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):ue(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}({type:(null===(r=i.emission)||void 0===r?void 0:r.type)||"point",rate:(null===(a=i.emission)||void 0===a?void 0:a.rate)||30,lifetime:(null===(l=i.emission)||void 0===l?void 0:l.lifetime)||2e3,burst:(null===(c=i.emission)||void 0===c?void 0:c.burst)||0},i.emission),this.particle={velocity:(null===(h=i.particle)||void 0===h?void 0:h.velocity)||{min:{x:-50,y:-50},max:{x:50,y:50}},acceleration:(null===(u=i.particle)||void 0===u?void 0:u.acceleration)||{x:0,y:0},size:(null===(m=i.particle)||void 0===m?void 0:m.size)||{min:2,max:4},color:(null===(y=i.particle)||void 0===y?void 0:y.color)||{start:"#ffffff",end:"#000000"},alpha:(null===(p=i.particle)||void 0===p?void 0:p.alpha)||{start:1,end:0},rotation:(null===(d=i.particle)||void 0===d?void 0:d.rotation)||{min:0,max:0},rotationSpeed:(null===(f=i.particle)||void 0===f?void 0:f.rotationSpeed)||{min:0,max:0},texture:(null===(_=i.particle)||void 0===_?void 0:_.texture)||null},this.lastEmissionTime=0,this.emissionInterval=1e3/this.emission.rate,this.autoDestroy=i.autoDestroy||!1},[{key:"start",value:function(){return this.active=!0,this.lastEmissionTime=performance.now(),this}},{key:"stop",value:function(){return this.active=!1,this}},{key:"pause",value:function(){return this.active=!1,this}},{key:"resume",value:function(){return this.active=!0,this.lastEmissionTime=performance.now(),this}},{key:"burst",value:function(t){for(var e=0;e<t;e++)this.emitParticle();return this}},{key:"move",value:function(t,e){return this.x=t,this.y=e,this.targetX=t,this.targetY=e,this.moveAnimation&&(this.moveAnimation=null),this}},{key:"moveTo",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.targetX=t,this.targetY=e;var n=this.x,o=this.y,s=i.duration||1e3,r=this.engine.Ease[i.easing]||this.engine.Ease.linear,a=performance.now();return this.moveAnimation={startX:n,startY:o,targetX:t,targetY:e,duration:s,easing:r,startTime:a},this}},{key:"emitParticle",value:function(){var t,e=this.engine.emitters.getParticle(),i=this.getEmissionPosition();e.init({x:i.x,y:i.y,velocity:this.randomizeValue(this.particle.velocity),acceleration:this.particle.acceleration,size:this.randomizeValue(this.particle.size),color:this.particle.color,alpha:this.particle.alpha,rotation:this.randomizeValue(this.particle.rotation),rotationSpeed:this.randomizeValue(this.particle.rotationSpeed),lifetime:this.emission.lifetime,texture:null===(t=this.engine.getAsset(this.particle.texture))||void 0===t?void 0:t.asset}),this.particles.push(e)}},{key:"getEmissionPosition",value:function(){switch(this.emission.type){case"point":return{x:this.x,y:this.y};case"circle":var t=Math.random()*Math.PI*2,e=this.emission.edge?this.emission.radius:Math.random()*this.emission.radius;return{x:this.x+Math.cos(t)*e,y:this.y+Math.sin(t)*e};case"rectangle":if(!this.emission.edge)return{x:this.x+(Math.random()-.5)*this.emission.width,y:this.y+(Math.random()-.5)*this.emission.height};var i=Math.floor(4*Math.random()),n=this.emission.width,o=this.emission.height;switch(i){case 0:return{x:this.x+Math.random()*n-n/2,y:this.y-o/2};case 1:return{x:this.x+n/2,y:this.y+Math.random()*o-o/2};case 2:return{x:this.x+Math.random()*n-n/2,y:this.y+o/2};case 3:return{x:this.x-n/2,y:this.y+Math.random()*o-o/2}}case"line":var s=Math.random();return{x:this.x+this.emission.start.x+s*(this.emission.end.x-this.emission.start.x),y:this.y+this.emission.start.y+s*(this.emission.end.y-this.emission.start.y)};default:return{x:this.x,y:this.y}}}},{key:"randomizeValue",value:function(t){return"number"==typeof t?t:void 0!==t.min&&void 0!==t.max?"object"===ye(t.min)?{x:t.min.x+Math.random()*(t.max.x-t.min.x),y:t.min.y+Math.random()*(t.max.y-t.min.y)}:t.min+Math.random()*(t.max-t.min):t}},{key:"update",value:function(t){if(this.moveAnimation){var e=performance.now()-this.moveAnimation.startTime,i=Math.min(e/this.moveAnimation.duration,1),n=this.moveAnimation.easing(i);this.x=this.moveAnimation.startX+(this.moveAnimation.targetX-this.moveAnimation.startX)*n,this.y=this.moveAnimation.startY+(this.moveAnimation.targetY-this.moveAnimation.startY)*n,i>=1&&(this.moveAnimation=null)}if(this.active&&this.emission.rate>0){var o=performance.now();o-this.lastEmissionTime>=this.emissionInterval&&(this.emitParticle(),this.lastEmissionTime=o)}for(var s=this.particles.length-1;s>=0;s--){var r=this.particles[s];r.update(t),r.isDead()&&(this.engine.emitters.returnParticle(r),this.particles.splice(s,1))}this.autoDestroy&&!this.active&&0===this.particles.length&&this.engine.emitters.remove(this.id)}},{key:"render",value:function(t){if(this.particles.forEach(function(e){e.render(t)}),"invisible"!==this.shape){switch(t.save(),t.globalAlpha=this.opacity,t.fillStyle=this.color,this.shape){case"circle":t.beginPath(),t.arc(this.x,this.y,this.size/2,0,2*Math.PI),t.fill();break;case"square":t.fillRect(this.x-this.size/2,this.y-this.size/2,this.size,this.size);break;case"diamond":t.beginPath(),t.moveTo(this.x,this.y-this.size/2),t.lineTo(this.x+this.size/2,this.y),t.lineTo(this.x,this.y+this.size/2),t.lineTo(this.x-this.size/2,this.y),t.closePath(),t.fill();break;case"cross":var e=this.size/6;t.fillRect(this.x-this.size/2,this.y-e,this.size,2*e),t.fillRect(this.x-e,this.y-this.size/2,2*e,this.size)}t.restore()}}},{key:"destroy",value:function(){var t=this;this.particles.forEach(function(e){t.engine.emitters.returnParticle(e)}),this.particles=[],this.active=!1}}])}();const be=ve;function xe(t){return xe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},xe(t)}function we(t){return function(t){if(Array.isArray(t))return Me(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||Ae(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ce(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,o,s,r,a=[],l=!0,c=!1;try{if(s=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;l=!1}else for(;!(l=(n=s.call(i)).done)&&(a.push(n.value),a.length!==e);l=!0);}catch(t){c=!0,o=t}finally{try{if(!l&&null!=i.return&&(r=i.return(),Object(r)!==r))return}finally{if(c)throw o}}return a}}(t,e)||Ae(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Se(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=Ae(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return r=t.done,t},e:function(t){a=!0,s=t},f:function(){try{r||null==i.return||i.return()}finally{if(a)throw s}}}}function Ae(t,e){if(t){if("string"==typeof t)return Me(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?Me(t,e):void 0}}function Me(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function ke(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var t,e,i="function"==typeof Symbol?Symbol:{},n=i.iterator||"@@iterator",o=i.toStringTag||"@@toStringTag";function s(i,n,o,s){var l=n&&n.prototype instanceof a?n:a,c=Object.create(l.prototype);return De(c,"_invoke",function(i,n,o){var s,a,l,c=0,h=o||[],u=!1,m={p:0,n:0,v:t,a:y,f:y.bind(t,4),d:function(e,i){return s=e,a=0,l=t,m.n=i,r}};function y(i,n){for(a=i,l=n,e=0;!u&&c&&!o&&e<h.length;e++){var o,s=h[e],y=m.p,p=s[2];i>3?(o=p===n)&&(l=s[(a=s[4])?5:(a=3,3)],s[4]=s[5]=t):s[0]<=y&&((o=i<2&&y<s[1])?(a=0,m.v=n,m.n=s[1]):y<p&&(o=i<3||s[0]>n||n>p)&&(s[4]=i,s[5]=n,m.n=p,a=0))}if(o||i>1)return r;throw u=!0,n}return function(o,h,p){if(c>1)throw TypeError("Generator is already running");for(u&&1===h&&y(h,p),a=h,l=p;(e=a<2?t:l)||!u;){s||(a?a<3?(a>1&&(m.n=-1),y(a,l)):m.n=l:m.v=l);try{if(c=2,s){if(a||(o="next"),e=s[o]){if(!(e=e.call(s,l)))throw TypeError("iterator result is not an object");if(!e.done)return e;l=e.value,a<2&&(a=0)}else 1===a&&(e=s.return)&&e.call(s),a<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),a=1);s=t}else if((e=(u=m.n<0)?l:i.call(n,m))!==r)break}catch(e){s=t,a=1,l=e}finally{c=1}}return{value:e,done:u}}}(i,o,s),!0),c}var r={};function a(){}function l(){}function c(){}e=Object.getPrototypeOf;var h=[][n]?e(e([][n]())):(De(e={},n,function(){return this}),e),u=c.prototype=a.prototype=Object.create(h);function m(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,c):(t.__proto__=c,De(t,o,"GeneratorFunction")),t.prototype=Object.create(u),t}return l.prototype=c,De(u,"constructor",c),De(c,"constructor",l),l.displayName="GeneratorFunction",De(c,o,"GeneratorFunction"),De(u),De(u,o,"Generator"),De(u,n,function(){return this}),De(u,"toString",function(){return"[object Generator]"}),(ke=function(){return{w:s,m}})()}function De(t,e,i,n){var o=Object.defineProperty;try{o({},"",{})}catch(t){o=0}De=function(t,e,i,n){if(e)o?o(t,e,{value:i,enumerable:!n,configurable:!n,writable:!n}):t[e]=i;else{var s=function(e,i){De(t,e,function(t){return this._invoke(e,i,t)})};s("next",0),s("throw",1),s("return",2)}},De(t,e,i,n)}function Ie(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function Be(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Ie(Object(i),!0).forEach(function(e){Pe(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Ie(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function Pe(t,e,i){return(e=Le(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function Ve(t,e,i,n,o,s,r){try{var a=t[s](r),l=a.value}catch(t){return void i(t)}a.done?e(l):Promise.resolve(l).then(n,o)}function Te(t){return function(){var e=this,i=arguments;return new Promise(function(n,o){var s=t.apply(e,i);function r(t){Ve(s,n,o,r,a,"next",t)}function a(t){Ve(s,n,o,r,a,"throw",t)}r(void 0)})}}function Ee(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Le(n.key),n)}}function Le(t){var e=function(t,e){if("object"!=xe(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=xe(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==xe(e)?e:e+""}var Fe=function(){return function(t,e,i){return e&&Ee(t.prototype,e),i&&Ee(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(e){if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.assets=new Map,this.workerID=e,this.isWorker="undefined"!=typeof importScripts&&"undefined"!=typeof DedicatedWorkerGlobalScope,this.instances=new Map,this.assetInstances=new Map,this.listener=null,this.masterVolume=1,this.nextInstanceId=0,!this.isWorker)try{this.context=new(window.AudioContext||window.webkitAudioContext),this.listener=this.context.listener,this._initSpatialAudio()}catch(t){this.error(t)}},[{key:"load",value:(e=Te(ke().m(function t(e,i,n){var o=this;return ke().w(function(t){for(;;)switch(t.n){case 0:if(!this.isWorker){t.n=1;break}return this._sendWorker({action:"audio_load",args:[e,i,n]}),t.a(2);case 1:return t.a(2,new Promise(function(){var t=Te(ke().m(function t(s,r){var a,l,c,h,u;return ke().w(function(t){for(;;)switch(t.p=t.n){case 0:return t.p=0,t.n=1,fetch(i,Be({mode:"cors"},n.fetch||{}));case 1:return a=t.v,t.n=2,a.arrayBuffer();case 2:return l=t.v,t.n=3,o.context.decodeAudioData(l);case 3:c=t.v,h={id:e,asset:c,config:Be(Be({},n),{},{volume:n.volume||1,loop:n.loop||!1,autoplay:n.autoplay||!1,muted:n.muted||!1})},o.assets.set(e,h),o.isWorker?o._sendWorker(Be(Be({},h),{},{asset:null,type:"pixalo_audio_loaded"})):null!=o&&o.worker&&o.worker.postMessage(Be(Be({},h),{},{asset:null,type:"pixalo_audio_loaded"})),s({asset:c,config:h.config}),t.n=5;break;case 4:t.p=4,u=t.v,r(new Error("Failed to load audio: ".concat(u.message)));case 5:return t.a(2)}},t,null,[[0,4]])}));return function(e,i){return t.apply(this,arguments)}}()))}},t,this)})),function(t,i,n){return e.apply(this,arguments)})},{key:"play",value:(t=Te(ke().m(function t(e){var i,n=this,o=arguments;return ke().w(function(t){for(;;)switch(t.n){case 0:if(i=o.length>1&&void 0!==o[1]?o[1]:{},!this.isWorker){t.n=1;break}return this._sendWorker({action:"audio_play",args:[e,i]}),t.a(2);case 1:return t.a(2,new Promise(function(t,o){try{var s=n.assets.get(e);if(!s)return void o(new Error("Audio asset with id '".concat(e,"' not found")));"suspended"===n.context.state&&n.context.resume();var r=n._generateInstanceId(),a=n.context.createBufferSource(),l=n.context.createGain();a.buffer=s.asset;var c=Be(Be({},s.config),i);l.gain.value=c.muted?0:c.volume*n.masterVolume,a.loop=c.loop;var h=n._setupAudioChain(a,l,c.spatial),u={instanceId:r,assetId:e,source:a,gainNode:l,spatialNodes:h,spatialConfig:c.spatial||null,startTime:n.context.currentTime,pauseTime:0,duration:s.asset.duration,isPlaying:!0,isPaused:!1,config:c};n.instances.set(r,u),n.assetInstances.has(e)||n.assetInstances.set(e,new Set),n.assetInstances.get(e).add(r),a.onended=function(){n.instances.delete(r),n.assetInstances.has(e)&&(n.assetInstances.get(e).delete(r),0===n.assetInstances.get(e).size&&n.assetInstances.delete(e))},a.start(0),t({instanceId:r,assetId:e,source:a,gainNode:l,spatialNodes:h})}catch(t){n.error("Failed to play audio '".concat(e,"':"),t.message),o(new Error("Failed to play audio: ".concat(t.message)))}}))}},t,this)})),function(e){return t.apply(this,arguments)})},{key:"pause",value:function(t){if(this.isWorker)return this._sendWorker({action:"audio_pause",args:[t]}),this;var e=this.instances.get(t);if(!e){var i,n=Se(this.instances);try{for(n.s();!(i=n.n()).done;){var o=Ce(i.value,2),s=o[0],r=o[1];if(r.assetId===t&&r.isPlaying&&!r.isPaused){e=r,t=s;break}}}catch(t){n.e(t)}finally{n.f()}}if(e&&e.isPlaying&&!e.isPaused){var a=this.getCurrentTime(t);e.pauseTime=a,e.isPlaying=!1,e.isPaused=!0;try{e.source.onended=null,e.source.stop()}catch(t){this.warn("Source already stopped:",t.message)}}else this.warn("No active audio instance found for id '".concat(t,"' or already paused"));return this}},{key:"resume",value:function(t){var e=this;if(this.isWorker)return this._sendWorker({action:"audio_resume",args:[t]}),this;var i=this.instances.get(t),n=t;if(!i){var o=this.assetInstances.get(t);if(o){var s,r=Se(o);try{for(r.s();!(s=r.n()).done;){var a=s.value,l=this.instances.get(a);if(l&&l.isPaused){i=l,n=a;break}}}catch(t){r.e(t)}finally{r.f()}}}if(i&&i.isPaused){var c=this.assets.get(i.assetId);if(!c)return this.warn("Asset not found for instance '".concat(n,"'")),this;"suspended"===this.context.state&&this.context.resume();var h=this.context.createBufferSource(),u=this.context.createGain();h.buffer=c.asset,h.loop=i.config.loop,u.gain.value=i.config.volume*this.masterVolume;var m=this._setupAudioChain(h,u,i.spatialConfig);i.source=h,i.gainNode=u,i.spatialNodes=m,i.startTime=this.context.currentTime-i.pauseTime,i.isPlaying=!0,i.isPaused=!1,h.onended=function(){e.instances.delete(n),e.assetInstances.has(i.assetId)&&(e.assetInstances.get(i.assetId).delete(n),0===e.assetInstances.get(i.assetId).size&&e.assetInstances.delete(i.assetId))},c.asset.duration-i.pauseTime>0?h.start(0,i.pauseTime):h.start(0,0)}else this.warn("No paused audio instance found for id '".concat(t,"'"));return this}},{key:"stop",value:function(t){if(this.isWorker)return this._sendWorker({action:"audio_stop",args:[t]}),this;var e=this.instances.get(t),i=t;if(!e){var n,o=Se(this.instances);try{for(o.s();!(n=o.n()).done;){var s=Ce(n.value,2),r=s[0],a=s[1];if(a.assetId===t){e=a,i=r;break}}}catch(t){o.e(t)}finally{o.f()}}if(e=this.instances.get(i)){try{e.source.onended=null,e.source.stop()}catch(t){this.warn("Error stopping source:",t.message)}this.instances.delete(i),this.assetInstances.has(e.assetId)&&(this.assetInstances.get(e.assetId).delete(i),0===this.assetInstances.get(e.assetId).size&&this.assetInstances.delete(e.assetId))}return this}},{key:"stopAsset",value:function(t){var e=this;if(this.isWorker)return this._sendWorker({action:"audio_stopAsset",args:[t]}),this;var i=this.assetInstances.get(t);i&&Array.from(i).forEach(function(t){return e.stop(t)});return this}},{key:"setVolume",value:function(t,e){if(this.isWorker)return this._sendWorker({action:"audio_setVolume",args:[t,e]}),this;var i=this.instances.get(t);if(i)i.gainNode.gain.value=e*this.masterVolume,i.config.volume=e;else{var n,o=Se(this.instances.values());try{for(o.s();!(n=o.n()).done;){var s=n.value;if(s.assetId===t){s.gainNode.gain.value=e*this.masterVolume,s.config.volume=e;break}}}catch(t){o.e(t)}finally{o.f()}}return this}},{key:"setAssetVolume",value:function(t,e){var i=this;if(this.isWorker)return this._sendWorker({action:"audio_setAssetVolume",args:[t,e]}),this;this.instances.forEach(function(n){n.assetId===t&&(n.gainNode.gain.value=e*i.masterVolume,n.config.volume=e)});var n=this.assets.get(t);return n&&(n.config.volume=e),this}},{key:"setMasterVolume",value:function(t){var e=this;return this.isWorker?(this._sendWorker({action:"audio_setMasterVolume",args:[t]}),this):(this.masterVolume=Math.max(0,Math.min(1,t)),this.instances.forEach(function(t){t.config.muted||(t.gainNode.gain.value=t.config.volume*e.masterVolume)}),this)}},{key:"setListenerPosition",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return this.isWorker?(this._sendWorker({action:"audio_setListenerPosition",args:[t,e,i]}),this):(this.listener.positionX?(this.listener.positionX.value=t,this.listener.positionY.value=e,this.listener.positionZ.value=i):this.listener.setPosition(t,e,i),this)}},{key:"setListenerOrientation",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;return this.isWorker?(this._sendWorker({action:"audio_setListenerOrientation",args:[t,e,i,n,o,s]}),this):(this.listener.forwardX?(this.listener.forwardX.value=t,this.listener.forwardY.value=e,this.listener.forwardZ.value=i,this.listener.upX.value=n,this.listener.upY.value=o,this.listener.upZ.value=s):this.listener.setOrientation(t,e,i,n,o,s),this)}},{key:"setSpatialPosition",value:function(t,e,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(this.isWorker)return this._sendWorker({action:"audio_setSpatialPosition",args:[t,e,i,n]}),this;var o=this.instances.get(t);if(!o){var s,r=Se(this.instances.values());try{for(r.s();!(s=r.n()).done;){var a=s.value;if(a.assetId===t&&a.spatialNodes&&a.spatialNodes.panner){o=a;break}}}catch(t){r.e(t)}finally{r.f()}}return o&&o.spatialNodes&&o.spatialNodes.panner?o.spatialNodes.panner.positionX?(o.spatialNodes.panner.positionX.value=e,o.spatialNodes.panner.positionY.value=i,o.spatialNodes.panner.positionZ.value=n):o.spatialNodes.panner.setPosition(e,i,n):this.warn("No spatial audio found for id '".concat(t,"'")),this}},{key:"setSpatialOrientation",value:function(t,e,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(this.isWorker)return this._sendWorker({action:"audio_setSpatialOrientation",args:[t,e,i,n]}),this;var o=this.instances.get(t);if(!o){var s,r=Se(this.instances.values());try{for(r.s();!(s=r.n()).done;){var a=s.value;if(a.assetId===t&&a.spatialNodes&&a.spatialNodes.panner){o=a;break}}}catch(t){r.e(t)}finally{r.f()}}return o&&o.spatialNodes&&o.spatialNodes.panner?o.spatialNodes.panner.orientationX?(o.spatialNodes.panner.orientationX.value=e,o.spatialNodes.panner.orientationY.value=i,o.spatialNodes.panner.orientationZ.value=n):o.spatialNodes.panner.setOrientation(e,i,n):this.warn("No spatial audio found for id '".concat(t,"'")),this}},{key:"playSpatial",value:function(t,e,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},s=Be(Be({},o),{},{spatial:Be({position:{x:e,y:i,z:n},panningModel:"HRTF",distanceModel:"inverse",refDistance:1,maxDistance:1e4,rolloffFactor:1},o.spatial)});return this.play(t,s)}},{key:"updateSpatial",value:function(t,e){return e.position&&this.setSpatialPosition(t,e.position.x,e.position.y,e.position.z),e.orientation&&this.setSpatialOrientation(t,e.orientation.x,e.orientation.y,e.orientation.z),void 0!==e.volume&&this.setVolume(t,e.volume),this}},{key:"isPlaying",value:function(t){if(this.isWorker)return this._sendWorker({action:"audio_isPlaying",args:[t]}),!1;var e=this.instances.get(t);if(!e){var i,n=Se(this.instances.values());try{for(n.s();!(i=n.n()).done;){var o=i.value;if(o.assetId===t&&o.isPlaying)return!0}}catch(t){n.e(t)}finally{n.f()}return!1}return!!e&&e.isPlaying}},{key:"getAssetInstances",value:function(t){if(this.isWorker)return this._sendWorker({action:"audio_getAssetInstances",args:[t]}),[];var e=[],i=this.assetInstances.get(t);if(i){var n,o=Se(i);try{for(o.s();!(n=o.n()).done;){var s=n.value,r=this.instances.get(s);r&&e.push({instanceId:s,isPlaying:r.isPlaying,isPaused:r.isPaused,currentTime:this.getCurrentTime(s)})}}catch(t){o.e(t)}finally{o.f()}}return e}},{key:"getDuration",value:function(t){if(this.isWorker)return this._sendWorker({action:"audio_getDuration",args:[t]}),0;var e=this.assets.get(t);return e?e.asset.duration:0}},{key:"getCurrentTime",value:function(t){if(this.isWorker)return this._sendWorker({action:"audio_getCurrentTime",args:[t]}),0;var e=this.instances.get(t);if(!e){var i,n=Se(this.instances.values());try{for(n.s();!(i=n.n()).done;){var o=i.value;if(o.assetId===t){e=o;break}}}catch(t){n.e(t)}finally{n.f()}}if(!e)return 0;if(e.isPaused)return e.pauseTime;if(e.isPlaying){var s=this.context.currentTime-e.startTime;return Math.min(s,e.duration)}return 0}},{key:"getDistance",value:function(t){var e=this.instances.get(t);if(!e){var i,n=Se(this.instances.values());try{for(n.s();!(i=n.n()).done;){var o=i.value;if(o.assetId===t&&o.spatialNodes&&o.spatialNodes.panner){e=o;break}}}catch(t){n.e(t)}finally{n.f()}}if(!e||!e.spatialNodes||!e.spatialNodes.panner)return null;var s,r,a,l,c,h,u=e.spatialNodes.panner,m=this.listener;return u.positionX?(s=u.positionX.value,r=u.positionY.value,a=u.positionZ.value,l=m.positionX.value,c=m.positionY.value,h=m.positionZ.value,Math.sqrt(Math.pow(s-l,2)+Math.pow(r-c,2)+Math.pow(a-h,2))):null}},{key:"muteAll",value:function(){return this.isWorker?(this._sendWorker({action:"audio_muteAll",args:[]}),this):(this.instances.forEach(function(t){t.gainNode.gain.value=0}),this)}},{key:"unmuteAll",value:function(){var t=this;return this.isWorker?(this._sendWorker({action:"audio_unmuteAll",args:[]}),this):(this.instances.forEach(function(e){e.gainNode.gain.value=e.config.volume*t.masterVolume}),this)}},{key:"pauseAll",value:function(){var t=this;return this.isWorker?(this._sendWorker({action:"audio_pauseAll",args:[]}),this):(Array.from(this.instances.keys()).filter(function(e){var i=t.instances.get(e);return i.isPlaying&&!i.isPaused}).forEach(function(e){return t.pause(e)}),this)}},{key:"resumeAll",value:function(){var t=this;return this.isWorker?(this._sendWorker({action:"audio_resumeAll",args:[]}),this):(Array.from(this.instances.keys()).filter(function(e){return t.instances.get(e).isPaused}).forEach(function(e){return t.resume(e)}),this)}},{key:"stopAll",value:function(){return this.isWorker?(this._sendWorker({action:"audio_stopAll",args:[]}),this):(this.instances.forEach(function(t){try{t.source.stop()}catch(t){}}),this.instances.clear(),this.assetInstances.clear(),this)}},{key:"cleanup",value:function(){return this.isWorker?(this._sendWorker({action:"audio_cleanup",args:[]}),this):(this.stopAll(),this.assets.clear(),this.context&&"closed"!==this.context.state&&this.context.close(),this.instances.clear(),this.listener=null,this.masterVolume=1,this.nextInstanceId=0,this)}},{key:"warn",value:function(){for(var t,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return(t=console).warn.apply(t,["%c[AudioManager WARN]","color: #ff9800;"].concat(i)),this}},{key:"error",value:function(){for(var t,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return(t=console).error.apply(t,["%c[AudioManager ERROR]","color: #f44336;"].concat(i)),this}},{key:"_handleWorker",value:function(t){var e,i=t.data,n=null!==(e=null==i?void 0:i.action)&&void 0!==e?e:"";if(n.startsWith("audio_")){var o=n.replace("audio_","");"function"==typeof this[o]&&this[o].apply(this,we(i.args))}}},{key:"_sendWorker",value:function(t){postMessage(Be({wid:this.workerID},t))}},{key:"_initSpatialAudio",value:function(){this.listener.forwardX?(this.listener.forwardX.value=0,this.listener.forwardY.value=0,this.listener.forwardZ.value=-1,this.listener.upX.value=0,this.listener.upY.value=1,this.listener.upZ.value=0,this.listener.positionX.value=0,this.listener.positionY.value=0,this.listener.positionZ.value=0):(this.listener.setOrientation(0,0,-1,0,1,0),this.listener.setPosition(0,0,0))}},{key:"_generateInstanceId",value:function(){return"instance_".concat(this.nextInstanceId++,"_").concat(performance.now().toString(36))}},{key:"_setupAudioChain",value:function(t,e,i){if(i){var n=this._createSpatialNodes(i);return t.connect(e),e.connect(n.panner),n.panner.connect(this.context.destination),n}return t.connect(e),e.connect(this.context.destination),null}},{key:"_createSpatialNodes",value:function(t){var e=this.context.createPanner();e.panningModel=t.panningModel||"HRTF",e.distanceModel=t.distanceModel||"inverse",e.refDistance=t.refDistance||1,e.maxDistance=t.maxDistance||1e4,e.rolloffFactor=t.rolloffFactor||1,e.coneInnerAngle=t.coneInnerAngle||360,e.coneOuterAngle=t.coneOuterAngle||360,e.coneOuterGain=t.coneOuterGain||0;var i=t.position||{x:0,y:0,z:0};e.positionX?(e.positionX.value=i.x,e.positionY.value=i.y,e.positionZ.value=i.z):e.setPosition(i.x,i.y,i.z);var n=t.orientation||{x:1,y:0,z:0};return e.orientationX?(e.orientationX.value=n.x,e.orientationY.value=n.y,e.orientationZ.value=n.z):e.setOrientation(n.x,n.y,n.z),{panner:e}}}]);var t,e}();const Ge=Fe;function Re(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,o,s,r,a=[],l=!0,c=!1;try{if(s=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;l=!1}else for(;!(l=(n=s.call(i)).done)&&(a.push(n.value),a.length!==e);l=!0);}catch(t){c=!0,o=t}finally{try{if(!l&&null!=i.return&&(r=i.return(),Object(r)!==r))return}finally{if(c)throw o}}return a}}(t,e)||Oe(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Je(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=Oe(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return r=t.done,t},e:function(t){a=!0,s=t},f:function(){try{r||null==i.return||i.return()}finally{if(a)throw s}}}}function Oe(t,e){if(t){if("string"==typeof t)return je(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?je(t,e):void 0}}function je(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function ze(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var t,e,i="function"==typeof Symbol?Symbol:{},n=i.iterator||"@@iterator",o=i.toStringTag||"@@toStringTag";function s(i,n,o,s){var l=n&&n.prototype instanceof a?n:a,c=Object.create(l.prototype);return Xe(c,"_invoke",function(i,n,o){var s,a,l,c=0,h=o||[],u=!1,m={p:0,n:0,v:t,a:y,f:y.bind(t,4),d:function(e,i){return s=e,a=0,l=t,m.n=i,r}};function y(i,n){for(a=i,l=n,e=0;!u&&c&&!o&&e<h.length;e++){var o,s=h[e],y=m.p,p=s[2];i>3?(o=p===n)&&(l=s[(a=s[4])?5:(a=3,3)],s[4]=s[5]=t):s[0]<=y&&((o=i<2&&y<s[1])?(a=0,m.v=n,m.n=s[1]):y<p&&(o=i<3||s[0]>n||n>p)&&(s[4]=i,s[5]=n,m.n=p,a=0))}if(o||i>1)return r;throw u=!0,n}return function(o,h,p){if(c>1)throw TypeError("Generator is already running");for(u&&1===h&&y(h,p),a=h,l=p;(e=a<2?t:l)||!u;){s||(a?a<3?(a>1&&(m.n=-1),y(a,l)):m.n=l:m.v=l);try{if(c=2,s){if(a||(o="next"),e=s[o]){if(!(e=e.call(s,l)))throw TypeError("iterator result is not an object");if(!e.done)return e;l=e.value,a<2&&(a=0)}else 1===a&&(e=s.return)&&e.call(s),a<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),a=1);s=t}else if((e=(u=m.n<0)?l:i.call(n,m))!==r)break}catch(e){s=t,a=1,l=e}finally{c=1}}return{value:e,done:u}}}(i,o,s),!0),c}var r={};function a(){}function l(){}function c(){}e=Object.getPrototypeOf;var h=[][n]?e(e([][n]())):(Xe(e={},n,function(){return this}),e),u=c.prototype=a.prototype=Object.create(h);function m(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,c):(t.__proto__=c,Xe(t,o,"GeneratorFunction")),t.prototype=Object.create(u),t}return l.prototype=c,Xe(u,"constructor",c),Xe(c,"constructor",l),l.displayName="GeneratorFunction",Xe(c,o,"GeneratorFunction"),Xe(u),Xe(u,o,"Generator"),Xe(u,n,function(){return this}),Xe(u,"toString",function(){return"[object Generator]"}),(ze=function(){return{w:s,m}})()}function Xe(t,e,i,n){var o=Object.defineProperty;try{o({},"",{})}catch(t){o=0}Xe=function(t,e,i,n){if(e)o?o(t,e,{value:i,enumerable:!n,configurable:!n,writable:!n}):t[e]=i;else{var s=function(e,i){Xe(t,e,function(t){return this._invoke(e,i,t)})};s("next",0),s("throw",1),s("return",2)}},Xe(t,e,i,n)}function Ne(t,e,i,n,o,s,r){try{var a=t[s](r),l=a.value}catch(t){return void i(t)}a.done?e(l):Promise.resolve(l).then(n,o)}function We(t){return function(){var e=this,i=arguments;return new Promise(function(n,o){var s=t.apply(e,i);function r(t){Ne(s,n,o,r,a,"next",t)}function a(t){Ne(s,n,o,r,a,"throw",t)}r(void 0)})}}function Ye(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function qe(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Ye(Object(i),!0).forEach(function(e){Ue(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Ye(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function Ue(t,e,i){return(e=He(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function Ke(t){return Ke="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Ke(t)}function Ze(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,He(n.key),n)}}function He(t){var e=function(t,e){if("object"!=Ke(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=Ke(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==Ke(e)?e:e+""}function Qe(t,e,i){return e=ti(e),function(t,e){if(e&&("object"==Ke(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(t,$e()?Reflect.construct(e,i||[],ti(t).constructor):e.apply(t,i))}function $e(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(t){}return($e=function(){return!!t})()}function ti(t){return ti=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},ti(t)}function ei(t,e){return ei=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},ei(t,e)}function ii(t,e){(function(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")})(t,e),e.add(t)}function ni(t,e,i){if("function"==typeof t?t===e:t.has(e))return arguments.length<3?e:i;throw new TypeError("Private element is not present on this object")}var oi=new WeakSet,si=function(t){function e(t){var i,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),ii(i=Qe(this,e),oi),t=t||{},n.worker="undefined"!=typeof DedicatedWorkerGlobalScope,"string"==typeof t||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement){var o;i.canvas=e._handleCanvasSelector(t,(null===(o=n)||void 0===o?void 0:o.appendTo)||null)}else{if("object"!==Ke(t))throw new Error("Invalid selector");n=qe(qe({},t),n)}return i.eventListeners=new Map,i.assets=new Map,i.timers=new Map,i._data=new Map,ni(oi,i,ri).call(i,n),i}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&ei(t,e)}(e,t),function(t,e,i){return e&&Ze(t.prototype,e),i&&Ze(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(e,[{key:"_createWindow",value:function(){var t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:null)||{innerWidth:window.innerWidth,innerHeight:window.innerHeight,outerWidth:window.outerWidth,outerHeight:window.outerHeight,devicePixelRatio:window.devicePixelRatio},e=t.innerWidth,i=t.outerWidth,n=t.innerHeight,o=t.outerHeight,s=t.devicePixelRatio,r=Math.round(i/e*100),a=o-n;this.window={zoom:r,width:Math.round(100*i/r),height:o-a,outerWidth:i,outerHeight:o,innerWidth:e,innerHeight:n,devicePixelRatio:s}}},{key:"_applyCanvasConfig",value:function(){var t,e=this.config,i=this.canvas,n={attributes:{tabIndex:0,width:e.width*e.quality,height:e.height*e.quality},style:{width:e.width+"px",height:e.height+"px",outline:"none",backgroundColor:e.background,imageRendering:e.imageRendering||(null===(t=i.style)||void 0===t?void 0:t.imageRendering),colorProfile:e.context.colorSpace||"srgb",colorScheme:"normal"}};i.style||(i.style={}),Object.assign(this.canvas,n.attributes),Object.assign(this.canvas.style,n.style),this.workerSend({action:"update_canvas",props:n}),e.resizeTarget&&this.workerSend({action:"set_resize_target",target:e.resizeTarget})}},{key:"_setupEventListeners",value:function(){var t=this;if("undefined"==typeof window||"undefined"==typeof document)return this.config.worker?void this.on("worker_msg",this._workerEventListeners):void this.warn("Browser environment is required. This feature is only available in browser context.");this._windowResizeListener();var e=this.config.resizeTarget;e&&"window"!==e&&"document"!==e?("string"==typeof e&&(e=document.querySelector(e)),this._setupResizeObserver(e)):this._setupResizeObserver(this.canvas),document.addEventListener("visibilitychange",function(){var e=!document.hidden;t.config.autoStartStop&&(e?t.start():t.stop()),t.trigger("visibility",e)}),this.canvas.addEventListener("click",this._handleClick.bind(this)),this.canvas.addEventListener("contextmenu",this._handleRightClick.bind(this)),this.canvas.addEventListener("mousemove",this._handleMouseMove.bind(this)),this.canvas.addEventListener("mousedown",this._handleMouseDown.bind(this)),this.canvas.addEventListener("mouseup",this._handleMouseUp.bind(this)),this.canvas.addEventListener("touchstart",this._handleTouchStart.bind(this)),this.canvas.addEventListener("touchmove",this._handleTouchMove.bind(this)),this.canvas.addEventListener("touchend",this._handleTouchEnd.bind(this)),this.canvas.addEventListener("touchcancel",this._handleTouchCancel.bind(this)),this.canvas.addEventListener("wheel",this._handleWheel.bind(this),{passive:!1}),this.canvas.addEventListener("keydown",this._handleKeyDown.bind(this)),this.canvas.addEventListener("keyup",this._handleKeyUp.bind(this))}},{key:"_workerEventListeners",value:function(t){var e=t.data;if("canvas_event"!==(null==e?void 0:e.action)){if("visibilitychange"===(null==e?void 0:e.action)){var i=!e.hidden;return this.config.autoStartStop&&(i?this.start():this.stop()),void this.trigger("visibility",!e.hidden)}"boundingClientRect"===(null==e?void 0:e.action)&&(this.canvas.getBoundingClientRect=function(){return e.rect}),"resizedTarget"===(null==e?void 0:e.action)&&("object"===Ke(e.window)&&(this._createWindow(e.window),e.width=this.window.width,e.height=this.window.height),this.config.autoResize?this.resize(e.width,e.height,!0,this.config.resizeTarget):this.trigger("resize",{width:e.width,height:e.height,target:this.config.resizeTarget}))}else switch(e.event.type){case"click":this._handleClick(e.event);break;case"contextmenu":this._handleRightClick(e.event);break;case"keydown":this._handleKeyDown(e.event);break;case"keyup":this._handleKeyUp(e.event);break;case"mousemove":this._handleMouseMove(e.event);break;case"mousedown":this._handleMouseDown(e.event);break;case"mouseup":this._handleMouseUp(e.event);break;case"touchstart":this._handleTouchStart(e.event);break;case"touchmove":this._handleTouchMove(e.event);break;case"touchend":this._handleTouchEnd(e.event);break;case"touchcancel":this._handleTouchCancel(e.event);break;case"wheel":this._handleWheel(e.event)}}},{key:"workerSend",value:(o=We(ze().m(function t(){var e,i,n,o,s=this,r=arguments;return ze().w(function(t){for(;;)switch(t.n){case 0:if(e=r.length>0&&void 0!==r[0]?r[0]:{},i=r.length>1&&void 0!==r[1]?r[1]:null,n=r.length>2&&void 0!==r[2]?r[2]:null,this.config.worker){t.n=1;break}return t.a(2,this);case 1:return postMessage(qe({wid:this.config.worker},e)),i&&"function"==typeof n&&(o=function(t){t.data.action===i&&(n(t),s.off("worker_msg",o))},this.on("worker_msg",o)),t.a(2,this)}},t,this)})),function(){return o.apply(this,arguments)})},{key:"quality",value:function(t){return void 0===t?this.config.quality:(t=Number(t.toFixed(2)),this.config.quality=t,this._applyQuality(t),this)}},{key:"_applyQuality",value:function(t){this.canvas.width=this.baseWidth*t,this.canvas.height=this.baseHeight*t,this.canvas.style.width=this.baseWidth+"px",this.canvas.style.height=this.baseHeight+"px",this.ctx.scale(t,t)}},{key:"on",value:function(t,e){var i=this;if(Array.isArray(t))return t.forEach(function(t){i.on(t,e)}),this;if("object"===Ke(t)){for(var n in t)this.on(n,t[n]);return this}return this.eventListeners.has(t)||this.eventListeners.set(t,new Set),this.eventListeners.get(t).add(e),this}},{key:"one",value:function(t,e){var i=this;if(Array.isArray(t))return t.forEach(function(t){i.one(t,e)}),this;if("object"===Ke(t)){for(var n in t)this.one(n,t[n]);return this}var o=function(n){e.call(i,n),i.off(t,o)};return this.on(t,o),this}},{key:"trigger",value:function(t){for(var e=this,i=arguments.length,n=new Array(i>1?i-1:0),o=1;o<i;o++)n[o-1]=arguments[o];if(Array.isArray(t))return t.forEach(function(t){e.trigger(t,n)}),this;if(!this.eventListeners.has(t))return this;var s,r=Je(this.eventListeners.get(t));try{for(r.s();!(s=r.n()).done;){s.value.apply(this,n)}}catch(t){r.e(t)}finally{r.f()}return this}},{key:"off",value:function(t,e){var i=this;return Array.isArray(t)?(t.forEach(function(t){return i.off(t,e)}),this):(this.eventListeners.has(t)&&this.eventListeners.get(t).delete(e),this)}},{key:"timer",value:function(t,e){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=Symbol(),o={callback:t,delay:e,repeat:i,lastTime:performance.now(),accumulated:0,isRunning:!0};return this.timers.set(n,o),n}},{key:"timeout",value:function(t,e){return this.timer(t,e,!1)}},{key:"clearTimer",value:function(t){return this.timers.delete(t)}},{key:"updateTimers",value:function(t){var e=this;this.timers.forEach(function(i,n){if(i.isRunning){var o=t-i.lastTime;for(i.accumulated+=o;i.accumulated>=i.delay;){if(i.callback(),!i.repeat){e.clearTimer(n);break}i.accumulated-=i.delay}i.lastTime=t}})}},{key:"delay",value:(n=We(ze().m(function t(e){var i=this;return ze().w(function(t){for(;;)if(0===t.n)return t.a(2,new Promise(function(t){return i.timeout(t,e)}))},t)})),function(t){return n.apply(this,arguments)})},{key:"data",value:function(t,e){return void 0===e?this._data.get(t):(this._data.set(t,e),this)}},{key:"unset",value:function(t){return this._data.delete(t),this}},{key:"addBackground",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.background.add(t,e),this}},{key:"removeBackground",value:function(t){return this.background.remove(t),this}},{key:"updateBackground",value:function(t,e){return this.background.update(t,e),this}},{key:"clearBackgrounds",value:function(){return this.background.clear(),this}},{key:"getBackground",value:function(t){return this.background.get(t),this}},{key:"setBackgroundOrder",value:function(t,e){return this.background.setOrder(t,e),this}},{key:"setBackgroundVisible",value:function(t,e){return this.background.setVisible(t,e),this}},{key:"enableGrid",value:function(){return this.gridEnabled=!0,this}},{key:"disableGrid",value:function(){return this.gridEnabled=!1,this}},{key:"toggleGrid",value:function(){return this.gridEnabled=!this.gridEnabled,this}},{key:"setGridSize",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t;return this.grid.setSize(t,e),this}},{key:"setGridColors",value:function(t,e){return this.grid.setColors(t,e),this}},{key:"setGridLineWidth",value:function(t,e){return this.grid.setLineWidth(t,e),this}},{key:"setMajorGrid",value:function(t,e,i){return this.grid.setMajorGrid(t,e,i),this}},{key:"setGridBounds",value:function(t){return this.grid.setBounds(t),this}},{key:"setGridOrigin",value:function(t,e){return this.grid.setOrigin(t,e),this}},{key:"setGridVisibilityRange",value:function(t,e){return this.grid.setVisibilityRange(t,e),this}},{key:"snapToGrid",value:function(t,e){return this.grid.snapToGrid(t,e)}},{key:"getGridCell",value:function(t,e){return this.grid.getGridCell(t,e)}},{key:"cellToWorld",value:function(t,e){return this.grid.cellToWorld(t,e)}},{key:"startLoop",value:function(){this.running=!0,requestAnimationFrame(this.loop.bind(this))}},{key:"loop",value:function(t){if(this.running){var e=1e3/this.config.fps,i=t-this.lastTime;if(i=Math.min(i,this.maxDeltaTime),this.debugger.active){this.debugger.frameCount++;var n=t,o=n-this.debugger.lastFpsUpdate;if(o>=1e3){var s=Math.round(1e3*this.debugger.frameCount/o),r=this.config.fps,a=Math.min(Math.round(s/r*100),100);this.debugger.fps={target:r,actual:Math.min(s,r),ratio:a},this.debugger.frameCount=0,this.debugger.lastFpsUpdate=n}}i>=e&&(this.deltaTime=i,this.clear(),this.updateTimers(t),this.update(i),this.render(),this.lastTime=t-i%e),requestAnimationFrame(this.loop.bind(this))}}},{key:"update",value:function(t){this.camera.update(),this.background._updateLayers(t),this.tileMap.running&&this.tileMap.update();var e,i=Je(this.entities);try{for(i.s();!(e=i.n()).done;){var n=Re(e.value,2),o=(n[0],n[1]);"function"==typeof o.update&&o.update(t)}}catch(t){i.e(t)}finally{i.f()}if(this.physicsEnabled&&this.physics.update(t),this.collisionEnabled&&!this.physicsEnabled){var s=Array.from(this.entities.values()).filter(function(t){var e;return null===(e=t.collision)||void 0===e?void 0:e.enabled});this.collision.updateCollisions(s)}this.emitters.update(t),this.trigger("update",t)}},{key:"render",value:function(){var t=this;this.clear(),this.ctx.save(),this.ctx.scale(this.config.quality,this.config.quality),this.camera.apply(),this.trigger("beforeRender",this.ctx),this.background._renderLayers(this.ctx,!1),this.tileMap.running&&this.tileMap._renderMap(),Array.from(this.entities.values()).sort(function(t,e){return t.zIndex-e.zIndex}).forEach(function(e){"function"==typeof e.render&&(t.ctx.save(),e.render(t.ctx),t.ctx.restore())}),this.trigger("render",this.ctx),this.emitters.render(this.ctx),this.background._renderLayers(this.ctx,!0),this.gridEnabled&&this.grid.render(this.ctx),this.debugger.render(this.ctx),this.trigger("afterRender",this.ctx),this.ctx.restore(),this.debugger.renderPanel()}},{key:"start",value:function(){return this.running||(this.timers.forEach(function(t){t.isRunning=!0,t.lastTime=performance.now()}),this.audio.resumeAll(),this.startLoop(),this.trigger("start")),this}},{key:"stop",value:function(){return this.running=!1,this.pressedKeys.clear(),this.timers.forEach(function(t){t.isRunning=!1}),this.audio.pauseAll(),this.trigger("stop"),this}},{key:"clear",value:function(){this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle=this.config.background,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}},{key:"reset",value:function(){return this.trigger("reset"),this.stop(),this.pressedKeys.clear(),this.entities.clear(),this.eventListeners.clear(),this.timers.clear(),this.assets.clear(),this.collision.reset(),this.audio.cleanup(),this.camera.reset(),this.background.clear(),this.emitters.clear(),this.physics.reset(),this.tileMap.reset(),this.draggedEntity=null,this.draggedEntities.clear(),this.hoveredEntity=null,this.animations={},this.lastTime=0,this.debugger.clearItems(),this.gridEnabled=Boolean(this.config.grid),this.physicsEnabled=Boolean(this.config.physics),this.collisionEnabled=Boolean(this.config.collision),this.background=new lt(this),this.camera=new nt(this,this.config.camera),this.grid=new yt(this,this.config.grid||{}),this.physics=new qt(this,this.config.physics),this.collision=new y,this.tileMap=new se(this),this.emitters=new be(this),this.clear(),this._applyQuality(this.config.quality),this._applyCanvasConfig(),this}},{key:"enableDebugger",value:function(){return this.debugger.enableDebugger()}},{key:"disableDebugger",value:function(){return this.debugger.disableDebugger()}},{key:"log",value:function(){for(var t,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return this.debugger&&this.debugger.active&&(t=console).log.apply(t,["%c[Pixalo LOG]","color: #2196f3;"].concat(i)),this}},{key:"info",value:function(){for(var t,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return this.debugger&&this.debugger.active&&(t=console).info.apply(t,["%c[Pixalo INFO]","color: #4491F8;"].concat(i)),this}},{key:"warn",value:function(){for(var t,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return this.debugger&&this.debugger.active&&(t=console).warn.apply(t,["%c[Pixalo WARN]","color: #ff9800;"].concat(i)),this}},{key:"error",value:function(){for(var t,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return this.debugger&&this.debugger.active&&(t=console).error.apply(t,["%c[Pixalo ERROR]","color: #f44336;"].concat(i)),this}},{key:"loadAsset",value:(i=We(ze().m(function t(e,i,n){var o,s=this,r=arguments;return ze().w(function(t){for(;;)switch(t.n){case 0:if(o=r.length>3&&void 0!==r[3]?r[3]:{},e&&i&&n){t.n=1;break}return t.a(2,Promise.reject(new Error("Invalid parameters for Assets.load")));case 1:if(!this.assets.has(i)){t.n=2;break}return t.a(2,Promise.resolve(this.assets.get(i)));case 2:return t.a(2,new Promise(function(){var t=We(ze().m(function t(r,a){var l,c,h,u,m,y,p,d,f,_,v,g,b,x,w,C,S,A,M,k,D,I,B;return ze().w(function(t){for(;;)switch(t.p=t.n){case 0:D=e.toLowerCase(),t.n="image"===D||"tiles"===D?1:"spritesheet"===D?8:"audio"===D?18:19;break;case 1:return t.p=1,t.n=2,fetch(n);case 2:if((c=t.v).ok){t.n=3;break}throw new Error("Failed to fetch image: ".concat(c.statusText));case 3:return t.n=4,c.blob();case 4:return h=t.v,u=qe({colorSpaceConversion:"default",imageOrientation:"from-image",premultiplyAlpha:"default"},o.bitmap||{}),t.n=5,createImageBitmap(h,u);case 5:if(l=t.v,"tiles"===e.toLowerCase())for(o.tileSize||(s.warn("No tileSize specified for tiles"),o.tileSize=32),o.tiles||(s.warn("No tiles configuration specified for tiles"),o.tiles={}),o.columns=Math.floor(l.width/o.tileSize),o.rows=Math.floor(l.height/o.tileSize),m=0,y=Object.entries(o.tiles);m<y.length;m++)p=Re(y[m],2),d=p[0],f=p[1],Array.isArray(f)&&(_=Re(f,2),v=_[0],g=_[1],o.tiles[d]={x:v*o.tileSize,y:g*o.tileSize,width:o.tileSize,height:o.tileSize});ni(oi,s,ci).call(s,l,o),s.assets.set(i,{id:i,asset:l,config:o,type:e}),r({asset:l,config:o,type:e}),t.n=7;break;case 6:t.p=6,I=t.v,a(new Error("Failed to load image: ".concat(I.message)));case 7:return t.a(3,20);case 8:return t.p=8,t.n=9,fetch(n);case 9:if((b=t.v).ok){t.n=10;break}throw new Error("Failed to fetch spritesheet: ".concat(b.statusText));case 10:return t.n=11,b.blob();case 11:return x=t.v,t.n=12,createImageBitmap(x,o.bitmap||{});case 12:l=t.v,w=0,C=["columns","rows","width","height"];case 13:if(!(w<C.length)){t.n=15;break}if(S=C[w],o[S]){t.n=14;break}throw s.error("Missing required parameter: ".concat(S)),new Error("Missing required parameter: ".concat(S));case 14:w++,t.n=13;break;case 15:for(o.originOffset=o.originOffset||[0,0],o.margin=o.margin||[0,0],Array.isArray(o.originOffset)&&2===o.originOffset.length||(o.originOffset=[0,0]),Array.isArray(o.margin)&&2===o.margin.length||(o.margin=[0,0]),o.totalFrames=o.columns*o.rows,o.frames=[],A=0;A<o.rows;A++)for(M=0;M<o.columns;M++)o.frames.push({x:o.originOffset[0]+M*(o.width+o.margin[0]),y:o.originOffset[1]+A*(o.height+o.margin[1]),width:o.width,height:o.height});s.assets.set(i,{id:i,asset:l,config:o,type:e}),r({asset:l,config:o,type:e}),t.n=17;break;case 16:t.p=16,B=t.v,a(new Error("Failed to load spritesheet: ".concat(B.message)));case 17:return t.a(3,20);case 18:return s.config.worker?(s.audio.load(i,n,o),k=function(t){"pixalo_audio_loaded"===t.data.type&&(r(),s.off("worker_msg",k))},s.on("worker_msg",k)):s.audio.load(i,n,o).then(r).catch(a),t.a(3,20);case 19:a(new Error("Unsupported asset type: ".concat(e)));case 20:return t.a(2)}},t,null,[[8,16],[1,6]])}));return function(e,i){return t.apply(this,arguments)}}()))}},t,this)})),function(t,e,n){return i.apply(this,arguments)})},{key:"getAsset",value:function(t){return this.assets.get(t)||null}},{key:"deleteAsset",value:function(t){return this.assets.delete(t),this}},{key:"clearAssets",value:function(){return this.assets.clear(),this}},{key:"defineAnimation",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.animations[t]={keyframes:e,options:{duration:i.duration||1e3,repeat:i.repeat||0,easing:i.easing||"linear"}},this}},{key:"append",value:function(t){var e,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t instanceof Bt?t:i instanceof Bt?i:new Bt(t,qe(qe({},i),{},{engine:this}));return this.entities.has(n.id)?(this.error("Entity (".concat(n.id,") exists with this ID")),n):(n.engine=this,this.entities.set(n.id,n),null===(e=n.updatePosition)||void 0===e||e.call(n),this.physicsEnabled&&(n.physics||i.physics)&&this.physics.addEntity(n,n.physics||i.physics),this.debugger.addItem(n.id,n),n)}},{key:"getAllEntities",value:function(){return this.entities}},{key:"getSortedEntitiesByZIndex",value:function(){return Array.from(this.entities.values()).sort(function(t,e){return e.zIndex-t.zIndex})}},{key:"find",value:function(t){return this.entities.get(t)}},{key:"findByClass",value:function(t){return(t=t.trim())?Array.from(this.entities).filter(function(e){return Re(e,2)[1].class.has(t)}).map(function(t){return Re(t,2)[1]}):(this.warn("ClassName is required"),[])}},{key:"isEntity",value:function(t){return t instanceof Bt}},{key:"kill",value:function(t){var e=this.entities.get(t);return!!e&&e.kill()}},{key:"enableCollisions",value:function(){return this.collisionEnabled=!0,this}},{key:"checkCollision",value:function(t,e){return this.collision.detectCollisionDetailed(t,e)}},{key:"checkGroupCollision",value:function(t,e){var i,n=Je(t);try{for(n.s();!(i=n.n()).done;){var o,s=i.value,r=Je(e);try{for(r.s();!(o=r.n()).done;){var a=o.value;if(this.detectCollisionDetailed(s,a))return{entityA:s,entityB:a}}}catch(t){r.e(t)}finally{r.f()}}}catch(t){n.e(t)}finally{n.f()}return!1}},{key:"disableCollisions",value:function(){return this.collisionEnabled=!1,this}},{key:"createEmitter",value:function(t,e){return this.emitters.create(t,e)}},{key:"shot",value:function(){var t=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=i.format,o=void 0===n?"png":n,s=i.quality,r=void 0===s?1:s,a=i.backgroundColor,l=void 0===a?this.config.background:a,c=i.download,h=void 0!==c&&c,u=i.filename,m=void 0===u?"pixalo-screenshot-".concat(Date.now()):u;if(!["png","jpeg","webp"].includes(o.toLowerCase()))return this.error("Invalid format. Supported formats are: png, jpeg, webp");if(r<0||r>1)return this.error("Quality must be between 0 and 1");if(this.config.worker)return new Promise(function(e){t.workerSend(qe({action:"take_screenshot"},i),"screenshot_taken",function(t){return e(qe(qe({},t.data.details),{},{revoke:function(){return URL.revokeObjectURL(v)}}))})});var y=document.createElement("canvas"),p=y.getContext("2d");y.width=this.canvas.width,y.height=this.canvas.height,l&&(p.fillStyle=l,p.fillRect(0,0,y.width,y.height)),p.drawImage(this.canvas,0,0);var d="image/".concat(o.toLowerCase()),f=y.toDataURL(d,r),_=e.dataURLToBlob(f),v=URL.createObjectURL(_);if(h){var g=document.createElement("a");g.download="".concat(m,".").concat(o.toLowerCase()),g.href=f,g.click()}return y.remove(),{dataURL:f,blob:_,blobURL:v,width:y.width,height:y.height,revoke:function(){return URL.revokeObjectURL(v)}}}}]);var i,n,o}(V);function ri(t){return ai.apply(this,arguments)}function ai(){return ai=We(ze().m(function t(e){var i,n,o,s,r=arguments;return ze().w(function(t){for(;;)switch(t.n){case 0:if(o=r.length>1&&void 0!==r[1]&&r[1],null==e||!e.worker||o){t.n=1;break}return t.a(2,ni(oi,this,li).call(this,e));case 1:this._createWindow(null==e?void 0:e.window),s=qe({id:"2d",alpha:!0,colorSpace:"srgb",desynchronized:!0,willReadFrequently:!1},(null==e?void 0:e.context)||{}),this.ctx=this.canvas.getContext(s.id,s),this.config={context:s,worker:e.worker||!1,width:e.width||this.canvas.width||0,height:e.height||this.canvas.height||0,fps:e.fps||60,grid:e.grid||!1,quality:e.quality||this.window.devicePixelRatio,physics:e.physics||{},collision:e.collision||{},background:e.background||"#ffffff",resizeTarget:e.resizeTarget||!1,autoResize:null===(i=e.autoResize)||void 0===i||i,autoStartStop:null===(n=e.autoStartStop)||void 0===n||n},this.baseWidth=this.config.width,this.baseHeight=this.config.height,this.running=!1,this.lastTime=0,this.debugger=new O(this,qe(qe({active:Boolean(e.debugger)},e.debugger||{}),{},{fps:{target:this.config.fps,actual:this.config.fps}})),this.entities=new Map,this.background=new lt(this),this.camera=new nt(this,e.camera),this.gridEnabled=Boolean(e.grid),this.grid=new yt(this,e.grid||{}),this.physicsEnabled=Boolean(e.physics),this.physics=new qt(this,e.physics),this.collisionEnabled=Boolean(e.collision),this.collision=new y,this.tileMap=new se(this),this.emitters=new be(this),this.audio=new Ge(this.config.worker),this.animations={},this.deltaTime=0,this.maxDeltaTime=Math.max(1e3/this.config.fps,16.67),this._applyCanvasConfig(),this.draggedEntity=null,this.draggedEntities=new Map,this.hoveredEntity=null,this.mouseDownEntity=null,this.touchStartEntities=new Map,this._setupEventListeners(),this.trigger("ready");case 2:return t.a(2)}},t,this)})),ai.apply(this,arguments)}function li(t){var e=this;if("undefined"==typeof DedicatedWorkerGlobalScope)throw new Error("Please run Pixalo in the Worker environment.");onmessage=function(t){return e.trigger("worker_msg",t)},onerror=function(t){return e.trigger("worker_err",t)},this.one("worker_msg",function(i){var n=i.data;t.worker=n.wid,t.window=qe(qe({},t.window),n.window),e.canvas=n.canvas,ni(oi,e,ri).call(e,t,!0),e.workerSend({wid:t.worker,action:"ready"}),e.on("worker_msg",e.audio._handleWorker)})}function ci(t,e){if(!e.tileSize)for(var i in e)if(i in t)try{t[i]=e[i]}catch(t){this.warn('Failed to set property "'.concat(i,'" on asset:'),t)}}si.prototype.Bezier=W,si.prototype.Ease=q;const hi=si;var ui;function mi(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=function(t,e){if(t){if("string"==typeof t)return yi(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?yi(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return r=t.done,t},e:function(t){a=!0,s=t},f:function(){try{r||null==i.return||i.return()}finally{if(a)throw s}}}}function yi(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function pi(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function di(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var t,e,i="function"==typeof Symbol?Symbol:{},n=i.iterator||"@@iterator",o=i.toStringTag||"@@toStringTag";function s(i,n,o,s){var l=n&&n.prototype instanceof a?n:a,c=Object.create(l.prototype);return fi(c,"_invoke",function(i,n,o){var s,a,l,c=0,h=o||[],u=!1,m={p:0,n:0,v:t,a:y,f:y.bind(t,4),d:function(e,i){return s=e,a=0,l=t,m.n=i,r}};function y(i,n){for(a=i,l=n,e=0;!u&&c&&!o&&e<h.length;e++){var o,s=h[e],y=m.p,p=s[2];i>3?(o=p===n)&&(l=s[(a=s[4])?5:(a=3,3)],s[4]=s[5]=t):s[0]<=y&&((o=i<2&&y<s[1])?(a=0,m.v=n,m.n=s[1]):y<p&&(o=i<3||s[0]>n||n>p)&&(s[4]=i,s[5]=n,m.n=p,a=0))}if(o||i>1)return r;throw u=!0,n}return function(o,h,p){if(c>1)throw TypeError("Generator is already running");for(u&&1===h&&y(h,p),a=h,l=p;(e=a<2?t:l)||!u;){s||(a?a<3?(a>1&&(m.n=-1),y(a,l)):m.n=l:m.v=l);try{if(c=2,s){if(a||(o="next"),e=s[o]){if(!(e=e.call(s,l)))throw TypeError("iterator result is not an object");if(!e.done)return e;l=e.value,a<2&&(a=0)}else 1===a&&(e=s.return)&&e.call(s),a<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),a=1);s=t}else if((e=(u=m.n<0)?l:i.call(n,m))!==r)break}catch(e){s=t,a=1,l=e}finally{c=1}}return{value:e,done:u}}}(i,o,s),!0),c}var r={};function a(){}function l(){}function c(){}e=Object.getPrototypeOf;var h=[][n]?e(e([][n]())):(fi(e={},n,function(){return this}),e),u=c.prototype=a.prototype=Object.create(h);function m(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,c):(t.__proto__=c,fi(t,o,"GeneratorFunction")),t.prototype=Object.create(u),t}return l.prototype=c,fi(u,"constructor",c),fi(c,"constructor",l),l.displayName="GeneratorFunction",fi(c,o,"GeneratorFunction"),fi(u),fi(u,o,"Generator"),fi(u,n,function(){return this}),fi(u,"toString",function(){return"[object Generator]"}),(di=function(){return{w:s,m}})()}function fi(t,e,i,n){var o=Object.defineProperty;try{o({},"",{})}catch(t){o=0}fi=function(t,e,i,n){if(e)o?o(t,e,{value:i,enumerable:!n,configurable:!n,writable:!n}):t[e]=i;else{var s=function(e,i){fi(t,e,function(t){return this._invoke(e,i,t)})};s("next",0),s("throw",1),s("return",2)}},fi(t,e,i,n)}function _i(t){return _i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_i(t)}function vi(t,e,i,n,o,s,r){try{var a=t[s](r),l=a.value}catch(t){return void i(t)}a.done?e(l):Promise.resolve(l).then(n,o)}function gi(t){return function(){var e=this,i=arguments;return new Promise(function(n,o){var s=t.apply(e,i);function r(t){vi(s,n,o,r,a,"next",t)}function a(t){vi(s,n,o,r,a,"throw",t)}r(void 0)})}}function bi(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,wi(n.key),n)}}function xi(t,e,i){return(e=wi(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function wi(t){var e=function(t,e){if("object"!=_i(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=_i(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==_i(e)?e:e+""}function Ci(t,e,i){if("function"==typeof t?t===e:t.has(e))return arguments.length<3?e:i;throw new TypeError("Private element is not present on this object")}var Si=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t)}return function(t,e,i){return e&&bi(t.prototype,e),i&&bi(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(t,null,[{key:"register",value:(e=gi(di().m(function e(i,n){var o,s,r,a,l,c,h,u,m,y=arguments;return di().w(function(e){for(;;)switch(e.p=e.n){case 0:if(o=y.length>2&&void 0!==y[2]?y[2]:{},s=Ci(t,this,Mi).call(this,i,(null==o?void 0:o.appendTo)||null),r="worker_".concat(Math.floor(99999*Math.random())),a=s.transferControlToOffscreen(),l=null,!o.fetch){e.n=5;break}return e.p=1,e.n=2,Ci(t,this,ki).call(this,n,"object"===_i(o.fetch)?o.fetch:{});case 2:l=e.v,e.n=4;break;case 3:throw e.p=3,m=e.v,null===(c=o.onerror)||void 0===c||c.call(o,{code:0,text:"Fetch worker failed",error:m}),m;case 4:e.n=6;break;case 5:n=hi.scriptToUrl(n);case 6:return(h=new Worker(l||n,{type:o.type||"module"})).postMessage({wid:r,canvas:a,window:Ci(t,this,Ai).call(this)},[a]),h.onmessage=function(e){var i;l&&(URL.revokeObjectURL(l),l=null),Ii.call(t,e),null==o||null===(i=o.onmessage)||void 0===i||i.call(o,e)},h.onerror=function(e){var i;l&&(URL.revokeObjectURL(l),l=null),Bi.call(t,e),null==o||null===(i=o.onerror)||void 0===i||i.call(o,e)},(u=new Ge(r)).worker=h,t.workers.set(r,{canvas:s,offscreen:a,worker:h,audio:u}),e.a(2,r)}},e,this,[[1,3]])})),function(t,i){return e.apply(this,arguments)})},{key:"send",value:function(t,e){this.workers.has(t)&&this.workers.get(t).worker.postMessage(function(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?pi(Object(i),!0).forEach(function(e){xi(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):pi(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}({wid:t},e))}},{key:"destroy",value:function(t){if(this.workers.has(t)){var e=this.workers.get(t);e.audio.cleanup(),e.worker.terminate(),this.workers.delete(t)}}}]);var e}();function Ai(){return{innerWidth:window.innerWidth,innerHeight:window.innerHeight,outerWidth:window.outerWidth,outerHeight:window.outerHeight,devicePixelRatio:window.devicePixelRatio}}function Mi(t,e){var i=hi._handleCanvasSelector(t,e);return i.tabIndex=0,i.style.outline="none",i}function ki(t){return Di.apply(this,arguments)}function Di(){return Di=gi(di().m(function t(e){var i,n,o,s=arguments;return di().w(function(t){for(;;)switch(t.n){case 0:return i=s.length>1&&void 0!==s[1]?s[1]:{},t.n=1,fetch(e,i);case 1:if((n=t.v).ok){t.n=2;break}throw new Error("fetch failed ".concat(n.status));case 2:return t.n=3,n.blob();case 3:return o=t.v,t.a(2,URL.createObjectURL(o))}},t)})),Di.apply(this,arguments)}function Ii(t){var e=this,i=t.data;if(this.workers.has(i.wid)){var n=this.workers.get(i.wid);switch(i.action){case"ready":n.ready=!0,Ci(ui,this,Pi).call(this,i.wid);break;case"update_canvas":Object.assign(n.canvas.style,i.props.style);break;case"set_resize_target":var o=i.target;if("window"===o||"document"===o)window.addEventListener("resize",function(){var t={action:"resizedTarget"};"window"===o?t.window=Ci(ui,e,Ai).call(e):"document"===o&&(t.width=document.documentElement.clientWidth,t.height=document.documentElement.clientHeight),e.send(i.wid,t)});else{if("string"==typeof o&&(o=document.querySelector(o)),!o instanceof HTMLElement||"undefined"==typeof document||"undefined"==typeof ResizeObserver)return;new ResizeObserver(function(){return e.send(i.wid,{action:"resizedTarget",width:o.offsetWidth,height:o.offsetHeight})}).observe(o)}break;case"take_screenshot":Ci(ui,this,Ti).call(this,i.wid,i)}n.audio._handleWorker(t)}}function Bi(t){}function Pi(t){Vi.call(ui,t)}function Vi(t){var e=this,i=this.workers.get(t),n=function(t,e){var n=i.canvas.getBoundingClientRect(),o={type:e,clientX:t.clientX,clientY:t.clientY,offsetX:t.offsetX,offsetY:t.offsetY,canvasRect:{x:n.x,y:n.y,width:n.width,height:n.height},relativeX:t.clientX-n.left,relativeY:t.clientY-n.top,button:t.button,buttons:t.buttons,altKey:t.altKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey,timeStamp:t.timeStamp};return"wheel"===e&&(o.deltaX=t.deltaX,o.deltaY=t.deltaY,o.deltaZ=t.deltaZ,o.deltaMode=t.deltaMode),o},o=function(t,e){return{type:e,key:t.key,code:t.code,keyCode:t.keyCode,altKey:t.altKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey,repeat:t.repeat,timeStamp:t.timeStamp}},s=function(t,e){return{type:e,touches:Array.from(t.touches).map(function(t){return{identifier:t.identifier,clientX:t.clientX,clientY:t.clientY,pageX:t.pageX,pageY:t.pageY,screenX:t.screenX,screenY:t.screenY}}),changedTouches:Array.from(t.changedTouches).map(function(t){return{identifier:t.identifier,clientX:t.clientX,clientY:t.clientY,pageX:t.pageX,pageY:t.pageY,screenX:t.screenX,screenY:t.screenY}}),altKey:t.altKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey,timeStamp:t.timeStamp}},r=function(){var n=i.canvas.getBoundingClientRect();e.send(t,{action:"boundingClientRect",rect:{x:n.x,y:n.y,width:n.width,height:n.height,top:n.top,left:n.left,right:n.right,bottom:n.bottom}})};r();var a=new ResizeObserver(function(t){var e,n=mi(t);try{for(n.s();!(e=n.n()).done;){e.value.target===i.canvas&&r()}}catch(t){n.e(t)}finally{n.f()}});a.observe(i.canvas),i.resizeObserver=a,i.canvas.addEventListener("contextmenu",function(i){i.preventDefault(),e.send(t,{action:"canvas_event",event:n(i,"contextmenu")})}),i.canvas.addEventListener("mousemove",function(i){e.send(t,{action:"canvas_event",event:n(i,"mousemove")})}),i.canvas.addEventListener("mousedown",function(i){e.send(t,{action:"canvas_event",event:n(i,"mousedown")})}),i.canvas.addEventListener("mouseup",function(i){e.send(t,{action:"canvas_event",event:n(i,"mouseup")})}),i.canvas.addEventListener("wheel",function(i){i.preventDefault(),e.send(t,{action:"canvas_event",event:n(i,"wheel")})}),i.canvas.addEventListener("keydown",function(i){i.preventDefault(),e.send(t,{action:"canvas_event",event:o(i,"keydown")})}),i.canvas.addEventListener("keyup",function(i){i.preventDefault(),e.send(t,{action:"canvas_event",event:o(i,"keyup")})}),i.canvas.addEventListener("touchstart",function(i){i.preventDefault(),e.send(t,{action:"canvas_event",event:s(i,"touchstart")})}),i.canvas.addEventListener("touchmove",function(i){i.preventDefault(),e.send(t,{action:"canvas_event",event:s(i,"touchmove")})}),i.canvas.addEventListener("touchend",function(i){i.preventDefault(),e.send(t,{action:"canvas_event",event:s(i,"touchend")})}),i.canvas.addEventListener("touchcancel",function(i){e.send(t,{action:"canvas_event",event:s(i,"touchcancel")})}),i.canvas.addEventListener("pointerdown",function(i){e.send(t,{action:"canvas_event",event:n(i,"click")})}),document.addEventListener("visibilitychange",function(){e.send(t,{action:"visibilitychange",hidden:document.hidden})}),i.canvas.addEventListener("focus",function(){e.send(t,{action:"canvas_event",event:{type:"focus"}})}),i.canvas.addEventListener("blur",function(){e.send(t,{action:"canvas_event",event:{type:"blur"}})})}function Ti(t,e){var i=e.format,n=void 0===i?"png":i,o=e.quality,s=void 0===o?1:o,r=e.backgroundColor,a=void 0===r?"transparent":r,l=e.download,c=void 0!==l&&l,h=e.filename,u=void 0===h?"pixalo-screenshot-".concat(Date.now()):h,m=this.workers.get(t),y=document.createElement("canvas"),p=y.getContext("2d");y.width=m.canvas.width,y.height=m.canvas.height,a&&(p.fillStyle=a,p.fillRect(0,0,y.width,y.height)),p.drawImage(m.canvas,0,0);var d="image/".concat(n.toLowerCase()),f=y.toDataURL(d,s),_=hi.dataURLToBlob(f),v=URL.createObjectURL(_);if(c){var g=document.createElement("a");g.download="".concat(u,".").concat(n.toLowerCase()),g.href=f,g.click()}y.remove(),this.send(t,{action:"screenshot_taken",details:{dataURL:f,blob:_,blobURL:v,width:y.width,height:y.height}})}ui=Si,xi(Si,"workers",new Map);function Ei(t){return Ei="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Ei(t)}if("undefined"!=typeof window){var Li={Pixalo:hi,Utils:V,Workers:Si,AudioManager:Ge,Background:lt,Bezier:W,Camera:nt,Collision:y,Ease:q,Emitters:be,Entity:Bt,Grid:yt,Particle:he,Physics:qt,Box2D:Ft,TileMap:se,Debugger:O};"function"==typeof define&&define.amd?define(function(){return Li}):"object"===("undefined"==typeof module?"undefined":Ei(module))&&module.exports?module.exports=Li:window.PixaloBundle=Li}return e=e.default})());