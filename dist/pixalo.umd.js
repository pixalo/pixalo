/*!
 * Copyright (c) 2025 Pixalo
 * @Repository: https://github.com/pixalo
 * @License: MIT
 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Pixalo=e():t.Pixalo=e()}(this,()=>(()=>{"use strict";var t={d:(e,i)=>{for(var o in i)t.o(i,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:i[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};function i(t){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i(t)}function o(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var o,n,s,r,a=[],l=!0,h=!1;try{if(s=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;l=!1}else for(;!(l=(o=s.call(i)).done)&&(a.push(o.value),a.length!==e);l=!0);}catch(t){h=!0,n=t}finally{try{if(!l&&null!=i.return&&(r=i.return(),Object(r)!==r))return}finally{if(h)throw n}}return a}}(t,e)||s(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=s(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var o=0,n=function(){};return{s:n,n:function(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,a=!0,l=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return a=t.done,t},e:function(t){l=!0,r=t},f:function(){try{a||null==i.return||i.return()}finally{if(l)throw r}}}}function s(t,e){if(t){if("string"==typeof t)return r(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?r(t,e):void 0}}function r(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,o=Array(e);i<e;i++)o[i]=t[i];return o}function a(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,o)}return i}function l(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?a(Object(i),!0).forEach(function(e){h(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):a(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function h(t,e,i){return(e=m(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function c(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,m(o.key),o)}}function m(t){var e=function(t,e){if("object"!=i(t)||!t)return t;var o=t[Symbol.toPrimitive];if(void 0!==o){var n=o.call(t,e||"default");if("object"!=i(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==i(e)?e:e+""}t.d(e,{default:()=>ni});var u=function(){return function(t,e,i){return e&&c(t.prototype,e),i&&c(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.decomposedShapes=new Map,this.activeCollisions=new Map,this.lastPositions=new Map,this.customPathCache=new Map},[{key:"updateCollisions",value:function(t){var e=this;t=t.filter(function(t){var e;return t&&(null===(e=t.collision)||void 0===e?void 0:e.enabled)});var i=new Map;t.forEach(function(t){var i=e.lastPositions.get(t.id);i&&i.x===t.absoluteX&&i.y===t.absoluteY&&i.rotation===t.styles.rotation&&i.scaleX===t.styles.scaleX&&i.scaleY===t.styles.scaleY&&i.skewX===t.styles.skewX&&i.skewY===t.styles.skewY&&i.borderRadius===t.styles.borderRadius||e.clearCache(t.id),e.lastPositions.set(t.id,{x:t.absoluteX,y:t.absoluteY,rotation:t.styles.rotation,scaleX:t.styles.scaleX,scaleY:t.styles.scaleY,skewX:t.styles.skewX,skewY:t.styles.skewY,borderRadius:t.styles.borderRadius})});for(var s=0;s<t.length;s++)for(var r=s+1;r<t.length;r++){var a,h,c=t[s],m=t[r];if(null!==(a=c.collision)&&void 0!==a&&a.enabled&&null!==(h=m.collision)&&void 0!==h&&h.enabled&&c.collision.group!==m.collision.group){var u="".concat(c.id,"-").concat(m.id),y=this.detectCollisionDetailed(c,m);y.colliding&&!this.activeCollisions.has(u)&&(i.set(u,l(l({entity1:c,entity2:m},y),{},{timestamp:Date.now()})),c.trigger("collide",{entity:m,side:y.side1,otherSide:y.side2,point:y.point,overlap:y.overlap,normal:y.normal}),m.trigger("collide",{entity:c,side:y.side2,otherSide:y.side1,point:y.point,overlap:y.overlap,normal:{x:-y.normal.x,y:-y.normal.y}}))}}var p,_=n(this.activeCollisions);try{for(_.s();!(p=_.n()).done;){var f=o(p.value,2),d=f[0],v=f[1];if(!i.has(d)){var b=v.entity1,x=v.entity2,g=v.side1,w=v.side2;b.trigger("collideEnd",{entity:x,side:g}),x.trigger("collideEnd",{entity:b,side:w})}}}catch(t){_.e(t)}finally{_.f()}this.activeCollisions=i}},{key:"detectCollisionDetailed",value:function(t,e){var i=t.styles.borderRadius>0||e.styles.borderRadius>0?.2*Math.max(t.styles.borderRadius,e.styles.borderRadius):0;if(!this.checkAABBCollision(t,e,i))return{colliding:!1};if("circle"===t.styles.shape&&"circle"===e.styles.shape)return this.detectCircleCollision(t,e);var o=this.getVertices(t),n=this.getVertices(e);return this.detectSATCollision(o,n,t,e,i)}},{key:"detectCircleCollision",value:function(t,e){var i=Math.min(t.width,t.height)/2,o=Math.min(e.width,e.height)/2,n=t.absoluteX+t.width/2,s=t.absoluteY+t.height/2,r=e.absoluteX+e.width/2-n,a=e.absoluteY+e.height/2-s,l=Math.sqrt(r*r+a*a),h=i+o;if(l>=h)return{colliding:!1};var c=h-l,m={x:r/l,y:a/l};return{colliding:!0,side1:this.getSideFromNormal(m),side2:this.getSideFromNormal({x:-m.x,y:-m.y}),point:{x:n+m.x*i,y:s+m.y*i},overlap:c,normal:m}}},{key:"detectSATCollision",value:function(t,e,i,o){var s,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=1/0,l={x:0,y:0},h=n(this.getAxes(t).concat(this.getAxes(e)));try{for(h.s();!(s=h.n()).done;){var c=s.value,m=this.projectVertices(t,c),u=this.projectVertices(e,c),y=this.getOverlap(m,u)-r;if(y<=0)return{colliding:!1};y<a&&(a=y,l=c)}}catch(t){h.e(t)}finally{h.f()}var p=this.findCollisionPoint(t,e),_=this.getSideFromNormal(l);return{colliding:!0,side1:_,side2:this.getOppositeSide(_),point:p,overlap:a,normal:l}}},{key:"checkAABBCollision",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=this.getAABB(t),n=this.getAABB(e);return o.minX-i<=n.maxX+i&&o.maxX+i>=n.minX-i&&o.minY-i<=n.maxY+i&&o.maxY+i>=n.minY-i}},{key:"getSideFromNormal",value:function(t){var e=180*Math.atan2(t.y,t.x)/Math.PI;return e>-45&&e<=45?"right":e>45&&e<=135?"bottom":e>135||e<=-135?"left":"top"}},{key:"getOppositeSide",value:function(t){return{left:"right",right:"left",top:"bottom",bottom:"top"}[t]}},{key:"getOverlap",value:function(t,e){var i=Math.min(t.max-e.min,e.max-t.min);return Math.round(1e4*i)/1e4}},{key:"getAABB",value:function(t){var e=this.getVertices(t),i=1/0,o=1/0,n=-1/0,s=-1/0;return e.forEach(function(t){i=Math.min(i,t.x),o=Math.min(o,t.y),n=Math.max(n,t.x),s=Math.max(s,t.y)}),{minX:i,minY:o,maxX:n,maxY:s}}},{key:"getAxes",value:function(t){for(var e=[],i=0;i<t.length;i++){var o=t[i],n=t[(i+1)%t.length],s={x:n.x-o.x,y:n.y-o.y},r={x:-s.y,y:s.x},a=Math.sqrt(r.x*r.x+r.y*r.y);0!==a&&e.push({x:r.x/a,y:r.y/a})}return e}},{key:"projectVertices",value:function(t,e){var i=1/0,o=-1/0;return t.forEach(function(t){var n=t.x*e.x+t.y*e.y;i=Math.min(i,n),o=Math.max(o,n)}),{min:i,max:o}}},{key:"getVertices",value:function(t){if(this.decomposedShapes.has(t.id))return this.decomposedShapes.get(t.id);var e;if(t.collision.points&&t.collision.points.length>=3)e=t.collision.points;else if(t.styles.customPath)e=this.getCustomPathVertices(t);else switch(t.styles.shape){case"star":e=this.getStarVertices(t);break;case"circle":e=this.getCircleVertices(t);break;case"triangle":e=this.getTriangleVertices(t);break;case"polygon":e=t.styles.points;break;default:e=this.getRectangleVertices(t,t.styles.borderRadius)}return e=this.applyTransformations(e,t),this.decomposedShapes.set(t.id,e),e}},{key:"getStarVertices",value:function(t){for(var e=Math.min(t.width,t.height)/2,i=.4*e,o=t.styles.spikes||5,n=[],s=Math.PI/o,r=0;r<2*o;r++){var a=r%2==0?e:i,l=s*r-Math.PI/2;if(n.push({x:Math.cos(l)*a,y:Math.sin(l)*a}),r<2*o-1){var h=(r+1)%2==0?e:i,c=s*(r+1)-Math.PI/2,m=(Math.cos(l)*a+Math.cos(c)*h)/2,u=(Math.sin(l)*a+Math.sin(c)*h)/2;n.push({x:m,y:u})}}return n}},{key:"getCircleVertices",value:function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:16,i=[],o=Math.min(t.width,t.height)/2,n=0;n<e;n++){var s=n/e*Math.PI*2;i.push({x:Math.cos(s)*o,y:Math.sin(s)*o})}return i}},{key:"getTriangleVertices",value:function(t){var e=t.width/2,i=t.height/2;return[{x:0,y:-i},{x:e,y:i},{x:-e,y:i}]}},{key:"getRectangleVertices",value:function(t,e){var i=t.width/2,o=t.height/2;if(!e)return[{x:-i,y:-o},{x:i,y:-o},{x:i,y:o},{x:-i,y:o}];var n=Math.min(e,Math.min(i,o)),s=[];return s.push({x:i-n,y:-o}),s.push({x:-i+n,y:-o}),s.push({x:-i,y:-o+n}),s.push({x:-i,y:o-n}),s.push({x:-i+n,y:o}),s.push({x:i-n,y:o}),s.push({x:i,y:o-n}),s.push({x:i,y:-o+n}),this.addRoundedCornerVertices(s,i-n,-o+n,n,0,4),this.addRoundedCornerVertices(s,-i+n,-o+n,n,Math.PI/2,4),this.addRoundedCornerVertices(s,-i+n,o-n,n,Math.PI,4),this.addRoundedCornerVertices(s,i-n,o-n,n,3*Math.PI/2,4),s}},{key:"addRoundedCornerVertices",value:function(t,e,i,o,n,s){for(var r=0;r<=s;r++){var a=n+Math.PI/2*(r/s);t.push({x:e+Math.cos(a)*o,y:i+Math.sin(a)*o})}}},{key:"getCustomPathVertices",value:function(t){var e="".concat(t.id,"-").concat(t.styles.customPath);if(this.customPathCache.has(e))return this.customPathCache.get(e);var i=document.createElement("canvas"),o=i.getContext("2d");i.width=t.width,i.height=t.height,o.save(),o.translate(t.width/2,t.height/2),t.styles.customPath(o);var n=this.samplePathPoints(o,t.width,t.height);return o.restore(),this.customPathCache.set(e,n),n}},{key:"findCollisionPoint",value:function(t,e){var i=1/0,o={x:0,y:0};return t.forEach(function(t){e.forEach(function(e){var n=e.x-t.x,s=e.y-t.y,r=n*n+s*s;r<i&&(i=r,o={x:t.x+n/2,y:t.y+s/2})})}),o}},{key:"samplePathPoints",value:function(t,e,i){for(var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:16,n=[],s={minX:-e/2+2,maxX:e/2-2,minY:-i/2+2,maxY:i/2-2},r=0;r<2*Math.PI;r+=2*Math.PI/o){for(var a=0,l=Math.max(e,i),h=l,c=0;c<8;c++){var m=(a+l)/2,u=Math.cos(r)*m,y=Math.sin(r)*m;this.isPointInBounds(u,y,s)&&t.isPointInPath(u+e/2,y+i/2)?(h=m,l=m):a=m}var p=Math.cos(r)*h,_=Math.sin(r)*h;this.isPointInBounds(p,_,s)&&n.push({x:p,y:_})}if(n.length>2){for(var f=[],d=0;d<n.length;d++){var v=n[d],b=n[(d+1)%n.length];f.push(v),f.push({x:(v.x+b.x)/2,y:(v.y+b.y)/2})}return f}return n}},{key:"isPointInBounds",value:function(t,e,i){return t>=i.minX&&t<=i.maxX&&e>=i.minY&&e<=i.maxY}},{key:"applyTransformations",value:function(t,e){var i=e.styles.rotation*Math.PI/180,o=Math.cos(i),n=Math.sin(i),s=e.styles.scale*e.styles.scaleX,r=e.styles.scale*e.styles.scaleY,a=Math.tan(e.styles.skewX*Math.PI/180),l=Math.tan(e.styles.skewY*Math.PI/180);return t.map(function(t){var i=t.x*s,h=t.y*r,c=(i+=h*a)*n+(h+=i*l)*o;return{x:i*o-h*n+e.absoluteX+e.width/2,y:c+e.absoluteY+e.height/2}})}},{key:"remove",value:function(t){var e=this;this.decomposedShapes.delete(t.id),this.lastPositions.delete(t.id);var i=[];this.activeCollisions.forEach(function(e,o){e.entity1.id!==t.id&&e.entity2.id!==t.id||i.push(o)}),i.forEach(function(i){var o=e.activeCollisions.get(i);if(o){var n=o.entity1.id===t.id?o.entity2:o.entity1,s=o.entity1.id===t.id?o.side2:o.side1;n.trigger("collideEnd",{entity:t,side:s}),e.activeCollisions.delete(i)}})}},{key:"clearCache",value:function(t){this.decomposedShapes.delete(t)}},{key:"reset",value:function(){this.decomposedShapes.clear(),this.activeCollisions.clear(),this.lastPositions.clear(),this.customPathCache.clear()}}],[{key:"isPointInCollisionPoints",value:function(t,e,i){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2;return!!this.isPointOnBezierCurves(t,e,i,o)||this.isPointInShape(t,e,i)}},{key:"isPointInTriangle",value:function(t,e,i,o){var n=-o/2,s=i/2,r=o/2,a=-i/2,l=o/2,h=(t-a)*(n-l)-(0-a)*(e-l),c=(t-0)*(r-n)-(s-0)*(e-n),m=(t-s)*(l-r)-(a-s)*(e-r);return h>=0&&c>=0&&m>=0||h<=0&&c<=0&&m<=0}},{key:"isPointOnBezierCurves",value:function(t,e,i,o){for(var n=0;n<i.length-1;n++)for(var s=i[n],r=i[n+1],a=this.getIntermediatePoints(s,r,10),l=0;l<a.length-1;l++){var h=a[l],c=a[l+1];if(this.pointToLineDistance(t,e,h.x,h.y,c.x,c.y)<=o)return!0}if(i.length>0)for(var m=i[0],u=i[i.length-1],y=this.getIntermediatePoints(u,m,10),p=0;p<y.length-1;p++){var _=y[p],f=y[p+1];if(this.pointToLineDistance(t,e,_.x,_.y,f.x,f.y)<=o)return!0}return!1}},{key:"isPointInShape",value:function(t,e,i){for(var o=0,n=0;n<i.length;n++){var s=i[n],r=i[(n+1)%i.length];s.y<=e?r.y>e&&this.isLeft(s,r,{x:t,y:e})>0&&o++:r.y<=e&&this.isLeft(s,r,{x:t,y:e})<0&&o--}return 0!==o}},{key:"isLeft",value:function(t,e,i){return(e.x-t.x)*(i.y-t.y)-(i.x-t.x)*(e.y-t.y)}},{key:"getIntermediatePoints",value:function(t,e,i){for(var o=[],n=0;n<=i;n++){var s=n/i;o.push({x:t.x+(e.x-t.x)*s,y:t.y+(e.y-t.y)*s})}return o}},{key:"pointToLineDistance",value:function(t,e,i,o,n,s){var r,a,l=n-i,h=s-o,c=l*l+h*h,m=-1;0!==c&&(m=((t-i)*l+(e-o)*h)/c),m<0?(r=i,a=o):m>1?(r=n,a=s):(r=i+m*l,a=o+m*h);var u=t-r,y=e-a;return Math.sqrt(u*u+y*y)}},{key:"optimizeCollisionPoints",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;if(t.length<=2)return t;for(var i=[t[0]],o=t[0],n=1;n<t.length;n++){var s=t[n],r=s.x-o.x,a=s.y-o.y;Math.sqrt(r*r+a*a)>=e&&(i.push(s),o=s)}return i[0]!==i[i.length-1]&&i.push(i[0]),i}}])}();const y=u;function p(t){return p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},p(t)}function _(t){return function(t){if(Array.isArray(t))return v(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||d(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function f(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=d(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var o=0,n=function(){};return{s:n,n:function(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return r=t.done,t},e:function(t){a=!0,s=t},f:function(){try{r||null==i.return||i.return()}finally{if(a)throw s}}}}function d(t,e){if(t){if("string"==typeof t)return v(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?v(t,e):void 0}}function v(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,o=Array(e);i<e;i++)o[i]=t[i];return o}function b(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,w(o.key),o)}}function x(t,e){(function(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")})(t,e),e.add(t)}function g(t,e,i){return(e=w(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function w(t){var e=function(t,e){if("object"!=p(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var o=i.call(t,e||"default");if("object"!=p(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==p(e)?e:e+""}function C(t,e,i){if("function"==typeof t?t===e:t.has(e))return arguments.length<3?e:i;throw new TypeError("Private element is not present on this object")}var S=new WeakSet,A=function(){return function(t,e,i){return e&&b(t.prototype,e),i&&b(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),x(this,S),g(this,"pressedKeys",new Set),g(this,"keyMap",{control:"ctrl"," ":"space",arrowup:"up",arrowdown:"down",arrowleft:"left",arrowright:"right",escape:"esc",enter:"enter",shift:"shift",alt:"alt",meta:"meta",delete:"del",backspace:"backspace",tab:"tab",capslock:"caps",pageup:"pageup",pagedown:"pagedown",insert:"ins",home:"home",end:"end"})},[{key:"getSortedEntitiesForInteraction",value:function(){var t,e=[],i=0,o=function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:0)+(t.zIndex||0);e.push({entity:t,level:n,effectiveZIndex:s,isChild:!!t.parent,addOrder:i++});var r,a=f(t.children.values());try{for(a.s();!(r=a.n()).done;){var l=r.value;o(l,n+1,s)}}catch(t){a.e(t)}finally{a.f()}},n=f(this.entities.values());try{for(n.s();!(t=n.n()).done;){var s=t.value;o(s)}}catch(t){n.e(t)}finally{n.f()}return e.sort(function(t,e){return e.effectiveZIndex!==t.effectiveZIndex?e.effectiveZIndex-t.effectiveZIndex:e.level!==t.level?e.level-t.level:t.addOrder-e.addOrder}).map(function(t){return t.entity})}},{key:"isPointInEntity",value:function(t,e,i){var o;if(!i.styles.visible)return!1;var n=i.absoluteX+i.width/2,s=i.absoluteY+i.height/2,r=-i.styles.rotation*Math.PI/180,a=Math.cos(r),l=Math.sin(r),h=a*(t-n)-l*(e-s),c=l*(t-n)+a*(e-s);if((null===(o=i.collision)||void 0===o||null===(o=o.points)||void 0===o?void 0:o.length)>0)return y.isPointInCollisionPoints(h,c,i.collision.points);var m=i.width*i.styles.scale*i.styles.scaleX,u=i.height*i.styles.scale*i.styles.scaleY;switch(i.styles.shape){case"circle":var p=Math.min(m,u)/2;return h*h+c*c<=p*p;case"triangle":return y.isPointInTriangle(h,c,m,u);default:return Math.abs(h)<=m/2&&Math.abs(c)<=u/2}}},{key:"_handleResize",value:function(){this.canvas.width=this.canvas.offsetWidth*this.config.quality,this.canvas.height=this.canvas.offsetHeight*this.config.quality,this.config.width=this.canvas.offsetWidth,this.config.height=this.canvas.offsetHeight,this.baseWidth=this.config.width,this.baseHeight=this.config.height,this.ctx.scale(this.config.quality,this.config.quality),this.trigger("resize",{width:this.config.width,height:this.config.height})}},{key:"handleTouchStart",value:function(t){var e=this;if(this.running){var i,o=f(t.changedTouches);try{var n=function(){var t=i.value,o=t.identifier,n=e.camera.screenToWorld(t.clientX,t.clientY),s={x:n.x,y:n.y,worldX:n.x,worldY:n.y,screenX:t.clientX,screenY:t.clientY,timestamp:Date.now(),identifier:o};if(e.trigger("touchstart",s),e.physicsEnabled)return 1;var r=e.getSortedEntitiesForInteraction().find(function(t){return e.isPointInEntity(n.x,n.y,t)&&(t.isDraggable()||t.isClickable())});if(r){e.entities.forEach(function(t){t.zIndex>r.zIndex&&t.zIndex--});var a=0;e.entities.forEach(function(t){a=Math.max(a,t.zIndex||0)}),r.zIndex=a+1,e.draggedEntities.set(o,{entity:r,touchStartX:n.x,touchStartY:n.y,dragStartX:n.x-r.absoluteX,dragStartY:n.y-r.absoluteY}),r.isDraggable()&&r.trigger("drag",s)}};for(o.s();!(i=o.n()).done;)n()}catch(t){o.e(t)}finally{o.f()}}}},{key:"handleTouchMove",value:function(t){if(t.preventDefault(),this.running){var e,i=f(t.changedTouches);try{for(i.s();!(e=i.n()).done;){var o=e.value,n=o.identifier,s=this.draggedEntities.get(n),r=this.camera.screenToWorld(o.clientX,o.clientY),a={x:r.x,y:r.y,worldX:r.x,worldY:r.y,screenX:o.clientX,screenY:o.clientY,timestamp:Date.now(),identifier:n};if(this.trigger("touchmove",a),!this.physicsEnabled&&s){var l=s.entity,h=r.x-s.dragStartX,c=r.y-s.dragStartY;if(l.parent&&l.constrainToParent){var m=l.parent,u=m.width-l.width,y=m.height-l.height;h=Math.max(0,Math.min(u,h-m.absoluteX)),c=Math.max(0,Math.min(y,c-m.absoluteY))}else l.parent&&(h-=l.parent.absoluteX,c-=l.parent.absoluteY);l.style({x:h,y:c}),l.trigger("dragMove",a)}}}catch(t){i.e(t)}finally{i.f()}}}},{key:"handleTouchEnd",value:function(t){if(this.running){var e,i=f(t.changedTouches);try{for(i.s();!(e=i.n()).done;){var o=e.value,n=o.identifier,s=this.draggedEntities.get(n),r=this.camera.screenToWorld(o.clientX,o.clientY),a={x:r.x,y:r.y,worldX:r.x,worldY:r.y,screenX:o.clientX,screenY:o.clientY,timestamp:Date.now(),identifier:n};if(!this.physicsEnabled&&s){var l=s.entity,h=Math.abs(r.x-s.touchStartX),c=Math.abs(r.y-s.touchStartY),m=h>5||c>5;l.isDraggable()&&l.trigger("drop",a),!m&&l.isClickable()&&l.trigger("click",a),this.draggedEntities.delete(n)}this.trigger("touchend",a)}}catch(t){i.e(t)}finally{i.f()}}}},{key:"handleTouchCancel",value:function(t){this.handleTouchEnd(t)}},{key:"handleMouseMove",value:function(t){var e=this;if(this.running&&2!==t.buttons){var i=this.camera.screenToWorld(t.clientX,t.clientY),o={x:i.x,y:i.y,worldX:i.x,worldY:i.y,screenX:t.clientX,screenY:t.clientY,timestamp:Date.now()};if(this.trigger("mousemove",o),!this.physicsEnabled){if(this.draggedEntity&&this.draggedEntity.isDraggable()){var n=i.x-this.draggedEntity.dragStartX,s=i.y-this.draggedEntity.dragStartY;if(this.draggedEntity.parent&&this.draggedEntity.constrainToParent){var r=this.draggedEntity.parent,a=r.width-this.draggedEntity.width,l=r.height-this.draggedEntity.height;n=Math.max(0,Math.min(a,n-r.absoluteX)),s=Math.max(0,Math.min(l,s-r.absoluteY))}else this.draggedEntity.parent&&(n-=this.draggedEntity.parent.absoluteX,s-=this.draggedEntity.parent.absoluteY);return this.draggedEntity.style({x:n,y:s}),void this.draggedEntity.trigger("dragMove",o)}var h=this.getSortedEntitiesForInteraction().find(function(t){return e.isPointInEntity(i.x,i.y,t)&&t.isHoverable()});h!==this.hoveredEntity&&(this.hoveredEntity&&this.hoveredEntity.trigger("hoverOut",o),h?(this.hoveredEntity=h,h.trigger("hover",o)):this.hoveredEntity=null)}}}},{key:"handleMouseDown",value:function(t){var e=this;if(this.running&&2!==t.buttons){var i=this.camera.screenToWorld(t.clientX,t.clientY),o={x:i.x,y:i.y,worldX:i.x,worldY:i.y,screenX:t.clientX,screenY:t.clientY,timestamp:Date.now()};if(this.trigger("mousedown",o),!this.physicsEnabled){var n=this.getSortedEntitiesForInteraction().find(function(t){return e.isPointInEntity(i.x,i.y,t)&&t.isDraggable()});if(n){this.draggedEntity=n,this.entities.forEach(function(t){t.zIndex>n.zIndex&&t.zIndex--});var s=0;this.entities.forEach(function(t){s=Math.max(s,t.zIndex||0)}),n.zIndex=s+1,this.draggedEntity.dragStartX=i.x-n.absoluteX,this.draggedEntity.dragStartY=i.y-n.absoluteY,n.trigger("drag",o)}}}}},{key:"handleMouseUp",value:function(t){if(this.running&&2!==t.buttons){var e=this.camera.screenToWorld(t.clientX,t.clientY),i={x:e.x,y:e.y,worldX:e.x,worldY:e.y,screenX:t.clientX,screenY:t.clientY,timestamp:Date.now()};this.trigger("mouseup",i),this.physicsEnabled||this.draggedEntity&&(this.draggedEntity.trigger("drop",i),this.draggedEntity=null)}}},{key:"handleClick",value:function(t){2!==t.button&&this._handleClick(t,"click")}},{key:"handleRightClick",value:function(t){this._handleClick(t,"rightclick")}},{key:"_handleClick",value:function(t,e){var i=this;if(t.preventDefault(),setTimeout(function(){return i.canvas.focus()},0),this.running){var o=this.camera.screenToWorld(t.clientX,t.clientY),n={x:o.x,y:o.y,worldX:o.x,worldY:o.y,screenX:t.clientX,screenY:t.clientY,timestamp:Date.now()},s=this.getSortedEntitiesForInteraction().find(function(t){return i.isPointInEntity(o.x,o.y,t)&&t.isClickable()});s&&s.trigger(e,n),this.trigger(e,n)}}},{key:"handleKeyDown",value:function(t){t.preventDefault();var e=C(S,this,M).call(this,t.key);this.pressedKeys.add(e);var i=C(S,this,D).call(this,this.pressedKeys).join("+");this.trigger("keydown",i,t),this.trigger(i,i,t)}},{key:"handleKeyUp",value:function(t){t.preventDefault();var e=C(S,this,M).call(this,t.key);this.pressedKeys.delete(e),this.trigger("keyup",e,t)}},{key:"hexToRgb",value:function(t){var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}},{key:"rgbToHex",value:function(t,e,i){return"#"+[t,e,i].map(function(t){var e=t.toString(16);return 1===e.length?"0"+e:e}).join("")}},{key:"hslToRgb",value:function(t,e,i){var o,n,s;if(0===e)o=n=s=i;else{var r=function(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t},a=i<.5?i*(1+e):i+e-i*e,l=2*i-a;o=r(l,a,t+1/3),n=r(l,a,t),s=r(l,a,t-1/3)}return{r:Math.round(255*o),g:Math.round(255*n),b:Math.round(255*s)}}},{key:"randHex",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=Math.floor(256*Math.random()),i=Math.floor(256*Math.random()),o=Math.floor(256*Math.random()),n=function(t){return t.toString(16).padStart(2,"0")};if(t){var s=Math.floor(256*Math.random());return"#".concat(n(e)).concat(n(i)).concat(n(o)).concat(n(s))}return"#".concat(n(e)).concat(n(i)).concat(n(o))}},{key:"randRgb",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=Math.floor(256*Math.random()),i=Math.floor(256*Math.random()),o=Math.floor(256*Math.random());if(t){var n=Math.random().toFixed(2);return"rgba(".concat(e,", ").concat(i,", ").concat(o,", ").concat(n,")")}return"rgb(".concat(e,", ").concat(i,", ").concat(o,")")}},{key:"randHsl",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=t.hueRange,o=void 0===i?[0,360]:i,n=t.saturationRange,s=void 0===n?[0,100]:n,r=t.lightnessRange,a=void 0===r?[0,100]:r,l=Math.floor(Math.random()*(o[1]-o[0])+o[0]),h=Math.floor(Math.random()*(s[1]-s[0])+s[0]),c=Math.floor(Math.random()*(a[1]-a[0])+a[0]);if(e){var m=Math.random().toFixed(2);return"hsla(".concat(l,", ").concat(h,"%, ").concat(c,"%, ").concat(m,")")}return"hsl(".concat(l,", ").concat(h,"%, ").concat(c,"%)")}},{key:"adjustAlpha",value:function(t,e){if(t.includes("rgba"))return t.replace(/rgba\((.+),\s*([0-9.]+)\)/,function(t,i,o){var n=Math.min(parseFloat(o)*e,1);return"rgba(".concat(i,", ").concat(n,")")});if(t.includes("rgb")){var i=t.match(/rgb\((.+)\)/)[1],o=Math.min(.5*e,1);return"rgba(".concat(i,", ").concat(o,")")}var n=t.replace("#",""),s=parseInt(n.substr(0,2),16),r=parseInt(n.substr(2,2),16),a=parseInt(n.substr(4,2),16),l=Math.min(.5*e,1);return"rgba(".concat(s,", ").concat(r,", ").concat(a,", ").concat(l,")")}},{key:"getDistance",value:function(t,e,i,o){return Math.sqrt(Math.pow(i-t,2)+Math.pow(o-e,2))}},{key:"randBetween",value:function(t,e){return Math.floor(Math.random()*(e-t+1)+t)}},{key:"clamp",value:function(t,e,i){return Math.min(Math.max(t,e),i)}},{key:"lerp",value:function(t,e,i){return t+(e-t)*i}},{key:"degToRad",value:function(t){return t*(Math.PI/180)}},{key:"radToDeg",value:function(t){return t*(180/Math.PI)}},{key:"getAngle",value:function(t,e,i,o){return Math.atan2(o-e,i-t)}},{key:"rotatePoint",value:function(t,e,i,o,n){var s=this.degToRad(n),r=Math.cos(s),a=Math.sin(s),l=i-t,h=o-e;return{x:t+(l*r-h*a),y:e+(l*a+h*r)}}},{key:"dataURLToBlob",value:function(t){for(var e=t.split(","),i=e[0].match(/:(.*?);/)[1],o=atob(e[1]),n=o.length,s=new Uint8Array(n);n--;)s[n]=o.charCodeAt(n);return new Blob([s],{type:i})}}])}();function M(t){return this.keyMap[t.toLowerCase()]||t.toLowerCase()}function D(t){var e=["ctrl","shift","alt","meta"];return _(t).sort(function(t,i){var o=e.indexOf(t),n=e.indexOf(i);return(-1===o?99:o)-(-1===n?99:n)||t.localeCompare(i)})}const B=A;function I(t){return I="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},I(t)}function V(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,k(o.key),o)}}function k(t){var e=function(t,e){if("object"!=I(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var o=i.call(t,e||"default");if("object"!=I(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==I(e)?e:e+""}var P=function(){return function(t,e,i){return e&&V(t.prototype,e),i&&V(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t)},null,[{key:"getPoint",value:function(t,e,i,o,n){var s=1-n;return{x:s*s*s*t.x+3*s*s*n*e.x+3*s*n*n*i.x+n*n*n*o.x,y:s*s*s*t.y+3*s*s*n*e.y+3*s*n*n*i.y+n*n*n*o.y}}},{key:"getPoints",value:function(t,e,i,o){for(var n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:20,s=[],r=0;r<=1;r+=1/n)s.push(this.getPoint(t,e,i,o,r));return s}},{key:"getQuadraticPoint",value:function(t,e,i,o){var n=1-o;return{x:n*n*t.x+2*n*o*e.x+o*o*i.x,y:n*n*t.y+2*n*o*e.y+o*o*i.y}}},{key:"getLength",value:function(t,e,i,o){for(var n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:100,s=0,r=this.getPoint(t,e,i,o,0),a=1;a<=n;a++){var l=a/n,h=this.getPoint(t,e,i,o,l),c=h.x-r.x,m=h.y-r.y;s+=Math.sqrt(c*c+m*m),r=h}return s}}])}();const T=P;var G={linear:function(t){return t},easeInQuad:function(t){return t*t},easeOutQuad:function(t){return t*(2-t)},easeInOutQuad:function(t){return t<.5?2*t*t:(4-2*t)*t-1},easeInCubic:function(t){return t*t*t},easeOutCubic:function(t){return--t*t*t+1},easeInOutCubic:function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1},easeInQuart:function(t){return t*t*t*t},easeOutQuart:function(t){return 1- --t*t*t*t},easeInOutQuart:function(t){return t<.5?8*t*t*t*t:1-8*--t*t*t*t},easeInQuint:function(t){return t*t*t*t*t},easeOutQuint:function(t){return 1+--t*t*t*t*t},easeInOutQuint:function(t){return t<.5?16*t*t*t*t*t:1+16*--t*t*t*t*t},easeInSine:function(t){return 1-Math.cos(t*Math.PI/2)},easeOutSine:function(t){return Math.sin(t*Math.PI/2)},easeInOutSine:function(t){return-(Math.cos(Math.PI*t)-1)/2},easeInExpo:function(t){return 0===t?0:Math.pow(2,10*(t-1))},easeOutExpo:function(t){return 1===t?1:1-Math.pow(2,-10*t)},easeInOutExpo:function(t){return 0===t?0:1===t?1:t<.5?Math.pow(2,20*t-10)/2:(2-Math.pow(2,-20*t+10))/2},easeInCirc:function(t){return 1-Math.sqrt(1-t*t)},easeOutCirc:function(t){return Math.sqrt(1- --t*t)},easeInOutCirc:function(t){return t<.5?(1-Math.sqrt(1-4*t*t))/2:(Math.sqrt(1-4*(t-1)*(t-1))+1)/2},easeInBounce:function(t){return 1-G.easeOutBounce(1-t)},easeOutBounce:function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},easeInOutBounce:function(t){return t<.5?.5*G.easeInBounce(2*t):.5*G.easeOutBounce(2*t-1)+.5},easeInElastic:function(t){return 0===t?0:1===t?1:-Math.pow(2,10*(t-1))*Math.sin(5*(t-1.1)*Math.PI)},easeOutElastic:function(t){return 0===t?0:1===t?1:Math.pow(2,-10*t)*Math.sin(5*(t-.1)*Math.PI)+1},easeInOutElastic:function(t){return 0===t?0:1===t?1:(t*=2)<1?-.5*Math.pow(2,10*(t-1))*Math.sin(5*(t-1.1)*Math.PI):.5*Math.pow(2,-10*(t-1))*Math.sin(5*(t-1.1)*Math.PI)+1},easeStepStart:function(t){return 0===t?0:1},easeStepEnd:function(t){return 1===t?1:0},easeSteps:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;return Math.floor(t*e)/(e-1)},easeInBack:function(t){var e=1.70158;return e*t*t*t-e*t*t},easeOutBack:function(t){var e=1.70158;return 1+e*Math.pow(t-1,3)+e*Math.pow(t-1,2)},easeInOutBack:function(t){var e=2.5949095;return t<.5?Math.pow(2*t,2)*(7.189819*t-e)/2:(Math.pow(2*t-2,2)*((e+1)*(2*t-2)+e)+2)/2}};const L=G;function E(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var o,n,s,r,a=[],l=!0,h=!1;try{if(s=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;l=!1}else for(;!(l=(o=s.call(i)).done)&&(a.push(o.value),a.length!==e);l=!0);}catch(t){h=!0,n=t}finally{try{if(!l&&null!=i.return&&(r=i.return(),Object(r)!==r))return}finally{if(h)throw n}}return a}}(t,e)||function(t,e){if(t){if("string"==typeof t)return F(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?F(t,e):void 0}}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function F(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,o=Array(e);i<e;i++)o[i]=t[i];return o}function R(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,o)}return i}function J(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?R(Object(i),!0).forEach(function(e){O(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):R(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function O(t,e,i){return(e=N(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function z(t){return z="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},z(t)}function j(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,N(o.key),o)}}function N(t){var e=function(t,e){if("object"!=z(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var o=i.call(t,e||"default");if("object"!=z(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==z(e)?e:e+""}var X=function(){return function(t,e,i){return e&&j(t.prototype,e),i&&j(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(e){var i,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.engine=e,this.x=o.x||0,this.y=o.y||0,this.zoom=o.zoom||1,this.bounds=o.bounds||null,this.minZoom=o.minZoom||.1,this.maxZoom=o.maxZoom||5,this.smoothing=null===(i=o.smoothing)||void 0===i||i,this.smoothSpeed=o.smoothSpeed||.1,this._targetX=this.x,this._targetY=this.y,this._targetZoom=this.zoom,this._lastX=this.x,this._lastY=this.y,this._lastZoom=this.zoom,this.deltaX=0,this.deltaY=0,this.deltaZoom=0,this._followedEntity=null,this._followConfig=null,this._followOffset={x:0,y:0},this._states=new Map,this._effects={shake:null,flash:null,fade:null,cinematic:null}},[{key:"moveTo",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"easeInOutCubic";if(this.bounds){var r=this.engine.baseWidth/this.zoom,a=this.engine.baseHeight/this.zoom;t=this.bounds.width>r?Math.min(Math.max(t,this.bounds.x),this.bounds.x+this.bounds.width-r):this.bounds.x+(this.bounds.width-r)/2,i=this.bounds.height>a?Math.min(Math.max(i,this.bounds.y),this.bounds.y+this.bounds.height-a):this.bounds.y+(this.bounds.height-a)/2}if(o||!n)return this.x=this._targetX=t,this.y=this._targetY=i,this;var l=this.x,h=this.y,c=Date.now();this.smoothing=!1,s="function"==typeof s?s:this.engine.Ease[s]||this.engine.Ease.easeInOutCubic;var m=function(){var o=Math.min((Date.now()-c)/n,1),r=s(o);e.x=e._targetX=l+(t-l)*r,e.y=e._targetY=h+(i-h)*r,o<1?requestAnimationFrame(m):e.smoothing=!0};return m(),this}},{key:"moveBy",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"easeInOutCubic";return this.moveTo(this.x+t,this.y+e,i,o,n)}},{key:"getCurrentCenter",value:function(){var t=this.engine.baseWidth/this.zoom,e=this.engine.baseHeight/this.zoom;return{x:this.x+t/2,y:this.y+e/2}}},{key:"zoomTo",value:function(t,e,i){var o=this,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"easeInOutCubic";if("object"===z(t)){var r=t;t=r.zoom,e=r.centerX,i=r.centerY;var a=r.duration;n=void 0===a?500:a;var l=r.easing;s=void 0===l?"easeInOutCubic":l}t=Math.min(Math.max(t,this.minZoom),this.maxZoom);var h=this.zoom,c=this.x,m=this.y,u=Date.now();if(void 0===e||void 0===i){var y=this.getCurrentCenter();e=y.x,i=y.y}this.engine.baseWidth,this.engine.baseHeight;var p=this.engine.baseWidth/t,_=this.engine.baseHeight/t,f=e-p/2,d=i-_/2;this.bounds&&(f=this.bounds.width>p?Math.min(Math.max(f,this.bounds.x),this.bounds.x+this.bounds.width-p):this.bounds.x+(this.bounds.width-p)/2,d=this.bounds.height>_?Math.min(Math.max(d,this.bounds.y),this.bounds.y+this.bounds.height-_):this.bounds.y+(this.bounds.height-_)/2);var v=this.smoothing;this.smoothing=!1,s="function"==typeof s?s:this.engine.Ease[s]||this.engine.Ease.easeInOutCubic;var b=function(){var e=Date.now()-u,i=Math.min(e/n,1),r=s(i);o.zoom=h+(t-h)*r;var a,l,y=o.engine.baseWidth/o.zoom,p=o.engine.baseHeight/o.zoom;o.bounds?(o.bounds.width>y?(a=c+(f-c)*r,a=Math.min(Math.max(a,o.bounds.x),o.bounds.x+o.bounds.width-y)):a=o.bounds.x+(o.bounds.width-y)/2,o.bounds.height>p?(l=m+(d-m)*r,l=Math.min(Math.max(l,o.bounds.y),o.bounds.y+o.bounds.height-p)):l=o.bounds.y+(o.bounds.height-p)/2):(a=c+(f-c)*r,l=m+(d-m)*r),o.x=a,o.y=l,o._targetZoom=o.zoom,o._targetX=o.x,o._targetY=o.y,i<1?requestAnimationFrame(b):o.smoothing=v};return b(),this}},{key:"zoomToLevel",value:function(t,e,i){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"easeInOutCubic";return this.zoomTo(t,e,i,o,n)}},{key:"zoomBy",value:function(t,e,i){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"easeInOutCubic";return this.zoomTo(this.zoom*t,e,i,o,n)}},{key:"zoomAtPoint",value:function(t,e,i){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"easeInOutCubic",s=this.screenToWorld(e,i);return this.zoomTo(this.zoom*t,s.x,s.y,o,n)}},{key:"setBounds",value:function(t){return this.bounds=t,this._enforceBounds(),this}},{key:"_enforceBounds",value:function(){if(this.bounds){var t=this.engine.baseWidth/this._targetZoom,e=this.engine.baseHeight/this._targetZoom;this.bounds.width>t?this._targetX=Math.min(Math.max(this._targetX,this.bounds.x),this.bounds.x+this.bounds.width-t):this._targetX=this.bounds.x+(this.bounds.width-t)/2,this.bounds.height>e?this._targetY=Math.min(Math.max(this._targetY,this.bounds.y),this.bounds.y+this.bounds.height-e):this._targetY=this.bounds.y+(this.bounds.height-e)/2}}},{key:"focusOn",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.zoom,o=this.engine.baseWidth/i,n=this.engine.baseHeight/i;return this.moveTo(t-o/2,e-n/2).zoomTo(i)}},{key:"focusOnRect",value:function(t){var e,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=this.engine.baseWidth/this.engine.baseHeight;return e=(t.width+2*i)/(t.height+2*i)>o?this.engine.baseWidth/(t.width+2*i):this.engine.baseHeight/(t.height+2*i),this.focusOn(t.x+t.width/2,t.y+t.height/2,Math.min(Math.max(e,this.minZoom),this.maxZoom))}},{key:"apply",value:function(t){t.save(),t.translate(this.engine.baseWidth/2,this.engine.baseHeight/2),t.scale(this.zoom,this.zoom),t.translate(-this.engine.baseWidth/(2*this.zoom)-this.x,-this.engine.baseHeight/(2*this.zoom)-this.y)}},{key:"restore",value:function(t){t.restore()}},{key:"update",value:function(){var t;if(this._lastX=this.x,this._lastY=this.y,this._lastZoom=this.zoom,this._followedEntity&&this._followConfig){var e=this._calculateFollowPosition();e&&(this._followConfig.smooth?(this._targetX=e.x,this._targetY=e.y):(this.x=this._targetX=e.x,this.y=this._targetY=e.y))}if(this.smoothing||this._followedEntity&&null!==(t=this._followConfig)&&void 0!==t&&t.smooth){var i,o=(null===(i=this._followConfig)||void 0===i?void 0:i.smoothSpeed)||this.smoothSpeed;this.x+=(this._targetX-this.x)*o,this.y+=(this._targetY-this.y)*o,this.zoom+=(this._targetZoom-this.zoom)*this.smoothSpeed}else this.x=this._targetX,this.y=this._targetY,this.zoom=this._targetZoom;this.deltaX=this.x-this._lastX,this.deltaY=this.y-this._lastY,this.deltaZoom=this.zoom-this._lastZoom,this._enforceBounds(),this.updateEffects(this.engine.ctx)}},{key:"screenToWorld",value:function(t,e){var i=this.engine.canvas.getBoundingClientRect(),o=(t-i.left)*(this.engine.canvas.width/i.width),n=(e-i.top)*(this.engine.canvas.height/i.height),s=o/this.engine.config.quality,r=n/this.engine.config.quality;return{x:s/this.zoom+this.x,y:r/this.zoom+this.y}}},{key:"worldToScreen",value:function(t,e){var i=(t-this.x)*this.zoom,o=(e-this.y)*this.zoom,n=i*this.engine.config.quality,s=o*this.engine.config.quality,r=this.engine.canvas.getBoundingClientRect();return{x:n*(r.width/this.engine.canvas.width)+r.left,y:s*(r.height/this.engine.canvas.height)+r.top}}},{key:"follow",value:function(t){var e,i,o,n,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t?(this._followedEntity=t,this._followConfig={behavior:s.behavior||"center",offset:{x:(null===(e=s.offset)||void 0===e?void 0:e.x)||0,y:(null===(i=s.offset)||void 0===i?void 0:i.y)||0},deadzone:{x:(null===(o=s.deadzone)||void 0===o?void 0:o.x)||0,y:(null===(n=s.deadzone)||void 0===n?void 0:n.y)||0},smooth:void 0===s.smooth||s.smooth,smoothSpeed:s.smoothSpeed||.1},this._followConfig.smoothSpeed=Math.min(Math.max(this._followConfig.smoothSpeed,0),1),this):this}},{key:"cancelFollow",value:function(){return this._followedEntity=null,this._followConfig=null,this._followOffset={x:0,y:0},this}},{key:"_calculateFollowPosition",value:function(){if(!this._followedEntity||!this._followConfig)return null;var t=this._followedEntity,e=this._followConfig,i=this.engine.baseWidth/this.zoom,o=this.engine.baseHeight/this.zoom,n=this.x,s=this.y,r=t.absoluteX+t.width/2,a=t.absoluteY+t.height/2,l=this.x,h=this.x+i,c=this.y,m=this.y+o,u=e.deadzone.x,y=e.deadzone.y;switch(e.behavior){case"center":n=r-i/2+e.offset.x,s=a-o/2+e.offset.y;break;case"edge":r<l+u?n=r-u:r>h-u&&(n=r+u-i),a<c+y?s=a-y:a>m-y&&(s=a+y-o);break;case"horizontal-edge":r<l+u?n=r-u:r>h-u&&(n=r+u-i);break;case"vertical-edge":a<c+y?s=a-y:a>m-y&&(s=a+y-o);break;case"top":n=r-i/2+e.offset.x,s=a-y+e.offset.y;break;case"bottom":n=r-i/2+e.offset.x,s=a+y-o+e.offset.y;break;case"left":n=r-u+e.offset.x,s=a-o/2+e.offset.y;break;case"right":n=r+u-i+e.offset.x,s=a-o/2+e.offset.y}return this.bounds&&(n=this.bounds.width>i?Math.min(Math.max(n,this.bounds.x),this.bounds.x+this.bounds.width-i):this.bounds.x+(this.bounds.width-i)/2,s=this.bounds.height>o?Math.min(Math.max(s,this.bounds.y),this.bounds.y+this.bounds.height-o):this.bounds.y+(this.bounds.height-o)/2),{x:n,y:s}}},{key:"saveState",value:function(t){if(!t)throw new Error("Status name cannot be empty.");var e={x:this.x,y:this.y,zoom:this.zoom,_targetX:this._targetX,_targetY:this._targetY,_targetZoom:this._targetZoom,smoothing:this.smoothing,smoothSpeed:this.smoothSpeed,bounds:this.bounds?J({},this.bounds):null,minZoom:this.minZoom,maxZoom:this.maxZoom,_followedEntity:this._followedEntity,_followConfig:this._followConfig?J({},this._followConfig):null,_followOffset:J({},this._followOffset),timestamp:(new Date).toISOString()};return this._states.set(t,e),this}},{key:"loadState",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=this._states.get(t);if(!i)throw new Error('No status with name "'.concat(t,'" found.'));var o=e.smooth,n=void 0!==o&&o,s=e.duration,r=void 0===s?500:s;return n?this.zoomTo({zoom:i.zoom,centerX:i.x+this.engine.baseWidth/i.zoom/2,centerY:i.y+this.engine.baseHeight/i.zoom/2,duration:r}):(this.x=this._targetX=i.x,this.y=this._targetY=i.y,this.zoom=this._targetZoom=i.zoom),this.smoothing=i.smoothing,this.smoothSpeed=i.smoothSpeed,this.bounds=i.bounds?J({},i.bounds):null,this.minZoom=i.minZoom,this.maxZoom=i.maxZoom,i._followedEntity?(this._followedEntity=i._followedEntity,this._followConfig=i._followConfig?J({},i._followConfig):null,this._followOffset=J({},i._followOffset)):this.cancelFollow(),this}},{key:"deleteState",value:function(t){return this._states.delete(t)}},{key:"getStatesList",value:function(){return Array.from(this._states.keys())}},{key:"hasState",value:function(t){return this._states.has(t)}},{key:"shake",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};"number"==typeof e&&(e={intensity:e});var i=e,o=i.intensity,n=void 0===o?5:o,s=i.duration,r=void 0===s?500:s,a=(i.frequency,i.falloff),l=void 0===a?"linear":a,h=Date.now(),c=this.x,m=this.y;return this._effects.shake={animate:function(){var e=Date.now()-h;if(e<r){var i=e/r,o="linear"===l?n*(1-i):n*Math.pow(1-i,2),s=2*(Math.random()-.5)*o,a=2*(Math.random()-.5)*o,u=c+s,y=m+a;if(t.bounds){var p=t.engine.baseWidth/t.zoom,_=t.engine.baseHeight/t.zoom;u=t.bounds.width>p?Math.min(Math.max(u,t.bounds.x),t.bounds.x+t.bounds.width-p):t.bounds.x+(t.bounds.width-p)/2,y=t.bounds.height>_?Math.min(Math.max(y,t.bounds.y),t.bounds.y+t.bounds.height-_):t.bounds.y+(t.bounds.height-_)/2}return t.x=u,t.y=y,!0}if(t.bounds){var f=t.engine.baseWidth/t.zoom,d=t.engine.baseHeight/t.zoom;t.bounds.width>f?t.x=Math.min(Math.max(c,t.bounds.x),t.bounds.x+t.bounds.width-f):t.x=t.bounds.x+(t.bounds.width-f)/2,t.bounds.height>d?t.y=Math.min(Math.max(m,t.bounds.y),t.bounds.y+t.bounds.height-d):t.y=t.bounds.y+(t.bounds.height-d)/2}else t.x=c,t.y=m;return t._effects.shake=null,!1}},this}},{key:"setCinematicMode",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=e.duration,o=void 0===i?1e3:i,n=e.ratio,s=void 0===n?2.35:n,r=(this.engine.baseHeight-this.engine.baseWidth/s)/2,a=Date.now();return this._effects.cinematic={animate:function(e){var i=Date.now()-a,n=Math.min(i/o,1),s=r*n;return e.fillStyle="black",e.fillRect(0,0,t.engine.baseWidth,s),e.fillRect(0,t.engine.baseHeight-s,t.engine.baseWidth,s),n<1}},this}},{key:"fade",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=e.type,o=void 0===i?"in":i,n=e.color,s=void 0===n?"black":n,r=e.duration,a=void 0===r?1e3:r,l=Date.now();return this._effects.fade={animate:function(e){var i=Date.now()-l,n=Math.min(i/a,1),r="in"===o?1-n:n;return e.fillStyle=s,e.globalAlpha=r,e.fillRect(0,0,t.engine.baseWidth,t.engine.baseHeight),e.globalAlpha=1,n<1}},this}},{key:"dramaticFocus",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,n=this.zoom,s=this.x,r=this.y,a=Date.now(),l=t.x-this.engine.baseWidth/o/2,h=t.y-this.engine.baseHeight/o/2;return this._effects.dramaticFocus={animate:function(){var t=Date.now()-a,c=Math.min(t/i,1),m=e.engine.Ease.easeInOutCubic(c);return e.zoom=n+(o-n)*m,e.x=s+(l-s)*m,e.y=r+(h-r)*m,c<1}},this}},{key:"updateEffects",value:function(t){for(var e=0,i=Object.entries(this._effects);e<i.length;e++){var o=E(i[e],2),n=o[0],s=o[1];s&&!s.animate(t)&&(this._effects[n]=null)}}}])}();const W=X;function Y(t){return Y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Y(t)}function q(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,U(o.key),o)}}function U(t){var e=function(t,e){if("object"!=Y(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var o=i.call(t,e||"default");if("object"!=Y(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==Y(e)?e:e+""}var K=function(){return function(t,e,i){return e&&q(t.prototype,e),i&&q(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.engine=e,this.layers=new Map,this.layerCounter=0},[{key:"add",value:function(t){var e,i,o,n,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=s.id||"bg_layer_".concat(++this.layerCounter),a=this._detectSourceType(t),l={id:r,source:t,sourceType:a,asset:"asset"===a?this.engine.getAsset(t):null,x:s.x||0,y:s.y||0,scale:s.scale||1,rotation:s.rotation||0,opacity:void 0!==s.opacity?s.opacity:1,parallax:void 0!==s.parallax?s.parallax:1,parallaxX:void 0!==s.parallaxX?s.parallaxX:s.parallax||1,parallaxY:void 0!==s.parallaxY?s.parallaxY:s.parallax||1,repeat:s.repeat||"none",speed:{x:(null===(e=s.speed)||void 0===e?void 0:e.x)||0,y:(null===(i=s.speed)||void 0===i?void 0:i.y)||0},offset:{x:(null===(o=s.offset)||void 0===o?void 0:o.x)||0,y:(null===(n=s.offset)||void 0===n?void 0:n.y)||0},top:s.top||!1,zIndex:s.zIndex||0,visible:void 0===s.visible||s.visible,_currentOffset:{x:0,y:0}};return"asset"!==a||l.asset?(this.layers.set(r,l),r):(this.engine.warn("Background asset '".concat(t,"' not found")),null)}},{key:"get",value:function(t){return this.layers.get(t)||null}},{key:"remove",value:function(t){return this.layers.delete(t)}},{key:"clear",value:function(){return this.layers.clear(),this.layerCounter=0,this}},{key:"setOrder",value:function(t,e){var i=this.layers.get(t);return!!i&&(i.zIndex=e,!0)}},{key:"setVisible",value:function(t,e){var i=this.layers.get(t);return!!i&&(i.visible=e,!0)}},{key:"update",value:function(t,e){var i=this.layers.get(t);return!!i&&(Object.keys(e).forEach(function(t){"speed"===t||"offset"===t?Object.assign(i[t],e[t]):i[t]=e[t]}),!0)}},{key:"_updateLayers",value:function(t){this.layers.forEach(function(e){e.visible&&(e._currentOffset.x+=e.speed.x*(t/1e3),e._currentOffset.y+=e.speed.y*(t/1e3))})}},{key:"_renderLayers",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];Array.from(this.layers.values()).filter(function(t){return t.visible&&t.top===i}).sort(function(t,e){return t.zIndex-e.zIndex}).forEach(function(i){e._renderLayer(t,i)})}},{key:"_renderLayer",value:function(t,e){t.save(),e.opacity<1&&(t.globalAlpha=e.opacity);var i=this.engine.camera,o=Math.floor(i.x),n=Math.floor(i.y),s=this.engine.baseWidth/i.zoom,r=this.engine.baseHeight/i.zoom,a=o*(1-e.parallaxX),l=n*(1-e.parallaxY),h=e.x+a+e.offset.x+e._currentOffset.x,c=e.y+l+e.offset.y+e._currentOffset.y;"color"===e.sourceType?this._renderColorBackground(t,e,h,c,o,n,s,r):"asset"===e.sourceType&&e.asset&&this._renderImageBackground(t,e,h,c,o,n,s,r),t.restore()}},{key:"_renderColorBackground",value:function(t,e,i,o,n,s,r,a){t.fillStyle=e.source,t.fillRect(n,s,r,a)}},{key:"_renderImageBackground",value:function(t,e,i,o,n,s,r,a){var l=e.asset.asset;t.imageSmoothingEnabled=!1,"none"===e.repeat?this._renderSingleImage(t,e,l,i,o):this._renderRepeatingBackground(t,e,l,i,o,n,s,r,a)}},{key:"_renderSingleImage",value:function(t,e,i,o,n){var s=i.width*e.scale,r=i.height*e.scale;0!==e.rotation?(t.save(),t.translate(o+s/2,n+r/2),t.rotate(e.rotation),t.scale(e.scale,e.scale),t.drawImage(i,-i.width/2,-i.height/2),t.restore()):t.drawImage(i,o,n,s,r)}},{key:"_renderRepeatingBackground",value:function(t,e,i,o,n,s,r,a,l){var h=i.width*e.scale,c=i.height*e.scale,m=0,u=1,y=0,p=1;if("x"===e.repeat||"both"===e.repeat){var _=s-o;m=Math.floor(_/h)-1,u=Math.ceil((_+a)/h)+1}if("y"===e.repeat||"both"===e.repeat){var f=r-n;y=Math.floor(f/c)-1,p=Math.ceil((f+l)/c)+1}for(var d=y;d<p;d++)for(var v=m;v<u;v++){var b=o+v*h,x=n+d*c;b+h<s||b>s+a||x+c<r||x>r+l||(0!==e.rotation?(t.save(),t.translate(b+h/2,x+c/2),t.rotate(e.rotation),t.scale(e.scale,e.scale),t.drawImage(i,-i.width/2,-i.height/2),t.restore()):t.drawImage(i,b,x,h,c))}}},{key:"_detectSourceType",value:function(t){if(this.engine.getAsset(t))return"asset";return"string"==typeof t&&/^(#[0-9a-fA-F]{3,8}|rgb\(|rgba\(|hsl\(|hsla\(|[a-zA-Z]+)$/.test(t.trim())?"color":void 0}}])}();const Z=K;function H(t){return H="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},H(t)}function Q(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,$(o.key),o)}}function $(t){var e=function(t,e){if("object"!=H(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var o=i.call(t,e||"default");if("object"!=H(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==H(e)?e:e+""}var tt=function(){return function(t,e,i){return e&&Q(t.prototype,e),i&&Q(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.engine=e,this.enabled=!1!==i.enabled,this.width=i.width||32,this.height=i.height||32,this.color=i.color||"rgba(0,0,0,0.3)",this.lineWidth=i.lineWidth||1,this.majorGridEvery=i.majorGridEvery||5,this.majorColor=i.majorColor||"rgba(0,0,0,0.6)",this.majorLineWidth=i.majorLineWidth||2,this.bounds=i.bounds||null,this.minZoomToShow=i.minZoomToShow||.1,this.maxZoomToShow=i.maxZoomToShow||10,this.maxLines=i.maxLines||1e3,this.originX=i.originX||0,this.originY=i.originY||0},[{key:"render",value:function(t){if(this.enabled){var e=this.engine.camera,i=e.zoom;if(!(i<this.minZoomToShow||i>this.maxZoomToShow)){t.save();var o=this.engine.baseWidth/i,n=this.engine.baseHeight/i,s=e.x,r=e.y,a=s+o,l=r+n,h=this.bounds?Math.max(s,this.bounds.x):s,c=this.bounds?Math.max(r,this.bounds.y):r,m=this.bounds?Math.min(a,this.bounds.x+this.bounds.width):a,u=this.bounds?Math.min(l,this.bounds.y+this.bounds.height):l,y=Math.floor((h-this.originX)/this.width)*this.width+this.originX,p=Math.floor((c-this.originY)/this.height)*this.height+this.originY;if(Math.ceil((m-y)/this.width)+Math.ceil((u-p)/this.height)>this.maxLines)t.restore();else{var _=Math.min(i/2,1);t.beginPath(),t.strokeStyle=this.engine.adjustAlpha(this.color,_),t.lineWidth=this.lineWidth/i;for(var f=y;f<=m;f+=this.width)if(!(f<h)){var d,v=Math.round((f-this.originX)/this.width);if(!(this.majorGridEvery>0&&v%this.majorGridEvery===0))t.moveTo(f,Math.max(c,(null===(d=this.bounds)||void 0===d?void 0:d.y)||c)),t.lineTo(f,Math.min(u,this.bounds?this.bounds.y+this.bounds.height:u))}t.stroke(),t.beginPath();for(var b=p;b<=u;b+=this.height)if(!(b<c)){var x,g=Math.round((b-this.originY)/this.height);if(!(this.majorGridEvery>0&&g%this.majorGridEvery===0))t.moveTo(Math.max(h,(null===(x=this.bounds)||void 0===x?void 0:x.x)||h),b),t.lineTo(Math.min(m,this.bounds?this.bounds.x+this.bounds.width:m),b)}if(t.stroke(),this.majorGridEvery>0){t.beginPath(),t.strokeStyle=this.engine.adjustAlpha(this.majorColor,_),t.lineWidth=this.majorLineWidth/i;for(var w=y;w<=m;w+=this.width){var C;if(!(w<h))if(Math.round((w-this.originX)/this.width)%this.majorGridEvery===0)t.moveTo(w,Math.max(c,(null===(C=this.bounds)||void 0===C?void 0:C.y)||c)),t.lineTo(w,Math.min(u,this.bounds?this.bounds.y+this.bounds.height:u))}for(var S=p;S<=u;S+=this.height){var A;if(!(S<c))if(Math.round((S-this.originY)/this.height)%this.majorGridEvery===0)t.moveTo(Math.max(h,(null===(A=this.bounds)||void 0===A?void 0:A.x)||h),S),t.lineTo(Math.min(m,this.bounds?this.bounds.x+this.bounds.width:m),S)}t.stroke()}t.restore()}}}}},{key:"snapToGrid",value:function(t,e){return{x:Math.round((t-this.originX)/this.width)*this.width+this.originX,y:Math.round((e-this.originY)/this.height)*this.height+this.originY}}},{key:"getGridCell",value:function(t,e){return{x:Math.floor((t-this.originX)/this.width),y:Math.floor((e-this.originY)/this.height)}}},{key:"cellToWorld",value:function(t,e){return{x:t*this.width+this.originX,y:e*this.height+this.originY}}},{key:"setEnabled",value:function(t){return this.enabled=t,this}},{key:"setSize",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t;return this.width=t,this.height=e,this}},{key:"setColors",value:function(t,e){return t&&(this.color=t),e&&(this.majorColor=e),this}},{key:"setLineWidth",value:function(t,e){return void 0!==t&&(this.lineWidth=t),void 0!==e&&(this.majorLineWidth=e),this}},{key:"setMajorGrid",value:function(t,e,i){return void 0!==t&&(this.majorGridEvery=t),e&&(this.majorColor=e),void 0!==i&&(this.majorLineWidth=i),this}},{key:"setBounds",value:function(t){return this.bounds=t,this}},{key:"setOrigin",value:function(t,e){return this.originX=t,this.originY=e,this}},{key:"setVisibilityRange",value:function(t,e){return void 0!==t&&(this.minZoomToShow=t),void 0!==e&&(this.maxZoomToShow=e),this}}])}();const et=tt;function it(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=function(t,e){if(t){if("string"==typeof t)return ot(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?ot(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var o=0,n=function(){};return{s:n,n:function(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return r=t.done,t},e:function(t){a=!0,s=t},f:function(){try{r||null==i.return||i.return()}finally{if(a)throw s}}}}function ot(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,o=Array(e);i<e;i++)o[i]=t[i];return o}function nt(t){return nt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},nt(t)}function st(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,o)}return i}function rt(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?st(Object(i),!0).forEach(function(e){at(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):st(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function at(t,e,i){return(e=ht(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function lt(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,ht(o.key),o)}}function ht(t){var e=function(t,e){if("object"!=nt(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var o=i.call(t,e||"default");if("object"!=nt(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==nt(e)?e:e+""}function ct(t,e){(function(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")})(t,e),e.add(t)}function mt(t,e,i){if("function"==typeof t?t===e:t.has(e))return arguments.length<3?e:i;throw new TypeError("Private element is not present on this object")}var ut=new WeakSet,yt=function(){function t(e){var i,o,n,s,r,a,l,h,c,m=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),ct(this,ut),this.engine=m.engine,this.id=e,this.x=m.x||0,this.y=m.y||0,this.width=m.width||32,this.height=m.height||32,this.parent=null,this.children=new Map,this.absoluteX=this.x,this.absoluteY=this.y,this.constrainToParent=null===(i=m.constrainToParent)||void 0===i||i,this.styles=rt(rt({},mt(ut,this,pt).call(this,m)),{},{color:m.color||"#000000",opacity:m.opacity||1,shape:m.shape||"rectangle",borderColor:m.borderColor,borderWidth:m.borderWidth||0,borderStyle:m.borderStyle||"solid",borderRadius:m.borderRadius||0,shadowColor:m.shadowColor,shadowBlur:m.shadowBlur||0,shadowOffsetX:m.shadowOffsetX||0,shadowOffsetY:m.shadowOffsetY||0,blur:m.blur||0,rotation:m.rotation||0,scale:m.scale||1,scaleX:m.scaleX||1,scaleY:m.scaleY||1,skewX:m.skewX||0,skewY:m.skewY||0,flipX:m.flipX||!1,flipY:m.flipY||!1,text:m.text,font:m.font||"16px Arial",textAlign:m.textAlign||"center",textBaseline:m.textBaseline||"middle",lineHeight:m.lineHeight||1.2,transition:m.transition||{},animation:m.animation||{},visible:null===(o=m.visible)||void 0===o||o,blendMode:m.blendMode||"source-over",clip:m.clip,mask:m.mask,filter:m.filter,points:m.points||[],roundness:m.roundness||0,customPath:m.customPath?m.customPath.bind(this):null}),this.collision={enabled:Boolean(m.collision),group:(null===(n=m.collision)||void 0===n?void 0:n.group)||"group_".concat(e),points:(null===(s=m.collision)||void 0===s?void 0:s.points)||null},this.physics=null!==(r=m.physics)&&void 0!==r&&r,this.events={hoverable:Boolean(m.hoverable),draggable:Boolean(m.draggable),clickable:Boolean(m.clickable)},this.eventListeners=new Map,this.animationStates=new Map,this.zIndex=m.zIndex||0,this.defaultZIndex=this.zIndex,this.sprite=m.sprite?{asset:this.engine.getAsset(m.sprite.asset),width:(null===(a=m.sprite)||void 0===a?void 0:a.width)||null,height:(null===(l=m.sprite)||void 0===l?void 0:l.height)||null,x:(null===(h=m.sprite)||void 0===h?void 0:h.x)||0,y:(null===(c=m.sprite)||void 0===c?void 0:c.y)||0,currentFrame:0,currentAnimation:null,lastFrameUpdate:0,animations:m.sprite.animations||{},defaultAnimation:m.sprite.defaultAnimation,playing:!1,frameTimer:null}:null,this.sprite&&this.sprite.defaultAnimation&&this.play(this.sprite.defaultAnimation)}return function(t,e,i){return e&&lt(t.prototype,e),i&&lt(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(t,[{key:"on",value:function(t,e){var i=this;if(Array.isArray(t))return t.forEach(function(t){i.on(t,e)}),this;if("object"===nt(t)){for(var o in t)this.on(o,t[o]);return this}return this.eventListeners.has(t)||this.eventListeners.set(t,new Set),this.eventListeners.get(t).add(e),this}},{key:"off",value:function(t,e){var i=this;return Array.isArray(t)?(t.forEach(function(t){i.on(t,e)}),this):(this.eventListeners.has(t)&&this.eventListeners.get(t).delete(e),this)}},{key:"trigger",value:function(t){var e=this;if(Array.isArray(t))return t.forEach(function(t){e.trigger(t,data)}),this;if(!this.eventListeners.has(t))return this;for(var i=this.eventListeners.get(t),o=arguments.length,n=new Array(o>1?o-1:0),s=1;s<o;s++)n[s-1]=arguments[s];var r,a=it(i);try{for(a.s();!(r=a.n()).done;){r.value.apply(this,n)}}catch(t){a.e(t)}finally{a.f()}return this}},{key:"isHoverable",value:function(){return this.events.hoverable}},{key:"isDraggable",value:function(){return this.events.draggable}},{key:"isClickable",value:function(){return this.events.clickable}},{key:"append",value:function(e){var i,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e instanceof t?e=(i=e).id:i=new t(e,rt(rt({},o),{},{engine:this.engine})),i.parent=this,this.children.set(e,i),i.move({x:0,y:0,relative:!this.engine.physicsEnabled}),i}},{key:"layer",value:function(t){if("number"==typeof t)this.zIndex=t;else switch(t){case"above":this.zIndex=999999;break;case"below":this.zIndex=-999999;break;case"top":this.zIndex=100;break;case"bottom":this.zIndex=-100;break;case"reset":this.zIndex=this.defaultZIndex;break;default:this.zIndex=0}return this}},{key:"find",value:function(t){return this.children.get(t)}},{key:"getEntities",value:function(){var t=[this],e=function(i){i.children.forEach(function(i){t.push(i),e(i)})};return e(this),t}},{key:"clone",value:function(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,o=rt(rt(rt({x:this.x,y:this.y,width:this.width,height:this.height,engine:this.engine,constrainToParent:this.constrainToParent,zIndex:this.zIndex},this.styles),this.events),{},{collision:rt(rt({},this.collision),{},{points:null!==(e=this.collision)&&void 0!==e&&e.points?JSON.parse(JSON.stringify(this.collision.points)):null}),physics:this.physics}),n=new t(i||"".concat(this.id,"_clone_").concat(Date.now()),o);return n.defaultZIndex=this.defaultZIndex,this.eventListeners.forEach(function(t,e){t.forEach(function(t){n.on(e,t)})}),this.animationStates.forEach(function(t,e){n.animationStates.set(e,rt({},t))}),this.sprite&&(n.sprite=rt(rt({},this.sprite),{},{animations:JSON.parse(JSON.stringify(this.sprite.animations)),asset:this.sprite.asset,currentFrame:0,currentAnimation:null,lastFrameUpdate:0,playing:!1,frameTimer:null}),n.sprite.defaultAnimation&&n.play(n.sprite.defaultAnimation)),this.styles.mask instanceof t&&(n.styles.mask=this.styles.mask.clone()),this.children.forEach(function(t,e){var i=t.clone();i.parent=n,n.children.set(e,i)}),n}},{key:"updatePosition",value:function(){this.parent?(this.absoluteX=this.parent.absoluteX+this.x,this.absoluteY=this.parent.absoluteY+this.y):(this.absoluteX=this.x,this.absoluteY=this.y),this.children.forEach(function(t){return t.updatePosition()})}},{key:"transition",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};"string"==typeof t&&(i=arguments[2]||{},t=at({},t,arguments[1]));i=rt({duration:300,easing:"linear",delay:0},i);var o={};Object.keys(t).forEach(function(t){o[t]=e.styles[t]});var n=performance.now()+i.delay,s="function"==typeof i.easing?i.easing:this.engine.Ease[i.easing]||this.engine.Ease.linear,r=function(a){if(a<n)requestAnimationFrame(r);else{var l=a-n;if(l>=i.duration)return e.style(t),void("function"==typeof i.complete&&i.complete.call(e));var h=l/i.duration,c=s(h),m={};Object.keys(t).forEach(function(i){var n=o[i],s=t[i];"number"==typeof n?m[i]=n+(s-n)*c:"string"==typeof n&&n.startsWith("#")&&(m[i]=e._interpolateColor(n,s,c))}),e.style(m),requestAnimationFrame(r)}};return requestAnimationFrame(r),this}},{key:"startAnimation",value:function(t){var e=this,i=this.engine.animations[t];if(!i)return this;var o=this.animationStates.get(t)||{currentFrame:0,repeat:i.options.repeat,isRunning:!0};o.isRunning=!0,this.animationStates.set(t,o);var n=function(){if(o.isRunning){var t=i.keyframes[o.currentFrame];if(e.style(t),o.currentFrame++,o.currentFrame>=i.keyframes.length){if(!("infinite"===o.repeat||o.repeat>0))return void(o.isRunning=!1);o.currentFrame=0,"number"==typeof o.repeat&&o.repeat--}setTimeout(function(){return requestAnimationFrame(n)},i.options.duration/i.keyframes.length)}};return requestAnimationFrame(n),this}},{key:"stopAnimation",value:function(t){if(!this.animationStates)return this;if(t){var e=this.animationStates.get(t);e&&(e.isRunning=!1,e.currentFrame=0)}else this.animationStates.forEach(function(t){t.isRunning=!1,t.currentFrame=0});return this}},{key:"style",value:function(t,e){return"object"===nt(t)?(("x"in t||"y"in t)&&(Object.assign(this,t),this.updatePosition()),Object.assign(this.styles,t)):"x"===t||"y"===t?(this[t]=e,this.updatePosition()):this.styles[t]=e,this}},{key:"text",value:function(t){return void 0===t?this.styles.text:(this.styles.text=t,this)}},{key:"img",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=this.engine.getAsset(t);if(!i)throw new Error("Asset not found.");return this.style({backgroundColor:"transparent",backgroundImage:i.asset,backgroundImageFit:e.fit||"cover",backgroundImagePosition:e.position||"center",backgroundImageRepeat:e.repeat||!1})}},{key:"move",value:function(t){var e=this;"number"==typeof t&&(t={x:t,y:arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,duration:(arguments.length>2&&void 0!==arguments[2]?arguments[2]:0)||0});var i=rt({x:this.x,y:this.y,duration:0,easing:"linear",relative:!0},t);i.relative&&("x"in t&&(i.x=this.x+(t.x||0)),"y"in t&&(i.y=this.y+(t.y||0)));var o=i.x-this.x,n=i.y-this.y;if(!i.duration)return this.style({x:i.x,y:i.y}),i.onComplete&&i.onComplete.call(this),this;var s=this.getEntities(),r=new Map;s.forEach(function(t){r.set(t,{x:t.x,y:t.y,absoluteX:t.absoluteX,absoluteY:t.absoluteY})});var a=performance.now(),l="function"==typeof i.easing?i.easing:this.engine.Ease[i.easing]||this.engine.Ease.linear,h=function(t){var c=t-a;if(c>=i.duration)return e.style({x:i.x,y:i.y}),void(i.onComplete&&i.onComplete.call(e));var m=c/i.duration,u=l(m);s.forEach(function(t){var i=r.get(t);if(t===e)t.style({x:i.x+o*u,y:i.y+n*u});else{var s={x:i.x,y:i.y};t.style({x:s.x,y:s.y})}}),i.onUpdate&&i.onUpdate.call(e,u),requestAnimationFrame(h)};return requestAnimationFrame(h),this}},{key:"hide",value:function(){this.style("visible",!1)}},{key:"show",value:function(){this.style("visible",!0)}},{key:"play",value:function(t){var e,i=this;if(t=t||this.sprite.currentAnimation,!this.sprite||!this.sprite.animations[t])return this;var o=this.sprite.currentAnimation;this.stop();var n=this.sprite.animations[t];this.sprite.currentAnimation=t,this.sprite.currentFrame=0,this.sprite.playing=!0,this.sprite.lastFrameUpdate=performance.now(),this.trigger("animationStart",t),null===(e=n.onStart)||void 0===e||e.call(this),o!==t&&this.trigger("animationChange",o,t);var s=function(){if(i.sprite.playing){var e=performance.now();if(e-i.sprite.lastFrameUpdate>=1e3/n.frameRate){var o,r=i.sprite.currentFrame;if(i.sprite.currentFrame++,i.sprite.lastFrameUpdate=e,r!==i.sprite.currentFrame)i.trigger("frameChange",i.sprite.currentFrame),null===(o=n.onFrame)||void 0===o||o.call(i,i.sprite.currentFrame);if(i.sprite.currentFrame>=n.frames.length){var a,l;if(!n.loop)return i.stop(),i.trigger("animationEnd",t),void(null===(a=n.onEnd)||void 0===a||a.call(i));i.sprite.currentFrame=0,null===(l=n.onLoop)||void 0===l||l.call(i)}}i.sprite.frameTimer=requestAnimationFrame(s)}};return s(),this}},{key:"pause",value:function(){return this.sprite&&this.sprite.playing?(this.sprite.playing=!1,this.sprite.frameTimer&&(cancelAnimationFrame(this.sprite.frameTimer),this.sprite.frameTimer=null),this.trigger("animationPause",this.sprite.currentAnimation),this):this}},{key:"resume",value:function(){if(!this.sprite||this.sprite.playing)return this;var t=this.sprite.currentFrame;return this.sprite.playing=!0,this.play(this.sprite.currentAnimation),this.sprite.currentFrame=t,this.trigger("animationResume",this.sprite.currentAnimation),this}},{key:"stop",value:function(){if(!this.sprite)return this;var t=this.sprite.currentAnimation;return this.sprite.playing=!1,this.sprite.currentFrame=0,this.sprite.frameTimer&&(cancelAnimationFrame(this.sprite.frameTimer),this.sprite.frameTimer=null),t&&this.trigger("animationStop",t),this}},{key:"isPlaying",value:function(){var t;return(null===(t=this.sprite)||void 0===t?void 0:t.playing)||!1}},{key:"setSpriteAsset",value:function(t){return"spritesheet"!==(t=this.engine.getAsset(t)).type||(this.sprite.asset=t,this.trigger("spriteAssetChanged",t.id)),this}},{key:"addAnimation",value:function(t,e){return this.sprite?(this.sprite.animations[t]=e,this):this}},{key:"setAnimations",value:function(t){return this.sprite?(this.sprite.animations=t,this):this}},{key:"getCurrentAnimation",value:function(){var t;return(null===(t=this.sprite)||void 0===t?void 0:t.currentAnimation)||null}},{key:"setFrame",value:function(t){return!this.sprite||!this.sprite.currentAnimation||t>=this.sprite.animations[this.sprite.currentAnimation].frames.length||(this.sprite.currentFrame=t),this}},{key:"getCurrentFrame",value:function(){return this.sprite&&this.sprite.currentAnimation?this.sprite.animations[this.sprite.currentAnimation].frames[this.sprite.currentFrame]:null}},{key:"setFrameRate",value:function(t,e){return this.sprite&&this.sprite.animations[t]?(this.sprite.animations[t].frameRate=e,this):this}},{key:"render",value:function(t){var e;if(this.styles.visible){t.save(),this.trigger("beforerender",t),t.translate(this.absoluteX+this.width/2,this.absoluteY+this.height/2),t.rotate(this.styles.rotation*Math.PI/180),t.scale((this.styles.flipX?-1:1)*this.styles.scaleX*this.styles.scale,(this.styles.flipY?-1:1)*this.styles.scaleY*this.styles.scale),t.transform(1,this.styles.skewY,this.styles.skewX,1,0,0),t.globalAlpha=this.styles.opacity,t.globalCompositeOperation=this.styles.blendMode,this._applyFilters(t),this._applyClip(t),this.styles.shadowColor&&(t.shadowColor=this.styles.shadowColor,t.shadowBlur=this.styles.shadowBlur,t.shadowOffsetX=this.styles.shadowOffsetX,t.shadowOffsetY=this.styles.shadowOffsetY);var i=this.styles.borderRadius>0;i&&(t.save(),this._clipPath(t)),this.trigger("render",t),this.sprite?this._renderSprite(t):(this.styles.backgroundImage&&this._renderBackgroundImage(t),this.styles.customPath?this._renderCustomPath(t):this.renderShape(t)),this.styles.text&&this._renderText(t),this._applyMask(t),i&&t.restore(),this.trigger("afterrender",t),t.restore(),null!==(e=this.engine)&&void 0!==e&&null!==(e=e.debugger)&&void 0!==e&&e.active&&(t.save(),t.globalCompositeOperation="source-over",t.translate(this.absoluteX+this.width/2,this.absoluteY+this.height/2),t.rotate(this.styles.rotation*Math.PI/180),t.scale((this.styles.flipX?-1:1)*this.styles.scaleX*this.styles.scale,(this.styles.flipY?-1:1)*this.styles.scaleY*this.styles.scale),t.transform(1,this.styles.skewY,this.styles.skewX,1,0,0),this._renderDebugInfo(t),t.restore()),this.children.size>0&&this.children.forEach(function(e){e.styles.visible&&e.render(t)})}}},{key:"renderShape",value:function(t){switch(this.styles.shape){case"circle":this.renderCircle(t);break;case"triangle":this.renderTriangle(t);break;case"star":this.renderStar(t);break;case"polygon":this.renderPolygon(t);break;default:this.renderRectangle(t)}}},{key:"renderRectangle",value:function(t){var e=this.width,i=this.height;if(this.styles.borderRadius>0){var o=this.styles.borderRadius;t.beginPath(),t.moveTo(-e/2+o,-i/2),t.lineTo(e/2-o,-i/2),t.arcTo(e/2,-i/2,e/2,-i/2+o,o),t.lineTo(e/2,i/2-o),t.arcTo(e/2,i/2,e/2-o,i/2,o),t.lineTo(-e/2+o,i/2),t.arcTo(-e/2,i/2,-e/2,i/2-o,o),t.lineTo(-e/2,-i/2+o),t.arcTo(-e/2,-i/2,-e/2+o,-i/2,o),t.closePath()}else t.beginPath(),t.rect(-e/2,-i/2,e,i);this.fillAndStroke(t)}},{key:"renderCircle",value:function(t){t.beginPath(),t.arc(0,0,Math.min(this.width,this.height)/2,0,2*Math.PI),this.fillAndStroke(t)}},{key:"renderTriangle",value:function(t){var e=this.width,i=this.height;t.beginPath(),t.moveTo(0,-i/2),t.lineTo(e/2,i/2),t.lineTo(-e/2,i/2),t.closePath(),this.fillAndStroke(t)}},{key:"renderPolygon",value:function(t){if(!(this.styles.points.length<3)){if(this.styles.borderRadius>0)this._renderPolygonWithRadius(t);else{t.beginPath(),t.moveTo(this.styles.points[0].x,this.styles.points[0].y);for(var e=1;e<this.styles.points.length;e++)t.lineTo(this.styles.points[e].x,this.styles.points[e].y);t.closePath()}this.fillAndStroke(t)}}},{key:"renderStar",value:function(t){var e=Math.min(this.width,this.height)/2,i=.4*e,o=this.styles.spikes||5,n=Math.PI/o;t.beginPath(),t.moveTo(0,-e);for(var s=0;s<2*o;s++){var r=s%2==0?e:i,a=n*s-Math.PI/2;t.lineTo(Math.cos(a)*r,Math.sin(a)*r)}t.closePath(),this.fillAndStroke(t)}},{key:"fillAndStroke",value:function(t){if(this.styles.backgroundGradient){var e=this._createGradient(t);t.fillStyle=e}else t.fillStyle=this.styles.backgroundColor||this.styles.fill;this.styles.borderWidth>0&&(t.strokeStyle=this.styles.borderColor,t.lineWidth=this.styles.borderWidth,"dashed"===this.styles.borderStyle?t.setLineDash([2*this.styles.borderWidth]):"dotted"===this.styles.borderStyle&&t.setLineDash([this.styles.borderWidth])),t.fill(),this.styles.borderWidth>0&&t.stroke()}},{key:"_renderPolygonWithRadius",value:function(t){var e=this.styles.points,i=this.styles.borderRadius;t.beginPath();for(var o=0;o<e.length;o++){var n=e[o],s=e[(o+1)%e.length],r=e[(o-1+e.length)%e.length],a={x:r.x-n.x,y:r.y-n.y},l={x:s.x-n.x,y:s.y-n.y},h=Math.sqrt(a.x*a.x+a.y*a.y),c=Math.sqrt(l.x*l.x+l.y*l.y);a.x/=h,a.y/=h,l.x/=c,l.y/=c;var m=Math.min(i,h/2,c/2),u={x:n.x+a.x*m,y:n.y+a.y*m},y={x:n.x+l.x*m,y:n.y+l.y*m};0===o?t.moveTo(u.x,u.y):t.lineTo(u.x,u.y),t.quadraticCurveTo(n.x,n.y,y.x,y.y)}t.closePath()}},{key:"_renderBackgroundImage",value:function(t){if(this.styles.backgroundImage){this.styles.borderRadius>0&&this._clipPath(t),this.style("backgroundColor","transparent");var e=this.styles.backgroundImage,i=this.styles.backgroundImageFit,o=this.styles.backgroundImagePosition,n=this.styles.backgroundImageRepeat,s=this.width,r=this.height,a=-this.width/2,l=-this.height/2;if(n)t.fillStyle=t.createPattern(e,"repeat"),t.fillRect(-this.width/2,-this.height/2,this.width,this.height);else{var h="contain"===i?Math.min(this.width/e.width,this.height/e.height):"cover"===i?Math.max(this.width/e.width,this.height/e.height):1;"stretch"!==i&&(s=e.width*h,r=e.height*h),o.includes("center")?(a=-s/2,l=-r/2):(o.includes("left")&&(a=-this.width/2),o.includes("right")&&(a=this.width/2-s),o.includes("top")&&(l=-this.height/2),o.includes("bottom")&&(l=this.height/2-r)),t.drawImage(e,a,l,s,r)}}}},{key:"_renderText",value:function(t){var e=this;if(this.styles.text){t.font=this.styles.font,t.textAlign=this.styles.textAlign,t.textBaseline=this.styles.textBaseline,t.fillStyle=this.styles.color;var i=this.styles.text.toString().split("\n"),o=parseInt(this.styles.font)*this.styles.lineHeight;i.forEach(function(n,s){var r=0,a=(s-(i.length-1)/2)*o;switch(e.styles.textAlign){case"left":r=-e.width/2;break;case"right":r=e.width/2;break;default:r=0}t.fillText(n,r,a)})}}},{key:"_clipPath",value:function(t){var e=this.width,i=this.height,o=this.styles.borderRadius;o>0&&(t.beginPath(),t.moveTo(-e/2+o,-i/2),t.lineTo(e/2-o,-i/2),t.arcTo(e/2,-i/2,e/2,-i/2+o,o),t.lineTo(e/2,i/2-o),t.arcTo(e/2,i/2,e/2-o,i/2,o),t.lineTo(-e/2+o,i/2),t.arcTo(-e/2,i/2,-e/2,i/2-o,o),t.lineTo(-e/2,-i/2+o),t.arcTo(-e/2,-i/2,-e/2+o,-i/2,o),t.closePath(),t.clip())}},{key:"_applyClip",value:function(t){if(this.styles.clip)if("function"==typeof this.styles.clip)this.styles.clip.call(this,t),t.clip();else if(Array.isArray(this.styles.clip)){t.beginPath(),t.moveTo(this.styles.clip[0].x,this.styles.clip[0].y);for(var e=1;e<this.styles.clip.length;e++)t.lineTo(this.styles.clip[e].x,this.styles.clip[e].y);t.closePath(),t.clip()}}},{key:"_applyFilters",value:function(t){this.styles.blur>0&&(t.filter="blur(".concat(this.styles.blur,"px)")),this.styles.filter&&(t.filter=this.styles.filter)}},{key:"_applyMask",value:function(e){this.styles.mask&&(e.save(),"function"==typeof this.styles.mask?this.styles.mask.call(this,e):this.styles.mask instanceof t&&(e.globalCompositeOperation="destination-in",this.styles.mask.render(e)),e.restore())}},{key:"_renderCustomPath",value:function(t){"function"==typeof this.styles.customPath&&this.styles.customPath(t)}},{key:"_renderSprite",value:function(t){var e;if(this.sprite&&this.sprite.asset){var i=this.sprite.asset;if("spritesheet"===i.type){var o=this.sprite.animations[this.sprite.currentAnimation];if(o){var n=o.frames[this.sprite.currentFrame];if(i.config.frames[n]){t.save(),t.translate(-this.width/2,-this.height/2),(this.styles.backgroundColor||this.styles.backgroundGradient)&&(this.styles.backgroundGradient?t.fillStyle=this._createGradient(t):t.fillStyle=this.styles.backgroundColor,t.fillRect(0,0,this.width,this.height));var s,r,a,l=i.config,h=l.width,c=l.height,m=l.columns,u=l.margin,y=void 0===u?[0,0]:u,p=l.originOffset,_=void 0===p?[0,0]:p;if(null!==this.sprite.width&&null!==this.sprite.height)s=this.sprite.width,r=this.sprite.height,a=s/h;else{var f=this.width/h,d=this.height/c;s=h*(a=Math.max(f,d)),r=c*a}var v=.5*(this.width-s)+(this.sprite.x||0),b=.5*(this.height-r)+(this.sprite.y||0),x=n%m,g=Math.floor(n/m),w=_[0]+x*(h+y[0]),C=_[1]+g*(c+y[1]);t.drawImage(i.asset,w,C,h,c,v,b,s,r);var S={frame:{current:this.sprite.currentFrame,total:o.frames.length,index:n,data:{x:w,y:C,width:h,height:c,column:x,row:g}},timing:{lastUpdate:this.sprite.lastFrameUpdate,frameRate:o.frameRate,elapsedSinceLastFrame:performance.now()-this.sprite.lastFrameUpdate},render:{source:{x:w,y:C,width:h,height:c},target:{x:v,y:b,width:s,height:r,scale:a}},animation:{name:this.sprite.currentAnimation,isPlaying:this.sprite.playing,loop:o.loop},sprite:{asset:i.id,totalFrames:o.frames.length,config:{columns:m,rows:i.config.rows,width:h,height:c,originOffset:_,margin:y}}};this.trigger("spriteRender",S),null===(e=o.onRender)||void 0===e||e.call(this,S),this.styles.borderWidth>0&&(t.strokeStyle=this.styles.borderColor,t.lineWidth=this.styles.borderWidth,"dashed"===this.styles.borderStyle?t.setLineDash([2*this.styles.borderWidth]):"dotted"===this.styles.borderStyle&&t.setLineDash([this.styles.borderWidth]),t.strokeRect(0,0,this.width,this.height)),t.restore()}}}}}},{key:"isCollidable",value:function(){return this.collision.enabled}},{key:"enableCollision",value:function(){return this.collision.enabled=!0,this}},{key:"disableCollision",value:function(){return this.collision.enabled=!1,this}},{key:"setCollisionGroup",value:function(t){return this.collision.group=t,this}},{key:"setCollisionPoints",value:function(t){if(!Array.isArray(t)||t.length<3)throw new Error("Collision points must be an array with at least 3 points");return t.forEach(function(t){if(!t.x||!t.y)throw new Error("Each collision point must have x and y coordinates")}),this.collision.points=t,this.engine&&this.engine.collision&&this.engine.collision.clearCache(this.id),this}},{key:"clearCollisionPoints",value:function(){return this.collision.points=null,this.engine&&this.engine.collision&&this.engine.collision.clearCache(this.id),this}},{key:"getBounds",value:function(){var t={x:this.absoluteX,y:this.absoluteY,width:this.width*Math.abs(this.styles.scaleX*this.styles.scale),height:this.height*Math.abs(this.styles.scaleY*this.styles.scale)};if(0!==this.styles.rotation){var e=this.styles.rotation*Math.PI/180,i=Math.abs(Math.cos(e)),o=Math.abs(Math.sin(e)),n=t.width*i+t.height*o,s=t.width*o+t.height*i;t.width=n,t.height=s}return t}},{key:"_createGradient",value:function(t){var e,i=this.styles.backgroundGradient;return"linear"===i.type?e=t.createLinearGradient(i.x1||-this.width/2,i.y1||-this.height/2,i.x2||this.width/2,i.y2||this.height/2):"radial"===i.type&&(e=t.createRadialGradient(0,0,0,0,0,Math.max(this.width,this.height)/2)),i.stops.forEach(function(t){e.addColorStop(t.offset,t.color)}),e}},{key:"_interpolateColor",value:function(t,e,i){var o=this.engine.hexToRgb(t),n=this.engine.hexToRgb(e),s=Math.round(o.r+(n.r-o.r)*i),r=Math.round(o.g+(n.g-o.g)*i),a=Math.round(o.b+(n.b-o.b)*i);return"rgb(".concat(s,",").concat(r,",").concat(a,")")}},{key:"_renderDebugInfo",value:function(t){this.collision.enabled&&(t.lineWidth=1,this.collision.points?this._renderCustomCollisionShape(t):this._renderCollisionShape(t))}},{key:"_renderCustomCollisionShape",value:function(t){var e=this.collision.points;if(e&&!(e.length<2)){if(t.strokeStyle="rgba(255, 255, 255, 0.8)",t.beginPath(),t.moveTo(e[0].x,e[0].y),this.styles.customPath)for(var i=0;i<e.length-1;){var o=e[i],n=e[i+1],s={x:o.x+(n.x-o.x)/3,y:o.y+(n.y-o.y)/3},r={x:o.x+2*(n.x-o.x)/3,y:o.y+2*(n.y-o.y)/3};t.bezierCurveTo(s.x,s.y,r.x,r.y,n.x,n.y),i++}else for(var a=1;a<e.length;a++)t.lineTo(e[a].x,e[a].y);t.closePath(),t.stroke(),t.strokeStyle="rgba(255, 0, 0, 0.8)",t.fillStyle="rgba(255, 0, 0, 0.6)",t.fill(),t.stroke(),"advanced"===this.engine.debugger.level&&(t.fillStyle="rgba(255, 255, 255, 0.8)",e.forEach(function(e){t.beginPath(),t.arc(e.x,e.y,2,0,2*Math.PI),t.fill()}))}}},{key:"_renderCollisionShape",value:function(t){t.save();var e=rt({},this.styles);Object.assign(this.styles,{backgroundColor:"transparent",borderColor:"rgba(255, 255, 255, 0.8)",borderWidth:2}),this.renderShape(t),Object.assign(this.styles,{backgroundColor:"rgba(255, 0, 0, 0.3)",borderColor:"rgba(255, 0, 0, 0.5)",borderWidth:1,color:"rgba(255, 0, 0, 0.3)"}),this.renderShape(t),this.styles=e,t.restore()}},{key:"kill",value:function(){var t;return!!this.engine&&(this.engine.physics&&this.physics&&this.engine.physics.removeEntity(this),this.engine.draggedEntity===this&&(this.engine.draggedEntity=null),this.engine.hoveredEntity===this&&(this.engine.hoveredEntity=null),this.engine.collisionEnabled&&null!==(t=this.collision)&&void 0!==t&&t.enabled&&this.engine.collision.remove(this),this.parent&&this.parent.children.delete(this.id),this.children.forEach(function(t){return t.kill()}),this.engine.entities.delete(this.id),this.trigger("kill"),this.engine.trigger("kill",this.id),this.parent=null,this.engine=null,!0)}}])}();function pt(){var t,e,i,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n={};n.backgroundColor=null!==(t=o.fill)&&void 0!==t?t:o.backgroundColor,n.backgroundGradient=null!==(e=o.gradient)&&void 0!==e?e:o.backgroundGradient;var s=null!==(i=o.image)&&void 0!==i?i:o.backgroundImage;return"string"==typeof s?(n.backgroundImage=mt(ut,this,_t).call(this,s),n.backgroundImageFit=o.backgroundImageFit||"contain",n.backgroundImagePosition=o.backgroundImagePosition||"center",n.backgroundImageRepeat=o.backgroundImageRepeat||!1):"object"===nt(s)&&(null!=s&&s.asset||null!=s&&s.src)&&(n.backgroundImage=(null==s?void 0:s.asset)||mt(ut,this,_t).call(this,s.src),n.backgroundImageFit=s.fit||"contain",n.backgroundImagePosition=s.position||"center",n.backgroundImageRepeat=s.repeat||!1),n}function _t(t){var e,i;return"object"===nt(t)&&null!=t&&t.asset?t.asset:null===(e=(i=this.engine).getAsset)||void 0===e||null===(e=e.call(i,t))||void 0===e?void 0:e.asset}const ft=yt;var dt={};!function(t,e){function i(){}t.inherit=function(t,e){var o=t;i.prototype=e.prototype,t.prototype=new i,t.prototype.constructor=o},t.generateCallback=function(t,e){return function(){e.apply(t,arguments)}},t.NVector=function(t){t===e&&(t=0);for(var i=new Array(t||0),o=0;o<t;++o)i[o]=0;return i},t.is=function(t,i){return null!==t&&(i instanceof Function&&t instanceof i||!(t.constructor.__implements==e||!t.constructor.__implements[i]))},t.parseUInt=function(t){return Math.abs(parseInt(t))}}(dt);var vt,bt,xt=Array,gt=dt.NVector;for(void 0===dt&&(dt={}),void 0===dt.Collision&&(dt.Collision={}),void 0===dt.Collision.Shapes&&(dt.Collision.Shapes={}),void 0===dt.Common&&(dt.Common={}),void 0===dt.Common.Math&&(dt.Common.Math={}),void 0===dt.Dynamics&&(dt.Dynamics={}),void 0===dt.Dynamics.Contacts&&(dt.Dynamics.Contacts={}),void 0===dt.Dynamics.Controllers&&(dt.Dynamics.Controllers={}),void 0===dt.Dynamics.Joints&&(dt.Dynamics.Joints={}),dt.Collision.IBroadPhase="Box2D.Collision.IBroadPhase",dt.Collision.b2AABB=function t(){t.b2AABB.apply(this,arguments)},dt.Collision.b2Bound=function t(){t.b2Bound.apply(this,arguments)},dt.Collision.b2BoundValues=function t(){t.b2BoundValues.apply(this,arguments),this.constructor===t&&this.b2BoundValues.apply(this,arguments)},dt.Collision.b2Collision=function t(){t.b2Collision.apply(this,arguments)},dt.Collision.b2ContactID=function t(){t.b2ContactID.apply(this,arguments),this.constructor===t&&this.b2ContactID.apply(this,arguments)},dt.Collision.b2ContactPoint=function t(){t.b2ContactPoint.apply(this,arguments)},dt.Collision.b2Distance=function t(){t.b2Distance.apply(this,arguments)},dt.Collision.b2DistanceInput=function t(){t.b2DistanceInput.apply(this,arguments)},dt.Collision.b2DistanceOutput=function t(){t.b2DistanceOutput.apply(this,arguments)},dt.Collision.b2DistanceProxy=function t(){t.b2DistanceProxy.apply(this,arguments)},dt.Collision.b2DynamicTree=function t(){t.b2DynamicTree.apply(this,arguments),this.constructor===t&&this.b2DynamicTree.apply(this,arguments)},dt.Collision.b2DynamicTreeBroadPhase=function t(){t.b2DynamicTreeBroadPhase.apply(this,arguments)},dt.Collision.b2DynamicTreeNode=function t(){t.b2DynamicTreeNode.apply(this,arguments)},dt.Collision.b2DynamicTreePair=function t(){t.b2DynamicTreePair.apply(this,arguments)},dt.Collision.b2Manifold=function t(){t.b2Manifold.apply(this,arguments),this.constructor===t&&this.b2Manifold.apply(this,arguments)},dt.Collision.b2ManifoldPoint=function t(){t.b2ManifoldPoint.apply(this,arguments),this.constructor===t&&this.b2ManifoldPoint.apply(this,arguments)},dt.Collision.b2Point=function t(){t.b2Point.apply(this,arguments)},dt.Collision.b2RayCastInput=function t(){t.b2RayCastInput.apply(this,arguments),this.constructor===t&&this.b2RayCastInput.apply(this,arguments)},dt.Collision.b2RayCastOutput=function t(){t.b2RayCastOutput.apply(this,arguments)},dt.Collision.b2Segment=function t(){t.b2Segment.apply(this,arguments)},dt.Collision.b2SeparationFunction=function t(){t.b2SeparationFunction.apply(this,arguments)},dt.Collision.b2Simplex=function t(){t.b2Simplex.apply(this,arguments),this.constructor===t&&this.b2Simplex.apply(this,arguments)},dt.Collision.b2SimplexCache=function t(){t.b2SimplexCache.apply(this,arguments)},dt.Collision.b2SimplexVertex=function t(){t.b2SimplexVertex.apply(this,arguments)},dt.Collision.b2TimeOfImpact=function t(){t.b2TimeOfImpact.apply(this,arguments)},dt.Collision.b2TOIInput=function t(){t.b2TOIInput.apply(this,arguments)},dt.Collision.b2WorldManifold=function t(){t.b2WorldManifold.apply(this,arguments),this.constructor===t&&this.b2WorldManifold.apply(this,arguments)},dt.Collision.ClipVertex=function t(){t.ClipVertex.apply(this,arguments)},dt.Collision.Features=function t(){t.Features.apply(this,arguments)},dt.Collision.Shapes.b2CircleShape=function t(){t.b2CircleShape.apply(this,arguments),this.constructor===t&&this.b2CircleShape.apply(this,arguments)},dt.Collision.Shapes.b2EdgeChainDef=function t(){t.b2EdgeChainDef.apply(this,arguments),this.constructor===t&&this.b2EdgeChainDef.apply(this,arguments)},dt.Collision.Shapes.b2EdgeShape=function t(){t.b2EdgeShape.apply(this,arguments),this.constructor===t&&this.b2EdgeShape.apply(this,arguments)},dt.Collision.Shapes.b2MassData=function t(){t.b2MassData.apply(this,arguments)},dt.Collision.Shapes.b2PolygonShape=function t(){t.b2PolygonShape.apply(this,arguments),this.constructor===t&&this.b2PolygonShape.apply(this,arguments)},dt.Collision.Shapes.b2Shape=function t(){t.b2Shape.apply(this,arguments),this.constructor===t&&this.b2Shape.apply(this,arguments)},dt.Common.b2internal="Box2D.Common.b2internal",dt.Common.b2Color=function t(){t.b2Color.apply(this,arguments),this.constructor===t&&this.b2Color.apply(this,arguments)},dt.Common.b2Settings=function t(){t.b2Settings.apply(this,arguments)},dt.Common.Math.b2Mat22=function t(){t.b2Mat22.apply(this,arguments),this.constructor===t&&this.b2Mat22.apply(this,arguments)},dt.Common.Math.b2Mat33=function t(){t.b2Mat33.apply(this,arguments),this.constructor===t&&this.b2Mat33.apply(this,arguments)},dt.Common.Math.b2Math=function t(){t.b2Math.apply(this,arguments)},dt.Common.Math.b2Sweep=function t(){t.b2Sweep.apply(this,arguments)},dt.Common.Math.b2Transform=function t(){t.b2Transform.apply(this,arguments),this.constructor===t&&this.b2Transform.apply(this,arguments)},dt.Common.Math.b2Vec2=function t(){t.b2Vec2.apply(this,arguments),this.constructor===t&&this.b2Vec2.apply(this,arguments)},dt.Common.Math.b2Vec3=function t(){t.b2Vec3.apply(this,arguments),this.constructor===t&&this.b2Vec3.apply(this,arguments)},dt.Dynamics.b2Body=function t(){t.b2Body.apply(this,arguments),this.constructor===t&&this.b2Body.apply(this,arguments)},dt.Dynamics.b2BodyDef=function t(){t.b2BodyDef.apply(this,arguments),this.constructor===t&&this.b2BodyDef.apply(this,arguments)},dt.Dynamics.b2ContactFilter=function t(){t.b2ContactFilter.apply(this,arguments)},dt.Dynamics.b2ContactImpulse=function t(){t.b2ContactImpulse.apply(this,arguments)},dt.Dynamics.b2ContactListener=function t(){t.b2ContactListener.apply(this,arguments)},dt.Dynamics.b2ContactManager=function t(){t.b2ContactManager.apply(this,arguments),this.constructor===t&&this.b2ContactManager.apply(this,arguments)},dt.Dynamics.b2DebugDraw=function t(){t.b2DebugDraw.apply(this,arguments),this.constructor===t&&this.b2DebugDraw.apply(this,arguments)},dt.Dynamics.b2DestructionListener=function t(){t.b2DestructionListener.apply(this,arguments)},dt.Dynamics.b2FilterData=function t(){t.b2FilterData.apply(this,arguments)},dt.Dynamics.b2Fixture=function t(){t.b2Fixture.apply(this,arguments),this.constructor===t&&this.b2Fixture.apply(this,arguments)},dt.Dynamics.b2FixtureDef=function t(){t.b2FixtureDef.apply(this,arguments),this.constructor===t&&this.b2FixtureDef.apply(this,arguments)},dt.Dynamics.b2Island=function t(){t.b2Island.apply(this,arguments),this.constructor===t&&this.b2Island.apply(this,arguments)},dt.Dynamics.b2TimeStep=function t(){t.b2TimeStep.apply(this,arguments)},dt.Dynamics.b2World=function t(){t.b2World.apply(this,arguments),this.constructor===t&&this.b2World.apply(this,arguments)},dt.Dynamics.Contacts.b2CircleContact=function t(){t.b2CircleContact.apply(this,arguments)},dt.Dynamics.Contacts.b2Contact=function t(){t.b2Contact.apply(this,arguments),this.constructor===t&&this.b2Contact.apply(this,arguments)},dt.Dynamics.Contacts.b2ContactConstraint=function t(){t.b2ContactConstraint.apply(this,arguments),this.constructor===t&&this.b2ContactConstraint.apply(this,arguments)},dt.Dynamics.Contacts.b2ContactConstraintPoint=function t(){t.b2ContactConstraintPoint.apply(this,arguments)},dt.Dynamics.Contacts.b2ContactEdge=function t(){t.b2ContactEdge.apply(this,arguments)},dt.Dynamics.Contacts.b2ContactFactory=function t(){t.b2ContactFactory.apply(this,arguments),this.constructor===t&&this.b2ContactFactory.apply(this,arguments)},dt.Dynamics.Contacts.b2ContactRegister=function t(){t.b2ContactRegister.apply(this,arguments)},dt.Dynamics.Contacts.b2ContactResult=function t(){t.b2ContactResult.apply(this,arguments)},dt.Dynamics.Contacts.b2ContactSolver=function t(){t.b2ContactSolver.apply(this,arguments),this.constructor===t&&this.b2ContactSolver.apply(this,arguments)},dt.Dynamics.Contacts.b2EdgeAndCircleContact=function t(){t.b2EdgeAndCircleContact.apply(this,arguments)},dt.Dynamics.Contacts.b2NullContact=function t(){t.b2NullContact.apply(this,arguments),this.constructor===t&&this.b2NullContact.apply(this,arguments)},dt.Dynamics.Contacts.b2PolyAndCircleContact=function t(){t.b2PolyAndCircleContact.apply(this,arguments)},dt.Dynamics.Contacts.b2PolyAndEdgeContact=function t(){t.b2PolyAndEdgeContact.apply(this,arguments)},dt.Dynamics.Contacts.b2PolygonContact=function t(){t.b2PolygonContact.apply(this,arguments)},dt.Dynamics.Contacts.b2PositionSolverManifold=function t(){t.b2PositionSolverManifold.apply(this,arguments),this.constructor===t&&this.b2PositionSolverManifold.apply(this,arguments)},dt.Dynamics.Controllers.b2BuoyancyController=function t(){t.b2BuoyancyController.apply(this,arguments)},dt.Dynamics.Controllers.b2ConstantAccelController=function t(){t.b2ConstantAccelController.apply(this,arguments)},dt.Dynamics.Controllers.b2ConstantForceController=function t(){t.b2ConstantForceController.apply(this,arguments)},dt.Dynamics.Controllers.b2Controller=function t(){t.b2Controller.apply(this,arguments)},dt.Dynamics.Controllers.b2ControllerEdge=function t(){t.b2ControllerEdge.apply(this,arguments)},dt.Dynamics.Controllers.b2GravityController=function t(){t.b2GravityController.apply(this,arguments)},dt.Dynamics.Controllers.b2TensorDampingController=function t(){t.b2TensorDampingController.apply(this,arguments)},dt.Dynamics.Joints.b2DistanceJoint=function t(){t.b2DistanceJoint.apply(this,arguments),this.constructor===t&&this.b2DistanceJoint.apply(this,arguments)},dt.Dynamics.Joints.b2DistanceJointDef=function t(){t.b2DistanceJointDef.apply(this,arguments),this.constructor===t&&this.b2DistanceJointDef.apply(this,arguments)},dt.Dynamics.Joints.b2FrictionJoint=function t(){t.b2FrictionJoint.apply(this,arguments),this.constructor===t&&this.b2FrictionJoint.apply(this,arguments)},dt.Dynamics.Joints.b2FrictionJointDef=function t(){t.b2FrictionJointDef.apply(this,arguments),this.constructor===t&&this.b2FrictionJointDef.apply(this,arguments)},dt.Dynamics.Joints.b2GearJoint=function t(){t.b2GearJoint.apply(this,arguments),this.constructor===t&&this.b2GearJoint.apply(this,arguments)},dt.Dynamics.Joints.b2GearJointDef=function t(){t.b2GearJointDef.apply(this,arguments),this.constructor===t&&this.b2GearJointDef.apply(this,arguments)},dt.Dynamics.Joints.b2Jacobian=function t(){t.b2Jacobian.apply(this,arguments)},dt.Dynamics.Joints.b2Joint=function t(){t.b2Joint.apply(this,arguments),this.constructor===t&&this.b2Joint.apply(this,arguments)},dt.Dynamics.Joints.b2JointDef=function t(){t.b2JointDef.apply(this,arguments),this.constructor===t&&this.b2JointDef.apply(this,arguments)},dt.Dynamics.Joints.b2JointEdge=function t(){t.b2JointEdge.apply(this,arguments)},dt.Dynamics.Joints.b2LineJoint=function t(){t.b2LineJoint.apply(this,arguments),this.constructor===t&&this.b2LineJoint.apply(this,arguments)},dt.Dynamics.Joints.b2LineJointDef=function t(){t.b2LineJointDef.apply(this,arguments),this.constructor===t&&this.b2LineJointDef.apply(this,arguments)},dt.Dynamics.Joints.b2MouseJoint=function t(){t.b2MouseJoint.apply(this,arguments),this.constructor===t&&this.b2MouseJoint.apply(this,arguments)},dt.Dynamics.Joints.b2MouseJointDef=function t(){t.b2MouseJointDef.apply(this,arguments),this.constructor===t&&this.b2MouseJointDef.apply(this,arguments)},dt.Dynamics.Joints.b2PrismaticJoint=function t(){t.b2PrismaticJoint.apply(this,arguments),this.constructor===t&&this.b2PrismaticJoint.apply(this,arguments)},dt.Dynamics.Joints.b2PrismaticJointDef=function t(){t.b2PrismaticJointDef.apply(this,arguments),this.constructor===t&&this.b2PrismaticJointDef.apply(this,arguments)},dt.Dynamics.Joints.b2PulleyJoint=function t(){t.b2PulleyJoint.apply(this,arguments),this.constructor===t&&this.b2PulleyJoint.apply(this,arguments)},dt.Dynamics.Joints.b2PulleyJointDef=function t(){t.b2PulleyJointDef.apply(this,arguments),this.constructor===t&&this.b2PulleyJointDef.apply(this,arguments)},dt.Dynamics.Joints.b2RevoluteJoint=function t(){t.b2RevoluteJoint.apply(this,arguments),this.constructor===t&&this.b2RevoluteJoint.apply(this,arguments)},dt.Dynamics.Joints.b2RevoluteJointDef=function t(){t.b2RevoluteJointDef.apply(this,arguments),this.constructor===t&&this.b2RevoluteJointDef.apply(this,arguments)},dt.Dynamics.Joints.b2WeldJoint=function t(){t.b2WeldJoint.apply(this,arguments),this.constructor===t&&this.b2WeldJoint.apply(this,arguments)},dt.Dynamics.Joints.b2WeldJointDef=function t(){t.b2WeldJointDef.apply(this,arguments),this.constructor===t&&this.b2WeldJointDef.apply(this,arguments)},dt.postDefs=[],function(){var t=dt.Collision.Shapes.b2CircleShape;dt.Collision.Shapes.b2EdgeChainDef,dt.Collision.Shapes.b2EdgeShape,dt.Collision.Shapes.b2MassData;var e=dt.Collision.Shapes.b2PolygonShape,i=dt.Collision.Shapes.b2Shape;dt.Common.b2Color,dt.Common.b2internal;var o=dt.Common.b2Settings;dt.Common.Math.b2Mat22,dt.Common.Math.b2Mat33;var n=dt.Common.Math.b2Math,s=dt.Common.Math.b2Sweep,r=dt.Common.Math.b2Transform,a=dt.Common.Math.b2Vec2;dt.Common.Math.b2Vec3;var l=dt.Collision.b2AABB,h=dt.Collision.b2Bound,c=dt.Collision.b2BoundValues,m=dt.Collision.b2Collision,u=dt.Collision.b2ContactID,y=dt.Collision.b2ContactPoint,p=dt.Collision.b2Distance,_=dt.Collision.b2DistanceInput,f=dt.Collision.b2DistanceOutput,d=dt.Collision.b2DistanceProxy,v=dt.Collision.b2DynamicTree,b=dt.Collision.b2DynamicTreeBroadPhase,x=dt.Collision.b2DynamicTreeNode,g=dt.Collision.b2DynamicTreePair,w=dt.Collision.b2Manifold,C=dt.Collision.b2ManifoldPoint,S=dt.Collision.b2Point,A=dt.Collision.b2RayCastInput,M=dt.Collision.b2RayCastOutput,D=dt.Collision.b2Segment,B=dt.Collision.b2SeparationFunction,I=dt.Collision.b2Simplex,V=dt.Collision.b2SimplexCache,k=dt.Collision.b2SimplexVertex,P=dt.Collision.b2TimeOfImpact,T=dt.Collision.b2TOIInput,G=dt.Collision.b2WorldManifold,L=dt.Collision.ClipVertex,E=dt.Collision.Features,F=dt.Collision.IBroadPhase;l.b2AABB=function(){this.lowerBound=new a,this.upperBound=new a},l.prototype.IsValid=function(){var t=this.upperBound.x-this.lowerBound.x,e=this.upperBound.y-this.lowerBound.y,i=t>=0&&e>=0;return i&&this.lowerBound.IsValid()&&this.upperBound.IsValid()},l.prototype.GetCenter=function(){return new a((this.lowerBound.x+this.upperBound.x)/2,(this.lowerBound.y+this.upperBound.y)/2)},l.prototype.GetExtents=function(){return new a((this.upperBound.x-this.lowerBound.x)/2,(this.upperBound.y-this.lowerBound.y)/2)},l.prototype.Contains=function(t){var e=!0;return(e=(e=(e=e&&this.lowerBound.x<=t.lowerBound.x)&&this.lowerBound.y<=t.lowerBound.y)&&t.upperBound.x<=this.upperBound.x)&&t.upperBound.y<=this.upperBound.y},l.prototype.RayCast=function(t,e){var i=-Number.MAX_VALUE,o=Number.MAX_VALUE,n=e.p1.x,s=e.p1.y,r=e.p2.x-e.p1.x,a=e.p2.y-e.p1.y,l=Math.abs(r),h=Math.abs(a),c=t.normal,m=0,u=0,y=0,p=0,_=0;if(l<Number.MIN_VALUE){if(n<this.lowerBound.x||this.upperBound.x<n)return!1}else if(m=1/r,_=-1,(u=(this.lowerBound.x-n)*m)>(y=(this.upperBound.x-n)*m)&&(p=u,u=y,y=p,_=1),u>i&&(c.x=_,c.y=0,i=u),i>(o=Math.min(o,y)))return!1;if(h<Number.MIN_VALUE){if(s<this.lowerBound.y||this.upperBound.y<s)return!1}else if(m=1/a,_=-1,(u=(this.lowerBound.y-s)*m)>(y=(this.upperBound.y-s)*m)&&(p=u,u=y,y=p,_=1),u>i&&(c.y=_,c.x=0,i=u),i>(o=Math.min(o,y)))return!1;return t.fraction=i,!0},l.prototype.TestOverlap=function(t){var e=t.lowerBound.x-this.upperBound.x,i=t.lowerBound.y-this.upperBound.y,o=this.lowerBound.x-t.upperBound.x,n=this.lowerBound.y-t.upperBound.y;return!(e>0||i>0||o>0||n>0)},l.Combine=function(t,e){var i=new l;return i.Combine(t,e),i},l.prototype.Combine=function(t,e){this.lowerBound.x=Math.min(t.lowerBound.x,e.lowerBound.x),this.lowerBound.y=Math.min(t.lowerBound.y,e.lowerBound.y),this.upperBound.x=Math.max(t.upperBound.x,e.upperBound.x),this.upperBound.y=Math.max(t.upperBound.y,e.upperBound.y)},h.b2Bound=function(){},h.prototype.IsLower=function(){return!(1&this.value)},h.prototype.IsUpper=function(){return!(1&~this.value)},h.prototype.Swap=function(t){var e=this.value,i=this.proxy,o=this.stabbingCount;this.value=t.value,this.proxy=t.proxy,this.stabbingCount=t.stabbingCount,t.value=e,t.proxy=i,t.stabbingCount=o},c.b2BoundValues=function(){},c.prototype.b2BoundValues=function(){this.lowerValues=new gt,this.lowerValues[0]=0,this.lowerValues[1]=0,this.upperValues=new gt,this.upperValues[0]=0,this.upperValues[1]=0},m.b2Collision=function(){},m.ClipSegmentToLine=function(t,e,i,o){var n;void 0===o&&(o=0);var s=0,r=(n=e[0]).v,a=(n=e[1]).v,l=i.x*r.x+i.y*r.y-o,h=i.x*a.x+i.y*a.y-o;if(l<=0&&t[s++].Set(e[0]),h<=0&&t[s++].Set(e[1]),l*h<0){var c,m=l/(l-h),u=(n=t[s]).v;u.x=r.x+m*(a.x-r.x),u.y=r.y+m*(a.y-r.y),n=t[s],l>0?(c=e[0],n.id=c.id):(c=e[1],n.id=c.id),++s}return s},m.EdgeSeparation=function(t,e,i,o,n){void 0===i&&(i=0),parseInt(t.m_vertexCount);var s,r,a=t.m_vertices,l=t.m_normals,h=parseInt(o.m_vertexCount),c=o.m_vertices;s=e.R,r=l[i];for(var m=s.col1.x*r.x+s.col2.x*r.y,u=s.col1.y*r.x+s.col2.y*r.y,y=(s=n.R).col1.x*m+s.col1.y*u,p=s.col2.x*m+s.col2.y*u,_=0,f=Number.MAX_VALUE,d=0;d<h;++d){var v=(r=c[d]).x*y+r.y*p;v<f&&(f=v,_=d)}r=a[i],s=e.R;var b=e.position.x+(s.col1.x*r.x+s.col2.x*r.y),x=e.position.y+(s.col1.y*r.x+s.col2.y*r.y);r=c[_],s=n.R;var g=n.position.x+(s.col1.x*r.x+s.col2.x*r.y),w=n.position.y+(s.col1.y*r.x+s.col2.y*r.y);return(g-=b)*m+(w-=x)*u},m.FindMaxSeparation=function(t,e,i,o,n){var s,r,a=parseInt(e.m_vertexCount),l=e.m_normals;r=n.R,s=o.m_centroid;var h=n.position.x+(r.col1.x*s.x+r.col2.x*s.y),c=n.position.y+(r.col1.y*s.x+r.col2.y*s.y);r=i.R,s=e.m_centroid,h-=i.position.x+(r.col1.x*s.x+r.col2.x*s.y),c-=i.position.y+(r.col1.y*s.x+r.col2.y*s.y);for(var u=h*i.R.col1.x+c*i.R.col1.y,y=h*i.R.col2.x+c*i.R.col2.y,p=0,_=-Number.MAX_VALUE,f=0;f<a;++f){var d=(s=l[f]).x*u+s.y*y;d>_&&(_=d,p=f)}var v=m.EdgeSeparation(e,i,p,o,n),b=parseInt(p-1>=0?p-1:a-1),x=m.EdgeSeparation(e,i,b,o,n),g=parseInt(p+1<a?p+1:0),w=m.EdgeSeparation(e,i,g,o,n),C=0,S=0,A=0;if(x>v&&x>w)A=-1,C=b,S=x;else{if(!(w>v))return t[0]=p,v;A=1,C=g,S=w}for(;p=-1==A?C-1>=0?C-1:a-1:C+1<a?C+1:0,(v=m.EdgeSeparation(e,i,p,o,n))>S;)C=p,S=v;return t[0]=C,S},m.FindIncidentEdge=function(t,e,i,o,n,s){void 0===o&&(o=0),parseInt(e.m_vertexCount);var r,a,l=e.m_normals,h=parseInt(n.m_vertexCount),c=n.m_vertices,m=n.m_normals;r=i.R,a=l[o];var u=r.col1.x*a.x+r.col2.x*a.y,y=r.col1.y*a.x+r.col2.y*a.y,p=(r=s.R).col1.x*u+r.col1.y*y;y=r.col2.x*u+r.col2.y*y,u=p;for(var _,f=0,d=Number.MAX_VALUE,v=0;v<h;++v){var b=u*(a=m[v]).x+y*a.y;b<d&&(d=b,f=v)}var x=parseInt(f),g=parseInt(x+1<h?x+1:0);_=t[0],a=c[x],r=s.R,_.v.x=s.position.x+(r.col1.x*a.x+r.col2.x*a.y),_.v.y=s.position.y+(r.col1.y*a.x+r.col2.y*a.y),_.id.features.referenceEdge=o,_.id.features.incidentEdge=x,_.id.features.incidentVertex=0,_=t[1],a=c[g],r=s.R,_.v.x=s.position.x+(r.col1.x*a.x+r.col2.x*a.y),_.v.y=s.position.y+(r.col1.y*a.x+r.col2.y*a.y),_.id.features.referenceEdge=o,_.id.features.incidentEdge=g,_.id.features.incidentVertex=1},m.MakeClipPointVector=function(){var t=new xt(2);return t[0]=new L,t[1]=new L,t},m.CollidePolygons=function(t,e,i,n,s){var r;t.m_pointCount=0;var a=e.m_radius+n.m_radius,l=0;m.s_edgeAO[0]=l;var h=m.FindMaxSeparation(m.s_edgeAO,e,i,n,s);if(l=m.s_edgeAO[0],!(h>a)){var c=0;m.s_edgeBO[0]=c;var u=m.FindMaxSeparation(m.s_edgeBO,n,s,e,i);if(c=m.s_edgeBO[0],!(u>a)){var y,p,_,f,d,v=0,b=0;u>.98*h+.001?(y=n,p=e,_=s,f=i,v=c,t.m_type=w.e_faceB,b=1):(y=e,p=n,_=i,f=s,v=l,t.m_type=w.e_faceA,b=0);var x=m.s_incidentEdge;m.FindIncidentEdge(x,y,_,v,p,f);var g,C=parseInt(y.m_vertexCount),S=y.m_vertices,A=S[v];g=v+1<C?S[parseInt(v+1)]:S[0];var M=m.s_localTangent;M.Set(g.x-A.x,g.y-A.y),M.Normalize();var D=m.s_localNormal;D.x=M.y,D.y=-M.x;var B=m.s_planePoint;B.Set(.5*(A.x+g.x),.5*(A.y+g.y));var I=m.s_tangent;d=_.R,I.x=d.col1.x*M.x+d.col2.x*M.y,I.y=d.col1.y*M.x+d.col2.y*M.y;var V=m.s_tangent2;V.x=-I.x,V.y=-I.y;var k=m.s_normal;k.x=I.y,k.y=-I.x;var P=m.s_v11,T=m.s_v12;P.x=_.position.x+(d.col1.x*A.x+d.col2.x*A.y),P.y=_.position.y+(d.col1.y*A.x+d.col2.y*A.y),T.x=_.position.x+(d.col1.x*g.x+d.col2.x*g.y),T.y=_.position.y+(d.col1.y*g.x+d.col2.y*g.y);var G=k.x*P.x+k.y*P.y,L=-I.x*P.x-I.y*P.y+a,E=I.x*T.x+I.y*T.y+a,F=m.s_clipPoints1,R=m.s_clipPoints2;if(!(m.ClipSegmentToLine(F,x,V,L)<2||m.ClipSegmentToLine(R,F,I,E)<2)){t.m_localPlaneNormal.SetV(D),t.m_localPoint.SetV(B);for(var J=0,O=0;O<o.b2_maxManifoldPoints;++O)if(r=R[O],k.x*r.v.x+k.y*r.v.y-G<=a){var z=t.m_points[J];d=f.R;var j=r.v.x-f.position.x,N=r.v.y-f.position.y;z.m_localPoint.x=j*d.col1.x+N*d.col1.y,z.m_localPoint.y=j*d.col2.x+N*d.col2.y,z.m_id.Set(r.id),z.m_id.features.flip=b,++J}t.m_pointCount=J}}}},m.CollideCircles=function(t,e,i,o,n){var s,r;t.m_pointCount=0,s=i.R,r=e.m_p;var a=i.position.x+(s.col1.x*r.x+s.col2.x*r.y),l=i.position.y+(s.col1.y*r.x+s.col2.y*r.y);s=n.R,r=o.m_p;var h=n.position.x+(s.col1.x*r.x+s.col2.x*r.y)-a,c=n.position.y+(s.col1.y*r.x+s.col2.y*r.y)-l,m=h*h+c*c,u=e.m_radius+o.m_radius;m>u*u||(t.m_type=w.e_circles,t.m_localPoint.SetV(e.m_p),t.m_localPlaneNormal.SetZero(),t.m_pointCount=1,t.m_points[0].m_localPoint.SetV(o.m_p),t.m_points[0].m_id.key=0)},m.CollidePolygonAndCircle=function(t,e,i,o,n){t.m_pointCount=0;var s,r,a=0,l=0;r=n.R,s=o.m_p;var h=n.position.x+(r.col1.x*s.x+r.col2.x*s.y),c=n.position.y+(r.col1.y*s.x+r.col2.y*s.y);a=h-i.position.x,l=c-i.position.y;for(var m=a*(r=i.R).col1.x+l*r.col1.y,u=a*r.col2.x+l*r.col2.y,y=0,p=-Number.MAX_VALUE,_=e.m_radius+o.m_radius,f=parseInt(e.m_vertexCount),d=e.m_vertices,v=e.m_normals,b=0;b<f;++b){a=m-(s=d[b]).x,l=u-s.y;var x=(s=v[b]).x*a+s.y*l;if(x>_)return;x>p&&(p=x,y=b)}var g=parseInt(y),C=parseInt(g+1<f?g+1:0),S=d[g],A=d[C];if(p<Number.MIN_VALUE)return t.m_pointCount=1,t.m_type=w.e_faceA,t.m_localPlaneNormal.SetV(v[y]),t.m_localPoint.x=.5*(S.x+A.x),t.m_localPoint.y=.5*(S.y+A.y),t.m_points[0].m_localPoint.SetV(o.m_p),void(t.m_points[0].m_id.key=0);var M=(m-S.x)*(A.x-S.x)+(u-S.y)*(A.y-S.y),D=(m-A.x)*(S.x-A.x)+(u-A.y)*(S.y-A.y);if(M<=0){if((m-S.x)*(m-S.x)+(u-S.y)*(u-S.y)>_*_)return;t.m_pointCount=1,t.m_type=w.e_faceA,t.m_localPlaneNormal.x=m-S.x,t.m_localPlaneNormal.y=u-S.y,t.m_localPlaneNormal.Normalize(),t.m_localPoint.SetV(S),t.m_points[0].m_localPoint.SetV(o.m_p),t.m_points[0].m_id.key=0}else if(D<=0){if((m-A.x)*(m-A.x)+(u-A.y)*(u-A.y)>_*_)return;t.m_pointCount=1,t.m_type=w.e_faceA,t.m_localPlaneNormal.x=m-A.x,t.m_localPlaneNormal.y=u-A.y,t.m_localPlaneNormal.Normalize(),t.m_localPoint.SetV(A),t.m_points[0].m_localPoint.SetV(o.m_p),t.m_points[0].m_id.key=0}else{var B=.5*(S.x+A.x),I=.5*(S.y+A.y);if((p=(m-B)*v[g].x+(u-I)*v[g].y)>_)return;t.m_pointCount=1,t.m_type=w.e_faceA,t.m_localPlaneNormal.x=v[g].x,t.m_localPlaneNormal.y=v[g].y,t.m_localPlaneNormal.Normalize(),t.m_localPoint.Set(B,I),t.m_points[0].m_localPoint.SetV(o.m_p),t.m_points[0].m_id.key=0}},m.TestOverlap=function(t,e){var i=e.lowerBound,o=t.upperBound,n=i.x-o.x,s=i.y-o.y;i=t.lowerBound,o=e.upperBound;var r=i.x-o.x,a=i.y-o.y;return!(n>0||s>0||r>0||a>0)},dt.postDefs.push(function(){dt.Collision.b2Collision.s_incidentEdge=m.MakeClipPointVector(),dt.Collision.b2Collision.s_clipPoints1=m.MakeClipPointVector(),dt.Collision.b2Collision.s_clipPoints2=m.MakeClipPointVector(),dt.Collision.b2Collision.s_edgeAO=new gt(1),dt.Collision.b2Collision.s_edgeBO=new gt(1),dt.Collision.b2Collision.s_localTangent=new a,dt.Collision.b2Collision.s_localNormal=new a,dt.Collision.b2Collision.s_planePoint=new a,dt.Collision.b2Collision.s_normal=new a,dt.Collision.b2Collision.s_tangent=new a,dt.Collision.b2Collision.s_tangent2=new a,dt.Collision.b2Collision.s_v11=new a,dt.Collision.b2Collision.s_v12=new a,dt.Collision.b2Collision.b2CollidePolyTempVec=new a,dt.Collision.b2Collision.b2_nullFeature=255}),u.b2ContactID=function(){this.features=new E},u.prototype.b2ContactID=function(){this.features._m_id=this},u.prototype.Set=function(t){this.key=t._key},u.prototype.Copy=function(){var t=new u;return t.key=this.key,t},Object.defineProperty(u.prototype,"key",{enumerable:!1,configurable:!0,get:function(){return this._key}}),Object.defineProperty(u.prototype,"key",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._key=t,this.features._referenceEdge=255&this._key,this.features._incidentEdge=(65280&this._key)>>8&255,this.features._incidentVertex=(16711680&this._key)>>16&255,this.features._flip=(4278190080&this._key)>>24&255}}),y.b2ContactPoint=function(){this.position=new a,this.velocity=new a,this.normal=new a,this.id=new u},p.b2Distance=function(){},p.Distance=function(t,e,i){++p.b2_gjkCalls;var s=i.proxyA,r=i.proxyB,l=i.transformA,h=i.transformB,c=p.s_simplex;c.ReadCache(e,s,l,r,h);var m=c.m_vertices,u=p.s_saveA,y=p.s_saveB,_=0;c.GetClosestPoint().LengthSquared();for(var f,d=0,v=0;v<20;){for(_=c.m_count,d=0;d<_;d++)u[d]=m[d].indexA,y[d]=m[d].indexB;switch(c.m_count){case 1:break;case 2:c.Solve2();break;case 3:c.Solve3();break;default:o.b2Assert(!1)}if(3==c.m_count)break;(f=c.GetClosestPoint()).LengthSquared();var b=c.GetSearchDirection();if(b.LengthSquared()<Number.MIN_VALUE*Number.MIN_VALUE)break;var x=m[c.m_count];x.indexA=s.GetSupport(n.MulTMV(l.R,b.GetNegative())),x.wA=n.MulX(l,s.GetVertex(x.indexA)),x.indexB=r.GetSupport(n.MulTMV(h.R,b)),x.wB=n.MulX(h,r.GetVertex(x.indexB)),x.w=n.SubtractVV(x.wB,x.wA),++v,++p.b2_gjkIters;var g=!1;for(d=0;d<_;d++)if(x.indexA==u[d]&&x.indexB==y[d]){g=!0;break}if(g)break;++c.m_count}if(p.b2_gjkMaxIters=n.Max(p.b2_gjkMaxIters,v),c.GetWitnessPoints(t.pointA,t.pointB),t.distance=n.SubtractVV(t.pointA,t.pointB).Length(),t.iterations=v,c.WriteCache(e),i.useRadii){var w=s.m_radius,C=r.m_radius;if(t.distance>w+C&&t.distance>Number.MIN_VALUE){t.distance-=w+C;var S=n.SubtractVV(t.pointB,t.pointA);S.Normalize(),t.pointA.x+=w*S.x,t.pointA.y+=w*S.y,t.pointB.x-=C*S.x,t.pointB.y-=C*S.y}else(f=new a).x=.5*(t.pointA.x+t.pointB.x),f.y=.5*(t.pointA.y+t.pointB.y),t.pointA.x=t.pointB.x=f.x,t.pointA.y=t.pointB.y=f.y,t.distance=0}},dt.postDefs.push(function(){dt.Collision.b2Distance.s_simplex=new I,dt.Collision.b2Distance.s_saveA=new gt(3),dt.Collision.b2Distance.s_saveB=new gt(3)}),_.b2DistanceInput=function(){},f.b2DistanceOutput=function(){this.pointA=new a,this.pointB=new a},d.b2DistanceProxy=function(){},d.prototype.Set=function(n){switch(n.GetType()){case i.e_circleShape:var s=n instanceof t?n:null;this.m_vertices=new xt(1,!0),this.m_vertices[0]=s.m_p,this.m_count=1,this.m_radius=s.m_radius;break;case i.e_polygonShape:var r=n instanceof e?n:null;this.m_vertices=r.m_vertices,this.m_count=r.m_vertexCount,this.m_radius=r.m_radius;break;default:o.b2Assert(!1)}},d.prototype.GetSupport=function(t){for(var e=0,i=this.m_vertices[0].x*t.x+this.m_vertices[0].y*t.y,o=1;o<this.m_count;++o){var n=this.m_vertices[o].x*t.x+this.m_vertices[o].y*t.y;n>i&&(e=o,i=n)}return e},d.prototype.GetSupportVertex=function(t){for(var e=0,i=this.m_vertices[0].x*t.x+this.m_vertices[0].y*t.y,o=1;o<this.m_count;++o){var n=this.m_vertices[o].x*t.x+this.m_vertices[o].y*t.y;n>i&&(e=o,i=n)}return this.m_vertices[e]},d.prototype.GetVertexCount=function(){return this.m_count},d.prototype.GetVertex=function(t){return void 0===t&&(t=0),o.b2Assert(0<=t&&t<this.m_count),this.m_vertices[t]},v.b2DynamicTree=function(){},v.prototype.b2DynamicTree=function(){this.m_root=null,this.m_freeList=null,this.m_path=0,this.m_insertionCount=0},v.prototype.CreateProxy=function(t,e){var i=this.AllocateNode(),n=o.b2_aabbExtension,s=o.b2_aabbExtension;return i.aabb.lowerBound.x=t.lowerBound.x-n,i.aabb.lowerBound.y=t.lowerBound.y-s,i.aabb.upperBound.x=t.upperBound.x+n,i.aabb.upperBound.y=t.upperBound.y+s,i.userData=e,this.InsertLeaf(i),i},v.prototype.DestroyProxy=function(t){this.RemoveLeaf(t),this.FreeNode(t)},v.prototype.MoveProxy=function(t,e,i){if(o.b2Assert(t.IsLeaf()),t.aabb.Contains(e))return!1;this.RemoveLeaf(t);var n=o.b2_aabbExtension+o.b2_aabbMultiplier*(i.x>0?i.x:-i.x),s=o.b2_aabbExtension+o.b2_aabbMultiplier*(i.y>0?i.y:-i.y);return t.aabb.lowerBound.x=e.lowerBound.x-n,t.aabb.lowerBound.y=e.lowerBound.y-s,t.aabb.upperBound.x=e.upperBound.x+n,t.aabb.upperBound.y=e.upperBound.y+s,this.InsertLeaf(t),!0},v.prototype.Rebalance=function(t){if(void 0===t&&(t=0),null!=this.m_root)for(var e=0;e<t;e++){for(var i=this.m_root,o=0;0==i.IsLeaf();)i=this.m_path>>o&1?i.child2:i.child1,o=o+1&31;++this.m_path,this.RemoveLeaf(i),this.InsertLeaf(i)}},v.prototype.GetFatAABB=function(t){return t.aabb},v.prototype.GetUserData=function(t){return t.userData},v.prototype.Query=function(t,e){if(null!=this.m_root){var i=new xt,o=0;for(i[o++]=this.m_root;o>0;){var n=i[--o];if(n.aabb.TestOverlap(e))if(n.IsLeaf()){if(!t(n))return}else i[o++]=n.child1,i[o++]=n.child2}}},v.prototype.RayCast=function(t,e){if(null!=this.m_root){var i=e.p1,o=e.p2,s=n.SubtractVV(i,o);s.Normalize();var r=n.CrossFV(1,s),a=n.AbsV(r),h=e.maxFraction,c=new l,m=0,u=0;m=i.x+h*(o.x-i.x),u=i.y+h*(o.y-i.y),c.lowerBound.x=Math.min(i.x,m),c.lowerBound.y=Math.min(i.y,u),c.upperBound.x=Math.max(i.x,m),c.upperBound.y=Math.max(i.y,u);var y=new xt,p=0;for(y[p++]=this.m_root;p>0;){var _=y[--p];if(0!=_.aabb.TestOverlap(c)){var f=_.aabb.GetCenter(),d=_.aabb.GetExtents();if(!(Math.abs(r.x*(i.x-f.x)+r.y*(i.y-f.y))-a.x*d.x-a.y*d.y>0))if(_.IsLeaf()){var v=new A;if(v.p1=e.p1,v.p2=e.p2,v.maxFraction=e.maxFraction,0==(h=t(v,_)))return;h>0&&(m=i.x+h*(o.x-i.x),u=i.y+h*(o.y-i.y),c.lowerBound.x=Math.min(i.x,m),c.lowerBound.y=Math.min(i.y,u),c.upperBound.x=Math.max(i.x,m),c.upperBound.y=Math.max(i.y,u))}else y[p++]=_.child1,y[p++]=_.child2}}}},v.prototype.AllocateNode=function(){if(this.m_freeList){var t=this.m_freeList;return this.m_freeList=t.parent,t.parent=null,t.child1=null,t.child2=null,t}return new x},v.prototype.FreeNode=function(t){t.parent=this.m_freeList,this.m_freeList=t},v.prototype.InsertLeaf=function(t){if(++this.m_insertionCount,null==this.m_root)return this.m_root=t,void(this.m_root.parent=null);var e=t.aabb.GetCenter(),i=this.m_root;if(0==i.IsLeaf())do{var o=i.child1,n=i.child2;i=Math.abs((o.aabb.lowerBound.x+o.aabb.upperBound.x)/2-e.x)+Math.abs((o.aabb.lowerBound.y+o.aabb.upperBound.y)/2-e.y)<Math.abs((n.aabb.lowerBound.x+n.aabb.upperBound.x)/2-e.x)+Math.abs((n.aabb.lowerBound.y+n.aabb.upperBound.y)/2-e.y)?o:n}while(0==i.IsLeaf());var s=i.parent,r=this.AllocateNode();if(r.parent=s,r.userData=null,r.aabb.Combine(t.aabb,i.aabb),s){i.parent.child1==i?s.child1=r:s.child2=r,r.child1=i,r.child2=t,i.parent=r,t.parent=r;do{if(s.aabb.Contains(r.aabb))break;s.aabb.Combine(s.child1.aabb,s.child2.aabb),r=s,s=s.parent}while(s)}else r.child1=i,r.child2=t,i.parent=r,t.parent=r,this.m_root=r},v.prototype.RemoveLeaf=function(t){if(t!=this.m_root){var e,i=t.parent,o=i.parent;if(e=i.child1==t?i.child2:i.child1,o)for(o.child1==i?o.child1=e:o.child2=e,e.parent=o,this.FreeNode(i);o;){var n=o.aabb;if(o.aabb=l.Combine(o.child1.aabb,o.child2.aabb),n.Contains(o.aabb))break;o=o.parent}else this.m_root=e,e.parent=null,this.FreeNode(i)}else this.m_root=null},b.b2DynamicTreeBroadPhase=function(){this.m_tree=new v,this.m_moveBuffer=new xt,this.m_pairBuffer=new xt,this.m_pairCount=0},b.prototype.CreateProxy=function(t,e){var i=this.m_tree.CreateProxy(t,e);return++this.m_proxyCount,this.BufferMove(i),i},b.prototype.DestroyProxy=function(t){this.UnBufferMove(t),--this.m_proxyCount,this.m_tree.DestroyProxy(t)},b.prototype.MoveProxy=function(t,e,i){this.m_tree.MoveProxy(t,e,i)&&this.BufferMove(t)},b.prototype.TestOverlap=function(t,e){var i=this.m_tree.GetFatAABB(t),o=this.m_tree.GetFatAABB(e);return i.TestOverlap(o)},b.prototype.GetUserData=function(t){return this.m_tree.GetUserData(t)},b.prototype.GetFatAABB=function(t){return this.m_tree.GetFatAABB(t)},b.prototype.GetProxyCount=function(){return this.m_proxyCount},b.prototype.UpdatePairs=function(t){var e=this;e.m_pairCount=0;var i,o=0;function n(t){if(t==i)return!0;e.m_pairCount==e.m_pairBuffer.length&&(e.m_pairBuffer[e.m_pairCount]=new g);var o=e.m_pairBuffer[e.m_pairCount];return o.proxyA=t<i?t:i,o.proxyB=t>=i?t:i,++e.m_pairCount,!0}for(o=0;o<e.m_moveBuffer.length;++o){i=e.m_moveBuffer[o];var s=e.m_tree.GetFatAABB(i);e.m_tree.Query(n,s)}for(e.m_moveBuffer.length=0,o=0;o<e.m_pairCount;){var r=e.m_pairBuffer[o];for(t(e.m_tree.GetUserData(r.proxyA),e.m_tree.GetUserData(r.proxyB)),++o;o<e.m_pairCount;){var a=e.m_pairBuffer[o];if(a.proxyA!=r.proxyA||a.proxyB!=r.proxyB)break;++o}}},b.prototype.Query=function(t,e){this.m_tree.Query(t,e)},b.prototype.RayCast=function(t,e){this.m_tree.RayCast(t,e)},b.prototype.Validate=function(){},b.prototype.Rebalance=function(t){void 0===t&&(t=0),this.m_tree.Rebalance(t)},b.prototype.BufferMove=function(t){this.m_moveBuffer[this.m_moveBuffer.length]=t},b.prototype.UnBufferMove=function(t){var e=parseInt(this.m_moveBuffer.indexOf(t));this.m_moveBuffer.splice(e,1)},b.prototype.ComparePairs=function(t,e){return 0},b.__implements={},b.__implements[F]=!0,x.b2DynamicTreeNode=function(){this.aabb=new l},x.prototype.IsLeaf=function(){return null==this.child1},g.b2DynamicTreePair=function(){},w.b2Manifold=function(){this.m_pointCount=0},w.prototype.b2Manifold=function(){this.m_points=new xt(o.b2_maxManifoldPoints);for(var t=0;t<o.b2_maxManifoldPoints;t++)this.m_points[t]=new C;this.m_localPlaneNormal=new a,this.m_localPoint=new a},w.prototype.Reset=function(){for(var t=0;t<o.b2_maxManifoldPoints;t++)(this.m_points[t]instanceof C?this.m_points[t]:null).Reset();this.m_localPlaneNormal.SetZero(),this.m_localPoint.SetZero(),this.m_type=0,this.m_pointCount=0},w.prototype.Set=function(t){this.m_pointCount=t.m_pointCount;for(var e=0;e<o.b2_maxManifoldPoints;e++)(this.m_points[e]instanceof C?this.m_points[e]:null).Set(t.m_points[e]);this.m_localPlaneNormal.SetV(t.m_localPlaneNormal),this.m_localPoint.SetV(t.m_localPoint),this.m_type=t.m_type},w.prototype.Copy=function(){var t=new w;return t.Set(this),t},dt.postDefs.push(function(){dt.Collision.b2Manifold.e_circles=1,dt.Collision.b2Manifold.e_faceA=2,dt.Collision.b2Manifold.e_faceB=4}),C.b2ManifoldPoint=function(){this.m_localPoint=new a,this.m_id=new u},C.prototype.b2ManifoldPoint=function(){this.Reset()},C.prototype.Reset=function(){this.m_localPoint.SetZero(),this.m_normalImpulse=0,this.m_tangentImpulse=0,this.m_id.key=0},C.prototype.Set=function(t){this.m_localPoint.SetV(t.m_localPoint),this.m_normalImpulse=t.m_normalImpulse,this.m_tangentImpulse=t.m_tangentImpulse,this.m_id.Set(t.m_id)},S.b2Point=function(){this.p=new a},S.prototype.Support=function(t,e,i){return this.p},S.prototype.GetFirstVertex=function(t){return this.p},A.b2RayCastInput=function(){this.p1=new a,this.p2=new a},A.prototype.b2RayCastInput=function(t,e,i){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=1),t&&this.p1.SetV(t),e&&this.p2.SetV(e),this.maxFraction=i},M.b2RayCastOutput=function(){this.normal=new a},D.b2Segment=function(){this.p1=new a,this.p2=new a},D.prototype.TestSegment=function(t,e,i,o){void 0===o&&(o=0);var n=i.p1,s=i.p2.x-n.x,r=i.p2.y-n.y,a=this.p2.x-this.p1.x,l=this.p2.y-this.p1.y,h=-a,c=100*Number.MIN_VALUE,m=-(s*l+r*h);if(m>c){var u=n.x-this.p1.x,y=n.y-this.p1.y,p=u*l+y*h;if(0<=p&&p<=o*m){var _=-s*y+r*u;if(-c*m<=_&&_<=m*(1+c)){p/=m;var f=Math.sqrt(l*l+h*h);return l/=f,h/=f,t[0]=p,e.Set(l,h),!0}}}return!1},D.prototype.Extend=function(t){this.ExtendForward(t),this.ExtendBackward(t)},D.prototype.ExtendForward=function(t){var e=this.p2.x-this.p1.x,i=this.p2.y-this.p1.y,o=Math.min(e>0?(t.upperBound.x-this.p1.x)/e:e<0?(t.lowerBound.x-this.p1.x)/e:Number.POSITIVE_INFINITY,i>0?(t.upperBound.y-this.p1.y)/i:i<0?(t.lowerBound.y-this.p1.y)/i:Number.POSITIVE_INFINITY);this.p2.x=this.p1.x+e*o,this.p2.y=this.p1.y+i*o},D.prototype.ExtendBackward=function(t){var e=-this.p2.x+this.p1.x,i=-this.p2.y+this.p1.y,o=Math.min(e>0?(t.upperBound.x-this.p2.x)/e:e<0?(t.lowerBound.x-this.p2.x)/e:Number.POSITIVE_INFINITY,i>0?(t.upperBound.y-this.p2.y)/i:i<0?(t.lowerBound.y-this.p2.y)/i:Number.POSITIVE_INFINITY);this.p1.x=this.p2.x+e*o,this.p1.y=this.p2.y+i*o},B.b2SeparationFunction=function(){this.m_localPoint=new a,this.m_axis=new a},B.prototype.Initialize=function(t,e,i,s,r){this.m_proxyA=e,this.m_proxyB=s;var l,h,c,m,u,y,p=parseInt(t.count);o.b2Assert(0<p&&p<3);var _,f,d=0,v=0,b=0,x=0,g=0,w=0,C=0;if(1==p)this.m_type=B.e_points,l=this.m_proxyA.GetVertex(t.indexA[0]),m=this.m_proxyB.GetVertex(t.indexB[0]),f=l,_=i.R,d=i.position.x+(_.col1.x*f.x+_.col2.x*f.y),v=i.position.y+(_.col1.y*f.x+_.col2.y*f.y),f=m,_=r.R,b=r.position.x+(_.col1.x*f.x+_.col2.x*f.y),x=r.position.y+(_.col1.y*f.x+_.col2.y*f.y),this.m_axis.x=b-d,this.m_axis.y=x-v,this.m_axis.Normalize();else if(t.indexB[0]==t.indexB[1])this.m_type=B.e_faceA,h=this.m_proxyA.GetVertex(t.indexA[0]),c=this.m_proxyA.GetVertex(t.indexA[1]),m=this.m_proxyB.GetVertex(t.indexB[0]),this.m_localPoint.x=.5*(h.x+c.x),this.m_localPoint.y=.5*(h.y+c.y),this.m_axis=n.CrossVF(n.SubtractVV(c,h),1),this.m_axis.Normalize(),f=this.m_axis,g=(_=i.R).col1.x*f.x+_.col2.x*f.y,w=_.col1.y*f.x+_.col2.y*f.y,f=this.m_localPoint,_=i.R,d=i.position.x+(_.col1.x*f.x+_.col2.x*f.y),v=i.position.y+(_.col1.y*f.x+_.col2.y*f.y),f=m,_=r.R,(C=((b=r.position.x+(_.col1.x*f.x+_.col2.x*f.y))-d)*g+((x=r.position.y+(_.col1.y*f.x+_.col2.y*f.y))-v)*w)<0&&this.m_axis.NegativeSelf();else if(t.indexA[0]==t.indexA[0])this.m_type=B.e_faceB,u=this.m_proxyB.GetVertex(t.indexB[0]),y=this.m_proxyB.GetVertex(t.indexB[1]),l=this.m_proxyA.GetVertex(t.indexA[0]),this.m_localPoint.x=.5*(u.x+y.x),this.m_localPoint.y=.5*(u.y+y.y),this.m_axis=n.CrossVF(n.SubtractVV(y,u),1),this.m_axis.Normalize(),f=this.m_axis,g=(_=r.R).col1.x*f.x+_.col2.x*f.y,w=_.col1.y*f.x+_.col2.y*f.y,f=this.m_localPoint,_=r.R,b=r.position.x+(_.col1.x*f.x+_.col2.x*f.y),x=r.position.y+(_.col1.y*f.x+_.col2.y*f.y),f=l,_=i.R,(C=((d=i.position.x+(_.col1.x*f.x+_.col2.x*f.y))-b)*g+((v=i.position.y+(_.col1.y*f.x+_.col2.y*f.y))-x)*w)<0&&this.m_axis.NegativeSelf();else{h=this.m_proxyA.GetVertex(t.indexA[0]),c=this.m_proxyA.GetVertex(t.indexA[1]),u=this.m_proxyB.GetVertex(t.indexB[0]),y=this.m_proxyB.GetVertex(t.indexB[1]),n.MulX(i,l);var S=n.MulMV(i.R,n.SubtractVV(c,h));n.MulX(r,m);var A=n.MulMV(r.R,n.SubtractVV(y,u)),M=S.x*S.x+S.y*S.y,D=A.x*A.x+A.y*A.y,I=n.SubtractVV(A,S),V=S.x*I.x+S.y*I.y,k=A.x*I.x+A.y*I.y,P=S.x*A.x+S.y*A.y,T=M*D-P*P;C=0,0!=T&&(C=n.Clamp((P*k-V*D)/T,0,1));var G=(P*C+k)/D;G<0&&(G=0,C=n.Clamp((P-V)/M,0,1)),(l=new a).x=h.x+C*(c.x-h.x),l.y=h.y+C*(c.y-h.y),(m=new a).x=u.x+C*(y.x-u.x),m.y=u.y+C*(y.y-u.y),0==C||1==C?(this.m_type=B.e_faceB,this.m_axis=n.CrossVF(n.SubtractVV(y,u),1),this.m_axis.Normalize(),this.m_localPoint=m,f=this.m_axis,g=(_=r.R).col1.x*f.x+_.col2.x*f.y,w=_.col1.y*f.x+_.col2.y*f.y,f=this.m_localPoint,_=r.R,b=r.position.x+(_.col1.x*f.x+_.col2.x*f.y),x=r.position.y+(_.col1.y*f.x+_.col2.y*f.y),f=l,_=i.R,d=i.position.x+(_.col1.x*f.x+_.col2.x*f.y),v=i.position.y+(_.col1.y*f.x+_.col2.y*f.y),C<0&&this.m_axis.NegativeSelf()):(this.m_type=B.e_faceA,this.m_axis=n.CrossVF(n.SubtractVV(c,h),1),this.m_localPoint=l,f=this.m_axis,g=(_=i.R).col1.x*f.x+_.col2.x*f.y,w=_.col1.y*f.x+_.col2.y*f.y,f=this.m_localPoint,_=i.R,d=i.position.x+(_.col1.x*f.x+_.col2.x*f.y),v=i.position.y+(_.col1.y*f.x+_.col2.y*f.y),f=m,_=r.R,b=r.position.x+(_.col1.x*f.x+_.col2.x*f.y),x=r.position.y+(_.col1.y*f.x+_.col2.y*f.y),C<0&&this.m_axis.NegativeSelf())}},B.prototype.Evaluate=function(t,e){var i,s,r,a,l,h,c;switch(this.m_type){case B.e_points:return i=n.MulTMV(t.R,this.m_axis),s=n.MulTMV(e.R,this.m_axis.GetNegative()),r=this.m_proxyA.GetSupportVertex(i),a=this.m_proxyB.GetSupportVertex(s),l=n.MulX(t,r),((h=n.MulX(e,a)).x-l.x)*this.m_axis.x+(h.y-l.y)*this.m_axis.y;case B.e_faceA:return c=n.MulMV(t.R,this.m_axis),l=n.MulX(t,this.m_localPoint),s=n.MulTMV(e.R,c.GetNegative()),a=this.m_proxyB.GetSupportVertex(s),((h=n.MulX(e,a)).x-l.x)*c.x+(h.y-l.y)*c.y;case B.e_faceB:return c=n.MulMV(e.R,this.m_axis),h=n.MulX(e,this.m_localPoint),i=n.MulTMV(t.R,c.GetNegative()),r=this.m_proxyA.GetSupportVertex(i),((l=n.MulX(t,r)).x-h.x)*c.x+(l.y-h.y)*c.y;default:return o.b2Assert(!1),0}},dt.postDefs.push(function(){dt.Collision.b2SeparationFunction.e_points=1,dt.Collision.b2SeparationFunction.e_faceA=2,dt.Collision.b2SeparationFunction.e_faceB=4}),I.b2Simplex=function(){this.m_v1=new k,this.m_v2=new k,this.m_v3=new k,this.m_vertices=new xt(3)},I.prototype.b2Simplex=function(){this.m_vertices[0]=this.m_v1,this.m_vertices[1]=this.m_v2,this.m_vertices[2]=this.m_v3},I.prototype.ReadCache=function(t,e,i,s,r){var a,l;o.b2Assert(0<=t.count&&t.count<=3),this.m_count=t.count;for(var h=this.m_vertices,c=0;c<this.m_count;c++){var m=h[c];m.indexA=t.indexA[c],m.indexB=t.indexB[c],a=e.GetVertex(m.indexA),l=s.GetVertex(m.indexB),m.wA=n.MulX(i,a),m.wB=n.MulX(r,l),m.w=n.SubtractVV(m.wB,m.wA),m.a=0}if(this.m_count>1){var u=t.metric,y=this.GetMetric();(y<.5*u||2*u<y||y<Number.MIN_VALUE)&&(this.m_count=0)}0==this.m_count&&((m=h[0]).indexA=0,m.indexB=0,a=e.GetVertex(0),l=s.GetVertex(0),m.wA=n.MulX(i,a),m.wB=n.MulX(r,l),m.w=n.SubtractVV(m.wB,m.wA),this.m_count=1)},I.prototype.WriteCache=function(t){t.metric=this.GetMetric(),t.count=dt.parseUInt(this.m_count);for(var e=this.m_vertices,i=0;i<this.m_count;i++)t.indexA[i]=dt.parseUInt(e[i].indexA),t.indexB[i]=dt.parseUInt(e[i].indexB)},I.prototype.GetSearchDirection=function(){switch(this.m_count){case 1:return this.m_v1.w.GetNegative();case 2:var t=n.SubtractVV(this.m_v2.w,this.m_v1.w);return n.CrossVV(t,this.m_v1.w.GetNegative())>0?n.CrossFV(1,t):n.CrossVF(t,1);default:return o.b2Assert(!1),new a}},I.prototype.GetClosestPoint=function(){switch(this.m_count){case 0:default:return o.b2Assert(!1),new a;case 1:return this.m_v1.w;case 2:return new a(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y)}},I.prototype.GetWitnessPoints=function(t,e){switch(this.m_count){case 0:default:o.b2Assert(!1);break;case 1:t.SetV(this.m_v1.wA),e.SetV(this.m_v1.wB);break;case 2:t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x,t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y,e.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x,e.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:e.x=t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x,e.y=t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y}},I.prototype.GetMetric=function(){switch(this.m_count){case 0:default:return o.b2Assert(!1),0;case 1:return 0;case 2:return n.SubtractVV(this.m_v1.w,this.m_v2.w).Length();case 3:return n.CrossVV(n.SubtractVV(this.m_v2.w,this.m_v1.w),n.SubtractVV(this.m_v3.w,this.m_v1.w))}},I.prototype.Solve2=function(){var t=this.m_v1.w,e=this.m_v2.w,i=n.SubtractVV(e,t),o=-(t.x*i.x+t.y*i.y);if(o<=0)return this.m_v1.a=1,void(this.m_count=1);var s=e.x*i.x+e.y*i.y;if(s<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Set(this.m_v2);var r=1/(s+o);this.m_v1.a=s*r,this.m_v2.a=o*r,this.m_count=2},I.prototype.Solve3=function(){var t=this.m_v1.w,e=this.m_v2.w,i=this.m_v3.w,o=n.SubtractVV(e,t),s=n.Dot(t,o),r=n.Dot(e,o),a=-s,l=n.SubtractVV(i,t),h=n.Dot(t,l),c=n.Dot(i,l),m=-h,u=n.SubtractVV(i,e),y=n.Dot(e,u),p=n.Dot(i,u),_=-y,f=n.CrossVV(o,l),d=f*n.CrossVV(e,i),v=f*n.CrossVV(i,t),b=f*n.CrossVV(t,e);if(a<=0&&m<=0)return this.m_v1.a=1,void(this.m_count=1);if(r>0&&a>0&&b<=0){var x=1/(r+a);return this.m_v1.a=r*x,this.m_v2.a=a*x,void(this.m_count=2)}if(c>0&&m>0&&v<=0){var g=1/(c+m);return this.m_v1.a=c*g,this.m_v3.a=m*g,this.m_count=2,void this.m_v2.Set(this.m_v3)}if(r<=0&&_<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Set(this.m_v2);if(c<=0&&p<=0)return this.m_v3.a=1,this.m_count=1,void this.m_v1.Set(this.m_v3);if(p>0&&_>0&&d<=0){var w=1/(p+_);return this.m_v2.a=p*w,this.m_v3.a=_*w,this.m_count=2,void this.m_v1.Set(this.m_v3)}var C=1/(d+v+b);this.m_v1.a=d*C,this.m_v2.a=v*C,this.m_v3.a=b*C,this.m_count=3},V.b2SimplexCache=function(){this.indexA=new gt(3),this.indexB=new gt(3)},k.b2SimplexVertex=function(){},k.prototype.Set=function(t){this.wA.SetV(t.wA),this.wB.SetV(t.wB),this.w.SetV(t.w),this.a=t.a,this.indexA=t.indexA,this.indexB=t.indexB},P.b2TimeOfImpact=function(){},P.TimeOfImpact=function(t){++P.b2_toiCalls;var e=t.proxyA,i=t.proxyB,s=t.sweepA,r=t.sweepB;o.b2Assert(s.t0==r.t0),o.b2Assert(1-s.t0>Number.MIN_VALUE);var a=e.m_radius+i.m_radius,l=t.tolerance,h=0,c=0,m=0;for(P.s_cache.count=0,P.s_distanceInput.useRadii=!1;;){if(s.GetTransform(P.s_xfA,h),r.GetTransform(P.s_xfB,h),P.s_distanceInput.proxyA=e,P.s_distanceInput.proxyB=i,P.s_distanceInput.transformA=P.s_xfA,P.s_distanceInput.transformB=P.s_xfB,p.Distance(P.s_distanceOutput,P.s_cache,P.s_distanceInput),P.s_distanceOutput.distance<=0){h=1;break}P.s_fcn.Initialize(P.s_cache,e,P.s_xfA,i,P.s_xfB);var u=P.s_fcn.Evaluate(P.s_xfA,P.s_xfB);if(u<=0){h=1;break}if(0==c&&(m=u>a?n.Max(a-l,.75*a):n.Max(u-l,.02*a)),u-m<.5*l){if(0==c){h=1;break}break}var y=h,_=h,f=1,d=u;s.GetTransform(P.s_xfA,f),r.GetTransform(P.s_xfB,f);var v=P.s_fcn.Evaluate(P.s_xfA,P.s_xfB);if(v>=m){h=1;break}for(var b=0;;){var x;x=1&b?_+(m-d)*(f-_)/(v-d):.5*(_+f),s.GetTransform(P.s_xfA,x),r.GetTransform(P.s_xfB,x);var g=P.s_fcn.Evaluate(P.s_xfA,P.s_xfB);if(n.Abs(g-m)<.025*l){y=x;break}if(g>m?(_=x,d=g):(f=x,v=g),++b,++P.b2_toiRootIters,50==b)break}if(P.b2_toiMaxRootIters=n.Max(P.b2_toiMaxRootIters,b),y<(1+100*Number.MIN_VALUE)*h)break;if(h=y,c++,++P.b2_toiIters,1e3==c)break}return P.b2_toiMaxIters=n.Max(P.b2_toiMaxIters,c),h},dt.postDefs.push(function(){dt.Collision.b2TimeOfImpact.b2_toiCalls=0,dt.Collision.b2TimeOfImpact.b2_toiIters=0,dt.Collision.b2TimeOfImpact.b2_toiMaxIters=0,dt.Collision.b2TimeOfImpact.b2_toiRootIters=0,dt.Collision.b2TimeOfImpact.b2_toiMaxRootIters=0,dt.Collision.b2TimeOfImpact.s_cache=new V,dt.Collision.b2TimeOfImpact.s_distanceInput=new _,dt.Collision.b2TimeOfImpact.s_xfA=new r,dt.Collision.b2TimeOfImpact.s_xfB=new r,dt.Collision.b2TimeOfImpact.s_fcn=new B,dt.Collision.b2TimeOfImpact.s_distanceOutput=new f}),T.b2TOIInput=function(){this.proxyA=new d,this.proxyB=new d,this.sweepA=new s,this.sweepB=new s},G.b2WorldManifold=function(){this.m_normal=new a},G.prototype.b2WorldManifold=function(){this.m_points=new xt(o.b2_maxManifoldPoints);for(var t=0;t<o.b2_maxManifoldPoints;t++)this.m_points[t]=new a},G.prototype.Initialize=function(t,e,i,o,n){if(void 0===i&&(i=0),void 0===n&&(n=0),0!=t.m_pointCount){var s,r,a=0,l=0,h=0,c=0,m=0,u=0,y=0;switch(t.m_type){case w.e_circles:r=e.R,s=t.m_localPoint;var p=e.position.x+r.col1.x*s.x+r.col2.x*s.y,_=e.position.y+r.col1.y*s.x+r.col2.y*s.y;r=o.R,s=t.m_points[0].m_localPoint;var f=o.position.x+r.col1.x*s.x+r.col2.x*s.y,d=o.position.y+r.col1.y*s.x+r.col2.y*s.y,v=f-p,b=d-_,x=v*v+b*b;if(x>Number.MIN_VALUE*Number.MIN_VALUE){var g=Math.sqrt(x);this.m_normal.x=v/g,this.m_normal.y=b/g}else this.m_normal.x=1,this.m_normal.y=0;var C=p+i*this.m_normal.x,S=_+i*this.m_normal.y,A=f-n*this.m_normal.x,M=d-n*this.m_normal.y;this.m_points[0].x=.5*(C+A),this.m_points[0].y=.5*(S+M);break;case w.e_faceA:for(r=e.R,s=t.m_localPlaneNormal,l=r.col1.x*s.x+r.col2.x*s.y,h=r.col1.y*s.x+r.col2.y*s.y,r=e.R,s=t.m_localPoint,c=e.position.x+r.col1.x*s.x+r.col2.x*s.y,m=e.position.y+r.col1.y*s.x+r.col2.y*s.y,this.m_normal.x=l,this.m_normal.y=h,a=0;a<t.m_pointCount;a++)r=o.R,s=t.m_points[a].m_localPoint,u=o.position.x+r.col1.x*s.x+r.col2.x*s.y,y=o.position.y+r.col1.y*s.x+r.col2.y*s.y,this.m_points[a].x=u+.5*(i-(u-c)*l-(y-m)*h-n)*l,this.m_points[a].y=y+.5*(i-(u-c)*l-(y-m)*h-n)*h;break;case w.e_faceB:for(r=o.R,s=t.m_localPlaneNormal,l=r.col1.x*s.x+r.col2.x*s.y,h=r.col1.y*s.x+r.col2.y*s.y,r=o.R,s=t.m_localPoint,c=o.position.x+r.col1.x*s.x+r.col2.x*s.y,m=o.position.y+r.col1.y*s.x+r.col2.y*s.y,this.m_normal.x=-l,this.m_normal.y=-h,a=0;a<t.m_pointCount;a++)r=e.R,s=t.m_points[a].m_localPoint,u=e.position.x+r.col1.x*s.x+r.col2.x*s.y,y=e.position.y+r.col1.y*s.x+r.col2.y*s.y,this.m_points[a].x=u+.5*(n-(u-c)*l-(y-m)*h-i)*l,this.m_points[a].y=y+.5*(n-(u-c)*l-(y-m)*h-i)*h}}},L.ClipVertex=function(){this.v=new a,this.id=new u},L.prototype.Set=function(t){this.v.SetV(t.v),this.id.Set(t.id)},E.Features=function(){},Object.defineProperty(E.prototype,"referenceEdge",{enumerable:!1,configurable:!0,get:function(){return this._referenceEdge}}),Object.defineProperty(E.prototype,"referenceEdge",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._referenceEdge=t,this._m_id._key=4294967040&this._m_id._key|255&this._referenceEdge}}),Object.defineProperty(E.prototype,"incidentEdge",{enumerable:!1,configurable:!0,get:function(){return this._incidentEdge}}),Object.defineProperty(E.prototype,"incidentEdge",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._incidentEdge=t,this._m_id._key=4294902015&this._m_id._key|this._incidentEdge<<8&65280}}),Object.defineProperty(E.prototype,"incidentVertex",{enumerable:!1,configurable:!0,get:function(){return this._incidentVertex}}),Object.defineProperty(E.prototype,"incidentVertex",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._incidentVertex=t,this._m_id._key=4278255615&this._m_id._key|this._incidentVertex<<16&16711680}}),Object.defineProperty(E.prototype,"flip",{enumerable:!1,configurable:!0,get:function(){return this._flip}}),Object.defineProperty(E.prototype,"flip",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._flip=t,this._m_id._key=16777215&this._m_id._key|this._flip<<24&4278190080}})}(),function(){dt.Common.b2Color,dt.Common.b2internal;var t=dt.Common.b2Settings,e=dt.Collision.Shapes.b2CircleShape,i=dt.Collision.Shapes.b2EdgeChainDef,o=dt.Collision.Shapes.b2EdgeShape,n=dt.Collision.Shapes.b2MassData,s=dt.Collision.Shapes.b2PolygonShape,r=dt.Collision.Shapes.b2Shape,a=dt.Common.Math.b2Mat22;dt.Common.Math.b2Mat33;var l=dt.Common.Math.b2Math;dt.Common.Math.b2Sweep;var h=dt.Common.Math.b2Transform,c=dt.Common.Math.b2Vec2;dt.Common.Math.b2Vec3,dt.Dynamics.b2Body,dt.Dynamics.b2BodyDef,dt.Dynamics.b2ContactFilter,dt.Dynamics.b2ContactImpulse,dt.Dynamics.b2ContactListener,dt.Dynamics.b2ContactManager,dt.Dynamics.b2DebugDraw,dt.Dynamics.b2DestructionListener,dt.Dynamics.b2FilterData,dt.Dynamics.b2Fixture,dt.Dynamics.b2FixtureDef,dt.Dynamics.b2Island,dt.Dynamics.b2TimeStep,dt.Dynamics.b2World,dt.Collision.b2AABB,dt.Collision.b2Bound,dt.Collision.b2BoundValues,dt.Collision.b2Collision,dt.Collision.b2ContactID,dt.Collision.b2ContactPoint;var m=dt.Collision.b2Distance,u=dt.Collision.b2DistanceInput,y=dt.Collision.b2DistanceOutput,p=dt.Collision.b2DistanceProxy;dt.Collision.b2DynamicTree,dt.Collision.b2DynamicTreeBroadPhase,dt.Collision.b2DynamicTreeNode,dt.Collision.b2DynamicTreePair,dt.Collision.b2Manifold,dt.Collision.b2ManifoldPoint,dt.Collision.b2Point,dt.Collision.b2RayCastInput,dt.Collision.b2RayCastOutput,dt.Collision.b2Segment,dt.Collision.b2SeparationFunction,dt.Collision.b2Simplex;var _=dt.Collision.b2SimplexCache;dt.Collision.b2SimplexVertex,dt.Collision.b2TimeOfImpact,dt.Collision.b2TOIInput,dt.Collision.b2WorldManifold,dt.Collision.ClipVertex,dt.Collision.Features,dt.Collision.IBroadPhase,dt.inherit(e,dt.Collision.Shapes.b2Shape),e.prototype.__super=dt.Collision.Shapes.b2Shape.prototype,e.b2CircleShape=function(){dt.Collision.Shapes.b2Shape.b2Shape.apply(this,arguments),this.m_p=new c},e.prototype.Copy=function(){var t=new e;return t.Set(this),t},e.prototype.Set=function(t){if(this.__super.Set.call(this,t),dt.is(t,e)){var i=t instanceof e?t:null;this.m_p.SetV(i.m_p)}},e.prototype.TestPoint=function(t,e){var i=t.R,o=t.position.x+(i.col1.x*this.m_p.x+i.col2.x*this.m_p.y),n=t.position.y+(i.col1.y*this.m_p.x+i.col2.y*this.m_p.y);return(o=e.x-o)*o+(n=e.y-n)*n<=this.m_radius*this.m_radius},e.prototype.RayCast=function(t,e,i){var o=i.R,n=i.position.x+(o.col1.x*this.m_p.x+o.col2.x*this.m_p.y),s=i.position.y+(o.col1.y*this.m_p.x+o.col2.y*this.m_p.y),r=e.p1.x-n,a=e.p1.y-s,l=r*r+a*a-this.m_radius*this.m_radius,h=e.p2.x-e.p1.x,c=e.p2.y-e.p1.y,m=r*h+a*c,u=h*h+c*c,y=m*m-u*l;if(y<0||u<Number.MIN_VALUE)return!1;var p=-(m+Math.sqrt(y));return 0<=p&&p<=e.maxFraction*u&&(p/=u,t.fraction=p,t.normal.x=r+p*h,t.normal.y=a+p*c,t.normal.Normalize(),!0)},e.prototype.ComputeAABB=function(t,e){var i=e.R,o=e.position.x+(i.col1.x*this.m_p.x+i.col2.x*this.m_p.y),n=e.position.y+(i.col1.y*this.m_p.x+i.col2.y*this.m_p.y);t.lowerBound.Set(o-this.m_radius,n-this.m_radius),t.upperBound.Set(o+this.m_radius,n+this.m_radius)},e.prototype.ComputeMass=function(e,i){void 0===i&&(i=0),e.mass=i*t.b2_pi*this.m_radius*this.m_radius,e.center.SetV(this.m_p),e.I=e.mass*(.5*this.m_radius*this.m_radius+(this.m_p.x*this.m_p.x+this.m_p.y*this.m_p.y))},e.prototype.ComputeSubmergedArea=function(t,e,i,o){void 0===e&&(e=0);var n=l.MulX(i,this.m_p),s=-(l.Dot(t,n)-e);if(s<-this.m_radius+Number.MIN_VALUE)return 0;if(s>this.m_radius)return o.SetV(n),Math.PI*this.m_radius*this.m_radius;var r=this.m_radius*this.m_radius,a=s*s,h=r*(Math.asin(s/this.m_radius)+Math.PI/2)+s*Math.sqrt(r-a),c=-2/3*Math.pow(r-a,1.5)/h;return o.x=n.x+t.x*c,o.y=n.y+t.y*c,h},e.prototype.GetLocalPosition=function(){return this.m_p},e.prototype.SetLocalPosition=function(t){this.m_p.SetV(t)},e.prototype.GetRadius=function(){return this.m_radius},e.prototype.SetRadius=function(t){void 0===t&&(t=0),this.m_radius=t},e.prototype.b2CircleShape=function(t){void 0===t&&(t=0),this.__super.b2Shape.call(this),this.m_type=r.e_circleShape,this.m_radius=t},i.b2EdgeChainDef=function(){},i.prototype.b2EdgeChainDef=function(){this.vertexCount=0,this.isALoop=!0,this.vertices=[]},dt.inherit(o,dt.Collision.Shapes.b2Shape),o.prototype.__super=dt.Collision.Shapes.b2Shape.prototype,o.b2EdgeShape=function(){dt.Collision.Shapes.b2Shape.b2Shape.apply(this,arguments),this.s_supportVec=new c,this.m_v1=new c,this.m_v2=new c,this.m_coreV1=new c,this.m_coreV2=new c,this.m_normal=new c,this.m_direction=new c,this.m_cornerDir1=new c,this.m_cornerDir2=new c},o.prototype.TestPoint=function(t,e){return!1},o.prototype.RayCast=function(t,e,i){var o,n=e.p2.x-e.p1.x,s=e.p2.y-e.p1.y;o=i.R;var r=i.position.x+(o.col1.x*this.m_v1.x+o.col2.x*this.m_v1.y),a=i.position.y+(o.col1.y*this.m_v1.x+o.col2.y*this.m_v1.y),l=i.position.y+(o.col1.y*this.m_v2.x+o.col2.y*this.m_v2.y)-a,h=-(i.position.x+(o.col1.x*this.m_v2.x+o.col2.x*this.m_v2.y)-r),c=100*Number.MIN_VALUE,m=-(n*l+s*h);if(m>c){var u=e.p1.x-r,y=e.p1.y-a,p=u*l+y*h;if(0<=p&&p<=e.maxFraction*m){var _=-n*y+s*u;if(-c*m<=_&&_<=m*(1+c)){p/=m,t.fraction=p;var f=Math.sqrt(l*l+h*h);return t.normal.x=l/f,t.normal.y=h/f,!0}}}return!1},o.prototype.ComputeAABB=function(t,e){var i=e.R,o=e.position.x+(i.col1.x*this.m_v1.x+i.col2.x*this.m_v1.y),n=e.position.y+(i.col1.y*this.m_v1.x+i.col2.y*this.m_v1.y),s=e.position.x+(i.col1.x*this.m_v2.x+i.col2.x*this.m_v2.y),r=e.position.y+(i.col1.y*this.m_v2.x+i.col2.y*this.m_v2.y);o<s?(t.lowerBound.x=o,t.upperBound.x=s):(t.lowerBound.x=s,t.upperBound.x=o),n<r?(t.lowerBound.y=n,t.upperBound.y=r):(t.lowerBound.y=r,t.upperBound.y=n)},o.prototype.ComputeMass=function(t,e){t.mass=0,t.center.SetV(this.m_v1),t.I=0},o.prototype.ComputeSubmergedArea=function(t,e,i,o){void 0===e&&(e=0);var n=new c(t.x*e,t.y*e),s=l.MulX(i,this.m_v1),r=l.MulX(i,this.m_v2),a=l.Dot(t,s)-e,h=l.Dot(t,r)-e;if(a>0){if(h>0)return 0;s.x=-h/(a-h)*s.x+a/(a-h)*r.x,s.y=-h/(a-h)*s.y+a/(a-h)*r.y}else h>0&&(r.x=-h/(a-h)*s.x+a/(a-h)*r.x,r.y=-h/(a-h)*s.y+a/(a-h)*r.y);return o.x=(n.x+s.x+r.x)/3,o.y=(n.y+s.y+r.y)/3,.5*((s.x-n.x)*(r.y-n.y)-(s.y-n.y)*(r.x-n.x))},o.prototype.GetLength=function(){return this.m_length},o.prototype.GetVertex1=function(){return this.m_v1},o.prototype.GetVertex2=function(){return this.m_v2},o.prototype.GetCoreVertex1=function(){return this.m_coreV1},o.prototype.GetCoreVertex2=function(){return this.m_coreV2},o.prototype.GetNormalVector=function(){return this.m_normal},o.prototype.GetDirectionVector=function(){return this.m_direction},o.prototype.GetCorner1Vector=function(){return this.m_cornerDir1},o.prototype.GetCorner2Vector=function(){return this.m_cornerDir2},o.prototype.Corner1IsConvex=function(){return this.m_cornerConvex1},o.prototype.Corner2IsConvex=function(){return this.m_cornerConvex2},o.prototype.GetFirstVertex=function(t){var e=t.R;return new c(t.position.x+(e.col1.x*this.m_coreV1.x+e.col2.x*this.m_coreV1.y),t.position.y+(e.col1.y*this.m_coreV1.x+e.col2.y*this.m_coreV1.y))},o.prototype.GetNextEdge=function(){return this.m_nextEdge},o.prototype.GetPrevEdge=function(){return this.m_prevEdge},o.prototype.Support=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0);var o=t.R,n=t.position.x+(o.col1.x*this.m_coreV1.x+o.col2.x*this.m_coreV1.y),s=t.position.y+(o.col1.y*this.m_coreV1.x+o.col2.y*this.m_coreV1.y),r=t.position.x+(o.col1.x*this.m_coreV2.x+o.col2.x*this.m_coreV2.y),a=t.position.y+(o.col1.y*this.m_coreV2.x+o.col2.y*this.m_coreV2.y);return n*e+s*i>r*e+a*i?(this.s_supportVec.x=n,this.s_supportVec.y=s):(this.s_supportVec.x=r,this.s_supportVec.y=a),this.s_supportVec},o.prototype.b2EdgeShape=function(e,i){this.__super.b2Shape.call(this),this.m_type=r.e_edgeShape,this.m_prevEdge=null,this.m_nextEdge=null,this.m_v1=e,this.m_v2=i,this.m_direction.Set(this.m_v2.x-this.m_v1.x,this.m_v2.y-this.m_v1.y),this.m_length=this.m_direction.Normalize(),this.m_normal.Set(this.m_direction.y,-this.m_direction.x),this.m_coreV1.Set(-t.b2_toiSlop*(this.m_normal.x-this.m_direction.x)+this.m_v1.x,-t.b2_toiSlop*(this.m_normal.y-this.m_direction.y)+this.m_v1.y),this.m_coreV2.Set(-t.b2_toiSlop*(this.m_normal.x+this.m_direction.x)+this.m_v2.x,-t.b2_toiSlop*(this.m_normal.y+this.m_direction.y)+this.m_v2.y),this.m_cornerDir1=this.m_normal,this.m_cornerDir2.Set(-this.m_normal.x,-this.m_normal.y)},o.prototype.SetPrevEdge=function(t,e,i,o){this.m_prevEdge=t,this.m_coreV1=e,this.m_cornerDir1=i,this.m_cornerConvex1=o},o.prototype.SetNextEdge=function(t,e,i,o){this.m_nextEdge=t,this.m_coreV2=e,this.m_cornerDir2=i,this.m_cornerConvex2=o},n.b2MassData=function(){this.mass=0,this.center=new c(0,0),this.I=0},dt.inherit(s,dt.Collision.Shapes.b2Shape),s.prototype.__super=dt.Collision.Shapes.b2Shape.prototype,s.b2PolygonShape=function(){dt.Collision.Shapes.b2Shape.b2Shape.apply(this,arguments)},s.prototype.Copy=function(){var t=new s;return t.Set(this),t},s.prototype.Set=function(t){if(this.__super.Set.call(this,t),dt.is(t,s)){var e=t instanceof s?t:null;this.m_centroid.SetV(e.m_centroid),this.m_vertexCount=e.m_vertexCount,this.Reserve(this.m_vertexCount);for(var i=0;i<this.m_vertexCount;i++)this.m_vertices[i].SetV(e.m_vertices[i]),this.m_normals[i].SetV(e.m_normals[i])}},s.prototype.SetAsArray=function(t,e){void 0===e&&(e=0);var i,o=new xt,n=0;for(n=0;n<t.length;++n)i=t[n],o.push(i);this.SetAsVector(o,e)},s.AsArray=function(t,e){void 0===e&&(e=0);var i=new s;return i.SetAsArray(t,e),i},s.prototype.SetAsVector=function(e,i){void 0===i&&(i=0),0==i&&(i=e.length),t.b2Assert(2<=i),this.m_vertexCount=i,this.Reserve(i);var o=0;for(o=0;o<this.m_vertexCount;o++)this.m_vertices[o].SetV(e[o]);for(o=0;o<this.m_vertexCount;++o){var n=parseInt(o),r=parseInt(o+1<this.m_vertexCount?o+1:0),a=l.SubtractVV(this.m_vertices[r],this.m_vertices[n]);t.b2Assert(a.LengthSquared()>Number.MIN_VALUE),this.m_normals[o].SetV(l.CrossVF(a,1)),this.m_normals[o].Normalize()}this.m_centroid=s.ComputeCentroid(this.m_vertices,this.m_vertexCount)},s.AsVector=function(t,e){void 0===e&&(e=0);var i=new s;return i.SetAsVector(t,e),i},s.prototype.SetAsBox=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.m_vertexCount=4,this.Reserve(4),this.m_vertices[0].Set(-t,-e),this.m_vertices[1].Set(t,-e),this.m_vertices[2].Set(t,e),this.m_vertices[3].Set(-t,e),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid.SetZero()},s.AsBox=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0);var i=new s;return i.SetAsBox(t,e),i},s.prototype.SetAsOrientedBox=function(t,e,i,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=null),void 0===o&&(o=0),this.m_vertexCount=4,this.Reserve(4),this.m_vertices[0].Set(-t,-e),this.m_vertices[1].Set(t,-e),this.m_vertices[2].Set(t,e),this.m_vertices[3].Set(-t,e),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid=i;var n=new h;n.position=i,n.R.Set(o);for(var s=0;s<this.m_vertexCount;++s)this.m_vertices[s]=l.MulX(n,this.m_vertices[s]),this.m_normals[s]=l.MulMV(n.R,this.m_normals[s])},s.AsOrientedBox=function(t,e,i,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=null),void 0===o&&(o=0);var n=new s;return n.SetAsOrientedBox(t,e,i,o),n},s.prototype.SetAsEdge=function(t,e){this.m_vertexCount=2,this.Reserve(2),this.m_vertices[0].SetV(t),this.m_vertices[1].SetV(e),this.m_centroid.x=.5*(t.x+e.x),this.m_centroid.y=.5*(t.y+e.y),this.m_normals[0]=l.CrossVF(l.SubtractVV(e,t),1),this.m_normals[0].Normalize(),this.m_normals[1].x=-this.m_normals[0].x,this.m_normals[1].y=-this.m_normals[0].y},s.AsEdge=function(t,e){var i=new s;return i.SetAsEdge(t,e),i},s.prototype.TestPoint=function(t,e){for(var i,o=t.R,n=e.x-t.position.x,s=e.y-t.position.y,r=n*o.col1.x+s*o.col1.y,a=n*o.col2.x+s*o.col2.y,l=0;l<this.m_vertexCount;++l)if(n=r-(i=this.m_vertices[l]).x,s=a-i.y,(i=this.m_normals[l]).x*n+i.y*s>0)return!1;return!0},s.prototype.RayCast=function(t,e,i){var o,n,s=0,r=e.maxFraction,a=0,l=0;a=e.p1.x-i.position.x,l=e.p1.y-i.position.y;var h=a*(o=i.R).col1.x+l*o.col1.y,c=a*o.col2.x+l*o.col2.y;a=e.p2.x-i.position.x,l=e.p2.y-i.position.y;for(var m=a*(o=i.R).col1.x+l*o.col1.y-h,u=a*o.col2.x+l*o.col2.y-c,y=parseInt(-1),p=0;p<this.m_vertexCount;++p){a=(n=this.m_vertices[p]).x-h,l=n.y-c;var _=(n=this.m_normals[p]).x*a+n.y*l,f=n.x*m+n.y*u;if(0==f){if(_<0)return!1}else f<0&&_<s*f?(s=_/f,y=p):f>0&&_<r*f&&(r=_/f);if(r<s-Number.MIN_VALUE)return!1}return y>=0&&(t.fraction=s,o=i.R,n=this.m_normals[y],t.normal.x=o.col1.x*n.x+o.col2.x*n.y,t.normal.y=o.col1.y*n.x+o.col2.y*n.y,!0)},s.prototype.ComputeAABB=function(t,e){for(var i=e.R,o=this.m_vertices[0],n=e.position.x+(i.col1.x*o.x+i.col2.x*o.y),s=e.position.y+(i.col1.y*o.x+i.col2.y*o.y),r=n,a=s,l=1;l<this.m_vertexCount;++l){o=this.m_vertices[l];var h=e.position.x+(i.col1.x*o.x+i.col2.x*o.y),c=e.position.y+(i.col1.y*o.x+i.col2.y*o.y);n=n<h?n:h,s=s<c?s:c,r=r>h?r:h,a=a>c?a:c}t.lowerBound.x=n-this.m_radius,t.lowerBound.y=s-this.m_radius,t.upperBound.x=r+this.m_radius,t.upperBound.y=a+this.m_radius},s.prototype.ComputeMass=function(t,e){if(void 0===e&&(e=0),2==this.m_vertexCount)return t.center.x=.5*(this.m_vertices[0].x+this.m_vertices[1].x),t.center.y=.5*(this.m_vertices[0].y+this.m_vertices[1].y),t.mass=0,void(t.I=0);for(var i=0,o=0,n=0,s=0,r=1/3,a=0;a<this.m_vertexCount;++a){var l=this.m_vertices[a],h=a+1<this.m_vertexCount?this.m_vertices[parseInt(a+1)]:this.m_vertices[0],c=l.x-0,m=l.y-0,u=h.x-0,y=h.y-0,p=c*y-m*u,_=.5*p;n+=_,i+=_*r*(0+l.x+h.x),o+=_*r*(0+l.y+h.y),s+=p*(r*(.25*(c*c+u*c+u*u)+(0*c+0*u))+0+(r*(.25*(m*m+y*m+y*y)+(0*m+0*y))+0))}t.mass=e*n,i*=1/n,o*=1/n,t.center.Set(i,o),t.I=e*s},s.prototype.ComputeSubmergedArea=function(t,e,i,o){void 0===e&&(e=0);var s=l.MulTMV(i.R,t),r=e-l.Dot(t,i.position),a=new gt,h=0,m=parseInt(-1),u=parseInt(-1),y=!1,p=0;for(p=0;p<this.m_vertexCount;++p){a[p]=l.Dot(s,this.m_vertices[p])-r;var _=a[p]<-Number.MIN_VALUE;p>0&&(_?y||(m=p-1,h++):y&&(u=p-1,h++)),y=_}switch(h){case 0:if(y){var f=new n;return this.ComputeMass(f,1),o.SetV(l.MulX(i,f.center)),f.mass}return 0;case 1:-1==m?m=this.m_vertexCount-1:u=this.m_vertexCount-1}var d,v=parseInt((m+1)%this.m_vertexCount),b=parseInt((u+1)%this.m_vertexCount),x=(0-a[m])/(a[v]-a[m]),g=(0-a[u])/(a[b]-a[u]),w=new c(this.m_vertices[m].x*(1-x)+this.m_vertices[v].x*x,this.m_vertices[m].y*(1-x)+this.m_vertices[v].y*x),C=new c(this.m_vertices[u].x*(1-g)+this.m_vertices[b].x*g,this.m_vertices[u].y*(1-g)+this.m_vertices[b].y*g),S=0,A=new c,M=this.m_vertices[v];for(p=v;p!=b;){d=(p=(p+1)%this.m_vertexCount)==b?C:this.m_vertices[p];var D=.5*((M.x-w.x)*(d.y-w.y)-(M.y-w.y)*(d.x-w.x));S+=D,A.x+=D*(w.x+M.x+d.x)/3,A.y+=D*(w.y+M.y+d.y)/3,M=d}return A.Multiply(1/S),o.SetV(l.MulX(i,A)),S},s.prototype.GetVertexCount=function(){return this.m_vertexCount},s.prototype.GetVertices=function(){return this.m_vertices},s.prototype.GetNormals=function(){return this.m_normals},s.prototype.GetSupport=function(t){for(var e=0,i=this.m_vertices[0].x*t.x+this.m_vertices[0].y*t.y,o=1;o<this.m_vertexCount;++o){var n=this.m_vertices[o].x*t.x+this.m_vertices[o].y*t.y;n>i&&(e=o,i=n)}return e},s.prototype.GetSupportVertex=function(t){for(var e=0,i=this.m_vertices[0].x*t.x+this.m_vertices[0].y*t.y,o=1;o<this.m_vertexCount;++o){var n=this.m_vertices[o].x*t.x+this.m_vertices[o].y*t.y;n>i&&(e=o,i=n)}return this.m_vertices[e]},s.prototype.Validate=function(){return!1},s.prototype.b2PolygonShape=function(){this.__super.b2Shape.call(this),this.m_type=r.e_polygonShape,this.m_centroid=new c,this.m_vertices=new xt,this.m_normals=new xt},s.prototype.Reserve=function(t){void 0===t&&(t=0);for(var e=parseInt(this.m_vertices.length);e<t;e++)this.m_vertices[e]=new c,this.m_normals[e]=new c},s.ComputeCentroid=function(t,e){void 0===e&&(e=0);for(var i=new c,o=0,n=1/3,s=0;s<e;++s){var r=t[s],a=s+1<e?t[parseInt(s+1)]:t[0],l=r.x-0,h=r.y-0,m=a.x-0,u=.5*(l*(a.y-0)-h*m);o+=u,i.x+=u*n*(0+r.x+a.x),i.y+=u*n*(0+r.y+a.y)}return i.x*=1/o,i.y*=1/o,i},s.ComputeOBB=function(t,e,i){void 0===i&&(i=0);var o=0,n=new xt(i+1);for(o=0;o<i;++o)n[o]=e[o];n[i]=n[0];var s=Number.MAX_VALUE;for(o=1;o<=i;++o){for(var r=n[parseInt(o-1)],a=n[o].x-r.x,l=n[o].y-r.y,h=Math.sqrt(a*a+l*l),c=-(l/=h),m=a/=h,u=Number.MAX_VALUE,y=Number.MAX_VALUE,p=-Number.MAX_VALUE,_=-Number.MAX_VALUE,f=0;f<i;++f){var d=n[f].x-r.x,v=n[f].y-r.y,b=a*d+l*v,x=c*d+m*v;b<u&&(u=b),x<y&&(y=x),b>p&&(p=b),x>_&&(_=x)}var g=(p-u)*(_-y);if(g<.95*s){s=g,t.R.col1.x=a,t.R.col1.y=l,t.R.col2.x=c,t.R.col2.y=m;var w=.5*(u+p),C=.5*(y+_),S=t.R;t.center.x=r.x+(S.col1.x*w+S.col2.x*C),t.center.y=r.y+(S.col1.y*w+S.col2.y*C),t.extents.x=.5*(p-u),t.extents.y=.5*(_-y)}}},dt.postDefs.push(function(){dt.Collision.Shapes.b2PolygonShape.s_mat=new a}),r.b2Shape=function(){},r.prototype.Copy=function(){return null},r.prototype.Set=function(t){this.m_radius=t.m_radius},r.prototype.GetType=function(){return this.m_type},r.prototype.TestPoint=function(t,e){return!1},r.prototype.RayCast=function(t,e,i){return!1},r.prototype.ComputeAABB=function(t,e){},r.prototype.ComputeMass=function(t,e){},r.prototype.ComputeSubmergedArea=function(t,e,i,o){return 0},r.TestOverlap=function(t,e,i,o){var n=new u;n.proxyA=new p,n.proxyA.Set(t),n.proxyB=new p,n.proxyB.Set(i),n.transformA=e,n.transformB=o,n.useRadii=!0;var s=new _;s.count=0;var r=new y;return m.Distance(r,s,n),r.distance<10*Number.MIN_VALUE},r.prototype.b2Shape=function(){this.m_type=r.e_unknownShape,this.m_radius=t.b2_linearSlop},dt.postDefs.push(function(){dt.Collision.Shapes.b2Shape.e_unknownShape=parseInt(-1),dt.Collision.Shapes.b2Shape.e_circleShape=0,dt.Collision.Shapes.b2Shape.e_polygonShape=1,dt.Collision.Shapes.b2Shape.e_edgeShape=2,dt.Collision.Shapes.b2Shape.e_shapeTypeCount=3,dt.Collision.Shapes.b2Shape.e_hitCollide=1,dt.Collision.Shapes.b2Shape.e_missCollide=0,dt.Collision.Shapes.b2Shape.e_startsInsideCollide=parseInt(-1)})}(),function(){var t=dt.Common.b2Color;dt.Common.b2internal;var e=dt.Common.b2Settings;dt.Common.Math.b2Mat22,dt.Common.Math.b2Mat33;var i=dt.Common.Math.b2Math;dt.Common.Math.b2Sweep,dt.Common.Math.b2Transform,dt.Common.Math.b2Vec2,dt.Common.Math.b2Vec3,t.b2Color=function(){this._r=0,this._g=0,this._b=0},t.prototype.b2Color=function(t,e,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===o&&(o=0),this._r=dt.parseUInt(255*i.Clamp(t,0,1)),this._g=dt.parseUInt(255*i.Clamp(e,0,1)),this._b=dt.parseUInt(255*i.Clamp(o,0,1))},t.prototype.Set=function(t,e,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===o&&(o=0),this._r=dt.parseUInt(255*i.Clamp(t,0,1)),this._g=dt.parseUInt(255*i.Clamp(e,0,1)),this._b=dt.parseUInt(255*i.Clamp(o,0,1))},Object.defineProperty(t.prototype,"r",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._r=dt.parseUInt(255*i.Clamp(t,0,1))}}),Object.defineProperty(t.prototype,"g",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._g=dt.parseUInt(255*i.Clamp(t,0,1))}}),Object.defineProperty(t.prototype,"b",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._b=dt.parseUInt(255*i.Clamp(t,0,1))}}),Object.defineProperty(t.prototype,"color",{enumerable:!1,configurable:!0,get:function(){return this._r<<16|this._g<<8|this._b}}),e.b2Settings=function(){},e.b2MixFriction=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),Math.sqrt(t*e)},e.b2MixRestitution=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),t>e?t:e},e.b2Assert=function(t){if(!t)throw"Assertion Failed"},dt.postDefs.push(function(){dt.Common.b2Settings.VERSION="2.1alpha",dt.Common.b2Settings.USHRT_MAX=65535,dt.Common.b2Settings.b2_pi=Math.PI,dt.Common.b2Settings.b2_maxManifoldPoints=2,dt.Common.b2Settings.b2_aabbExtension=.1,dt.Common.b2Settings.b2_aabbMultiplier=2,dt.Common.b2Settings.b2_polygonRadius=2*e.b2_linearSlop,dt.Common.b2Settings.b2_linearSlop=.005,dt.Common.b2Settings.b2_angularSlop=2/180*e.b2_pi,dt.Common.b2Settings.b2_toiSlop=8*e.b2_linearSlop,dt.Common.b2Settings.b2_maxTOIContactsPerIsland=32,dt.Common.b2Settings.b2_maxTOIJointsPerIsland=32,dt.Common.b2Settings.b2_velocityThreshold=1,dt.Common.b2Settings.b2_maxLinearCorrection=.2,dt.Common.b2Settings.b2_maxAngularCorrection=8/180*e.b2_pi,dt.Common.b2Settings.b2_maxTranslation=2,dt.Common.b2Settings.b2_maxTranslationSquared=e.b2_maxTranslation*e.b2_maxTranslation,dt.Common.b2Settings.b2_maxRotation=.5*e.b2_pi,dt.Common.b2Settings.b2_maxRotationSquared=e.b2_maxRotation*e.b2_maxRotation,dt.Common.b2Settings.b2_contactBaumgarte=.2,dt.Common.b2Settings.b2_timeToSleep=.5,dt.Common.b2Settings.b2_linearSleepTolerance=.01,dt.Common.b2Settings.b2_angularSleepTolerance=2/180*e.b2_pi})}(),function(){dt.Collision.b2AABB,dt.Common.b2Color,dt.Common.b2internal,dt.Common.b2Settings;var t=dt.Common.Math.b2Mat22,e=dt.Common.Math.b2Mat33,i=dt.Common.Math.b2Math,o=dt.Common.Math.b2Sweep,n=dt.Common.Math.b2Transform,s=dt.Common.Math.b2Vec2,r=dt.Common.Math.b2Vec3;t.b2Mat22=function(){this.col1=new s,this.col2=new s},t.prototype.b2Mat22=function(){this.SetIdentity()},t.FromAngle=function(e){void 0===e&&(e=0);var i=new t;return i.Set(e),i},t.FromVV=function(e,i){var o=new t;return o.SetVV(e,i),o},t.prototype.Set=function(t){void 0===t&&(t=0);var e=Math.cos(t),i=Math.sin(t);this.col1.x=e,this.col2.x=-i,this.col1.y=i,this.col2.y=e},t.prototype.SetVV=function(t,e){this.col1.SetV(t),this.col2.SetV(e)},t.prototype.Copy=function(){var e=new t;return e.SetM(this),e},t.prototype.SetM=function(t){this.col1.SetV(t.col1),this.col2.SetV(t.col2)},t.prototype.AddM=function(t){this.col1.x+=t.col1.x,this.col1.y+=t.col1.y,this.col2.x+=t.col2.x,this.col2.y+=t.col2.y},t.prototype.SetIdentity=function(){this.col1.x=1,this.col2.x=0,this.col1.y=0,this.col2.y=1},t.prototype.SetZero=function(){this.col1.x=0,this.col2.x=0,this.col1.y=0,this.col2.y=0},t.prototype.GetAngle=function(){return Math.atan2(this.col1.y,this.col1.x)},t.prototype.GetInverse=function(t){var e=this.col1.x,i=this.col2.x,o=this.col1.y,n=this.col2.y,s=e*n-i*o;return 0!=s&&(s=1/s),t.col1.x=s*n,t.col2.x=-s*i,t.col1.y=-s*o,t.col2.y=s*e,t},t.prototype.Solve=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0);var o=this.col1.x,n=this.col2.x,s=this.col1.y,r=this.col2.y,a=o*r-n*s;return 0!=a&&(a=1/a),t.x=a*(r*e-n*i),t.y=a*(o*i-s*e),t},t.prototype.Abs=function(){this.col1.Abs(),this.col2.Abs()},e.b2Mat33=function(){this.col1=new r,this.col2=new r,this.col3=new r},e.prototype.b2Mat33=function(t,e,i){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=null),t||e||i?(this.col1.SetV(t),this.col2.SetV(e),this.col3.SetV(i)):(this.col1.SetZero(),this.col2.SetZero(),this.col3.SetZero())},e.prototype.SetVVV=function(t,e,i){this.col1.SetV(t),this.col2.SetV(e),this.col3.SetV(i)},e.prototype.Copy=function(){return new e(this.col1,this.col2,this.col3)},e.prototype.SetM=function(t){this.col1.SetV(t.col1),this.col2.SetV(t.col2),this.col3.SetV(t.col3)},e.prototype.AddM=function(t){this.col1.x+=t.col1.x,this.col1.y+=t.col1.y,this.col1.z+=t.col1.z,this.col2.x+=t.col2.x,this.col2.y+=t.col2.y,this.col2.z+=t.col2.z,this.col3.x+=t.col3.x,this.col3.y+=t.col3.y,this.col3.z+=t.col3.z},e.prototype.SetIdentity=function(){this.col1.x=1,this.col2.x=0,this.col3.x=0,this.col1.y=0,this.col2.y=1,this.col3.y=0,this.col1.z=0,this.col2.z=0,this.col3.z=1},e.prototype.SetZero=function(){this.col1.x=0,this.col2.x=0,this.col3.x=0,this.col1.y=0,this.col2.y=0,this.col3.y=0,this.col1.z=0,this.col2.z=0,this.col3.z=0},e.prototype.Solve22=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0);var o=this.col1.x,n=this.col2.x,s=this.col1.y,r=this.col2.y,a=o*r-n*s;return 0!=a&&(a=1/a),t.x=a*(r*e-n*i),t.y=a*(o*i-s*e),t},e.prototype.Solve33=function(t,e,i,o){void 0===e&&(e=0),void 0===i&&(i=0),void 0===o&&(o=0);var n=this.col1.x,s=this.col1.y,r=this.col1.z,a=this.col2.x,l=this.col2.y,h=this.col2.z,c=this.col3.x,m=this.col3.y,u=this.col3.z,y=n*(l*u-h*m)+s*(h*c-a*u)+r*(a*m-l*c);return 0!=y&&(y=1/y),t.x=y*(e*(l*u-h*m)+i*(h*c-a*u)+o*(a*m-l*c)),t.y=y*(n*(i*u-o*m)+s*(o*c-e*u)+r*(e*m-i*c)),t.z=y*(n*(l*o-h*i)+s*(h*e-a*o)+r*(a*i-l*e)),t},i.b2Math=function(){},i.IsValid=function(t){return void 0===t&&(t=0),isFinite(t)},i.Dot=function(t,e){return t.x*e.x+t.y*e.y},i.CrossVV=function(t,e){return t.x*e.y-t.y*e.x},i.CrossVF=function(t,e){return void 0===e&&(e=0),new s(e*t.y,-e*t.x)},i.CrossFV=function(t,e){return void 0===t&&(t=0),new s(-t*e.y,t*e.x)},i.MulMV=function(t,e){return new s(t.col1.x*e.x+t.col2.x*e.y,t.col1.y*e.x+t.col2.y*e.y)},i.MulTMV=function(t,e){return new s(i.Dot(e,t.col1),i.Dot(e,t.col2))},i.MulX=function(t,e){var o=i.MulMV(t.R,e);return o.x+=t.position.x,o.y+=t.position.y,o},i.MulXT=function(t,e){var o=i.SubtractVV(e,t.position),n=o.x*t.R.col1.x+o.y*t.R.col1.y;return o.y=o.x*t.R.col2.x+o.y*t.R.col2.y,o.x=n,o},i.AddVV=function(t,e){return new s(t.x+e.x,t.y+e.y)},i.SubtractVV=function(t,e){return new s(t.x-e.x,t.y-e.y)},i.Distance=function(t,e){var i=t.x-e.x,o=t.y-e.y;return Math.sqrt(i*i+o*o)},i.DistanceSquared=function(t,e){var i=t.x-e.x,o=t.y-e.y;return i*i+o*o},i.MulFV=function(t,e){return void 0===t&&(t=0),new s(t*e.x,t*e.y)},i.AddMM=function(e,o){return t.FromVV(i.AddVV(e.col1,o.col1),i.AddVV(e.col2,o.col2))},i.MulMM=function(e,o){return t.FromVV(i.MulMV(e,o.col1),i.MulMV(e,o.col2))},i.MulTMM=function(e,o){var n=new s(i.Dot(e.col1,o.col1),i.Dot(e.col2,o.col1)),r=new s(i.Dot(e.col1,o.col2),i.Dot(e.col2,o.col2));return t.FromVV(n,r)},i.Abs=function(t){return void 0===t&&(t=0),t>0?t:-t},i.AbsV=function(t){return new s(i.Abs(t.x),i.Abs(t.y))},i.AbsM=function(e){return t.FromVV(i.AbsV(e.col1),i.AbsV(e.col2))},i.Min=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),t<e?t:e},i.MinV=function(t,e){return new s(i.Min(t.x,e.x),i.Min(t.y,e.y))},i.Max=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),t>e?t:e},i.MaxV=function(t,e){return new s(i.Max(t.x,e.x),i.Max(t.y,e.y))},i.Clamp=function(t,e,i){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),t<e?e:t>i?i:t},i.ClampV=function(t,e,o){return i.MaxV(e,i.MinV(t,o))},i.Swap=function(t,e){var i=t[0];t[0]=e[0],e[0]=i},i.Random=function(){return 2*Math.random()-1},i.RandomRange=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0);var i=Math.random();return(e-t)*i+t},i.NextPowerOfTwo=function(t){return void 0===t&&(t=0),t|=t>>1&2147483647,t|=t>>2&1073741823,t|=t>>4&268435455,t|=t>>8&16777215,1+(t|=t>>16&65535)},i.IsPowerOfTwo=function(t){return void 0===t&&(t=0),t>0&&!(t&t-1)},dt.postDefs.push(function(){dt.Common.Math.b2Math.b2Vec2_zero=new s(0,0),dt.Common.Math.b2Math.b2Mat22_identity=t.FromVV(new s(1,0),new s(0,1)),dt.Common.Math.b2Math.b2Transform_identity=new n(i.b2Vec2_zero,i.b2Mat22_identity)}),o.b2Sweep=function(){this.localCenter=new s,this.c0=new s,this.c=new s},o.prototype.Set=function(t){this.localCenter.SetV(t.localCenter),this.c0.SetV(t.c0),this.c.SetV(t.c),this.a0=t.a0,this.a=t.a,this.t0=t.t0},o.prototype.Copy=function(){var t=new o;return t.localCenter.SetV(this.localCenter),t.c0.SetV(this.c0),t.c.SetV(this.c),t.a0=this.a0,t.a=this.a,t.t0=this.t0,t},o.prototype.GetTransform=function(t,e){void 0===e&&(e=0),t.position.x=(1-e)*this.c0.x+e*this.c.x,t.position.y=(1-e)*this.c0.y+e*this.c.y;var i=(1-e)*this.a0+e*this.a;t.R.Set(i);var o=t.R;t.position.x-=o.col1.x*this.localCenter.x+o.col2.x*this.localCenter.y,t.position.y-=o.col1.y*this.localCenter.x+o.col2.y*this.localCenter.y},o.prototype.Advance=function(t){if(void 0===t&&(t=0),this.t0<t&&1-this.t0>Number.MIN_VALUE){var e=(t-this.t0)/(1-this.t0);this.c0.x=(1-e)*this.c0.x+e*this.c.x,this.c0.y=(1-e)*this.c0.y+e*this.c.y,this.a0=(1-e)*this.a0+e*this.a,this.t0=t}},n.b2Transform=function(){this.position=new s,this.R=new t},n.prototype.b2Transform=function(t,e){void 0===t&&(t=null),void 0===e&&(e=null),t&&(this.position.SetV(t),this.R.SetM(e))},n.prototype.Initialize=function(t,e){this.position.SetV(t),this.R.SetM(e)},n.prototype.SetIdentity=function(){this.position.SetZero(),this.R.SetIdentity()},n.prototype.Set=function(t){this.position.SetV(t.position),this.R.SetM(t.R)},n.prototype.GetAngle=function(){return Math.atan2(this.R.col1.y,this.R.col1.x)},s.b2Vec2=function(){},s.prototype.b2Vec2=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e},s.prototype.SetZero=function(){this.x=0,this.y=0},s.prototype.Set=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e},s.prototype.SetV=function(t){this.x=t.x,this.y=t.y},s.prototype.GetNegative=function(){return new s(-this.x,-this.y)},s.prototype.NegativeSelf=function(){this.x=-this.x,this.y=-this.y},s.Make=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),new s(t,e)},s.prototype.Copy=function(){return new s(this.x,this.y)},s.prototype.Add=function(t){this.x+=t.x,this.y+=t.y},s.prototype.Subtract=function(t){this.x-=t.x,this.y-=t.y},s.prototype.Multiply=function(t){void 0===t&&(t=0),this.x*=t,this.y*=t},s.prototype.MulM=function(t){var e=this.x;this.x=t.col1.x*e+t.col2.x*this.y,this.y=t.col1.y*e+t.col2.y*this.y},s.prototype.MulTM=function(t){var e=i.Dot(this,t.col1);this.y=i.Dot(this,t.col2),this.x=e},s.prototype.CrossVF=function(t){void 0===t&&(t=0);var e=this.x;this.x=t*this.y,this.y=-t*e},s.prototype.CrossFV=function(t){void 0===t&&(t=0);var e=this.x;this.x=-t*this.y,this.y=t*e},s.prototype.MinV=function(t){this.x=this.x<t.x?this.x:t.x,this.y=this.y<t.y?this.y:t.y},s.prototype.MaxV=function(t){this.x=this.x>t.x?this.x:t.x,this.y=this.y>t.y?this.y:t.y},s.prototype.Abs=function(){this.x<0&&(this.x=-this.x),this.y<0&&(this.y=-this.y)},s.prototype.Length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},s.prototype.LengthSquared=function(){return this.x*this.x+this.y*this.y},s.prototype.Normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y);if(t<Number.MIN_VALUE)return 0;var e=1/t;return this.x*=e,this.y*=e,t},s.prototype.IsValid=function(){return i.IsValid(this.x)&&i.IsValid(this.y)},r.b2Vec3=function(){},r.prototype.b2Vec3=function(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=i},r.prototype.SetZero=function(){this.x=this.y=this.z=0},r.prototype.Set=function(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=i},r.prototype.SetV=function(t){this.x=t.x,this.y=t.y,this.z=t.z},r.prototype.GetNegative=function(){return new r(-this.x,-this.y,-this.z)},r.prototype.NegativeSelf=function(){this.x=-this.x,this.y=-this.y,this.z=-this.z},r.prototype.Copy=function(){return new r(this.x,this.y,this.z)},r.prototype.Add=function(t){this.x+=t.x,this.y+=t.y,this.z+=t.z},r.prototype.Subtract=function(t){this.x-=t.x,this.y-=t.y,this.z-=t.z},r.prototype.Multiply=function(t){void 0===t&&(t=0),this.x*=t,this.y*=t,this.z*=t}}(),function(){dt.Dynamics.Controllers.b2ControllerEdge,dt.Common.Math.b2Mat22,dt.Common.Math.b2Mat33;var t=dt.Common.Math.b2Math,e=dt.Common.Math.b2Sweep,i=dt.Common.Math.b2Transform,o=dt.Common.Math.b2Vec2;dt.Common.Math.b2Vec3;var n=dt.Common.b2Color;dt.Common.b2internal;var s=dt.Common.b2Settings,r=dt.Collision.b2AABB;dt.Collision.b2Bound,dt.Collision.b2BoundValues,dt.Collision.b2Collision,dt.Collision.b2ContactID;var a=dt.Collision.b2ContactPoint;dt.Collision.b2Distance,dt.Collision.b2DistanceInput,dt.Collision.b2DistanceOutput,dt.Collision.b2DistanceProxy,dt.Collision.b2DynamicTree;var l=dt.Collision.b2DynamicTreeBroadPhase;dt.Collision.b2DynamicTreeNode,dt.Collision.b2DynamicTreePair,dt.Collision.b2Manifold,dt.Collision.b2ManifoldPoint,dt.Collision.b2Point;var h=dt.Collision.b2RayCastInput,c=dt.Collision.b2RayCastOutput;dt.Collision.b2Segment,dt.Collision.b2SeparationFunction,dt.Collision.b2Simplex,dt.Collision.b2SimplexCache,dt.Collision.b2SimplexVertex,dt.Collision.b2TimeOfImpact,dt.Collision.b2TOIInput,dt.Collision.b2WorldManifold,dt.Collision.ClipVertex,dt.Collision.Features,dt.Collision.IBroadPhase;var m=dt.Collision.Shapes.b2CircleShape;dt.Collision.Shapes.b2EdgeChainDef;var u=dt.Collision.Shapes.b2EdgeShape,y=dt.Collision.Shapes.b2MassData,p=dt.Collision.Shapes.b2PolygonShape,_=dt.Collision.Shapes.b2Shape,f=dt.Dynamics.b2Body,d=dt.Dynamics.b2BodyDef,v=dt.Dynamics.b2ContactFilter,b=dt.Dynamics.b2ContactImpulse,x=dt.Dynamics.b2ContactListener,g=dt.Dynamics.b2ContactManager,w=dt.Dynamics.b2DebugDraw,C=dt.Dynamics.b2DestructionListener,S=dt.Dynamics.b2FilterData,A=dt.Dynamics.b2Fixture,M=dt.Dynamics.b2FixtureDef,D=dt.Dynamics.b2Island,B=dt.Dynamics.b2TimeStep,I=dt.Dynamics.b2World;dt.Dynamics.Contacts.b2CircleContact;var V=dt.Dynamics.Contacts.b2Contact;dt.Dynamics.Contacts.b2ContactConstraint,dt.Dynamics.Contacts.b2ContactConstraintPoint,dt.Dynamics.Contacts.b2ContactEdge;var k=dt.Dynamics.Contacts.b2ContactFactory;dt.Dynamics.Contacts.b2ContactRegister,dt.Dynamics.Contacts.b2ContactResult;var P=dt.Dynamics.Contacts.b2ContactSolver;dt.Dynamics.Contacts.b2EdgeAndCircleContact,dt.Dynamics.Contacts.b2NullContact,dt.Dynamics.Contacts.b2PolyAndCircleContact,dt.Dynamics.Contacts.b2PolyAndEdgeContact,dt.Dynamics.Contacts.b2PolygonContact,dt.Dynamics.Contacts.b2PositionSolverManifold,dt.Dynamics.Controllers.b2Controller,dt.Dynamics.Joints.b2DistanceJoint,dt.Dynamics.Joints.b2DistanceJointDef,dt.Dynamics.Joints.b2FrictionJoint,dt.Dynamics.Joints.b2FrictionJointDef,dt.Dynamics.Joints.b2GearJoint,dt.Dynamics.Joints.b2GearJointDef,dt.Dynamics.Joints.b2Jacobian;var T=dt.Dynamics.Joints.b2Joint;dt.Dynamics.Joints.b2JointDef,dt.Dynamics.Joints.b2JointEdge,dt.Dynamics.Joints.b2LineJoint,dt.Dynamics.Joints.b2LineJointDef,dt.Dynamics.Joints.b2MouseJoint,dt.Dynamics.Joints.b2MouseJointDef,dt.Dynamics.Joints.b2PrismaticJoint,dt.Dynamics.Joints.b2PrismaticJointDef;var G=dt.Dynamics.Joints.b2PulleyJoint;dt.Dynamics.Joints.b2PulleyJointDef,dt.Dynamics.Joints.b2RevoluteJoint,dt.Dynamics.Joints.b2RevoluteJointDef,dt.Dynamics.Joints.b2WeldJoint,dt.Dynamics.Joints.b2WeldJointDef,f.b2Body=function(){this.m_xf=new i,this.m_sweep=new e,this.m_linearVelocity=new o,this.m_force=new o},f.prototype.connectEdges=function(e,i,o){void 0===o&&(o=0);var n=Math.atan2(i.GetDirectionVector().y,i.GetDirectionVector().x),r=Math.tan(.5*(n-o)),a=t.MulFV(r,i.GetDirectionVector());a=t.SubtractVV(a,i.GetNormalVector()),a=t.MulFV(s.b2_toiSlop,a),a=t.AddVV(a,i.GetVertex1());var l=t.AddVV(e.GetDirectionVector(),i.GetDirectionVector());l.Normalize();var h=t.Dot(e.GetDirectionVector(),i.GetNormalVector())>0;return e.SetNextEdge(i,a,l,h),i.SetPrevEdge(e,a,l,h),n},f.prototype.CreateFixture=function(t){if(1==this.m_world.IsLocked())return null;var e=new A;if(e.Create(this,this.m_xf,t),this.m_flags&f.e_activeFlag){var i=this.m_world.m_contactManager.m_broadPhase;e.CreateProxy(i,this.m_xf)}return e.m_next=this.m_fixtureList,this.m_fixtureList=e,++this.m_fixtureCount,e.m_body=this,e.m_density>0&&this.ResetMassData(),this.m_world.m_flags|=I.e_newFixture,e},f.prototype.CreateFixture2=function(t,e){void 0===e&&(e=0);var i=new M;return i.shape=t,i.density=e,this.CreateFixture(i)},f.prototype.DestroyFixture=function(t){if(1!=this.m_world.IsLocked()){for(var e=this.m_fixtureList,i=null;null!=e;){if(e==t){i?i.m_next=t.m_next:this.m_fixtureList=t.m_next;break}i=e,e=e.m_next}for(var o=this.m_contactList;o;){var n=o.contact;o=o.next;var s=n.GetFixtureA(),r=n.GetFixtureB();t!=s&&t!=r||this.m_world.m_contactManager.Destroy(n)}if(this.m_flags&f.e_activeFlag){var a=this.m_world.m_contactManager.m_broadPhase;t.DestroyProxy(a)}t.Destroy(),t.m_body=null,t.m_next=null,--this.m_fixtureCount,this.ResetMassData()}},f.prototype.SetPositionAndAngle=function(t,e){var i;if(void 0===e&&(e=0),1!=this.m_world.IsLocked()){this.m_xf.R.Set(e),this.m_xf.position.SetV(t);var o=this.m_xf.R,n=this.m_sweep.localCenter;this.m_sweep.c.x=o.col1.x*n.x+o.col2.x*n.y,this.m_sweep.c.y=o.col1.y*n.x+o.col2.y*n.y,this.m_sweep.c.x+=this.m_xf.position.x,this.m_sweep.c.y+=this.m_xf.position.y,this.m_sweep.c0.SetV(this.m_sweep.c),this.m_sweep.a0=this.m_sweep.a=e;var s=this.m_world.m_contactManager.m_broadPhase;for(i=this.m_fixtureList;i;i=i.m_next)i.Synchronize(s,this.m_xf,this.m_xf);this.m_world.m_contactManager.FindNewContacts()}},f.prototype.SetTransform=function(t){this.SetPositionAndAngle(t.position,t.GetAngle())},f.prototype.GetTransform=function(){return this.m_xf},f.prototype.GetPosition=function(){return this.m_xf.position},f.prototype.SetPosition=function(t){this.SetPositionAndAngle(t,this.GetAngle())},f.prototype.GetAngle=function(){return this.m_sweep.a},f.prototype.SetAngle=function(t){void 0===t&&(t=0),this.SetPositionAndAngle(this.GetPosition(),t)},f.prototype.GetWorldCenter=function(){return this.m_sweep.c},f.prototype.GetLocalCenter=function(){return this.m_sweep.localCenter},f.prototype.SetLinearVelocity=function(t){this.m_type!=f.b2_staticBody&&this.m_linearVelocity.SetV(t)},f.prototype.GetLinearVelocity=function(){return this.m_linearVelocity},f.prototype.SetAngularVelocity=function(t){void 0===t&&(t=0),this.m_type!=f.b2_staticBody&&(this.m_angularVelocity=t)},f.prototype.GetAngularVelocity=function(){return this.m_angularVelocity},f.prototype.GetDefinition=function(){var t=new d;return t.type=this.GetType(),t.allowSleep=(this.m_flags&f.e_allowSleepFlag)==f.e_allowSleepFlag,t.angle=this.GetAngle(),t.angularDamping=this.m_angularDamping,t.angularVelocity=this.m_angularVelocity,t.fixedRotation=(this.m_flags&f.e_fixedRotationFlag)==f.e_fixedRotationFlag,t.bullet=(this.m_flags&f.e_bulletFlag)==f.e_bulletFlag,t.awake=(this.m_flags&f.e_awakeFlag)==f.e_awakeFlag,t.linearDamping=this.m_linearDamping,t.linearVelocity.SetV(this.GetLinearVelocity()),t.position=this.GetPosition(),t.userData=this.GetUserData(),t},f.prototype.ApplyForce=function(t,e){this.m_type==f.b2_dynamicBody&&(0==this.IsAwake()&&this.SetAwake(!0),this.m_force.x+=t.x,this.m_force.y+=t.y,this.m_torque+=(e.x-this.m_sweep.c.x)*t.y-(e.y-this.m_sweep.c.y)*t.x)},f.prototype.ApplyTorque=function(t){void 0===t&&(t=0),this.m_type==f.b2_dynamicBody&&(0==this.IsAwake()&&this.SetAwake(!0),this.m_torque+=t)},f.prototype.ApplyImpulse=function(t,e){this.m_type==f.b2_dynamicBody&&(0==this.IsAwake()&&this.SetAwake(!0),this.m_linearVelocity.x+=this.m_invMass*t.x,this.m_linearVelocity.y+=this.m_invMass*t.y,this.m_angularVelocity+=this.m_invI*((e.x-this.m_sweep.c.x)*t.y-(e.y-this.m_sweep.c.y)*t.x))},f.prototype.Split=function(e){for(var i,o=this.GetLinearVelocity().Copy(),n=this.GetAngularVelocity(),s=this.GetWorldCenter(),r=this,a=this.m_world.CreateBody(this.GetDefinition()),l=r.m_fixtureList;l;)if(e(l)){var h=l.m_next;i?i.m_next=h:r.m_fixtureList=h,r.m_fixtureCount--,l.m_next=a.m_fixtureList,a.m_fixtureList=l,a.m_fixtureCount++,l.m_body=a,l=h}else i=l,l=l.m_next;r.ResetMassData(),a.ResetMassData();var c=r.GetWorldCenter(),m=a.GetWorldCenter(),u=t.AddVV(o,t.CrossFV(n,t.SubtractVV(c,s))),y=t.AddVV(o,t.CrossFV(n,t.SubtractVV(m,s)));return r.SetLinearVelocity(u),a.SetLinearVelocity(y),r.SetAngularVelocity(n),a.SetAngularVelocity(n),r.SynchronizeFixtures(),a.SynchronizeFixtures(),a},f.prototype.Merge=function(t){var e;for(e=t.m_fixtureList;e;){var i=e.m_next;t.m_fixtureCount--,e.m_next=this.m_fixtureList,this.m_fixtureList=e,this.m_fixtureCount++,e.m_body=n,e=i}o.m_fixtureCount=0;var o=this,n=t;o.GetWorldCenter(),n.GetWorldCenter(),o.GetLinearVelocity().Copy(),n.GetLinearVelocity().Copy(),o.GetAngularVelocity(),n.GetAngularVelocity(),o.ResetMassData(),this.SynchronizeFixtures()},f.prototype.GetMass=function(){return this.m_mass},f.prototype.GetInertia=function(){return this.m_I},f.prototype.GetMassData=function(t){t.mass=this.m_mass,t.I=this.m_I,t.center.SetV(this.m_sweep.localCenter)},f.prototype.SetMassData=function(e){if(s.b2Assert(0==this.m_world.IsLocked()),1!=this.m_world.IsLocked()&&this.m_type==f.b2_dynamicBody){this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=e.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,e.I>0&&!(this.m_flags&f.e_fixedRotationFlag)&&(this.m_I=e.I-this.m_mass*(e.center.x*e.center.x+e.center.y*e.center.y),this.m_invI=1/this.m_I);var i=this.m_sweep.c.Copy();this.m_sweep.localCenter.SetV(e.center),this.m_sweep.c0.SetV(t.MulX(this.m_xf,this.m_sweep.localCenter)),this.m_sweep.c.SetV(this.m_sweep.c0),this.m_linearVelocity.x+=this.m_angularVelocity*-(this.m_sweep.c.y-i.y),this.m_linearVelocity.y+=this.m_angularVelocity*+(this.m_sweep.c.x-i.x)}},f.prototype.ResetMassData=function(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_sweep.localCenter.SetZero(),this.m_type!=f.b2_staticBody&&this.m_type!=f.b2_kinematicBody){for(var e=o.Make(0,0),i=this.m_fixtureList;i;i=i.m_next)if(0!=i.m_density){var n=i.GetMassData();this.m_mass+=n.mass,e.x+=n.center.x*n.mass,e.y+=n.center.y*n.mass,this.m_I+=n.I}this.m_mass>0?(this.m_invMass=1/this.m_mass,e.x*=this.m_invMass,e.y*=this.m_invMass):(this.m_mass=1,this.m_invMass=1),this.m_I>0&&!(this.m_flags&f.e_fixedRotationFlag)?(this.m_I-=this.m_mass*(e.x*e.x+e.y*e.y),this.m_I*=this.m_inertiaScale,s.b2Assert(this.m_I>0),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0);var r=this.m_sweep.c.Copy();this.m_sweep.localCenter.SetV(e),this.m_sweep.c0.SetV(t.MulX(this.m_xf,this.m_sweep.localCenter)),this.m_sweep.c.SetV(this.m_sweep.c0),this.m_linearVelocity.x+=this.m_angularVelocity*-(this.m_sweep.c.y-r.y),this.m_linearVelocity.y+=this.m_angularVelocity*+(this.m_sweep.c.x-r.x)}},f.prototype.GetWorldPoint=function(t){var e=this.m_xf.R,i=new o(e.col1.x*t.x+e.col2.x*t.y,e.col1.y*t.x+e.col2.y*t.y);return i.x+=this.m_xf.position.x,i.y+=this.m_xf.position.y,i},f.prototype.GetWorldVector=function(e){return t.MulMV(this.m_xf.R,e)},f.prototype.GetLocalPoint=function(e){return t.MulXT(this.m_xf,e)},f.prototype.GetLocalVector=function(e){return t.MulTMV(this.m_xf.R,e)},f.prototype.GetLinearVelocityFromWorldPoint=function(t){return new o(this.m_linearVelocity.x-this.m_angularVelocity*(t.y-this.m_sweep.c.y),this.m_linearVelocity.y+this.m_angularVelocity*(t.x-this.m_sweep.c.x))},f.prototype.GetLinearVelocityFromLocalPoint=function(t){var e=this.m_xf.R,i=new o(e.col1.x*t.x+e.col2.x*t.y,e.col1.y*t.x+e.col2.y*t.y);return i.x+=this.m_xf.position.x,i.y+=this.m_xf.position.y,new o(this.m_linearVelocity.x-this.m_angularVelocity*(i.y-this.m_sweep.c.y),this.m_linearVelocity.y+this.m_angularVelocity*(i.x-this.m_sweep.c.x))},f.prototype.GetLinearDamping=function(){return this.m_linearDamping},f.prototype.SetLinearDamping=function(t){void 0===t&&(t=0),this.m_linearDamping=t},f.prototype.GetAngularDamping=function(){return this.m_angularDamping},f.prototype.SetAngularDamping=function(t){void 0===t&&(t=0),this.m_angularDamping=t},f.prototype.SetType=function(t){if(void 0===t&&(t=0),this.m_type!=t){this.m_type=t,this.ResetMassData(),this.m_type==f.b2_staticBody&&(this.m_linearVelocity.SetZero(),this.m_angularVelocity=0),this.SetAwake(!0),this.m_force.SetZero(),this.m_torque=0;for(var e=this.m_contactList;e;e=e.next)e.contact.FlagForFiltering()}},f.prototype.GetType=function(){return this.m_type},f.prototype.SetBullet=function(t){t?this.m_flags|=f.e_bulletFlag:this.m_flags&=~f.e_bulletFlag},f.prototype.IsBullet=function(){return(this.m_flags&f.e_bulletFlag)==f.e_bulletFlag},f.prototype.SetSleepingAllowed=function(t){t?this.m_flags|=f.e_allowSleepFlag:(this.m_flags&=~f.e_allowSleepFlag,this.SetAwake(!0))},f.prototype.SetAwake=function(t){t?(this.m_flags|=f.e_awakeFlag,this.m_sleepTime=0):(this.m_flags&=~f.e_awakeFlag,this.m_sleepTime=0,this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_force.SetZero(),this.m_torque=0)},f.prototype.IsAwake=function(){return(this.m_flags&f.e_awakeFlag)==f.e_awakeFlag},f.prototype.SetFixedRotation=function(t){t?this.m_flags|=f.e_fixedRotationFlag:this.m_flags&=~f.e_fixedRotationFlag,this.ResetMassData()},f.prototype.IsFixedRotation=function(){return(this.m_flags&f.e_fixedRotationFlag)==f.e_fixedRotationFlag},f.prototype.SetActive=function(t){var e,i;if(t!=this.IsActive())if(t)for(this.m_flags|=f.e_activeFlag,e=this.m_world.m_contactManager.m_broadPhase,i=this.m_fixtureList;i;i=i.m_next)i.CreateProxy(e,this.m_xf);else{for(this.m_flags&=~f.e_activeFlag,e=this.m_world.m_contactManager.m_broadPhase,i=this.m_fixtureList;i;i=i.m_next)i.DestroyProxy(e);for(var o=this.m_contactList;o;){var n=o;o=o.next,this.m_world.m_contactManager.Destroy(n.contact)}this.m_contactList=null}},f.prototype.IsActive=function(){return(this.m_flags&f.e_activeFlag)==f.e_activeFlag},f.prototype.IsSleepingAllowed=function(){return(this.m_flags&f.e_allowSleepFlag)==f.e_allowSleepFlag},f.prototype.GetFixtureList=function(){return this.m_fixtureList},f.prototype.GetJointList=function(){return this.m_jointList},f.prototype.GetControllerList=function(){return this.m_controllerList},f.prototype.GetContactList=function(){return this.m_contactList},f.prototype.GetNext=function(){return this.m_next},f.prototype.GetUserData=function(){return this.m_userData},f.prototype.SetUserData=function(t){this.m_userData=t},f.prototype.GetWorld=function(){return this.m_world},f.prototype.b2Body=function(t,e){this.m_flags=0,t.bullet&&(this.m_flags|=f.e_bulletFlag),t.fixedRotation&&(this.m_flags|=f.e_fixedRotationFlag),t.allowSleep&&(this.m_flags|=f.e_allowSleepFlag),t.awake&&(this.m_flags|=f.e_awakeFlag),t.active&&(this.m_flags|=f.e_activeFlag),this.m_world=e,this.m_xf.position.SetV(t.position),this.m_xf.R.Set(t.angle),this.m_sweep.localCenter.SetZero(),this.m_sweep.t0=1,this.m_sweep.a0=this.m_sweep.a=t.angle;var i=this.m_xf.R,o=this.m_sweep.localCenter;this.m_sweep.c.x=i.col1.x*o.x+i.col2.x*o.y,this.m_sweep.c.y=i.col1.y*o.x+i.col2.y*o.y,this.m_sweep.c.x+=this.m_xf.position.x,this.m_sweep.c.y+=this.m_xf.position.y,this.m_sweep.c0.SetV(this.m_sweep.c),this.m_jointList=null,this.m_controllerList=null,this.m_contactList=null,this.m_controllerCount=0,this.m_prev=null,this.m_next=null,this.m_linearVelocity.SetV(t.linearVelocity),this.m_angularVelocity=t.angularVelocity,this.m_linearDamping=t.linearDamping,this.m_angularDamping=t.angularDamping,this.m_force.Set(0,0),this.m_torque=0,this.m_sleepTime=0,this.m_type=t.type,this.m_type==f.b2_dynamicBody?(this.m_mass=1,this.m_invMass=1):(this.m_mass=0,this.m_invMass=0),this.m_I=0,this.m_invI=0,this.m_inertiaScale=t.inertiaScale,this.m_userData=t.userData,this.m_fixtureList=null,this.m_fixtureCount=0},f.prototype.SynchronizeFixtures=function(){var t=f.s_xf1;t.R.Set(this.m_sweep.a0);var e,i=t.R,o=this.m_sweep.localCenter;t.position.x=this.m_sweep.c0.x-(i.col1.x*o.x+i.col2.x*o.y),t.position.y=this.m_sweep.c0.y-(i.col1.y*o.x+i.col2.y*o.y);var n=this.m_world.m_contactManager.m_broadPhase;for(e=this.m_fixtureList;e;e=e.m_next)e.Synchronize(n,t,this.m_xf)},f.prototype.SynchronizeTransform=function(){this.m_xf.R.Set(this.m_sweep.a);var t=this.m_xf.R,e=this.m_sweep.localCenter;this.m_xf.position.x=this.m_sweep.c.x-(t.col1.x*e.x+t.col2.x*e.y),this.m_xf.position.y=this.m_sweep.c.y-(t.col1.y*e.x+t.col2.y*e.y)},f.prototype.ShouldCollide=function(t){if(this.m_type!=f.b2_dynamicBody&&t.m_type!=f.b2_dynamicBody)return!1;for(var e=this.m_jointList;e;e=e.next)if(e.other==t&&0==e.joint.m_collideConnected)return!1;return!0},f.prototype.Advance=function(t){void 0===t&&(t=0),this.m_sweep.Advance(t),this.m_sweep.c.SetV(this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.SynchronizeTransform()},dt.postDefs.push(function(){dt.Dynamics.b2Body.s_xf1=new i,dt.Dynamics.b2Body.e_islandFlag=1,dt.Dynamics.b2Body.e_awakeFlag=2,dt.Dynamics.b2Body.e_allowSleepFlag=4,dt.Dynamics.b2Body.e_bulletFlag=8,dt.Dynamics.b2Body.e_fixedRotationFlag=16,dt.Dynamics.b2Body.e_activeFlag=32,dt.Dynamics.b2Body.b2_staticBody=0,dt.Dynamics.b2Body.b2_kinematicBody=1,dt.Dynamics.b2Body.b2_dynamicBody=2}),d.b2BodyDef=function(){this.position=new o,this.linearVelocity=new o},d.prototype.b2BodyDef=function(){this.userData=null,this.position.Set(0,0),this.angle=0,this.linearVelocity.Set(0,0),this.angularVelocity=0,this.linearDamping=0,this.angularDamping=0,this.allowSleep=!0,this.awake=!0,this.fixedRotation=!1,this.bullet=!1,this.type=f.b2_staticBody,this.active=!0,this.inertiaScale=1},v.b2ContactFilter=function(){},v.prototype.ShouldCollide=function(t,e){var i=t.GetFilterData(),o=e.GetFilterData();return i.groupIndex==o.groupIndex&&0!=i.groupIndex?i.groupIndex>0:!!(i.maskBits&o.categoryBits)&&!!(i.categoryBits&o.maskBits)},v.prototype.RayCollide=function(t,e){return!t||this.ShouldCollide(t instanceof A?t:null,e)},dt.postDefs.push(function(){dt.Dynamics.b2ContactFilter.b2_defaultFilter=new v}),b.b2ContactImpulse=function(){this.normalImpulses=new gt(s.b2_maxManifoldPoints),this.tangentImpulses=new gt(s.b2_maxManifoldPoints)},x.b2ContactListener=function(){},x.prototype.BeginContact=function(t){},x.prototype.EndContact=function(t){},x.prototype.PreSolve=function(t,e){},x.prototype.PostSolve=function(t,e){},dt.postDefs.push(function(){dt.Dynamics.b2ContactListener.b2_defaultListener=new x}),g.b2ContactManager=function(){},g.prototype.b2ContactManager=function(){this.m_world=null,this.m_contactCount=0,this.m_contactFilter=v.b2_defaultFilter,this.m_contactListener=x.b2_defaultListener,this.m_contactFactory=new k(this.m_allocator),this.m_broadPhase=new l},g.prototype.AddPair=function(t,e){var i=t instanceof A?t:null,o=e instanceof A?e:null,n=i.GetBody(),s=o.GetBody();if(n!=s){for(var r=s.GetContactList();r;){if(r.other==n){var a=r.contact.GetFixtureA(),l=r.contact.GetFixtureB();if(a==i&&l==o)return;if(a==o&&l==i)return}r=r.next}if(0!=s.ShouldCollide(n)&&0!=this.m_contactFilter.ShouldCollide(i,o)){var h=this.m_contactFactory.Create(i,o);i=h.GetFixtureA(),o=h.GetFixtureB(),n=i.m_body,s=o.m_body,h.m_prev=null,h.m_next=this.m_world.m_contactList,null!=this.m_world.m_contactList&&(this.m_world.m_contactList.m_prev=h),this.m_world.m_contactList=h,h.m_nodeA.contact=h,h.m_nodeA.other=s,h.m_nodeA.prev=null,h.m_nodeA.next=n.m_contactList,null!=n.m_contactList&&(n.m_contactList.prev=h.m_nodeA),n.m_contactList=h.m_nodeA,h.m_nodeB.contact=h,h.m_nodeB.other=n,h.m_nodeB.prev=null,h.m_nodeB.next=s.m_contactList,null!=s.m_contactList&&(s.m_contactList.prev=h.m_nodeB),s.m_contactList=h.m_nodeB,++this.m_world.m_contactCount}}},g.prototype.FindNewContacts=function(){this.m_broadPhase.UpdatePairs(dt.generateCallback(this,this.AddPair))},g.prototype.Destroy=function(t){var e=t.GetFixtureA(),i=t.GetFixtureB(),o=e.GetBody(),n=i.GetBody();t.IsTouching()&&this.m_contactListener.EndContact(t),t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_world.m_contactList&&(this.m_world.m_contactList=t.m_next),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA==o.m_contactList&&(o.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB==n.m_contactList&&(n.m_contactList=t.m_nodeB.next),this.m_contactFactory.Destroy(t),--this.m_contactCount},g.prototype.Collide=function(){for(var t=this.m_world.m_contactList;t;){var e=t.GetFixtureA(),i=t.GetFixtureB(),o=e.GetBody(),n=i.GetBody();if(0!=o.IsAwake()||0!=n.IsAwake()){if(t.m_flags&V.e_filterFlag){if(0==n.ShouldCollide(o)){var s=t;t=s.GetNext(),this.Destroy(s);continue}if(0==this.m_contactFilter.ShouldCollide(e,i)){t=(s=t).GetNext(),this.Destroy(s);continue}t.m_flags&=~V.e_filterFlag}var r=e.m_proxy,a=i.m_proxy;0!=this.m_broadPhase.TestOverlap(r,a)?(t.Update(this.m_contactListener),t=t.GetNext()):(t=(s=t).GetNext(),this.Destroy(s))}else t=t.GetNext()}},dt.postDefs.push(function(){dt.Dynamics.b2ContactManager.s_evalCP=new a}),w.b2DebugDraw=function(){},w.prototype.b2DebugDraw=function(){},w.prototype.SetFlags=function(t){},w.prototype.GetFlags=function(){},w.prototype.AppendFlags=function(t){},w.prototype.ClearFlags=function(t){},w.prototype.SetSprite=function(t){},w.prototype.GetSprite=function(){},w.prototype.SetDrawScale=function(t){},w.prototype.GetDrawScale=function(){},w.prototype.SetLineThickness=function(t){},w.prototype.GetLineThickness=function(){},w.prototype.SetAlpha=function(t){},w.prototype.GetAlpha=function(){},w.prototype.SetFillAlpha=function(t){},w.prototype.GetFillAlpha=function(){},w.prototype.SetXFormScale=function(t){},w.prototype.GetXFormScale=function(){},w.prototype.DrawPolygon=function(t,e,i){},w.prototype.DrawSolidPolygon=function(t,e,i){},w.prototype.DrawCircle=function(t,e,i){},w.prototype.DrawSolidCircle=function(t,e,i,o){},w.prototype.DrawSegment=function(t,e,i){},w.prototype.DrawTransform=function(t){},dt.postDefs.push(function(){dt.Dynamics.b2DebugDraw.e_shapeBit=1,dt.Dynamics.b2DebugDraw.e_jointBit=2,dt.Dynamics.b2DebugDraw.e_aabbBit=4,dt.Dynamics.b2DebugDraw.e_pairBit=8,dt.Dynamics.b2DebugDraw.e_centerOfMassBit=16,dt.Dynamics.b2DebugDraw.e_controllerBit=32}),C.b2DestructionListener=function(){},C.prototype.SayGoodbyeJoint=function(t){},C.prototype.SayGoodbyeFixture=function(t){},S.b2FilterData=function(){this.categoryBits=1,this.maskBits=65535,this.groupIndex=0},S.prototype.Copy=function(){var t=new S;return t.categoryBits=this.categoryBits,t.maskBits=this.maskBits,t.groupIndex=this.groupIndex,t},A.b2Fixture=function(){this.m_filter=new S},A.prototype.GetType=function(){return this.m_shape.GetType()},A.prototype.GetShape=function(){return this.m_shape},A.prototype.SetSensor=function(t){if(this.m_isSensor!=t&&(this.m_isSensor=t,null!=this.m_body))for(var e=this.m_body.GetContactList();e;){var i=e.contact,o=i.GetFixtureA(),n=i.GetFixtureB();o!=this&&n!=this||i.SetSensor(o.IsSensor()||n.IsSensor()),e=e.next}},A.prototype.IsSensor=function(){return this.m_isSensor},A.prototype.SetFilterData=function(t){if(this.m_filter=t.Copy(),!this.m_body)for(var e=this.m_body.GetContactList();e;){var i=e.contact,o=i.GetFixtureA(),n=i.GetFixtureB();o!=this&&n!=this||i.FlagForFiltering(),e=e.next}},A.prototype.GetFilterData=function(){return this.m_filter.Copy()},A.prototype.GetBody=function(){return this.m_body},A.prototype.GetNext=function(){return this.m_next},A.prototype.GetUserData=function(){return this.m_userData},A.prototype.SetUserData=function(t){this.m_userData=t},A.prototype.TestPoint=function(t){return this.m_shape.TestPoint(this.m_body.GetTransform(),t)},A.prototype.RayCast=function(t,e){return this.m_shape.RayCast(t,e,this.m_body.GetTransform())},A.prototype.GetMassData=function(t){return void 0===t&&(t=null),null==t&&(t=new y),this.m_shape.ComputeMass(t,this.m_density),t},A.prototype.SetDensity=function(t){void 0===t&&(t=0),this.m_density=t},A.prototype.GetDensity=function(){return this.m_density},A.prototype.GetFriction=function(){return this.m_friction},A.prototype.SetFriction=function(t){void 0===t&&(t=0),this.m_friction=t},A.prototype.GetRestitution=function(){return this.m_restitution},A.prototype.SetRestitution=function(t){void 0===t&&(t=0),this.m_restitution=t},A.prototype.GetAABB=function(){return this.m_aabb},A.prototype.b2Fixture=function(){this.m_aabb=new r,this.m_userData=null,this.m_body=null,this.m_next=null,this.m_shape=null,this.m_density=0,this.m_friction=0,this.m_restitution=0},A.prototype.Create=function(t,e,i){this.m_userData=i.userData,this.m_friction=i.friction,this.m_restitution=i.restitution,this.m_body=t,this.m_next=null,this.m_filter=i.filter.Copy(),this.m_isSensor=i.isSensor,this.m_shape=i.shape.Copy(),this.m_density=i.density},A.prototype.Destroy=function(){this.m_shape=null},A.prototype.CreateProxy=function(t,e){this.m_shape.ComputeAABB(this.m_aabb,e),this.m_proxy=t.CreateProxy(this.m_aabb,this)},A.prototype.DestroyProxy=function(t){null!=this.m_proxy&&(t.DestroyProxy(this.m_proxy),this.m_proxy=null)},A.prototype.Synchronize=function(e,i,o){if(this.m_proxy){var n=new r,s=new r;this.m_shape.ComputeAABB(n,i),this.m_shape.ComputeAABB(s,o),this.m_aabb.Combine(n,s);var a=t.SubtractVV(o.position,i.position);e.MoveProxy(this.m_proxy,this.m_aabb,a)}},M.b2FixtureDef=function(){this.filter=new S},M.prototype.b2FixtureDef=function(){this.shape=null,this.userData=null,this.friction=.2,this.restitution=0,this.density=0,this.filter.categoryBits=1,this.filter.maskBits=65535,this.filter.groupIndex=0,this.isSensor=!1},D.b2Island=function(){},D.prototype.b2Island=function(){this.m_bodies=new xt,this.m_contacts=new xt,this.m_joints=new xt},D.prototype.Initialize=function(t,e,i,o,n,s){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0);var r=0;for(this.m_bodyCapacity=t,this.m_contactCapacity=e,this.m_jointCapacity=i,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_allocator=o,this.m_listener=n,this.m_contactSolver=s,r=this.m_bodies.length;r<t;r++)this.m_bodies[r]=null;for(r=this.m_contacts.length;r<e;r++)this.m_contacts[r]=null;for(r=this.m_joints.length;r<i;r++)this.m_joints[r]=null},D.prototype.Clear=function(){this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0},D.prototype.Solve=function(e,i,o){var n,r=0,a=0;for(r=0;r<this.m_bodyCount;++r)(n=this.m_bodies[r]).GetType()==f.b2_dynamicBody&&(n.m_linearVelocity.x+=e.dt*(i.x+n.m_invMass*n.m_force.x),n.m_linearVelocity.y+=e.dt*(i.y+n.m_invMass*n.m_force.y),n.m_angularVelocity+=e.dt*n.m_invI*n.m_torque,n.m_linearVelocity.Multiply(t.Clamp(1-e.dt*n.m_linearDamping,0,1)),n.m_angularVelocity*=t.Clamp(1-e.dt*n.m_angularDamping,0,1));this.m_contactSolver.Initialize(e,this.m_contacts,this.m_contactCount,this.m_allocator);var l=this.m_contactSolver;for(l.InitVelocityConstraints(e),r=0;r<this.m_jointCount;++r)this.m_joints[r].InitVelocityConstraints(e);for(r=0;r<e.velocityIterations;++r){for(a=0;a<this.m_jointCount;++a)this.m_joints[a].SolveVelocityConstraints(e);l.SolveVelocityConstraints()}for(r=0;r<this.m_jointCount;++r)this.m_joints[r].FinalizeVelocityConstraints();for(l.FinalizeVelocityConstraints(),r=0;r<this.m_bodyCount;++r)if((n=this.m_bodies[r]).GetType()!=f.b2_staticBody){var h=e.dt*n.m_linearVelocity.x,c=e.dt*n.m_linearVelocity.y;h*h+c*c>s.b2_maxTranslationSquared&&(n.m_linearVelocity.Normalize(),n.m_linearVelocity.x*=s.b2_maxTranslation*e.inv_dt,n.m_linearVelocity.y*=s.b2_maxTranslation*e.inv_dt);var m=e.dt*n.m_angularVelocity;m*m>s.b2_maxRotationSquared&&(n.m_angularVelocity<0?n.m_angularVelocity=-s.b2_maxRotation*e.inv_dt:n.m_angularVelocity=s.b2_maxRotation*e.inv_dt),n.m_sweep.c0.SetV(n.m_sweep.c),n.m_sweep.a0=n.m_sweep.a,n.m_sweep.c.x+=e.dt*n.m_linearVelocity.x,n.m_sweep.c.y+=e.dt*n.m_linearVelocity.y,n.m_sweep.a+=e.dt*n.m_angularVelocity,n.SynchronizeTransform()}for(r=0;r<e.positionIterations;++r){var u=l.SolvePositionConstraints(s.b2_contactBaumgarte),y=!0;for(a=0;a<this.m_jointCount;++a){var p=this.m_joints[a].SolvePositionConstraints(s.b2_contactBaumgarte);y=y&&p}if(u&&y)break}if(this.Report(l.m_constraints),o){var _=Number.MAX_VALUE,d=s.b2_linearSleepTolerance*s.b2_linearSleepTolerance,v=s.b2_angularSleepTolerance*s.b2_angularSleepTolerance;for(r=0;r<this.m_bodyCount;++r)(n=this.m_bodies[r]).GetType()!=f.b2_staticBody&&(n.m_flags&f.e_allowSleepFlag||(n.m_sleepTime=0,_=0),!(n.m_flags&f.e_allowSleepFlag)||n.m_angularVelocity*n.m_angularVelocity>v||t.Dot(n.m_linearVelocity,n.m_linearVelocity)>d?(n.m_sleepTime=0,_=0):(n.m_sleepTime+=e.dt,_=t.Min(_,n.m_sleepTime)));if(_>=s.b2_timeToSleep)for(r=0;r<this.m_bodyCount;++r)(n=this.m_bodies[r]).SetAwake(!1)}},D.prototype.SolveTOI=function(t){var e=0,i=0;this.m_contactSolver.Initialize(t,this.m_contacts,this.m_contactCount,this.m_allocator);var o=this.m_contactSolver;for(e=0;e<this.m_jointCount;++e)this.m_joints[e].InitVelocityConstraints(t);for(e=0;e<t.velocityIterations;++e)for(o.SolveVelocityConstraints(),i=0;i<this.m_jointCount;++i)this.m_joints[i].SolveVelocityConstraints(t);for(e=0;e<this.m_bodyCount;++e){var n=this.m_bodies[e];if(n.GetType()!=f.b2_staticBody){var r=t.dt*n.m_linearVelocity.x,a=t.dt*n.m_linearVelocity.y;r*r+a*a>s.b2_maxTranslationSquared&&(n.m_linearVelocity.Normalize(),n.m_linearVelocity.x*=s.b2_maxTranslation*t.inv_dt,n.m_linearVelocity.y*=s.b2_maxTranslation*t.inv_dt);var l=t.dt*n.m_angularVelocity;l*l>s.b2_maxRotationSquared&&(n.m_angularVelocity<0?n.m_angularVelocity=-s.b2_maxRotation*t.inv_dt:n.m_angularVelocity=s.b2_maxRotation*t.inv_dt),n.m_sweep.c0.SetV(n.m_sweep.c),n.m_sweep.a0=n.m_sweep.a,n.m_sweep.c.x+=t.dt*n.m_linearVelocity.x,n.m_sweep.c.y+=t.dt*n.m_linearVelocity.y,n.m_sweep.a+=t.dt*n.m_angularVelocity,n.SynchronizeTransform()}}for(e=0;e<t.positionIterations;++e){var h=o.SolvePositionConstraints(.75),c=!0;for(i=0;i<this.m_jointCount;++i){var m=this.m_joints[i].SolvePositionConstraints(s.b2_contactBaumgarte);c=c&&m}if(h&&c)break}this.Report(o.m_constraints)},D.prototype.Report=function(t){if(null!=this.m_listener)for(var e=0;e<this.m_contactCount;++e){for(var i=this.m_contacts[e],o=t[e],n=0;n<o.pointCount;++n)D.s_impulse.normalImpulses[n]=o.points[n].normalImpulse,D.s_impulse.tangentImpulses[n]=o.points[n].tangentImpulse;this.m_listener.PostSolve(i,D.s_impulse)}},D.prototype.AddBody=function(t){t.m_islandIndex=this.m_bodyCount,this.m_bodies[this.m_bodyCount++]=t},D.prototype.AddContact=function(t){this.m_contacts[this.m_contactCount++]=t},D.prototype.AddJoint=function(t){this.m_joints[this.m_jointCount++]=t},dt.postDefs.push(function(){dt.Dynamics.b2Island.s_impulse=new b}),B.b2TimeStep=function(){},B.prototype.Set=function(t){this.dt=t.dt,this.inv_dt=t.inv_dt,this.positionIterations=t.positionIterations,this.velocityIterations=t.velocityIterations,this.warmStarting=t.warmStarting},I.b2World=function(){this.s_stack=new xt,this.m_contactManager=new g,this.m_contactSolver=new P,this.m_island=new D},I.prototype.b2World=function(t,e){this.m_destructionListener=null,this.m_debugDraw=null,this.m_bodyList=null,this.m_contactList=null,this.m_jointList=null,this.m_controllerList=null,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_controllerCount=0,I.m_warmStarting=!0,I.m_continuousPhysics=!0,this.m_allowSleep=e,this.m_gravity=t,this.m_inv_dt0=0,this.m_contactManager.m_world=this;var i=new d;this.m_groundBody=this.CreateBody(i)},I.prototype.SetDestructionListener=function(t){this.m_destructionListener=t},I.prototype.SetContactFilter=function(t){this.m_contactManager.m_contactFilter=t},I.prototype.SetContactListener=function(t){this.m_contactManager.m_contactListener=t},I.prototype.SetDebugDraw=function(t){this.m_debugDraw=t},I.prototype.SetBroadPhase=function(t){var e=this.m_contactManager.m_broadPhase;this.m_contactManager.m_broadPhase=t;for(var i=this.m_bodyList;i;i=i.m_next)for(var o=i.m_fixtureList;o;o=o.m_next)o.m_proxy=t.CreateProxy(e.GetFatAABB(o.m_proxy),o)},I.prototype.Validate=function(){this.m_contactManager.m_broadPhase.Validate()},I.prototype.GetProxyCount=function(){return this.m_contactManager.m_broadPhase.GetProxyCount()},I.prototype.CreateBody=function(t){if(1==this.IsLocked())return null;var e=new f(t,this);return e.m_prev=null,e.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=e),this.m_bodyList=e,++this.m_bodyCount,e},I.prototype.DestroyBody=function(t){if(1!=this.IsLocked()){for(var e=t.m_jointList;e;){var i=e;e=e.next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeJoint(i.joint),this.DestroyJoint(i.joint)}for(var o=t.m_controllerList;o;){var n=o;o=o.nextController,n.controller.RemoveBody(t)}for(var s=t.m_contactList;s;){var r=s;s=s.next,this.m_contactManager.Destroy(r.contact)}t.m_contactList=null;for(var a=t.m_fixtureList;a;){var l=a;a=a.m_next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeFixture(l),l.DestroyProxy(this.m_contactManager.m_broadPhase),l.Destroy()}t.m_fixtureList=null,t.m_fixtureCount=0,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_bodyList&&(this.m_bodyList=t.m_next),--this.m_bodyCount}},I.prototype.CreateJoint=function(t){var e=T.Create(t,null);e.m_prev=null,e.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=e),this.m_jointList=e,++this.m_jointCount,e.m_edgeA.joint=e,e.m_edgeA.other=e.m_bodyB,e.m_edgeA.prev=null,e.m_edgeA.next=e.m_bodyA.m_jointList,e.m_bodyA.m_jointList&&(e.m_bodyA.m_jointList.prev=e.m_edgeA),e.m_bodyA.m_jointList=e.m_edgeA,e.m_edgeB.joint=e,e.m_edgeB.other=e.m_bodyA,e.m_edgeB.prev=null,e.m_edgeB.next=e.m_bodyB.m_jointList,e.m_bodyB.m_jointList&&(e.m_bodyB.m_jointList.prev=e.m_edgeB),e.m_bodyB.m_jointList=e.m_edgeB;var i=t.bodyA,o=t.bodyB;if(0==t.collideConnected)for(var n=o.GetContactList();n;)n.other==i&&n.contact.FlagForFiltering(),n=n.next;return e},I.prototype.DestroyJoint=function(t){var e=t.m_collideConnected;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_jointList&&(this.m_jointList=t.m_next);var i=t.m_bodyA,o=t.m_bodyB;if(i.SetAwake(!0),o.SetAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA==i.m_jointList&&(i.m_jointList=t.m_edgeA.next),t.m_edgeA.prev=null,t.m_edgeA.next=null,t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB==o.m_jointList&&(o.m_jointList=t.m_edgeB.next),t.m_edgeB.prev=null,t.m_edgeB.next=null,T.Destroy(t,null),--this.m_jointCount,0==e)for(var n=o.GetContactList();n;)n.other==i&&n.contact.FlagForFiltering(),n=n.next},I.prototype.AddController=function(t){return t.m_next=this.m_controllerList,t.m_prev=null,this.m_controllerList=t,t.m_world=this,this.m_controllerCount++,t},I.prototype.RemoveController=function(t){t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),this.m_controllerList==t&&(this.m_controllerList=t.m_next),this.m_controllerCount--},I.prototype.CreateController=function(t){if(t.m_world!=this)throw new Error("Controller can only be a member of one world");return t.m_next=this.m_controllerList,t.m_prev=null,this.m_controllerList&&(this.m_controllerList.m_prev=t),this.m_controllerList=t,++this.m_controllerCount,t.m_world=this,t},I.prototype.DestroyController=function(t){t.Clear(),t.m_next&&(t.m_next.m_prev=t.m_prev),t.m_prev&&(t.m_prev.m_next=t.m_next),t==this.m_controllerList&&(this.m_controllerList=t.m_next),--this.m_controllerCount},I.prototype.SetWarmStarting=function(t){I.m_warmStarting=t},I.prototype.SetContinuousPhysics=function(t){I.m_continuousPhysics=t},I.prototype.GetBodyCount=function(){return this.m_bodyCount},I.prototype.GetJointCount=function(){return this.m_jointCount},I.prototype.GetContactCount=function(){return this.m_contactCount},I.prototype.SetGravity=function(t){this.m_gravity=t},I.prototype.GetGravity=function(){return this.m_gravity},I.prototype.GetGroundBody=function(){return this.m_groundBody},I.prototype.Step=function(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.m_flags&I.e_newFixture&&(this.m_contactManager.FindNewContacts(),this.m_flags&=~I.e_newFixture),this.m_flags|=I.e_locked;var o=I.s_timestep2;o.dt=t,o.velocityIterations=e,o.positionIterations=i,o.inv_dt=t>0?1/t:0,o.dtRatio=this.m_inv_dt0*t,o.warmStarting=I.m_warmStarting,this.m_contactManager.Collide(),o.dt>0&&this.Solve(o),I.m_continuousPhysics&&o.dt>0&&this.SolveTOI(o),o.dt>0&&(this.m_inv_dt0=o.inv_dt),this.m_flags&=~I.e_locked},I.prototype.ClearForces=function(){for(var t=this.m_bodyList;t;t=t.m_next)t.m_force.SetZero(),t.m_torque=0},I.prototype.DrawDebugData=function(){if(null!=this.m_debugDraw){this.m_debugDraw.m_sprite.graphics.clear();var t,e,i,s,a,l,h=this.m_debugDraw.GetFlags();new o,new o,new o,new r,new r;var c=[new o,new o,new o,new o],m=new n(0,0,0);if(h&w.e_shapeBit)for(t=this.m_bodyList;t;t=t.m_next)for(l=t.m_xf,e=t.GetFixtureList();e;e=e.m_next)i=e.GetShape(),0==t.IsActive()?(m.Set(.5,.5,.3),this.DrawShape(i,l,m)):t.GetType()==f.b2_staticBody?(m.Set(.5,.9,.5),this.DrawShape(i,l,m)):t.GetType()==f.b2_kinematicBody?(m.Set(.5,.5,.9),this.DrawShape(i,l,m)):0==t.IsAwake()?(m.Set(.6,.6,.6),this.DrawShape(i,l,m)):(m.Set(.9,.7,.7),this.DrawShape(i,l,m));if(h&w.e_jointBit)for(s=this.m_jointList;s;s=s.m_next)this.DrawJoint(s);if(h&w.e_controllerBit)for(var u=this.m_controllerList;u;u=u.m_next)u.Draw(this.m_debugDraw);if(h&w.e_pairBit){m.Set(.3,.9,.9);for(var y=this.m_contactManager.m_contactList;y;y=y.GetNext()){var p=y.GetFixtureA(),_=y.GetFixtureB(),d=p.GetAABB().GetCenter(),v=_.GetAABB().GetCenter();this.m_debugDraw.DrawSegment(d,v,m)}}if(h&w.e_aabbBit)for(a=this.m_contactManager.m_broadPhase,c=[new o,new o,new o,new o],t=this.m_bodyList;t;t=t.GetNext())if(0!=t.IsActive())for(e=t.GetFixtureList();e;e=e.GetNext()){var b=a.GetFatAABB(e.m_proxy);c[0].Set(b.lowerBound.x,b.lowerBound.y),c[1].Set(b.upperBound.x,b.lowerBound.y),c[2].Set(b.upperBound.x,b.upperBound.y),c[3].Set(b.lowerBound.x,b.upperBound.y),this.m_debugDraw.DrawPolygon(c,4,m)}if(h&w.e_centerOfMassBit)for(t=this.m_bodyList;t;t=t.m_next)(l=I.s_xf).R=t.m_xf.R,l.position=t.GetWorldCenter(),this.m_debugDraw.DrawTransform(l)}},I.prototype.QueryAABB=function(t,e){var i=this.m_contactManager.m_broadPhase;i.Query(function(e){return t(i.GetUserData(e))},e)},I.prototype.QueryShape=function(t,e,o){void 0===o&&(o=null),null==o&&(o=new i).SetIdentity();var n=this.m_contactManager.m_broadPhase,s=new r;e.ComputeAABB(s,o),n.Query(function(i){var s=n.GetUserData(i)instanceof A?n.GetUserData(i):null;return!_.TestOverlap(e,o,s.GetShape(),s.GetBody().GetTransform())||t(s)},s)},I.prototype.QueryPoint=function(t,e){var i=this.m_contactManager.m_broadPhase,o=new r;o.lowerBound.Set(e.x-s.b2_linearSlop,e.y-s.b2_linearSlop),o.upperBound.Set(e.x+s.b2_linearSlop,e.y+s.b2_linearSlop),i.Query(function(o){var n=i.GetUserData(o)instanceof A?i.GetUserData(o):null;return!n.TestPoint(e)||t(n)},o)},I.prototype.RayCast=function(t,e,i){var n=this.m_contactManager.m_broadPhase,s=new c,r=new h(e,i);n.RayCast(function(r,a){var l=n.GetUserData(a),h=l instanceof A?l:null;if(h.RayCast(s,r)){var c=s.fraction,m=new o((1-c)*e.x+c*i.x,(1-c)*e.y+c*i.y);return t(h,m,s.normal,c)}return r.maxFraction},r)},I.prototype.RayCastOne=function(t,e){var i;return this.RayCast(function(t,e,o,n){return void 0===n&&(n=0),i=t,n},t,e),i},I.prototype.RayCastAll=function(t,e){var i=new xt;return this.RayCast(function(t,e,o,n){return i[i.length]=t,1},t,e),i},I.prototype.GetBodyList=function(){return this.m_bodyList},I.prototype.GetJointList=function(){return this.m_jointList},I.prototype.GetContactList=function(){return this.m_contactList},I.prototype.IsLocked=function(){return(this.m_flags&I.e_locked)>0},I.prototype.Solve=function(t){for(var e,i=this.m_controllerList;i;i=i.m_next)i.Step(t);var o=this.m_island;for(o.Initialize(this.m_bodyCount,this.m_contactCount,this.m_jointCount,null,this.m_contactManager.m_contactListener,this.m_contactSolver),e=this.m_bodyList;e;e=e.m_next)e.m_flags&=~f.e_islandFlag;for(var n=this.m_contactList;n;n=n.m_next)n.m_flags&=~V.e_islandFlag;for(var s=this.m_jointList;s;s=s.m_next)s.m_islandFlag=!1;parseInt(this.m_bodyCount);for(var r=this.s_stack,a=this.m_bodyList;a;a=a.m_next)if(!(a.m_flags&f.e_islandFlag)&&0!=a.IsAwake()&&0!=a.IsActive()&&a.GetType()!=f.b2_staticBody){o.Clear();var l=0;for(r[l++]=a,a.m_flags|=f.e_islandFlag;l>0;)if(e=r[--l],o.AddBody(e),0==e.IsAwake()&&e.SetAwake(!0),e.GetType()!=f.b2_staticBody){for(var h,c=e.m_contactList;c;c=c.next)c.contact.m_flags&V.e_islandFlag||1!=c.contact.IsSensor()&&0!=c.contact.IsEnabled()&&0!=c.contact.IsTouching()&&(o.AddContact(c.contact),c.contact.m_flags|=V.e_islandFlag,(h=c.other).m_flags&f.e_islandFlag||(r[l++]=h,h.m_flags|=f.e_islandFlag));for(var m=e.m_jointList;m;m=m.next)1!=m.joint.m_islandFlag&&0!=(h=m.other).IsActive()&&(o.AddJoint(m.joint),m.joint.m_islandFlag=!0,h.m_flags&f.e_islandFlag||(r[l++]=h,h.m_flags|=f.e_islandFlag))}o.Solve(t,this.m_gravity,this.m_allowSleep);for(var u=0;u<o.m_bodyCount;++u)(e=o.m_bodies[u]).GetType()==f.b2_staticBody&&(e.m_flags&=~f.e_islandFlag)}for(u=0;u<r.length&&r[u];++u)r[u]=null;for(e=this.m_bodyList;e;e=e.m_next)0!=e.IsAwake()&&0!=e.IsActive()&&e.GetType()!=f.b2_staticBody&&e.SynchronizeFixtures();this.m_contactManager.FindNewContacts()},I.prototype.SolveTOI=function(t){var e,i,o,n,r,a,l,h=this.m_island;h.Initialize(this.m_bodyCount,s.b2_maxTOIContactsPerIsland,s.b2_maxTOIJointsPerIsland,null,this.m_contactManager.m_contactListener,this.m_contactSolver);var c,m=I.s_queue;for(e=this.m_bodyList;e;e=e.m_next)e.m_flags&=~f.e_islandFlag,e.m_sweep.t0=0;for(c=this.m_contactList;c;c=c.m_next)c.m_flags&=~(V.e_toiFlag|V.e_islandFlag);for(l=this.m_jointList;l;l=l.m_next)l.m_islandFlag=!1;for(;;){var u=null,y=1;for(c=this.m_contactList;c;c=c.m_next)if(1!=c.IsSensor()&&0!=c.IsEnabled()&&0!=c.IsContinuous()){var p=1;if(c.m_flags&V.e_toiFlag)p=c.m_toi;else{if(i=c.m_fixtureA,o=c.m_fixtureB,n=i.m_body,r=o.m_body,!(n.GetType()==f.b2_dynamicBody&&0!=n.IsAwake()||r.GetType()==f.b2_dynamicBody&&0!=r.IsAwake()))continue;var _=n.m_sweep.t0;n.m_sweep.t0<r.m_sweep.t0?(_=r.m_sweep.t0,n.m_sweep.Advance(_)):r.m_sweep.t0<n.m_sweep.t0&&(_=n.m_sweep.t0,r.m_sweep.Advance(_)),p=c.ComputeTOI(n.m_sweep,r.m_sweep),s.b2Assert(0<=p&&p<=1),p>0&&p<1&&(p=(1-p)*_+p)>1&&(p=1),c.m_toi=p,c.m_flags|=V.e_toiFlag}Number.MIN_VALUE<p&&p<y&&(u=c,y=p)}if(null==u||1-100*Number.MIN_VALUE<y)break;if(i=u.m_fixtureA,o=u.m_fixtureB,n=i.m_body,r=o.m_body,I.s_backupA.Set(n.m_sweep),I.s_backupB.Set(r.m_sweep),n.Advance(y),r.Advance(y),u.Update(this.m_contactManager.m_contactListener),u.m_flags&=~V.e_toiFlag,1!=u.IsSensor()&&0!=u.IsEnabled()){if(0!=u.IsTouching()){var d=n;d.GetType()!=f.b2_dynamicBody&&(d=r),h.Clear();var v=0,b=0;for(m[v+b++]=d,d.m_flags|=f.e_islandFlag;b>0;)if(e=m[v++],--b,h.AddBody(e),0==e.IsAwake()&&e.SetAwake(!0),e.GetType()==f.b2_dynamicBody){for(a=e.m_contactList;a&&h.m_contactCount!=h.m_contactCapacity;a=a.next)if(!(a.contact.m_flags&V.e_islandFlag)&&1!=a.contact.IsSensor()&&0!=a.contact.IsEnabled()&&0!=a.contact.IsTouching()){h.AddContact(a.contact),a.contact.m_flags|=V.e_islandFlag;var x=a.other;x.m_flags&f.e_islandFlag||(x.GetType()!=f.b2_staticBody&&(x.Advance(y),x.SetAwake(!0)),m[v+b]=x,++b,x.m_flags|=f.e_islandFlag)}for(var g=e.m_jointList;g;g=g.next)h.m_jointCount!=h.m_jointCapacity&&1!=g.joint.m_islandFlag&&0!=(x=g.other).IsActive()&&(h.AddJoint(g.joint),g.joint.m_islandFlag=!0,x.m_flags&f.e_islandFlag||(x.GetType()!=f.b2_staticBody&&(x.Advance(y),x.SetAwake(!0)),m[v+b]=x,++b,x.m_flags|=f.e_islandFlag))}var w=I.s_timestep;w.warmStarting=!1,w.dt=(1-y)*t.dt,w.inv_dt=1/w.dt,w.dtRatio=0,w.velocityIterations=t.velocityIterations,w.positionIterations=t.positionIterations,h.SolveTOI(w);var C=0;for(C=0;C<h.m_bodyCount;++C)if((e=h.m_bodies[C]).m_flags&=~f.e_islandFlag,0!=e.IsAwake()&&e.GetType()==f.b2_dynamicBody)for(e.SynchronizeFixtures(),a=e.m_contactList;a;a=a.next)a.contact.m_flags&=~V.e_toiFlag;for(C=0;C<h.m_contactCount;++C)(c=h.m_contacts[C]).m_flags&=~(V.e_toiFlag|V.e_islandFlag);for(C=0;C<h.m_jointCount;++C)(l=h.m_joints[C]).m_islandFlag=!1;this.m_contactManager.FindNewContacts()}}else n.m_sweep.Set(I.s_backupA),r.m_sweep.Set(I.s_backupB),n.SynchronizeTransform(),r.SynchronizeTransform()}},I.prototype.DrawJoint=function(t){var e=t.GetBodyA(),i=t.GetBodyB(),o=e.m_xf,n=i.m_xf,s=o.position,r=n.position,a=t.GetAnchorA(),l=t.GetAnchorB(),h=I.s_jointColor;switch(t.m_type){case T.e_distanceJoint:this.m_debugDraw.DrawSegment(a,l,h);break;case T.e_pulleyJoint:var c=t instanceof G?t:null,m=c.GetGroundAnchorA(),u=c.GetGroundAnchorB();this.m_debugDraw.DrawSegment(m,a,h),this.m_debugDraw.DrawSegment(u,l,h),this.m_debugDraw.DrawSegment(m,u,h);break;case T.e_mouseJoint:this.m_debugDraw.DrawSegment(a,l,h);break;default:e!=this.m_groundBody&&this.m_debugDraw.DrawSegment(s,a,h),this.m_debugDraw.DrawSegment(a,l,h),i!=this.m_groundBody&&this.m_debugDraw.DrawSegment(r,l,h)}},I.prototype.DrawShape=function(e,i,o){switch(e.m_type){case _.e_circleShape:var n=e instanceof m?e:null,s=t.MulX(i,n.m_p),r=n.m_radius,a=i.R.col1;this.m_debugDraw.DrawSolidCircle(s,r,a,o);break;case _.e_polygonShape:var l=0,h=e instanceof p?e:null,c=parseInt(h.GetVertexCount()),y=h.GetVertices(),f=new xt(c);for(l=0;l<c;++l)f[l]=t.MulX(i,y[l]);this.m_debugDraw.DrawSolidPolygon(f,c,o);break;case _.e_edgeShape:var d=e instanceof u?e:null;this.m_debugDraw.DrawSegment(t.MulX(i,d.GetVertex1()),t.MulX(i,d.GetVertex2()),o)}},dt.postDefs.push(function(){dt.Dynamics.b2World.s_timestep2=new B,dt.Dynamics.b2World.s_xf=new i,dt.Dynamics.b2World.s_backupA=new e,dt.Dynamics.b2World.s_backupB=new e,dt.Dynamics.b2World.s_timestep=new B,dt.Dynamics.b2World.s_queue=new xt,dt.Dynamics.b2World.s_jointColor=new n(.5,.8,.8),dt.Dynamics.b2World.e_newFixture=1,dt.Dynamics.b2World.e_locked=2})}(),function(){var t=dt.Collision.Shapes.b2CircleShape;dt.Collision.Shapes.b2EdgeChainDef;var e=dt.Collision.Shapes.b2EdgeShape;dt.Collision.Shapes.b2MassData;var i=dt.Collision.Shapes.b2PolygonShape,o=dt.Collision.Shapes.b2Shape,n=dt.Dynamics.Contacts.b2CircleContact,s=dt.Dynamics.Contacts.b2Contact,r=dt.Dynamics.Contacts.b2ContactConstraint,a=dt.Dynamics.Contacts.b2ContactConstraintPoint,l=dt.Dynamics.Contacts.b2ContactEdge,h=dt.Dynamics.Contacts.b2ContactFactory,c=dt.Dynamics.Contacts.b2ContactRegister,m=dt.Dynamics.Contacts.b2ContactResult,u=dt.Dynamics.Contacts.b2ContactSolver,y=dt.Dynamics.Contacts.b2EdgeAndCircleContact,p=dt.Dynamics.Contacts.b2NullContact,_=dt.Dynamics.Contacts.b2PolyAndCircleContact,f=dt.Dynamics.Contacts.b2PolyAndEdgeContact,d=dt.Dynamics.Contacts.b2PolygonContact,v=dt.Dynamics.Contacts.b2PositionSolverManifold,b=dt.Dynamics.b2Body;dt.Dynamics.b2BodyDef,dt.Dynamics.b2ContactFilter,dt.Dynamics.b2ContactImpulse,dt.Dynamics.b2ContactListener,dt.Dynamics.b2ContactManager,dt.Dynamics.b2DebugDraw,dt.Dynamics.b2DestructionListener,dt.Dynamics.b2FilterData,dt.Dynamics.b2Fixture,dt.Dynamics.b2FixtureDef,dt.Dynamics.b2Island;var x=dt.Dynamics.b2TimeStep;dt.Dynamics.b2World,dt.Common.b2Color,dt.Common.b2internal;var g=dt.Common.b2Settings,w=dt.Common.Math.b2Mat22;dt.Common.Math.b2Mat33;var C=dt.Common.Math.b2Math;dt.Common.Math.b2Sweep,dt.Common.Math.b2Transform;var S=dt.Common.Math.b2Vec2;dt.Common.Math.b2Vec3,dt.Collision.b2AABB,dt.Collision.b2Bound,dt.Collision.b2BoundValues;var A=dt.Collision.b2Collision,M=dt.Collision.b2ContactID;dt.Collision.b2ContactPoint,dt.Collision.b2Distance,dt.Collision.b2DistanceInput,dt.Collision.b2DistanceOutput,dt.Collision.b2DistanceProxy,dt.Collision.b2DynamicTree,dt.Collision.b2DynamicTreeBroadPhase,dt.Collision.b2DynamicTreeNode,dt.Collision.b2DynamicTreePair;var D=dt.Collision.b2Manifold;dt.Collision.b2ManifoldPoint,dt.Collision.b2Point,dt.Collision.b2RayCastInput,dt.Collision.b2RayCastOutput,dt.Collision.b2Segment,dt.Collision.b2SeparationFunction,dt.Collision.b2Simplex,dt.Collision.b2SimplexCache,dt.Collision.b2SimplexVertex;var B=dt.Collision.b2TimeOfImpact,I=dt.Collision.b2TOIInput,V=dt.Collision.b2WorldManifold;dt.Collision.ClipVertex,dt.Collision.Features,dt.Collision.IBroadPhase,dt.inherit(n,dt.Dynamics.Contacts.b2Contact),n.prototype.__super=dt.Dynamics.Contacts.b2Contact.prototype,n.b2CircleContact=function(){dt.Dynamics.Contacts.b2Contact.b2Contact.apply(this,arguments)},n.Create=function(t){return new n},n.Destroy=function(t,e){},n.prototype.Reset=function(t,e){this.__super.Reset.call(this,t,e)},n.prototype.Evaluate=function(){var e=this.m_fixtureA.GetBody(),i=this.m_fixtureB.GetBody();A.CollideCircles(this.m_manifold,this.m_fixtureA.GetShape()instanceof t?this.m_fixtureA.GetShape():null,e.m_xf,this.m_fixtureB.GetShape()instanceof t?this.m_fixtureB.GetShape():null,i.m_xf)},s.b2Contact=function(){this.m_nodeA=new l,this.m_nodeB=new l,this.m_manifold=new D,this.m_oldManifold=new D},s.prototype.GetManifold=function(){return this.m_manifold},s.prototype.GetWorldManifold=function(t){var e=this.m_fixtureA.GetBody(),i=this.m_fixtureB.GetBody(),o=this.m_fixtureA.GetShape(),n=this.m_fixtureB.GetShape();t.Initialize(this.m_manifold,e.GetTransform(),o.m_radius,i.GetTransform(),n.m_radius)},s.prototype.IsTouching=function(){return(this.m_flags&s.e_touchingFlag)==s.e_touchingFlag},s.prototype.IsContinuous=function(){return(this.m_flags&s.e_continuousFlag)==s.e_continuousFlag},s.prototype.SetSensor=function(t){t?this.m_flags|=s.e_sensorFlag:this.m_flags&=~s.e_sensorFlag},s.prototype.IsSensor=function(){return(this.m_flags&s.e_sensorFlag)==s.e_sensorFlag},s.prototype.SetEnabled=function(t){t?this.m_flags|=s.e_enabledFlag:this.m_flags&=~s.e_enabledFlag},s.prototype.IsEnabled=function(){return(this.m_flags&s.e_enabledFlag)==s.e_enabledFlag},s.prototype.GetNext=function(){return this.m_next},s.prototype.GetFixtureA=function(){return this.m_fixtureA},s.prototype.GetFixtureB=function(){return this.m_fixtureB},s.prototype.FlagForFiltering=function(){this.m_flags|=s.e_filterFlag},s.prototype.b2Contact=function(){},s.prototype.Reset=function(t,e){if(void 0===t&&(t=null),void 0===e&&(e=null),this.m_flags=s.e_enabledFlag,!t||!e)return this.m_fixtureA=null,void(this.m_fixtureB=null);(t.IsSensor()||e.IsSensor())&&(this.m_flags|=s.e_sensorFlag);var i=t.GetBody(),o=e.GetBody();(i.GetType()!=b.b2_dynamicBody||i.IsBullet()||o.GetType()!=b.b2_dynamicBody||o.IsBullet())&&(this.m_flags|=s.e_continuousFlag),this.m_fixtureA=t,this.m_fixtureB=e,this.m_manifold.m_pointCount=0,this.m_prev=null,this.m_next=null,this.m_nodeA.contact=null,this.m_nodeA.prev=null,this.m_nodeA.next=null,this.m_nodeA.other=null,this.m_nodeB.contact=null,this.m_nodeB.prev=null,this.m_nodeB.next=null,this.m_nodeB.other=null},s.prototype.Update=function(t){var e=this.m_oldManifold;this.m_oldManifold=this.m_manifold,this.m_manifold=e,this.m_flags|=s.e_enabledFlag;var i=!1,n=(this.m_flags&s.e_touchingFlag)==s.e_touchingFlag,r=this.m_fixtureA.m_body,a=this.m_fixtureB.m_body,l=this.m_fixtureA.m_aabb.TestOverlap(this.m_fixtureB.m_aabb);if(this.m_flags&s.e_sensorFlag){if(l){var h=this.m_fixtureA.GetShape(),c=this.m_fixtureB.GetShape(),m=r.GetTransform(),u=a.GetTransform();i=o.TestOverlap(h,m,c,u)}this.m_manifold.m_pointCount=0}else{if(r.GetType()!=b.b2_dynamicBody||r.IsBullet()||a.GetType()!=b.b2_dynamicBody||a.IsBullet()?this.m_flags|=s.e_continuousFlag:this.m_flags&=~s.e_continuousFlag,l){this.Evaluate(),i=this.m_manifold.m_pointCount>0;for(var y=0;y<this.m_manifold.m_pointCount;++y){var p=this.m_manifold.m_points[y];p.m_normalImpulse=0,p.m_tangentImpulse=0;for(var _=p.m_id,f=0;f<this.m_oldManifold.m_pointCount;++f){var d=this.m_oldManifold.m_points[f];if(d.m_id.key==_.key){p.m_normalImpulse=d.m_normalImpulse,p.m_tangentImpulse=d.m_tangentImpulse;break}}}}else this.m_manifold.m_pointCount=0;i!=n&&(r.SetAwake(!0),a.SetAwake(!0))}i?this.m_flags|=s.e_touchingFlag:this.m_flags&=~s.e_touchingFlag,0==n&&1==i&&t.BeginContact(this),1==n&&0==i&&t.EndContact(this),this.m_flags&s.e_sensorFlag||t.PreSolve(this,this.m_oldManifold)},s.prototype.Evaluate=function(){},s.prototype.ComputeTOI=function(t,e){return s.s_input.proxyA.Set(this.m_fixtureA.GetShape()),s.s_input.proxyB.Set(this.m_fixtureB.GetShape()),s.s_input.sweepA=t,s.s_input.sweepB=e,s.s_input.tolerance=g.b2_linearSlop,B.TimeOfImpact(s.s_input)},dt.postDefs.push(function(){dt.Dynamics.Contacts.b2Contact.e_sensorFlag=1,dt.Dynamics.Contacts.b2Contact.e_continuousFlag=2,dt.Dynamics.Contacts.b2Contact.e_islandFlag=4,dt.Dynamics.Contacts.b2Contact.e_toiFlag=8,dt.Dynamics.Contacts.b2Contact.e_touchingFlag=16,dt.Dynamics.Contacts.b2Contact.e_enabledFlag=32,dt.Dynamics.Contacts.b2Contact.e_filterFlag=64,dt.Dynamics.Contacts.b2Contact.s_input=new I}),r.b2ContactConstraint=function(){this.localPlaneNormal=new S,this.localPoint=new S,this.normal=new S,this.normalMass=new w,this.K=new w},r.prototype.b2ContactConstraint=function(){this.points=new xt(g.b2_maxManifoldPoints);for(var t=0;t<g.b2_maxManifoldPoints;t++)this.points[t]=new a},a.b2ContactConstraintPoint=function(){this.localPoint=new S,this.rA=new S,this.rB=new S},l.b2ContactEdge=function(){},h.b2ContactFactory=function(){},h.prototype.b2ContactFactory=function(t){this.m_allocator=t,this.InitializeRegisters()},h.prototype.AddType=function(t,e,i,o){void 0===i&&(i=0),void 0===o&&(o=0),this.m_registers[i][o].createFcn=t,this.m_registers[i][o].destroyFcn=e,this.m_registers[i][o].primary=!0,i!=o&&(this.m_registers[o][i].createFcn=t,this.m_registers[o][i].destroyFcn=e,this.m_registers[o][i].primary=!1)},h.prototype.InitializeRegisters=function(){this.m_registers=new xt(o.e_shapeTypeCount);for(var t=0;t<o.e_shapeTypeCount;t++){this.m_registers[t]=new xt(o.e_shapeTypeCount);for(var e=0;e<o.e_shapeTypeCount;e++)this.m_registers[t][e]=new c}this.AddType(n.Create,n.Destroy,o.e_circleShape,o.e_circleShape),this.AddType(_.Create,_.Destroy,o.e_polygonShape,o.e_circleShape),this.AddType(d.Create,d.Destroy,o.e_polygonShape,o.e_polygonShape),this.AddType(y.Create,y.Destroy,o.e_edgeShape,o.e_circleShape),this.AddType(f.Create,f.Destroy,o.e_polygonShape,o.e_edgeShape)},h.prototype.Create=function(t,e){var i,o=parseInt(t.GetType()),n=parseInt(e.GetType()),s=this.m_registers[o][n];if(s.pool)return i=s.pool,s.pool=i.m_next,s.poolCount--,i.Reset(t,e),i;var r=s.createFcn;return null!=r?s.primary?((i=r(this.m_allocator)).Reset(t,e),i):((i=r(this.m_allocator)).Reset(e,t),i):null},h.prototype.Destroy=function(t){t.m_manifold.m_pointCount>0&&(t.m_fixtureA.m_body.SetAwake(!0),t.m_fixtureB.m_body.SetAwake(!0));var e=parseInt(t.m_fixtureA.GetType()),i=parseInt(t.m_fixtureB.GetType()),o=this.m_registers[e][i];o.poolCount++,t.m_next=o.pool,o.pool=t,(0,o.destroyFcn)(t,this.m_allocator)},c.b2ContactRegister=function(){},m.b2ContactResult=function(){this.position=new S,this.normal=new S,this.id=new M},u.b2ContactSolver=function(){this.m_step=new x,this.m_constraints=new xt},u.prototype.b2ContactSolver=function(){},u.prototype.Initialize=function(t,e,i,o){var n;void 0===i&&(i=0),this.m_step.Set(t),this.m_allocator=o;var s=0;for(this.m_constraintCount=i;this.m_constraints.length<this.m_constraintCount;)this.m_constraints[this.m_constraints.length]=new r;for(s=0;s<i;++s){var a=(n=e[s]).m_fixtureA,l=n.m_fixtureB,h=a.m_shape,c=l.m_shape,m=h.m_radius,y=c.m_radius,p=a.m_body,_=l.m_body,f=n.GetManifold(),d=g.b2MixFriction(a.GetFriction(),l.GetFriction()),v=g.b2MixRestitution(a.GetRestitution(),l.GetRestitution()),b=p.m_linearVelocity.x,x=p.m_linearVelocity.y,w=_.m_linearVelocity.x,C=_.m_linearVelocity.y,S=p.m_angularVelocity,A=_.m_angularVelocity;g.b2Assert(f.m_pointCount>0),u.s_worldManifold.Initialize(f,p.m_xf,m,_.m_xf,y);var M=u.s_worldManifold.m_normal.x,D=u.s_worldManifold.m_normal.y,B=this.m_constraints[s];B.bodyA=p,B.bodyB=_,B.manifold=f,B.normal.x=M,B.normal.y=D,B.pointCount=f.m_pointCount,B.friction=d,B.restitution=v,B.localPlaneNormal.x=f.m_localPlaneNormal.x,B.localPlaneNormal.y=f.m_localPlaneNormal.y,B.localPoint.x=f.m_localPoint.x,B.localPoint.y=f.m_localPoint.y,B.radius=m+y,B.type=f.m_type;for(var I=0;I<B.pointCount;++I){var V=f.m_points[I],k=B.points[I];k.normalImpulse=V.m_normalImpulse,k.tangentImpulse=V.m_tangentImpulse,k.localPoint.SetV(V.m_localPoint);var P=k.rA.x=u.s_worldManifold.m_points[I].x-p.m_sweep.c.x,T=k.rA.y=u.s_worldManifold.m_points[I].y-p.m_sweep.c.y,G=k.rB.x=u.s_worldManifold.m_points[I].x-_.m_sweep.c.x,L=k.rB.y=u.s_worldManifold.m_points[I].y-_.m_sweep.c.y,E=P*D-T*M,F=G*D-L*M;E*=E,F*=F;var R=p.m_invMass+_.m_invMass+p.m_invI*E+_.m_invI*F;k.normalMass=1/R;var J=p.m_mass*p.m_invMass+_.m_mass*_.m_invMass;J+=p.m_mass*p.m_invI*E+_.m_mass*_.m_invI*F,k.equalizedMass=1/J;var O=-M,z=P*O-T*D,j=G*O-L*D;z*=z,j*=j;var N=p.m_invMass+_.m_invMass+p.m_invI*z+_.m_invI*j;k.tangentMass=1/N,k.velocityBias=0;var X=w+-A*L-b- -S*T,W=C+A*G-x-S*P,Y=B.normal.x*X+B.normal.y*W;Y<-g.b2_velocityThreshold&&(k.velocityBias+=-B.restitution*Y)}if(2==B.pointCount){var q=B.points[0],U=B.points[1],K=p.m_invMass,Z=p.m_invI,H=_.m_invMass,Q=_.m_invI,$=q.rA.x*D-q.rA.y*M,tt=q.rB.x*D-q.rB.y*M,et=U.rA.x*D-U.rA.y*M,it=U.rB.x*D-U.rB.y*M,ot=K+H+Z*$*$+Q*tt*tt,nt=K+H+Z*et*et+Q*it*it,st=K+H+Z*$*et+Q*tt*it;ot*ot<100*(ot*nt-st*st)?(B.K.col1.Set(ot,st),B.K.col2.Set(st,nt),B.K.GetInverse(B.normalMass)):B.pointCount=1}}},u.prototype.InitVelocityConstraints=function(t){for(var e=0;e<this.m_constraintCount;++e){var i=this.m_constraints[e],o=i.bodyA,n=i.bodyB,s=o.m_invMass,r=o.m_invI,a=n.m_invMass,l=n.m_invI,h=i.normal.x,c=i.normal.y,m=c,u=-h,y=0,p=0;if(t.warmStarting)for(p=i.pointCount,y=0;y<p;++y){var _=i.points[y];_.normalImpulse*=t.dtRatio,_.tangentImpulse*=t.dtRatio;var f=_.normalImpulse*h+_.tangentImpulse*m,d=_.normalImpulse*c+_.tangentImpulse*u;o.m_angularVelocity-=r*(_.rA.x*d-_.rA.y*f),o.m_linearVelocity.x-=s*f,o.m_linearVelocity.y-=s*d,n.m_angularVelocity+=l*(_.rB.x*d-_.rB.y*f),n.m_linearVelocity.x+=a*f,n.m_linearVelocity.y+=a*d}else for(p=i.pointCount,y=0;y<p;++y){var v=i.points[y];v.normalImpulse=0,v.tangentImpulse=0}}},u.prototype.SolveVelocityConstraints=function(){for(var t,e,i=0,o=0,n=0,s=0,r=0,a=0,l=0,h=0,c=0,m=0,u=0,y=0,p=0,_=0,f=0;f<this.m_constraintCount;++f){var d=this.m_constraints[f],v=d.bodyA,b=d.bodyB,x=v.m_angularVelocity,g=b.m_angularVelocity,w=v.m_linearVelocity,S=b.m_linearVelocity,A=v.m_invMass,M=v.m_invI,D=b.m_invMass,B=b.m_invI,I=d.normal.x,V=d.normal.y,k=V,P=-I,T=d.friction;for(i=0;i<d.pointCount;i++)t=d.points[i],n=(S.x-g*t.rB.y-w.x+x*t.rA.y)*k+(S.y+g*t.rB.x-w.y-x*t.rA.x)*P,s=t.tangentMass*-n,r=T*t.normalImpulse,l=(s=(a=C.Clamp(t.tangentImpulse+s,-r,r))-t.tangentImpulse)*k,h=s*P,w.x-=A*l,w.y-=A*h,x-=M*(t.rA.x*h-t.rA.y*l),S.x+=D*l,S.y+=D*h,g+=B*(t.rB.x*h-t.rB.y*l),t.tangentImpulse=a;if(parseInt(d.pointCount),1==d.pointCount)t=d.points[0],o=(S.x+-g*t.rB.y-w.x- -x*t.rA.y)*I+(S.y+g*t.rB.x-w.y-x*t.rA.x)*V,s=-t.normalMass*(o-t.velocityBias),l=(s=(a=(a=t.normalImpulse+s)>0?a:0)-t.normalImpulse)*I,h=s*V,w.x-=A*l,w.y-=A*h,x-=M*(t.rA.x*h-t.rA.y*l),S.x+=D*l,S.y+=D*h,g+=B*(t.rB.x*h-t.rB.y*l),t.normalImpulse=a;else{var G=d.points[0],L=d.points[1],E=G.normalImpulse,F=L.normalImpulse,R=(S.x-g*G.rB.y-w.x+x*G.rA.y)*I+(S.y+g*G.rB.x-w.y-x*G.rA.x)*V,J=(S.x-g*L.rB.y-w.x+x*L.rA.y)*I+(S.y+g*L.rB.x-w.y-x*L.rA.x)*V,O=R-G.velocityBias,z=J-L.velocityBias;for(O-=(e=d.K).col1.x*E+e.col2.x*F,z-=e.col1.y*E+e.col2.y*F;;){var j=-((e=d.normalMass).col1.x*O+e.col2.x*z),N=-(e.col1.y*O+e.col2.y*z);if(j>=0&&N>=0){u=(c=j-E)*I,y=c*V,p=(m=N-F)*I,_=m*V,w.x-=A*(u+p),w.y-=A*(y+_),x-=M*(G.rA.x*y-G.rA.y*u+L.rA.x*_-L.rA.y*p),S.x+=D*(u+p),S.y+=D*(y+_),g+=B*(G.rB.x*y-G.rB.y*u+L.rB.x*_-L.rB.y*p),G.normalImpulse=j,L.normalImpulse=N;break}if(j=-G.normalMass*O,N=0,R=0,J=d.K.col1.y*j+z,j>=0&&J>=0){u=(c=j-E)*I,y=c*V,p=(m=N-F)*I,_=m*V,w.x-=A*(u+p),w.y-=A*(y+_),x-=M*(G.rA.x*y-G.rA.y*u+L.rA.x*_-L.rA.y*p),S.x+=D*(u+p),S.y+=D*(y+_),g+=B*(G.rB.x*y-G.rB.y*u+L.rB.x*_-L.rB.y*p),G.normalImpulse=j,L.normalImpulse=N;break}if(j=0,N=-L.normalMass*z,R=d.K.col2.x*N+O,J=0,N>=0&&R>=0){u=(c=j-E)*I,y=c*V,p=(m=N-F)*I,_=m*V,w.x-=A*(u+p),w.y-=A*(y+_),x-=M*(G.rA.x*y-G.rA.y*u+L.rA.x*_-L.rA.y*p),S.x+=D*(u+p),S.y+=D*(y+_),g+=B*(G.rB.x*y-G.rB.y*u+L.rB.x*_-L.rB.y*p),G.normalImpulse=j,L.normalImpulse=N;break}if(j=0,N=0,J=z,(R=O)>=0&&J>=0){u=(c=j-E)*I,y=c*V,p=(m=N-F)*I,_=m*V,w.x-=A*(u+p),w.y-=A*(y+_),x-=M*(G.rA.x*y-G.rA.y*u+L.rA.x*_-L.rA.y*p),S.x+=D*(u+p),S.y+=D*(y+_),g+=B*(G.rB.x*y-G.rB.y*u+L.rB.x*_-L.rB.y*p),G.normalImpulse=j,L.normalImpulse=N;break}break}}v.m_angularVelocity=x,b.m_angularVelocity=g}},u.prototype.FinalizeVelocityConstraints=function(){for(var t=0;t<this.m_constraintCount;++t)for(var e=this.m_constraints[t],i=e.manifold,o=0;o<e.pointCount;++o){var n=i.m_points[o],s=e.points[o];n.m_normalImpulse=s.normalImpulse,n.m_tangentImpulse=s.tangentImpulse}},u.prototype.SolvePositionConstraints=function(t){void 0===t&&(t=0);for(var e=0,i=0;i<this.m_constraintCount;i++){var o=this.m_constraints[i],n=o.bodyA,s=o.bodyB,r=n.m_mass*n.m_invMass,a=n.m_mass*n.m_invI,l=s.m_mass*s.m_invMass,h=s.m_mass*s.m_invI;u.s_psm.Initialize(o);for(var c=u.s_psm.m_normal,m=0;m<o.pointCount;m++){var y=o.points[m],p=u.s_psm.m_points[m],_=u.s_psm.m_separations[m],f=p.x-n.m_sweep.c.x,d=p.y-n.m_sweep.c.y,v=p.x-s.m_sweep.c.x,b=p.y-s.m_sweep.c.y;e=e<_?e:_;var x=C.Clamp(t*(_+g.b2_linearSlop),-g.b2_maxLinearCorrection,0),w=-y.equalizedMass*x,S=w*c.x,A=w*c.y;n.m_sweep.c.x-=r*S,n.m_sweep.c.y-=r*A,n.m_sweep.a-=a*(f*A-d*S),n.SynchronizeTransform(),s.m_sweep.c.x+=l*S,s.m_sweep.c.y+=l*A,s.m_sweep.a+=h*(v*A-b*S),s.SynchronizeTransform()}}return e>-1.5*g.b2_linearSlop},dt.postDefs.push(function(){dt.Dynamics.Contacts.b2ContactSolver.s_worldManifold=new V,dt.Dynamics.Contacts.b2ContactSolver.s_psm=new v}),dt.inherit(y,dt.Dynamics.Contacts.b2Contact),y.prototype.__super=dt.Dynamics.Contacts.b2Contact.prototype,y.b2EdgeAndCircleContact=function(){dt.Dynamics.Contacts.b2Contact.b2Contact.apply(this,arguments)},y.Create=function(t){return new y},y.Destroy=function(t,e){},y.prototype.Reset=function(t,e){this.__super.Reset.call(this,t,e)},y.prototype.Evaluate=function(){var i=this.m_fixtureA.GetBody(),o=this.m_fixtureB.GetBody();this.b2CollideEdgeAndCircle(this.m_manifold,this.m_fixtureA.GetShape()instanceof e?this.m_fixtureA.GetShape():null,i.m_xf,this.m_fixtureB.GetShape()instanceof t?this.m_fixtureB.GetShape():null,o.m_xf)},y.prototype.b2CollideEdgeAndCircle=function(t,e,i,o,n){},dt.inherit(p,dt.Dynamics.Contacts.b2Contact),p.prototype.__super=dt.Dynamics.Contacts.b2Contact.prototype,p.b2NullContact=function(){dt.Dynamics.Contacts.b2Contact.b2Contact.apply(this,arguments)},p.prototype.b2NullContact=function(){this.__super.b2Contact.call(this)},p.prototype.Evaluate=function(){},dt.inherit(_,dt.Dynamics.Contacts.b2Contact),_.prototype.__super=dt.Dynamics.Contacts.b2Contact.prototype,_.b2PolyAndCircleContact=function(){dt.Dynamics.Contacts.b2Contact.b2Contact.apply(this,arguments)},_.Create=function(t){return new _},_.Destroy=function(t,e){},_.prototype.Reset=function(t,e){this.__super.Reset.call(this,t,e),g.b2Assert(t.GetType()==o.e_polygonShape),g.b2Assert(e.GetType()==o.e_circleShape)},_.prototype.Evaluate=function(){var e=this.m_fixtureA.m_body,o=this.m_fixtureB.m_body;A.CollidePolygonAndCircle(this.m_manifold,this.m_fixtureA.GetShape()instanceof i?this.m_fixtureA.GetShape():null,e.m_xf,this.m_fixtureB.GetShape()instanceof t?this.m_fixtureB.GetShape():null,o.m_xf)},dt.inherit(f,dt.Dynamics.Contacts.b2Contact),f.prototype.__super=dt.Dynamics.Contacts.b2Contact.prototype,f.b2PolyAndEdgeContact=function(){dt.Dynamics.Contacts.b2Contact.b2Contact.apply(this,arguments)},f.Create=function(t){return new f},f.Destroy=function(t,e){},f.prototype.Reset=function(t,e){this.__super.Reset.call(this,t,e),g.b2Assert(t.GetType()==o.e_polygonShape),g.b2Assert(e.GetType()==o.e_edgeShape)},f.prototype.Evaluate=function(){var t=this.m_fixtureA.GetBody(),o=this.m_fixtureB.GetBody();this.b2CollidePolyAndEdge(this.m_manifold,this.m_fixtureA.GetShape()instanceof i?this.m_fixtureA.GetShape():null,t.m_xf,this.m_fixtureB.GetShape()instanceof e?this.m_fixtureB.GetShape():null,o.m_xf)},f.prototype.b2CollidePolyAndEdge=function(t,e,i,o,n){},dt.inherit(d,dt.Dynamics.Contacts.b2Contact),d.prototype.__super=dt.Dynamics.Contacts.b2Contact.prototype,d.b2PolygonContact=function(){dt.Dynamics.Contacts.b2Contact.b2Contact.apply(this,arguments)},d.Create=function(t){return new d},d.Destroy=function(t,e){},d.prototype.Reset=function(t,e){this.__super.Reset.call(this,t,e)},d.prototype.Evaluate=function(){var t=this.m_fixtureA.GetBody(),e=this.m_fixtureB.GetBody();A.CollidePolygons(this.m_manifold,this.m_fixtureA.GetShape()instanceof i?this.m_fixtureA.GetShape():null,t.m_xf,this.m_fixtureB.GetShape()instanceof i?this.m_fixtureB.GetShape():null,e.m_xf)},v.b2PositionSolverManifold=function(){},v.prototype.b2PositionSolverManifold=function(){this.m_normal=new S,this.m_separations=new gt(g.b2_maxManifoldPoints),this.m_points=new xt(g.b2_maxManifoldPoints);for(var t=0;t<g.b2_maxManifoldPoints;t++)this.m_points[t]=new S},v.prototype.Initialize=function(t){g.b2Assert(t.pointCount>0);var e,i,o=0,n=0,s=0,r=0,a=0;switch(t.type){case D.e_circles:e=t.bodyA.m_xf.R,i=t.localPoint;var l=t.bodyA.m_xf.position.x+(e.col1.x*i.x+e.col2.x*i.y),h=t.bodyA.m_xf.position.y+(e.col1.y*i.x+e.col2.y*i.y);e=t.bodyB.m_xf.R,i=t.points[0].localPoint;var c=t.bodyB.m_xf.position.x+(e.col1.x*i.x+e.col2.x*i.y),m=t.bodyB.m_xf.position.y+(e.col1.y*i.x+e.col2.y*i.y),u=c-l,y=m-h,p=u*u+y*y;if(p>Number.MIN_VALUE*Number.MIN_VALUE){var _=Math.sqrt(p);this.m_normal.x=u/_,this.m_normal.y=y/_}else this.m_normal.x=1,this.m_normal.y=0;this.m_points[0].x=.5*(l+c),this.m_points[0].y=.5*(h+m),this.m_separations[0]=u*this.m_normal.x+y*this.m_normal.y-t.radius;break;case D.e_faceA:for(e=t.bodyA.m_xf.R,i=t.localPlaneNormal,this.m_normal.x=e.col1.x*i.x+e.col2.x*i.y,this.m_normal.y=e.col1.y*i.x+e.col2.y*i.y,e=t.bodyA.m_xf.R,i=t.localPoint,r=t.bodyA.m_xf.position.x+(e.col1.x*i.x+e.col2.x*i.y),a=t.bodyA.m_xf.position.y+(e.col1.y*i.x+e.col2.y*i.y),e=t.bodyB.m_xf.R,o=0;o<t.pointCount;++o)i=t.points[o].localPoint,n=t.bodyB.m_xf.position.x+(e.col1.x*i.x+e.col2.x*i.y),s=t.bodyB.m_xf.position.y+(e.col1.y*i.x+e.col2.y*i.y),this.m_separations[o]=(n-r)*this.m_normal.x+(s-a)*this.m_normal.y-t.radius,this.m_points[o].x=n,this.m_points[o].y=s;break;case D.e_faceB:for(e=t.bodyB.m_xf.R,i=t.localPlaneNormal,this.m_normal.x=e.col1.x*i.x+e.col2.x*i.y,this.m_normal.y=e.col1.y*i.x+e.col2.y*i.y,e=t.bodyB.m_xf.R,i=t.localPoint,r=t.bodyB.m_xf.position.x+(e.col1.x*i.x+e.col2.x*i.y),a=t.bodyB.m_xf.position.y+(e.col1.y*i.x+e.col2.y*i.y),e=t.bodyA.m_xf.R,o=0;o<t.pointCount;++o)i=t.points[o].localPoint,n=t.bodyA.m_xf.position.x+(e.col1.x*i.x+e.col2.x*i.y),s=t.bodyA.m_xf.position.y+(e.col1.y*i.x+e.col2.y*i.y),this.m_separations[o]=(n-r)*this.m_normal.x+(s-a)*this.m_normal.y-t.radius,this.m_points[o].Set(n,s);this.m_normal.x*=-1,this.m_normal.y*=-1}},dt.postDefs.push(function(){dt.Dynamics.Contacts.b2PositionSolverManifold.circlePointA=new S,dt.Dynamics.Contacts.b2PositionSolverManifold.circlePointB=new S})}(),function(){dt.Dynamics.b2Body,dt.Dynamics.b2BodyDef,dt.Dynamics.b2ContactFilter,dt.Dynamics.b2ContactImpulse,dt.Dynamics.b2ContactListener,dt.Dynamics.b2ContactManager,dt.Dynamics.b2DebugDraw,dt.Dynamics.b2DestructionListener,dt.Dynamics.b2FilterData,dt.Dynamics.b2Fixture,dt.Dynamics.b2FixtureDef,dt.Dynamics.b2Island,dt.Dynamics.b2TimeStep,dt.Dynamics.b2World;var t=dt.Common.Math.b2Mat22;dt.Common.Math.b2Mat33;var e=dt.Common.Math.b2Math;dt.Common.Math.b2Sweep,dt.Common.Math.b2Transform;var i=dt.Common.Math.b2Vec2;dt.Common.Math.b2Vec3;var o=dt.Common.b2Color;dt.Common.b2internal,dt.Common.b2Settings,dt.Collision.Shapes.b2CircleShape,dt.Collision.Shapes.b2EdgeChainDef,dt.Collision.Shapes.b2EdgeShape,dt.Collision.Shapes.b2MassData,dt.Collision.Shapes.b2PolygonShape,dt.Collision.Shapes.b2Shape;var n=dt.Dynamics.Controllers.b2BuoyancyController,s=dt.Dynamics.Controllers.b2ConstantAccelController,r=dt.Dynamics.Controllers.b2ConstantForceController,a=dt.Dynamics.Controllers.b2Controller,l=dt.Dynamics.Controllers.b2ControllerEdge,h=dt.Dynamics.Controllers.b2GravityController,c=dt.Dynamics.Controllers.b2TensorDampingController;dt.inherit(n,dt.Dynamics.Controllers.b2Controller),n.prototype.__super=dt.Dynamics.Controllers.b2Controller.prototype,n.b2BuoyancyController=function(){dt.Dynamics.Controllers.b2Controller.b2Controller.apply(this,arguments),this.normal=new i(0,-1),this.offset=0,this.density=0,this.velocity=new i(0,0),this.linearDrag=2,this.angularDrag=1,this.useDensity=!1,this.useWorldGravity=!0,this.gravity=null},n.prototype.Step=function(t){if(this.m_bodyList){this.useWorldGravity&&(this.gravity=this.GetWorld().GetGravity().Copy());for(var e=this.m_bodyList;e;e=e.nextBody){var o=e.body;if(0!=o.IsAwake()){for(var n=new i,s=new i,r=0,a=0,l=o.GetFixtureList();l;l=l.GetNext()){var h=new i,c=l.GetShape().ComputeSubmergedArea(this.normal,this.offset,o.GetTransform(),h);r+=c,n.x+=c*h.x,n.y+=c*h.y;var m=0;a+=c*(this.useDensity,m=1),s.x+=c*h.x*m,s.y+=c*h.y*m}if(n.x/=r,n.y/=r,s.x/=a,s.y/=a,!(r<Number.MIN_VALUE)){var u=this.gravity.GetNegative();u.Multiply(this.density*r),o.ApplyForce(u,s);var y=o.GetLinearVelocityFromWorldPoint(n);y.Subtract(this.velocity),y.Multiply(-this.linearDrag*r),o.ApplyForce(y,n),o.ApplyTorque(-o.GetInertia()/o.GetMass()*r*o.GetAngularVelocity()*this.angularDrag)}}}}},n.prototype.Draw=function(t){var e=1e3,n=new i,s=new i;n.x=this.normal.x*this.offset+this.normal.y*e,n.y=this.normal.y*this.offset-this.normal.x*e,s.x=this.normal.x*this.offset-this.normal.y*e,s.y=this.normal.y*this.offset+this.normal.x*e;var r=new o(0,0,1);t.DrawSegment(n,s,r)},dt.inherit(s,dt.Dynamics.Controllers.b2Controller),s.prototype.__super=dt.Dynamics.Controllers.b2Controller.prototype,s.b2ConstantAccelController=function(){dt.Dynamics.Controllers.b2Controller.b2Controller.apply(this,arguments),this.A=new i(0,0)},s.prototype.Step=function(t){for(var e=new i(this.A.x*t.dt,this.A.y*t.dt),o=this.m_bodyList;o;o=o.nextBody){var n=o.body;n.IsAwake()&&n.SetLinearVelocity(new i(n.GetLinearVelocity().x+e.x,n.GetLinearVelocity().y+e.y))}},dt.inherit(r,dt.Dynamics.Controllers.b2Controller),r.prototype.__super=dt.Dynamics.Controllers.b2Controller.prototype,r.b2ConstantForceController=function(){dt.Dynamics.Controllers.b2Controller.b2Controller.apply(this,arguments),this.F=new i(0,0)},r.prototype.Step=function(t){for(var e=this.m_bodyList;e;e=e.nextBody){var i=e.body;i.IsAwake()&&i.ApplyForce(this.F,i.GetWorldCenter())}},a.b2Controller=function(){},a.prototype.Step=function(t){},a.prototype.Draw=function(t){},a.prototype.AddBody=function(t){var e=new l;e.controller=this,e.body=t,e.nextBody=this.m_bodyList,e.prevBody=null,this.m_bodyList=e,e.nextBody&&(e.nextBody.prevBody=e),this.m_bodyCount++,e.nextController=t.m_controllerList,e.prevController=null,t.m_controllerList=e,e.nextController&&(e.nextController.prevController=e),t.m_controllerCount++},a.prototype.RemoveBody=function(t){for(var e=t.m_controllerList;e&&e.controller!=this;)e=e.nextController;e.prevBody&&(e.prevBody.nextBody=e.nextBody),e.nextBody&&(e.nextBody.prevBody=e.prevBody),e.nextController&&(e.nextController.prevController=e.prevController),e.prevController&&(e.prevController.nextController=e.nextController),this.m_bodyList==e&&(this.m_bodyList=e.nextBody),t.m_controllerList==e&&(t.m_controllerList=e.nextController),t.m_controllerCount--,this.m_bodyCount--},a.prototype.Clear=function(){for(;this.m_bodyList;)this.RemoveBody(this.m_bodyList.body)},a.prototype.GetNext=function(){return this.m_next},a.prototype.GetWorld=function(){return this.m_world},a.prototype.GetBodyList=function(){return this.m_bodyList},l.b2ControllerEdge=function(){},dt.inherit(h,dt.Dynamics.Controllers.b2Controller),h.prototype.__super=dt.Dynamics.Controllers.b2Controller.prototype,h.b2GravityController=function(){dt.Dynamics.Controllers.b2Controller.b2Controller.apply(this,arguments),this.G=1,this.invSqr=!0},h.prototype.Step=function(t){var e=null,o=null,n=null,s=0,r=null,a=null,l=null,h=0,c=0,m=0,u=null;if(this.invSqr)for(e=this.m_bodyList;e;e=e.nextBody)for(n=(o=e.body).GetWorldCenter(),s=o.GetMass(),r=this.m_bodyList;r!=e;r=r.nextBody)(m=(h=(l=(a=r.body).GetWorldCenter()).x-n.x)*h+(c=l.y-n.y)*c)<Number.MIN_VALUE||((u=new i(h,c)).Multiply(this.G/m/Math.sqrt(m)*s*a.GetMass()),o.IsAwake()&&o.ApplyForce(u,n),u.Multiply(-1),a.IsAwake()&&a.ApplyForce(u,l));else for(e=this.m_bodyList;e;e=e.nextBody)for(n=(o=e.body).GetWorldCenter(),s=o.GetMass(),r=this.m_bodyList;r!=e;r=r.nextBody)(m=(h=(l=(a=r.body).GetWorldCenter()).x-n.x)*h+(c=l.y-n.y)*c)<Number.MIN_VALUE||((u=new i(h,c)).Multiply(this.G/m*s*a.GetMass()),o.IsAwake()&&o.ApplyForce(u,n),u.Multiply(-1),a.IsAwake()&&a.ApplyForce(u,l))},dt.inherit(c,dt.Dynamics.Controllers.b2Controller),c.prototype.__super=dt.Dynamics.Controllers.b2Controller.prototype,c.b2TensorDampingController=function(){dt.Dynamics.Controllers.b2Controller.b2Controller.apply(this,arguments),this.T=new t,this.maxTimestep=0},c.prototype.SetAxisAligned=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.T.col1.x=-t,this.T.col1.y=0,this.T.col2.x=0,this.T.col2.y=-e,this.maxTimestep=t>0||e>0?1/Math.max(t,e):0},c.prototype.Step=function(t){var o=t.dt;if(!(o<=Number.MIN_VALUE)){o>this.maxTimestep&&this.maxTimestep>0&&(o=this.maxTimestep);for(var n=this.m_bodyList;n;n=n.nextBody){var s=n.body;if(s.IsAwake()){var r=s.GetWorldVector(e.MulMV(this.T,s.GetLocalVector(s.GetLinearVelocity())));s.SetLinearVelocity(new i(s.GetLinearVelocity().x+r.x*o,s.GetLinearVelocity().y+r.y*o))}}}}}(),function(){dt.Common.b2Color,dt.Common.b2internal;var t=dt.Common.b2Settings,e=dt.Common.Math.b2Mat22,i=dt.Common.Math.b2Mat33,o=dt.Common.Math.b2Math;dt.Common.Math.b2Sweep,dt.Common.Math.b2Transform;var n=dt.Common.Math.b2Vec2,s=dt.Common.Math.b2Vec3,r=dt.Dynamics.Joints.b2DistanceJoint,a=dt.Dynamics.Joints.b2DistanceJointDef,l=dt.Dynamics.Joints.b2FrictionJoint,h=dt.Dynamics.Joints.b2FrictionJointDef,c=dt.Dynamics.Joints.b2GearJoint,m=dt.Dynamics.Joints.b2GearJointDef,u=dt.Dynamics.Joints.b2Jacobian,y=dt.Dynamics.Joints.b2Joint,p=dt.Dynamics.Joints.b2JointDef,_=dt.Dynamics.Joints.b2JointEdge,f=dt.Dynamics.Joints.b2LineJoint,d=dt.Dynamics.Joints.b2LineJointDef,v=dt.Dynamics.Joints.b2MouseJoint,b=dt.Dynamics.Joints.b2MouseJointDef,x=dt.Dynamics.Joints.b2PrismaticJoint,g=dt.Dynamics.Joints.b2PrismaticJointDef,w=dt.Dynamics.Joints.b2PulleyJoint,C=dt.Dynamics.Joints.b2PulleyJointDef,S=dt.Dynamics.Joints.b2RevoluteJoint,A=dt.Dynamics.Joints.b2RevoluteJointDef,M=dt.Dynamics.Joints.b2WeldJoint,D=dt.Dynamics.Joints.b2WeldJointDef;dt.Dynamics.b2Body,dt.Dynamics.b2BodyDef,dt.Dynamics.b2ContactFilter,dt.Dynamics.b2ContactImpulse,dt.Dynamics.b2ContactListener,dt.Dynamics.b2ContactManager,dt.Dynamics.b2DebugDraw,dt.Dynamics.b2DestructionListener,dt.Dynamics.b2FilterData,dt.Dynamics.b2Fixture,dt.Dynamics.b2FixtureDef,dt.Dynamics.b2Island,dt.Dynamics.b2TimeStep,dt.Dynamics.b2World,dt.inherit(r,dt.Dynamics.Joints.b2Joint),r.prototype.__super=dt.Dynamics.Joints.b2Joint.prototype,r.b2DistanceJoint=function(){dt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_localAnchor1=new n,this.m_localAnchor2=new n,this.m_u=new n},r.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},r.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},r.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new n(t*this.m_impulse*this.m_u.x,t*this.m_impulse*this.m_u.y)},r.prototype.GetReactionTorque=function(t){return 0},r.prototype.GetLength=function(){return this.m_length},r.prototype.SetLength=function(t){void 0===t&&(t=0),this.m_length=t},r.prototype.GetFrequency=function(){return this.m_frequencyHz},r.prototype.SetFrequency=function(t){void 0===t&&(t=0),this.m_frequencyHz=t},r.prototype.GetDampingRatio=function(){return this.m_dampingRatio},r.prototype.SetDampingRatio=function(t){void 0===t&&(t=0),this.m_dampingRatio=t},r.prototype.b2DistanceJoint=function(t){this.__super.b2Joint.call(this,t),this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_length=t.length,this.m_frequencyHz=t.frequencyHz,this.m_dampingRatio=t.dampingRatio,this.m_impulse=0,this.m_gamma=0,this.m_bias=0},r.prototype.InitVelocityConstraints=function(e){var i,o=0,n=this.m_bodyA,s=this.m_bodyB;i=n.m_xf.R;var r=this.m_localAnchor1.x-n.m_sweep.localCenter.x,a=this.m_localAnchor1.y-n.m_sweep.localCenter.y;o=i.col1.x*r+i.col2.x*a,a=i.col1.y*r+i.col2.y*a,r=o,i=s.m_xf.R;var l=this.m_localAnchor2.x-s.m_sweep.localCenter.x,h=this.m_localAnchor2.y-s.m_sweep.localCenter.y;o=i.col1.x*l+i.col2.x*h,h=i.col1.y*l+i.col2.y*h,l=o,this.m_u.x=s.m_sweep.c.x+l-n.m_sweep.c.x-r,this.m_u.y=s.m_sweep.c.y+h-n.m_sweep.c.y-a;var c=Math.sqrt(this.m_u.x*this.m_u.x+this.m_u.y*this.m_u.y);c>t.b2_linearSlop?this.m_u.Multiply(1/c):this.m_u.SetZero();var m=r*this.m_u.y-a*this.m_u.x,u=l*this.m_u.y-h*this.m_u.x,y=n.m_invMass+n.m_invI*m*m+s.m_invMass+s.m_invI*u*u;if(this.m_mass=0!=y?1/y:0,this.m_frequencyHz>0){var p=c-this.m_length,_=2*Math.PI*this.m_frequencyHz,f=2*this.m_mass*this.m_dampingRatio*_,d=this.m_mass*_*_;this.m_gamma=e.dt*(f+e.dt*d),this.m_gamma=0!=this.m_gamma?1/this.m_gamma:0,this.m_bias=p*e.dt*d*this.m_gamma,this.m_mass=y+this.m_gamma,this.m_mass=0!=this.m_mass?1/this.m_mass:0}if(e.warmStarting){this.m_impulse*=e.dtRatio;var v=this.m_impulse*this.m_u.x,b=this.m_impulse*this.m_u.y;n.m_linearVelocity.x-=n.m_invMass*v,n.m_linearVelocity.y-=n.m_invMass*b,n.m_angularVelocity-=n.m_invI*(r*b-a*v),s.m_linearVelocity.x+=s.m_invMass*v,s.m_linearVelocity.y+=s.m_invMass*b,s.m_angularVelocity+=s.m_invI*(l*b-h*v)}else this.m_impulse=0},r.prototype.SolveVelocityConstraints=function(t){var e,i=this.m_bodyA,o=this.m_bodyB;e=i.m_xf.R;var n=this.m_localAnchor1.x-i.m_sweep.localCenter.x,s=this.m_localAnchor1.y-i.m_sweep.localCenter.y,r=e.col1.x*n+e.col2.x*s;s=e.col1.y*n+e.col2.y*s,n=r,e=o.m_xf.R;var a=this.m_localAnchor2.x-o.m_sweep.localCenter.x,l=this.m_localAnchor2.y-o.m_sweep.localCenter.y;r=e.col1.x*a+e.col2.x*l,l=e.col1.y*a+e.col2.y*l,a=r;var h=i.m_linearVelocity.x+-i.m_angularVelocity*s,c=i.m_linearVelocity.y+i.m_angularVelocity*n,m=o.m_linearVelocity.x+-o.m_angularVelocity*l,u=o.m_linearVelocity.y+o.m_angularVelocity*a,y=this.m_u.x*(m-h)+this.m_u.y*(u-c),p=-this.m_mass*(y+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=p;var _=p*this.m_u.x,f=p*this.m_u.y;i.m_linearVelocity.x-=i.m_invMass*_,i.m_linearVelocity.y-=i.m_invMass*f,i.m_angularVelocity-=i.m_invI*(n*f-s*_),o.m_linearVelocity.x+=o.m_invMass*_,o.m_linearVelocity.y+=o.m_invMass*f,o.m_angularVelocity+=o.m_invI*(a*f-l*_)},r.prototype.SolvePositionConstraints=function(e){var i;if(this.m_frequencyHz>0)return!0;var n=this.m_bodyA,s=this.m_bodyB;i=n.m_xf.R;var r=this.m_localAnchor1.x-n.m_sweep.localCenter.x,a=this.m_localAnchor1.y-n.m_sweep.localCenter.y,l=i.col1.x*r+i.col2.x*a;a=i.col1.y*r+i.col2.y*a,r=l,i=s.m_xf.R;var h=this.m_localAnchor2.x-s.m_sweep.localCenter.x,c=this.m_localAnchor2.y-s.m_sweep.localCenter.y;l=i.col1.x*h+i.col2.x*c,c=i.col1.y*h+i.col2.y*c,h=l;var m=s.m_sweep.c.x+h-n.m_sweep.c.x-r,u=s.m_sweep.c.y+c-n.m_sweep.c.y-a,y=Math.sqrt(m*m+u*u);m/=y,u/=y;var p=y-this.m_length;p=o.Clamp(p,-t.b2_maxLinearCorrection,t.b2_maxLinearCorrection);var _=-this.m_mass*p;this.m_u.Set(m,u);var f=_*this.m_u.x,d=_*this.m_u.y;return n.m_sweep.c.x-=n.m_invMass*f,n.m_sweep.c.y-=n.m_invMass*d,n.m_sweep.a-=n.m_invI*(r*d-a*f),s.m_sweep.c.x+=s.m_invMass*f,s.m_sweep.c.y+=s.m_invMass*d,s.m_sweep.a+=s.m_invI*(h*d-c*f),n.SynchronizeTransform(),s.SynchronizeTransform(),o.Abs(p)<t.b2_linearSlop},dt.inherit(a,dt.Dynamics.Joints.b2JointDef),a.prototype.__super=dt.Dynamics.Joints.b2JointDef.prototype,a.b2DistanceJointDef=function(){dt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.localAnchorA=new n,this.localAnchorB=new n},a.prototype.b2DistanceJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_distanceJoint,this.length=1,this.frequencyHz=0,this.dampingRatio=0},a.prototype.Initialize=function(t,e,i,o){this.bodyA=t,this.bodyB=e,this.localAnchorA.SetV(this.bodyA.GetLocalPoint(i)),this.localAnchorB.SetV(this.bodyB.GetLocalPoint(o));var n=o.x-i.x,s=o.y-i.y;this.length=Math.sqrt(n*n+s*s),this.frequencyHz=0,this.dampingRatio=0},dt.inherit(l,dt.Dynamics.Joints.b2Joint),l.prototype.__super=dt.Dynamics.Joints.b2Joint.prototype,l.b2FrictionJoint=function(){dt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_localAnchorA=new n,this.m_localAnchorB=new n,this.m_linearMass=new e,this.m_linearImpulse=new n},l.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA)},l.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB)},l.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new n(t*this.m_linearImpulse.x,t*this.m_linearImpulse.y)},l.prototype.GetReactionTorque=function(t){return void 0===t&&(t=0),t*this.m_angularImpulse},l.prototype.SetMaxForce=function(t){void 0===t&&(t=0),this.m_maxForce=t},l.prototype.GetMaxForce=function(){return this.m_maxForce},l.prototype.SetMaxTorque=function(t){void 0===t&&(t=0),this.m_maxTorque=t},l.prototype.GetMaxTorque=function(){return this.m_maxTorque},l.prototype.b2FrictionJoint=function(t){this.__super.b2Joint.call(this,t),this.m_localAnchorA.SetV(t.localAnchorA),this.m_localAnchorB.SetV(t.localAnchorB),this.m_linearMass.SetZero(),this.m_angularMass=0,this.m_linearImpulse.SetZero(),this.m_angularImpulse=0,this.m_maxForce=t.maxForce,this.m_maxTorque=t.maxTorque},l.prototype.InitVelocityConstraints=function(t){var i,o=0,n=this.m_bodyA,s=this.m_bodyB;i=n.m_xf.R;var r=this.m_localAnchorA.x-n.m_sweep.localCenter.x,a=this.m_localAnchorA.y-n.m_sweep.localCenter.y;o=i.col1.x*r+i.col2.x*a,a=i.col1.y*r+i.col2.y*a,r=o,i=s.m_xf.R;var l=this.m_localAnchorB.x-s.m_sweep.localCenter.x,h=this.m_localAnchorB.y-s.m_sweep.localCenter.y;o=i.col1.x*l+i.col2.x*h,h=i.col1.y*l+i.col2.y*h,l=o;var c=n.m_invMass,m=s.m_invMass,u=n.m_invI,y=s.m_invI,p=new e;if(p.col1.x=c+m,p.col2.x=0,p.col1.y=0,p.col2.y=c+m,p.col1.x+=u*a*a,p.col2.x+=-u*r*a,p.col1.y+=-u*r*a,p.col2.y+=u*r*r,p.col1.x+=y*h*h,p.col2.x+=-y*l*h,p.col1.y+=-y*l*h,p.col2.y+=y*l*l,p.GetInverse(this.m_linearMass),this.m_angularMass=u+y,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),t.warmStarting){this.m_linearImpulse.x*=t.dtRatio,this.m_linearImpulse.y*=t.dtRatio,this.m_angularImpulse*=t.dtRatio;var _=this.m_linearImpulse;n.m_linearVelocity.x-=c*_.x,n.m_linearVelocity.y-=c*_.y,n.m_angularVelocity-=u*(r*_.y-a*_.x+this.m_angularImpulse),s.m_linearVelocity.x+=m*_.x,s.m_linearVelocity.y+=m*_.y,s.m_angularVelocity+=y*(l*_.y-h*_.x+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0},l.prototype.SolveVelocityConstraints=function(t){var e,i=0,s=this.m_bodyA,r=this.m_bodyB,a=s.m_linearVelocity,l=s.m_angularVelocity,h=r.m_linearVelocity,c=r.m_angularVelocity,m=s.m_invMass,u=r.m_invMass,y=s.m_invI,p=r.m_invI;e=s.m_xf.R;var _=this.m_localAnchorA.x-s.m_sweep.localCenter.x,f=this.m_localAnchorA.y-s.m_sweep.localCenter.y;i=e.col1.x*_+e.col2.x*f,f=e.col1.y*_+e.col2.y*f,_=i,e=r.m_xf.R;var d=this.m_localAnchorB.x-r.m_sweep.localCenter.x,v=this.m_localAnchorB.y-r.m_sweep.localCenter.y;i=e.col1.x*d+e.col2.x*v,v=e.col1.y*d+e.col2.y*v,d=i;var b=0,x=c-l,g=-this.m_angularMass*x,w=this.m_angularImpulse;b=t.dt*this.m_maxTorque,this.m_angularImpulse=o.Clamp(this.m_angularImpulse+g,-b,b),l-=y*(g=this.m_angularImpulse-w),c+=p*g;var C=h.x-c*v-a.x+l*f,S=h.y+c*d-a.y-l*_,A=o.MulMV(this.m_linearMass,new n(-C,-S)),M=this.m_linearImpulse.Copy();this.m_linearImpulse.Add(A),b=t.dt*this.m_maxForce,this.m_linearImpulse.LengthSquared()>b*b&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.Multiply(b)),A=o.SubtractVV(this.m_linearImpulse,M),a.x-=m*A.x,a.y-=m*A.y,l-=y*(_*A.y-f*A.x),h.x+=u*A.x,h.y+=u*A.y,c+=p*(d*A.y-v*A.x),s.m_angularVelocity=l,r.m_angularVelocity=c},l.prototype.SolvePositionConstraints=function(t){return!0},dt.inherit(h,dt.Dynamics.Joints.b2JointDef),h.prototype.__super=dt.Dynamics.Joints.b2JointDef.prototype,h.b2FrictionJointDef=function(){dt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.localAnchorA=new n,this.localAnchorB=new n},h.prototype.b2FrictionJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_frictionJoint,this.maxForce=0,this.maxTorque=0},h.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.localAnchorA.SetV(this.bodyA.GetLocalPoint(i)),this.localAnchorB.SetV(this.bodyB.GetLocalPoint(i))},dt.inherit(c,dt.Dynamics.Joints.b2Joint),c.prototype.__super=dt.Dynamics.Joints.b2Joint.prototype,c.b2GearJoint=function(){dt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_groundAnchor1=new n,this.m_groundAnchor2=new n,this.m_localAnchor1=new n,this.m_localAnchor2=new n,this.m_J=new u},c.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},c.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},c.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new n(t*this.m_impulse*this.m_J.linearB.x,t*this.m_impulse*this.m_J.linearB.y)},c.prototype.GetReactionTorque=function(t){void 0===t&&(t=0);var e=this.m_bodyB.m_xf.R,i=this.m_localAnchor1.x-this.m_bodyB.m_sweep.localCenter.x,o=this.m_localAnchor1.y-this.m_bodyB.m_sweep.localCenter.y,n=e.col1.x*i+e.col2.x*o;o=e.col1.y*i+e.col2.y*o,i=n;var s=this.m_impulse*this.m_J.linearB.x,r=this.m_impulse*this.m_J.linearB.y;return t*(this.m_impulse*this.m_J.angularB-i*r+o*s)},c.prototype.GetRatio=function(){return this.m_ratio},c.prototype.SetRatio=function(t){void 0===t&&(t=0),this.m_ratio=t},c.prototype.b2GearJoint=function(t){this.__super.b2Joint.call(this,t);var e=parseInt(t.joint1.m_type),i=parseInt(t.joint2.m_type);this.m_revolute1=null,this.m_prismatic1=null,this.m_revolute2=null,this.m_prismatic2=null;var o=0,n=0;this.m_ground1=t.joint1.GetBodyA(),this.m_bodyA=t.joint1.GetBodyB(),e==y.e_revoluteJoint?(this.m_revolute1=t.joint1 instanceof S?t.joint1:null,this.m_groundAnchor1.SetV(this.m_revolute1.m_localAnchor1),this.m_localAnchor1.SetV(this.m_revolute1.m_localAnchor2),o=this.m_revolute1.GetJointAngle()):(this.m_prismatic1=t.joint1 instanceof x?t.joint1:null,this.m_groundAnchor1.SetV(this.m_prismatic1.m_localAnchor1),this.m_localAnchor1.SetV(this.m_prismatic1.m_localAnchor2),o=this.m_prismatic1.GetJointTranslation()),this.m_ground2=t.joint2.GetBodyA(),this.m_bodyB=t.joint2.GetBodyB(),i==y.e_revoluteJoint?(this.m_revolute2=t.joint2 instanceof S?t.joint2:null,this.m_groundAnchor2.SetV(this.m_revolute2.m_localAnchor1),this.m_localAnchor2.SetV(this.m_revolute2.m_localAnchor2),n=this.m_revolute2.GetJointAngle()):(this.m_prismatic2=t.joint2 instanceof x?t.joint2:null,this.m_groundAnchor2.SetV(this.m_prismatic2.m_localAnchor1),this.m_localAnchor2.SetV(this.m_prismatic2.m_localAnchor2),n=this.m_prismatic2.GetJointTranslation()),this.m_ratio=t.ratio,this.m_constant=o+this.m_ratio*n,this.m_impulse=0},c.prototype.InitVelocityConstraints=function(t){var e,i,o=this.m_ground1,n=this.m_ground2,s=this.m_bodyA,r=this.m_bodyB,a=0,l=0,h=0,c=0,m=0,u=0,y=0;this.m_J.SetZero(),this.m_revolute1?(this.m_J.angularA=-1,y+=s.m_invI):(e=o.m_xf.R,i=this.m_prismatic1.m_localXAxis1,a=e.col1.x*i.x+e.col2.x*i.y,l=e.col1.y*i.x+e.col2.y*i.y,e=s.m_xf.R,h=this.m_localAnchor1.x-s.m_sweep.localCenter.x,c=this.m_localAnchor1.y-s.m_sweep.localCenter.y,u=e.col1.x*h+e.col2.x*c,c=e.col1.y*h+e.col2.y*c,m=(h=u)*l-c*a,this.m_J.linearA.Set(-a,-l),this.m_J.angularA=-m,y+=s.m_invMass+s.m_invI*m*m),this.m_revolute2?(this.m_J.angularB=-this.m_ratio,y+=this.m_ratio*this.m_ratio*r.m_invI):(e=n.m_xf.R,i=this.m_prismatic2.m_localXAxis1,a=e.col1.x*i.x+e.col2.x*i.y,l=e.col1.y*i.x+e.col2.y*i.y,e=r.m_xf.R,h=this.m_localAnchor2.x-r.m_sweep.localCenter.x,c=this.m_localAnchor2.y-r.m_sweep.localCenter.y,u=e.col1.x*h+e.col2.x*c,c=e.col1.y*h+e.col2.y*c,m=(h=u)*l-c*a,this.m_J.linearB.Set(-this.m_ratio*a,-this.m_ratio*l),this.m_J.angularB=-this.m_ratio*m,y+=this.m_ratio*this.m_ratio*(r.m_invMass+r.m_invI*m*m)),this.m_mass=y>0?1/y:0,t.warmStarting?(s.m_linearVelocity.x+=s.m_invMass*this.m_impulse*this.m_J.linearA.x,s.m_linearVelocity.y+=s.m_invMass*this.m_impulse*this.m_J.linearA.y,s.m_angularVelocity+=s.m_invI*this.m_impulse*this.m_J.angularA,r.m_linearVelocity.x+=r.m_invMass*this.m_impulse*this.m_J.linearB.x,r.m_linearVelocity.y+=r.m_invMass*this.m_impulse*this.m_J.linearB.y,r.m_angularVelocity+=r.m_invI*this.m_impulse*this.m_J.angularB):this.m_impulse=0},c.prototype.SolveVelocityConstraints=function(t){var e=this.m_bodyA,i=this.m_bodyB,o=this.m_J.Compute(e.m_linearVelocity,e.m_angularVelocity,i.m_linearVelocity,i.m_angularVelocity),n=-this.m_mass*o;this.m_impulse+=n,e.m_linearVelocity.x+=e.m_invMass*n*this.m_J.linearA.x,e.m_linearVelocity.y+=e.m_invMass*n*this.m_J.linearA.y,e.m_angularVelocity+=e.m_invI*n*this.m_J.angularA,i.m_linearVelocity.x+=i.m_invMass*n*this.m_J.linearB.x,i.m_linearVelocity.y+=i.m_invMass*n*this.m_J.linearB.y,i.m_angularVelocity+=i.m_invI*n*this.m_J.angularB},c.prototype.SolvePositionConstraints=function(e){var i,o,n=this.m_bodyA,s=this.m_bodyB;i=this.m_revolute1?this.m_revolute1.GetJointAngle():this.m_prismatic1.GetJointTranslation(),o=this.m_revolute2?this.m_revolute2.GetJointAngle():this.m_prismatic2.GetJointTranslation();var r=this.m_constant-(i+this.m_ratio*o),a=-this.m_mass*r;return n.m_sweep.c.x+=n.m_invMass*a*this.m_J.linearA.x,n.m_sweep.c.y+=n.m_invMass*a*this.m_J.linearA.y,n.m_sweep.a+=n.m_invI*a*this.m_J.angularA,s.m_sweep.c.x+=s.m_invMass*a*this.m_J.linearB.x,s.m_sweep.c.y+=s.m_invMass*a*this.m_J.linearB.y,s.m_sweep.a+=s.m_invI*a*this.m_J.angularB,n.SynchronizeTransform(),s.SynchronizeTransform(),0<t.b2_linearSlop},dt.inherit(m,dt.Dynamics.Joints.b2JointDef),m.prototype.__super=dt.Dynamics.Joints.b2JointDef.prototype,m.b2GearJointDef=function(){dt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments)},m.prototype.b2GearJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_gearJoint,this.joint1=null,this.joint2=null,this.ratio=1},u.b2Jacobian=function(){this.linearA=new n,this.linearB=new n},u.prototype.SetZero=function(){this.linearA.SetZero(),this.angularA=0,this.linearB.SetZero(),this.angularB=0},u.prototype.Set=function(t,e,i,o){void 0===e&&(e=0),void 0===o&&(o=0),this.linearA.SetV(t),this.angularA=e,this.linearB.SetV(i),this.angularB=o},u.prototype.Compute=function(t,e,i,o){return void 0===e&&(e=0),void 0===o&&(o=0),this.linearA.x*t.x+this.linearA.y*t.y+this.angularA*e+(this.linearB.x*i.x+this.linearB.y*i.y)+this.angularB*o},y.b2Joint=function(){this.m_edgeA=new _,this.m_edgeB=new _,this.m_localCenterA=new n,this.m_localCenterB=new n},y.prototype.GetType=function(){return this.m_type},y.prototype.GetAnchorA=function(){return null},y.prototype.GetAnchorB=function(){return null},y.prototype.GetReactionForce=function(t){return null},y.prototype.GetReactionTorque=function(t){return 0},y.prototype.GetBodyA=function(){return this.m_bodyA},y.prototype.GetBodyB=function(){return this.m_bodyB},y.prototype.GetNext=function(){return this.m_next},y.prototype.GetUserData=function(){return this.m_userData},y.prototype.SetUserData=function(t){this.m_userData=t},y.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()},y.Create=function(t,e){var i=null;switch(t.type){case y.e_distanceJoint:i=new r(t instanceof a?t:null);break;case y.e_mouseJoint:i=new v(t instanceof b?t:null);break;case y.e_prismaticJoint:i=new x(t instanceof g?t:null);break;case y.e_revoluteJoint:i=new S(t instanceof A?t:null);break;case y.e_pulleyJoint:i=new w(t instanceof C?t:null);break;case y.e_gearJoint:i=new c(t instanceof m?t:null);break;case y.e_lineJoint:i=new f(t instanceof d?t:null);break;case y.e_weldJoint:i=new M(t instanceof D?t:null);break;case y.e_frictionJoint:i=new l(t instanceof h?t:null)}return i},y.Destroy=function(t,e){},y.prototype.b2Joint=function(e){t.b2Assert(e.bodyA!=e.bodyB),this.m_type=e.type,this.m_prev=null,this.m_next=null,this.m_bodyA=e.bodyA,this.m_bodyB=e.bodyB,this.m_collideConnected=e.collideConnected,this.m_islandFlag=!1,this.m_userData=e.userData},y.prototype.InitVelocityConstraints=function(t){},y.prototype.SolveVelocityConstraints=function(t){},y.prototype.FinalizeVelocityConstraints=function(){},y.prototype.SolvePositionConstraints=function(t){return!1},dt.postDefs.push(function(){dt.Dynamics.Joints.b2Joint.e_unknownJoint=0,dt.Dynamics.Joints.b2Joint.e_revoluteJoint=1,dt.Dynamics.Joints.b2Joint.e_prismaticJoint=2,dt.Dynamics.Joints.b2Joint.e_distanceJoint=3,dt.Dynamics.Joints.b2Joint.e_pulleyJoint=4,dt.Dynamics.Joints.b2Joint.e_mouseJoint=5,dt.Dynamics.Joints.b2Joint.e_gearJoint=6,dt.Dynamics.Joints.b2Joint.e_lineJoint=7,dt.Dynamics.Joints.b2Joint.e_weldJoint=8,dt.Dynamics.Joints.b2Joint.e_frictionJoint=9,dt.Dynamics.Joints.b2Joint.e_inactiveLimit=0,dt.Dynamics.Joints.b2Joint.e_atLowerLimit=1,dt.Dynamics.Joints.b2Joint.e_atUpperLimit=2,dt.Dynamics.Joints.b2Joint.e_equalLimits=3}),p.b2JointDef=function(){},p.prototype.b2JointDef=function(){this.type=y.e_unknownJoint,this.userData=null,this.bodyA=null,this.bodyB=null,this.collideConnected=!1},_.b2JointEdge=function(){},dt.inherit(f,dt.Dynamics.Joints.b2Joint),f.prototype.__super=dt.Dynamics.Joints.b2Joint.prototype,f.b2LineJoint=function(){dt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_localAnchor1=new n,this.m_localAnchor2=new n,this.m_localXAxis1=new n,this.m_localYAxis1=new n,this.m_axis=new n,this.m_perp=new n,this.m_K=new e,this.m_impulse=new n},f.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},f.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},f.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new n(t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.x),t*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.y))},f.prototype.GetReactionTorque=function(t){return void 0===t&&(t=0),t*this.m_impulse.y},f.prototype.GetJointTranslation=function(){var t=this.m_bodyA,e=this.m_bodyB,i=t.GetWorldPoint(this.m_localAnchor1),o=e.GetWorldPoint(this.m_localAnchor2),n=o.x-i.x,s=o.y-i.y,r=t.GetWorldVector(this.m_localXAxis1);return r.x*n+r.y*s},f.prototype.GetJointSpeed=function(){var t,e=this.m_bodyA,i=this.m_bodyB;t=e.m_xf.R;var o=this.m_localAnchor1.x-e.m_sweep.localCenter.x,n=this.m_localAnchor1.y-e.m_sweep.localCenter.y,s=t.col1.x*o+t.col2.x*n;n=t.col1.y*o+t.col2.y*n,o=s,t=i.m_xf.R;var r=this.m_localAnchor2.x-i.m_sweep.localCenter.x,a=this.m_localAnchor2.y-i.m_sweep.localCenter.y;s=t.col1.x*r+t.col2.x*a,a=t.col1.y*r+t.col2.y*a,r=s;var l=e.m_sweep.c.x+o,h=e.m_sweep.c.y+n,c=i.m_sweep.c.x+r-l,m=i.m_sweep.c.y+a-h,u=e.GetWorldVector(this.m_localXAxis1),y=e.m_linearVelocity,p=i.m_linearVelocity,_=e.m_angularVelocity,f=i.m_angularVelocity;return c*(-_*u.y)+m*(_*u.x)+(u.x*(p.x+-f*a-y.x- -_*n)+u.y*(p.y+f*r-y.y-_*o))},f.prototype.IsLimitEnabled=function(){return this.m_enableLimit},f.prototype.EnableLimit=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t},f.prototype.GetLowerLimit=function(){return this.m_lowerTranslation},f.prototype.GetUpperLimit=function(){return this.m_upperTranslation},f.prototype.SetLimits=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e},f.prototype.IsMotorEnabled=function(){return this.m_enableMotor},f.prototype.EnableMotor=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t},f.prototype.SetMotorSpeed=function(t){void 0===t&&(t=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t},f.prototype.GetMotorSpeed=function(){return this.m_motorSpeed},f.prototype.SetMaxMotorForce=function(t){void 0===t&&(t=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t},f.prototype.GetMaxMotorForce=function(){return this.m_maxMotorForce},f.prototype.GetMotorForce=function(){return this.m_motorImpulse},f.prototype.b2LineJoint=function(t){this.__super.b2Joint.call(this,t),this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_localXAxis1.SetV(t.localAxisA),this.m_localYAxis1.x=-this.m_localXAxis1.y,this.m_localYAxis1.y=this.m_localXAxis1.x,this.m_impulse.SetZero(),this.m_motorMass=0,this.m_motorImpulse=0,this.m_lowerTranslation=t.lowerTranslation,this.m_upperTranslation=t.upperTranslation,this.m_maxMotorForce=t.maxMotorForce,this.m_motorSpeed=t.motorSpeed,this.m_enableLimit=t.enableLimit,this.m_enableMotor=t.enableMotor,this.m_limitState=y.e_inactiveLimit,this.m_axis.SetZero(),this.m_perp.SetZero()},f.prototype.InitVelocityConstraints=function(e){var i,n=this.m_bodyA,s=this.m_bodyB,r=0;this.m_localCenterA.SetV(n.GetLocalCenter()),this.m_localCenterB.SetV(s.GetLocalCenter());var a=n.GetTransform();s.GetTransform(),i=n.m_xf.R;var l=this.m_localAnchor1.x-this.m_localCenterA.x,h=this.m_localAnchor1.y-this.m_localCenterA.y;r=i.col1.x*l+i.col2.x*h,h=i.col1.y*l+i.col2.y*h,l=r,i=s.m_xf.R;var c=this.m_localAnchor2.x-this.m_localCenterB.x,m=this.m_localAnchor2.y-this.m_localCenterB.y;r=i.col1.x*c+i.col2.x*m,m=i.col1.y*c+i.col2.y*m,c=r;var u=s.m_sweep.c.x+c-n.m_sweep.c.x-l,p=s.m_sweep.c.y+m-n.m_sweep.c.y-h;this.m_invMassA=n.m_invMass,this.m_invMassB=s.m_invMass,this.m_invIA=n.m_invI,this.m_invIB=s.m_invI,this.m_axis.SetV(o.MulMV(a.R,this.m_localXAxis1)),this.m_a1=(u+l)*this.m_axis.y-(p+h)*this.m_axis.x,this.m_a2=c*this.m_axis.y-m*this.m_axis.x,this.m_motorMass=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_a1*this.m_a1+this.m_invIB*this.m_a2*this.m_a2,this.m_motorMass=this.m_motorMass>Number.MIN_VALUE?1/this.m_motorMass:0,this.m_perp.SetV(o.MulMV(a.R,this.m_localYAxis1)),this.m_s1=(u+l)*this.m_perp.y-(p+h)*this.m_perp.x,this.m_s2=c*this.m_perp.y-m*this.m_perp.x;var _=this.m_invMassA,f=this.m_invMassB,d=this.m_invIA,v=this.m_invIB;if(this.m_K.col1.x=_+f+d*this.m_s1*this.m_s1+v*this.m_s2*this.m_s2,this.m_K.col1.y=d*this.m_s1*this.m_a1+v*this.m_s2*this.m_a2,this.m_K.col2.x=this.m_K.col1.y,this.m_K.col2.y=_+f+d*this.m_a1*this.m_a1+v*this.m_a2*this.m_a2,this.m_enableLimit){var b=this.m_axis.x*u+this.m_axis.y*p;o.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*t.b2_linearSlop?this.m_limitState=y.e_equalLimits:b<=this.m_lowerTranslation?this.m_limitState!=y.e_atLowerLimit&&(this.m_limitState=y.e_atLowerLimit,this.m_impulse.y=0):b>=this.m_upperTranslation?this.m_limitState!=y.e_atUpperLimit&&(this.m_limitState=y.e_atUpperLimit,this.m_impulse.y=0):(this.m_limitState=y.e_inactiveLimit,this.m_impulse.y=0)}else this.m_limitState=y.e_inactiveLimit;if(0==this.m_enableMotor&&(this.m_motorImpulse=0),e.warmStarting){this.m_impulse.x*=e.dtRatio,this.m_impulse.y*=e.dtRatio,this.m_motorImpulse*=e.dtRatio;var x=this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.x,g=this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.y,w=this.m_impulse.x*this.m_s1+(this.m_motorImpulse+this.m_impulse.y)*this.m_a1,C=this.m_impulse.x*this.m_s2+(this.m_motorImpulse+this.m_impulse.y)*this.m_a2;n.m_linearVelocity.x-=this.m_invMassA*x,n.m_linearVelocity.y-=this.m_invMassA*g,n.m_angularVelocity-=this.m_invIA*w,s.m_linearVelocity.x+=this.m_invMassB*x,s.m_linearVelocity.y+=this.m_invMassB*g,s.m_angularVelocity+=this.m_invIB*C}else this.m_impulse.SetZero(),this.m_motorImpulse=0},f.prototype.SolveVelocityConstraints=function(t){var e=this.m_bodyA,i=this.m_bodyB,s=e.m_linearVelocity,r=e.m_angularVelocity,a=i.m_linearVelocity,l=i.m_angularVelocity,h=0,c=0,m=0,u=0;if(this.m_enableMotor&&this.m_limitState!=y.e_equalLimits){var p=this.m_axis.x*(a.x-s.x)+this.m_axis.y*(a.y-s.y)+this.m_a2*l-this.m_a1*r,_=this.m_motorMass*(this.m_motorSpeed-p),f=this.m_motorImpulse,d=t.dt*this.m_maxMotorForce;this.m_motorImpulse=o.Clamp(this.m_motorImpulse+_,-d,d),h=(_=this.m_motorImpulse-f)*this.m_axis.x,c=_*this.m_axis.y,m=_*this.m_a1,u=_*this.m_a2,s.x-=this.m_invMassA*h,s.y-=this.m_invMassA*c,r-=this.m_invIA*m,a.x+=this.m_invMassB*h,a.y+=this.m_invMassB*c,l+=this.m_invIB*u}var v=this.m_perp.x*(a.x-s.x)+this.m_perp.y*(a.y-s.y)+this.m_s2*l-this.m_s1*r;if(this.m_enableLimit&&this.m_limitState!=y.e_inactiveLimit){var b=this.m_axis.x*(a.x-s.x)+this.m_axis.y*(a.y-s.y)+this.m_a2*l-this.m_a1*r,x=this.m_impulse.Copy(),g=this.m_K.Solve(new n,-v,-b);this.m_impulse.Add(g),this.m_limitState==y.e_atLowerLimit?this.m_impulse.y=o.Max(this.m_impulse.y,0):this.m_limitState==y.e_atUpperLimit&&(this.m_impulse.y=o.Min(this.m_impulse.y,0));var w,C=-v-(this.m_impulse.y-x.y)*this.m_K.col2.x;w=0!=this.m_K.col1.x?C/this.m_K.col1.x+x.x:x.x,this.m_impulse.x=w,g.x=this.m_impulse.x-x.x,g.y=this.m_impulse.y-x.y,h=g.x*this.m_perp.x+g.y*this.m_axis.x,c=g.x*this.m_perp.y+g.y*this.m_axis.y,m=g.x*this.m_s1+g.y*this.m_a1,u=g.x*this.m_s2+g.y*this.m_a2,s.x-=this.m_invMassA*h,s.y-=this.m_invMassA*c,r-=this.m_invIA*m,a.x+=this.m_invMassB*h,a.y+=this.m_invMassB*c,l+=this.m_invIB*u}else{var S;S=0!=this.m_K.col1.x?-v/this.m_K.col1.x:0,this.m_impulse.x+=S,h=S*this.m_perp.x,c=S*this.m_perp.y,m=S*this.m_s1,u=S*this.m_s2,s.x-=this.m_invMassA*h,s.y-=this.m_invMassA*c,r-=this.m_invIA*m,a.x+=this.m_invMassB*h,a.y+=this.m_invMassB*c,l+=this.m_invIB*u}e.m_linearVelocity.SetV(s),e.m_angularVelocity=r,i.m_linearVelocity.SetV(a),i.m_angularVelocity=l},f.prototype.SolvePositionConstraints=function(i){var s,r=this.m_bodyA,a=this.m_bodyB,l=r.m_sweep.c,h=r.m_sweep.a,c=a.m_sweep.c,m=a.m_sweep.a,u=0,y=0,p=0,_=0,f=0,d=0,v=!1,b=0,x=e.FromAngle(h),g=e.FromAngle(m);s=x;var w=this.m_localAnchor1.x-this.m_localCenterA.x,C=this.m_localAnchor1.y-this.m_localCenterA.y;u=s.col1.x*w+s.col2.x*C,C=s.col1.y*w+s.col2.y*C,w=u,s=g;var S=this.m_localAnchor2.x-this.m_localCenterB.x,A=this.m_localAnchor2.y-this.m_localCenterB.y;u=s.col1.x*S+s.col2.x*A,A=s.col1.y*S+s.col2.y*A,S=u;var M=c.x+S-l.x-w,D=c.y+A-l.y-C;if(this.m_enableLimit){this.m_axis=o.MulMV(x,this.m_localXAxis1),this.m_a1=(M+w)*this.m_axis.y-(D+C)*this.m_axis.x,this.m_a2=S*this.m_axis.y-A*this.m_axis.x;var B=this.m_axis.x*M+this.m_axis.y*D;o.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*t.b2_linearSlop?(b=o.Clamp(B,-t.b2_maxLinearCorrection,t.b2_maxLinearCorrection),d=o.Abs(B),v=!0):B<=this.m_lowerTranslation?(b=o.Clamp(B-this.m_lowerTranslation+t.b2_linearSlop,-t.b2_maxLinearCorrection,0),d=this.m_lowerTranslation-B,v=!0):B>=this.m_upperTranslation&&(b=o.Clamp(B-this.m_upperTranslation+t.b2_linearSlop,0,t.b2_maxLinearCorrection),d=B-this.m_upperTranslation,v=!0)}this.m_perp=o.MulMV(x,this.m_localYAxis1),this.m_s1=(M+w)*this.m_perp.y-(D+C)*this.m_perp.x,this.m_s2=S*this.m_perp.y-A*this.m_perp.x;var I=new n,V=this.m_perp.x*M+this.m_perp.y*D;if(d=o.Max(d,o.Abs(V)),v)y=this.m_invMassA,p=this.m_invMassB,_=this.m_invIA,f=this.m_invIB,this.m_K.col1.x=y+p+_*this.m_s1*this.m_s1+f*this.m_s2*this.m_s2,this.m_K.col1.y=_*this.m_s1*this.m_a1+f*this.m_s2*this.m_a2,this.m_K.col2.x=this.m_K.col1.y,this.m_K.col2.y=y+p+_*this.m_a1*this.m_a1+f*this.m_a2*this.m_a2,this.m_K.Solve(I,-V,-b);else{y=this.m_invMassA,p=this.m_invMassB,_=this.m_invIA,f=this.m_invIB;var k,P=y+p+_*this.m_s1*this.m_s1+f*this.m_s2*this.m_s2;k=0!=P?-V/P:0,I.x=k,I.y=0}var T=I.x*this.m_perp.x+I.y*this.m_axis.x,G=I.x*this.m_perp.y+I.y*this.m_axis.y,L=I.x*this.m_s1+I.y*this.m_a1,E=I.x*this.m_s2+I.y*this.m_a2;return l.x-=this.m_invMassA*T,l.y-=this.m_invMassA*G,h-=this.m_invIA*L,c.x+=this.m_invMassB*T,c.y+=this.m_invMassB*G,m+=this.m_invIB*E,r.m_sweep.a=h,a.m_sweep.a=m,r.SynchronizeTransform(),a.SynchronizeTransform(),d<=t.b2_linearSlop&&0<=t.b2_angularSlop},dt.inherit(d,dt.Dynamics.Joints.b2JointDef),d.prototype.__super=dt.Dynamics.Joints.b2JointDef.prototype,d.b2LineJointDef=function(){dt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.localAnchorA=new n,this.localAnchorB=new n,this.localAxisA=new n},d.prototype.b2LineJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_lineJoint,this.localAxisA.Set(1,0),this.enableLimit=!1,this.lowerTranslation=0,this.upperTranslation=0,this.enableMotor=!1,this.maxMotorForce=0,this.motorSpeed=0},d.prototype.Initialize=function(t,e,i,o){this.bodyA=t,this.bodyB=e,this.localAnchorA=this.bodyA.GetLocalPoint(i),this.localAnchorB=this.bodyB.GetLocalPoint(i),this.localAxisA=this.bodyA.GetLocalVector(o)},dt.inherit(v,dt.Dynamics.Joints.b2Joint),v.prototype.__super=dt.Dynamics.Joints.b2Joint.prototype,v.b2MouseJoint=function(){dt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.K=new e,this.K1=new e,this.K2=new e,this.m_localAnchor=new n,this.m_target=new n,this.m_impulse=new n,this.m_mass=new e,this.m_C=new n},v.prototype.GetAnchorA=function(){return this.m_target},v.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor)},v.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new n(t*this.m_impulse.x,t*this.m_impulse.y)},v.prototype.GetReactionTorque=function(t){return 0},v.prototype.GetTarget=function(){return this.m_target},v.prototype.SetTarget=function(t){0==this.m_bodyB.IsAwake()&&this.m_bodyB.SetAwake(!0),this.m_target=t},v.prototype.GetMaxForce=function(){return this.m_maxForce},v.prototype.SetMaxForce=function(t){void 0===t&&(t=0),this.m_maxForce=t},v.prototype.GetFrequency=function(){return this.m_frequencyHz},v.prototype.SetFrequency=function(t){void 0===t&&(t=0),this.m_frequencyHz=t},v.prototype.GetDampingRatio=function(){return this.m_dampingRatio},v.prototype.SetDampingRatio=function(t){void 0===t&&(t=0),this.m_dampingRatio=t},v.prototype.b2MouseJoint=function(t){this.__super.b2Joint.call(this,t),this.m_target.SetV(t.target);var e=this.m_target.x-this.m_bodyB.m_xf.position.x,i=this.m_target.y-this.m_bodyB.m_xf.position.y,o=this.m_bodyB.m_xf.R;this.m_localAnchor.x=e*o.col1.x+i*o.col1.y,this.m_localAnchor.y=e*o.col2.x+i*o.col2.y,this.m_maxForce=t.maxForce,this.m_impulse.SetZero(),this.m_frequencyHz=t.frequencyHz,this.m_dampingRatio=t.dampingRatio,this.m_beta=0,this.m_gamma=0},v.prototype.InitVelocityConstraints=function(t){var e,i=this.m_bodyB,o=i.GetMass(),n=2*Math.PI*this.m_frequencyHz,s=2*o*this.m_dampingRatio*n,r=o*n*n;this.m_gamma=t.dt*(s+t.dt*r),this.m_gamma=0!=this.m_gamma?1/this.m_gamma:0,this.m_beta=t.dt*r*this.m_gamma,e=i.m_xf.R;var a=this.m_localAnchor.x-i.m_sweep.localCenter.x,l=this.m_localAnchor.y-i.m_sweep.localCenter.y,h=e.col1.x*a+e.col2.x*l;l=e.col1.y*a+e.col2.y*l,a=h;var c=i.m_invMass,m=i.m_invI;this.K1.col1.x=c,this.K1.col2.x=0,this.K1.col1.y=0,this.K1.col2.y=c,this.K2.col1.x=m*l*l,this.K2.col2.x=-m*a*l,this.K2.col1.y=-m*a*l,this.K2.col2.y=m*a*a,this.K.SetM(this.K1),this.K.AddM(this.K2),this.K.col1.x+=this.m_gamma,this.K.col2.y+=this.m_gamma,this.K.GetInverse(this.m_mass),this.m_C.x=i.m_sweep.c.x+a-this.m_target.x,this.m_C.y=i.m_sweep.c.y+l-this.m_target.y,i.m_angularVelocity*=.98,this.m_impulse.x*=t.dtRatio,this.m_impulse.y*=t.dtRatio,i.m_linearVelocity.x+=c*this.m_impulse.x,i.m_linearVelocity.y+=c*this.m_impulse.y,i.m_angularVelocity+=m*(a*this.m_impulse.y-l*this.m_impulse.x)},v.prototype.SolveVelocityConstraints=function(t){var e,i,o=this.m_bodyB,n=0;e=o.m_xf.R;var s=this.m_localAnchor.x-o.m_sweep.localCenter.x,r=this.m_localAnchor.y-o.m_sweep.localCenter.y;n=e.col1.x*s+e.col2.x*r,r=e.col1.y*s+e.col2.y*r,s=n;var a=o.m_linearVelocity.x+-o.m_angularVelocity*r,l=o.m_linearVelocity.y+o.m_angularVelocity*s;e=this.m_mass,n=a+this.m_beta*this.m_C.x+this.m_gamma*this.m_impulse.x,i=l+this.m_beta*this.m_C.y+this.m_gamma*this.m_impulse.y;var h=-(e.col1.x*n+e.col2.x*i),c=-(e.col1.y*n+e.col2.y*i),m=this.m_impulse.x,u=this.m_impulse.y;this.m_impulse.x+=h,this.m_impulse.y+=c;var y=t.dt*this.m_maxForce;this.m_impulse.LengthSquared()>y*y&&this.m_impulse.Multiply(y/this.m_impulse.Length()),h=this.m_impulse.x-m,c=this.m_impulse.y-u,o.m_linearVelocity.x+=o.m_invMass*h,o.m_linearVelocity.y+=o.m_invMass*c,o.m_angularVelocity+=o.m_invI*(s*c-r*h)},v.prototype.SolvePositionConstraints=function(t){return!0},dt.inherit(b,dt.Dynamics.Joints.b2JointDef),b.prototype.__super=dt.Dynamics.Joints.b2JointDef.prototype,b.b2MouseJointDef=function(){dt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.target=new n},b.prototype.b2MouseJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_mouseJoint,this.maxForce=0,this.frequencyHz=5,this.dampingRatio=.7},dt.inherit(x,dt.Dynamics.Joints.b2Joint),x.prototype.__super=dt.Dynamics.Joints.b2Joint.prototype,x.b2PrismaticJoint=function(){dt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_localAnchor1=new n,this.m_localAnchor2=new n,this.m_localXAxis1=new n,this.m_localYAxis1=new n,this.m_axis=new n,this.m_perp=new n,this.m_K=new i,this.m_impulse=new s},x.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},x.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},x.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new n(t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x),t*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y))},x.prototype.GetReactionTorque=function(t){return void 0===t&&(t=0),t*this.m_impulse.y},x.prototype.GetJointTranslation=function(){var t=this.m_bodyA,e=this.m_bodyB,i=t.GetWorldPoint(this.m_localAnchor1),o=e.GetWorldPoint(this.m_localAnchor2),n=o.x-i.x,s=o.y-i.y,r=t.GetWorldVector(this.m_localXAxis1);return r.x*n+r.y*s},x.prototype.GetJointSpeed=function(){var t,e=this.m_bodyA,i=this.m_bodyB;t=e.m_xf.R;var o=this.m_localAnchor1.x-e.m_sweep.localCenter.x,n=this.m_localAnchor1.y-e.m_sweep.localCenter.y,s=t.col1.x*o+t.col2.x*n;n=t.col1.y*o+t.col2.y*n,o=s,t=i.m_xf.R;var r=this.m_localAnchor2.x-i.m_sweep.localCenter.x,a=this.m_localAnchor2.y-i.m_sweep.localCenter.y;s=t.col1.x*r+t.col2.x*a,a=t.col1.y*r+t.col2.y*a,r=s;var l=e.m_sweep.c.x+o,h=e.m_sweep.c.y+n,c=i.m_sweep.c.x+r-l,m=i.m_sweep.c.y+a-h,u=e.GetWorldVector(this.m_localXAxis1),y=e.m_linearVelocity,p=i.m_linearVelocity,_=e.m_angularVelocity,f=i.m_angularVelocity;return c*(-_*u.y)+m*(_*u.x)+(u.x*(p.x+-f*a-y.x- -_*n)+u.y*(p.y+f*r-y.y-_*o))},x.prototype.IsLimitEnabled=function(){return this.m_enableLimit},x.prototype.EnableLimit=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t},x.prototype.GetLowerLimit=function(){return this.m_lowerTranslation},x.prototype.GetUpperLimit=function(){return this.m_upperTranslation},x.prototype.SetLimits=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e},x.prototype.IsMotorEnabled=function(){return this.m_enableMotor},x.prototype.EnableMotor=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t},x.prototype.SetMotorSpeed=function(t){void 0===t&&(t=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t},x.prototype.GetMotorSpeed=function(){return this.m_motorSpeed},x.prototype.SetMaxMotorForce=function(t){void 0===t&&(t=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t},x.prototype.GetMotorForce=function(){return this.m_motorImpulse},x.prototype.b2PrismaticJoint=function(t){this.__super.b2Joint.call(this,t),this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_localXAxis1.SetV(t.localAxisA),this.m_localYAxis1.x=-this.m_localXAxis1.y,this.m_localYAxis1.y=this.m_localXAxis1.x,this.m_refAngle=t.referenceAngle,this.m_impulse.SetZero(),this.m_motorMass=0,this.m_motorImpulse=0,this.m_lowerTranslation=t.lowerTranslation,this.m_upperTranslation=t.upperTranslation,this.m_maxMotorForce=t.maxMotorForce,this.m_motorSpeed=t.motorSpeed,this.m_enableLimit=t.enableLimit,this.m_enableMotor=t.enableMotor,this.m_limitState=y.e_inactiveLimit,this.m_axis.SetZero(),this.m_perp.SetZero()},x.prototype.InitVelocityConstraints=function(e){var i,n=this.m_bodyA,s=this.m_bodyB,r=0;this.m_localCenterA.SetV(n.GetLocalCenter()),this.m_localCenterB.SetV(s.GetLocalCenter());var a=n.GetTransform();s.GetTransform(),i=n.m_xf.R;var l=this.m_localAnchor1.x-this.m_localCenterA.x,h=this.m_localAnchor1.y-this.m_localCenterA.y;r=i.col1.x*l+i.col2.x*h,h=i.col1.y*l+i.col2.y*h,l=r,i=s.m_xf.R;var c=this.m_localAnchor2.x-this.m_localCenterB.x,m=this.m_localAnchor2.y-this.m_localCenterB.y;r=i.col1.x*c+i.col2.x*m,m=i.col1.y*c+i.col2.y*m,c=r;var u=s.m_sweep.c.x+c-n.m_sweep.c.x-l,p=s.m_sweep.c.y+m-n.m_sweep.c.y-h;this.m_invMassA=n.m_invMass,this.m_invMassB=s.m_invMass,this.m_invIA=n.m_invI,this.m_invIB=s.m_invI,this.m_axis.SetV(o.MulMV(a.R,this.m_localXAxis1)),this.m_a1=(u+l)*this.m_axis.y-(p+h)*this.m_axis.x,this.m_a2=c*this.m_axis.y-m*this.m_axis.x,this.m_motorMass=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_a1*this.m_a1+this.m_invIB*this.m_a2*this.m_a2,this.m_motorMass>Number.MIN_VALUE&&(this.m_motorMass=1/this.m_motorMass),this.m_perp.SetV(o.MulMV(a.R,this.m_localYAxis1)),this.m_s1=(u+l)*this.m_perp.y-(p+h)*this.m_perp.x,this.m_s2=c*this.m_perp.y-m*this.m_perp.x;var _=this.m_invMassA,f=this.m_invMassB,d=this.m_invIA,v=this.m_invIB;if(this.m_K.col1.x=_+f+d*this.m_s1*this.m_s1+v*this.m_s2*this.m_s2,this.m_K.col1.y=d*this.m_s1+v*this.m_s2,this.m_K.col1.z=d*this.m_s1*this.m_a1+v*this.m_s2*this.m_a2,this.m_K.col2.x=this.m_K.col1.y,this.m_K.col2.y=d+v,this.m_K.col2.z=d*this.m_a1+v*this.m_a2,this.m_K.col3.x=this.m_K.col1.z,this.m_K.col3.y=this.m_K.col2.z,this.m_K.col3.z=_+f+d*this.m_a1*this.m_a1+v*this.m_a2*this.m_a2,this.m_enableLimit){var b=this.m_axis.x*u+this.m_axis.y*p;o.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*t.b2_linearSlop?this.m_limitState=y.e_equalLimits:b<=this.m_lowerTranslation?this.m_limitState!=y.e_atLowerLimit&&(this.m_limitState=y.e_atLowerLimit,this.m_impulse.z=0):b>=this.m_upperTranslation?this.m_limitState!=y.e_atUpperLimit&&(this.m_limitState=y.e_atUpperLimit,this.m_impulse.z=0):(this.m_limitState=y.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=y.e_inactiveLimit;if(0==this.m_enableMotor&&(this.m_motorImpulse=0),e.warmStarting){this.m_impulse.x*=e.dtRatio,this.m_impulse.y*=e.dtRatio,this.m_motorImpulse*=e.dtRatio;var x=this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x,g=this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y,w=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,C=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;n.m_linearVelocity.x-=this.m_invMassA*x,n.m_linearVelocity.y-=this.m_invMassA*g,n.m_angularVelocity-=this.m_invIA*w,s.m_linearVelocity.x+=this.m_invMassB*x,s.m_linearVelocity.y+=this.m_invMassB*g,s.m_angularVelocity+=this.m_invIB*C}else this.m_impulse.SetZero(),this.m_motorImpulse=0},x.prototype.SolveVelocityConstraints=function(t){var e=this.m_bodyA,i=this.m_bodyB,r=e.m_linearVelocity,a=e.m_angularVelocity,l=i.m_linearVelocity,h=i.m_angularVelocity,c=0,m=0,u=0,p=0;if(this.m_enableMotor&&this.m_limitState!=y.e_equalLimits){var _=this.m_axis.x*(l.x-r.x)+this.m_axis.y*(l.y-r.y)+this.m_a2*h-this.m_a1*a,f=this.m_motorMass*(this.m_motorSpeed-_),d=this.m_motorImpulse,v=t.dt*this.m_maxMotorForce;this.m_motorImpulse=o.Clamp(this.m_motorImpulse+f,-v,v),c=(f=this.m_motorImpulse-d)*this.m_axis.x,m=f*this.m_axis.y,u=f*this.m_a1,p=f*this.m_a2,r.x-=this.m_invMassA*c,r.y-=this.m_invMassA*m,a-=this.m_invIA*u,l.x+=this.m_invMassB*c,l.y+=this.m_invMassB*m,h+=this.m_invIB*p}var b=this.m_perp.x*(l.x-r.x)+this.m_perp.y*(l.y-r.y)+this.m_s2*h-this.m_s1*a,x=h-a;if(this.m_enableLimit&&this.m_limitState!=y.e_inactiveLimit){var g=this.m_axis.x*(l.x-r.x)+this.m_axis.y*(l.y-r.y)+this.m_a2*h-this.m_a1*a,w=this.m_impulse.Copy(),C=this.m_K.Solve33(new s,-b,-x,-g);this.m_impulse.Add(C),this.m_limitState==y.e_atLowerLimit?this.m_impulse.z=o.Max(this.m_impulse.z,0):this.m_limitState==y.e_atUpperLimit&&(this.m_impulse.z=o.Min(this.m_impulse.z,0));var S=-b-(this.m_impulse.z-w.z)*this.m_K.col3.x,A=-x-(this.m_impulse.z-w.z)*this.m_K.col3.y,M=this.m_K.Solve22(new n,S,A);M.x+=w.x,M.y+=w.y,this.m_impulse.x=M.x,this.m_impulse.y=M.y,C.x=this.m_impulse.x-w.x,C.y=this.m_impulse.y-w.y,C.z=this.m_impulse.z-w.z,c=C.x*this.m_perp.x+C.z*this.m_axis.x,m=C.x*this.m_perp.y+C.z*this.m_axis.y,u=C.x*this.m_s1+C.y+C.z*this.m_a1,p=C.x*this.m_s2+C.y+C.z*this.m_a2,r.x-=this.m_invMassA*c,r.y-=this.m_invMassA*m,a-=this.m_invIA*u,l.x+=this.m_invMassB*c,l.y+=this.m_invMassB*m,h+=this.m_invIB*p}else{var D=this.m_K.Solve22(new n,-b,-x);this.m_impulse.x+=D.x,this.m_impulse.y+=D.y,c=D.x*this.m_perp.x,m=D.x*this.m_perp.y,u=D.x*this.m_s1+D.y,p=D.x*this.m_s2+D.y,r.x-=this.m_invMassA*c,r.y-=this.m_invMassA*m,a-=this.m_invIA*u,l.x+=this.m_invMassB*c,l.y+=this.m_invMassB*m,h+=this.m_invIB*p}e.m_linearVelocity.SetV(r),e.m_angularVelocity=a,i.m_linearVelocity.SetV(l),i.m_angularVelocity=h},x.prototype.SolvePositionConstraints=function(i){var r,a,l=this.m_bodyA,h=this.m_bodyB,c=l.m_sweep.c,m=l.m_sweep.a,u=h.m_sweep.c,y=h.m_sweep.a,p=0,_=0,f=0,d=0,v=0,b=0,x=!1,g=0,w=e.FromAngle(m),C=e.FromAngle(y);r=w;var S=this.m_localAnchor1.x-this.m_localCenterA.x,A=this.m_localAnchor1.y-this.m_localCenterA.y;p=r.col1.x*S+r.col2.x*A,A=r.col1.y*S+r.col2.y*A,S=p,r=C;var M=this.m_localAnchor2.x-this.m_localCenterB.x,D=this.m_localAnchor2.y-this.m_localCenterB.y;p=r.col1.x*M+r.col2.x*D,D=r.col1.y*M+r.col2.y*D,M=p;var B=u.x+M-c.x-S,I=u.y+D-c.y-A;if(this.m_enableLimit){this.m_axis=o.MulMV(w,this.m_localXAxis1),this.m_a1=(B+S)*this.m_axis.y-(I+A)*this.m_axis.x,this.m_a2=M*this.m_axis.y-D*this.m_axis.x;var V=this.m_axis.x*B+this.m_axis.y*I;o.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*t.b2_linearSlop?(g=o.Clamp(V,-t.b2_maxLinearCorrection,t.b2_maxLinearCorrection),b=o.Abs(V),x=!0):V<=this.m_lowerTranslation?(g=o.Clamp(V-this.m_lowerTranslation+t.b2_linearSlop,-t.b2_maxLinearCorrection,0),b=this.m_lowerTranslation-V,x=!0):V>=this.m_upperTranslation&&(g=o.Clamp(V-this.m_upperTranslation+t.b2_linearSlop,0,t.b2_maxLinearCorrection),b=V-this.m_upperTranslation,x=!0)}this.m_perp=o.MulMV(w,this.m_localYAxis1),this.m_s1=(B+S)*this.m_perp.y-(I+A)*this.m_perp.x,this.m_s2=M*this.m_perp.y-D*this.m_perp.x;var k=new s,P=this.m_perp.x*B+this.m_perp.y*I,T=y-m-this.m_refAngle;if(b=o.Max(b,o.Abs(P)),a=o.Abs(T),x)_=this.m_invMassA,f=this.m_invMassB,d=this.m_invIA,v=this.m_invIB,this.m_K.col1.x=_+f+d*this.m_s1*this.m_s1+v*this.m_s2*this.m_s2,this.m_K.col1.y=d*this.m_s1+v*this.m_s2,this.m_K.col1.z=d*this.m_s1*this.m_a1+v*this.m_s2*this.m_a2,this.m_K.col2.x=this.m_K.col1.y,this.m_K.col2.y=d+v,this.m_K.col2.z=d*this.m_a1+v*this.m_a2,this.m_K.col3.x=this.m_K.col1.z,this.m_K.col3.y=this.m_K.col2.z,this.m_K.col3.z=_+f+d*this.m_a1*this.m_a1+v*this.m_a2*this.m_a2,this.m_K.Solve33(k,-P,-T,-g);else{_=this.m_invMassA,f=this.m_invMassB,d=this.m_invIA,v=this.m_invIB;var G=_+f+d*this.m_s1*this.m_s1+v*this.m_s2*this.m_s2,L=d*this.m_s1+v*this.m_s2,E=d+v;this.m_K.col1.Set(G,L,0),this.m_K.col2.Set(L,E,0);var F=this.m_K.Solve22(new n,-P,-T);k.x=F.x,k.y=F.y,k.z=0}var R=k.x*this.m_perp.x+k.z*this.m_axis.x,J=k.x*this.m_perp.y+k.z*this.m_axis.y,O=k.x*this.m_s1+k.y+k.z*this.m_a1,z=k.x*this.m_s2+k.y+k.z*this.m_a2;return c.x-=this.m_invMassA*R,c.y-=this.m_invMassA*J,m-=this.m_invIA*O,u.x+=this.m_invMassB*R,u.y+=this.m_invMassB*J,y+=this.m_invIB*z,l.m_sweep.a=m,h.m_sweep.a=y,l.SynchronizeTransform(),h.SynchronizeTransform(),b<=t.b2_linearSlop&&a<=t.b2_angularSlop},dt.inherit(g,dt.Dynamics.Joints.b2JointDef),g.prototype.__super=dt.Dynamics.Joints.b2JointDef.prototype,g.b2PrismaticJointDef=function(){dt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.localAnchorA=new n,this.localAnchorB=new n,this.localAxisA=new n},g.prototype.b2PrismaticJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_prismaticJoint,this.localAxisA.Set(1,0),this.referenceAngle=0,this.enableLimit=!1,this.lowerTranslation=0,this.upperTranslation=0,this.enableMotor=!1,this.maxMotorForce=0,this.motorSpeed=0},g.prototype.Initialize=function(t,e,i,o){this.bodyA=t,this.bodyB=e,this.localAnchorA=this.bodyA.GetLocalPoint(i),this.localAnchorB=this.bodyB.GetLocalPoint(i),this.localAxisA=this.bodyA.GetLocalVector(o),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},dt.inherit(w,dt.Dynamics.Joints.b2Joint),w.prototype.__super=dt.Dynamics.Joints.b2Joint.prototype,w.b2PulleyJoint=function(){dt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_groundAnchor1=new n,this.m_groundAnchor2=new n,this.m_localAnchor1=new n,this.m_localAnchor2=new n,this.m_u1=new n,this.m_u2=new n},w.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},w.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},w.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new n(t*this.m_impulse*this.m_u2.x,t*this.m_impulse*this.m_u2.y)},w.prototype.GetReactionTorque=function(t){return 0},w.prototype.GetGroundAnchorA=function(){var t=this.m_ground.m_xf.position.Copy();return t.Add(this.m_groundAnchor1),t},w.prototype.GetGroundAnchorB=function(){var t=this.m_ground.m_xf.position.Copy();return t.Add(this.m_groundAnchor2),t},w.prototype.GetLength1=function(){var t=this.m_bodyA.GetWorldPoint(this.m_localAnchor1),e=this.m_ground.m_xf.position.x+this.m_groundAnchor1.x,i=this.m_ground.m_xf.position.y+this.m_groundAnchor1.y,o=t.x-e,n=t.y-i;return Math.sqrt(o*o+n*n)},w.prototype.GetLength2=function(){var t=this.m_bodyB.GetWorldPoint(this.m_localAnchor2),e=this.m_ground.m_xf.position.x+this.m_groundAnchor2.x,i=this.m_ground.m_xf.position.y+this.m_groundAnchor2.y,o=t.x-e,n=t.y-i;return Math.sqrt(o*o+n*n)},w.prototype.GetRatio=function(){return this.m_ratio},w.prototype.b2PulleyJoint=function(t){this.__super.b2Joint.call(this,t),this.m_ground=this.m_bodyA.m_world.m_groundBody,this.m_groundAnchor1.x=t.groundAnchorA.x-this.m_ground.m_xf.position.x,this.m_groundAnchor1.y=t.groundAnchorA.y-this.m_ground.m_xf.position.y,this.m_groundAnchor2.x=t.groundAnchorB.x-this.m_ground.m_xf.position.x,this.m_groundAnchor2.y=t.groundAnchorB.y-this.m_ground.m_xf.position.y,this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_ratio=t.ratio,this.m_constant=t.lengthA+this.m_ratio*t.lengthB,this.m_maxLength1=o.Min(t.maxLengthA,this.m_constant-this.m_ratio*w.b2_minPulleyLength),this.m_maxLength2=o.Min(t.maxLengthB,(this.m_constant-w.b2_minPulleyLength)/this.m_ratio),this.m_impulse=0,this.m_limitImpulse1=0,this.m_limitImpulse2=0},w.prototype.InitVelocityConstraints=function(e){var i,o=this.m_bodyA,n=this.m_bodyB;i=o.m_xf.R;var s=this.m_localAnchor1.x-o.m_sweep.localCenter.x,r=this.m_localAnchor1.y-o.m_sweep.localCenter.y,a=i.col1.x*s+i.col2.x*r;r=i.col1.y*s+i.col2.y*r,s=a,i=n.m_xf.R;var l=this.m_localAnchor2.x-n.m_sweep.localCenter.x,h=this.m_localAnchor2.y-n.m_sweep.localCenter.y;a=i.col1.x*l+i.col2.x*h,h=i.col1.y*l+i.col2.y*h,l=a;var c=o.m_sweep.c.x+s,m=o.m_sweep.c.y+r,u=n.m_sweep.c.x+l,p=n.m_sweep.c.y+h,_=this.m_ground.m_xf.position.x+this.m_groundAnchor1.x,f=this.m_ground.m_xf.position.y+this.m_groundAnchor1.y,d=this.m_ground.m_xf.position.x+this.m_groundAnchor2.x,v=this.m_ground.m_xf.position.y+this.m_groundAnchor2.y;this.m_u1.Set(c-_,m-f),this.m_u2.Set(u-d,p-v);var b=this.m_u1.Length(),x=this.m_u2.Length();b>t.b2_linearSlop?this.m_u1.Multiply(1/b):this.m_u1.SetZero(),x>t.b2_linearSlop?this.m_u2.Multiply(1/x):this.m_u2.SetZero(),this.m_constant-b-this.m_ratio*x>0?(this.m_state=y.e_inactiveLimit,this.m_impulse=0):this.m_state=y.e_atUpperLimit,b<this.m_maxLength1?(this.m_limitState1=y.e_inactiveLimit,this.m_limitImpulse1=0):this.m_limitState1=y.e_atUpperLimit,x<this.m_maxLength2?(this.m_limitState2=y.e_inactiveLimit,this.m_limitImpulse2=0):this.m_limitState2=y.e_atUpperLimit;var g=s*this.m_u1.y-r*this.m_u1.x,w=l*this.m_u2.y-h*this.m_u2.x;if(this.m_limitMass1=o.m_invMass+o.m_invI*g*g,this.m_limitMass2=n.m_invMass+n.m_invI*w*w,this.m_pulleyMass=this.m_limitMass1+this.m_ratio*this.m_ratio*this.m_limitMass2,this.m_limitMass1=1/this.m_limitMass1,this.m_limitMass2=1/this.m_limitMass2,this.m_pulleyMass=1/this.m_pulleyMass,e.warmStarting){this.m_impulse*=e.dtRatio,this.m_limitImpulse1*=e.dtRatio,this.m_limitImpulse2*=e.dtRatio;var C=(-this.m_impulse-this.m_limitImpulse1)*this.m_u1.x,S=(-this.m_impulse-this.m_limitImpulse1)*this.m_u1.y,A=(-this.m_ratio*this.m_impulse-this.m_limitImpulse2)*this.m_u2.x,M=(-this.m_ratio*this.m_impulse-this.m_limitImpulse2)*this.m_u2.y;o.m_linearVelocity.x+=o.m_invMass*C,o.m_linearVelocity.y+=o.m_invMass*S,o.m_angularVelocity+=o.m_invI*(s*S-r*C),n.m_linearVelocity.x+=n.m_invMass*A,n.m_linearVelocity.y+=n.m_invMass*M,n.m_angularVelocity+=n.m_invI*(l*M-h*A)}else this.m_impulse=0,this.m_limitImpulse1=0,this.m_limitImpulse2=0},w.prototype.SolveVelocityConstraints=function(t){var e,i=this.m_bodyA,n=this.m_bodyB;e=i.m_xf.R;var s=this.m_localAnchor1.x-i.m_sweep.localCenter.x,r=this.m_localAnchor1.y-i.m_sweep.localCenter.y,a=e.col1.x*s+e.col2.x*r;r=e.col1.y*s+e.col2.y*r,s=a,e=n.m_xf.R;var l=this.m_localAnchor2.x-n.m_sweep.localCenter.x,h=this.m_localAnchor2.y-n.m_sweep.localCenter.y;a=e.col1.x*l+e.col2.x*h,h=e.col1.y*l+e.col2.y*h,l=a;var c=0,m=0,u=0,p=0,_=0,f=0,d=0,v=0,b=0,x=0,g=0;this.m_state==y.e_atUpperLimit&&(c=i.m_linearVelocity.x+-i.m_angularVelocity*r,m=i.m_linearVelocity.y+i.m_angularVelocity*s,u=n.m_linearVelocity.x+-n.m_angularVelocity*h,p=n.m_linearVelocity.y+n.m_angularVelocity*l,b=-(this.m_u1.x*c+this.m_u1.y*m)-this.m_ratio*(this.m_u2.x*u+this.m_u2.y*p),x=this.m_pulleyMass*-b,g=this.m_impulse,this.m_impulse=o.Max(0,this.m_impulse+x),_=-(x=this.m_impulse-g)*this.m_u1.x,f=-x*this.m_u1.y,d=-this.m_ratio*x*this.m_u2.x,v=-this.m_ratio*x*this.m_u2.y,i.m_linearVelocity.x+=i.m_invMass*_,i.m_linearVelocity.y+=i.m_invMass*f,i.m_angularVelocity+=i.m_invI*(s*f-r*_),n.m_linearVelocity.x+=n.m_invMass*d,n.m_linearVelocity.y+=n.m_invMass*v,n.m_angularVelocity+=n.m_invI*(l*v-h*d)),this.m_limitState1==y.e_atUpperLimit&&(c=i.m_linearVelocity.x+-i.m_angularVelocity*r,m=i.m_linearVelocity.y+i.m_angularVelocity*s,b=-(this.m_u1.x*c+this.m_u1.y*m),x=-this.m_limitMass1*b,g=this.m_limitImpulse1,this.m_limitImpulse1=o.Max(0,this.m_limitImpulse1+x),_=-(x=this.m_limitImpulse1-g)*this.m_u1.x,f=-x*this.m_u1.y,i.m_linearVelocity.x+=i.m_invMass*_,i.m_linearVelocity.y+=i.m_invMass*f,i.m_angularVelocity+=i.m_invI*(s*f-r*_)),this.m_limitState2==y.e_atUpperLimit&&(u=n.m_linearVelocity.x+-n.m_angularVelocity*h,p=n.m_linearVelocity.y+n.m_angularVelocity*l,b=-(this.m_u2.x*u+this.m_u2.y*p),x=-this.m_limitMass2*b,g=this.m_limitImpulse2,this.m_limitImpulse2=o.Max(0,this.m_limitImpulse2+x),d=-(x=this.m_limitImpulse2-g)*this.m_u2.x,v=-x*this.m_u2.y,n.m_linearVelocity.x+=n.m_invMass*d,n.m_linearVelocity.y+=n.m_invMass*v,n.m_angularVelocity+=n.m_invI*(l*v-h*d))},w.prototype.SolvePositionConstraints=function(e){var i,n=this.m_bodyA,s=this.m_bodyB,r=this.m_ground.m_xf.position.x+this.m_groundAnchor1.x,a=this.m_ground.m_xf.position.y+this.m_groundAnchor1.y,l=this.m_ground.m_xf.position.x+this.m_groundAnchor2.x,h=this.m_ground.m_xf.position.y+this.m_groundAnchor2.y,c=0,m=0,u=0,p=0,_=0,f=0,d=0,v=0,b=0,x=0,g=0,w=0,C=0,S=0;return this.m_state==y.e_atUpperLimit&&(i=n.m_xf.R,c=this.m_localAnchor1.x-n.m_sweep.localCenter.x,m=this.m_localAnchor1.y-n.m_sweep.localCenter.y,C=i.col1.x*c+i.col2.x*m,m=i.col1.y*c+i.col2.y*m,c=C,i=s.m_xf.R,u=this.m_localAnchor2.x-s.m_sweep.localCenter.x,p=this.m_localAnchor2.y-s.m_sweep.localCenter.y,C=i.col1.x*u+i.col2.x*p,p=i.col1.y*u+i.col2.y*p,u=C,_=n.m_sweep.c.x+c,f=n.m_sweep.c.y+m,d=s.m_sweep.c.x+u,v=s.m_sweep.c.y+p,this.m_u1.Set(_-r,f-a),this.m_u2.Set(d-l,v-h),b=this.m_u1.Length(),x=this.m_u2.Length(),b>t.b2_linearSlop?this.m_u1.Multiply(1/b):this.m_u1.SetZero(),x>t.b2_linearSlop?this.m_u2.Multiply(1/x):this.m_u2.SetZero(),g=this.m_constant-b-this.m_ratio*x,S=o.Max(S,-g),g=o.Clamp(g+t.b2_linearSlop,-t.b2_maxLinearCorrection,0),_=-(w=-this.m_pulleyMass*g)*this.m_u1.x,f=-w*this.m_u1.y,d=-this.m_ratio*w*this.m_u2.x,v=-this.m_ratio*w*this.m_u2.y,n.m_sweep.c.x+=n.m_invMass*_,n.m_sweep.c.y+=n.m_invMass*f,n.m_sweep.a+=n.m_invI*(c*f-m*_),s.m_sweep.c.x+=s.m_invMass*d,s.m_sweep.c.y+=s.m_invMass*v,s.m_sweep.a+=s.m_invI*(u*v-p*d),n.SynchronizeTransform(),s.SynchronizeTransform()),this.m_limitState1==y.e_atUpperLimit&&(i=n.m_xf.R,c=this.m_localAnchor1.x-n.m_sweep.localCenter.x,m=this.m_localAnchor1.y-n.m_sweep.localCenter.y,C=i.col1.x*c+i.col2.x*m,m=i.col1.y*c+i.col2.y*m,c=C,_=n.m_sweep.c.x+c,f=n.m_sweep.c.y+m,this.m_u1.Set(_-r,f-a),(b=this.m_u1.Length())>t.b2_linearSlop?(this.m_u1.x*=1/b,this.m_u1.y*=1/b):this.m_u1.SetZero(),g=this.m_maxLength1-b,S=o.Max(S,-g),g=o.Clamp(g+t.b2_linearSlop,-t.b2_maxLinearCorrection,0),_=-(w=-this.m_limitMass1*g)*this.m_u1.x,f=-w*this.m_u1.y,n.m_sweep.c.x+=n.m_invMass*_,n.m_sweep.c.y+=n.m_invMass*f,n.m_sweep.a+=n.m_invI*(c*f-m*_),n.SynchronizeTransform()),this.m_limitState2==y.e_atUpperLimit&&(i=s.m_xf.R,u=this.m_localAnchor2.x-s.m_sweep.localCenter.x,p=this.m_localAnchor2.y-s.m_sweep.localCenter.y,C=i.col1.x*u+i.col2.x*p,p=i.col1.y*u+i.col2.y*p,u=C,d=s.m_sweep.c.x+u,v=s.m_sweep.c.y+p,this.m_u2.Set(d-l,v-h),(x=this.m_u2.Length())>t.b2_linearSlop?(this.m_u2.x*=1/x,this.m_u2.y*=1/x):this.m_u2.SetZero(),g=this.m_maxLength2-x,S=o.Max(S,-g),g=o.Clamp(g+t.b2_linearSlop,-t.b2_maxLinearCorrection,0),d=-(w=-this.m_limitMass2*g)*this.m_u2.x,v=-w*this.m_u2.y,s.m_sweep.c.x+=s.m_invMass*d,s.m_sweep.c.y+=s.m_invMass*v,s.m_sweep.a+=s.m_invI*(u*v-p*d),s.SynchronizeTransform()),S<t.b2_linearSlop},dt.postDefs.push(function(){dt.Dynamics.Joints.b2PulleyJoint.b2_minPulleyLength=2}),dt.inherit(C,dt.Dynamics.Joints.b2JointDef),C.prototype.__super=dt.Dynamics.Joints.b2JointDef.prototype,C.b2PulleyJointDef=function(){dt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.groundAnchorA=new n,this.groundAnchorB=new n,this.localAnchorA=new n,this.localAnchorB=new n},C.prototype.b2PulleyJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_pulleyJoint,this.groundAnchorA.Set(-1,1),this.groundAnchorB.Set(1,1),this.localAnchorA.Set(-1,0),this.localAnchorB.Set(1,0),this.lengthA=0,this.maxLengthA=0,this.lengthB=0,this.maxLengthB=0,this.ratio=1,this.collideConnected=!0},C.prototype.Initialize=function(t,e,i,o,n,s,r){void 0===r&&(r=0),this.bodyA=t,this.bodyB=e,this.groundAnchorA.SetV(i),this.groundAnchorB.SetV(o),this.localAnchorA=this.bodyA.GetLocalPoint(n),this.localAnchorB=this.bodyB.GetLocalPoint(s);var a=n.x-i.x,l=n.y-i.y;this.lengthA=Math.sqrt(a*a+l*l);var h=s.x-o.x,c=s.y-o.y;this.lengthB=Math.sqrt(h*h+c*c),this.ratio=r;var m=this.lengthA+this.ratio*this.lengthB;this.maxLengthA=m-this.ratio*w.b2_minPulleyLength,this.maxLengthB=(m-w.b2_minPulleyLength)/this.ratio},dt.inherit(S,dt.Dynamics.Joints.b2Joint),S.prototype.__super=dt.Dynamics.Joints.b2Joint.prototype,S.b2RevoluteJoint=function(){dt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.K=new e,this.K1=new e,this.K2=new e,this.K3=new e,this.impulse3=new s,this.impulse2=new n,this.reduced=new n,this.m_localAnchor1=new n,this.m_localAnchor2=new n,this.m_impulse=new s,this.m_mass=new i},S.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},S.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},S.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new n(t*this.m_impulse.x,t*this.m_impulse.y)},S.prototype.GetReactionTorque=function(t){return void 0===t&&(t=0),t*this.m_impulse.z},S.prototype.GetJointAngle=function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle},S.prototype.GetJointSpeed=function(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity},S.prototype.IsLimitEnabled=function(){return this.m_enableLimit},S.prototype.EnableLimit=function(t){this.m_enableLimit=t},S.prototype.GetLowerLimit=function(){return this.m_lowerAngle},S.prototype.GetUpperLimit=function(){return this.m_upperAngle},S.prototype.SetLimits=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.m_lowerAngle=t,this.m_upperAngle=e},S.prototype.IsMotorEnabled=function(){return this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor},S.prototype.EnableMotor=function(t){this.m_enableMotor=t},S.prototype.SetMotorSpeed=function(t){void 0===t&&(t=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t},S.prototype.GetMotorSpeed=function(){return this.m_motorSpeed},S.prototype.SetMaxMotorTorque=function(t){void 0===t&&(t=0),this.m_maxMotorTorque=t},S.prototype.GetMotorTorque=function(){return this.m_maxMotorTorque},S.prototype.b2RevoluteJoint=function(t){this.__super.b2Joint.call(this,t),this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_referenceAngle=t.referenceAngle,this.m_impulse.SetZero(),this.m_motorImpulse=0,this.m_lowerAngle=t.lowerAngle,this.m_upperAngle=t.upperAngle,this.m_maxMotorTorque=t.maxMotorTorque,this.m_motorSpeed=t.motorSpeed,this.m_enableLimit=t.enableLimit,this.m_enableMotor=t.enableMotor,this.m_limitState=y.e_inactiveLimit},S.prototype.InitVelocityConstraints=function(e){var i,n=this.m_bodyA,s=this.m_bodyB,r=0;this.m_enableMotor||this.m_enableLimit,i=n.m_xf.R;var a=this.m_localAnchor1.x-n.m_sweep.localCenter.x,l=this.m_localAnchor1.y-n.m_sweep.localCenter.y;r=i.col1.x*a+i.col2.x*l,l=i.col1.y*a+i.col2.y*l,a=r,i=s.m_xf.R;var h=this.m_localAnchor2.x-s.m_sweep.localCenter.x,c=this.m_localAnchor2.y-s.m_sweep.localCenter.y;r=i.col1.x*h+i.col2.x*c,c=i.col1.y*h+i.col2.y*c,h=r;var m=n.m_invMass,u=s.m_invMass,p=n.m_invI,_=s.m_invI;if(this.m_mass.col1.x=m+u+l*l*p+c*c*_,this.m_mass.col2.x=-l*a*p-c*h*_,this.m_mass.col3.x=-l*p-c*_,this.m_mass.col1.y=this.m_mass.col2.x,this.m_mass.col2.y=m+u+a*a*p+h*h*_,this.m_mass.col3.y=a*p+h*_,this.m_mass.col1.z=this.m_mass.col3.x,this.m_mass.col2.z=this.m_mass.col3.y,this.m_mass.col3.z=p+_,this.m_motorMass=1/(p+_),0==this.m_enableMotor&&(this.m_motorImpulse=0),this.m_enableLimit){var f=s.m_sweep.a-n.m_sweep.a-this.m_referenceAngle;o.Abs(this.m_upperAngle-this.m_lowerAngle)<2*t.b2_angularSlop?this.m_limitState=y.e_equalLimits:f<=this.m_lowerAngle?(this.m_limitState!=y.e_atLowerLimit&&(this.m_impulse.z=0),this.m_limitState=y.e_atLowerLimit):f>=this.m_upperAngle?(this.m_limitState!=y.e_atUpperLimit&&(this.m_impulse.z=0),this.m_limitState=y.e_atUpperLimit):(this.m_limitState=y.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=y.e_inactiveLimit;if(e.warmStarting){this.m_impulse.x*=e.dtRatio,this.m_impulse.y*=e.dtRatio,this.m_motorImpulse*=e.dtRatio;var d=this.m_impulse.x,v=this.m_impulse.y;n.m_linearVelocity.x-=m*d,n.m_linearVelocity.y-=m*v,n.m_angularVelocity-=p*(a*v-l*d+this.m_motorImpulse+this.m_impulse.z),s.m_linearVelocity.x+=u*d,s.m_linearVelocity.y+=u*v,s.m_angularVelocity+=_*(h*v-c*d+this.m_motorImpulse+this.m_impulse.z)}else this.m_impulse.SetZero(),this.m_motorImpulse=0},S.prototype.SolveVelocityConstraints=function(t){var e,i=this.m_bodyA,n=this.m_bodyB,s=0,r=0,a=0,l=0,h=0,c=i.m_linearVelocity,m=i.m_angularVelocity,u=n.m_linearVelocity,p=n.m_angularVelocity,_=i.m_invMass,f=n.m_invMass,d=i.m_invI,v=n.m_invI;if(this.m_enableMotor&&this.m_limitState!=y.e_equalLimits){var b=p-m-this.m_motorSpeed,x=this.m_motorMass*-b,g=this.m_motorImpulse,w=t.dt*this.m_maxMotorTorque;this.m_motorImpulse=o.Clamp(this.m_motorImpulse+x,-w,w),m-=d*(x=this.m_motorImpulse-g),p+=v*x}if(this.m_enableLimit&&this.m_limitState!=y.e_inactiveLimit){e=i.m_xf.R,r=this.m_localAnchor1.x-i.m_sweep.localCenter.x,a=this.m_localAnchor1.y-i.m_sweep.localCenter.y,s=e.col1.x*r+e.col2.x*a,a=e.col1.y*r+e.col2.y*a,r=s,e=n.m_xf.R,l=this.m_localAnchor2.x-n.m_sweep.localCenter.x,h=this.m_localAnchor2.y-n.m_sweep.localCenter.y,s=e.col1.x*l+e.col2.x*h,h=e.col1.y*l+e.col2.y*h,l=s;var C=u.x+-p*h-c.x- -m*a,S=u.y+p*l-c.y-m*r,A=p-m;this.m_mass.Solve33(this.impulse3,-C,-S,-A),this.m_limitState==y.e_equalLimits?this.m_impulse.Add(this.impulse3):this.m_limitState==y.e_atLowerLimit?this.m_impulse.z+this.impulse3.z<0&&(this.m_mass.Solve22(this.reduced,-C,-S),this.impulse3.x=this.reduced.x,this.impulse3.y=this.reduced.y,this.impulse3.z=-this.m_impulse.z,this.m_impulse.x+=this.reduced.x,this.m_impulse.y+=this.reduced.y,this.m_impulse.z=0):this.m_limitState==y.e_atUpperLimit&&this.m_impulse.z+this.impulse3.z>0&&(this.m_mass.Solve22(this.reduced,-C,-S),this.impulse3.x=this.reduced.x,this.impulse3.y=this.reduced.y,this.impulse3.z=-this.m_impulse.z,this.m_impulse.x+=this.reduced.x,this.m_impulse.y+=this.reduced.y,this.m_impulse.z=0),c.x-=_*this.impulse3.x,c.y-=_*this.impulse3.y,m-=d*(r*this.impulse3.y-a*this.impulse3.x+this.impulse3.z),u.x+=f*this.impulse3.x,u.y+=f*this.impulse3.y,p+=v*(l*this.impulse3.y-h*this.impulse3.x+this.impulse3.z)}else{e=i.m_xf.R,r=this.m_localAnchor1.x-i.m_sweep.localCenter.x,a=this.m_localAnchor1.y-i.m_sweep.localCenter.y,s=e.col1.x*r+e.col2.x*a,a=e.col1.y*r+e.col2.y*a,r=s,e=n.m_xf.R,l=this.m_localAnchor2.x-n.m_sweep.localCenter.x,h=this.m_localAnchor2.y-n.m_sweep.localCenter.y,s=e.col1.x*l+e.col2.x*h,h=e.col1.y*l+e.col2.y*h,l=s;var M=u.x+-p*h-c.x- -m*a,D=u.y+p*l-c.y-m*r;this.m_mass.Solve22(this.impulse2,-M,-D),this.m_impulse.x+=this.impulse2.x,this.m_impulse.y+=this.impulse2.y,c.x-=_*this.impulse2.x,c.y-=_*this.impulse2.y,m-=d*(r*this.impulse2.y-a*this.impulse2.x),u.x+=f*this.impulse2.x,u.y+=f*this.impulse2.y,p+=v*(l*this.impulse2.y-h*this.impulse2.x)}i.m_linearVelocity.SetV(c),i.m_angularVelocity=m,n.m_linearVelocity.SetV(u),n.m_angularVelocity=p},S.prototype.SolvePositionConstraints=function(e){var i,n,s=0,r=this.m_bodyA,a=this.m_bodyB,l=0,h=0,c=0,m=0;if(this.m_enableLimit&&this.m_limitState!=y.e_inactiveLimit){var u=a.m_sweep.a-r.m_sweep.a-this.m_referenceAngle,p=0;this.m_limitState==y.e_equalLimits?(s=o.Clamp(u-this.m_lowerAngle,-t.b2_maxAngularCorrection,t.b2_maxAngularCorrection),p=-this.m_motorMass*s,l=o.Abs(s)):this.m_limitState==y.e_atLowerLimit?(l=-(s=u-this.m_lowerAngle),s=o.Clamp(s+t.b2_angularSlop,-t.b2_maxAngularCorrection,0),p=-this.m_motorMass*s):this.m_limitState==y.e_atUpperLimit&&(l=s=u-this.m_upperAngle,s=o.Clamp(s-t.b2_angularSlop,0,t.b2_maxAngularCorrection),p=-this.m_motorMass*s),r.m_sweep.a-=r.m_invI*p,a.m_sweep.a+=a.m_invI*p,r.SynchronizeTransform(),a.SynchronizeTransform()}i=r.m_xf.R;var _=this.m_localAnchor1.x-r.m_sweep.localCenter.x,f=this.m_localAnchor1.y-r.m_sweep.localCenter.y;h=i.col1.x*_+i.col2.x*f,f=i.col1.y*_+i.col2.y*f,_=h,i=a.m_xf.R;var d=this.m_localAnchor2.x-a.m_sweep.localCenter.x,v=this.m_localAnchor2.y-a.m_sweep.localCenter.y;h=i.col1.x*d+i.col2.x*v,v=i.col1.y*d+i.col2.y*v,d=h;var b=a.m_sweep.c.x+d-r.m_sweep.c.x-_,x=a.m_sweep.c.y+v-r.m_sweep.c.y-f,g=b*b+x*x;n=Math.sqrt(g);var w=r.m_invMass,C=a.m_invMass,A=r.m_invI,M=a.m_invI,D=10*t.b2_linearSlop;if(g>D*D){var B=1/(w+C);c=B*-b,m=B*-x;var I=.5;r.m_sweep.c.x-=I*w*c,r.m_sweep.c.y-=I*w*m,a.m_sweep.c.x+=I*C*c,a.m_sweep.c.y+=I*C*m,b=a.m_sweep.c.x+d-r.m_sweep.c.x-_,x=a.m_sweep.c.y+v-r.m_sweep.c.y-f}return this.K1.col1.x=w+C,this.K1.col2.x=0,this.K1.col1.y=0,this.K1.col2.y=w+C,this.K2.col1.x=A*f*f,this.K2.col2.x=-A*_*f,this.K2.col1.y=-A*_*f,this.K2.col2.y=A*_*_,this.K3.col1.x=M*v*v,this.K3.col2.x=-M*d*v,this.K3.col1.y=-M*d*v,this.K3.col2.y=M*d*d,this.K.SetM(this.K1),this.K.AddM(this.K2),this.K.AddM(this.K3),this.K.Solve(S.tImpulse,-b,-x),c=S.tImpulse.x,m=S.tImpulse.y,r.m_sweep.c.x-=r.m_invMass*c,r.m_sweep.c.y-=r.m_invMass*m,r.m_sweep.a-=r.m_invI*(_*m-f*c),a.m_sweep.c.x+=a.m_invMass*c,a.m_sweep.c.y+=a.m_invMass*m,a.m_sweep.a+=a.m_invI*(d*m-v*c),r.SynchronizeTransform(),a.SynchronizeTransform(),n<=t.b2_linearSlop&&l<=t.b2_angularSlop},dt.postDefs.push(function(){dt.Dynamics.Joints.b2RevoluteJoint.tImpulse=new n}),dt.inherit(A,dt.Dynamics.Joints.b2JointDef),A.prototype.__super=dt.Dynamics.Joints.b2JointDef.prototype,A.b2RevoluteJointDef=function(){dt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.localAnchorA=new n,this.localAnchorB=new n},A.prototype.b2RevoluteJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_revoluteJoint,this.localAnchorA.Set(0,0),this.localAnchorB.Set(0,0),this.referenceAngle=0,this.lowerAngle=0,this.upperAngle=0,this.maxMotorTorque=0,this.motorSpeed=0,this.enableLimit=!1,this.enableMotor=!1},A.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.localAnchorA=this.bodyA.GetLocalPoint(i),this.localAnchorB=this.bodyB.GetLocalPoint(i),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},dt.inherit(M,dt.Dynamics.Joints.b2Joint),M.prototype.__super=dt.Dynamics.Joints.b2Joint.prototype,M.b2WeldJoint=function(){dt.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_localAnchorA=new n,this.m_localAnchorB=new n,this.m_impulse=new s,this.m_mass=new i},M.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA)},M.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB)},M.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new n(t*this.m_impulse.x,t*this.m_impulse.y)},M.prototype.GetReactionTorque=function(t){return void 0===t&&(t=0),t*this.m_impulse.z},M.prototype.b2WeldJoint=function(t){this.__super.b2Joint.call(this,t),this.m_localAnchorA.SetV(t.localAnchorA),this.m_localAnchorB.SetV(t.localAnchorB),this.m_referenceAngle=t.referenceAngle,this.m_impulse.SetZero(),this.m_mass=new i},M.prototype.InitVelocityConstraints=function(t){var e,i=0,o=this.m_bodyA,n=this.m_bodyB;e=o.m_xf.R;var s=this.m_localAnchorA.x-o.m_sweep.localCenter.x,r=this.m_localAnchorA.y-o.m_sweep.localCenter.y;i=e.col1.x*s+e.col2.x*r,r=e.col1.y*s+e.col2.y*r,s=i,e=n.m_xf.R;var a=this.m_localAnchorB.x-n.m_sweep.localCenter.x,l=this.m_localAnchorB.y-n.m_sweep.localCenter.y;i=e.col1.x*a+e.col2.x*l,l=e.col1.y*a+e.col2.y*l,a=i;var h=o.m_invMass,c=n.m_invMass,m=o.m_invI,u=n.m_invI;this.m_mass.col1.x=h+c+r*r*m+l*l*u,this.m_mass.col2.x=-r*s*m-l*a*u,this.m_mass.col3.x=-r*m-l*u,this.m_mass.col1.y=this.m_mass.col2.x,this.m_mass.col2.y=h+c+s*s*m+a*a*u,this.m_mass.col3.y=s*m+a*u,this.m_mass.col1.z=this.m_mass.col3.x,this.m_mass.col2.z=this.m_mass.col3.y,this.m_mass.col3.z=m+u,t.warmStarting?(this.m_impulse.x*=t.dtRatio,this.m_impulse.y*=t.dtRatio,this.m_impulse.z*=t.dtRatio,o.m_linearVelocity.x-=h*this.m_impulse.x,o.m_linearVelocity.y-=h*this.m_impulse.y,o.m_angularVelocity-=m*(s*this.m_impulse.y-r*this.m_impulse.x+this.m_impulse.z),n.m_linearVelocity.x+=c*this.m_impulse.x,n.m_linearVelocity.y+=c*this.m_impulse.y,n.m_angularVelocity+=u*(a*this.m_impulse.y-l*this.m_impulse.x+this.m_impulse.z)):this.m_impulse.SetZero()},M.prototype.SolveVelocityConstraints=function(t){var e,i=0,o=this.m_bodyA,n=this.m_bodyB,r=o.m_linearVelocity,a=o.m_angularVelocity,l=n.m_linearVelocity,h=n.m_angularVelocity,c=o.m_invMass,m=n.m_invMass,u=o.m_invI,y=n.m_invI;e=o.m_xf.R;var p=this.m_localAnchorA.x-o.m_sweep.localCenter.x,_=this.m_localAnchorA.y-o.m_sweep.localCenter.y;i=e.col1.x*p+e.col2.x*_,_=e.col1.y*p+e.col2.y*_,p=i,e=n.m_xf.R;var f=this.m_localAnchorB.x-n.m_sweep.localCenter.x,d=this.m_localAnchorB.y-n.m_sweep.localCenter.y;i=e.col1.x*f+e.col2.x*d,d=e.col1.y*f+e.col2.y*d,f=i;var v=l.x-h*d-r.x+a*_,b=l.y+h*f-r.y-a*p,x=h-a,g=new s;this.m_mass.Solve33(g,-v,-b,-x),this.m_impulse.Add(g),r.x-=c*g.x,r.y-=c*g.y,a-=u*(p*g.y-_*g.x+g.z),l.x+=m*g.x,l.y+=m*g.y,h+=y*(f*g.y-d*g.x+g.z),o.m_angularVelocity=a,n.m_angularVelocity=h},M.prototype.SolvePositionConstraints=function(e){var i,n=0,r=this.m_bodyA,a=this.m_bodyB;i=r.m_xf.R;var l=this.m_localAnchorA.x-r.m_sweep.localCenter.x,h=this.m_localAnchorA.y-r.m_sweep.localCenter.y;n=i.col1.x*l+i.col2.x*h,h=i.col1.y*l+i.col2.y*h,l=n,i=a.m_xf.R;var c=this.m_localAnchorB.x-a.m_sweep.localCenter.x,m=this.m_localAnchorB.y-a.m_sweep.localCenter.y;n=i.col1.x*c+i.col2.x*m,m=i.col1.y*c+i.col2.y*m,c=n;var u=r.m_invMass,y=a.m_invMass,p=r.m_invI,_=a.m_invI,f=a.m_sweep.c.x+c-r.m_sweep.c.x-l,d=a.m_sweep.c.y+m-r.m_sweep.c.y-h,v=a.m_sweep.a-r.m_sweep.a-this.m_referenceAngle,b=10*t.b2_linearSlop,x=Math.sqrt(f*f+d*d),g=o.Abs(v);x>b&&(p*=1,_*=1),this.m_mass.col1.x=u+y+h*h*p+m*m*_,this.m_mass.col2.x=-h*l*p-m*c*_,this.m_mass.col3.x=-h*p-m*_,this.m_mass.col1.y=this.m_mass.col2.x,this.m_mass.col2.y=u+y+l*l*p+c*c*_,this.m_mass.col3.y=l*p+c*_,this.m_mass.col1.z=this.m_mass.col3.x,this.m_mass.col2.z=this.m_mass.col3.y,this.m_mass.col3.z=p+_;var w=new s;return this.m_mass.Solve33(w,-f,-d,-v),r.m_sweep.c.x-=u*w.x,r.m_sweep.c.y-=u*w.y,r.m_sweep.a-=p*(l*w.y-h*w.x+w.z),a.m_sweep.c.x+=y*w.x,a.m_sweep.c.y+=y*w.y,a.m_sweep.a+=_*(c*w.y-m*w.x+w.z),r.SynchronizeTransform(),a.SynchronizeTransform(),x<=t.b2_linearSlop&&g<=t.b2_angularSlop},dt.inherit(D,dt.Dynamics.Joints.b2JointDef),D.prototype.__super=dt.Dynamics.Joints.b2JointDef.prototype,D.b2WeldJointDef=function(){dt.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.localAnchorA=new n,this.localAnchorB=new n},D.prototype.b2WeldJointDef=function(){this.__super.b2JointDef.call(this),this.type=y.e_weldJoint,this.referenceAngle=0},D.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.localAnchorA.SetV(this.bodyA.GetLocalPoint(i)),this.localAnchorB.SetV(this.bodyB.GetLocalPoint(i)),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}(),(vt=dt.Dynamics.b2DebugDraw).b2DebugDraw=function(){this.m_drawScale=1,this.m_lineThickness=1,this.m_alpha=1,this.m_fillAlpha=1,this.m_xformScale=1;var t=this;this.m_sprite={graphics:{clear:function(){t.m_ctx.clearRect(0,0,t.m_ctx.canvas.width,t.m_ctx.canvas.height)}}}},vt.prototype._color=function(t,e){return"rgba("+((16711680&t)>>16)+","+((65280&t)>>8)+","+(255&t)+","+e+")"},vt.prototype.b2DebugDraw=function(){this.m_drawFlags=0},vt.prototype.SetFlags=function(t){void 0===t&&(t=0),this.m_drawFlags=t},vt.prototype.GetFlags=function(){return this.m_drawFlags},vt.prototype.AppendFlags=function(t){void 0===t&&(t=0),this.m_drawFlags|=t},vt.prototype.ClearFlags=function(t){void 0===t&&(t=0),this.m_drawFlags&=~t},vt.prototype.SetSprite=function(t){this.m_ctx=t},vt.prototype.GetSprite=function(){return this.m_ctx},vt.prototype.SetDrawScale=function(t){void 0===t&&(t=0),this.m_drawScale=t},vt.prototype.GetDrawScale=function(){return this.m_drawScale},vt.prototype.SetLineThickness=function(t){void 0===t&&(t=0),this.m_lineThickness=t,this.m_ctx.strokeWidth=t},vt.prototype.GetLineThickness=function(){return this.m_lineThickness},vt.prototype.SetAlpha=function(t){void 0===t&&(t=0),this.m_alpha=t},vt.prototype.GetAlpha=function(){return this.m_alpha},vt.prototype.SetFillAlpha=function(t){void 0===t&&(t=0),this.m_fillAlpha=t},vt.prototype.GetFillAlpha=function(){return this.m_fillAlpha},vt.prototype.SetXFormScale=function(t){void 0===t&&(t=0),this.m_xformScale=t},vt.prototype.GetXFormScale=function(){return this.m_xformScale},vt.prototype.DrawPolygon=function(t,e,i){if(e){var o=this.m_ctx,n=this.m_drawScale;o.beginPath(),o.strokeStyle=this._color(i.color,this.m_alpha),o.moveTo(t[0].x*n,t[0].y*n);for(var s=1;s<e;s++)o.lineTo(t[s].x*n,t[s].y*n);o.lineTo(t[0].x*n,t[0].y*n),o.closePath(),o.stroke()}},vt.prototype.DrawSolidPolygon=function(t,e,i){if(e){var o=this.m_ctx,n=this.m_drawScale;o.beginPath(),o.strokeStyle=this._color(i.color,this.m_alpha),o.fillStyle=this._color(i.color,this.m_fillAlpha),o.moveTo(t[0].x*n,t[0].y*n);for(var s=1;s<e;s++)o.lineTo(t[s].x*n,t[s].y*n);o.lineTo(t[0].x*n,t[0].y*n),o.closePath(),o.fill(),o.stroke()}},vt.prototype.DrawCircle=function(t,e,i){if(e){var o=this.m_ctx,n=this.m_drawScale;o.beginPath(),o.strokeStyle=this._color(i.color,this.m_alpha),o.arc(t.x*n,t.y*n,e*n,0,2*Math.PI,!0),o.closePath(),o.stroke()}},vt.prototype.DrawSolidCircle=function(t,e,i,o){if(e){var n=this.m_ctx,s=this.m_drawScale,r=t.x*s,a=t.y*s;n.moveTo(0,0),n.beginPath(),n.strokeStyle=this._color(o.color,this.m_alpha),n.fillStyle=this._color(o.color,this.m_fillAlpha),n.arc(r,a,e*s,0,2*Math.PI,!0),n.moveTo(r,a),n.lineTo((t.x+i.x*e)*s,(t.y+i.y*e)*s),n.closePath(),n.fill(),n.stroke()}},vt.prototype.DrawSegment=function(t,e,i){var o=this.m_ctx,n=this.m_drawScale;o.strokeStyle=this._color(i.color,this.m_alpha),o.beginPath(),o.moveTo(t.x*n,t.y*n),o.lineTo(e.x*n,e.y*n),o.closePath(),o.stroke()},vt.prototype.DrawTransform=function(t){var e=this.m_ctx,i=this.m_drawScale;e.beginPath(),e.strokeStyle=this._color(16711680,this.m_alpha),e.moveTo(t.position.x*i,t.position.y*i),e.lineTo((t.position.x+this.m_xformScale*t.R.col1.x)*i,(t.position.y+this.m_xformScale*t.R.col1.y)*i),e.strokeStyle=this._color(65280,this.m_alpha),e.moveTo(t.position.x*i,t.position.y*i),e.lineTo((t.position.x+this.m_xformScale*t.R.col2.x)*i,(t.position.y+this.m_xformScale*t.R.col2.y)*i),e.closePath(),e.stroke()},bt=0;bt<dt.postDefs.length;++bt)dt.postDefs[bt]();var wt=dt;wt.postDefs;function Ct(t){return Ct="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Ct(t)}function St(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var o,n,s,r,a=[],l=!0,h=!1;try{if(s=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;l=!1}else for(;!(l=(o=s.call(i)).done)&&(a.push(o.value),a.length!==e);l=!0);}catch(t){h=!0,n=t}finally{try{if(!l&&null!=i.return&&(r=i.return(),Object(r)!==r))return}finally{if(h)throw n}}return a}}(t,e)||Mt(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function At(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=Mt(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var o=0,n=function(){};return{s:n,n:function(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return r=t.done,t},e:function(t){a=!0,s=t},f:function(){try{r||null==i.return||i.return()}finally{if(a)throw s}}}}function Mt(t,e){if(t){if("string"==typeof t)return Dt(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?Dt(t,e):void 0}}function Dt(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,o=Array(e);i<e;i++)o[i]=t[i];return o}function Bt(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,o)}return i}function It(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Bt(Object(i),!0).forEach(function(e){Vt(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Bt(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function Vt(t,e,i){return(e=Pt(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function kt(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,Pt(o.key),o)}}function Pt(t){var e=function(t,e){if("object"!=Ct(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var o=i.call(t,e||"default");if("object"!=Ct(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==Ct(e)?e:e+""}var Tt=function(){return function(t,e,i){return e&&kt(t.prototype,e),i&&kt(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(e){var i,o,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),e.physicsEnabled&&(this.engine=e,this.canvas=e.canvas,this.BASE_SCALE=n.scale||30,this.quality=n.quality||1,this.SCALE=this.BASE_SCALE*this.quality,this.world=new wt.Dynamics.b2World(new wt.Common.Math.b2Vec2((null===(i=n.gravity)||void 0===i?void 0:i.x)/this.SCALE||0,(null===(o=n.gravity)||void 0===o?void 0:o.y)/this.SCALE||9.8),n.sleep||!0),this.config=It({friction:n.friction||.2,restitution:n.bounce||.2,density:n.density||1,maxVelocity:n.maxVelocity||1e3,velocityIterations:n.velocityIterations||8,positionIterations:n.positionIterations||3},n),this.bodies=new Map,this.velocities=new Map,this.materials=new Map,this.eventListeners=new Map,this._setupContactListener(),this.mouseJoints=new Map,this.draggedBodies=new Map,this.bodyTouchMap=new Map,this.mouseWorld=new wt.Common.Math.b2Vec2(0,0),this._setupDragListeners())},[{key:"on",value:function(t,e){this.eventListeners.has(t)||this.eventListeners.set(t,new Set),this.eventListeners.get(t).add(e)}},{key:"off",value:function(t,e){var i=this.eventListeners.get(t);i&&i.delete(e)}},{key:"trigger",value:function(t,e){var i=this.eventListeners.get(t);i&&i.forEach(function(t){return t(e)})}},{key:"_setupContactListener",value:function(){var t=this,e=new wt.Dynamics.b2ContactListener;e.BeginContact=function(e){var i=e.GetFixtureA().GetBody().GetUserData(),o=e.GetFixtureB().GetBody().GetUserData(),n=new wt.Collision.b2WorldManifold;e.GetWorldManifold(n);var s=n.m_points.map(function(e){return{x:e.x*t.SCALE,y:e.y*t.SCALE}}),r={x:n.m_normal.x,y:n.m_normal.y},a=e.GetFixtureA().GetBody(),l=e.GetFixtureB().GetBody(),h=a.GetLinearVelocity(),c=l.GetLinearVelocity(),m={x:(c.x-h.x)*t.SCALE,y:(c.y-h.y)*t.SCALE},u={entityA:i,entityB:o,contact:e,contactPoints:s,normal:r,relativeVelocity:m,type:"start",impactForce:Math.sqrt(m.x*m.x+m.y*m.y),angle:180*Math.atan2(r.y,r.x)/Math.PI};t.trigger("collisions",u),i&&"function"==typeof i.trigger&&i.trigger("collide",It(It({},u),{},{target:o})),o&&"function"==typeof o.trigger&&o.trigger("collide",It(It({},u),{},{target:i,normal:{x:-r.x,y:-r.y},relativeVelocity:{x:-m.x,y:-m.y}}))},e.EndContact=function(e){var i=e.GetFixtureA().GetBody().GetUserData(),o=e.GetFixtureB().GetBody().GetUserData();t.trigger("collisionEnd",{entityA:i,entityB:o,contact:e}),i&&"function"==typeof i.trigger&&i.trigger("collideEnd",{target:o,contact:e,type:"end"}),o&&"function"==typeof o.trigger&&o.trigger("collideEnd",{target:i,contact:e,type:"end"})},this.world.SetContactListener(e)}},{key:"createMaterial",value:function(t,e){var i,o,n;this.materials.set(t,{friction:null!==(i=e.friction)&&void 0!==i?i:this.config.friction,restitution:null!==(o=e.restitution)&&void 0!==o?o:this.config.restitution,density:null!==(n=e.density)&&void 0!==n?n:this.config.density})}},{key:"getMaterial",value:function(t){return this.materials.get(t)}},{key:"addEntity",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=new wt.Dynamics.b2BodyDef;switch(e.bodyType){case"static":i.type=wt.Dynamics.b2Body.b2_staticBody;break;case"kinematic":i.type=wt.Dynamics.b2Body.b2_kinematicBody;break;default:i.type=wt.Dynamics.b2Body.b2_dynamicBody}i.position.x=(t.absoluteX+t.width/2)/this.SCALE,i.position.y=(t.absoluteY+t.height/2)/this.SCALE,i.angle=t.styles.rotation*Math.PI/180;var o=this.world.CreateBody(i),n=this._createShape(t),s=new wt.Dynamics.b2FixtureDef;if(s.shape=n,e.material&&this.materials.has(e.material)){var r=this.materials.get(e.material);s.density=r.density,s.friction=r.friction,s.restitution=r.restitution}else s.density=e.density||this.config.density,s.friction=e.friction||this.config.friction,s.restitution=e.restitution||this.config.restitution;return e.collision&&(s.filter.categoryBits=e.collision.categoryBits||1,s.filter.maskBits=e.collision.maskBits||65535,s.filter.groupIndex=e.collision.groupIndex||0),o.CreateFixture(s),this.bodies.set(t.id,o),this.velocities.set(t.id,{x:0,y:0}),o.SetUserData(t),o}},{key:"removeEntity",value:function(t){var e=this.bodies.get(t.id);e&&(this.world.DestroyBody(e),this.bodies.delete(t.id),this.velocities.delete(t.id))}},{key:"_createShape",value:function(t){var e=this;switch(t.styles.shape){case"circle":return new wt.Collision.Shapes.b2CircleShape(Math.min(t.width,t.height)/2/this.SCALE);case"triangle":var i=new wt.Collision.Shapes.b2PolygonShape,o=[new wt.Common.Math.b2Vec2(0,-t.height/2/this.SCALE),new wt.Common.Math.b2Vec2(t.width/2/this.SCALE,t.height/2/this.SCALE),new wt.Common.Math.b2Vec2(-t.width/2/this.SCALE,t.height/2/this.SCALE)];return i.SetAsArray(o,o.length),i;case"star":for(var n=new wt.Collision.Shapes.b2PolygonShape,s=t.styles.spikes||5,r=.99*(Math.min(t.width,t.height)/2/this.SCALE),a=[],l=2*s,h=0;h<l;h++){var c=2*h*Math.PI/l-Math.PI/2;a.push(new wt.Common.Math.b2Vec2(Math.cos(c)*r,Math.sin(c)*r))}try{for(var m=[],u=0;u<8;u++){var y=2*u*Math.PI/8-Math.PI/2;m.push(new wt.Common.Math.b2Vec2(Math.cos(y)*r,Math.sin(y)*r))}return n.SetAsArray(m,m.length),n}catch(t){return this.engine.warn("Creating circle shape as fallback for star"),new wt.Collision.Shapes.b2CircleShape(r)}case"polygon":if(t.collision.points&&t.collision.points.length>=3){var p=new wt.Collision.Shapes.b2PolygonShape,_=t.collision.points.map(function(t){return new wt.Common.Math.b2Vec2(t.x/e.SCALE,t.y/e.SCALE)});try{var f=_.reduce(function(t,e,i){var o=_[(i+1)%_.length];return t+(o.x-e.x)*(o.y+e.y)},0);return f>0&&_.reverse(),p.SetAsArray(_,_.length),p}catch(e){return this.engine.warn("Failed to create polygon shape, falling back to rectangle"),this._createRectangleShape(t)}}return this._createRectangleShape(t);default:return this._createRectangleShape(t)}}},{key:"_createRectangleShape",value:function(t){var e=new wt.Collision.Shapes.b2PolygonShape;return e.SetAsBox(t.width/2/this.SCALE,t.height/2/this.SCALE),e}},{key:"update",value:function(t){var e=Math.min(t,20)/1e3;this.world.Step(e,this.config.velocityIterations||8,this.config.positionIterations||3);var i,o=At(this.bodies);try{for(o.s();!(i=o.n()).done;){var n=St(i.value,2),s=n[0],r=n[1],a=r.GetUserData();if(a){var l=r.GetPosition(),h=r.GetAngle();a.style({x:l.x*this.SCALE-a.width/2,y:l.y*this.SCALE-a.height/2,rotation:180*h/Math.PI});var c=r.GetLinearVelocity();this.velocities.set(s,{x:c.x*this.SCALE,y:c.y*this.SCALE})}}}catch(t){o.e(t)}finally{o.f()}this.world.ClearForces()}},{key:"applyForce",value:function(t,e){var i=this.bodies.get(t.id);if(i){var o=i.GetWorldCenter();i.ApplyForce(new wt.Common.Math.b2Vec2(e.x,e.y),o)}}},{key:"setVelocity",value:function(t,e){var i=this.bodies.get(t.id);i&&i.SetLinearVelocity(new wt.Common.Math.b2Vec2(e.x/this.SCALE,e.y/this.SCALE))}},{key:"setVelocityLimit",value:function(t,e){var i=this.bodies.get(t.id);i&&i.SetLinearVelocity({x:Math.min(Math.max(i.GetLinearVelocity().x,-e),e),y:Math.min(Math.max(i.GetLinearVelocity().y,-e),e)})}},{key:"setGravity",value:function(t,e){this.world.SetGravity(new wt.Common.Math.b2Vec2(t/this.SCALE,e/this.SCALE));var i,o=At(this.bodies);try{for(o.s();!(i=o.n()).done;){var n=St(i.value,2),s=(n[0],n[1]);s.GetType()!==wt.Dynamics.b2Body.b2_staticBody&&this.applyImpulse(s.GetUserData(),{x:1e-4,y:1e-4})}}catch(t){o.e(t)}finally{o.f()}}},{key:"getBodyVelocity",value:function(t){return this.velocities.get(t.id)}},{key:"setAngularVelocity",value:function(t,e){var i=this.bodies.get(t.id);i&&i.SetAngularVelocity(e)}},{key:"applyTorque",value:function(t,e){var i=this.bodies.get(t.id);i&&i.ApplyTorque(e)}},{key:"applyImpulse",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=this.bodies.get(t.id);if(o){var n=i?new wt.Common.Math.b2Vec2(i.x/this.SCALE,i.y/this.SCALE):o.GetWorldCenter();o.ApplyImpulse(new wt.Common.Math.b2Vec2(e.x,e.y),n)}}},{key:"startDrag",value:function(t,e,i,o){var n=this.bodies.get(t.id);if(n&&!this.mouseJoints.has(o)&&!this.bodyTouchMap.has(t.id)){var s=new wt.Common.Math.b2Vec2(e/this.SCALE,i/this.SCALE),r=new wt.Dynamics.Joints.b2MouseJointDef,a=this.world.CreateBody(new wt.Dynamics.b2BodyDef);r.bodyA=a,r.bodyB=n,r.target.Set(s.x,s.y),r.maxForce=1e3*n.GetMass(),r.collideConnected=!0,r.dampingRatio=.5,r.frequencyHz=5;var l=this.world.CreateJoint(r);this.mouseJoints.set(o,l),this.draggedBodies.set(o,{body:n,entity:t}),this.bodyTouchMap.set(t.id,o),n.SetAngularDamping(.1),n.SetLinearDamping(.1),n.SetFixedRotation(!0),"function"==typeof t.trigger&&t.trigger("drag",{x:e,y:i,identifier:o})}}},{key:"updateDrag",value:function(t,e,i){var o=this.mouseJoints.get(i),n=this.draggedBodies.get(i);if(o&&n){var s=new wt.Common.Math.b2Vec2(t/this.SCALE,e/this.SCALE);o.SetTarget(s);n.body;var r=n.entity;"function"==typeof r.trigger&&r.trigger("dragMove",{x:t,y:e,identifier:i})}}},{key:"endDrag",value:function(t){var e=this.mouseJoints.get(t),i=this.draggedBodies.get(t);if(e&&i){var o=i.body,n=i.entity;if(o.SetFixedRotation(!1),o.SetAngularDamping(.1),o.SetLinearDamping(.1),"function"==typeof n.trigger){var s=o.GetPosition();n.trigger("drop",{x:s.x*this.SCALE,y:s.y*this.SCALE,identifier:t})}this.world.DestroyJoint(e),this.mouseJoints.delete(t),this.draggedBodies.delete(t),this.bodyTouchMap.delete(n.id)}}},{key:"canDrag",value:function(t){var e=this.bodies.get(t.id);return e&&e.GetType()!==wt.Dynamics.b2Body.b2_staticBody}},{key:"_setupDragListeners",value:function(){var t=this;if(this.canvas){var e=null,i=0,o={x:0,y:0},n="mouse",s=function(t,e,i){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s={x:i.x,y:i.y,worldX:i.x,worldY:i.y,screenX:t,screenY:e,timestamp:Date.now()};return null!==o&&(s.identifier=o),null!==n&&(s.target=n),s};this.canvas.addEventListener("mousedown",function(e){if(t.engine.running){var i=t.canvas.getBoundingClientRect(),o=e.clientX-i.left,r=e.clientY-i.top,a=t.engine.camera.screenToWorld(e.clientX,e.clientY),l=s(o,r,a,n);t.engine.trigger("mousedown",l);for(var h=0,c=Array.from(t.bodies.entries());h<c.length;h++){var m=St(c[h],2),u=(m[0],m[1].GetUserData());if(u&&u.events.draggable&&t._isPointInEntity(o,r,u)){t.startDrag(u,a.x,a.y,n),u.trigger("drag",s(o,r,a,n,u));break}}}}),this.canvas.addEventListener("mousemove",function(i){if(t.engine.running){var o=t.canvas.getBoundingClientRect(),r=i.clientX-o.left,a=i.clientY-o.top,l=t.engine.camera.screenToWorld(i.clientX,i.clientY),h=s(r,a,l,n);t.engine.trigger("mousemove",h);for(var c=null,m=0,u=Array.from(t.bodies.entries());m<u.length;m++){var y=St(u[m],2),p=(y[0],y[1].GetUserData());if(p&&p.events.hoverable&&t._isPointInEntity(r,a,p)){c=p;break}}if(c!==e&&(e&&e.trigger("hoverOut",s(r,a,l,null,e)),c&&c.trigger("hover",s(r,a,l,null,c)),e=c),t.mouseJoints.has(n)){var _=t.draggedBodies.get(n);_&&_.entity&&(t.updateDrag(l.x,l.y,n),_.entity.trigger("dragMove",s(r,a,l,n,_.entity)))}}}),this.canvas.addEventListener("mouseup",function(e){if(t.engine.running){var i=t.canvas.getBoundingClientRect(),o=e.clientX-i.left,r=e.clientY-i.top,a=t.engine.camera.screenToWorld(e.clientX,e.clientY),l=s(o,r,a,n);if(t.engine.trigger("mouseup",l),t.mouseJoints.has(n)){var h=t.draggedBodies.get(n);h&&h.entity&&h.entity.trigger("drop",s(o,r,a,n,h.entity)),t.endDrag(n)}}}),this.canvas.addEventListener("touchstart",function(e){if(e.preventDefault(),t.engine.running){i=Date.now();var n,r=At(e.changedTouches);try{for(r.s();!(n=r.n()).done;){var a=n.value,l=t.canvas.getBoundingClientRect(),h=a.clientX-l.left,c=a.clientY-l.top,m=t.engine.camera.screenToWorld(a.clientX,a.clientY);o={x:h,y:c};var u=s(h,c,m,a.identifier);t.engine.trigger("touchstart",u);var y,p=Array.from(t.bodies.entries()).filter(function(e){var i=St(e,2),o=i[0];i[1];return!t.bodyTouchMap.has(o)}),_=At(p);try{for(_.s();!(y=_.n()).done;){var f=St(y.value,2),d=(f[0],f[1].GetUserData());if(d&&d.events.draggable&&t._isPointInEntity(h,c,d)){t.startDrag(d,m.x,m.y,a.identifier),d.trigger("drag",s(h,c,m,a.identifier,d));break}}}catch(t){_.e(t)}finally{_.f()}}}catch(t){r.e(t)}finally{r.f()}}}),this.canvas.addEventListener("touchmove",function(e){if(e.preventDefault(),t.engine.running){var i,o=At(e.changedTouches);try{for(o.s();!(i=o.n()).done;){var n=i.value,r=t.canvas.getBoundingClientRect(),a=n.clientX-r.left,l=n.clientY-r.top,h=t.engine.camera.screenToWorld(n.clientX,n.clientY),c=s(a,l,h,n.identifier);if(t.engine.trigger("touchmove",c),t.mouseJoints.has(n.identifier)){var m=t.draggedBodies.get(n.identifier);m&&m.entity&&(t.updateDrag(h.x,h.y,n.identifier),m.entity.trigger("dragMove",s(a,l,h,n.identifier,m.entity)))}}}catch(t){o.e(t)}finally{o.f()}}}),this.canvas.addEventListener("touchend",function(e){if(t.engine.running){var n,r=Date.now(),a=At(e.changedTouches);try{for(a.s();!(n=a.n()).done;){var l=n.value,h=t.canvas.getBoundingClientRect(),c=l.clientX-h.left,m=l.clientY-h.top,u=t.engine.camera.screenToWorld(l.clientX,l.clientY),y=s(c,m,u,l.identifier);t.engine.trigger("touchend",y);var p=c-o.x,_=m-o.y;if(Math.sqrt(p*p+_*_)<10&&r-i<200){var f=s(c,m,u);t.engine.trigger("click",f);for(var d=Array.from(t.bodies.entries()),v=0,b=d;v<b.length;v++){var x=St(b[v],2),g=(x[0],x[1].GetUserData());if(g&&g.events.clickable&&t._isPointInEntity(c,m,g)){g.trigger("click",s(c,m,u,null,g));break}}}if(t.mouseJoints.has(l.identifier)){var w=t.draggedBodies.get(l.identifier);w&&w.entity&&w.entity.trigger("drop",s(c,m,u,l.identifier,w.entity)),t.endDrag(l.identifier)}}}catch(t){a.e(t)}finally{a.f()}}}),this.canvas.addEventListener("touchcancel",function(e){if(t.engine.running){var i,o=At(e.changedTouches);try{for(o.s();!(i=o.n()).done;){var n=i.value,r=t.canvas.getBoundingClientRect(),a=n.clientX-r.left,l=n.clientY-r.top,h=t.engine.camera.screenToWorld(n.clientX,n.clientY),c=s(a,l,h,n.identifier);if(t.engine.trigger("touchcancel",c),t.mouseJoints.has(n.identifier)){var m=t.draggedBodies.get(n.identifier);m&&m.entity&&m.entity.trigger("drop",s(a,l,h,n.identifier,m.entity)),t.endDrag(n.identifier)}}}catch(t){o.e(t)}finally{o.f()}}})}}},{key:"_isPointInEntity",value:function(t,e,i){var o=this.bodies.get(i.id);if(!o)return!1;for(var n=i.engine.camera.screenToWorld(t,e),s=new wt.Common.Math.b2Vec2(n.x/this.SCALE,n.y/this.SCALE),r=o.GetFixtureList();r;){if(r.TestPoint(s))return!0;r=r.GetNext()}return!1}},{key:"isBodyAwake",value:function(t){var e=this.bodies.get(t.id);return!!e&&e.IsAwake()}},{key:"setBodyAwake",value:function(t,e){var i=this.bodies.get(t.id);i&&i.SetAwake(e)}},{key:"setBodyProperties",value:function(t,e){var i=this.bodies.get(t.id);if(i){var o=i.GetFixtureList();o&&(void 0!==e.friction&&o.SetFriction(e.friction),void 0!==e.restitution&&o.SetRestitution(e.restitution),void 0!==e.density&&(o.SetDensity(e.density),i.ResetMassData()))}}}])}();const Gt=Tt;function Lt(t){return Lt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Lt(t)}function Et(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=zt(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var o=0,n=function(){};return{s:n,n:function(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return r=t.done,t},e:function(t){a=!0,s=t},f:function(){try{r||null==i.return||i.return()}finally{if(a)throw s}}}}function Ft(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,o)}return i}function Rt(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Ft(Object(i),!0).forEach(function(e){Jt(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Ft(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function Jt(t,e,i){return(e=Xt(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function Ot(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var o,n,s,r,a=[],l=!0,h=!1;try{if(s=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;l=!1}else for(;!(l=(o=s.call(i)).done)&&(a.push(o.value),a.length!==e);l=!0);}catch(t){h=!0,n=t}finally{try{if(!l&&null!=i.return&&(r=i.return(),Object(r)!==r))return}finally{if(h)throw n}}return a}}(t,e)||zt(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function zt(t,e){if(t){if("string"==typeof t)return jt(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?jt(t,e):void 0}}function jt(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,o=Array(e);i<e;i++)o[i]=t[i];return o}function Nt(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,Xt(o.key),o)}}function Xt(t){var e=function(t,e){if("object"!=Lt(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var o=i.call(t,e||"default");if("object"!=Lt(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==Lt(e)?e:e+""}var Wt=function(){return function(t,e,i){return e&&Nt(t.prototype,e),i&&Nt(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.engine=e,this.layers=new Map,this.tiles=new Map,this.defaultTileSize=32,this.activeCollisions=new Map,this.animatedTiles=new Map},[{key:"create",value:function(t){var e=t.layers,i=t.tiles;this.tiles.clear();for(var o=0,n=Object.entries(i);o<n.length;o++){var s=Ot(n[o],2),r=s[0],a=s[1];"string"==typeof a?this.tiles.set(r,{tile:a,type:"default"}):this.tiles.set(r,Rt(Rt({},a),{},{tile:a.tile,collision:a.collision||null}))}return this.layers=this.parseLayers(e),this.initializeTileAnimations({tiles:this.tiles}),{layers:this.layers,tiles:this.tiles}}},{key:"checkCollisions",value:function(t){var e;if(null!==(e=t.collision)&&void 0!==e&&e.enabled){t.previousX=t.absoluteX,t.previousY=t.absoluteY;for(var i=this.defaultTileSize,o=i/2,n={left:Math.floor((t.absoluteX-o)/i),top:Math.floor((t.absoluteY-o)/i),right:Math.ceil((t.absoluteX+t.width+o)/i),bottom:Math.ceil((t.absoluteY+t.height+o)/i)},s=new Map,r=null,a=n.top;a<=n.bottom;a++)for(var l=n.left;l<=n.right;l++){var h,c=Et(this.getTilesAt(l*i,a*i));try{for(c.s();!(h=c.n()).done;){var m=h.value;if(m.config.collision){var u=this.checkTileCollision(t,m,l*i,a*i);if(null!=u&&u.collides){var y="".concat(t.id,"_").concat(l,"_").concat(a,"_").concat(m.layer);switch(m.config.collision.type){case"solid":r=Rt(Rt({},u),{},{tile:m,x:l*i,y:a*i});break;case"platform":"bottom"===u.side&&t.style({y:a*i-t.height/2})}s.set(y,{entity:t,tile:m,x:l,y:a,layer:m.layer,time:performance.now(),side:u.side,amount:u.amount}),this.activeCollisions.has(y)&&this.activeCollisions.get(y).side===u.side||!m.config.collision.onCollide||m.config.collision.onCollide({entity:t,tile:m.config,position:{x:l*i,y:a*i},layer:m.layer,collisionType:m.config.collision.type,side:u.side,amount:u.amount})}}}}catch(t){c.e(t)}finally{c.f()}}if(r)switch(r.side){case"left":t.move({x:-r.amount,relative:!0});break;case"right":t.move({x:r.amount,relative:!0});break;case"top":t.move({y:-r.amount,relative:!0});break;case"bottom":t.move({y:r.amount,relative:!0})}var p,_=Et(this.activeCollisions);try{for(_.s();!(p=_.n()).done;){var f=Ot(p.value,2),d=f[0],v=f[1];if(!s.has(d)){var b=v.tile;b.config.collision.onCollisionEnd&&b.config.collision.onCollisionEnd({entity:v.entity,tile:b.config,position:{x:v.x*i,y:v.y*i},layer:v.layer})}}}catch(t){_.e(t)}finally{_.f()}this.activeCollisions=s}}},{key:"checkTileCollision",value:function(t,e,i,o){var n=e.config.collision.bounds||[0,0,this.defaultTileSize,this.defaultTileSize],s={x:i+n[0],y:o+n[1],width:n[2],height:n[3]},r={x:t.absoluteX,y:t.absoluteY,width:t.width,height:t.height};switch(e.config.collision.type){case"platform":var a=r.y+r.height,l=t.previousY+r.height,h=s.y;return l<=h&&a>=h?{collides:!0,side:"bottom",amount:a-h}:{collides:!1};case"trigger":var c=this.getOverlap(r,s);return c.collides?Rt(Rt({},c),{},{isTrigger:!0}):{collides:!1};default:return this.getOverlap(r,s)}}},{key:"getOverlap",value:function(t,e){var i=t.x+t.width>e.x&&t.x<e.x+e.width,o=t.y+t.height>e.y&&t.y<e.y+e.height;if(!i||!o)return{collides:!1};var n=[{side:"left",amount:t.x+t.width-e.x},{side:"right",amount:e.x+e.width-t.x},{side:"top",amount:t.y+t.height-e.y},{side:"bottom",amount:e.y+e.height-t.y}].reduce(function(t,e){return e.amount<t.amount?e:t});return{collides:!0,side:n.side,amount:n.amount}}},{key:"update",value:function(){if(this.engine.collisionEnabled){var t,e=Et(this.engine.entities);try{for(e.s();!(t=e.n()).done;){var i,o=Ot(t.value,2),n=(o[0],o[1]);null!==(i=n.collision)&&void 0!==i&&i.enabled&&this.checkCollisions(n)}}catch(t){e.e(t)}finally{e.f()}this.updateAnimatedTiles()}}},{key:"updateAnimatedTiles",value:function(){var t,e=performance.now(),i=Et(this.animatedTiles);try{for(i.s();!(t=i.n()).done;){var o=Ot(t.value,2),n=(o[0],o[1]);if(n.frames&&!(n.frames.length<=1)){var s=1e3/n.frameRate;e-n.lastFrameTime>=s&&(n.loop?n.currentFrame=(n.currentFrame+1)%n.frames.length:n.currentFrame<n.frames.length-1&&n.currentFrame++,n.lastFrameTime=e)}}}catch(t){i.e(t)}finally{i.f()}}},{key:"render",value:function(t){var e=this.engine.ctx,i=this.engine.camera,o=this.defaultTileSize,n=Math.floor(i.x),s=Math.floor(i.y),r=this.engine.baseWidth/i.zoom,a=this.engine.baseHeight/i.zoom,l=Math.floor(n/o)-1,h=Math.floor(s/o)-1,c=Math.ceil((n+r)/o)+1,m=Math.ceil((s+a)/o)+1;e.imageSmoothingEnabled=!1;var u,y=Et(t.layers);try{for(y.s();!(u=y.n()).done;)for(var p=Ot(u.value,2),_=(p[0],p[1]),f=Math.max(0,h),d=Math.min(_.length,m),v=f;v<d;v++){var b=_[v];if(b)for(var x=Math.max(0,l),g=Math.min(b.length,c),w=x;w<g;w++){var C,S=b[w];if(S){var A=t.tiles.get(S);A&&(A.parts?this.renderCompositeTile(e,Rt(Rt({},A),{},{symbol:S}),w,v,o,1):this.renderSingleTile(e,Rt(Rt({},A),{},{symbol:S}),w,v,o,1),null!==(C=this.engine.debugger)&&void 0!==C&&C.active&&A.collision&&this.renderTileDebug(e,A,w,v,o))}}}}catch(t){y.e(t)}finally{y.f()}}},{key:"renderTileDebug",value:function(t,e,i,o,n){t.save();var s=Ot(e.collision.bounds||[0,0,n,n],4),r=s[0],a=s[1],l=s[2],h=s[3],c=i*n+r,m=o*n+a;t.strokeStyle="rgba(255, 0, 0, 0.5)",t.fillStyle="rgba(255, 0, 0, 0.2)",t.lineWidth=1,t.beginPath(),t.rect(c,m,l,h),t.stroke(),t.fill(),e.collision.type&&(t.fillStyle="rgba(255, 255, 255, 0.8)",t.font="10px Arial",t.textAlign="left",t.fillText(e.collision.type,c+2,m+12)),t.fillStyle="rgba(255, 255, 0, 0.8)",[[c,m],[c+l,m],[c+l,m+h],[c,m+h]].forEach(function(e){var i=Ot(e,2),o=i[0],n=i[1];t.beginPath(),t.arc(o,n,2,0,2*Math.PI),t.fill()}),t.fillStyle="rgba(0, 255, 255, 0.8)",t.beginPath(),t.arc(c+l/2,m+h/2,2,0,2*Math.PI),t.fill(),t.restore()}},{key:"renderCompositeTile",value:function(t,e,i,o,n,s){this.renderSingleTile(t,Rt(Rt({},e),{},{symbol:e.symbol}),i,o,n,s);var r,a=Et(e.parts);try{for(a.s();!(r=a.n()).done;){var l,h=r.value,c=h.offsetX||0,m=h.offsetY||0,u=i+c,y=o+m;this.renderSingleTile(t,h.tile,u,y,n,s),null!==(l=this.engine.debugger)&&void 0!==l&&l.active&&h.collision&&this.renderTileDebug(t,h,u,y,n)}}catch(t){a.e(t)}finally{a.f()}}},{key:"renderSingleTile",value:function(t,e,i,o,n,s){var r="string"==typeof e?e:e.tile;if("object"===Lt(e)&&e.frames&&e.symbol){var a=this.getCurrentTileFrame(e.symbol);a&&(r=a)}var l=this.getTileInfo(r);if(l){var h=this.engine.getAsset(l.assetId);if(h){var c=h.config.tiles[l.tileName];if(c){var m=Math.floor(i*n-s),u=Math.floor(o*n-s),y=n+2*s;t.drawImage(h.asset,c.x,c.y,c.width,c.height,m,u,y,y)}}}}},{key:"initializeTileAnimations",value:function(t){var e,i=Et(t.tiles);try{for(i.s();!(e=i.n()).done;){var o=Ot(e.value,2),n=o[0],s=o[1];if(s.frames&&s.frames.length>1){var r="tile_".concat(n);this.animatedTiles.set(r,{frames:s.frames,frameRate:s.frameRate||8,loop:!1!==s.loop,currentFrame:0,lastFrameTime:performance.now()})}}}catch(t){i.e(t)}finally{i.f()}}},{key:"getCurrentTileFrame",value:function(t){var e="tile_".concat(t),i=this.animatedTiles.get(e);return i&&i.frames?i.frames[i.currentFrame]:null}},{key:"addTile",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(i=Math.floor(Number(i)),o=Math.floor(Number(o)),!Number.isInteger(i)||!Number.isInteger(o)||i<0||o<0)return this.engine.warn("Invalid coordinates: x=".concat(i,", y=").concat(o,". Coordinates must be non-negative integers.")),!1;if(!this.tiles.has(e))return this.engine.warn("Symbol '".concat(e,"' not found in tiles configuration")),!1;this.layers.has(t)||(this.layers.set(t,[]),this.engine.log("Created new layer: ".concat(t)));for(var n=this.layers.get(t);n.length<=o;)n.push([]);for(var s=n[o];s.length<=i;)s.push(void 0);return n[o][i]=e,this.engine.log("Added tile '".concat(e,"' to layer '").concat(t,"' at position (").concat(i,", ").concat(o,")")),!0}},{key:"getTileInfo",value:function(t){if("string"==typeof t){var e=Ot(t.split("."),2);return{assetId:e[0],tileName:e[1]}}return null}},{key:"getTileSize",value:function(t){var e=this.getTileInfo(t);if(!e)return this.defaultTileSize;var i=this.engine.getAsset(e.assetId);return(null==i?void 0:i.config.tileSize)||this.defaultTileSize}},{key:"getTilesAt",value:function(t,e){var i=Math.floor(t/this.defaultTileSize),o=Math.floor(e/this.defaultTileSize),n=[];if(i<0||o<0)return n;var s,r=Et(this.layers);try{for(r.s();!(s=r.n()).done;){var a=Ot(s.value,2),l=a[0],h=a[1];if(h[o]&&void 0!==h[o][i]){var c=h[o][i];if(c){var m=this.tiles.get(c);m&&n.push({symbol:c,config:m,x:i,y:o,layer:l,worldX:i*this.defaultTileSize,worldY:o*this.defaultTileSize})}}}}catch(t){r.e(t)}finally{r.f()}return n}},{key:"getTileAt",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(i){var o=Math.floor(t/this.defaultTileSize),n=Math.floor(e/this.defaultTileSize),s=this.layers.get(i);if(!s||o<0||n<0||!s[n]||void 0===s[n][o])return null;var r=s[n][o];if(!r)return null;var a=this.tiles.get(r);return a?{symbol:r,config:a,x:o,y:n,layer:i,worldX:o*this.defaultTileSize,worldY:n*this.defaultTileSize}:null}var l=this.getTilesAt(t,e);return l.length>0?l[0]:null}},{key:"fillBoxWith",value:function(t){for(var e=this.engine.canvas,i=this.getTileSize(),o=Math.ceil(e.width/i),n=Math.ceil(e.height/i),s=[],r=0;r<n;r++){var a=new Array(o).fill(t);s.push(a)}return s}},{key:"fillWith",value:function(t,e){return new Array(e).fill(t)}},{key:"parseLayers",value:function(t){for(var e=new Map,i=0,o=Object.entries(t);i<o.length;i++){var n=Ot(o[i],2),s=n[0],r=n[1];Array.isArray(r)?e.set(s,this.normalizeLayer(r)):e.set(s,r)}return e}},{key:"normalizeLayer",value:function(t){return t.map(function(t){return"string"==typeof t?t.split("").map(function(t){return" "===t?void 0:t}):Array.from(t,function(t){return void 0===t?void 0:t})})}},{key:"exportLayers",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0,e={};if(void 0!==t){if(!this.layers.has(t))return this.engine.warn("Layer '".concat(t,"' not found")),JSON.stringify({},null,2);var i=this.layers.get(t).map(function(t){return t.map(function(t){return void 0===t?" ":t}).join("")});e[t]=i}else{var o,n=Et(this.layers);try{for(n.s();!(o=n.n()).done;){var s=Ot(o.value,2),r=s[0],a=s[1].map(function(t){return t.map(function(t){return void 0===t?" ":t}).join("")});e[r]=a}}catch(t){n.e(t)}finally{n.f()}}return JSON.stringify(e,null,2)}}])}();const Yt=Wt;function qt(t){return qt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},qt(t)}function Ut(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,Kt(o.key),o)}}function Kt(t){var e=function(t,e){if("object"!=qt(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var o=i.call(t,e||"default");if("object"!=qt(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==qt(e)?e:e+""}var Zt=function(){return function(t,e,i){return e&&Ut(t.prototype,e),i&&Ut(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.reset()},[{key:"reset",value:function(){this.x=0,this.y=0,this.vx=0,this.vy=0,this.ax=0,this.ay=0,this.size=1,this.currentSize=1,this.startColor="#ffffff",this.endColor="#000000",this.startAlpha=1,this.endAlpha=0,this.rotation=0,this.rotationSpeed=0,this.lifetime=1e3,this.age=0,this.texture=null}},{key:"init",value:function(t){this.x=t.x,this.y=t.y,this.vx=t.velocity.x,this.vy=t.velocity.y,this.ax=t.acceleration.x,this.ay=t.acceleration.y,this.size=t.size,this.currentSize=t.size,this.startColor=t.color.start,this.endColor=t.color.end,this.startAlpha=t.alpha.start,this.endAlpha=t.alpha.end,this.rotation=t.rotation,this.rotationSpeed=t.rotationSpeed,this.lifetime=t.lifetime,this.age=0,this.texture=t.texture}},{key:"update",value:function(t){var e=t/1e3;this.vx+=this.ax*e,this.vy+=this.ay*e,this.x+=this.vx*e,this.y+=this.vy*e,this.rotation+=this.rotationSpeed*e,this.age+=t}},{key:"isDead",value:function(){return this.age>=this.lifetime}},{key:"render",value:function(t){if(!this.isDead()){var e=this.age/this.lifetime,i=this.startAlpha+(this.endAlpha-this.startAlpha)*e;if(t.save(),t.globalAlpha=i,t.translate(this.x,this.y),t.rotate(this.rotation*Math.PI/180),this.texture){var o=this.texture;t.drawImage(o,-this.size/2,-this.size/2,this.size,this.size)}else{var n=this.interpolateColor(this.startColor,this.endColor,e);t.fillStyle=n,t.beginPath(),t.arc(0,0,this.size/2,0,2*Math.PI),t.fill()}t.restore()}}},{key:"interpolateColor",value:function(t,e,i){var o=parseInt(t.substr(1,2),16),n=parseInt(t.substr(3,2),16),s=parseInt(t.substr(5,2),16),r=parseInt(e.substr(1,2),16),a=parseInt(e.substr(3,2),16),l=parseInt(e.substr(5,2),16),h=Math.round(o+(r-o)*i),c=Math.round(n+(a-n)*i),m=Math.round(s+(l-s)*i);return"rgb(".concat(h,", ").concat(c,", ").concat(m,")")}}])}();const Ht=Zt;function Qt(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,o)}return i}function $t(t,e,i){return(e=ne(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function te(t){return te="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},te(t)}function ee(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function ie(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,ne(o.key),o)}}function oe(t,e,i){return e&&ie(t.prototype,e),i&&ie(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function ne(t){var e=function(t,e){if("object"!=te(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var o=i.call(t,e||"default");if("object"!=te(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==te(e)?e:e+""}var se=function(){return oe(function t(e){ee(this,t),this.engine=e,this.emitters=new Map,this.particlePool=[],this.maxPoolSize=1e3},[{key:"create",value:function(t){var e=new re(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},this.engine);return this.emitters.set(t,e),e}},{key:"get",value:function(t){return this.emitters.get(t)||null}},{key:"remove",value:function(t){var e=this.emitters.get(t);return!!e&&(e.destroy(),this.emitters.delete(t),!0)}},{key:"getAll",value:function(){return Array.from(this.emitters.values())}},{key:"clear",value:function(){this.emitters.forEach(function(t){return t.destroy()}),this.emitters.clear(),this.particlePool=[]}},{key:"getParticle",value:function(){return this.particlePool.length>0?this.particlePool.pop():new Ht}},{key:"returnParticle",value:function(t){this.particlePool.length<this.maxPoolSize&&(t.reset(),this.particlePool.push(t))}},{key:"update",value:function(t){this.emitters.forEach(function(e){e.active&&e.update(t)})}},{key:"render",value:function(t){this.emitters.forEach(function(e){e.visible&&e.render(t)})}},{key:"explosion",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o={position:{x:t,y:e},shape:"invisible",emission:{type:"point",rate:0,burst:i.particleCount||30,lifetime:i.lifetime||1500},particle:{velocity:{min:{x:-150,y:-150},max:{x:150,y:-50}},acceleration:{x:0,y:100},size:{min:3,max:8},color:{start:i.startColor||"#ff4444",end:i.endColor||"#ffaa00"},alpha:{start:1,end:0},rotation:{min:0,max:360},rotationSpeed:{min:-360,max:360}},autoDestroy:!0},n=this.create("explosion_".concat(Date.now()),o);return n.start(),n.burst(i.particleCount||30),n}},{key:"fire",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o={position:{x:t,y:e},shape:"invisible",emission:{type:"point",rate:i.rate||40,lifetime:i.lifetime||1200},particle:{velocity:{min:{x:-30,y:-80},max:{x:30,y:-40}},acceleration:{x:0,y:-20},size:{min:2,max:6},color:{start:"#ff4444",end:"#ff8800"},alpha:{start:.8,end:0}}},n=this.create("fire_".concat(Date.now()),o);return n.start(),n}},{key:"smoke",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o={position:{x:t,y:e},shape:"invisible",emission:{type:"point",rate:i.rate||15,lifetime:i.lifetime||3e3},particle:{velocity:{min:{x:-20,y:-60},max:{x:20,y:-30}},acceleration:{x:0,y:-10},size:{min:8,max:16},color:{start:"#666666",end:"#cccccc"},alpha:{start:.6,end:0}}},n=this.create("smoke_".concat(Date.now()),o);return n.start(),n}}])}(),re=function(){return oe(function t(e,i,o){var n,s,r,a,l,h,c,m,u,y,p,_,f,d;ee(this,t),this.id=e,this.engine=o,this.particles=[],this.active=!1,this.visible=!0,this.x=(null===(n=i.position)||void 0===n?void 0:n.x)||0,this.y=(null===(s=i.position)||void 0===s?void 0:s.y)||0,this.targetX=this.x,this.targetY=this.y,this.moveAnimation=null,this.shape=i.shape||"invisible",this.size=i.size||10,this.color=i.color||"#ff0000",this.opacity=i.opacity||.5,this.emission=function(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Qt(Object(i),!0).forEach(function(e){$t(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Qt(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}({type:(null===(r=i.emission)||void 0===r?void 0:r.type)||"point",rate:(null===(a=i.emission)||void 0===a?void 0:a.rate)||30,lifetime:(null===(l=i.emission)||void 0===l?void 0:l.lifetime)||2e3,burst:(null===(h=i.emission)||void 0===h?void 0:h.burst)||0},i.emission),this.particle={velocity:(null===(c=i.particle)||void 0===c?void 0:c.velocity)||{min:{x:-50,y:-50},max:{x:50,y:50}},acceleration:(null===(m=i.particle)||void 0===m?void 0:m.acceleration)||{x:0,y:0},size:(null===(u=i.particle)||void 0===u?void 0:u.size)||{min:2,max:4},color:(null===(y=i.particle)||void 0===y?void 0:y.color)||{start:"#ffffff",end:"#000000"},alpha:(null===(p=i.particle)||void 0===p?void 0:p.alpha)||{start:1,end:0},rotation:(null===(_=i.particle)||void 0===_?void 0:_.rotation)||{min:0,max:0},rotationSpeed:(null===(f=i.particle)||void 0===f?void 0:f.rotationSpeed)||{min:0,max:0},texture:(null===(d=i.particle)||void 0===d?void 0:d.texture)||null},this.lastEmissionTime=0,this.emissionInterval=1e3/this.emission.rate,this.autoDestroy=i.autoDestroy||!1},[{key:"start",value:function(){return this.active=!0,this.lastEmissionTime=performance.now(),this}},{key:"stop",value:function(){return this.active=!1,this}},{key:"pause",value:function(){return this.active=!1,this}},{key:"resume",value:function(){return this.active=!0,this.lastEmissionTime=performance.now(),this}},{key:"burst",value:function(t){for(var e=0;e<t;e++)this.emitParticle();return this}},{key:"move",value:function(t,e){return this.x=t,this.y=e,this.targetX=t,this.targetY=e,this.moveAnimation&&(this.moveAnimation=null),this}},{key:"moveTo",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.targetX=t,this.targetY=e;var o=this.x,n=this.y,s=i.duration||1e3,r=this.engine.Ease[i.easing]||this.engine.Ease.linear,a=performance.now();return this.moveAnimation={startX:o,startY:n,targetX:t,targetY:e,duration:s,easing:r,startTime:a},this}},{key:"emitParticle",value:function(){var t,e=this.engine.emitters.getParticle(),i=this.getEmissionPosition();e.init({x:i.x,y:i.y,velocity:this.randomizeValue(this.particle.velocity),acceleration:this.particle.acceleration,size:this.randomizeValue(this.particle.size),color:this.particle.color,alpha:this.particle.alpha,rotation:this.randomizeValue(this.particle.rotation),rotationSpeed:this.randomizeValue(this.particle.rotationSpeed),lifetime:this.emission.lifetime,texture:null===(t=this.engine.getAsset(this.particle.texture))||void 0===t?void 0:t.asset}),this.particles.push(e)}},{key:"getEmissionPosition",value:function(){switch(this.emission.type){case"point":return{x:this.x,y:this.y};case"circle":var t=Math.random()*Math.PI*2,e=this.emission.edge?this.emission.radius:Math.random()*this.emission.radius;return{x:this.x+Math.cos(t)*e,y:this.y+Math.sin(t)*e};case"rectangle":if(!this.emission.edge)return{x:this.x+(Math.random()-.5)*this.emission.width,y:this.y+(Math.random()-.5)*this.emission.height};var i=Math.floor(4*Math.random()),o=this.emission.width,n=this.emission.height;switch(i){case 0:return{x:this.x+Math.random()*o-o/2,y:this.y-n/2};case 1:return{x:this.x+o/2,y:this.y+Math.random()*n-n/2};case 2:return{x:this.x+Math.random()*o-o/2,y:this.y+n/2};case 3:return{x:this.x-o/2,y:this.y+Math.random()*n-n/2}}case"line":var s=Math.random();return{x:this.x+this.emission.start.x+s*(this.emission.end.x-this.emission.start.x),y:this.y+this.emission.start.y+s*(this.emission.end.y-this.emission.start.y)};default:return{x:this.x,y:this.y}}}},{key:"randomizeValue",value:function(t){return"number"==typeof t?t:void 0!==t.min&&void 0!==t.max?"object"===te(t.min)?{x:t.min.x+Math.random()*(t.max.x-t.min.x),y:t.min.y+Math.random()*(t.max.y-t.min.y)}:t.min+Math.random()*(t.max-t.min):t}},{key:"update",value:function(t){if(this.moveAnimation){var e=performance.now()-this.moveAnimation.startTime,i=Math.min(e/this.moveAnimation.duration,1),o=this.moveAnimation.easing(i);this.x=this.moveAnimation.startX+(this.moveAnimation.targetX-this.moveAnimation.startX)*o,this.y=this.moveAnimation.startY+(this.moveAnimation.targetY-this.moveAnimation.startY)*o,i>=1&&(this.moveAnimation=null)}if(this.active&&this.emission.rate>0){var n=performance.now();n-this.lastEmissionTime>=this.emissionInterval&&(this.emitParticle(),this.lastEmissionTime=n)}for(var s=this.particles.length-1;s>=0;s--){var r=this.particles[s];r.update(t),r.isDead()&&(this.engine.emitters.returnParticle(r),this.particles.splice(s,1))}this.autoDestroy&&!this.active&&0===this.particles.length&&this.engine.emitters.remove(this.id)}},{key:"render",value:function(t){if(this.particles.forEach(function(e){e.render(t)}),"invisible"!==this.shape){switch(t.save(),t.globalAlpha=this.opacity,t.fillStyle=this.color,this.shape){case"circle":t.beginPath(),t.arc(this.x,this.y,this.size/2,0,2*Math.PI),t.fill();break;case"square":t.fillRect(this.x-this.size/2,this.y-this.size/2,this.size,this.size);break;case"diamond":t.beginPath(),t.moveTo(this.x,this.y-this.size/2),t.lineTo(this.x+this.size/2,this.y),t.lineTo(this.x,this.y+this.size/2),t.lineTo(this.x-this.size/2,this.y),t.closePath(),t.fill();break;case"cross":var e=this.size/6;t.fillRect(this.x-this.size/2,this.y-e,this.size,2*e),t.fillRect(this.x-e,this.y-this.size/2,2*e,this.size)}t.restore()}}},{key:"destroy",value:function(){var t=this;this.particles.forEach(function(e){t.engine.emitters.returnParticle(e)}),this.particles=[],this.active=!1}}])}();const ae=se;function le(t){return le="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},le(t)}function he(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,o)}return i}function ce(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?he(Object(i),!0).forEach(function(e){me(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):he(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function me(t,e,i){return(e=ge(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function ue(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var t,e,i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",n=i.toStringTag||"@@toStringTag";function s(i,o,n,s){var l=o&&o.prototype instanceof a?o:a,h=Object.create(l.prototype);return ye(h,"_invoke",function(i,o,n){var s,a,l,h=0,c=n||[],m=!1,u={p:0,n:0,v:t,a:y,f:y.bind(t,4),d:function(e,i){return s=e,a=0,l=t,u.n=i,r}};function y(i,o){for(a=i,l=o,e=0;!m&&h&&!n&&e<c.length;e++){var n,s=c[e],y=u.p,p=s[2];i>3?(n=p===o)&&(l=s[(a=s[4])?5:(a=3,3)],s[4]=s[5]=t):s[0]<=y&&((n=i<2&&y<s[1])?(a=0,u.v=o,u.n=s[1]):y<p&&(n=i<3||s[0]>o||o>p)&&(s[4]=i,s[5]=o,u.n=p,a=0))}if(n||i>1)return r;throw m=!0,o}return function(n,c,p){if(h>1)throw TypeError("Generator is already running");for(m&&1===c&&y(c,p),a=c,l=p;(e=a<2?t:l)||!m;){s||(a?a<3?(a>1&&(u.n=-1),y(a,l)):u.n=l:u.v=l);try{if(h=2,s){if(a||(n="next"),e=s[n]){if(!(e=e.call(s,l)))throw TypeError("iterator result is not an object");if(!e.done)return e;l=e.value,a<2&&(a=0)}else 1===a&&(e=s.return)&&e.call(s),a<2&&(l=TypeError("The iterator does not provide a '"+n+"' method"),a=1);s=t}else if((e=(m=u.n<0)?l:i.call(o,u))!==r)break}catch(e){s=t,a=1,l=e}finally{h=1}}return{value:e,done:m}}}(i,n,s),!0),h}var r={};function a(){}function l(){}function h(){}e=Object.getPrototypeOf;var c=[][o]?e(e([][o]())):(ye(e={},o,function(){return this}),e),m=h.prototype=a.prototype=Object.create(c);function u(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,h):(t.__proto__=h,ye(t,n,"GeneratorFunction")),t.prototype=Object.create(m),t}return l.prototype=h,ye(m,"constructor",h),ye(h,"constructor",l),l.displayName="GeneratorFunction",ye(h,n,"GeneratorFunction"),ye(m),ye(m,n,"Generator"),ye(m,o,function(){return this}),ye(m,"toString",function(){return"[object Generator]"}),(ue=function(){return{w:s,m:u}})()}function ye(t,e,i,o){var n=Object.defineProperty;try{n({},"",{})}catch(t){n=0}ye=function(t,e,i,o){if(e)n?n(t,e,{value:i,enumerable:!o,configurable:!o,writable:!o}):t[e]=i;else{var s=function(e,i){ye(t,e,function(t){return this._invoke(e,i,t)})};s("next",0),s("throw",1),s("return",2)}},ye(t,e,i,o)}function pe(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var o,n,s,r,a=[],l=!0,h=!1;try{if(s=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;l=!1}else for(;!(l=(o=s.call(i)).done)&&(a.push(o.value),a.length!==e);l=!0);}catch(t){h=!0,n=t}finally{try{if(!l&&null!=i.return&&(r=i.return(),Object(r)!==r))return}finally{if(h)throw n}}return a}}(t,e)||fe(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _e(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=fe(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var o=0,n=function(){};return{s:n,n:function(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return r=t.done,t},e:function(t){a=!0,s=t},f:function(){try{r||null==i.return||i.return()}finally{if(a)throw s}}}}function fe(t,e){if(t){if("string"==typeof t)return de(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?de(t,e):void 0}}function de(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,o=Array(e);i<e;i++)o[i]=t[i];return o}function ve(t,e,i,o,n,s,r){try{var a=t[s](r),l=a.value}catch(t){return void i(t)}a.done?e(l):Promise.resolve(l).then(o,n)}function be(t){return function(){var e=this,i=arguments;return new Promise(function(o,n){var s=t.apply(e,i);function r(t){ve(s,o,n,r,a,"next",t)}function a(t){ve(s,o,n,r,a,"throw",t)}r(void 0)})}}function xe(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,ge(o.key),o)}}function ge(t){var e=function(t,e){if("object"!=le(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var o=i.call(t,e||"default");if("object"!=le(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==le(e)?e:e+""}function we(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function Ce(t,e){return t.get(Se(t,e))}function Se(t,e,i){if("function"==typeof t?t===e:t.has(e))return arguments.length<3?e:i;throw new TypeError("Private element is not present on this object")}var Ae=new WeakMap,Me=new WeakSet,De=function(){return function(t,e,i){return e&&xe(t.prototype,e),i&&xe(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),function(t,e){we(t,e),e.add(t)}(this,Me),function(t,e,i){we(t,e),e.set(t,i)}(this,Ae,void 0),this.engine=e,this.context=null,this.masterGain=null,this.initialized=!1,function(t,e,i){t.set(Se(t,e),i)}(Ae,this,new Map),this.pendingPlayRequests=new Map,this.masterVolume=1,this.categoryVolumes=new Map,this.muted=!1,this.instances=new Map,this.categoryNodes=new Map,this.categories=["master","music","sfx","voice"],Se(Me,this,Be).call(this)},[{key:"_update",value:function(){Se(Me,this,Ge).call(this)}},{key:"startPlayback",value:(e=be(ue().m(function t(){var e,i,o,n,s,r,a;return ue().w(function(t){for(;;)switch(t.p=t.n){case 0:if(this.initialized){t.n=2;break}return t.n=1,Se(Me,this,Be).call(this);case 1:if(t.v){t.n=2;break}return t.a(2);case 2:e=_e(this.pendingPlayRequests),t.p=3,e.s();case 4:if((i=e.n()).done){t.n=6;break}return o=pe(i.value,2),n=o[0],s=o[1],r=s.options,s.asset,t.n=5,this.play(n,r);case 5:t.n=4;break;case 6:t.n=8;break;case 7:t.p=7,a=t.v,e.e(a);case 8:return t.p=8,e.f(),t.f(8);case 9:this.pendingPlayRequests.clear();case 10:return t.a(2)}},t,this,[[3,7,8,9]])})),function(){return e.apply(this,arguments)})},{key:"play",value:(t=be(ue().m(function t(e){var i,o,n,s,r,a,l=arguments;return ue().w(function(t){for(;;)switch(t.n){case 0:if(o=l.length>1&&void 0!==l[1]?l[1]:{},(n=this.engine.getAsset(e))&&"audio"===n.type){t.n=1;break}return t.a(2,null);case 1:if(this.initialized){t.n=2;break}return this.pendingPlayRequests.set(e,{options:o,asset:n}),t.a(2,null);case 2:if(s=this.instances.get(e)||[],r=o.maxInstances||(null===(i=n.config)||void 0===i?void 0:i.maxInstances)||1,!(s.filter(function(t){return t.playing}).length>=r)){t.n=3;break}return t.a(2,null);case 3:return(a=Se(Me,this,Te).call(this,n.asset,ce(ce({},n.config),o))).fadeInTime>0&&(a.gainNode.gain.setValueAtTime(0,this.context.currentTime),a.gainNode.gain.linearRampToValueAtTime(o.volume||n.config.volume||1,this.context.currentTime+a.fadeInTime/1e3)),a.source.onended=function(){a.playing=!1},a.source.start(0),a.playing=!0,a.startTime=this.context.currentTime,a.pausedAt=null,s.push(a),this.instances.set(e,s),t.a(2,a)}},t,this)})),function(e){return t.apply(this,arguments)})},{key:"stop",value:function(t){var e=this,i=this.instances.get(t);i&&i.forEach(function(t){if(t.playing)if(t.fadeOutTime>0)t.gainNode.gain.linearRampToValueAtTime(0,e.context.currentTime+t.fadeOutTime/1e3),setTimeout(function(){try{t.source.stop()}catch(t){}t.playing=!1,t.pausedAt=null},t.fadeOutTime);else{try{t.source.stop()}catch(t){}t.playing=!1,t.pausedAt=null}})}},{key:"pause",value:function(t){var e=this,i=this.instances.get(t);i&&i.forEach(function(t){if(t.playing){try{t.source.stop()}catch(t){}t.pausedAt=e.context.currentTime-t.startTime,t.playing=!1}})}},{key:"resume",value:function(t){var e=this,i=this.engine.getAsset(t),o=this.instances.get(t);i&&o&&(o.forEach(function(t,n){if(!t.playing&&null!=t.pausedAt){var s=Se(Me,e,Te).call(e,i.asset,ce(ce({},i.config),t.options));s.source.onended=function(){s.playing=!1};try{s.source.start(0,t.pausedAt)}catch(t){}s.playing=!0,s.startTime=e.context.currentTime-t.pausedAt,s.pausedAt=null,o[n]=s}}),this.instances.set(t,o))}},{key:"setVolume",value:function(t,e){if(!(e>1)){var i=this.instances.get(t);i&&i.forEach(function(t){t.gainNode.gain.value=e,t.options.volume=e})}}},{key:"setMasterVolume",value:function(t){this.masterVolume=t,this.masterGain.gain.value=t}},{key:"setCategoryVolume",value:function(t,e){var i=this.categoryNodes.get(t);i&&(this.categoryVolumes.set(t,e),i.gain.value=e)}},{key:"setSpatialPosition",value:function(t,e){var i=this,o=this.instances.get(t);o&&o.forEach(function(t){return i.updateSpatialPosition(t,e)})}},{key:"updateSpatialPosition",value:function(t,e){var i=pe(e,2),o=i[0],n=i[1];if(t.panNode){var s=this.engine.baseWidth,r=this.engine.baseHeight,a=o/s*2-1;t.panNode.pan.value=Math.max(-1,Math.min(1,a));var l=s/2,h=r/2,c=1-Math.sqrt(Math.pow(o-l,2)+Math.pow(n-h,2))/Math.sqrt(Math.pow(s/2,2)+Math.pow(r/2,2));t.gainNode.gain.value=Math.max(0,Math.min(1,c))}}},{key:"setSpatialRelation",value:function(t,e,i){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(!this.engine.isEntity(e)||!this.engine.isEntity(i))throw new Error("entity1 and entity2 must be instances of Entity");Ce(Ae,this).set(t,{entity1:e,entity2:i,options:o})}},{key:"isPlaying",value:function(t){var e,i=this.instances.get(t);return null!==(e=null==i?void 0:i.some(function(t){return t.playing}))&&void 0!==e&&e}},{key:"getDuration",value:function(t){var e,i=this.engine.getAsset(t);return null!==(e=null==i?void 0:i.asset.duration)&&void 0!==e?e:0}},{key:"getCurrentTime",value:function(t){var e=this.instances.get(t);return e&&e[0]&&e[0].playing?this.context.currentTime-e[0].startTime:0}},{key:"getState",value:function(){var t;return{initialized:this.initialized,contextState:(null===(t=this.context)||void 0===t?void 0:t.state)||"not created",masterVolume:this.masterVolume,muted:this.muted,activeInstances:Array.from(this.instances.entries()).map(function(t){var e=pe(t,2),i=e[0],o=e[1];return{id:i,count:o.length,playing:o.some(function(t){return t.playing})}})}}},{key:"muteAll",value:function(){this.muted=!0,this.masterGain.gain.value=0}},{key:"unmuteAll",value:function(){this.muted=!1,this.masterGain.gain.value=this.masterVolume}},{key:"pauseAll",value:function(){var t,e=_e(this.instances);try{for(e.s();!(t=e.n()).done;){var i=pe(t.value,1)[0];this.pause(i)}}catch(t){e.e(t)}finally{e.f()}}},{key:"resumeAll",value:function(){var t,e=_e(this.instances);try{for(e.s();!(t=e.n()).done;){var i=pe(t.value,1)[0];this.resume(i)}}catch(t){e.e(t)}finally{e.f()}}},{key:"stopAll",value:function(){var t,e=_e(this.instances);try{for(e.s();!(t=e.n()).done;){var i=pe(t.value,1)[0];this.stop(i)}}catch(t){e.e(t)}finally{e.f()}}},{key:"cleanup",value:function(){this.instances.forEach(function(t){t.forEach(function(t){try{t.source.stop(),t.gainNode.disconnect(),t.panNode&&t.panNode.disconnect()}catch(t){}})}),this.instances.clear(),this.categoryNodes.forEach(function(t){return t.disconnect()}),this.categoryNodes.clear(),Ce(Ae,this).clear();try{this.masterGain&&this.masterGain.disconnect(),this.context&&this.context.close()}catch(t){this.engine.error("Failed to cleanup",t.message)}}}]);var t,e}();function Be(){return Ie.apply(this,arguments)}function Ie(){return(Ie=be(ue().m(function t(){var e;return ue().w(function(t){for(;;)switch(t.p=t.n){case 0:if(!this.initialized){t.n=1;break}return t.a(2,!0);case 1:if(t.p=1,"undefined"!=typeof AudioContext||"undefined"!=typeof webkitAudioContext){t.n=2;break}return this.engine.warn("Web Audio API is not supported in this environment"),t.a(2,!1);case 2:if(this.context=new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.context.createGain(),this.masterGain.gain.value=this.masterVolume,this.masterGain.connect(this.context.destination),Se(Me,this,Ve).call(this),"undefined"==typeof document){t.n=3;break}return t.n=3,Se(Me,this,ke).call(this);case 3:return this.initialized=!0,t.a(2,!0);case 4:return t.p=4,e=t.v,this.engine.error("Failed to initialize AudioManager:",e),t.a(2,!1)}},t,this,[[1,4]])}))).apply(this,arguments)}function Ve(){var t=this;this.categories.forEach(function(e){var i=t.context.createGain();i.gain.value=1,i.connect(t.masterGain),t.categoryNodes.set(e,i),t.categoryVolumes.set(e,1)})}function ke(){return Pe.apply(this,arguments)}function Pe(){return Pe=be(ue().m(function t(){var e=this;return ue().w(function(t){for(;;)if(0===t.n)return t.a(2,new Promise(function(t){var i=function(){var o=be(ue().m(function o(){return ue().w(function(o){for(;;)switch(o.n){case 0:return o.n=1,e.context.resume();case 1:["click","touchstart","keydown"].forEach(function(t){document.removeEventListener(t,i)}),t();case 2:return o.a(2)}},o)}));return function(){return o.apply(this,arguments)}}();["click","touchstart","keydown"].forEach(function(t){document.addEventListener(t,i)})}))},t)})),Pe.apply(this,arguments)}function Te(t){var e,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=this.context.createBufferSource();o.buffer=t,o.loop=null!==(e=i.loop)&&void 0!==e&&e,o.playbackRate.value=i.playbackRate||1;var n=this.context.createGain();n.gain.value=void 0!==i.volume?i.volume:1;var s=this.context.createStereoPanner?this.context.createStereoPanner():null;s?(s.pan.value=0,o.connect(n),n.connect(s)):o.connect(n);var r=i.category||"master",a=this.categoryNodes.get(r);return s?s.connect(a||this.masterGain):n.connect(a||this.masterGain),{source:o,gainNode:n,panNode:s,category:r,spatialPosition:i.position||[0,0],maxInstances:i.maxInstances||1,fadeInTime:i.fadeIn||0,fadeOutTime:i.fadeOut||0,playing:!1,startTime:0,pausedAt:null,options:ce({},i)}}function Ge(){var t=this;Ce(Ae,this).forEach(function(e,i){var o,n=e.options,s=n.maxDistance,r=void 0===s?400:s,a=n.curve,l=[e.entity1.absoluteX,e.entity1.absoluteY],h=l[0],c=l[1],m=[e.entity2.absoluteX,e.entity2.absoluteY],u=m[0],y=m[1],p=Math.sqrt(Math.pow(h-u,2)+Math.pow(c-y,2));p>=r?o=0:"function"==typeof a?o=a(p/r):(o=1-p/r,o*=o),t.setSpatialPosition(i,[u,y]),t.setVolume(i,o)})}const Le=De;function Ee(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var t,e,i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",n=i.toStringTag||"@@toStringTag";function s(i,o,n,s){var l=o&&o.prototype instanceof a?o:a,h=Object.create(l.prototype);return Fe(h,"_invoke",function(i,o,n){var s,a,l,h=0,c=n||[],m=!1,u={p:0,n:0,v:t,a:y,f:y.bind(t,4),d:function(e,i){return s=e,a=0,l=t,u.n=i,r}};function y(i,o){for(a=i,l=o,e=0;!m&&h&&!n&&e<c.length;e++){var n,s=c[e],y=u.p,p=s[2];i>3?(n=p===o)&&(l=s[(a=s[4])?5:(a=3,3)],s[4]=s[5]=t):s[0]<=y&&((n=i<2&&y<s[1])?(a=0,u.v=o,u.n=s[1]):y<p&&(n=i<3||s[0]>o||o>p)&&(s[4]=i,s[5]=o,u.n=p,a=0))}if(n||i>1)return r;throw m=!0,o}return function(n,c,p){if(h>1)throw TypeError("Generator is already running");for(m&&1===c&&y(c,p),a=c,l=p;(e=a<2?t:l)||!m;){s||(a?a<3?(a>1&&(u.n=-1),y(a,l)):u.n=l:u.v=l);try{if(h=2,s){if(a||(n="next"),e=s[n]){if(!(e=e.call(s,l)))throw TypeError("iterator result is not an object");if(!e.done)return e;l=e.value,a<2&&(a=0)}else 1===a&&(e=s.return)&&e.call(s),a<2&&(l=TypeError("The iterator does not provide a '"+n+"' method"),a=1);s=t}else if((e=(m=u.n<0)?l:i.call(o,u))!==r)break}catch(e){s=t,a=1,l=e}finally{h=1}}return{value:e,done:m}}}(i,n,s),!0),h}var r={};function a(){}function l(){}function h(){}e=Object.getPrototypeOf;var c=[][o]?e(e([][o]())):(Fe(e={},o,function(){return this}),e),m=h.prototype=a.prototype=Object.create(c);function u(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,h):(t.__proto__=h,Fe(t,n,"GeneratorFunction")),t.prototype=Object.create(m),t}return l.prototype=h,Fe(m,"constructor",h),Fe(h,"constructor",l),l.displayName="GeneratorFunction",Fe(h,n,"GeneratorFunction"),Fe(m),Fe(m,n,"Generator"),Fe(m,o,function(){return this}),Fe(m,"toString",function(){return"[object Generator]"}),(Ee=function(){return{w:s,m:u}})()}function Fe(t,e,i,o){var n=Object.defineProperty;try{n({},"",{})}catch(t){n=0}Fe=function(t,e,i,o){if(e)n?n(t,e,{value:i,enumerable:!o,configurable:!o,writable:!o}):t[e]=i;else{var s=function(e,i){Fe(t,e,function(t){return this._invoke(e,i,t)})};s("next",0),s("throw",1),s("return",2)}},Fe(t,e,i,o)}function Re(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,o)}return i}function Je(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Re(Object(i),!0).forEach(function(e){Oe(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Re(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function Oe(t,e,i){return(e=Ue(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function ze(t,e,i,o,n,s,r){try{var a=t[s](r),l=a.value}catch(t){return void i(t)}a.done?e(l):Promise.resolve(l).then(o,n)}function je(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var o,n,s,r,a=[],l=!0,h=!1;try{if(s=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;l=!1}else for(;!(l=(o=s.call(i)).done)&&(a.push(o.value),a.length!==e);l=!0);}catch(t){h=!0,n=t}finally{try{if(!l&&null!=i.return&&(r=i.return(),Object(r)!==r))return}finally{if(h)throw n}}return a}}(t,e)||Xe(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ne(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=Xe(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var o=0,n=function(){};return{s:n,n:function(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return r=t.done,t},e:function(t){a=!0,s=t},f:function(){try{r||null==i.return||i.return()}finally{if(a)throw s}}}}function Xe(t,e){if(t){if("string"==typeof t)return We(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?We(t,e):void 0}}function We(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,o=Array(e);i<e;i++)o[i]=t[i];return o}function Ye(t){return Ye="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Ye(t)}function qe(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,Ue(o.key),o)}}function Ue(t){var e=function(t,e){if("object"!=Ye(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var o=i.call(t,e||"default");if("object"!=Ye(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==Ye(e)?e:e+""}function Ke(t,e,i){return e=He(e),function(t,e){if(e&&("object"==Ye(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(t,Ze()?Reflect.construct(e,i||[],He(t).constructor):e.apply(t,i))}function Ze(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(t){}return(Ze=function(){return!!t})()}function He(t){return He=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},He(t)}function Qe(t,e){return Qe=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Qe(t,e)}function $e(t,e){(function(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")})(t,e),e.add(t)}function ti(t,e,i){if("function"==typeof t?t===e:t.has(e))return arguments.length<3?e:i;throw new TypeError("Private element is not present on this object")}var ei=new WeakSet,ii=function(t){function e(t){var i,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),$e(i=Ke(this,e),ei),"string"==typeof t)i.canvas=document.querySelector(t);else{if(!(t instanceof HTMLCanvasElement))throw new Error("Invalid selector");i.canvas=t}return i.ctx=i.canvas.getContext("2d"),i.assets=new Map,i.entities=new Map,i.config={width:o.width||i.canvas.width,height:o.height||i.canvas.height,fps:o.fps||60,grids:o.grids||!1,quality:o.quality||1,physics:o.physics||{},collision:o.collision||{},background:o.background||"#ffffff"},i.baseWidth=i.config.width,i.baseHeight=i.config.height,i.debugger={active:!1,level:"advanced",fps:{target:i.config.fps,actual:i.config.fps,ratio:100},lastFpsUpdate:performance.now(),frameCount:0,targetFrameCount:0},i.eventListeners=new Map,i.running=!1,i.lastTime=0,i.draggedEntity=null,i.draggedEntities=new Map,i.hoveredEntity=null,i.timers=new Map,i.background=new Z(i),i.camera=new W(i,o.camera),i.gridEnabled=Boolean(o.grids),i.grid=new et(i,o.grids||{}),i.physicsEnabled=Boolean(o.physics),i.physics=new Gt(i,o.physics),i.collisionEnabled=Boolean(o.collision),i.collision=new y,i.activeTileMap=null,i.tileMap=new Yt(i),i.emitters=new ae(i),i.audio=new Le(i),i.animations={},i.maxDeltaTime=1e3/30,i.init(),i.setupEventListeners(),i}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&Qe(t,e)}(e,t),function(t,e,i){return e&&qe(t.prototype,e),i&&qe(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(e,[{key:"init",value:function(){this.canvas.tabIndex=0,this.canvas.width=this.config.width*this.config.quality,this.canvas.height=this.config.height*this.config.quality,this.canvas.style.width=this.config.width+"px",this.canvas.style.height=this.config.height+"px",this.canvas.style.backgroundColor=this.config.background,this.canvas.style.imageRendering=this.config.imageRendering||this.canvas.style.imageRendering}},{key:"setupEventListeners",value:function(){var t=this;"undefined"!=typeof window&&"undefined"!=typeof document?(new ResizeObserver(this._handleResize.bind(this)).observe(this.canvas),this.canvas.addEventListener("click",this.handleClick.bind(this)),this.canvas.addEventListener("contextmenu",this.handleRightClick.bind(this)),this.canvas.addEventListener("keydown",this.handleKeyDown.bind(this)),this.canvas.addEventListener("keyup",this.handleKeyUp.bind(this)),document.addEventListener("visibilitychange",function(){if(document.hidden)return t.stop();t.start()}),this.physicsEnabled||(this.canvas.addEventListener("mousemove",this.handleMouseMove.bind(this)),this.canvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.addEventListener("touchstart",this.handleTouchStart.bind(this)),this.canvas.addEventListener("touchmove",this.handleTouchMove.bind(this)),this.canvas.addEventListener("touchend",this.handleTouchEnd.bind(this)),this.canvas.addEventListener("touchcancel",this.handleTouchCancel.bind(this)))):this.warn("Browser environment is required. This feature is only available in browser context.")}},{key:"quality",value:function(t){return void 0===t?this.config.quality:(this.config.quality=t,this._applyQuality(t),this)}},{key:"_applyQuality",value:function(t){this.canvas.width=this.baseWidth*t,this.canvas.height=this.baseHeight*t,this.canvas.style.width=this.baseWidth+"px",this.canvas.style.height=this.baseHeight+"px",this.ctx.scale(t,t)}},{key:"on",value:function(t,e){var i=this;if(Array.isArray(t))return t.forEach(function(t){i.on(t,e)}),this;if("object"===Ye(t)){for(var o in t)this.on(o,t[o]);return this}return this.eventListeners.has(t)||this.eventListeners.set(t,new Set),this.eventListeners.get(t).add(e),this}},{key:"trigger",value:function(t,e){var i=this;if(Array.isArray(t))return t.forEach(function(t){i.trigger(t,e)}),this;if(!this.eventListeners.has(t))return this;var o,n=Ne(this.eventListeners.get(t));try{for(n.s();!(o=n.n()).done;){o.value.call(this,e)}}catch(t){n.e(t)}finally{n.f()}return this}},{key:"off",value:function(t,e){var i=this;return Array.isArray(t)?(t.forEach(function(t){i.off(t,e)}),this):(this.eventListeners.has(t)&&this.eventListeners.get(t).delete(e),this)}},{key:"timer",value:function(t,e){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],o=Symbol(),n={callback:t,delay:e,repeat:i,lastTime:performance.now(),accumulated:0,isRunning:!0};return this.timers.set(o,n),o}},{key:"timeout",value:function(t,e){this.timer(t,e,!1)}},{key:"clearTimer",value:function(t){return this.timers.delete(t)}},{key:"updateTimers",value:function(t){var e=this;this.timers.forEach(function(i,o){if(i.isRunning){var n=t-i.lastTime;for(i.accumulated+=n;i.accumulated>=i.delay;){if(i.callback(),!i.repeat){e.clearTimer(o);break}i.accumulated-=i.delay}i.lastTime=t}})}},{key:"addBackground",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.background.add(t,e),this}},{key:"removeBackground",value:function(t){return this.background.remove(t),this}},{key:"updateBackground",value:function(t,e){return this.background.update(t,e),this}},{key:"clearBackgrounds",value:function(){return this.background.clear(),this}},{key:"getBackground",value:function(t){return this.background.get(t),this}},{key:"setBackgroundOrder",value:function(t,e){return this.background.setOrder(t,e),this}},{key:"setBackgroundVisible",value:function(t,e){return this.background.setVisible(t,e),this}},{key:"enableGrid",value:function(){return this.gridEnabled=!0,this}},{key:"disableGrid",value:function(){return this.gridEnabled=!1,this}},{key:"toggleGrid",value:function(){return this.gridEnabled=!this.gridEnabled,this}},{key:"setGridSize",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t;return this.grid.setSize(t,e),this}},{key:"setGridColors",value:function(t,e){return this.grid.setColors(t,e),this}},{key:"setGridLineWidth",value:function(t,e){return this.grid.setLineWidth(t,e),this}},{key:"setMajorGrid",value:function(t,e,i){return this.grid.setMajorGrid(t,e,i),this}},{key:"setGridBounds",value:function(t){return this.grid.setBounds(t),this}},{key:"setGridOrigin",value:function(t,e){return this.grid.setOrigin(t,e),this}},{key:"setGridVisibilityRange",value:function(t,e){return this.grid.setVisibilityRange(t,e),this}},{key:"snapToGrid",value:function(t,e){return this.grid.snapToGrid(t,e)}},{key:"getGridCell",value:function(t,e){return this.grid.getGridCell(t,e)}},{key:"cellToWorld",value:function(t,e){return this.grid.cellToWorld(t,e)}},{key:"startLoop",value:function(){this.running=!0,requestAnimationFrame(this.loop.bind(this))}},{key:"loop",value:function(t){if(this.running){var e=1e3/this.config.fps,i=t-this.lastTime;if(i=Math.min(i,this.maxDeltaTime),this.debugger.active){this.debugger.frameCount++;var o=t,n=o-this.debugger.lastFpsUpdate;if(n>=1e3){var s=Math.round(1e3*this.debugger.frameCount/n),r=this.config.fps,a=Math.min(Math.round(s/r*100),100);this.debugger.fps={target:r,actual:Math.min(s,r),ratio:a},this.debugger.frameCount=0,this.debugger.lastFpsUpdate=o}}i>=e&&(this.clear(),this.updateTimers(t),this.update(i),this.render(),this.lastTime=t-i%e),requestAnimationFrame(this.loop.bind(this))}}},{key:"update",value:function(t){this.camera.update(),this.background._updateLayers(t),this.physicsEnabled&&this.physics.update(t),this.activeTileMap&&this.tileMap.update();var e,i=Ne(this.entities);try{for(i.s();!(e=i.n()).done;){var o=je(e.value,2),n=(o[0],o[1]);"function"==typeof n.update&&n.update(t)}}catch(t){i.e(t)}finally{i.f()}if(this.collisionEnabled&&!this.physicsEnabled){var s=Array.from(this.entities.values()).filter(function(t){var e;return null===(e=t.collision)||void 0===e?void 0:e.enabled});this.collision.updateCollisions(s)}this.emitters.update(t),this.audio._update(),this.trigger("update",t)}},{key:"render",value:function(){var t=this;this.clear(),this.ctx.save(),this.ctx.scale(this.config.quality,this.config.quality),this.camera.apply(this.ctx),this.trigger("beforerender",this.ctx),this.background._renderLayers(this.ctx,!1),this.activeTileMap&&this.tileMap.render(this.activeTileMap),Array.from(this.entities.values()).sort(function(t,e){return t.zIndex-e.zIndex}).forEach(function(e){"function"==typeof e.render&&(t.ctx.save(),e.render(t.ctx),t.ctx.restore())}),this.trigger("render",this.ctx),this.emitters.render(this.ctx),this.background._renderLayers(this.ctx,!0),this.gridEnabled&&this.grid.render(this.ctx),this.ctx.restore(),this.renderDebugInfo()}},{key:"start",value:function(){return this.running||(this.timers.forEach(function(t){t.isRunning=!0,t.lastTime=performance.now()}),this.audio.resumeAll(),this.startLoop(),this.trigger("start")),this}},{key:"stop",value:function(){return this.running=!1,this.timers.forEach(function(t){t.isRunning=!1}),this.audio.pauseAll(),this.trigger("stop"),this}},{key:"clear",value:function(){this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle=this.config.background,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}},{key:"reset",value:function(){this.entities.clear(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.eventListeners.clear(),this.timers.clear(),this.collision.reset(),this.audio.cleanup(),this.draggedEntity=null,this.hoveredEntity=null,this.touchIdentifier=null,this.activeTileMap=null}},{key:"enableDebugger",value:function(){var t=this;return this.debugger.active=!0,this.entities.forEach(function(e){t.enableEntityDebug(e)}),this}},{key:"disableDebugger",value:function(){var t=this;return this.debugger.active=!1,this.entities.forEach(function(e){t.disableEntityDebug(e)}),this}},{key:"enableEntityDebug",value:function(t){var e=this;t.style({debugCollision:!0}),t.children.forEach(function(t){e.enableEntityDebug(t)})}},{key:"disableEntityDebug",value:function(t){var e=this;t.style({debugCollision:!1}),t.children.forEach(function(t){e.disableEntityDebug(t)})}},{key:"renderDebugInfo",value:function(){if(this.debugger.active){var t=this.ctx,e=10,i=20,o=e;t.save(),t.fillStyle="rgba(0,0,0,0.6)",t.fillRect(e,e,300,500),t.font="12px monospace",t.fillStyle="#ffffff",t.fillStyle="#00ff00",t.fillText("=== Performance ===",15,o+=i),t.fillStyle="#ffffff",t.fillText("FPS: ".concat(this.debugger.fps.actual),15,o+=i),t.fillText("Max FPS: ".concat(this.debugger.fps.target),15,o+=i),t.fillText("FPS Ratio: ".concat(this.debugger.fps.ratio,"%"),15,o+=i),t.fillStyle="#00ff00",t.fillText("=== System ===",15,o+=30),t.fillStyle="#ffffff",t.fillText("Quality: ".concat(this.config.quality,"x"),15,o+=i),t.fillText("Canvas Size: ".concat(this.canvas.width,"x").concat(this.canvas.height),15,o+=i),t.fillStyle="#00ff00",t.fillText("=== State ===",15,o+=30),t.fillStyle="#ffffff";var n=0,s=0,r=function(t){n++,t.styles.visible&&s++,t.children.forEach(r)};this.entities.forEach(r),t.fillText("Total Entities: ".concat(n),15,o+=i),t.fillText("Visible Entities: ".concat(s),15,o+=i),t.fillStyle="#00ff00",t.fillText("=== Physics & Collision ===",15,o+=30),t.fillStyle="#ffffff";var a=0;this.entities.forEach(function(t){var e;null!==(e=t.collision)&&void 0!==e&&e.enabled&&a++}),t.fillText("Physics: ".concat(this.physicsEnabled?"Enabled":"Disabled"),15,o+=i),t.fillText("Collision Objects: ".concat(a),15,o+=i),t.fillStyle="#00ff00",t.fillText("=== Grid System ===",15,o+=30),t.fillStyle="#ffffff",t.fillText("Grid Enabled: ".concat(this.gridEnabled?"Yes":"No"),15,o+=i),this.gridEnabled&&(t.fillText("Grid Size: ".concat(this.grid.width,"x").concat(this.grid.height),15,o+=i),t.fillText("Major Grid: Every ".concat(this.grid.majorGridEvery),15,o+=i),t.fillText("Zoom Range: ".concat(this.grid.minZoomToShow," - ").concat(this.grid.maxZoomToShow),15,o+=i)),t.restore()}}},{key:"log",value:function(){for(var t,e=arguments.length,i=new Array(e),o=0;o<e;o++)i[o]=arguments[o];return this.debugger&&this.debugger.active&&(t=console).log.apply(t,["%c[Pixalo LOG]","color: #2196f3;"].concat(i)),this}},{key:"info",value:function(){for(var t,e=arguments.length,i=new Array(e),o=0;o<e;o++)i[o]=arguments[o];return this.debugger&&this.debugger.active&&(t=console).info.apply(t,["%c[Pixalo INFO]","color: #4caf50;"].concat(i)),this}},{key:"warn",value:function(){for(var t,e=arguments.length,i=new Array(e),o=0;o<e;o++)i[o]=arguments[o];return this.debugger&&this.debugger.active&&(t=console).warn.apply(t,["%c[Pixalo WARN]","color: #ff9800;"].concat(i)),this}},{key:"error",value:function(){for(var t,e=arguments.length,i=new Array(e),o=0;o<e;o++)i[o]=arguments[o];return this.debugger&&this.debugger.active&&(t=console).error.apply(t,["%c[Pixalo ERROR]","color: #f44336;"].concat(i)),this}},{key:"loadAsset",value:function(t,e,i){var o=this,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return t&&e&&i?this.assets.has(e)?Promise.resolve(this.assets.get(e)):new Promise(function(){var s=function(t){return function(){var e=this,i=arguments;return new Promise(function(o,n){var s=t.apply(e,i);function r(t){ze(s,o,n,r,a,"next",t)}function a(t){ze(s,o,n,r,a,"throw",t)}r(void 0)})}}(Ee().m(function s(r,a){var l,h,c,m,u,y,p;return Ee().w(function(s){for(;;)switch(s.p=s.n){case 0:y=t.toLowerCase(),s.n="image"===y||"tiles"===y?1:"spritesheet"===y?2:"audio"===y?3:9;break;case 1:return(l=new Image).onload=function(){if("tiles"===t.toLowerCase()){n.tileSize||(o.warn("No tileSize specified for tiles"),n.tileSize=32),n.tiles||(o.warn("No tiles configuration specified for tiles"),n.tiles={}),n.columns=Math.floor(l.width/n.tileSize),n.rows=Math.floor(l.height/n.tileSize);for(var i=0,s=Object.entries(n.tiles);i<s.length;i++){var a=je(s[i],2),h=a[0],c=a[1];if(Array.isArray(c)){var m=je(c,2),u=m[0],y=m[1];n.tiles[h]={x:u*n.tileSize,y:y*n.tileSize,width:n.tileSize,height:n.tileSize}}}}ti(ei,o,oi).call(o,l,n),o.assets.set(e,{id:e,asset:l,config:n,type:t}),r({asset:l,config:n,type:t})},l.onerror=a,l.src=i,s.a(3,10);case 2:return(l=new Image).onload=function(){for(var i=0,s=["columns","rows","width","height"];i<s.length;i++){var a=s[i];if(!n[a])throw o.error("Missing required parameter: ".concat(a)),new Error("Missing required parameter: ".concat(a))}n.originOffset=n.originOffset||[0,0],n.margin=n.margin||[0,0],Array.isArray(n.originOffset)&&2===n.originOffset.length||(n.originOffset=[0,0]),Array.isArray(n.margin)&&2===n.margin.length||(n.margin=[0,0]),n.totalFrames=n.columns*n.rows,n.frames=[];for(var h=0;h<n.rows;h++)for(var c=0;c<n.columns;c++)n.frames.push({x:n.originOffset[0]+c*(n.width+n.margin[0]),y:n.originOffset[1]+h*(n.height+n.margin[1]),width:n.width,height:n.height});o.assets.set(e,{id:e,asset:l,config:n,type:t}),r({asset:l,config:n,type:t})},l.onerror=a,l.src=i,s.a(3,10);case 3:return s.p=3,s.n=4,fetch(i,Je({mode:"cors"},n.fetch||{}));case 4:return h=s.v,s.n=5,h.arrayBuffer();case 5:return c=s.v,s.n=6,o.audio.context.decodeAudioData(c);case 6:m=s.v,u={id:e,asset:m,config:Je(Je({},n),{},{volume:n.volume||1,loop:n.loop||!1,autoplay:n.autoplay||!1,muted:n.muted||!1,category:n.category||"master"}),type:t},o.assets.set(e,u),r({asset:m,config:u.config,type:t}),s.n=8;break;case 7:s.p=7,p=s.v,a(new Error("Failed to load audio: ".concat(p.message)));case 8:return s.a(3,10);case 9:a(new Error("Unsupported asset type: ".concat(t)));case 10:return s.a(2)}},s,null,[[3,7]])}));return function(t,e){return s.apply(this,arguments)}}()):Promise.reject(new Error("Invalid parameters for Assets.load"))}},{key:"getAsset",value:function(t){return this.assets.get(t)||null}},{key:"deleteAsset",value:function(t){return this.assets.delete(t),this}},{key:"clearAssets",value:function(){return this.assets.clear(),this}},{key:"defineAnimation",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.animations[t]={keyframes:e,options:{duration:i.duration||1e3,repeat:i.repeat||0,easing:i.easing||"linear"}},this}},{key:"append",value:function(t){var e,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=t instanceof ft?t:i instanceof ft?i:new ft(t,Je(Je({},i),{},{engine:this}));return this.entities.has(o.id)&&(o.id="".concat(o.id,"_").concat(Date.now())),o.engine=this,this.entities.set(o.id,o),null===(e=o.updatePosition)||void 0===e||e.call(o),this.physicsEnabled&&(o.physics||i.physics)&&this.physics.addEntity(o,o.physics||i.physics),this.debugger.active&&this.enableEntityDebug(o),o}},{key:"getAllEntities",value:function(){return this.entities}},{key:"getSortedEntitiesByZIndex",value:function(){return Array.from(this.entities.values()).sort(function(t,e){return e.zIndex-t.zIndex})}},{key:"find",value:function(t){return this.entities.get(t)}},{key:"isEntity",value:function(t){return t instanceof ft}},{key:"kill",value:function(t){var e=this.entities.get(t);return!!e&&e.kill()}},{key:"enableCollisions",value:function(){return this.collisionEnabled=!0,this}},{key:"checkCollision",value:function(t,e){return this.collision.detectCollisionDetailed(t,e)}},{key:"checkGroupCollision",value:function(t,e){var i,o=Ne(t);try{for(o.s();!(i=o.n()).done;){var n,s=i.value,r=Ne(e);try{for(r.s();!(n=r.n()).done;){var a=n.value;if(this.detectCollisionDetailed(s,a))return{entity1:s,entity2:a}}}catch(t){r.e(t)}finally{r.f()}}}catch(t){o.e(t)}finally{o.f()}return!1}},{key:"disableCollisions",value:function(){return this.collisionEnabled=!1,this}},{key:"createTileMap",value:function(t){return this.tileMap.create(t)}},{key:"renderTileMap",value:function(t){return this.activeTileMap=t,this}},{key:"addTile",value:function(t,e){var i;return(i=this.tileMap).addTile.apply(i,arguments),this}},{key:"exportTileMap",value:function(t){return this.tileMap.exportLayers(t)}},{key:"createEmitter",value:function(t,e){return this.emitters.create(t,e)}},{key:"shot",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.format,i=void 0===e?"png":e,o=t.quality,n=void 0===o?1:o,s=t.backgroundColor,r=void 0===s?this.config.background:s,a=t.download,l=void 0!==a&&a,h=t.filename,c=void 0===h?"pixalo-screenshot-".concat(Date.now()):h;if(!["png","jpeg","webp"].includes(i.toLowerCase()))return this.error("Invalid format. Supported formats are: png, jpeg, webp");if(n<0||n>1)return this.error("Quality must be between 0 and 1");var m=document.createElement("canvas"),u=m.getContext("2d");m.width=this.canvas.width,m.height=this.canvas.height,r&&(u.fillStyle=r,u.fillRect(0,0,m.width,m.height)),u.drawImage(this.canvas,0,0);var y="image/".concat(i.toLowerCase()),p=m.toDataURL(y,n),_=this.dataURLToBlob(p),f=URL.createObjectURL(_);if(l){var d=document.createElement("a");d.download="".concat(c,".").concat(i.toLowerCase()),d.href=p,d.click()}return{dataURL:p,blob:_,blobURL:f,width:m.width,height:m.height,revoke:function(){return URL.revokeObjectURL(f)}}}}])}(B);function oi(t,e){if(!e.tileSize)for(var i in e)if(i in t)try{t[i]=e[i]}catch(t){this.warn('Failed to set property "'.concat(i,'" on asset:'),t)}}ii.prototype.Bezier=T,ii.prototype.Ease=L,ii.prototype.TileMap=Yt;const ni=ii;return e=e.default})());